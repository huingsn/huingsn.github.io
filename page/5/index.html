<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="永远不要说你知道本质，更别说真相了。">
<meta property="og:type" content="website">
<meta property="og:title" content="简">
<meta property="og:url" content="https://huyunshun.com/page/5/index.html">
<meta property="og:site_name" content="简">
<meta property="og:description" content="永远不要说你知道本质，更别说真相了。">
<meta property="article:author" content="初晨">
<meta property="article:tag" content="编程">
<meta property="article:tag" content="开发">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://huyunshun.com/page/5/"/>





  <title>简</title>
  








  <script type="text/javascript" src="/js/src/love.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">

  <!-- 看板娘 -->
    
        <script async src="/live2d-widget/autoload.js"></script>
    
 <!-- 飘动的彩带） -->
  <script src="/js/src/piao.js" type="text/javascript"></script>
<meta name="generator" content="Hexo 4.2.1"></head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">简</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">人生短暂，学海无边，而大道至简。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/04/23/ContiPerf%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/23/ContiPerf%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7/" itemprop="url">ContiPerf测试工具</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-23T00:00:00+08:00">
                2019-04-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%85%B6%E4%BB%96/" itemprop="url" rel="index">
                    <span itemprop="name">其他</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>ContiPerf是一个轻量级的测试工具，基于JUnit 4 开发，可用于接口级的性能测试，可以指定在线程数量和执行次数，通过限制最大时间和平均执行时间来进行效率测试。</p>
<p>常用的参数如下：@PerfTest(invocations = 100,threads = 10)</p>
<pre><code>invocations() : 执行次数与线程无关
duration(): 间隔时间
threads()：线程数</code></pre><p>添加依赖包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.databene<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>contiperf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="meta">@Autowired</span> UserService userService;</span><br><span class="line">    <span class="comment">//引入 ContiPerf 进行性能测试</span></span><br><span class="line">    <span class="meta">@Rule</span></span><br><span class="line">    <span class="keyword">public</span> ContiPerfRule rule = <span class="keyword">new</span> ContiPerfRule();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//10个线程 执行100次</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@PerfTest</span>(invocations = <span class="number">100</span>,threads = <span class="number">10</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Long id = (<span class="keyword">long</span>) (Math.random()*<span class="number">100</span>);</span><br><span class="line">        userService.selectId(id);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在junit执行完毕，会在target/contiperf-report中有相关的执行结果，可以使用浏览器打开查看</p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/04/21/Nodejs-uuid/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/Nodejs-uuid/" itemprop="url">Nodejs-uuid</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T00:00:00+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Node/" itemprop="url" rel="index">
                    <span itemprop="name">Node</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>UUID 定义</p>
<p>UUID 是由一组 32 位的 16 进制数所构成，是故 UUID 理论上的总数为 1632=2128，约等于 3.4 x 10^38。也就是说若每纳秒产生 1 兆个 UUID，要花 100 亿年才会将所有 UUID 用完。</p>
<p>UUID 示例：74760410-f963-11e8-b2a3-1bb26e1e5b69</p>
<p>UUID 版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;版本 1&quot; UUID 是根据时间和节点 ID（通常是 MAC 地址）生成；</span><br><span class="line">&quot;版本 2&quot; UUID 是根据标识符（通常是组或用户 ID）、时间和节点 ID 生成；</span><br><span class="line">&quot;版本 3&quot; 和 &quot;版本 5&quot; 确定性 UUID 通过散列 (hashing) 命名空间 (namespace) 标识符和名称生成；</span><br><span class="line">&quot;版本 4&quot; UUID 使用随机性或伪随机性生成。</span><br></pre></td></tr></table></figure>
<p>Node.js uuid 模块示例  在 JavaScript 中生成符合 RFC 规范的 UUID。</p>
<p>版本 1：基于时间的 UUID</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> uuidv1 = <span class="built_in">require</span>(<span class="string">'uuid/v1'</span>);</span><br><span class="line">uuidv1() <span class="comment">//  ⇨ 43d7e120-f963-11e8-999e-51f3e5aa256f</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> formatedUUID = uuidv1().replace(<span class="regexp">/-/g</span>, <span class="string">''</span>); <span class="comment">// 去除横线-</span></span><br></pre></td></tr></table></figure>
<p>版本 2：DCE 安全的 UUID</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">未实现。</span><br></pre></td></tr></table></figure>
<p>版本 3：基于名字空间的 UUID（MD5）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> uuidv3 = <span class="built_in">require</span>(<span class="string">'uuid/v3'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... using predefined DNS namespace (for domain names)</span></span><br><span class="line">uuidv3(<span class="string">'hello.example.com'</span>, uuidv3.DNS); <span class="comment">// ⇨ '9125a8dc-52ee-365b-a5aa-81b0b3681cf6'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ... using predefined URL namespace (for, well, URLs)</span></span><br><span class="line">uuidv3(<span class="string">'http://example.com/hello'</span>, uuidv3.URL); <span class="comment">// ⇨ 'c6235813-3ba4-3801-ae84-e0a6ebb7d138'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ... using a custom namespace</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Note: Custom namespaces should be a UUID string specific to your application!</span></span><br><span class="line"><span class="comment">// E.g. the one here was generated using this modules `uuid` CLI.</span></span><br><span class="line"><span class="keyword">const</span> MY_NAMESPACE = <span class="string">'1b671a64-40d5-491e-99b0-da01ff1f3341'</span>;</span><br><span class="line">uuidv3(<span class="string">'Hello, World!'</span>, MY_NAMESPACE); <span class="comment">// ⇨ 'e8b5a51d-11c8-3310-a6ab-367563f20686'</span></span><br></pre></td></tr></table></figure>
<p>版本 4：基于随机数的 UUID</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> uuidv4 = <span class="built_in">require</span>(<span class="string">'uuid/v4'</span>);</span><br><span class="line">uuidv4(); <span class="comment">// ⇨ 57751a52-db27-4b2f-8a08-7e02f9e94a42</span></span><br></pre></td></tr></table></figure>
<p>版本 5：基于名字空间的 UUID（SHA1）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> uuidv5 = <span class="built_in">require</span>(<span class="string">'uuid/v5'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... using predefined DNS namespace (for domain names)</span></span><br><span class="line">uuidv5(<span class="string">'hello.example.com'</span>, uuidv5.DNS); <span class="comment">// ⇨ 'fdda765f-fc57-5604-a269-52a7df8164ec'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ... using predefined URL namespace (for, well, URLs)</span></span><br><span class="line">uuidv5(<span class="string">'http://example.com/hello'</span>, uuidv5.URL); <span class="comment">// ⇨ '3bbcee75-cecc-5b56-8031-b6641c1ed1f1'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ... using a custom namespace</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Note: Custom namespaces should be a UUID string specific to your application!</span></span><br><span class="line"><span class="comment">// E.g. the one here was generated using this modules `uuid` CLI.</span></span><br><span class="line"><span class="keyword">const</span> MY_NAMESPACE = <span class="string">'1b671a64-40d5-491e-99b0-da01ff1f3341'</span>;</span><br><span class="line">uuidv5(<span class="string">'Hello, World!'</span>, MY_NAMESPACE); <span class="comment">// ⇨ '630eb68f-e0fa-5ecc-887a-7c7a62614681'</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/04/20/mybatis%E6%BA%90%E7%A0%81%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/20/mybatis%E6%BA%90%E7%A0%81%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90/" itemprop="url">mybatis源码日志分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-20T22:49:08+08:00">
                2019-04-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mybatis/" itemprop="url" rel="index">
                    <span itemprop="name">mybatis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="mybatis日志分析"><a href="#mybatis日志分析" class="headerlink" title="mybatis日志分析"></a>mybatis日志分析</h4><p>初始化：org.apache.ibatis.logging.LogFactory</p>
<p>mybatis内置日志工厂提供日志功能，提供很多日志的实现类，用来记录日志，取决于初始化的时候按顺序load到的class。默认是用Slf4j（第一个）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    tryImplementation(LogFactory::useSlf4jLogging);</span><br><span class="line">    tryImplementation(LogFactory::useCommonsLogging);</span><br><span class="line">    tryImplementation(LogFactory::useLog4J2Logging);</span><br><span class="line">    tryImplementation(LogFactory::useLog4JLogging);</span><br><span class="line">    tryImplementation(LogFactory::useJdkLogging);</span><br><span class="line">    tryImplementation(LogFactory::useNoLogging);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>没有则继续找：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">tryImplementation</span><span class="params">(Runnable runnable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (logConstructor == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            runnable.run();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var2) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Mybatis 中 SQL 语句的日志级别被设为DEBUG（JDK 日志设为 FINE）</p>
<p>默认情况下，mybatis+spring5不会打印输出mybatis日志，这是因为集成后spring5默认的日志是spring-jcl 最终选择的是jul，而jul默认日志级别为info，所以也不会打印Mybatis执行的日志。并且sql执行日志是debug级别。</p>
<p>可以加入log4j2的包，不用做任何更改就可以打印日志。</p>
<p>如果加入log4j包，并且配置mybatis选择使用该日志就可以。如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionFactoryBean <span class="title">sqlSessionFactoryBean</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        SqlSessionFactoryBean factoryBean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">        <span class="comment">//配置log</span></span><br><span class="line">        org.apache.ibatis.session.Configuration configuration = <span class="keyword">new</span> org.apache.ibatis.session.Configuration();</span><br><span class="line">        configuration.setLogImpl(Log4jImpl<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        factoryBean.setConfiguration(configuration);</span><br><span class="line">        factoryBean.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> factoryBean;</span><br><span class="line">    &#125;</span><br><span class="line">或者，在实例初始化前执行，推荐前面一种</span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//org.apache.ibatis.logging.LogFactory.useSlf4jLogging();</span></span><br><span class="line">        org.apache.ibatis.logging.LogFactory.useLog4JLogging();</span><br><span class="line">        <span class="comment">//org.apache.ibatis.logging.LogFactory.useJdkLogging();</span></span><br><span class="line">        <span class="comment">//org.apache.ibatis.logging.LogFactory.useCommonsLogging();</span></span><br><span class="line">        <span class="comment">//org.apache.ibatis.logging.LogFactory.useStdOutLogging();</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>如果加入log4j2就会打印，spring5使用了log4j默认是用log4j2。注意修改日志配置的级别。</p>
<p>这都是使用java配置方式，xml不做讨论。</p>
<p>此外，也可以扩展通过默认的方式打印日志信息。</p>
<p>自定义扩展类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLog</span> <span class="keyword">implements</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">ibatis</span>.<span class="title">logging</span>.<span class="title">Log</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyLog</span><span class="params">(String clazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.logger = Logger.getLogger(clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDebugEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTraceEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(String s, Throwable throwable)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">debug</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        logger.info(s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">trace</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">warn</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SqlSessionFactoryBean <span class="title">sqlSessionFactoryBean</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    SqlSessionFactoryBean factoryBean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">    <span class="comment">//配置log</span></span><br><span class="line">    LogFactory.useCustomLogging(MyLog<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="comment">//或</span></span><br><span class="line">    org.apache.ibatis.session.Configuration configuration = <span class="keyword">new</span> org.apache.ibatis.session.Configuration();</span><br><span class="line">    configuration.setLogImpl(MyLog<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    factoryBean.setConfiguration(configuration);</span><br><span class="line">    factoryBean.setDataSource(dataSource);</span><br><span class="line">    <span class="keyword">return</span> factoryBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/04/20/ES6%E2%80%94babel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/20/ES6%E2%80%94babel/" itemprop="url">ES6—babel</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-20T00:00:00+08:00">
                2019-04-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Node/" itemprop="url" rel="index">
                    <span itemprop="name">Node</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Babel是一个广泛使用的转码器，可以将ES6代码转为ES5代码，从而在现有环境执行。</p>
<h4 id="一、配置文件-babelrc-和转码规则"><a href="#一、配置文件-babelrc-和转码规则" class="headerlink" title="一、配置文件.babelrc 和转码规则"></a>一、配置文件.babelrc 和转码规则</h4><p>Babel的配置文件是.babelrc，存放在项目的根目录下。使用Babel的第一步，就是配置这个文件。</p>
<p>该文件用来设置转码规则和插件，基本格式如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"presets"</span>: [],</span><br><span class="line">  <span class="string">"plugins"</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>presets字段设定转码规则，官方提供以下的规则集，你可以根据需要安装。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#ES2015转码规则</span><br><span class="line">$ npm install --save-dev babel-preset-es2015</span><br><span class="line"></span><br><span class="line">#react转码规则</span><br><span class="line">$ npm install --save-dev babel-preset-react</span><br><span class="line"></span><br><span class="line">#ES7不同阶段语法提案的转码规则（共有4个阶段），选装一个</span><br><span class="line">$ npm install --save-dev babel-preset-stage-0</span><br><span class="line">$ npm install --save-dev babel-preset-stage-1</span><br><span class="line">$ npm install --save-dev babel-preset-stage-2</span><br><span class="line">$ npm install --save-dev babel-preset-stage-3</span><br></pre></td></tr></table></figure>
<p>然后，将这些规则加入.babelrc。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"presets"</span>: [</span><br><span class="line">    <span class="string">"es2015"</span>,</span><br><span class="line">    <span class="string">"react"</span>,</span><br><span class="line">    <span class="string">"stage-2"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"plugins"</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，以下所有Babel工具和模块的使用，都必须先写好.babelrc。</p>
<h4 id="二、命令行转码babel-cli"><a href="#二、命令行转码babel-cli" class="headerlink" title="二、命令行转码babel-cli"></a>二、命令行转码babel-cli</h4><p>Babel提供babel-cli工具，用于命令行转码。npm install –save-dev babel-cli</p>
<p>命令行中调用babel，两种方式：</p>
<p>1、配置文件中加入：</p>
<p>“build”: “babel src -d lib”</p>
<p>如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"6-babel"</span>,</span><br><span class="line">  <span class="string">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  <span class="string">"description"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="string">"main"</span>: <span class="string">"index.js"</span>,</span><br><span class="line">  <span class="string">"scripts"</span>: &#123;</span><br><span class="line">    <span class="string">"build"</span>: <span class="string">"babel src -d lib"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"author"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="string">"license"</span>: <span class="string">"ISC"</span>,</span><br><span class="line">  <span class="string">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="string">"babel-cli"</span>: <span class="string">"^6.26.0"</span>,</span><br><span class="line">    <span class="string">"babel-preset-es2015"</span>: <span class="string">"^6.24.1"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>npm run build</p>
<p>2、进入node_modules文件夹，再进入.bin文件夹，然后执行在命令行中执行babel src -d lib</p>
<p>3、测试</p>
<p>新建一个文件，写入ES6语法，直接运行，报错</p>
<p>执行npm run build</p>
<p>结果：</p>
<p><img src="https://img.huyunshun.com/img1/imgclipssssssssssssdfasdfasf.png" alt=""></p>
<p>再运行，没问题</p>
<h4 id="三、babel-node"><a href="#三、babel-node" class="headerlink" title="三、babel-node"></a>三、babel-node</h4><p>babel-cli工具自带一个babel-node命令，提供一个支持ES6的REPL环境。它支持Node的REPL环境的所有功能，而且可以直接运行ES6代码。</p>
<p>它不用单独安装，而是随babel-cli一起安装。然后，执行babel-node就进入PEPL环境。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ babel-node</span><br><span class="line">&gt; (<span class="function"><span class="params">x</span> =&gt;</span> x * <span class="number">2</span>)(<span class="number">1</span>)</span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>babel-node命令可以直接运行ES6脚本。将上面的代码放入脚本文件es6.js，然后直接运行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ babel-node es6.js</span><br><span class="line">2</span><br></pre></td></tr></table></figure>
<p>babel-node也可以安装在项目中。$ npm install –save-dev babel-cli</p>
<p>然后，改写package.json。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"scripts"</span>: &#123;</span><br><span class="line">    <span class="string">"script-name"</span>: <span class="string">"babel-node script.js"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码中，使用babel-node替代node，这样script.js本身就不用做任何转码处理。</p>
<h4 id="四、babel-register"><a href="#四、babel-register" class="headerlink" title="四、babel-register"></a>四、babel-register</h4><p>babel-register模块改写require命令，为它加上一个钩子。此后，每当使用require加载.js、.jsx、.es和.es6后缀名的文件，就会先用Babel进行转码。</p>
<p>$ npm install –save-dev babel-register</p>
<p>使用时，必须首先加载babel-register。</p>
<p>require(“babel-register”);<br>require(“./index.js”);</p>
<p>然后，就不需要手动对index.js转码了。</p>
<p>babel-register只会对require命令加载的文件转码，而不会对当前文件转码。另外，由于它是实时转码，所以只适合在开发环境使用。</p>
<h4 id="五、babel-core"><a href="#五、babel-core" class="headerlink" title="五、babel-core"></a>五、babel-core</h4><p>如果某些代码需要调用Babel的API进行转码，就要使用babel-core模块。</p>
<p>$ npm install babel-core –save</p>
<h4 id="六、babel-polyfill"><a href="#六、babel-polyfill" class="headerlink" title="六、babel-polyfill"></a>六、babel-polyfill</h4><p>Babel默认只转换新的JavaScript句法（syntax），而不转换新的API，比如Iterator、Generator、Set、Maps、Proxy、Reflect、Symbol、Promise等全局对象，以及一些定义在全局对象上的方法（比如Object.assign）都不会转码。</p>
<p>举例来说，ES6在Array对象上新增了Array.from方法。Babel就不会转码这个方法。如果想让这个方法运行，必须使用babel-polyfill，为当前环境提供一个垫片。</p>
<p>$ npm install –save babel-polyfill</p>
<p>然后，在脚本头部，加入如下一行代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import &#39;babel-polyfill&#39;;</span><br><span class="line">&#x2F;&#x2F; 或者</span><br><span class="line">require(&#39;babel-polyfill&#39;);</span><br></pre></td></tr></table></figure>
<p>Babel默认不转码的API非常多，详细清单可以查看babel-plugin-transform-runtime模块的definitions.js文件。</p>
<h4 id="七、浏览器环境"><a href="#七、浏览器环境" class="headerlink" title="七、浏览器环境"></a>七、浏览器环境</h4><p>Babel也可以用于浏览器环境。但是，从Babel 6.0开始，不再直接提供浏览器版本，而是要用构建工具构建出来。如果你没有或不想使用构建工具，可以通过安装5.x版本的babel-core模块获取。</p>
<p>$ npm install babel-core@old</p>
<p>运行上面的命令以后，就可以在当前目录的node_modules/babel-core/子目录里面，找到babel的浏览器版本browser.js（未精简）和browser.min.js（已精简）。</p>
<p>然后，将下面的代码插入网页。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">"node_modules/babel-core/browser.js"</span>&gt;&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&lt;script type="text/</span>babel<span class="string">"&gt;</span></span><br><span class="line"><span class="string">// Your ES6 code</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>
<p>上面代码中，browser.js是Babel提供的转换器脚本，可以在浏览器运行。用户的ES6脚本放在script标签之中，但是要注明type=”text/babel”。</p>
<p>另一种方法是使用babel-standalone模块提供的浏览器版本，将其插入网页。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.4.4/babel.min.js"</span>&gt;&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&lt;script type="text/</span>babel<span class="string">"&gt;</span></span><br><span class="line"><span class="string">// Your ES6 code</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string">注意，网页中实时将ES6代码转为ES5，对性能会有影响。生产环境需要加载已经转码完成的脚本。</span></span><br></pre></td></tr></table></figure>
<p>下面是如何将代码打包成浏览器可以使用的脚本，以Babel配合Browserify为例。首先，安装babelify模块。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --save-dev babelify babel-preset-es2015</span><br><span class="line">然后，再用命令行转换ES6脚本。</span><br><span class="line"></span><br><span class="line">$  browserify script.js -o bundle.js \</span><br><span class="line">  -t [ babelify --presets [ es2015 react ] ]</span><br></pre></td></tr></table></figure>
<p>上面代码将ES6脚本script.js，转为bundle.js，浏览器直接加载后者就可以了。</p>
<p>在package.json设置下面的代码，就不用每次命令行都输入参数了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"browserify"</span>: &#123;</span><br><span class="line">    <span class="string">"transform"</span>: [[<span class="string">"babelify"</span>, &#123; <span class="string">"presets"</span>: [<span class="string">"es2015"</span>] &#125;]]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/04/19/TypeScript%E2%80%94%E2%80%94orm%E6%A1%86%E6%9E%B6-TypeORM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/19/TypeScript%E2%80%94%E2%80%94orm%E6%A1%86%E6%9E%B6-TypeORM/" itemprop="url">TypeScript——orm框架-TypeORM</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-19T00:00:00+08:00">
                2019-04-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Node/" itemprop="url" rel="index">
                    <span itemprop="name">Node</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在nodejs中也有比较好用的ORM框架，比如TypeORM，Sequelize等等。</p>
<p>TypeORM 是一个 ORM 框架，它可以运行在 NodeJS、Browser、Cordova、PhoneGap、Ionic、React Native、Expo 和 Electron 平台上，可以与 TypeScript 和 JavaScript (ES5,ES6,ES7,ES8)一起使用。 它的目标是始终支持最新的 JavaScript 特性并提供额外的特性以帮助你开发任何使用数据库的（不管是只有几张表的小型应用还是拥有多数据库的大型企业应用）应用程序。</p>
<p>不同于现有的所有其他 JavaScript ORM 框架，TypeORM 支持 Active Record 和 Data Mapper 模式，这意味着你可以以最高效的方式编写高质量的、松耦合的、可扩展的、可维护的应用程序。</p>
<p>TypeORM 参考了很多其他优秀 ORM 的实现, 比如 Hibernate, Doctrine 和 Entity Framework。</p>
<p>TypeORM 的一些特性:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">同时支持 DataMapper 和 ActiveRecord (随你选择)</span><br><span class="line">实体和列</span><br><span class="line">数据库特性列类型</span><br><span class="line">实体管理</span><br><span class="line">存储库和自定义存储库</span><br><span class="line">清晰的对象关系模型</span><br><span class="line">关联（关系）</span><br><span class="line">贪婪和延迟关系</span><br><span class="line">单向的，双向的和自引用的关系</span><br><span class="line">支持多重继承模式</span><br><span class="line">级联</span><br><span class="line">索引</span><br><span class="line">事务</span><br><span class="line">迁移和自动迁移</span><br><span class="line">连接池</span><br><span class="line">主从复制</span><br><span class="line">使用多个数据库连接</span><br><span class="line">使用多个数据库类型</span><br><span class="line">跨数据库和跨模式查询</span><br><span class="line">优雅的语法，灵活而强大的 QueryBuilder</span><br><span class="line">左联接和内联接</span><br><span class="line">使用联查查询的适当分页</span><br><span class="line">查询缓存</span><br><span class="line">原始结果流</span><br><span class="line">日志</span><br><span class="line">监听者和订阅者（钩子）</span><br><span class="line">支持闭包表模式</span><br><span class="line">在模型或者分离的配置文件中声明模式</span><br><span class="line">json &#x2F; xml &#x2F; yml &#x2F; env 格式的连接配置</span><br><span class="line">支持 MySQL &#x2F; MariaDB &#x2F; Postgres &#x2F; SQLite &#x2F; Microsoft SQL Server &#x2F; Oracle &#x2F; sql.js</span><br><span class="line">支持 MongoDB NoSQL 数据库</span><br><span class="line">可在 NodeJS &#x2F; 浏览器 &#x2F; Ionic &#x2F; Cordova &#x2F; React Native &#x2F; Expo &#x2F; Electron 平台上使用</span><br><span class="line">支持 TypeScript 和 JavaScript</span><br><span class="line">生成高性能、灵活、清晰和可维护的代码</span><br><span class="line">遵循所有可能的最佳实践</span><br><span class="line">命令行工具</span><br></pre></td></tr></table></figure>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install typeorm --save</span><br><span class="line">npm install reflect-metadata --save</span><br></pre></td></tr></table></figure>
<p>并且需要在应用程序的全局位置导入（例如在app.ts中）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &quot;reflect-metadata&quot;;</span><br></pre></td></tr></table></figure>
<p>你可能还需要安装 node typings(以此来使用 Node 的智能提示):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install @types&#x2F;node --save</span><br></pre></td></tr></table></figure>
<p>安装数据库驱动:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">MySQL 或者 MariaDB</span><br><span class="line">npm install mysql --save (也可以安装 mysql2)</span><br><span class="line"></span><br><span class="line">PostgreSQL</span><br><span class="line">npm install pg --save</span><br><span class="line"></span><br><span class="line">SQLite</span><br><span class="line">npm install sqlite3 --save</span><br><span class="line"></span><br><span class="line">Microsoft SQL Server</span><br><span class="line">npm install mssql --save</span><br><span class="line"></span><br><span class="line">sql.js</span><br><span class="line">npm install sql.js --save</span><br><span class="line"></span><br><span class="line">Oracle</span><br><span class="line">npm install oracledb --save</span><br></pre></td></tr></table></figure>
<ul>
<li>TypeScript 配置 *<br>此外，请确保你使用的 TypeScript 编译器版本是2.3或更高版本，并且已经在 tsconfig.json 中启用了以下设置:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;emitDecoratorMetadata&quot;: true,</span><br><span class="line">&quot;experimentalDecorators&quot;: true,</span><br></pre></td></tr></table></figure>
除此之外，你可能还需要在编译器选项的 lib 中启用 es6，或者安装 es6-shim 的 @types。</li>
</ul>
<h3 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h3><p>全局安装 TypeORM:npm install typeorm -g</p>
<p>然后转到要创建新项目的目录并运行命令：typeorm init –name MyProject –database mysql</p>
<p>其中 name 是项目的名称，database 是将使用的数据库。</p>
<p>数据库可以是以下值之一: mysql、 mariadb、 postgres、 sqlite、 mssql、 oracle、 mongodb、 cordova、 react-native、 expo、 nativescript.</p>
<p>此命令将在 MyProject 目录中生成一个包含以下文件的新项目:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MyProject</span><br><span class="line">├── src              &#x2F;&#x2F; TypeScript 代码</span><br><span class="line">│   ├── entity       &#x2F;&#x2F; 存储实体（数据库模型）的位置</span><br><span class="line">│   │   └── User.ts  &#x2F;&#x2F; 示例 entity</span><br><span class="line">│   ├── migration    &#x2F;&#x2F; 存储迁移的目录</span><br><span class="line">│   └── index.ts     &#x2F;&#x2F; 程序执行主文件</span><br><span class="line">├── .gitignore       &#x2F;&#x2F; gitignore文件</span><br><span class="line">├── ormconfig.json   &#x2F;&#x2F; ORM和数据库连接配置</span><br><span class="line">├── package.json     &#x2F;&#x2F; node module 依赖</span><br><span class="line">├── README.md        &#x2F;&#x2F; 简单的 readme 文件</span><br><span class="line">└── tsconfig.json    &#x2F;&#x2F; TypeScript 编译选项</span><br></pre></td></tr></table></figure>
<p>或者在现有 node 项目上运行 typeorm init，但要注意，此操作可能会覆盖已有的某些文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">D:\mydoc\NodeJs\前端-study-demo\typeorm-demo&gt;typeorm init</span><br><span class="line">Project created inside current directory.</span><br></pre></td></tr></table></figure>
<p>接下来安装项目依赖项：npm install</p>
<p>在安装过程中，编辑 ormconfig.json 文件并在其中编辑自己的数据库连接配置选项：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ormconfig.json</span></span><br><span class="line">设置 synchronize 可确保每次运行应用程序时实体都将与数据库同步</span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">"type"</span>: <span class="string">"mysql"</span>,</span><br><span class="line">   <span class="attr">"host"</span>: <span class="string">"172.16.3.34"</span>,</span><br><span class="line">   <span class="attr">"port"</span>: <span class="number">3306</span>,</span><br><span class="line">   <span class="attr">"username"</span>: <span class="string">"root"</span>,</span><br><span class="line">   <span class="attr">"password"</span>: <span class="string">"root"</span>,</span><br><span class="line">   <span class="attr">"database"</span>: <span class="string">"root"</span>,</span><br><span class="line">   <span class="attr">"synchronize"</span>: <span class="literal">true</span>,</span><br><span class="line">   <span class="attr">"logging"</span>: <span class="literal">false</span>,</span><br><span class="line">   <span class="attr">"entities"</span>: [</span><br><span class="line">      <span class="string">"src/entity/**/*.ts"</span></span><br><span class="line">   ],</span><br><span class="line">   <span class="attr">"migrations"</span>: [</span><br><span class="line">      <span class="string">"src/migration/**/*.ts"</span></span><br><span class="line">   ],</span><br><span class="line">   <span class="attr">"subscribers"</span>: [</span><br><span class="line">      <span class="string">"src/subscriber/**/*.ts"</span></span><br><span class="line">   ],</span><br><span class="line">   <span class="attr">"cli"</span>: &#123;</span><br><span class="line">      <span class="attr">"entitiesDir"</span>: <span class="string">"src/entity"</span>,</span><br><span class="line">      <span class="attr">"migrationsDir"</span>: <span class="string">"src/migration"</span>,</span><br><span class="line">      <span class="attr">"subscribersDir"</span>: <span class="string">"src/subscriber"</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//tsconfig.json</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">"compilerOptions"</span>: &#123;</span><br><span class="line">      <span class="attr">"lib"</span>: [</span><br><span class="line">         <span class="string">"es5"</span>,</span><br><span class="line">         <span class="string">"es6"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"target"</span>: <span class="string">"es5"</span>,</span><br><span class="line">      <span class="attr">"module"</span>: <span class="string">"commonjs"</span>,</span><br><span class="line">      <span class="attr">"moduleResolution"</span>: <span class="string">"node"</span>,</span><br><span class="line">      <span class="attr">"outDir"</span>: <span class="string">"./build"</span>,</span><br><span class="line">      <span class="attr">"emitDecoratorMetadata"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">"experimentalDecorators"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">"sourceMap"</span>: <span class="literal">true</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//package.json</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">"name"</span>: <span class="string">"typeorm-demo"</span>,</span><br><span class="line">   <span class="attr">"version"</span>: <span class="string">"0.0.1"</span>,</span><br><span class="line">   <span class="attr">"description"</span>: <span class="string">"Awesome project developed with TypeORM."</span>,</span><br><span class="line">   <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">      <span class="attr">"ts-node"</span>: <span class="string">"3.3.0"</span>,</span><br><span class="line">      <span class="attr">"@types/node"</span>: <span class="string">"^8.0.29"</span>,</span><br><span class="line">      <span class="attr">"typescript"</span>: <span class="string">"3.3.3333"</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">      <span class="attr">"typeorm"</span>: <span class="string">"0.2.22"</span>,</span><br><span class="line">      <span class="attr">"reflect-metadata"</span>: <span class="string">"^0.1.10"</span>,</span><br><span class="line">      <span class="attr">"mysql"</span>: <span class="string">"^2.14.1"</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">      <span class="attr">"start"</span>: <span class="string">"ts-node src/index.ts"</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; typeorm-demo@0.0.1 start D:\mydoc\NodeJs\前端-study-demo\typeorm-demo</span><br><span class="line">&gt; ts-node src&#x2F;index.ts</span><br><span class="line"></span><br><span class="line">Inserting a new user into the database...</span><br><span class="line">Saved a new user with id: 11</span><br><span class="line">Loading users from the database...</span><br><span class="line">Loaded users:  [ User &#123; id: 1, firstName: &#39;Timber&#39;, lastName: &#39;Saw&#39;, age: 25 &#125;,</span><br><span class="line">  User &#123; id: 2, firstName: &#39;Timber&#39;, lastName: &#39;Saw&#39;, age: 25 &#125;,</span><br><span class="line">  User &#123; id: 3, firstName: &#39;Timber&#39;, lastName: &#39;Saw&#39;, age: 25 &#125;,</span><br><span class="line">  User &#123; id: 10, firstName: &#39;sundial&#39;, lastName: &#39;3434&#39;, age: 20 &#125;,</span><br><span class="line">  User &#123; id: 11, firstName: &#39;Timber&#39;, lastName: &#39;Saw&#39;, age: 25 &#125; ]</span><br><span class="line">Here you can setup and run express&#x2F;koa&#x2F;any other framework.</span><br></pre></td></tr></table></figure>
<p>绝大多数情况下，你只需要配置 host, username, password, database 或者 port 即可。</p>
<p>完成配置并安装所有 node modules 后，即可运行应用程序：npm start</p>
<p>还可以通过运行 typeorm init –name MyProject –database mysql –express 来生成一个更高级的 Express 项目</p>
<h3 id="分步指南"><a href="#分步指南" class="headerlink" title="分步指南"></a>分步指南</h3><h4 id="创建实体"><a href="#创建实体" class="headerlink" title="创建实体"></a>创建实体</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Entity, PrimaryGeneratedColumn, Column&#125; <span class="keyword">from</span> <span class="string">"typeorm"</span>;</span><br><span class="line"></span><br><span class="line">@Entity()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    @PrimaryGeneratedColumn()</span><br><span class="line">    id: number;</span><br><span class="line">    @Column()</span><br><span class="line">    firstName: string;</span><br><span class="line">    @Column()</span><br><span class="line">    lastName: string;</span><br><span class="line">    @Column()</span><br><span class="line">    age: number;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每个表都必须至少有一个主键列。使用 @PrimaryColumn 修饰符。自动生成的列@PrimaryGeneratedColumn()</p>
<h4 id="列数据类型"><a href="#列数据类型" class="headerlink" title="列数据类型"></a>列数据类型</h4><p>见最后</p>
<h4 id="创建数据库连接"><a href="#创建数据库连接" class="headerlink" title="创建数据库连接"></a>创建数据库连接</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">createConnection(&#123;</span><br><span class="line">    type: <span class="string">"mysql"</span>,</span><br><span class="line">    host: <span class="string">"localhost"</span>,</span><br><span class="line">    port: <span class="number">3306</span>,</span><br><span class="line">    username: <span class="string">"root"</span>,</span><br><span class="line">    password: <span class="string">"admin"</span>,</span><br><span class="line">    database: <span class="string">"test"</span>,</span><br><span class="line">    entities: [</span><br><span class="line">        Photo<span class="comment">//引用目录下的所有实体__dirname + "/entity/*.js"</span></span><br><span class="line">    ],</span><br><span class="line">    synchronize: <span class="literal">true</span>,</span><br><span class="line">    logging: <span class="literal">false</span></span><br><span class="line">&#125;).then(<span class="function"><span class="params">connection</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 这里可以写实体操作相关的代码 </span></span><br><span class="line">&#125;).catch(<span class="function"><span class="params">error</span> =&gt;</span> <span class="built_in">console</span>.log(error));</span><br></pre></td></tr></table></figure>
<p>可以吧数据库配置信息放到ormconfig.json</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="string">"name"</span>: <span class="string">"default"</span>,</span><br><span class="line">   <span class="string">"type"</span>: <span class="string">"mysql"</span>,</span><br><span class="line">   <span class="string">"host"</span>: <span class="string">"172.16.3.34"</span>,</span><br><span class="line">   <span class="string">"port"</span>: <span class="number">3306</span>,</span><br><span class="line">   <span class="string">"username"</span>: <span class="string">"root"</span>,</span><br><span class="line">   <span class="string">"password"</span>: <span class="string">"root"</span>,</span><br><span class="line">   <span class="string">"database"</span>: <span class="string">"sonar"</span>,</span><br><span class="line">   <span class="string">"synchronize"</span>: <span class="literal">true</span>,</span><br><span class="line">   <span class="string">"logging"</span>: <span class="literal">false</span>,</span><br><span class="line">   <span class="string">"cache"</span>: <span class="literal">true</span>,</span><br><span class="line">   <span class="string">"entities"</span>: [</span><br><span class="line">      <span class="string">"src/entity/**/*.ts"</span></span><br><span class="line">   ],</span><br><span class="line">   <span class="string">"migrations"</span>: [</span><br><span class="line">      <span class="string">"src/migration/**/*.ts"</span></span><br><span class="line">   ],</span><br><span class="line">   <span class="string">"subscribers"</span>: [</span><br><span class="line">      <span class="string">"src/subscriber/**/*.&#123;ts,js&#125;"</span></span><br><span class="line">   ],</span><br><span class="line">   <span class="string">"cli"</span>: &#123;</span><br><span class="line">      <span class="string">"entitiesDir"</span>: <span class="string">"src/entity"</span>,</span><br><span class="line">      <span class="string">"migrationsDir"</span>: <span class="string">"src/migration"</span>,</span><br><span class="line">      <span class="string">"subscribersDir"</span>: <span class="string">"src/subscriber"</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">import &quot;reflect-metadata&quot;;</span><br><span class="line">import &#123;createConnection&#125; from &quot;typeorm&quot;;</span><br><span class="line">import &#123;User&#125; from &quot;.&#x2F;entity&#x2F;User&quot;;</span><br><span class="line">createConnection().then(connection &#x3D;&gt; &#123;</span><br><span class="line">    &#x2F;&#x2F; 这里可以写实体操作相关的代码</span><br><span class="line">    connection.manager.find(User).then(o&#x3D;&gt;console.log(&quot;Loaded users: &quot;, o));</span><br><span class="line">&#125;).catch(error &#x3D;&gt; console.log(error));</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line">D:\mydoc\NodeJs\前端-study-demo\typeorm-demo&gt;ts-node src&#x2F;test1</span><br><span class="line">Loaded users:  [ User &#123; id: 1, firstName: &#39;Timber&#39;, lastName: &#39;Saw&#39;, age: 25 &#125;,</span><br><span class="line">  User &#123; id: 2, firstName: &#39;Timber&#39;, lastName: &#39;Saw&#39;, age: 25 &#125;,</span><br><span class="line">  User &#123; id: 3, firstName: &#39;Timber&#39;, lastName: &#39;Saw&#39;, age: 25 &#125;,</span><br><span class="line">  User &#123; id: 10, firstName: &#39;sundial&#39;, lastName: &#39;3434&#39;, age: 20 &#125;,</span><br><span class="line">  User &#123; id: 11, firstName: &#39;Timber&#39;, lastName: &#39;Saw&#39;, age: 25 &#125;,</span><br><span class="line">  User &#123; id: 12, firstName: &#39;Timber&#39;, lastName: &#39;Saw&#39;, age: 25 &#125; ]</span><br></pre></td></tr></table></figure>
<h4 id="使用async-await语法"><a href="#使用async-await语法" class="headerlink" title="使用async/await语法"></a>使用async/await语法</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"reflect-metadata"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;createConnection&#125; <span class="keyword">from</span> <span class="string">"typeorm"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;User&#125; <span class="keyword">from</span> <span class="string">"./entity/User"</span>;</span><br><span class="line">createConnection().then(<span class="keyword">async</span> connection =&gt; &#123;</span><br><span class="line">    <span class="comment">// 这里可以写实体操作相关的代码</span></span><br><span class="line">    <span class="keyword">const</span> users = <span class="keyword">await</span> connection.manager.find(User);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Loaded users: "</span>, users);</span><br><span class="line"></span><br><span class="line">&#125;).catch(<span class="function"><span class="params">error</span> =&gt;</span> <span class="built_in">console</span>.log(error));</span><br></pre></td></tr></table></figure>
<h4 id="使用Repositories"><a href="#使用Repositories" class="headerlink" title="使用Repositories"></a>使用Repositories</h4><p>使用Repository来代替EntityManage。每个实体都有自己的repository，可以对这个实体进行任何操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import &quot;reflect-metadata&quot;;</span><br><span class="line">import &#123;createConnection&#125; from &quot;typeorm&quot;;</span><br><span class="line">import &#123;User&#125; from &quot;.&#x2F;entity&#x2F;User&quot;;</span><br><span class="line">createConnection().then(async connection &#x3D;&gt; &#123;</span><br><span class="line">    &#x2F;&#x2F; 使用repository</span><br><span class="line">    const repository &#x3D; await connection.getRepository(User);</span><br><span class="line">    let user &#x3D; await repository.findOne(2);</span><br><span class="line">    user.firstName&#x3D;&quot;11111111111&quot;;</span><br><span class="line">    await repository.save(user);</span><br><span class="line">    console.log(&quot;Loaded users: &quot;, await repository.find());</span><br><span class="line">    await repository.remove(user);</span><br><span class="line">    process.exit();</span><br><span class="line">&#125;).catch(error &#x3D;&gt; console.log(error));</span><br></pre></td></tr></table></figure>
<h4 id="封装一个Repository"><a href="#封装一个Repository" class="headerlink" title="封装一个Repository"></a>封装一个Repository</h4><h4 id="ActiveRecord方式实现"><a href="#ActiveRecord方式实现" class="headerlink" title="ActiveRecord方式实现"></a>ActiveRecord方式实现</h4><p>实体：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Entity, PrimaryGeneratedColumn, Column, BaseEntity&#125; <span class="keyword">from</span> <span class="string">"typeorm"</span>;</span><br><span class="line"></span><br><span class="line">@Entity(<span class="string">"user"</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span></span>&#123;</span><br><span class="line">    @PrimaryGeneratedColumn()</span><br><span class="line">    id: number;</span><br><span class="line">    @Column()</span><br><span class="line">    firstName: string;</span><br><span class="line">    @Column()</span><br><span class="line">    lastName: string;</span><br><span class="line">    @Column()</span><br><span class="line">    age: number;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>操作：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"reflect-metadata"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;createConnection&#125; <span class="keyword">from</span> <span class="string">"typeorm"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Person&#125; <span class="keyword">from</span> <span class="string">"./entity/Person"</span>;</span><br><span class="line">createConnection().then(<span class="keyword">async</span> connection =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Loaded users: "</span>, <span class="keyword">await</span> Person.findOne(<span class="number">2</span>));</span><br><span class="line">    process.exit();</span><br><span class="line">&#125;).catch(<span class="function"><span class="params">error</span> =&gt;</span> <span class="built_in">console</span>.log(error));</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">D:\mydoc\NodeJs\前端-study-demo\typeorm-demo&gt;ts-node src&#x2F;test2</span><br><span class="line">Loaded users:  Person &#123; id: 2, firstName: &#39;Timber&#39;, lastName: &#39;Saw&#39;, age: 25 &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Caching-queries-缓存查询"><a href="#Caching-queries-缓存查询" class="headerlink" title="Caching queries (缓存查询)"></a>Caching queries (缓存查询)</h3><p>它缓存的实现，主要依赖于，自己在数据库里面建立一张缓存表，用的不是内存缓存，这样有好有坏吧，和我们的业务场景其实是不太适用的。这样做的好处，就是它不会把我们的内存跑满，而且也能大幅提高查询速度。但是我们更希望的是一个内存缓存。</p>
<p>它的用法，就是在数据库配置的过程中，增加一个cache字段。”cache”: true,</p>
<p>可以在这个方法中使用：getMany, getOne, getRawMany, getRawOne and getCount  find, findAndCount, findByIds, and count</p>
<p>使用例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> users = <span class="keyword">await</span> connection</span><br><span class="line">    .createQueryBuilder(User, <span class="string">"user"</span>)</span><br><span class="line">    .where(<span class="string">"user.isAdmin = :isAdmin"</span>, &#123; <span class="attr">isAdmin</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">    .cache(<span class="literal">true</span>)</span><br><span class="line">    .getMany();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> users = <span class="keyword">await</span> connection</span><br><span class="line">    .getRepository(User)</span><br><span class="line">    .find(&#123;</span><br><span class="line">        where: &#123; <span class="attr">isAdmin</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">        cache: <span class="literal">true</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> users = <span class="keyword">await</span> connection</span><br><span class="line">    .createQueryBuilder(User, <span class="string">"user"</span>)</span><br><span class="line">    .where(<span class="string">"user.isAdmin = :isAdmin"</span>, &#123; <span class="attr">isAdmin</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">    .cache(<span class="number">60000</span>) <span class="comment">// 设置缓存时间 1 minute</span></span><br><span class="line">    .getMany();</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置缓存时间</span></span><br><span class="line">&#123;</span><br><span class="line">    cache: &#123;</span><br><span class="line">        duration: <span class="number">30000</span> <span class="comment">// 30 seconds</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> users = <span class="keyword">await</span> connection</span><br><span class="line">    .createQueryBuilder(User, <span class="string">"user"</span>)</span><br><span class="line">    .where(<span class="string">"user.isAdmin = :isAdmin"</span>, &#123; <span class="attr">isAdmin</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">    .cache(<span class="string">"users_admins"</span>, <span class="number">25000</span>)<span class="comment">//缓存名称和时间</span></span><br><span class="line">    .getMany();</span><br></pre></td></tr></table></figure>
<p>也可以用redis当作缓存模块，这样也是比较不错的做法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    type: <span class="string">"mysql"</span>,</span><br><span class="line">    host: <span class="string">"localhost"</span>,</span><br><span class="line">    ...</span><br><span class="line">    cache: &#123;</span><br><span class="line">        type: <span class="string">"redis"</span>,</span><br><span class="line">        options: &#123;</span><br><span class="line">            host: <span class="string">"localhost"</span>,</span><br><span class="line">            port: <span class="number">6379</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="对应关系"><a href="#对应关系" class="headerlink" title="对应关系"></a>对应关系</h3><h4 id="一对一"><a href="#一对一" class="headerlink" title="一对一"></a>一对一</h4><p>要与另一个类创建一对一的关系：</p>
<p>其他参考：<a href="https://typeorm.io" target="_blank" rel="noopener">https://typeorm.io</a></p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="基本配置参数"><a href="#基本配置参数" class="headerlink" title="基本配置参数"></a>基本配置参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">type: 当前要连接的数据库类型(mysql,mssql, moongo, ...)</span><br><span class="line">host: 数据库服务暴露的host</span><br><span class="line">port: 数据库服务暴露的端口</span><br><span class="line">username: 连接数据库服务的用户名</span><br><span class="line">password: 连接数据库服务的用户名</span><br><span class="line">database: 连接数据库名</span><br></pre></td></tr></table></figure>
<h4 id="额外参数"><a href="#额外参数" class="headerlink" title="额外参数"></a>额外参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">name: 设置连接名，连多个数据库的时候，需要获取连接的时候可用 getConnection(&#39;name&#39;) 的方式取得对应的数据库连接；</span><br><span class="line">entities: 要加载并用于此连接的实体。写法类似：</span><br><span class="line"> entities: [Post, Category, &quot;entity&#x2F;*.js&quot;, &quot;modules&#x2F;**&#x2F;entity&#x2F;*.js&quot;]</span><br><span class="line">entityPrefix: 表名前缀</span><br><span class="line">extra: 拓展的参数值, 如设置连接池连接数量等;</span><br><span class="line">logging：</span><br><span class="line">查询(query):记录所有查询。</span><br><span class="line">错误(error):记录所有失败的查询和错误。</span><br><span class="line">模式(schema):记录模式构建过程。</span><br><span class="line">警告(warn):记录内部orm警告。</span><br><span class="line">记录(info):内部orm信息信息。</span><br><span class="line">日志(log):记录内部orm日志消息。</span><br><span class="line"></span><br><span class="line">如果只是简单的打印基本的数据库操作(包含错误)则设置 logging: true</span><br><span class="line">如果要打印以上全部类型，则设置 logging: &#39;all&#39;</span><br><span class="line">如果只是打印其中的1～2个（如query, error），则可设置 logging: [&#39;query&#39;, &#39;error&#39;]</span><br><span class="line"></span><br><span class="line">logger: 可设置的类型有 advanced-console,simple-console,file, debug, 在开启 logging 的情况下，logger默认使用类型是 advanced-console, 这个模式会高亮字体和标示sql语句。</span><br><span class="line">cache: 对查询的 sql 结果进行缓存。 支持数据库或者redis。看了下api，redis更为方便一点。</span><br><span class="line">cache: &#123;</span><br><span class="line">        type: &#39;redis&#39;, &#x2F;&#x2F; 必须参数</span><br><span class="line">        options: &#123;</span><br><span class="line">            host: &#39;localhost&#39;,</span><br><span class="line">            port: 6379,</span><br><span class="line">            username: &#39;&#39;,</span><br><span class="line">            password:&#39;&#39;,</span><br><span class="line">            db: 1,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="创建多个数据库连接"><a href="#创建多个数据库连接" class="headerlink" title="创建多个数据库连接"></a>创建多个数据库连接</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">   <span class="attr">"name"</span>: <span class="string">"dev"</span>,</span><br><span class="line">   <span class="attr">"type"</span>: <span class="string">"mysql"</span>,</span><br><span class="line">   <span class="attr">"host"</span>: <span class="string">"172.16.3.34"</span>,</span><br><span class="line">   <span class="attr">"port"</span>: <span class="number">3306</span>,</span><br><span class="line">   <span class="attr">"username"</span>: <span class="string">"root"</span>,</span><br><span class="line">   <span class="attr">"password"</span>: <span class="string">"root"</span>,</span><br><span class="line">   <span class="attr">"database"</span>: <span class="string">"sonar"</span>,</span><br><span class="line">   <span class="attr">"synchronize"</span>: <span class="literal">true</span>,</span><br><span class="line">   <span class="attr">"logging"</span>: <span class="literal">false</span>,</span><br><span class="line">   <span class="attr">"entities"</span>: [</span><br><span class="line">      <span class="string">"src/entity/**/*.ts"</span></span><br><span class="line">   ],</span><br><span class="line">   <span class="attr">"migrations"</span>: [</span><br><span class="line">      <span class="string">"src/migration/**/*.ts"</span></span><br><span class="line">   ],</span><br><span class="line">   <span class="attr">"subscribers"</span>: [</span><br><span class="line">      <span class="string">"src/subscriber/**/*.ts"</span></span><br><span class="line">   ],</span><br><span class="line">   <span class="attr">"cli"</span>: &#123;</span><br><span class="line">      <span class="attr">"entitiesDir"</span>: <span class="string">"src/entity"</span>,</span><br><span class="line">      <span class="attr">"migrationsDir"</span>: <span class="string">"src/migration"</span>,</span><br><span class="line">      <span class="attr">"subscribersDir"</span>: <span class="string">"src/subscriber"</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;,&#123;</span><br><span class="line">   <span class="attr">"name"</span>: <span class="string">"pro"</span>,</span><br><span class="line">   <span class="attr">"type"</span>: <span class="string">"mysql"</span>,</span><br><span class="line">   <span class="attr">"host"</span>: <span class="string">"172.16.3.34"</span>,</span><br><span class="line">   <span class="attr">"port"</span>: <span class="number">3306</span>,</span><br><span class="line">   <span class="attr">"username"</span>: <span class="string">"root"</span>,</span><br><span class="line">   <span class="attr">"password"</span>: <span class="string">"root"</span>,</span><br><span class="line">   <span class="attr">"database"</span>: <span class="string">"sonar"</span>,</span><br><span class="line">   <span class="attr">"synchronize"</span>: <span class="literal">true</span>,</span><br><span class="line">   <span class="attr">"entities"</span>: [</span><br><span class="line">      <span class="string">"src/entity/**/*.ts"</span></span><br><span class="line">   ],</span><br><span class="line">   <span class="attr">"migrations"</span>: [</span><br><span class="line">      <span class="string">"src/migration/**/*.ts"</span></span><br><span class="line">   ],</span><br><span class="line">   <span class="attr">"subscribers"</span>: [</span><br><span class="line">      <span class="string">"src/subscriber/**/*.ts"</span></span><br><span class="line">   ],</span><br><span class="line">   <span class="attr">"cli"</span>: &#123;</span><br><span class="line">      <span class="attr">"entitiesDir"</span>: <span class="string">"src/entity"</span>,</span><br><span class="line">      <span class="attr">"migrationsDir"</span>: <span class="string">"src/migration"</span>,</span><br><span class="line">      <span class="attr">"subscribersDir"</span>: <span class="string">"src/subscriber"</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">"logging"</span>: <span class="literal">true</span>, <span class="comment">// 开启所有数据库信息打印</span></span><br><span class="line">   <span class="attr">"logger"</span>: <span class="string">"advanced-console"</span>, <span class="comment">// 高亮字体的打印信息,</span></span><br><span class="line">   <span class="attr">"extra"</span>: &#123;</span><br><span class="line">      <span class="attr">"connectionLimit"</span>:  <span class="number">10</span>, <span class="comment">// 连接池最大连接数量, 查阅资料 建议是  core number  * 2 + n </span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>
<p>获取指定数据库连接：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">方式一：</span><br><span class="line">import &#123; getConnection &#125; from &#39;typeorm&#39;;</span><br><span class="line"></span><br><span class="line">const dev_connection &#x3D; getConnection(&#39;dev&#39;);</span><br><span class="line">const dev_connection &#x3D; getConnection(&#39;dev&#39;);</span><br><span class="line"></span><br><span class="line">方式二：</span><br><span class="line">import &#123; getConnectionManager &#125; from &quot;typeorm&quot;;</span><br><span class="line"></span><br><span class="line">const dev_connection &#x3D; getConnectionManager().get(&#39;dev&#39;);</span><br><span class="line">const dev_connection  &#x3D; getConnectionManager().get(&#39;pro&#39;);</span><br></pre></td></tr></table></figure>

<h4 id="使用-QueryBuilder"><a href="#使用-QueryBuilder" class="headerlink" title="使用 QueryBuilder"></a>使用 QueryBuilder</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">import &quot;reflect-metadata&quot;;</span><br><span class="line">import &#123;createConnection, getConnectionOptions,getManager&#125; from &quot;typeorm&quot;;</span><br><span class="line">import &#123;User&#125; from &quot;.&#x2F;entity&#x2F;User&quot;;</span><br><span class="line">&#x2F;&#x2F;import &#123;dev&#125; from &quot;.&#x2F;MyConnectionInfo&quot;;</span><br><span class="line">const myConn &#x3D; require(&quot;.&#x2F;MyConnectionInfo&quot;);</span><br><span class="line"></span><br><span class="line">async function testConn()&#123;</span><br><span class="line">    const connectionOptions &#x3D; await getConnectionOptions(&quot;dev&quot;);</span><br><span class="line">    const dev &#x3D; await createConnection(connectionOptions);</span><br><span class="line">    let user &#x3D; await dev</span><br><span class="line">        .getRepository(User)</span><br><span class="line">        .createQueryBuilder(&quot;user&quot;) &#x2F;&#x2F; 第一个参数是别名</span><br><span class="line">        .where(&quot;user.id &#x3D; 10&quot;)</span><br><span class="line">        .orderBy(&quot;user.id&quot;, &quot;DESC&quot;)</span><br><span class="line">        .skip(0)</span><br><span class="line">        .take(10)</span><br><span class="line">        .getMany();</span><br><span class="line">    console.log(user);</span><br><span class="line"></span><br><span class="line">    process.exit();</span><br><span class="line">&#125;</span><br><span class="line">testConn();</span><br></pre></td></tr></table></figure>

<p>附录：</p>
<p>列数据类型</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//主键自动生成列类型，主要为整型、小数等数值类型</span></span><br><span class="line"><span class="keyword">export</span> type PrimaryGeneratedColumnType = <span class="string">"int"</span> <span class="comment">// mysql, mssql, oracle, sqlite</span></span><br><span class="line">    |<span class="string">"int2"</span> <span class="comment">// postgres, sqlite</span></span><br><span class="line">    |<span class="string">"int2"</span> <span class="comment">// postgres, sqlite</span></span><br><span class="line">    |<span class="string">"int4"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"int8"</span> <span class="comment">// postgres, sqlite</span></span><br><span class="line">    |<span class="string">"integer"</span> <span class="comment">// postgres, oracle, sqlite</span></span><br><span class="line">    |<span class="string">"tinyint"</span> <span class="comment">// mysql, mssql, sqlite</span></span><br><span class="line">    |<span class="string">"smallint"</span> <span class="comment">// mysql, postgres, mssql, oracle, sqlite</span></span><br><span class="line">    |<span class="string">"mediumint"</span> <span class="comment">// mysql, sqlite</span></span><br><span class="line">    |<span class="string">"bigint"</span> <span class="comment">// mysql, postgres, mssql, sqlite</span></span><br><span class="line">    |<span class="string">"dec"</span> <span class="comment">// oracle, mssql</span></span><br><span class="line">    |<span class="string">"decimal"</span> <span class="comment">// mysql, postgres, mssql, sqlite</span></span><br><span class="line">    |<span class="string">"numeric"</span> <span class="comment">// postgres, mssql, sqlite</span></span><br><span class="line">    |<span class="string">"number"</span>; <span class="comment">// oracle</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//带有精度的列类型，主要为各种浮点数、小数类型</span></span><br><span class="line"><span class="keyword">export</span> type WithPrecisionColumnType = <span class="string">"float"</span> <span class="comment">// mysql, mssql, oracle, sqlite</span></span><br><span class="line">    |<span class="string">"double"</span> <span class="comment">// mysql, sqlite</span></span><br><span class="line">    |<span class="string">"dec"</span> <span class="comment">// oracle, mssql</span></span><br><span class="line">    |<span class="string">"decimal"</span> <span class="comment">// mysql, postgres, mssql, sqlite</span></span><br><span class="line">    |<span class="string">"numeric"</span> <span class="comment">// postgres, mssql, sqlite</span></span><br><span class="line">    |<span class="string">"real"</span> <span class="comment">// mysql, postgres, mssql, oracle, sqlite</span></span><br><span class="line">    |<span class="string">"double precision"</span> <span class="comment">// postgres, oracle, sqlite</span></span><br><span class="line">    |<span class="string">"number"</span> <span class="comment">// oracle</span></span><br><span class="line">    |<span class="string">"datetime"</span> <span class="comment">// mssql, mysql, sqlite</span></span><br><span class="line">    |<span class="string">"datetime2"</span> <span class="comment">// mssql</span></span><br><span class="line">    |<span class="string">"datetimeoffset"</span> <span class="comment">// mssql</span></span><br><span class="line">    |<span class="string">"time"</span> <span class="comment">// mysql, postgres, mssql</span></span><br><span class="line">    |<span class="string">"time with time zone"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"time without time zone"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"timestamp"</span> <span class="comment">// mysql, postgres, mssql, oracle</span></span><br><span class="line">    |<span class="string">"timestamp without time zone"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"timestamp with time zone"</span>; <span class="comment">// postgres, oracle</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//带有长度的列类型，</span></span><br><span class="line"><span class="keyword">export</span> type WithLengthColumnType = <span class="string">"int"</span> <span class="comment">// mysql, postgres, mssql, oracle, sqlite</span></span><br><span class="line">    |<span class="string">"tinyint"</span> <span class="comment">// mysql, mssql, sqlite</span></span><br><span class="line">    |<span class="string">"smallint"</span> <span class="comment">// mysql, postgres, mssql, oracle, sqlite</span></span><br><span class="line">    |<span class="string">"mediumint"</span> <span class="comment">// mysql, sqlite</span></span><br><span class="line">    |<span class="string">"bigint"</span> <span class="comment">// mysql, postgres, mssql, sqlite</span></span><br><span class="line">    |<span class="string">"character varying"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"varying character"</span> <span class="comment">// sqlite</span></span><br><span class="line">    |<span class="string">"nvarchar"</span> <span class="comment">// mssql</span></span><br><span class="line">    |<span class="string">"character"</span> <span class="comment">// mysql, postgres, sqlite</span></span><br><span class="line">    |<span class="string">"native character"</span> <span class="comment">// sqlite</span></span><br><span class="line">    |<span class="string">"varchar"</span> <span class="comment">// mysql, postgres, mssql, sqlite</span></span><br><span class="line">    |<span class="string">"char"</span> <span class="comment">// mysql, postgres, mssql, oracle</span></span><br><span class="line">    |<span class="string">"nchar"</span> <span class="comment">// mssql, oracle, sqlite</span></span><br><span class="line">    |<span class="string">"varchar2"</span> <span class="comment">// oracle</span></span><br><span class="line">    |<span class="string">"nvarchar2"</span> <span class="comment">// oracle, sqlite</span></span><br><span class="line">    |<span class="string">"binary"</span> <span class="comment">// mssql</span></span><br><span class="line">    |<span class="string">"varbinary"</span>; <span class="comment">// mssql</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//简单列类型</span></span><br><span class="line"><span class="keyword">export</span> type SimpleColumnType =</span><br><span class="line">    <span class="comment">//简单数组，为typeorm特有，对饮数据库中string类型</span></span><br><span class="line">    <span class="string">"simple-array"</span> <span class="comment">// typeorm-specific, automatically mapped to string</span></span><br><span class="line">    <span class="comment">//string类型，对应数据库中varchar类型</span></span><br><span class="line">    |<span class="string">"string"</span> <span class="comment">// typeorm-specific, automatically mapped to varchar depend on platform</span></span><br><span class="line">    <span class="comment">//数值类型</span></span><br><span class="line">    |<span class="string">"bit"</span> <span class="comment">// mssql</span></span><br><span class="line">    |<span class="string">"int2"</span> <span class="comment">// postgres, sqlite</span></span><br><span class="line">    |<span class="string">"integer"</span> <span class="comment">// postgres, oracle, sqlite</span></span><br><span class="line">    |<span class="string">"int4"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"int8"</span> <span class="comment">// postgres, sqlite</span></span><br><span class="line">    |<span class="string">"unsigned big int"</span> <span class="comment">// sqlite</span></span><br><span class="line">    |<span class="string">"float4"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"float8"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"smallmoney"</span> <span class="comment">// mssql</span></span><br><span class="line">    |<span class="string">"money"</span> <span class="comment">// postgres, mssql</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">//boolean类型</span></span><br><span class="line">    |<span class="string">"boolean"</span> <span class="comment">// postgres, sqlite</span></span><br><span class="line">    |<span class="string">"bool"</span> <span class="comment">// postgres</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">//二进制、文本类型</span></span><br><span class="line">    |<span class="string">"tinyblob"</span> <span class="comment">// mysql</span></span><br><span class="line">    |<span class="string">"tinytext"</span> <span class="comment">// mysql</span></span><br><span class="line">    |<span class="string">"mediumblob"</span> <span class="comment">// mysql</span></span><br><span class="line">    |<span class="string">"mediumtext"</span> <span class="comment">// mysql</span></span><br><span class="line">    |<span class="string">"blob"</span> <span class="comment">// mysql, oracle, sqlite</span></span><br><span class="line">    |<span class="string">"text"</span> <span class="comment">// mysql, postgres, mssql, sqlite</span></span><br><span class="line">    |<span class="string">"ntext"</span> <span class="comment">// mssql</span></span><br><span class="line">    |<span class="string">"citext"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"longblob"</span> <span class="comment">// mysql</span></span><br><span class="line">    |<span class="string">"longtext"</span> <span class="comment">// mysql</span></span><br><span class="line">    |<span class="string">"bytea"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"long"</span> <span class="comment">// oracle</span></span><br><span class="line">    |<span class="string">"raw"</span> <span class="comment">// oracle</span></span><br><span class="line">    |<span class="string">"long raw"</span> <span class="comment">// oracle</span></span><br><span class="line">    |<span class="string">"bfile"</span> <span class="comment">// oracle</span></span><br><span class="line">    |<span class="string">"clob"</span> <span class="comment">// oracle, sqlite</span></span><br><span class="line">    |<span class="string">"nclob"</span> <span class="comment">// oracle</span></span><br><span class="line">    |<span class="string">"image"</span> <span class="comment">// mssql</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">//日期类型</span></span><br><span class="line">    |<span class="string">"timestamp with local time zone"</span> <span class="comment">// oracle</span></span><br><span class="line">    |<span class="string">"smalldatetime"</span> <span class="comment">// mssql</span></span><br><span class="line">    |<span class="string">"date"</span> <span class="comment">// mysql, postgres, mssql, oracle, sqlite</span></span><br><span class="line">    |<span class="string">"interval year"</span> <span class="comment">// oracle</span></span><br><span class="line">    |<span class="string">"interval day"</span> <span class="comment">// oracle</span></span><br><span class="line">    |<span class="string">"interval"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"year"</span> <span class="comment">// mysql</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">//几何类型，只有postgres支持</span></span><br><span class="line">    |<span class="string">"point"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"line"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"lseg"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"box"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"circle"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"path"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"polygon"</span> <span class="comment">// postgres</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">// other types</span></span><br><span class="line">    |<span class="string">"enum"</span> <span class="comment">// mysql, postgres</span></span><br><span class="line">    |<span class="string">"cidr"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"inet"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"macaddr"</span><span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"bit"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"bit varying"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"varbit"</span><span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"tsvector"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"tsquery"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"uuid"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"xml"</span> <span class="comment">// mssql, postgres</span></span><br><span class="line">    |<span class="string">"json"</span> <span class="comment">// mysql, postgres</span></span><br><span class="line">    |<span class="string">"jsonb"</span> <span class="comment">// postgres</span></span><br><span class="line">    |<span class="string">"varbinary"</span> <span class="comment">// mssql</span></span><br><span class="line">    |<span class="string">"cursor"</span> <span class="comment">// mssql</span></span><br><span class="line">    |<span class="string">"hierarchyid"</span> <span class="comment">// mssql</span></span><br><span class="line">    |<span class="string">"sql_variant"</span> <span class="comment">// mssql</span></span><br><span class="line">    |<span class="string">"table"</span> <span class="comment">// mssql</span></span><br><span class="line">    |<span class="string">"rowid"</span> <span class="comment">// oracle</span></span><br><span class="line">    |<span class="string">"urowid"</span> <span class="comment">// oracle</span></span><br><span class="line">    |<span class="string">"uniqueidentifier"</span>; <span class="comment">// mssql</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//列数据类型，为联合类型，各个类型之间可能有重复</span></span><br><span class="line"><span class="keyword">export</span> type ColumnType = </span><br><span class="line">    <span class="comment">//带有精度类型</span></span><br><span class="line">    WithPrecisionColumnType</span><br><span class="line">    <span class="comment">//带有长度类型</span></span><br><span class="line">    |WithLengthColumnType</span><br><span class="line">    <span class="comment">//简单类型</span></span><br><span class="line">    |SimpleColumnType</span><br><span class="line">    <span class="comment">//boolean类型</span></span><br><span class="line">    |BooleanConstructor</span><br><span class="line">    <span class="comment">//Date类型</span></span><br><span class="line">    |DateConstructor</span><br><span class="line">    <span class="comment">//数字类型</span></span><br><span class="line">    |NumberConstructor</span><br><span class="line">    <span class="comment">//字符串类型</span></span><br><span class="line">    |StringConstructor;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/04/18/Lombok%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/18/Lombok%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/" itemprop="url">Lombok的基本使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-18T16:29:01+08:00">
                2019-04-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Lombok/" itemprop="url" rel="index">
                    <span itemprop="name">Lombok</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>自从Java 6起，javac就支持“JSR 269 Pluggable Annotation Processing API”规范，只要程序实现了该API，就能在javac运行的时候得到调用。</p>
<h4 id="Lombok实现原理"><a href="#Lombok实现原理" class="headerlink" title="Lombok实现原理"></a>Lombok实现原理</h4><p>Lombok就是一个实现了”JSR 269 API”的程序。在使用javac的过程中，它产生作用的具体流程如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. javac对源代码进行分析，生成一棵抽象语法树(AST)</span><br><span class="line">2. javac编译过程中调用实现了JSR 269的Lombok程序</span><br><span class="line">3. 此时Lombok就对第一步骤得到的AST进行处理，找到Lombok注解所在类对应的语法树       (AST)，然后修改该语法树(AST)，增加Lombok注解定义的相应树节点</span><br><span class="line">4. javac使用修改后的抽象语法树(AST)生成字节码文件</span><br></pre></td></tr></table></figure>
<h4 id="Lombok注解的使用"><a href="#Lombok注解的使用" class="headerlink" title="Lombok注解的使用"></a>Lombok注解的使用</h4><p>@Getter/@Setter: 作用类上，生成所有成员变量的getter/setter方法；作用于成员变量上，生成该成员变量的getter/setter方法。可以设定访问权限及是否懒加载等。</p>
<p>@ToString：作用于类，覆盖默认的toString()方法，可以通过of属性限定显示某些字段，通过exclude属性排除某些字段。</p>
<p>@EqualsAndHashCode：作用于类，覆盖默认的equals和hashCode</p>
<p>@NonNull：主要作用于成员变量和参数中，标识不能为空，否则抛出空指针异常。</p>
<p>@NoArgsConstructor, @RequiredArgsConstructor, @AllArgsConstructor：作用于类上，用于生成构造函数。有staticName、access等属性。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">staticName属性一旦设定，将采用静态方法的方式生成实例，access属性可以限定访问权限。</span><br><span class="line">@NoArgsConstructor：生成无参构造器；</span><br><span class="line">@RequiredArgsConstructor：生成包含final和@NonNull注解的成员变量的构造器；</span><br><span class="line">@AllArgsConstructor：生成全参构造器</span><br></pre></td></tr></table></figure>
<p>@Data：作用于类上，是以下注解的集合：@ToString @EqualsAndHashCode @Getter @Setter @RequiredArgsConstructor</p>
<p>@Builder：作用于类上，将类转变为建造者模式</p>
<p>@Log：作用于类上，生成日志变量。针对不同的日志实现产品，有不同的注解：</p>
<p>其他重要注解：<br>@Cleanup：自动关闭资源，针对实现了java.io.Closeable接口的对象有效，如：典型的IO流对象</p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/04/18/TypeScript%E2%80%94%E2%80%94orm%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/18/TypeScript%E2%80%94%E2%80%94orm%E5%AE%9E%E7%8E%B0/" itemprop="url">TypeScript——orm实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-18T00:00:00+08:00">
                2019-04-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Node/" itemprop="url" rel="index">
                    <span itemprop="name">Node</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>基于node,typescript封装，安装步骤略。</p>
<p>新建nodejs项目</p>
<p>npm init</p>
<p>npm install –save mysql</p>
<h5 id="简单封装"><a href="#简单封装" class="headerlink" title="简单封装"></a>简单封装</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"><span class="keyword">const</span> mysql=<span class="built_in">require</span>(<span class="string">'mysql'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    config: &#123;</span><br><span class="line">        host: <span class="string">'210.14.139.118'</span>,</span><br><span class="line">        port: <span class="number">44257</span>,</span><br><span class="line">        database: <span class="string">'jk_newcenter'</span>,</span><br><span class="line">        user: <span class="string">'jk_newcenter'</span>,</span><br><span class="line">        password: <span class="string">'aMF3va%d$cc'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    connection: <span class="literal">null</span>,</span><br><span class="line">    <span class="comment">//创建连接池并连接</span></span><br><span class="line">    openConnection: <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.connection = mysql.createConnection(<span class="keyword">this</span>.config);</span><br><span class="line">    &#125;,</span><br><span class="line">    closeConnection: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line">        me.connection.end(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(err);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    execute: <span class="function"><span class="keyword">function</span> (<span class="params">config</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> me = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">this</span>.openConnection();</span><br><span class="line">        me.connection.query(config.sql, config.params, <span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(err);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config.callback) &#123;</span><br><span class="line">                config.callback(res);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 关闭数据库连接</span></span><br><span class="line">            me.closeConnection();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="完整封装"><a href="#完整封装" class="headerlink" title="完整封装"></a>完整封装</h5><p>连接池配置connection.ts：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> mysql <span class="keyword">from</span> <span class="string">"mysql"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mysqlPool = mysql.createPool(&#123;</span><br><span class="line">    host: <span class="string">"172.16.3.34"</span>,</span><br><span class="line">    user: <span class="string">"root"</span>,</span><br><span class="line">    password: <span class="string">"root"</span>,</span><br><span class="line">    port: <span class="number">3306</span>,</span><br><span class="line">    database: <span class="string">"sonar"</span>,</span><br><span class="line">    connectionLimit: <span class="number">10000</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> timeout = <span class="number">4000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> interface ISqlResults &#123;</span><br><span class="line">    results: <span class="built_in">Array</span>&lt;any&gt;;</span><br><span class="line">    fields: <span class="built_in">Object</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface IQueryObject &#123;</span><br><span class="line">    [name: string]: string | number</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现增删改查基本方法</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> sqlQuery = <span class="function">(<span class="params">sql: mysql.QueryOptions</span>) =&gt;</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span></span><br><span class="line">    mysqlPool.query(sql, (err, results, fields) =&gt; err ? reject(err) : resolve(<span class="xml"><span class="tag">&lt;<span class="name">ISqlResults</span>&gt;</span>&#123;results, fields&#125;))</span></span><br><span class="line"><span class="xml">);</span></span><br><span class="line"></span><br><span class="line"><span class="xml">export const and = (dataObject: IQueryObject) =&gt; &#123;</span></span><br><span class="line"><span class="xml">    let queryString = "";</span></span><br><span class="line"><span class="xml">    Object.keys(dataObject).forEach(key =&gt; &#123;</span></span><br><span class="line"><span class="xml">        queryString += mysql.escape(key) + "=" + dataObject[key] + " and "</span></span><br><span class="line"><span class="xml">    &#125;);</span></span><br><span class="line"><span class="xml">    return queryString.replace(/\sand\s$/, "")</span></span><br><span class="line"><span class="xml">&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="xml">export const tableQuery = (table: string, condition: IQueryObject | string) =&gt; sqlQuery(&#123;</span></span><br><span class="line"><span class="xml">    sql: typeof condition === "string" ?</span></span><br><span class="line"><span class="xml">        mysql.format("select * from ?? where ??", [table, condition]) :</span></span><br><span class="line"><span class="xml">        mysql.format("select * from ?? where ?", [table, condition]),</span></span><br><span class="line"><span class="xml">    timeout</span></span><br><span class="line"><span class="xml">&#125;);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">export const insertTable = (table: string, data: IQueryObject | Array&lt;string | number&gt;) =&gt; sqlQuery(&#123;</span><br><span class="line">    sql: Array.isArray(data) ?</span><br><span class="line">        mysql.format("insert into ?? values(??)", [table, (&lt;Array&lt;string | number&gt;&gt;data).join(", ")]) :</span><br><span class="line">        mysql.format("insert into ?? set ?", [table, data]),</span><br><span class="line">    timeout</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">export const updateTable = (table: string, update: IQueryObject, condition: IQueryObject | string) =&gt; sqlQuery(&#123;</span><br><span class="line">    sql: typeof condition === "string" ?</span><br><span class="line">        mysql.format("update ?? set ? where ??", [table, update, condition]) :</span><br><span class="line">        mysql.format("update ?? set ? where ?", [table, update, condition]),</span><br><span class="line">    timeout</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">export const deleteRow = (table: string, condition: IQueryObject | string) =&gt; sqlQuery(&#123;</span><br><span class="line">    sql: typeof condition === "string" ?</span><br><span class="line">        mysql.format("delete from ?? where ??", [table, condition]) :</span><br><span class="line">        mysql.format("delete from ?? where ?", [table, condition]),</span><br><span class="line">    timeout</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">export default mysqlPool;</span><br></pre></td></tr></table></figure>
<p>ORM核心操作MyOrm.ts</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; sqlQuery, insertTable, deleteRow, tableQuery, updateTable, ISqlResults &#125; <span class="keyword">from</span> <span class="string">"./connection"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; format &#125; <span class="keyword">from</span> <span class="string">"mysql"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> interface IField &#123;</span><br><span class="line">    [name: string]: string | number</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> interface IError &#123;</span><br><span class="line">    err: boolean;</span><br><span class="line">    message?: string;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> interface IORM&lt;TableType, TableTypeRest&gt; &#123;</span><br><span class="line">    fieldMap: IField;</span><br><span class="line">    map: IField;</span><br><span class="line">    table: string;</span><br><span class="line">    defaultValue: TableType;</span><br><span class="line"></span><br><span class="line">    fetchAll (condition: TableTypeRest | string): <span class="built_in">Promise</span>&lt;<span class="built_in">Array</span>&lt;TableType&gt;&gt;;</span><br><span class="line"></span><br><span class="line">    fetch (query: TableTypeRest | string): <span class="built_in">Promise</span>&lt;TableType&gt;;</span><br><span class="line"></span><br><span class="line">    insert (data: TableType): <span class="built_in">Promise</span>&lt;IError&gt;;</span><br><span class="line"></span><br><span class="line">    update (data: TableTypeRest, <span class="attr">condition</span>: TableTypeRest | string): <span class="built_in">Promise</span>&lt;IError&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span> (condition: TableTypeRest | string): <span class="built_in">Promise</span>&lt;IError&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ORM framework</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">MyOrm</span>&lt;<span class="title">Type</span>, <span class="title">TypeRest</span>&gt; <span class="title">implements</span> <span class="title">IORM</span>&lt;<span class="title">Type</span>, <span class="title">TypeRest</span>&gt; </span>&#123;</span><br><span class="line">    public fieldMap: IField;</span><br><span class="line">    public map: IField;</span><br><span class="line">    public table: string;</span><br><span class="line">    public defaultValue: Type;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">async</span> <span class="keyword">delete</span> (condition: TypeRest | string): <span class="built_in">Promise</span>&lt;IError&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> dbCondition: IField | string = <span class="keyword">typeof</span> condition === <span class="string">"string"</span> ? condition :</span><br><span class="line">            <span class="built_in">Object</span>.keys(condition).reduce(<span class="function">(<span class="params">acc, curKey</span>) =&gt;</span> &#123;acc[<span class="keyword">this</span>.fieldMap[curKey]] = condition[curKey];</span><br><span class="line">                <span class="keyword">return</span> acc;</span><br><span class="line">            &#125;, &#123;&#125;);</span><br><span class="line">        <span class="keyword">const</span> &#123; results, fields &#125; = <span class="xml"><span class="tag">&lt;<span class="name">ISqlResults</span>&gt;</span>await deleteRow(this.table, dbCondition);</span></span><br><span class="line">        return results ? &lt;IError&gt;&#123; err: false &#125; :</span><br><span class="line">            &lt;IError&gt;&#123;</span><br><span class="line">                err: true,</span><br><span class="line">                message: "you have err on delete from " + this.table</span><br><span class="line">            &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public async fetch (query: TypeRest | string): Promise&lt;Type&gt; &#123;</span><br><span class="line">        const dbQuery: IField = typeof query === "string" ? query :</span><br><span class="line">            Object.keys(query).reduce((acc, curKey) =&gt; &#123;</span><br><span class="line">                acc[this.fieldMap[curKey]] = query[curKey];</span><br><span class="line">                return acc;</span><br><span class="line">            &#125;, &#123;&#125;);</span><br><span class="line">        let &#123; results, fields &#125; = &lt;ISqlResults&gt;await tableQuery(this.table, dbQuery);</span><br><span class="line"></span><br><span class="line">        results.length || (results = [&#123;&#125;]);</span><br><span class="line">        Array.isArray(results) &amp;&amp; (results = results[0]);</span><br><span class="line">        return &lt;Type&gt;Object.keys(results).reduce((acc, curKey) =&gt; &#123;</span><br><span class="line">            acc[this.map[curKey]] = results[curKey];</span><br><span class="line">            return acc</span><br><span class="line">        &#125;, &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public async fetchAll (condition?: TypeRest | string): Promise&lt;Array&lt;Type&gt;&gt; &#123;</span><br><span class="line"></span><br><span class="line">        const &#123; results, fields &#125; = &lt;ISqlResults&gt;await sqlQuery(&#123;</span><br><span class="line">            sql: !condition ? format("select * from ??", [this.table]) :</span><br><span class="line">                typeof condition === "string" ?</span><br><span class="line">                    format("select * from ?? where ??", [this.table, condition]) :</span><br><span class="line">                    format("select * from ?? where ?", [this.table, condition]),</span><br><span class="line">            timeout: 2000</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        return &lt;Array&lt;Type&gt;&gt;results.map(value =&gt; Object.keys(value).reduce((acc, curKey) =&gt; &#123;</span><br><span class="line">            acc[this.map[curKey]] = value[curKey];</span><br><span class="line">            return acc;</span><br><span class="line">        &#125;, &#123;&#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public async insert (data: Type): Promise&lt;IError&gt; &#123;</span><br><span class="line">        const dbData: IField = Object.keys(data).reduce((acc, curKey) =&gt; &#123;</span><br><span class="line">            acc[this.fieldMap[curKey]] = data[curKey];</span><br><span class="line">            return acc;</span><br><span class="line">        &#125;, &#123;&#125;);</span><br><span class="line">        const &#123; results &#125; = &lt;ISqlResults&gt;await insertTable(this.table, dbData);</span><br><span class="line">        return results ? &lt;IError&gt;&#123; err: false &#125; : &lt;IError&gt;&#123; err: true, message: "you have some error in insert data" &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public async update (data: TypeRest, condition: TypeRest | string): Promise&lt;IError&gt; &#123;</span><br><span class="line">        const dbData: IField = Object.keys(data).reduce((acc, curKey) =&gt; &#123;</span><br><span class="line">            acc[this.fieldMap[curKey]] = data[curKey];</span><br><span class="line">            return acc;</span><br><span class="line">        &#125;, &#123;&#125;);</span><br><span class="line">        const dbCondition: IField | string = typeof condition === "string" ? condition : Object.keys(condition).reduce((acc, curKey) =&gt; &#123;</span><br><span class="line">            acc[this.fieldMap[curKey]] = condition[curKey];</span><br><span class="line">            return acc;</span><br><span class="line">        &#125;, &#123;&#125;);</span><br><span class="line">        console.log(dbData,dbCondition);</span><br><span class="line">        const &#123; results &#125; = &lt;ISqlResults&gt;await updateTable(this.table, dbData, dbCondition);</span><br><span class="line">        return results ? &lt;IError&gt;&#123; err: false &#125; : &#123; err: true, message: "you have message in update" &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：创建实体：User.ts</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> ORM <span class="keyword">from</span> <span class="string">"./MyOrm"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> interface IUserType &#123;</span><br><span class="line">    readonly id: number;</span><br><span class="line">    readonly firstName: string;</span><br><span class="line">    readonly lastName: string;</span><br><span class="line">    readonly age: number;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> interface IUserTypeRest &#123;</span><br><span class="line">    readonly id?: number;</span><br><span class="line">    readonly firstName?: string;</span><br><span class="line">    readonly lastName?: string;</span><br><span class="line">    readonly age?: number;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 只需要继承ORM类即可</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">ORM</span>&lt;<span class="title">IUserType</span>, <span class="title">IUserTypeRest</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// 类属性与数据库列字段的映射</span></span><br><span class="line">    public fieldMap = &#123;</span><br><span class="line">        id: <span class="string">"id"</span>,</span><br><span class="line">        firstName: <span class="string">"firstName"</span>,</span><br><span class="line">        lastName: <span class="string">"lastName"</span>,</span><br><span class="line">        age: <span class="string">"age"</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 默认值</span></span><br><span class="line">    public defaultValue: IUserType = &#123;</span><br><span class="line">        id: <span class="number">0</span>,</span><br><span class="line">        firstName: <span class="string">""</span>,</span><br><span class="line">        lastName: <span class="string">""</span>,</span><br><span class="line">        age: <span class="number">0</span></span><br><span class="line">    &#125;;</span><br><span class="line">    public table: string = <span class="string">"user"</span>; <span class="comment">// 指定数据库表名</span></span><br><span class="line"></span><br><span class="line">    public map = <span class="built_in">Object</span>.keys(<span class="keyword">this</span>.fieldMap).reduce(<span class="function">(<span class="params">acc, curKey</span>) =&gt;</span> &#123;</span><br><span class="line">        acc[<span class="keyword">this</span>.fieldMap[curKey]] = curKey;</span><br><span class="line">        <span class="keyword">return</span> acc;</span><br><span class="line">    &#125;, &#123;&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> User, &#123;IUserType&#125; <span class="keyword">from</span> <span class="string">"./User"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> user = <span class="keyword">new</span> User();</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">new</span> User();</span><br><span class="line">    <span class="comment">/*await user.insert(&lt;IUserType&gt;&#123;</span></span><br><span class="line"><span class="comment">        id: 10,</span></span><br><span class="line"><span class="comment">        firstName: "hu",</span></span><br><span class="line"><span class="comment">        lastName: "hu",</span></span><br><span class="line"><span class="comment">        age: 20</span></span><br><span class="line"><span class="comment">    &#125;);*/</span></span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> user.fetchAll();</span><br><span class="line">    <span class="built_in">console</span>.log(data)</span><br><span class="line">&#125;</span><br><span class="line">main();</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/04/17/ECMAScript_6_async/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/17/ECMAScript_6_async/" itemprop="url">ECMAScript 6 async</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-17T00:00:00+08:00">
                2019-04-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Node/" itemprop="url" rel="index">
                    <span itemprop="name">Node</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>ES2017 标准引入了 async 函数，使得异步操作变得更加方便。async 函数是什么？一句话，它就是 Generator 函数的语法糖。</p>
<h5 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h5><p>前文有一个 Generator 函数，依次读取两个文件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> readFile = <span class="function"><span class="keyword">function</span> (<span class="params">fileName</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    fs.readFile(fileName, <span class="function"><span class="keyword">function</span>(<span class="params">error, data</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (error) <span class="keyword">return</span> reject(error);</span><br><span class="line">      resolve(data);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> gen = <span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> f1 = <span class="keyword">yield</span> readFile(<span class="string">'/etc/fstab'</span>);</span><br><span class="line">  <span class="keyword">const</span> f2 = <span class="keyword">yield</span> readFile(<span class="string">'/etc/shells'</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(f1.toString());</span><br><span class="line">  <span class="built_in">console</span>.log(f2.toString());</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>上面代码的函数gen可以写成async函数，就是下面这样。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> asyncReadFile = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> f1 = <span class="keyword">await</span> readFile(<span class="string">'/etc/fstab'</span>);</span><br><span class="line">  <span class="keyword">const</span> f2 = <span class="keyword">await</span> readFile(<span class="string">'/etc/shells'</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(f1.toString());</span><br><span class="line">  <span class="built_in">console</span>.log(f2.toString());</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>一比较就会发现，async函数就是将 Generator 函数的星号（*）替换成async，将yield替换成await，仅此而已。</p>
<p>async函数对 Generator 函数的改进，体现在以下四点。</p>
<p> （1）内置执行器。</p>
<p>Generator 函数的执行必须靠执行器，所以才有了co模块，而async函数自带执行器。也就是说，async函数的执行，与普通函数一模一样，只要一行。</p>
<p>asyncReadFile();</p>
<p>上面的代码调用了asyncReadFile函数，然后它就会自动执行，输出最后结果。这完全不像 Generator 函数，需要调用next方法，或者用co模块，才能真正执行，得到最后结果。</p>
<p>（2）更好的语义。</p>
<p>async和await，比起星号和yield，语义更清楚了。async表示函数里有异步操作，await表示紧跟在后面的表达式需要等待结果。</p>
<p>（3）更广的适用性。</p>
<p>co模块约定，yield命令后面只能是 Thunk 函数或 Promise 对象，而async函数的await命令后面，可以是 Promise 对象和原始类型的值（数值、字符串和布尔值，但这时会自动转成立即 resolved 的 Promise 对象）。</p>
<p>（4）返回值是 Promise。</p>
<p>async函数的返回值是 Promise 对象，这比 Generator 函数的返回值是 Iterator 对象方便多了。你可以用then方法指定下一步的操作。</p>
<p>进一步说，async函数完全可以看作多个异步操作，包装成的一个 Promise 对象，而await命令就是内部then命令的语法糖。</p>
<h5 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h5><p>async函数返回一个 Promise 对象，可以使用then方法添加回调函数。当函数执行的时候，一旦遇到await就会先返回，等到异步操作完成，再接着执行函数体内后面的语句。</p>
<p>例子，指定多少毫秒后输出一个值。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">timeout</span>(<span class="params">ms</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(resolve, ms);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">asyncPrint</span>(<span class="params">value, ms</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">await</span> timeout(ms);</span><br><span class="line">  <span class="built_in">console</span>.log(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">asyncPrint(<span class="string">'hello world'</span>, <span class="number">50</span>);</span><br></pre></td></tr></table></figure>
<p>async 函数有多种使用形式。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数表达式</span></span><br><span class="line"><span class="keyword">const</span> foo = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对象的方法</span></span><br><span class="line"><span class="keyword">let</span> obj = &#123; <span class="keyword">async</span> foo() &#123;&#125; &#125;;</span><br><span class="line">obj.foo().then(...)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Class 的方法</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Storage</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.cachePromise = caches.open(<span class="string">'avatars'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> getAvatar(name) &#123;</span><br><span class="line">    <span class="keyword">const</span> cache = <span class="keyword">await</span> <span class="keyword">this</span>.cachePromise;</span><br><span class="line">    <span class="keyword">return</span> cache.match(<span class="string">`/avatars/<span class="subst">$&#123;name&#125;</span>.jpg`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> storage = <span class="keyword">new</span> Storage();</span><br><span class="line">storage.getAvatar(<span class="string">'jake'</span>).then(…);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 箭头函数</span></span><br><span class="line"><span class="keyword">const</span> foo = <span class="keyword">async</span> () =&gt; &#123;&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h5><h6 id="返回-Promise-对象"><a href="#返回-Promise-对象" class="headerlink" title="返回 Promise 对象"></a>返回 Promise 对象</h6><p>async函数返回一个 Promise 对象。async函数内部return语句返回的值，会成为then方法回调函数的参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">async function f() &#123;</span><br><span class="line">  return &#39;hello world&#39;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f().then(v &#x3D;&gt; console.log(v))</span><br><span class="line">&#x2F;&#x2F; &quot;hello world&quot;</span><br></pre></td></tr></table></figure>
<p>上面代码中，函数f内部return命令返回的值，会被then方法回调函数接收到。</p>
<p>async函数内部抛出错误，会导致返回的 Promise 对象变为reject状态。抛出的错误对象会被catch方法回调函数接收到。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">async function f() &#123;</span><br><span class="line">  throw new Error(&#39;出错了&#39;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f().then(</span><br><span class="line">  v &#x3D;&gt; console.log(v),</span><br><span class="line">  e &#x3D;&gt; console.log(e)</span><br><span class="line">)</span><br><span class="line">&#x2F;&#x2F; Error: 出错了</span><br></pre></td></tr></table></figure>
<h6 id="Promise-对象的状态变化"><a href="#Promise-对象的状态变化" class="headerlink" title="Promise 对象的状态变化"></a>Promise 对象的状态变化</h6><p>async函数返回的 Promise 对象，必须等到内部所有await命令后面的 Promise 对象执行完，才会发生状态改变，除非遇到return语句或者抛出错误。也就是说，只有async函数内部的异步操作执行完，才会执行then方法指定的回调函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getTitle</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> response = <span class="keyword">await</span> fetch(url);</span><br><span class="line">    <span class="keyword">let</span> html = <span class="keyword">await</span> response.text();</span><br><span class="line">    <span class="keyword">return</span> html.match(<span class="regexp">/&lt;title&gt;([\s\S]+)&lt;\/title&gt;/i</span>)[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getTitle(<span class="string">'www.baidu.com'</span>).then(<span class="built_in">console</span>.log);</span><br></pre></td></tr></table></figure>
<p>上面代码中，函数getTitle内部有三个操作：抓取网页、取出文本、匹配页面标题。只有这三个操作全部完成，才会执行then方法里面的console.log。</p>
<h5 id="await-命令"><a href="#await-命令" class="headerlink" title="await 命令"></a>await 命令</h5><p>正常情况下，await命令后面是一个 Promise 对象，返回该对象的结果。如果不是 Promise 对象，就直接返回对应的值。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 等同于</span></span><br><span class="line">  <span class="comment">// return 123;</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="number">123</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f().then(<span class="function"><span class="params">v</span> =&gt;</span> <span class="built_in">console</span>.log(v))</span><br><span class="line"><span class="comment">// 123</span></span><br></pre></td></tr></table></figure>
<p>另一种情况是，await命令后面是一个thenable对象（即定义then方法的对象），那么await会将其等同于 Promise 对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sleep</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(timeout) &#123;</span><br><span class="line">        <span class="keyword">this</span>.timeout = timeout;</span><br><span class="line">    &#125;</span><br><span class="line">    then(resolve, reject) &#123;</span><br><span class="line">        <span class="keyword">const</span> startTime = <span class="built_in">Date</span>.now();</span><br><span class="line">        setTimeout(</span><br><span class="line">            () =&gt; resolve(<span class="built_in">Date</span>.now() - startTime),</span><br><span class="line">            <span class="keyword">this</span>.timeout</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * await命令后面是一个Sleep对象的实例。这个实例不是 Promise 对象，但是因为定义了then方法，await会将其视为Promise处理。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> sleepTime = <span class="keyword">await</span> <span class="keyword">new</span> Sleep(<span class="number">1000</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(sleepTime);</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="comment">//JavaScript 一直没有休眠的语法，但是借助await命令就可以让程序停顿指定的时间。</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params">interval</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        setTimeout(resolve, interval);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用法</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">one2FiveInAsync</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(i);</span><br><span class="line">        <span class="keyword">await</span> sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">one2FiveInAsync();</span><br></pre></td></tr></table></figure>
<p>任何一个await语句后面的 Promise 对象变为reject状态，那么整个async函数都会中断执行。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="built_in">Promise</span>.reject(<span class="string">'出错了'</span>);</span><br><span class="line">  <span class="keyword">await</span> <span class="built_in">Promise</span>.resolve(<span class="string">'hello world'</span>); <span class="comment">// 不会执行</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码中，第二个await语句是不会执行的，因为第一个await语句状态变成了reject。</p>
<p>有时，我们希望即使前一个异步操作失败，也不要中断后面的异步操作。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="built_in">Promise</span>.reject(<span class="string">'出错了'</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="built_in">Promise</span>.resolve(<span class="string">'hello world'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f()</span><br><span class="line">.then(<span class="function"><span class="params">v</span> =&gt;</span> <span class="built_in">console</span>.log(v))</span><br><span class="line"><span class="comment">// hello world</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//或</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="built_in">Promise</span>.reject(<span class="string">'出错了'</span>)</span><br><span class="line">    .catch(<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">console</span>.log(e));</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="built_in">Promise</span>.resolve(<span class="string">'hello world'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f()</span><br><span class="line">.then(<span class="function"><span class="params">v</span> =&gt;</span> <span class="built_in">console</span>.log(v))</span><br><span class="line"><span class="comment">// 出错了</span></span><br><span class="line"><span class="comment">// hello world</span></span><br></pre></td></tr></table></figure>




















          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/04/17/TypeScript%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/17/TypeScript%E4%BB%8B%E7%BB%8D/" itemprop="url">TypeScript介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-17T00:00:00+08:00">
                2019-04-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Node/" itemprop="url" rel="index">
                    <span itemprop="name">Node</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>TypeScript是一个编译到纯JS的有类型定义的JS超集。</p>
<p>TypeScript是一种由微软开发的自由和开源的编程语言。它是javascript的一个超集，而且本质上向这个语言添加了可选的静态类型和基于类的面向对象编程。</p>
<p>TypeScript扩展了JavaScript的语法，所以任何现有的JavaScript程序可以不加改变的在TypeScript下工作。TypeScript是为大型应用之开发而设计，而编译时它产生JavaScript 以确保兼容性。[5] TypeScript 支持为已存在的 JavaScript 库添加类型信息的头文件，扩展了它对于流行的库如 jQuery，MongoDB，Node.js 和 D3.js 的好处。</p>
<p>TS遵循当前以及未来出现的ECMAScript规范。TS不仅能兼容现有的JavaScript 代码，它也拥有兼容未来版本的JavaScript的能力。大多数TS的新增特性 都是基于未来的JavaScript提案，这意味着许多TS代码在将来很有可能会变成ECMA的标准.</p>
<h2 id="获取TypeScript"><a href="#获取TypeScript" class="headerlink" title="获取TypeScript"></a>获取TypeScript</h2><p>命令行的TypeScript编译器可以使用Node.js包来安装。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">安装npm install -g typescript</span><br><span class="line"></span><br><span class="line">新建文件helloworld.ts</span><br><span class="line">var message:string &#x3D; &quot;Hello World&quot; </span><br><span class="line">console.log(message)</span><br><span class="line"></span><br><span class="line">编译</span><br><span class="line">$tsc helloworld.ts</span><br><span class="line">$ node test.js </span><br><span class="line">Hello World</span><br></pre></td></tr></table></figure>
<h2 id="TypeScript在node项目中的实践"><a href="#TypeScript在node项目中的实践" class="headerlink" title="TypeScript在node项目中的实践"></a>TypeScript在node项目中的实践</h2><p>ts-node 环境变量</p>
<p>全局安装 typescript：npm install -g typescript　　<br>　　<br>全局安装 ts-node：npm install -g ts-node</p>
<p>安装它的原因是typescript自带的tsc命令并不能直接运行typescript代码。但值得注意的是 ts-node 并不等于 typescript 的 Node.js ，仅仅封装了 typescript 的编译过程，提供直接运行typescript代码的能力。</p>
<p>配置 ts-node 环境变量：npm config get prefix获取全局位置。</p>
<p>之后编写文件 直接就可以运行：ts-node 文件名.ts </p>
<h2 id="WebStorm自动编译TypeScript"><a href="#WebStorm自动编译TypeScript" class="headerlink" title="WebStorm自动编译TypeScript"></a>WebStorm自动编译TypeScript</h2><p><img src="https://img.huyunshun.com/img1/sssssssssssssssssssimgclip.png" alt=""></p>
<p>Program：D:\Program Files\nodejs\node_global\tsc</p>
<p>Arguments：–sourcemap –target “ES5”</p>
<p>Output paths to refresh：$FileNameWithoutExtension$.js:$FileNameWithoutExtension$.js.map</p>
<p>Working directory：$FileDir$</p>
<p>新版本的WebStorm已经提供自动编译的功能了，只是需要设置一下。 </p>
<h2 id="webstorm中直接运行ts-TypeScript"><a href="#webstorm中直接运行ts-TypeScript" class="headerlink" title="webstorm中直接运行ts(TypeScript)"></a>webstorm中直接运行ts(TypeScript)</h2><p>安装插件ts-node</p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/04/16/ECMAScript_6_Generator/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/16/ECMAScript_6_Generator/" itemprop="url">ECMAScript 6 Generator</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-16T00:00:00+08:00">
                2019-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Node/" itemprop="url" rel="index">
                    <span itemprop="name">Node</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="Generator-函数"><a href="#Generator-函数" class="headerlink" title="Generator 函数"></a>Generator 函数</h4><p>Generator 函数是 ES6 提供的一种异步编程解决方案，语法行为与传统函数完全不同。</p>
<p>Generator 就是一个异步操作的容器。语法上，首先可以把它理解成，Generator 函数是一个状态机，封装了多个内部状态。</p>
<p>执行 Generator 函数会返回一个遍历器对象，也就是说，Generator 函数除了状态机，还是一个遍历器对象生成函数。返回的遍历器对象，可以依次遍历 Generator 函数内部的每一个状态。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">helloWorldGenerator</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> <span class="string">'hello'</span>;</span><br><span class="line">    <span class="keyword">yield</span> <span class="string">'world'</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'ending'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> hw = helloWorldGenerator();</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(hw.next());</span><br></pre></td></tr></table></figure>
<p>调用遍历器对象的next方法，使得指针移向下一个状态。也就是说，每次调用next方法，内部指针就从函数头部或上一次停下来的地方开始执行，直到遇到下一个yield表达式（或return语句）为止。换言之，Generator 函数是分段执行的，yield表达式是暂停执行的标记，而next方法可以恢复执行。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">hw.next()</span><br><span class="line"><span class="comment">// &#123; value: 'hello', done: false &#125;</span></span><br><span class="line"></span><br><span class="line">hw.next()</span><br><span class="line"><span class="comment">// &#123; value: 'world', done: false &#125;</span></span><br><span class="line"></span><br><span class="line">hw.next()</span><br><span class="line"><span class="comment">// &#123; value: 'ending', done: true &#125;</span></span><br><span class="line"></span><br><span class="line">hw.next()</span><br><span class="line"><span class="comment">// &#123; value: undefined, done: true &#125;</span></span><br></pre></td></tr></table></figure>
<h5 id="yield表达式"><a href="#yield表达式" class="headerlink" title="yield表达式"></a>yield表达式</h5><p>由于 Generator 函数返回的遍历器对象，只有调用next方法才会遍历下一个内部状态，所以其实提供了一种可以暂停执行的函数。yield表达式就是暂停标志。</p>
<ul>
<li>yield表达式与 Iterator 接口的关系 *</li>
</ul>
<p>任意一个对象的Symbol.iterator方法，等于该对象的遍历器生成函数，调用该函数会返回该对象的一个遍历器对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myIterable = &#123;&#125;;</span><br><span class="line">myIterable[<span class="built_in">Symbol</span>.iterator] = <span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="number">3</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">[...myIterable] <span class="comment">// [1, 2, 3]</span></span><br></pre></td></tr></table></figure>
<h5 id="next-方法的参数"><a href="#next-方法的参数" class="headerlink" title="next 方法的参数"></a>next 方法的参数</h5><p>yield表达式本身没有返回值，或者说总是返回undefined。next方法可以带一个参数，该参数就会被当作上一个yield表达式的返回值。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">f</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; <span class="literal">true</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> reset = <span class="keyword">yield</span> i;</span><br><span class="line">    <span class="keyword">if</span>(reset) &#123; i = <span class="number">-1</span>; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> g = f();</span><br><span class="line"></span><br><span class="line">g.next() <span class="comment">// &#123; value: 0, done: false &#125;</span></span><br><span class="line">g.next() <span class="comment">// &#123; value: 1, done: false &#125;</span></span><br><span class="line">g.next(<span class="literal">true</span>) <span class="comment">// &#123; value: 0, done: false &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//通过next方法的参数，向 Generator 函数内部输入值的例子。</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">dataConsumer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Started'</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`1. <span class="subst">$&#123;<span class="keyword">yield</span>&#125;</span>`</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`2. <span class="subst">$&#123;<span class="keyword">yield</span>&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'result'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> genObj = dataConsumer();</span><br><span class="line">genObj.next();</span><br><span class="line"><span class="comment">// Started</span></span><br><span class="line">genObj.next(<span class="string">'a'</span>)</span><br><span class="line"><span class="comment">// 1. a</span></span><br><span class="line">genObj.next(<span class="string">'b'</span>)</span><br><span class="line"><span class="comment">// 2. b</span></span><br></pre></td></tr></table></figure>
<p>如果想要第一次调用next方法时，就能够输入值，可以在 Generator 函数外面再包一层。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wrapper</span>(<span class="params">generatorFunction</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> generatorObject = generatorFunction(...args);</span><br><span class="line">    generatorObject.next();</span><br><span class="line">    <span class="keyword">return</span> generatorObject;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> wrapped = wrapper(<span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`First input: <span class="subst">$&#123;<span class="keyword">yield</span>&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'DONE'</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">wrapped().next(<span class="string">'hello!'</span>)</span><br><span class="line"><span class="comment">// First input: hello!</span></span><br></pre></td></tr></table></figure>
<p>上面代码中，Generator 函数如果不用wrapper先包一层，是无法第一次调用next方法，就输入参数的。</p>
<h5 id="for…of"><a href="#for…of" class="headerlink" title="for…of"></a>for…of</h5><p>for…of循环可以自动遍历 Generator 函数运行时生成的Iterator对象，且此时不再需要调用next方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="number">5</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">6</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> v <span class="keyword">of</span> foo()) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(v);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 1 2 3 4 5</span></span><br></pre></td></tr></table></figure>
<p>利用 Generator 函数和for…of循环，实现斐波那契数列的例子。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">fibonacci</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> [prev, curr] = [<span class="number">0</span>, <span class="number">1</span>];</span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="keyword">yield</span> curr;</span><br><span class="line">    [prev, curr] = [curr, prev + curr];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> n <span class="keyword">of</span> fibonacci()) &#123;</span><br><span class="line">  <span class="keyword">if</span> (n &gt; <span class="number">1000</span>) <span class="keyword">break</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="yield-表达式"><a href="#yield-表达式" class="headerlink" title="yield* 表达式"></a>yield* 表达式</h5><p>如果在 Generator 函数内部，调用另一个 Generator 函数。需要在前者的函数体内部，自己手动完成遍历。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">'a'</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">'b'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">bar</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">'x'</span>;</span><br><span class="line">  <span class="comment">// 手动遍历 foo()</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">of</span> foo()) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(i);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">'y'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> v <span class="keyword">of</span> bar())&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(v);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// x</span></span><br><span class="line"><span class="comment">// a</span></span><br><span class="line"><span class="comment">// b</span></span><br><span class="line"><span class="comment">// y</span></span><br></pre></td></tr></table></figure>
<p>ES6 提供了yield*表达式，作为解决办法，用来在一个 Generator 函数里面执行另一个 Generator 函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">bar</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">'x'</span>;</span><br><span class="line">  <span class="keyword">yield</span>* foo();</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">'y'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">bar</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">'x'</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">'a'</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">'b'</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">'y'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">bar</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">'x'</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> v <span class="keyword">of</span> foo()) &#123;</span><br><span class="line">    <span class="keyword">yield</span> v;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">'y'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> v <span class="keyword">of</span> bar())&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(v);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// "x"</span></span><br><span class="line"><span class="comment">// "a"</span></span><br><span class="line"><span class="comment">// "b"</span></span><br><span class="line"><span class="comment">// "y"</span></span><br></pre></td></tr></table></figure>
<h5 id="作为对象属性的-Generator-函数"><a href="#作为对象属性的-Generator-函数" class="headerlink" title="作为对象属性的 Generator 函数"></a>作为对象属性的 Generator 函数</h5><p>如果一个对象的属性是 Generator 函数，可以简写成下面的形式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">let obj &#x3D; &#123;</span><br><span class="line">  * myGeneratorMethod() &#123;</span><br><span class="line">    ···</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>上面代码中，myGeneratorMethod属性前面有一个星号，表示这个属性是一个 Generator 函数。</p>
<p>它的完整形式如下，与上面的写法是等价的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">let obj &#x3D; &#123;</span><br><span class="line">  myGeneratorMethod: function* () &#123;</span><br><span class="line">    &#x2F;&#x2F; ···</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>生成一个空对象，使用call方法绑定 Generator 函数内部的this。这样，构造函数调用以后，这个空对象就是 Generator 函数的实例对象了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">F</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.a = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="keyword">this</span>.b = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="keyword">this</span>.c = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> obj = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> f = F.call(obj);</span><br><span class="line"></span><br><span class="line">f.next();  <span class="comment">// Object &#123;value: 2, done: false&#125;</span></span><br><span class="line">f.next();  <span class="comment">// Object &#123;value: 3, done: false&#125;</span></span><br><span class="line">f.next();  <span class="comment">// Object &#123;value: undefined, done: true&#125;</span></span><br><span class="line"></span><br><span class="line">obj.a <span class="comment">// 1</span></span><br><span class="line">obj.b <span class="comment">// 2</span></span><br><span class="line">obj.c <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>
<p>首先是F内部的this对象绑定obj对象，然后调用它，返回一个 Iterator 对象。这个对象执行三次next方法（因为F内部有两个yield表达式），完成 F 内部所有代码的运行。这时，所有内部属性都绑定在obj对象上了，因此obj对象也就成了F的实例。</p>
<p>上面代码中，执行的是遍历器对象f，但是生成的对象实例是obj，有没有办法将这两个对象统一呢？</p>
<p>一个办法就是将obj换成F.prototype。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">F</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.a = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="keyword">this</span>.b = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="keyword">this</span>.c = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> f = F.call(F.prototype);</span><br><span class="line"></span><br><span class="line">f.next();  <span class="comment">// Object &#123;value: 2, done: false&#125;</span></span><br><span class="line">f.next();  <span class="comment">// Object &#123;value: 3, done: false&#125;</span></span><br><span class="line">f.next();  <span class="comment">// Object &#123;value: undefined, done: true&#125;</span></span><br><span class="line"></span><br><span class="line">f.a <span class="comment">// 1</span></span><br><span class="line">f.b <span class="comment">// 2</span></span><br><span class="line">f.c <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>
<p>再将F改成构造函数，就可以对它执行new命令了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">gen</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.a = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="keyword">this</span>.b = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="keyword">this</span>.c = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">F</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> gen.call(gen.prototype);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> f = <span class="keyword">new</span> F();</span><br><span class="line"></span><br><span class="line">f.next();  <span class="comment">// Object &#123;value: 2, done: false&#125;</span></span><br><span class="line">f.next();  <span class="comment">// Object &#123;value: 3, done: false&#125;</span></span><br><span class="line">f.next();  <span class="comment">// Object &#123;value: undefined, done: true&#125;</span></span><br><span class="line"></span><br><span class="line">f.a <span class="comment">// 1</span></span><br><span class="line">f.b <span class="comment">// 2</span></span><br><span class="line">f.c <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>
<p>Generator 可以暂停函数执行，返回任意表达式的值。这种特点使得 Generator 有多种应用场景。</p>
<p>（1）异步操作的同步化表达</p>
<p>Ajax 是典型的异步操作，通过 Generator 函数部署 Ajax 操作，可以用同步的方式表达。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> result = <span class="keyword">yield</span> request(<span class="string">"http://some.url"</span>);</span><br><span class="line">  <span class="keyword">var</span> resp = <span class="built_in">JSON</span>.parse(result);</span><br><span class="line">    <span class="built_in">console</span>.log(resp.value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">request</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">  makeAjaxCall(url, <span class="function"><span class="keyword">function</span>(<span class="params">response</span>)</span>&#123;</span><br><span class="line">    it.next(response);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> it = main();</span><br><span class="line">it.next();</span><br></pre></td></tr></table></figure>
<p>上面代码的main函数，就是通过 Ajax 操作获取数据。可以看到，除了多了一个yield，它几乎与同步操作的写法完全一样。注意，makeAjaxCall函数中的next方法，必须加上response参数，因为yield表达式，本身是没有值的，总是等于undefined。</p>
<p>下面是另一个例子，通过 Generator 函数逐行读取文本文件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">numbers</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> file = <span class="keyword">new</span> FileReader(<span class="string">"numbers.txt"</span>);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span>(!file.eof) &#123;</span><br><span class="line">      <span class="keyword">yield</span> <span class="built_in">parseInt</span>(file.readLine(), <span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    file.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码打开文本文件，使用yield表达式可以手动逐行读取文件。</p>
<p>（2）控制流管理<br>如果有一个多步操作非常耗时，采用回调函数，可能会写成下面这样。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">step1(<span class="function"><span class="keyword">function</span> (<span class="params">value1</span>) </span>&#123;</span><br><span class="line">  step2(value1, <span class="function"><span class="keyword">function</span>(<span class="params">value2</span>) </span>&#123;</span><br><span class="line">    step3(value2, <span class="function"><span class="keyword">function</span>(<span class="params">value3</span>) </span>&#123;</span><br><span class="line">      step4(value3, <span class="function"><span class="keyword">function</span>(<span class="params">value4</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// Do something with value4</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>采用 Promise 改写上面的代码。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.resolve(step1)</span><br><span class="line">  .then(step2)</span><br><span class="line">  .then(step3)</span><br><span class="line">  .then(step4)</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span> (<span class="params">value4</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Do something with value4</span></span><br><span class="line">  &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Handle any error from step1 through step4</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .done();</span><br></pre></td></tr></table></figure>
<p>上面代码已经把回调函数，改成了直线执行的形式，但是加入了大量 Promise 的语法。Generator 函数可以进一步改善代码运行流程。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">longRunningTask</span>(<span class="params">value1</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> value2 = <span class="keyword">yield</span> step1(value1);</span><br><span class="line">    <span class="keyword">var</span> value3 = <span class="keyword">yield</span> step2(value2);</span><br><span class="line">    <span class="keyword">var</span> value4 = <span class="keyword">yield</span> step3(value3);</span><br><span class="line">    <span class="keyword">var</span> value5 = <span class="keyword">yield</span> step4(value4);</span><br><span class="line">    <span class="comment">// Do something with value4</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="comment">// Handle any error from step1 through step4</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="函数的异步应用"><a href="#函数的异步应用" class="headerlink" title="函数的异步应用"></a>函数的异步应用</h4><p>ES6 诞生以前，异步编程的方法，大概有下面四种。</p>
<p>回调函数 事件监听 发布/订阅 Promise 对象</p>
<h5 id="回调"><a href="#回调" class="headerlink" title="回调"></a>回调</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fs.readFile(&#39;&#x2F;etc&#x2F;passwd&#39;, &#39;utf-8&#39;, function (err, data) &#123;</span><br><span class="line">  if (err) throw err;</span><br><span class="line">  console.log(data);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h5 id="Promise"><a href="#Promise" class="headerlink" title="Promise"></a>Promise</h5><p>回调函数本身并没有问题，它的问题出现在多个回调函数嵌套。假定读取A文件之后，再读取B文件，代码如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fs.readFile(fileA, <span class="string">'utf-8'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">  fs.readFile(fileB, <span class="string">'utf-8'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Promise 对象就是为了解决这个问题而提出的。它不是新的语法功能，而是一种新的写法，允许将回调函数的嵌套，改成链式调用。采用 Promise，连续读取多个文件，写法如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> readFile = <span class="built_in">require</span>(<span class="string">'fs-readfile-promise'</span>);</span><br><span class="line"></span><br><span class="line">readFile(fileA)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(data.toString());</span><br><span class="line">&#125;)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> readFile(fileB);</span><br><span class="line">&#125;)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(data.toString());</span><br><span class="line">&#125;)</span><br><span class="line">.catch(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>使用了fs-readfile-promise模块，它的作用就是返回一个 Promise 版本的readFile函数。Promise 提供then方法加载回调函数，catch方法捕捉执行过程中抛出的错误。</p>
<p>可以看到，Promise 的写法只是回调函数的改进，使用then方法以后，异步任务的两段执行看得更清楚了，除此以外，并无新意。</p>
<p>Promise 的最大问题是代码冗余，原来的任务被 Promise 包装了一下，不管什么操作，一眼看去都是一堆then，原来的语义变得很不清楚。</p>
<h5 id="Generator-函数的流程管理"><a href="#Generator-函数的流程管理" class="headerlink" title="Generator 函数的流程管理"></a>Generator 函数的流程管理</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">gen</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> g = gen();</span><br><span class="line"><span class="keyword">var</span> res = g.next();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(!res.done)&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(res.value);</span><br><span class="line">  res = g.next();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是，这不适合异步操作。如果必须保证前一步执行完，才能执行后一步，上面的自动执行就不可行。这时，Thunk 函数就能派上用处。以读取文件为例。下面的 Generator 函数封装了两个异步操作。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> thunkify = <span class="built_in">require</span>(<span class="string">'thunkify'</span>);</span><br><span class="line"><span class="keyword">var</span> readFileThunk = thunkify(fs.readFile);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> gen = <span class="function"><span class="keyword">function</span>* (<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> r1 = <span class="keyword">yield</span> readFileThunk(<span class="string">'/etc/fstab'</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(r1.toString());</span><br><span class="line">  <span class="keyword">var</span> r2 = <span class="keyword">yield</span> readFileThunk(<span class="string">'/etc/shells'</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(r2.toString());</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>上面代码中，yield命令用于将程序的执行权移出 Generator 函数，那么就需要一种方法，将执行权再交还给 Generator 函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> g = gen();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> r1 = g.next();</span><br><span class="line">r1.value(<span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">  <span class="keyword">var</span> r2 = g.next(data);</span><br><span class="line">  r2.value(<span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">    g.next(data);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>变量g是 Generator 函数的内部指针，表示目前执行到哪一步。next方法负责将指针移动到下一步，并返回该步的信息（value属性和done属性）。</p>
<h5 id="Thunk-函数的自动流程管理"><a href="#Thunk-函数的自动流程管理" class="headerlink" title="Thunk 函数的自动流程管理"></a>Thunk 函数的自动流程管理</h5><p>Thunk 函数真正的威力，在于可以自动执行 Generator 函数。下面就是一个基于 Thunk 函数的 Generator 执行器。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> gen = fn();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = gen.next(data);</span><br><span class="line">    <span class="keyword">if</span> (result.done) <span class="keyword">return</span>;</span><br><span class="line">    result.value(next);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  next();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">g</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run(g);</span><br></pre></td></tr></table></figure>
<p>上面代码的run函数，就是一个 Generator 函数的自动执行器。内部的next函数就是 Thunk 的回调函数。next函数先将指针移到 Generator 函数的下一步（gen.next方法），然后判断 Generator 函数是否结束（result.done属性），如果没结束，就将next函数再传入 Thunk 函数（result.value属性），否则就直接退出。</p>
<p>有了这个执行器，执行 Generator 函数方便多了。不管内部有多少个异步操作，直接把 Generator 函数传入run函数即可。当然，前提是每一个异步操作，都要是 Thunk 函数，也就是说，跟在yield命令后面的必须是 Thunk 函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> g = <span class="function"><span class="keyword">function</span>* (<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> f1 = <span class="keyword">yield</span> readFileThunk(<span class="string">'fileA'</span>);</span><br><span class="line">  <span class="keyword">var</span> f2 = <span class="keyword">yield</span> readFileThunk(<span class="string">'fileB'</span>);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">var</span> fn = <span class="keyword">yield</span> readFileThunk(<span class="string">'fileN'</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">run(g);</span><br></pre></td></tr></table></figure>
<p>上面代码中，函数g封装了n个异步的读取文件操作，只要执行run函数，这些操作就会自动完成。这样一来，异步操作不仅可以写得像同步操作，而且一行代码就可以执行。</p>
<p>Thunk 函数并不是 Generator 函数自动执行的唯一方案。因为自动执行的关键是，必须有一种机制，自动控制 Generator 函数的流程，接收和交还程序的执行权。回调函数可以做到这一点，Promise 对象也可以做到这一点。</p>
<h5 id="co-模块"><a href="#co-模块" class="headerlink" title="co 模块"></a>co 模块</h5><p>co 模块是著名程序员 TJ Holowaychuk 于 2013 年 6 月发布的一个小工具，用于 Generator 函数的自动执行。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> gen = <span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">//用于依次读取两个文件。</span></span><br><span class="line">  <span class="keyword">var</span> f1 = <span class="keyword">yield</span> readFile(<span class="string">'/etc/fstab'</span>);</span><br><span class="line">  <span class="keyword">var</span> f2 = <span class="keyword">yield</span> readFile(<span class="string">'/etc/shells'</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(f1.toString());</span><br><span class="line">  <span class="built_in">console</span>.log(f2.toString());</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//co 模块可以让你不用编写 Generator 函数的执行器。</span></span><br><span class="line"><span class="keyword">var</span> co = <span class="built_in">require</span>(<span class="string">'co'</span>);</span><br><span class="line">co(gen);</span><br></pre></td></tr></table></figure>
<p>co函数返回一个Promise对象，因此可以用then方法添加回调函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">co(gen).then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Generator 函数执行完成'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>** co 模块的原理 **<br>为什么 co 可以自动执行 Generator 函数？</p>
<p>前面说过，Generator 就是一个异步操作的容器。它的自动执行需要一种机制，当异步操作有了结果，能够自动交回执行权。两种方法可以做到这一点。</p>
<p>（1）回调函数。将异步操作包装成 Thunk 函数，在回调函数里面交回执行权。</p>
<p>（2）Promise 对象。将异步操作包装成 Promise 对象，用then方法交回执行权。</p>
<h5 id="基于-Promise-对象的自动执行器"><a href="#基于-Promise-对象的自动执行器" class="headerlink" title="基于 Promise 对象的自动执行器"></a>基于 Promise 对象的自动执行器</h5><p>还是沿用上面的例子。首先，把fs模块的readFile方法包装成一个 Promise 对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> readFile = <span class="function"><span class="keyword">function</span> (<span class="params">fileName</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>)</span>&#123;</span><br><span class="line">    fs.readFile(fileName, <span class="function"><span class="keyword">function</span>(<span class="params">error, data</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (error) <span class="keyword">return</span> reject(error);</span><br><span class="line">      resolve(data);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> gen = <span class="function"><span class="keyword">function</span>* (<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> f1 = <span class="keyword">yield</span> readFile(<span class="string">'/etc/fstab'</span>);</span><br><span class="line">  <span class="keyword">var</span> f2 = <span class="keyword">yield</span> readFile(<span class="string">'/etc/shells'</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(f1.toString());</span><br><span class="line">  <span class="built_in">console</span>.log(f2.toString());</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>然后，手动执行上面的 Generator 函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> g = gen();</span><br><span class="line"></span><br><span class="line">g.next().value.then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">  g.next(data).value.then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    g.next(data);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>手动执行其实就是用then方法，层层添加回调函数。理解了这一点，就可以写出一个自动执行器。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params">gen</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> g = gen();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = g.next(data);</span><br><span class="line">    <span class="keyword">if</span> (result.done) <span class="keyword">return</span> result.value;</span><br><span class="line">    result.value.then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">      next(data);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  next();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run(gen);</span><br></pre></td></tr></table></figure>
<p>co 模块的源码分析</p>
<p>co 支持并发的异步操作，即允许某些操作同时进行，等到它们全部完成，才进行下一步。</p>
<p>这时，要把并发的操作都放在数组或对象里面，跟在yield语句后面。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数组的写法</span></span><br><span class="line">co(<span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> res = <span class="keyword">yield</span> [</span><br><span class="line">    <span class="built_in">Promise</span>.resolve(<span class="number">1</span>),</span><br><span class="line">    <span class="built_in">Promise</span>.resolve(<span class="number">2</span>)</span><br><span class="line">  ];</span><br><span class="line">  <span class="built_in">console</span>.log(res);</span><br><span class="line">&#125;).catch(onerror);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对象的写法</span></span><br><span class="line">co(<span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> res = <span class="keyword">yield</span> &#123;</span><br><span class="line">    <span class="number">1</span>: <span class="built_in">Promise</span>.resolve(<span class="number">1</span>),</span><br><span class="line">    <span class="number">2</span>: <span class="built_in">Promise</span>.resolve(<span class="number">2</span>),</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="built_in">console</span>.log(res);</span><br><span class="line">&#125;).catch(onerror);</span><br></pre></td></tr></table></figure>
<p>例子。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">co(<span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> values = [n1, n2, n3];</span><br><span class="line">  <span class="keyword">yield</span> values.map(somethingAsync);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">somethingAsync</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// do something async</span></span><br><span class="line">  <span class="keyword">return</span> y</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码允许并发三个somethingAsync异步操作，等到它们全部完成，才会进行下一步。</p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/">上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><a class="extend next" rel="next" href="/page/6/">下一页</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://img.huyunshun.com/img/20200522182348.png"
                alt="初晨" />
            
              <p class="site-author-name" itemprop="name">初晨</p>
              <p class="site-description motion-element" itemprop="description">永远不要说你知道本质，更别说真相了。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">249</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">46</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">109</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          
<!--近期文章版块-->
            
                <div class="links-of-blogroll motion-element links-of-blogroll-block">
                  <div class="links-of-blogroll-title">
                    <!-- modify icon to fire by szw -->
                    <i class="fa fa-history fa-" aria-hidden="true"></i>
                    近期文章
                  </div>
                  <ul class="links-of-blogroll-list">
                    
                    
                      <li>
                        <a href="/2020/05/22/WebSocket%E3%80%81Socket%E3%80%81TCP%E3%80%81HTTP%E5%8C%BA%E5%88%AB/" title="WebSocket、Socket、TCP、HTTP区别" target="_blank">WebSocket、Socket、TCP、HTTP区别</a>
                      </li>
                    
                      <li>
                        <a href="/2020/05/19/Springboot%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%8E%A5%E5%8F%A3%E9%98%B2%E5%88%B7/" title="Springboot项目的接口防刷" target="_blank">Springboot项目的接口防刷</a>
                      </li>
                    
                      <li>
                        <a href="/2020/05/03/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Volatile%E5%85%B3%E9%94%AE%E5%AD%97%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" title="深入理解Volatile关键字及其实现原理" target="_blank">深入理解Volatile关键字及其实现原理</a>
                      </li>
                    
                      <li>
                        <a href="/2020/04/20/%E4%BD%BF%E7%94%A8vscode%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0%E7%8E%AF%E5%A2%83/" title="使用vscode搭建个人笔记环境" target="_blank">使用vscode搭建个人笔记环境</a>
                      </li>
                    
                      <li>
                        <a href="/2020/01/20/HBase%E4%BB%8B%E7%BB%8D%E5%AE%89%E8%A3%85%E4%B8%8E%E6%93%8D%E4%BD%9C/" title="HBase介绍安装与操作" target="_blank">HBase介绍安装与操作</a>
                      </li>
                    
                  </ul>
                </div>
            
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Copyright</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  


</body>
</html>
