<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="永远不要说你知道本质，更别说真相了。">
<meta property="og:type" content="website">
<meta property="og:title" content="简">
<meta property="og:url" content="https://huyunshun.com/page/22/index.html">
<meta property="og:site_name" content="简">
<meta property="og:description" content="永远不要说你知道本质，更别说真相了。">
<meta property="article:author" content="初晨">
<meta property="article:tag" content="编程">
<meta property="article:tag" content="开发">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://huyunshun.com/page/22/"/>





  <title>简</title>
  








  <script type="text/javascript" src="/js/src/love.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">

  <!-- 看板娘 -->
    
        <script async src="/live2d-widget/autoload.js"></script>
    
 <!-- 飘动的彩带） -->
  <script src="/js/src/piao.js" type="text/javascript"></script>
<meta name="generator" content="Hexo 4.2.1"></head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">简</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">人生短暂，学海无边，而大道至简。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2017/08/01/windows%E4%B8%8A%E5%AE%89%E8%A3%85mysql5.7%E9%97%AE%E9%A2%98%E5%92%8C%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97%E8%AE%BE%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/01/windows%E4%B8%8A%E5%AE%89%E8%A3%85mysql5.7%E9%97%AE%E9%A2%98%E5%92%8C%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97%E8%AE%BE%E7%BD%AE/" itemprop="url">windows上安装mysql5.7问题和查询日志设置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-01T09:16:54+08:00">
                2017-08-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Windows上安装MySQL5.7，没有msi安装包，直接下载zip解压版。</p>
<p><strong>解压到自己需要的安装目录，该目录创建my.ini并配置：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">port&#x3D;3306</span><br><span class="line">default-character-set&#x3D;utf8</span><br><span class="line">[mysqld]</span><br><span class="line"># 设置为自己MYSQL的安装目录</span><br><span class="line">basedir&#x3D;E:\mysql\mysql-5.7.20-winx64</span><br><span class="line"># 设置为MYSQL的数据目录</span><br><span class="line">datadir&#x3D;G:\mysql\Data</span><br><span class="line">port&#x3D;3306</span><br><span class="line">character_set_server&#x3D;utf8</span><br><span class="line">sql_mode&#x3D;NO_ENGINE_SUBSTITUTION,NO_AUTO_CREATE_USER</span><br><span class="line">#开启查询缓存</span><br><span class="line">explicit_defaults_for_timestamp&#x3D;true</span><br><span class="line"># 允许最大连接数</span><br><span class="line">max_connections&#x3D;200</span><br><span class="line"># 服务端使用的字符集默认为8比特编码的latin1字符集</span><br><span class="line">character-set-server&#x3D;utf8</span><br><span class="line"># 创建新表时将使用的默认存储引擎</span><br><span class="line">default-storage-engine&#x3D;INNODB</span><br><span class="line">#底下代码开启，是数据库每次重启之后不要密码就可以连接数据库，适用于管理员忘记密码时的操作</span><br><span class="line">#skip-grant-tables</span><br></pre></td></tr></table></figure>
<p><strong>进入bin目录，执行命令：mysqld -install进行安装</strong></p>
<p>安装后查看data目录有没有生成相关文件，如果没有，再次执行下面命令。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">输入mysqld --initialize-insecure自动生成无密码的root用户，产生data文件夹</span><br><span class="line">输入mysqld --initialize自动生成带随机密码的root用户。（注：data文件夹存在时不能执行这个命令。可以先删除data目录下的所有文件夹）</span><br></pre></td></tr></table></figure>

<p>这样就安装完成了，输入net start mysql启动服务，然后就可以进行连接数据库登录等操作了。</p>
<p>设置查询日志参考：<a href="http://www.cnblogs.com/kerrycode/p/7130403.html" target="_blank" rel="noopener">http://www.cnblogs.com/kerrycode/p/7130403.html</a></p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2017/06/21/CentOS%E5%8D%87%E7%BA%A7%EF%BC%8CIP%EF%BC%8C%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6%E7%AD%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/21/CentOS%E5%8D%87%E7%BA%A7%EF%BC%8CIP%EF%BC%8C%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6%E7%AD%89/" itemprop="url">CentOS升级，IP，安装软件等</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-21T00:00:00+08:00">
                2017-06-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="将CentOS升级至最新版本"><a href="#将CentOS升级至最新版本" class="headerlink" title="将CentOS升级至最新版本"></a>将CentOS升级至最新版本</h2><pre><code>1. 检查你的CentOS版本。

# cat /etc/redhat-release
CentOS Linux release 7.1.1503 (Core)
2. 备份重要数据和目录（例如：/ etc，/ var，/ opt）

我建议，对于VMware虚拟机，请采用一个好的VMware快照或运行操作系统和数据的完整备份。（MySQL，Apache，NGINX，DNS等），可以查看本站如何备份数据的教程.

3. 用yum更新升级。

# yum clean all
# yum update
4. 用下面的命令重新启动服务器。

# reboot
5. 确认您的系统已成功升级

# cat /etc/redhat-release
CentOS Linux release 7.4.1611 (Core)</code></pre><h2 id="IP"><a href="#IP" class="headerlink" title="IP"></a>IP</h2><p>在Centos7中，要查看IP地址，不再使用ifconfig命令，而是使用了IP命令。</p>
<p>查看虚拟机IP地址：ip addr</p>
<p>Centos的IP地址是网卡的inet 的值，第一个是本地服务地址，选择第二个。</p>
<p>接下来配置网卡，上面ens33。使用vi编辑器打开配置文件：</p>
<p>vi /etc/sysconfig/network-scripts/ifcfg-ens33</p>
<p>发现默认是不启动网卡的（ONBOOT=no）。J键将光标移动到最后一行，L键将光标移动到最后一列，再按i键进入到插入模式下，把这一项改为yes（ONBOOT=yes），保存退出。</p>
<p>然后重启网络服务：service network restart</p>
<p>再通过ip addr即可看到IP</p>
<h2 id="安装基础软件"><a href="#安装基础软件" class="headerlink" title="安装基础软件"></a>安装基础软件</h2><pre><code>1、修改yum源
wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
yum clean all
yum makecache
2、安装vim
um -y install vim*
3、安装wget命令
yum -y install wget
4、安装java
yum -y install java-1.8.0-openjd</code></pre>
          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2017/05/11/Java%E5%8A%A8%E6%80%81%E6%80%A7%E3%80%81%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E3%80%81%E7%B1%BB%E5%8A%A0%E8%BD%BD%E3%80%81%E5%8A%A8%E6%80%81%E7%BC%96%E8%AF%91%E3%80%81%E8%84%9A%E6%9C%AC%E5%BC%95%E6%93%8E%E3%80%81%E5%AD%97%E8%8A%82%E7%A0%81%E6%93%8D%E4%BD%9C...../">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/11/Java%E5%8A%A8%E6%80%81%E6%80%A7%E3%80%81%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E3%80%81%E7%B1%BB%E5%8A%A0%E8%BD%BD%E3%80%81%E5%8A%A8%E6%80%81%E7%BC%96%E8%AF%91%E3%80%81%E8%84%9A%E6%9C%AC%E5%BC%95%E6%93%8E%E3%80%81%E5%AD%97%E8%8A%82%E7%A0%81%E6%93%8D%E4%BD%9C...../" itemprop="url">Java动态性、反射机制、类加载、动态编译、脚本引擎、字节码操作......md</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-11T00:00:00+08:00">
                2017-05-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="动态性"><a href="#动态性" class="headerlink" title="动态性"></a>动态性</h2><p>Java动态性有：反射机制，动态编译/代理，字节码操作。常见的是反射和字节码操作。</p>
<p>Java让我们在运行时识别对象和类的信息，主要有2种方式：一种是传统的RTTI，它假定我们在编译时已经知道了所有的类型信息；另一种是反射机制，它允许我们在运行时发现和使用类的信息。</p>
<h3 id="类的生命周期"><a href="#类的生命周期" class="headerlink" title="类的生命周期"></a>类的生命周期</h3><p><img src="https://img.huyunshun.com/img/20200412222135.png" alt="20200412222135"></p>
<p>类加载初始化阶段，必须对类进行初始化的情况：</p>
<ul>
<li><p>1、使用new关键字实例化对象时、读取或者设置一个类的静态字段(除final常量)以及调用静态方法的时候。</p>
</li>
<li><p>2、使用反射包(java.lang.reflect)的方法对类进行反射调用时，如果类还没有被初始化，则需先进行初始化，这点对反射很重要。</p>
</li>
<li><p>3、当初始化一个类的时候，如果其父类还没进行初始化则需先触发其父类的初始化。</p>
</li>
<li><p>4、当Java虚拟机启动时，用户需要指定一个要执行的主类(包含main方法的类)，虚拟机会先初始化这个主类</p>
</li>
<li><p>5、当使用JDK 1.7 的动态语言支持时，如果一个java.lang.invoke.MethodHandle 实例最后解析结果为REF_getStatic、REF_putStatic、REF_invokeStatic的方法句柄，并且这个方法句柄对应类没有初始化时。</p>
</li>
</ul>
<p>不会被初始化的情况：</p>
<pre><code>当访问静态域，只有真正声明这个域的类菜会被初始化。

    通过子类引用父类的静态变量，不会导致子类初始化。

通过数组定义引用类，不会触发此类初始化

引用常量不会触发此类的初始化。</code></pre><h3 id="Class对象"><a href="#Class对象" class="headerlink" title="Class对象"></a>Class对象</h3><p>Class类的对象作用是运行时提供或获得某个对象的类型信息。</p>
<p>　　理解RTTI在Java中的工作原理，首先需要知道类型信息在运行时是如何表示的，这是由Class对象来完成的，它包含了与类有关的信息。Class对象就是用来创建所有“常规”对象的，Java使用Class对象来执行RTTI，即使你正在执行的是类似类型转换这样的操作。</p>
<p>　　每个类都会产生一个对应的Class对象，也就是保存在.class文件。</p>
<p>比如创建一个Shapes类，编译Shapes类后就会创建其包含Shapes类相关类型信息的Class对象，并保存在Shapes.class字节码文件中。</p>
<p>所有类都是在对其第一次使用时，动态加载到JVM的，当程序创建一个对类的静态成员的引用时，就会加载这个类。Class对象仅在需要的时候才会加载，static初始化是在类加载时进行的。</p>
<p>类加载器首先会检查这个类的Class对象是否已被加载过，如果尚未加载，默认的类加载器就会根据类名查找对应的.class文件。</p>
<p>　　想在运行时使用类型信息，必须获取对象的Class对象的引用，使用功能Class.forName(“Base”)可以实现该目的，或者使用base.class。</p>
<p>注：使用.class来创建Class对象的引用时，不会自动初始化该Class对象，使用forName()会自动初始化该Class对象。为了使用类而做的准备工作一般有以下3个步骤：</p>
<p>加载：由类加载器完成，找到对应的字节码，创建一个Class对象</p>
<p>链接：验证类中的字节码，为静态域分配空间</p>
<p>初始化：如果该类有超类，则对其初始化，执行静态初始化器和静态初始化块</p>
<p>获取Class类的四种方式</p>
<p>1.调用运行时类本身的.class属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class clazz &#x3D; String.class;</span><br></pre></td></tr></table></figure>
<p>2.通过运行时类的对象获取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Person p &#x3D; new Person();</span><br><span class="line">Class clazz &#x3D; p.getClass();</span><br></pre></td></tr></table></figure>
<p>3.通过Class的静态方法获取:体现反射的动态性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class clazz &#x3D; Class.forName(&quot;com.util.xxx&quot;);</span><br></pre></td></tr></table></figure>
<p>4.通过类的加载器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ClassLoader classLoader &#x3D; this.getClass().getClassLoader();</span><br><span class="line">Class clazz &#x3D; classLoader.loadClass(&quot;com.util.xxx&quot;);</span><br></pre></td></tr></table></figure>
<p>这是一个实例方法,需要一个ClassLoader对象来调用该方法,该方法将Class文件加载到内存时,并不会执行类的初始化,直到这个类第一次使用时才进行初始化.该方法因为需要得到一个ClassLoader对象,所以可以根据需要指定使用哪个类加载器.</p>
<h2 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h2><p>Class类和java.lang.reflect类库一起对反射进行了支持，该类库包含Field、Method和Constructor类，这些类的对象由JVM在启动时创建，以表示未知类里对应的成员。这就就可以使用Contructor创建新的对象，用get()和set()方法获取和修改类中与Field对象关联的字段，用invoke()方法调用与Method对象关联的方法。另外，还可以调用getFields()、getMethods()和getConstructors()等许多便利的方法，以返回表示字段、方法、以及构造器对象的数组，这样，对象信息可以在运行时被完全确定下来，而在编译时不需要知道关于类的任何事情。</p>
<p>　　通过反射与一个未知类型的对象打交道时，JVM只是简单地检查这个对象，看它属于哪个特定的类。因此，那个类的.class对于JVM来说必须是可获取的，要么在本地机器上，要么从网络获取。所以对于RTTI和反射之间的真正区别只在于：</p>
<p>RTTI：编译器在编译时打开和检查.class文件</p>
<p>反射：运行时打开和检查.class文件</p>
<p>instanceof 关键字与isInstance方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if(obj instanceof Animal)&#123;</span><br><span class="line">    Animal animal&#x3D; (Animal) obj;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;isInstance方法则是Class类中的一个Native方法</span><br><span class="line">if(Animal.class.isInstance(obj))&#123;</span><br><span class="line">    Animal animal&#x3D; (Animal) obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参考：<a href="https://blog.csdn.net/javazejian/article/details/70768369" target="_blank" rel="noopener">https://blog.csdn.net/javazejian/article/details/70768369</a></p>
<h2 id="动态编译"><a href="#动态编译" class="headerlink" title="动态编译"></a>动态编译</h2><p>就是运行时动态生成java代码， JAVA 6.0引入了动态编译机制。</p>
<p><strong>动态编译的应用场景</strong></p>
<p>比如浏览器端编写java代码，上传服务器编译和运行。</p>
<p>服务器动态加载某些类文件进行编译。</p>
<p><strong>动态编译的两种做法：</strong></p>
<ul>
<li>通过Runtime调用javac，启动新的进程去操作，这是一种模拟操作。</li>
</ul>
<p>Runtime run = Runtime.getRuntime();</p>
<p>Process process = run.exec(“javac -cp d:/myjava/ HelloWorld.java”);</p>
<ul>
<li>通过JavaCompiler动态编译<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public static int compileFile(String sourceFile)&#123;</span><br><span class="line">    &#x2F;&#x2F; 动态编译</span><br><span class="line">    JavaCompiler compiler &#x3D; ToolProvider.getSystemJavaCompiler();</span><br><span class="line">    int result &#x3D; compiler.run(null, null, null,sourceFile);</span><br><span class="line">    System.out.println(result&#x3D;&#x3D;0?&quot; 编译成功 &quot;:&quot; 编译失败 &quot;);</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  第一个参数： 为java编译器提供参数<br>  第二个参数： 得到 Java 编译器的输出信息<br>  第三个参数： 接收编译器的 错误信息<br>  第四个参数： 可变参数（是一个String数组）能传入一个或多个 Java 源文件<br>  返回值： 0表示编译成功，非0表示编译失败</li>
</ul>
<p>动态编译运行好的类</p>
<p>1、通过Runtime.getRuntime() 运行启动新的进程运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Runtime run &#x3D; Runtime.getRuntime();</span><br><span class="line">Process process &#x3D; run.exec(&quot;java -cp d:&#x2F;myjava HelloWorld&quot;);</span><br><span class="line">&#x2F;&#x2F; Process process &#x3D; run.exec(&quot;java -cp &quot;+dir+&quot; &quot;+classFile);</span><br></pre></td></tr></table></figure>
<p>2、通过反射运行编译好的类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public static void runJavaClassByReflect(String dir,String classFile) throws Exception&#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        URL[] urls &#x3D; new URL[] &#123;new URL(&quot;file:&#x2F;&quot;+dir)&#125;;</span><br><span class="line">        URLClassLoader loader &#x3D; new URLClassLoader(urls);</span><br><span class="line">        Class c &#x3D; loader.loadClass(classFile);</span><br><span class="line">        &#x2F;&#x2F;调用加载类的main方法</span><br><span class="line">        c.getMethod(&quot;main&quot;,String[].class).invoke(null, (Object)new String[]&#123;&#125;);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="脚本引擎"><a href="#脚本引擎" class="headerlink" title="脚本引擎"></a>脚本引擎</h2><p>JAVA脚本引擎是从JDK6.0之后添加的新功能。</p>
<p>脚本引擎介绍：使得 Java 应用程序可以通过一套固定的接口与各种脚本引擎交互，从而达到在 Java 平台上调用各种脚本语言的目的。</p>
<p>Java 脚本 API 是连通 Java 平台和脚本语言的桥梁。可以把一些复杂异变的业务逻辑交给脚本语言处理。</p>
<p>获得脚本引擎对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ScriptEngineManager sem &#x3D; new ScriptEngineManager();</span><br><span class="line">ScriptEngine engine &#x3D; sem.getEngineByName(&quot;javascript&quot;);</span><br></pre></td></tr></table></figure>
<p>Java 脚本 API 为开发者提供了如下功能：</p>
<pre><code>获取脚本程序输入，通过脚本引擎运行脚本并返回运行结果，这是最核心的接口。
Java可以使用各种不同的实现，从而通用的调用js、python等脚本。</code></pre><p>– 使用Js脚本引擎：Rhino</p>
<p><a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino</a></p>
<p>Rhino 是一种使用 Java 语言编写的 JavaScript 的开源实现，现在被集成进入JDK 6.0。</p>
<p>– 通过脚本引擎的运行上下文在脚本和 Java 平台间交换数据。</p>
<p>– 通过 Java 应用程序调用脚本函数。</p>
<h2 id="字节码操作"><a href="#字节码操作" class="headerlink" title="字节码操作"></a>字节码操作</h2><p>就是在运行时对字节码操作，可以让我们实现如下功能：</p>
<pre><code>动态生成新的类

动态改变某个类的结构（添加、删除、修改  新的属性和方法）</code></pre><p>字节码操作的优势：比反射开销小，性能高</p>
<p>常见的字节码类库如下；</p>
<p>-BECL ：是java classworking广泛使用的一种框架，可以深入理解JVM汇编语言进行类的操作细节。</p>
<p>基于JVM底层指令操作，比较难学。哈哈</p>
<p>-ASM ：轻量级的java字节码操作框架类库，直接涉及JVM底层操作和指令</p>
<p>-CGLIB  ：是基于ASM的的实现，强大性能高</p>
<p>-Javassist ：开源框架，较简单。</p>
<p>支持类库和bytecode来操作字节码，性能相对BECL,ASM性能低下，跟CGLIB差不多，很多开源框架都在使用它，常见。</p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2017/05/11/Java%E5%8A%A8%E6%80%81%E7%BC%96%E7%A8%8B%E2%80%94%E2%80%94Javassist/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/11/Java%E5%8A%A8%E6%80%81%E7%BC%96%E7%A8%8B%E2%80%94%E2%80%94Javassist/" itemprop="url">Java动态编程——Javassist</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-11T00:00:00+08:00">
                2017-05-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>动态编程是相对于静态编程而言的,平时我们讨论比较多的就是静态编程语言，例如Java，与动态编程语言，例如JavaScript。</p>
<p>在静态编程中，类型检查是在编译时完成的，而动态编程中类型检查是在运行时完成的。所谓动态编程就是绕过编译过程在运行时进行操作的技术，在Java中有如下几种方式：</p>
<ul>
<li><p>反射：就是通过在运行时获得类型信息然后做相应的操作。</p>
</li>
<li><p>动态编译：动态编译是从Java 6开始支持的，主要是通过一个JavaCompiler接口来完成的。通过这种方式我们可以直接编译一个已经存在的java文件，也可以在内存中动态生成Java代码，动态编译执行。</p>
</li>
<li><p>调用JavaScript引擎：Java 6加入了对Script(JSR223)的支持。这是一个脚本框架，提供了让脚本语言来访问Java内部的方法。你可以在运行的时候找到脚本引擎，然后调用这个引擎去执行脚本。这个脚本API允许你为脚本语言提供Java支持。</p>
</li>
<li><p>动态生成字节码：这种技术通过操作Java字节码的方式在JVM中生成新类或者对已经加载的类动态添加元素。</p>
</li>
</ul>
<p><strong>动态编程解决什么问题</strong></p>
<p>在静态语言中引入动态特性，主要是为了解决一些使用场景的问题。</p>
<p>完全使用静态编程也办的到，只是付出的代价比较高，没有动态编程来的优雅。例如依赖注入框架Spring使用了反射，而Dagger2 却使用了代码生成的方式（APT）。</p>
<p>如 </p>
<p>1、在那些依赖关系需要动态确认的场景: </p>
<p>2、需要在运行时动态插入代码的场景，比如动态代理的实现。 </p>
<p>3、通过配置文件来实现相关功能的场景</p>
<h2 id="Javassist"><a href="#Javassist" class="headerlink" title="Javassist"></a>Javassist</h2><p>操作java字节码的工具BECL/ASM/CGLIB/Javassit</p>
<p>其中有两个比较流行，一个是ASM，一个是Javassit。</p>
<p>ASM 直接操作字节码指令，执行效率高，要是使用者掌握Java类字节码文件格式及指令，对使用者的要求比较高。</p>
<p>Javassit 提供了更高级的API，执行效率相对较差，但无需掌握字节码指令的知识，对使用者要求较低。</p>
<p>Javassit 是一个开源的分析、编辑和创建Java字节码的类库。是由东京工业大学的数学和计算机科学系的 Shigeru Chiba （千叶 滋）所创建的。它已加入了开放源代码JBoss应用服务器项目,通过使用Javassist对字节码操作为JBoss实现动态AOP框架。javassist是jboss的一个子项目，其主要的优点，在于简单，而且快速。直接使用java编码的形式，而不需要了解虚拟机指令，就能动态改变类的结构，或者动态生成类。</p>
<p>Javassist中最为重要的是ClassPool，CtClass ，CtMethod 以及 CtField这几个类。</p>
<p>ClassPool：一个基于HashMap实现的CtClass对象容器，其中键是类名称，值是表示该类的CtClass对象。默认的ClassPool使用与底层JVM相同的类路径，因此在某些情况下，可能需要向ClassPool添加类路径或类字节。</p>
<p>CtClass：表示一个类，这些CtClass对象可以从ClassPool获得。</p>
<p>CtMethods：表示类中的方法。</p>
<p>CtFields ：表示类中的字段。</p>
<p>例子：</p>
<p>创建Class，Field，Method，Constructor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ClassPool pool = ClassPool.getDefault();</span><br><span class="line">    CtClass person = pool.makeClass(<span class="string">"com.temp.bytecodeop.Person"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建属性</span></span><br><span class="line">    CtField name = CtField.make(<span class="string">"private String name;"</span>, person);</span><br><span class="line">    CtField age = CtField.make(<span class="string">"private int age;"</span>, person);</span><br><span class="line">    person.addField(name);</span><br><span class="line">    person.addField(age);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建方法</span></span><br><span class="line">    CtMethod getName = CtMethod.make(<span class="string">"public String getName()&#123;return name;&#125;"</span>, person);</span><br><span class="line">    CtMethod setName = CtMethod.make(<span class="string">"public void setName(String name)&#123;this.name=name;&#125;"</span>, person);</span><br><span class="line">    person.addMethod(getName);</span><br><span class="line">    person.addMethod(setName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建构造器        </span></span><br><span class="line">    CtConstructor constructor = <span class="keyword">new</span> CtConstructor(<span class="keyword">new</span> CtClass[]&#123;pool.get(<span class="string">"java.lang.String"</span>),CtClass.intType&#125;,person);</span><br><span class="line">    constructor.setBody(<span class="string">"&#123;this.name=name; this.age=age;&#125;"</span>);</span><br><span class="line">    person.addConstructor(constructor);</span><br><span class="line"></span><br><span class="line">    person.writeFile(<span class="string">"c:/Person"</span>);</span><br><span class="line">    System.out.println(<span class="string">"success"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参考文献：<a href="https://blog.csdn.net/ShuSheng0007/article/details/81269295" target="_blank" rel="noopener">https://blog.csdn.net/ShuSheng0007/article/details/81269295</a></p>
<p><a href="https://www.cnblogs.com/sunfie/p/5154246.html" target="_blank" rel="noopener">https://www.cnblogs.com/sunfie/p/5154246.html</a></p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2017/05/11/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%B9%B6%E5%8F%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/11/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%B9%B6%E5%8F%91/" itemprop="url">Java多线程并发</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-11T00:00:00+08:00">
                2017-05-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="锁的种类"><a href="#锁的种类" class="headerlink" title="锁的种类"></a>锁的种类</h2><p>Java 中锁的种类大致分为偏向锁，自旋锁，轻量级锁，重量级锁。锁的使用方式为：先提供偏向锁，如果不满足的时候，升级为轻量级锁，再不满足，升<br>级为重量级锁。自旋锁是一个过渡的锁状态，不是一种实际的锁类型。锁只能升级，不能降级。</p>
<h2 id="锁的底层实现"><a href="#锁的底层实现" class="headerlink" title="锁的底层实现"></a>锁的底层实现</h2><p>Java 虚拟机中的同步(Synchronization)基于进入和退出管程(Monitor)对象实现。同步方法由方法调用指令读取运行时常量池中方法的 ACC_SYNCHRONIZED 标志来隐式实现的。</p>
<p><img src="https://img.huyunshun.com/img/20200414091222.png" alt="20200414091222"></p>
<ul>
<li>对象头：存储对象的 hashCode、锁信息或分代年龄或 GC 标志，类型指针指向对象的类元数据，JVM 通过这个指针确定该对象是哪个类的实例等信息。</li>
<li>实例变量：存放类的属性数据信息，包括父类的属性信息。</li>
<li>填充数据：由于虚拟机要求对象起始地址必须是 8 字节的整数倍。填充数据不是必须存在的，仅仅是为了字节对齐。</li>
</ul>
<p>在 Java 虚拟机(HotSpot)中，monitor 是由 ObjectMonitor 实现的。ObjectMonitor 中有两个队列，_WaitSet 和 _EntryList，以及_Owner 标记。其中_WaitSet是用于管理等待队列(wait)线程的，_EntryList 是用于管理锁池阻塞线程的，_Owner 标记用于记录当前执行线程。</p>
<p>当在对象上加锁时，加锁信息的数据是记录在对象头中。会在对象头中记录锁标记，锁标记指向的是 monitor 对象（也称为管程或监视器锁）的起始地址。每个对象都存在着一个 monitor 与之关联，对象与其 monitor 之间的关系有存在多种实现方式，如 monitor 可以与对象一起创建销毁或当线程试图获取对象锁时自动生<br>成，但当一个 monitor 被某个线程持有后，它便处于锁定状态。</p>
<p>当线程访问同步代码块时，首先会进入_EntryList，当线程获取锁标记后，monitor 中的_Owner 记录此线程，并在 monitor 中的计数器执行递增计算（+1）代表锁定，其他线程在_EntryList 中继续阻塞。若执行线程调用 wait 方法，则 monitor 中的计数器执行赋值为 0 计算，并将_Owner 标记赋值为 null，代表放弃锁，执行线程进如_WaitSet 中阻塞。若执行线程调用 notify/notifyAll 方法，_WaitSet 中的线程被唤醒，进入_EntryList 中阻塞，等待获取锁标记。若执行线程的同步代码执行结束，同样会释放锁标记，monitor 中的_Owner标记赋值为 null，且计数器赋值为 0 计算。</p>
<h2 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h2><p>synchronized 的锁对象包括： this， 临界资源对象，Class 类对象</p>
<p>this对象：</p>
<pre><code>synchronized(this)和synchronized方法都是锁当前对象。</code></pre><p>临界资源对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Object o = <span class="keyword">new</span> Object();</span><br><span class="line"><span class="keyword">synchronized</span>(o)&#123;  ...        &#125;</span><br></pre></td></tr></table></figure>
<p>Class类对象：   public static synchronized void testSync4(){}    或  synchronized(Test_02.class){}</p>
<p>synchronized 加锁的目的就是为了保证操作的原子性。</p>
<p>同步方法：synchronized T methodName(){}</p>
<pre><code>同步方法锁定的是当前对象。当多线程通过同一个对象引用多次调用当前同步方法时，需同步执行。
同步方法只影响锁定同一个锁对象的同步方法。不影响其他线程调用非同步方法，或调用其他锁资源的同步方法。
同步方法只影响锁定同一个锁对象的同步方法。不影响其他线程调用非同步方法，或调用其他锁资源的同步方法。
同步方法只能保证当前方法的原子性，不能保证多个业务方法之间的互相访问的原子性。
同一个线程，多次调用同步代码，锁定同一个锁对象，可重入。
子类同步方法覆盖父类同步方法。可以指定调用父类的同步方法。
当同步方法中发生异常的时候，自动释放锁资源。不会影响其他线程的执行。如果异常需要对业务数据处理。</code></pre><p>同步代码块：同步代码块的同步粒度更加细致，是商业开发中推荐的编程方式。可以定位到具体的同步位置，而不是简单的将方法整体实现同步逻辑。在效率上，相对更高。</p>
<h2 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h2><p>变量的线程可见性。</p>
<p>在 CPU 计算过程中，会将计算过程需要的数据加载到 CPU 计算缓存中，当 CPU 计算中断时，有可能刷新缓存，重新读取内存中的数据。</p>
<p>在线程运行的过程中，如果某变量被其他线程修改，可能造成数据不一致的情况，从而导致结果错误。而 volatile修饰的变量是线程可见的，</p>
<p>当 JVM 解释 volatile 修饰的变量时，会通知 CPU，在计算过程中，每次使用变量参与计算时，都会检查内存中的数据是否发生变化，而不是一直使用 CPU 缓存中的数据，可以保证计算结果的正确。</p>
<p>volatile 只是通知底层计算时，CPU 检查内存数据，而不是让一个变量在多个线程中同步。</p>
<p>volatile只能保证可见性，不能保证原子性。</p>
<p>基础类型除了float和double之外，默认具有可见性。java.util.concurrent.atomic.AtomicXXX类都是具有原子性的。</p>
<pre><code>1. 基本类型: AtomicInteger, AtomicLong, AtomicBoolean ;
2. 数组类型: AtomicIntegerArray, AtomicLongArray, AtomicReferenceArray ;
3. 引用类型: AtomicReference, AtomicStampedRerence, AtomicMarkableReference ;
4. 对象的属性修改类型: AtomicIntegerFieldUpdater, AtomicLongFieldUpdater, AtomicReferenceFieldUpdater 。</code></pre><p>这些类存在的目的是对相应的数据进行原子操作。所谓原子操作，是指操作过程不会被中断，保证数据操作是以原子方式进行的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test_01</span> </span>&#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">               <span class="keyword">final</span> Test_01_Container t = <span class="keyword">new</span> Test_01_Container();</span><br><span class="line">               <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                       <span class="meta">@Override</span></span><br><span class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                               <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)&#123;</span><br><span class="line">                                       System.out.println(<span class="string">"add Object to Container "</span> + i);</span><br><span class="line">                                       t.add(<span class="keyword">new</span> Object());</span><br><span class="line">                                       <span class="keyword">try</span> &#123;</span><br><span class="line">                                               TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                                       &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                                               e.printStackTrace();</span><br><span class="line">                                       &#125;</span><br><span class="line">                               &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;).start();</span><br><span class="line">               </span><br><span class="line">               <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable()&#123;</span><br><span class="line">                       <span class="meta">@Override</span></span><br><span class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                               <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">                                       <span class="keyword">if</span>(t.size() == <span class="number">5</span>)&#123;</span><br><span class="line">                                               System.out.println(<span class="string">"size = 5"</span>);</span><br><span class="line">                                               <span class="keyword">break</span>;</span><br><span class="line">                                       &#125;</span><br><span class="line">                               &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;).start();</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test_01_Container</span></span>&#123;</span><br><span class="line">       <span class="keyword">volatile</span> List&lt;Object&gt; container = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">       </span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Object o)</span></span>&#123;</span><br><span class="line">               <span class="keyword">this</span>.container.add(o);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span>&#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">this</span>.container.size();</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">add Object to Container 0</span><br><span class="line">add Object to Container 1</span><br><span class="line">add Object to Container 2</span><br><span class="line">add Object to Container 3</span><br><span class="line">add Object to Container 4</span><br><span class="line">size &#x3D; 5</span><br><span class="line">add Object to Container 5</span><br><span class="line">add Object to Container 6</span><br><span class="line">add Object to Container 7</span><br><span class="line">add Object to Container 8</span><br><span class="line">add Object to Container 9</span><br></pre></td></tr></table></figure>
<p>如果不设置container的可见性，另外一个进程就一直循环下去。</p>
<h2 id="wait-amp-notify"><a href="#wait-amp-notify" class="headerlink" title="wait&amp;notify"></a>wait&amp;notify</h2><p>在Object.java中，定义了wait(), notify()和notifyAll()等方法。wait()的作用是让当前线程进入等待状态，同时，wait()也会让当前线程释放它所持有的锁。而notify()和notifyAll()的作用，则是唤醒当前对象上的等待线程；notify()是唤醒单个线程，而notifyAll()是唤醒所有的线程。</p>
<p>Object类中关于等待/唤醒的API详细信息如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">notify()            唤醒在此对象监视器上等待的单个线程。</span><br><span class="line">notifyAll()        唤醒在此对象监视器上等待的所有线程。</span><br><span class="line">wait()                  让当前线程处于&quot;等待(阻塞)状态&quot;，&quot;直到其他线程调用此对象的 notify() 方法或 notifyAll() 方法&quot;，当前线程被唤醒(进入&quot;就绪状态&quot;)。</span><br><span class="line">wait(long timeout)         让当前线程处于&quot;等待(阻塞)状态&quot;，&quot;直到其他线程调用此对象的 notify() 方法或 notifyAll() 方法，或者超过指定的时间量&quot;，当前线程被唤醒(进入&quot;就绪状态&quot;)。</span><br><span class="line">wait(long timeout, int nanos)        让当前线程处于&quot;等待(阻塞)状态&quot;，&quot;直到其他线程调用此对象的 notify() 方法或 notifyAll() 方法，或者其他某个线程中断当前线程，或者已超过某个实际时间量&quot;，当前线程被唤醒(进入&quot;就绪状态&quot;)。</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test_02</span> </span>&#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">               <span class="keyword">final</span> Test_02_Container t = <span class="keyword">new</span> Test_02_Container();</span><br><span class="line">               <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</span><br><span class="line">               </span><br><span class="line">               <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable()&#123;</span><br><span class="line">                       <span class="meta">@Override</span></span><br><span class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                               <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                                       <span class="keyword">if</span>(t.size() != <span class="number">5</span>)&#123;</span><br><span class="line">                                               <span class="keyword">try</span> &#123;</span><br><span class="line">                                                       lock.wait(); <span class="comment">// 线程进入等待队列。</span></span><br><span class="line">                                               &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                                                       e.printStackTrace();</span><br><span class="line">                                               &#125;</span><br><span class="line">                                       &#125;</span><br><span class="line">                                       System.out.println(<span class="string">"size = 5"</span>);</span><br><span class="line">                                       lock.notifyAll(); <span class="comment">// 唤醒其他等待线程</span></span><br><span class="line">                               &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;).start();</span><br><span class="line">               </span><br><span class="line">               <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                       <span class="meta">@Override</span></span><br><span class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                               <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                                       <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)&#123;</span><br><span class="line">                                               System.out.println(<span class="string">"add Object to Container "</span> + i);</span><br><span class="line">                                               t.add(<span class="keyword">new</span> Object());</span><br><span class="line">                                               <span class="keyword">if</span>(t.size() == <span class="number">5</span>)&#123;</span><br><span class="line">                                                       lock.notifyAll();</span><br><span class="line">                                                       <span class="keyword">try</span> &#123;</span><br><span class="line">                                                               lock.wait();</span><br><span class="line">                                                       &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                                                               e.printStackTrace();</span><br><span class="line">                                                       &#125;</span><br><span class="line">                                               &#125;</span><br><span class="line">                                               <span class="keyword">try</span> &#123;</span><br><span class="line">                                                       TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                                               &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                                                       e.printStackTrace();</span><br><span class="line">                                               &#125;</span><br><span class="line">                                       &#125;</span><br><span class="line">                               &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;).start();</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test_02_Container</span></span>&#123;</span><br><span class="line">       List&lt;Object&gt; container = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">       </span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Object o)</span></span>&#123;</span><br><span class="line">               <span class="keyword">this</span>.container.add(o);</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span>&#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">this</span>.container.size();</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line">add Object to Container <span class="number">0</span></span><br><span class="line">add Object to Container <span class="number">1</span></span><br><span class="line">add Object to Container <span class="number">2</span></span><br><span class="line">add Object to Container <span class="number">3</span></span><br><span class="line">add Object to Container <span class="number">4</span></span><br><span class="line">size = <span class="number">5</span></span><br><span class="line">add Object to Container <span class="number">5</span></span><br><span class="line">add Object to Container <span class="number">6</span></span><br><span class="line">add Object to Container <span class="number">7</span></span><br><span class="line">add Object to Container <span class="number">8</span></span><br><span class="line">add Object to Container <span class="number">9</span></span><br></pre></td></tr></table></figure>
<h2 id="yield"><a href="#yield" class="headerlink" title="yield"></a>yield</h2><p>yield()的作用是让步。它能让当前线程由”运行状态”进入到”就绪状态”，从而让其它具有相同优先级的等待线程获取执行权；但是，并不能保证在当前线程调用yield()之后，其它具有相同优先级的线程就一定能获得执行权；也有可能是当前线程又进入到”运行状态”继续运行！</p>
<p><strong>yield() 与 wait()的比较</strong></p>
<p>wait()的作用是让当前线程由”运行状态”进入”等待(阻塞)状态”的同时，也会释放同步锁。而yield()的作用是让步，它也会让当前线程离开”运行状态”。它们的区别是：</p>
<pre><code>(1) wait()是让线程由&quot;运行状态&quot;进入到&quot;等待(阻塞)状态&quot;，而不yield()是让线程由&quot;运行状态&quot;进入到&quot;就绪状态&quot;。
(2) wait()是会线程释放它所持有对象的同步锁，而yield()方法不会释放锁。</code></pre><h2 id="sleep"><a href="#sleep" class="headerlink" title="sleep"></a>sleep</h2><p>sleep() 定义在Thread.java中。</p>
<p>sleep() 的作用是让当前线程休眠，即当前线程会从”运行状态”进入到”休眠(阻塞)状态”。sleep()会指定休眠时间，线程休眠的时间会大于/等于该休眠时间；在线程重新被唤醒时，它会由”阻塞状态”变成”就绪状态”，从而等待cpu的调度执行。</p>
<p><strong>sleep() 与 wait()的比较</strong></p>
<p>wait()的作用是让当前线程由”运行状态”进入”等待(阻塞)状态”的同时，也会释放同步锁。而sleep()的作用是也是让当前线程由”运行状态”进入到”休眠(阻塞)状态”。但是，wait()会释放对象的同步锁，而sleep()则不会释放锁。</p>
<h2 id="join"><a href="#join" class="headerlink" title="join"></a>join</h2><p>join() 定义在Thread.java中。</p>
<p>join() 的作用：让”主线程”等待”子线程”结束之后才能继续运行。</p>
<h2 id="终止线程"><a href="#终止线程" class="headerlink" title="终止线程"></a>终止线程</h2><p>interrupt()的作用是中断本线程</p>
<p>本线程中断自己是被允许的；其它线程调用本线程的interrupt()方法时，会通过checkAccess()检查权限。这有可能抛出SecurityException异常。</p>
<p>如果本线程是处于阻塞状态：调用线程的wait(), wait(long)或wait(long, int)会让它进入等待(阻塞)状态，或者调用线程的join(), join(long), join(long, int), sleep(long), sleep(long, int)也会让它进入阻塞状态。</p>
<p>若线程在阻塞状态时，调用了它的interrupt()方法，那么它的”中断状态”会被清除并且会收到一个InterruptedException异常。例如，线程通过wait()进入阻塞状态，此时通过interrupt()中断该线程；调用interrupt()会立即将线程的中断标记设为”true”，但是由于线程处于阻塞状态，所以该”中断标记”会立即被清除为”false”，同时，会产生一个InterruptedException的异常。</p>
<p>如果线程被阻塞在一个Selector选择器中，那么通过interrupt()中断它时；线程的中断标记会被设置为true，并且它会立即从选择操作中返回。</p>
<p>如果不属于前面所说的情况，那么通过interrupt()中断线程时，它的中断标记会被设置为”true”。中断一个”已终止的线程”不会产生任何操作。</p>
<p><strong>Thread中的stop()和suspend()方法，由于固有的不安全性，已经建议不再使用！</strong></p>
<p>终止处于”阻塞状态”的线程： 在while(true)中不断的执行任务，当线程处于阻塞状态时，调用线程的interrupt()产生InterruptedException中断。中断的捕获在while(true)之外，这样就退出了while(true)循环！</p>
<p>注意：对InterruptedException的捕获务一般放在while(true)循环体的外面，这样，在产生异常时就退出了while(true)循环。否则，InterruptedException在while(true)循环体之内，就需要额外的添加退出处理。</p>
<p><strong>终止处于”运行状态”的线程</strong></p>
<h3 id="通过”中断标记”终止线程。"><a href="#通过”中断标记”终止线程。" class="headerlink" title="通过”中断标记”终止线程。"></a>通过”中断标记”终止线程。</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">while</span> (!isInterrupted()) &#123;</span><br><span class="line">       <span class="comment">// 执行任务...</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>isInterrupted()是判断线程的中断标记是不是为true。当线程处于运行状态，并且我们需要终止它时；可以调用线程的interrupt()方法，使用线程的中断标记为true，即isInterrupted()会返回true。此时，就会退出while循环。</p>
<p>注意：interrupt()并不会终止处于”运行状态”的线程！它会将线程的中断标记设为true。</p>
<h3 id="通过”额外添加标记”。"><a href="#通过”额外添加标记”。" class="headerlink" title="通过”额外添加标记”。"></a>通过”额外添加标记”。</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> flag= <span class="keyword">true</span>;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">stopTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   flag = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">while</span> (flag) &#123;</span><br><span class="line">       <span class="comment">// 执行任务...</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>线程中有一个flag标记，它的默认值是true；并且我们提供stopTask()来设置flag标记。当我们需要终止该线程时，调用该线程的stopTask()方法就可以让线程退出while循环。</p>
<p>注意：将flag定义为volatile类型，是为了保证flag的可见性。即其它线程通过stopTask()修改了flag之后，本线程能看到修改后的flag的值。</p>
<p>interrupted() 和 isInterrupted()都能够用于检测对象的”中断标记”。</p>
<p>区别是，interrupted()除了返回中断标记之外，它还会清除中断标记(即将中断标记设为false)；而isInterrupted()仅仅返回中断标记。</p>
<h2 id="优先级和守护线程"><a href="#优先级和守护线程" class="headerlink" title="优先级和守护线程"></a>优先级和守护线程</h2><p>每个线程都有一个优先级。”高优先级线程”会优先于”低优先级线程”执行。每个线程都可以被标记为一个守护进程或非守护进程。在一些运行的主线程中创建新的子线程时，子线程的优先级被设置为等于”创建它的主线程的优先级”，当且仅当”创建它的主线程是守护线程”时”子线程才会是守护线程”。</p>
<p>当Java虚拟机启动时，通常有一个单一的非守护线程（该线程通过是通过main()方法启动）。JVM会一直运行直到下面的任意一个条件发生，JVM就会终止运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(01) 调用了exit()方法，并且exit()有权限被正常执行。</span><br><span class="line">(02) 所有的&quot;非守护线程&quot;都死了(即JVM中仅仅只有&quot;守护线程&quot;)。</span><br></pre></td></tr></table></figure>
<p>每一个线程都被标记为”守护线程”或”用户线程”。当只有守护线程运行时，JVM会自动退出。</p>
<h2 id="生产消费者问题"><a href="#生产消费者问题" class="headerlink" title="生产消费者问题"></a>生产消费者问题</h2><p>生产/消费者问题是个非常典型的多线程问题，涉及到的对象包括”生产者”、”消费者”、”仓库”和”产品”。他们之间的关系如下：</p>
<pre><code>(01) 生产者仅仅在仓储未满时候生产，仓满则停止生产。
(02) 消费者仅仅在仓储有产品时候才能消费，仓空则等待。
(03) 当消费者发现仓储没产品可消费时候会通知生产者生产。
(04) 生产者在生产出可消费产品时候，应该通知等待的消费者去消费。</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestContainer01</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">final</span> LinkedList&lt;E&gt; list = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX = <span class="number">6</span>;<span class="comment">//最大数量</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">int</span> count = <span class="number">0</span>;<span class="comment">//已有数量</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(E e)</span></span>&#123;<span class="comment">//生产</span></span><br><span class="line">               <span class="keyword">while</span>(list.size() == MAX)&#123;</span><br><span class="line">                       <span class="keyword">try</span> &#123;</span><br><span class="line">                               <span class="keyword">this</span>.wait();</span><br><span class="line">                       &#125; <span class="keyword">catch</span> (InterruptedException e1) &#123;</span><br><span class="line">                               e1.printStackTrace();</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               </span><br><span class="line">               list.add(e);</span><br><span class="line">               System.out.println(<span class="string">"已生产"</span>+e);</span><br><span class="line">               count++;</span><br><span class="line">               <span class="keyword">this</span>.notifyAll();</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> E <span class="title">get</span><span class="params">()</span></span>&#123;<span class="comment">//消费</span></span><br><span class="line">               E e = <span class="keyword">null</span>;</span><br><span class="line">               <span class="keyword">while</span>(list.size() == <span class="number">0</span>)&#123;</span><br><span class="line">                       <span class="keyword">try</span>&#123;</span><br><span class="line">                               <span class="keyword">this</span>.wait();</span><br><span class="line">                       &#125; <span class="keyword">catch</span> (InterruptedException e1) &#123;</span><br><span class="line">                               e1.printStackTrace();</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               e = list.removeFirst();</span><br><span class="line">               count--;</span><br><span class="line">               System.out.println(<span class="string">"已消费"</span>+e);</span><br><span class="line">               <span class="keyword">this</span>.notifyAll();</span><br><span class="line">               <span class="keyword">return</span> e;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">               <span class="keyword">final</span> TestContainer01&lt;String&gt; c = <span class="keyword">new</span> TestContainer01&lt;&gt;();</span><br><span class="line">               <span class="keyword">int</span> num = <span class="number">10</span>;<span class="comment">//需要消费的数量</span></span><br><span class="line">               <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                       <span class="meta">@Override</span></span><br><span class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">                                       System.out.println(<span class="string">"消费者获得--"</span>+c.get());</span><br><span class="line">                               &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;, <span class="string">"consumer"</span>).start();</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                       TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                       <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">                       e.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                       <span class="meta">@Override</span></span><br><span class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">                                       c.put(<span class="string">"container value "</span>+i);</span><br><span class="line">                               &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;, <span class="string">"producer"</span>).start();</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>面向对象写法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">               Container&lt;Object&gt; container = <span class="keyword">new</span> Container&lt;&gt;();</span><br><span class="line">               Producer producer = <span class="keyword">new</span> Producer(container);</span><br><span class="line">               Customer customer = <span class="keyword">new</span> Customer(container);</span><br><span class="line">               producer.produce();<span class="comment">// 启动生产</span></span><br><span class="line">               <span class="comment">// 需要消费多少</span></span><br><span class="line">               customer.consume(<span class="number">2</span>);</span><br><span class="line">               Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">               customer.consume(<span class="number">3</span>);</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生产者</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line">       <span class="keyword">private</span> Container&lt;Object&gt; container;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">Producer</span><span class="params">(Container&lt;Object&gt; container)</span> </span>&#123;</span><br><span class="line">               <span class="keyword">this</span>.container = container;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 生产产品：新建一个线程向仓库中生产产品。</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produce</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                               <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                                       <span class="comment">// 生产线程生产东西</span></span><br><span class="line">                                       container.put(<span class="string">"produce----"</span> + <span class="keyword">new</span> Random().nextInt(<span class="number">100</span>));</span><br><span class="line">                               &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;.start();</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费者</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Customer</span> </span>&#123;</span><br><span class="line">       <span class="keyword">private</span> Container&lt;Object&gt; container;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">Customer</span><span class="params">(Container&lt;Object&gt; container)</span> </span>&#123;</span><br><span class="line">               <span class="keyword">this</span>.container = container;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 消费产品：新建一个线程从仓库中消费产品</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consume</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;<span class="comment">// 消费数量</span></span><br><span class="line">               <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                               <span class="keyword">int</span> c = count;</span><br><span class="line">                               <span class="keyword">while</span> (c &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                       container.get();</span><br><span class="line">                                       c--;</span><br><span class="line">                               &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;.start();</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 仓库</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Container</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">       <span class="keyword">private</span> LinkedList&lt;E&gt; list = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX = <span class="number">6</span>;<span class="comment">// 最大数量</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">int</span> count = <span class="number">0</span>;<span class="comment">// 已有数量</span></span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               <span class="keyword">return</span> count;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(E e)</span> </span>&#123;<span class="comment">// 生产</span></span><br><span class="line">               <span class="keyword">while</span> (list.size() == MAX) &#123;</span><br><span class="line">                       <span class="keyword">try</span> &#123;</span><br><span class="line">                               <span class="keyword">this</span>.wait();</span><br><span class="line">                       &#125; <span class="keyword">catch</span> (InterruptedException e1) &#123;</span><br><span class="line">                               e1.printStackTrace();</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               list.add(e);</span><br><span class="line">               System.out.println(<span class="string">"已生产"</span> + e);</span><br><span class="line">               count++;</span><br><span class="line">               <span class="keyword">this</span>.notifyAll();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> E <span class="title">get</span><span class="params">()</span> </span>&#123;<span class="comment">// 消费</span></span><br><span class="line">               E e = <span class="keyword">null</span>;</span><br><span class="line">               <span class="keyword">while</span> (list.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                       <span class="keyword">try</span> &#123;</span><br><span class="line">                               <span class="keyword">this</span>.wait();</span><br><span class="line">                       &#125; <span class="keyword">catch</span> (InterruptedException e1) &#123;</span><br><span class="line">                               e1.printStackTrace();</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               e = list.removeFirst();</span><br><span class="line">               count--;</span><br><span class="line">               System.out.println(<span class="string">"已消费"</span> + e);</span><br><span class="line">               <span class="keyword">this</span>.notifyAll();</span><br><span class="line">               <span class="keyword">return</span> e;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="concurrent包锁"><a href="#concurrent包锁" class="headerlink" title="concurrent包锁"></a>concurrent包锁</h2><h3 id="同步锁"><a href="#同步锁" class="headerlink" title="同步锁"></a>同步锁</h3><p>即通过synchronized关键字来进行同步，实现对竞争资源的互斥访问的锁。Java 1.0版本中就已经支持同步锁了。</p>
<p>同步锁的原理是，对于每一个对象，有且仅有一个同步锁；不同的线程能共同访问该同步锁。但是，在同一个时间点，该同步锁能且只能被一个线程获取到。这样，获取到同步锁的线程就能进行CPU调度，从而在CPU上执行；而没有获取到同步锁的线程，必须进行等待，直到获取到同步锁之后才能继续运行。这就是，多线程通过同步锁进行同步的原理！</p>
<h3 id="java-util-concurrent中的锁"><a href="#java-util-concurrent中的锁" class="headerlink" title="java.util.concurrent中的锁"></a>java.util.concurrent中的锁</h3><p> 相比同步锁，java.util.concurrent包中的锁的功能更加强大，它为锁提供了一个框架，该框架允许更灵活地使用锁，只是它的用法更难罢了。</p>
<p>包括：Lock接口，ReadWriteLock接口，LockSupport阻塞原语，Condition条件，AbstractOwnableSynchronizer/AbstractQueuedSynchronizer/AbstractQueuedLongSynchronizer三个抽象类，ReentrantLock独占锁，ReentrantReadWriteLock读写锁。由于CountDownLatch，CyclicBarrier和Semaphore也是通过AQS来实现的。</p>
<p><img src="https://img.huyunshun.com/img/20200414093915.png" alt="20200414093915"></p>
<h4 id="1-Lock接口"><a href="#1-Lock接口" class="headerlink" title="1. Lock接口"></a>1. Lock接口</h4><p>Lock 接口支持那些语义不同(重入、公平等)的锁规则。所谓语义不同，是指锁可是有”公平机制的锁”、”非公平机制的锁”、”可重入的锁”等等。”公平机制”是指”不同线程获取锁的机制是公平的”，而”非公平机制”则是指”不同线程获取锁的机制是非公平的”，”可重入的锁”是指同一个锁能够被一个线程多次获取。</p>
<h4 id="2-ReadWriteLock"><a href="#2-ReadWriteLock" class="headerlink" title="2. ReadWriteLock"></a>2. ReadWriteLock</h4><p>ReadWriteLock 接口以和Lock类似的方式定义了一些读取者可以共享而写入者独占的锁。JUC包只有一个类实现了该接口，即 ReentrantReadWriteLock，因为它适用于大部分的标准用法上下文。但程序员可以创建自己的、适用于非标准要求的实现。</p>
<h4 id="3-AbstractOwnableSynchronizer-AbstractQueuedSynchronizer-AbstractQueuedLongSynchronizer"><a href="#3-AbstractOwnableSynchronizer-AbstractQueuedSynchronizer-AbstractQueuedLongSynchronizer" class="headerlink" title="3. AbstractOwnableSynchronizer/AbstractQueuedSynchronizer/AbstractQueuedLongSynchronizer"></a>3. AbstractOwnableSynchronizer/AbstractQueuedSynchronizer/AbstractQueuedLongSynchronizer</h4><p>AbstractQueuedSynchronizer就是被称之为AQS的类，它是一个非常有用的超类，可用来定义锁以及依赖于排队阻塞线程的其他同步器；ReentrantLock，ReentrantReadWriteLock，CountDownLatch，CyclicBarrier和Semaphore等这些类都是基于AQS类实现的。AbstractQueuedLongSynchronizer 类提供相同的功能但扩展了对同步状态的 64 位的支持。两者都扩展了类 AbstractOwnableSynchronizer（一个帮助记录当前保持独占同步的线程的简单类）。</p>
<h4 id="4-LockSupport"><a href="#4-LockSupport" class="headerlink" title="4. LockSupport"></a>4. LockSupport</h4><p>LockSupport提供”创建锁”和”其他同步类的基本线程阻塞原语”。</p>
<p>LockSupport的功能和”Thread中的Thread.suspend()和Thread.resume()有点类似”，LockSupport中的park() 和 unpark() 的作用分别是阻塞线程和解除阻塞线程。但是park()和unpark()不会遇到”Thread.suspend 和 Thread.resume所可能引发的死锁”问题。</p>
<h4 id="5、Condition"><a href="#5、Condition" class="headerlink" title="5、Condition"></a>5、Condition</h4><p>Condition需要和Lock联合使用，它的作用是代替Object监视器方法，可以通过await(),signal()来休眠/唤醒线程。<br>Condition 接口描述了可能会与锁有关联的条件变量。这些变量在用法上与使用 Object.wait 访问的隐式监视器类似，但提供了更强大的功能。需要特别指出的是，单个 Lock 可能与多个 Condition 对象关联。为了避免兼容性问题，Condition 方法的名称与对应的 Object 版本中的不同。</p>
<h4 id="6-ReentrantLock"><a href="#6-ReentrantLock" class="headerlink" title="6. ReentrantLock"></a>6. ReentrantLock</h4><p>ReentrantLock是独占锁。所谓独占锁，是指只能被独自占领，即同一个时间点只能被一个线程锁获取到的锁。ReentrantLock锁包括”公平的ReentrantLock”和”非公平的ReentrantLock”。”公平的ReentrantLock”是指”不同线程获取锁的机制是公平的”，而”非公平的　　ReentrantLock”则是指”不同线程获取锁的机制是非公平的”，ReentrantLock是”可重入的锁”。</p>
<p>　　(01) ReentrantLock实现了Lock接口。<br>　　(02) ReentrantLock中有一个成员变量sync，sync是Sync类型；Sync是一个抽象类，而且它继承于AQS。<br>　　(03) ReentrantLock中有”公平锁类”FairSync和”非公平锁类”NonfairSync，它们都是Sync的子类。ReentrantReadWriteLock中sync对象，是FairSync与NonfairSync中的一种，这也意味着ReentrantLock是”公平锁”或”非公平锁”中的一种，ReentrantLock默认是非公平锁。</p>
<h4 id="7-ReentrantReadWriteLock"><a href="#7-ReentrantReadWriteLock" class="headerlink" title="7. ReentrantReadWriteLock"></a>7. ReentrantReadWriteLock</h4><p>ReentrantReadWriteLock是读写锁接口ReadWriteLock的实现类，它包括子类ReadLock和WriteLock。ReentrantLock是共享锁，而WriteLock是独占锁。</p>
<p>　　(01) ReentrantReadWriteLock实现了ReadWriteLock接口。<br>　　(02) ReentrantReadWriteLock中包含sync对象，读锁readerLock和写锁writerLock。读锁ReadLock和写锁WriteLock都实现了Lock接口。<br>　　(03) 和”ReentrantLock”一样，sync是Sync类型；而且，Sync也是一个继承于AQS的抽象类。Sync也包括”公平锁”FairSync和”非公平锁”NonfairSync。</p>
<h4 id="8-CountDownLatch"><a href="#8-CountDownLatch" class="headerlink" title="8. CountDownLatch"></a>8. CountDownLatch</h4><p>　　CountDownLatch是一个同步辅助类，在完成一组正在其他线程中执行的操作之前，它允许一个或多个线程一直等待。<br>　   CountDownLatch包含了sync对象，sync是Sync类型。CountDownLatch的Sync是实例类，它继承于AQS。</p>
<h4 id="9-CyclicBarrier"><a href="#9-CyclicBarrier" class="headerlink" title="9. CyclicBarrier"></a>9. CyclicBarrier</h4><p>CyclicBarrier是一个同步辅助类，允许一组线程互相等待，直到到达某个公共屏障点 (common barrier point)。因为该 barrier 在释放等待线程后可以重用，所以称它为循环 的 barrier。</p>
<p>CyclicBarrier是包含了”ReentrantLock对象lock”和”Condition对象trip”，它是通过独占锁实现的。</p>
<p>　　CyclicBarrier和CountDownLatch的区别是：<br>　　(01) CountDownLatch的作用是允许1或N个线程等待其他线程完成执行；而CyclicBarrier则是允许N个线程相互等待。<br>　　(02) CountDownLatch的计数器无法被重置；CyclicBarrier的计数器可以被重置后使用，因此它被称为是循环的barrier。</p>
<h4 id="10-Semaphore"><a href="#10-Semaphore" class="headerlink" title="10. Semaphore"></a>10. Semaphore</h4><p>Semaphore是一个计数信号量，它的本质是一个”共享锁”。</p>
<p>信号量维护了一个信号量许可集。线程可以通过调用acquire()来获取信号量的许可；当信号量中有可用的许可时，线程能获取该许可；否则线程必须等待，直到有可用的许可为止。 线程可以通过release()来释放它所持有的信号量许可。</p>
<p>和”ReentrantLock”一样，Semaphore包含了sync对象，sync是Sync类型；而且，Sync也是一个继承于AQS的抽象类。Sync也包括”公平信号量”FairSync和”非公平信号量”NonfairSync。</p>
<h2 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h2><p>ReentrantLock是一个可重入的互斥锁，又被称为”独占锁”。</p>
<p> 顾名思义，ReentrantLock锁在同一个时间点只能被一个线程锁持有；而可重入的意思是，ReentrantLock锁，可以被单个线程多次获取。</p>
<p>ReentrantLock分为”公平锁”和”非公平锁”。它们的区别体现在获取锁的机制上是否公平。”锁”是为了保护竞争资源，防止多个线程同时操作线程而出错，ReentrantLock在同一个时间点只能被一个线程获取(当某线程获取到”锁”时，其它线程就必须等待)；ReentraantLock是通过一个FIFO的等待队列来管理获取该锁所有线程的。在”公平锁”的机制下，线程依次排队获取锁；而”非公平锁”在锁是可获取状态时，不管自己是不是在队列的开头都会获取锁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个 ReentrantLock ，默认是"非公平锁"。</span></span><br><span class="line">ReentrantLock()</span><br><span class="line"><span class="comment">// 创建策略是fair的 ReentrantLock。fair为true表示是公平锁，fair为false表示是非公平锁。</span></span><br><span class="line">ReentrantLock(<span class="keyword">boolean</span> fair)</span><br><span class="line"><span class="comment">// 查询当前线程保持此锁的次数。</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getHoldCount</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 返回目前拥有此锁的线程，如果此锁不被任何线程拥有，则返回 null。</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Thread <span class="title">getOwner</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 返回一个 collection，它包含可能正等待获取此锁的线程。</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Collection&lt;Thread&gt; <span class="title">getQueuedThreads</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 返回正等待获取此锁的线程估计数。</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getQueueLength</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 返回一个 collection，它包含可能正在等待与此锁相关给定条件的那些线程。</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Collection&lt;Thread&gt; <span class="title">getWaitingThreads</span><span class="params">(Condition condition)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 返回等待与此锁相关的给定条件的线程估计数。</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getWaitQueueLength</span><span class="params">(Condition condition)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 查询给定线程是否正在等待获取此锁。</span></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">hasQueuedThread</span><span class="params">(Thread thread)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 查询是否有些线程正在等待获取此锁。</span></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">hasQueuedThreads</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 查询是否有些线程正在等待与此锁有关的给定条件。</span></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">hasWaiters</span><span class="params">(Condition condition)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 如果是"公平锁"返回true，否则返回false。</span></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isFair</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 查询当前线程是否保持此锁。</span></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isHeldByCurrentThread</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 查询此锁是否由任意线程保持。</span></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isLocked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 获取锁。</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 如果当前线程未被中断，则获取锁。</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lockInterruptibly</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 返回用来与此 Lock 实例一起使用的 Condition 实例。</span></span></span><br><span class="line"><span class="function">Condition <span class="title">newCondition</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 仅在调用时锁未被另一个线程保持的情况下，才获取该锁。</span></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 如果锁在给定等待时间内没有被另一个线程保持，且当前线程未被中断，则获取该锁。</span></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 试图释放此锁。</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<p>实例：生产者消费者问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">               Container&lt;Object&gt; container = <span class="keyword">new</span> Container&lt;&gt;();</span><br><span class="line">               Producer producer = <span class="keyword">new</span> Producer(container);</span><br><span class="line">               Customer customer = <span class="keyword">new</span> Customer(container);</span><br><span class="line">               producer.produce();<span class="comment">// 启动生产</span></span><br><span class="line">               <span class="comment">// 需要消费多少</span></span><br><span class="line">               customer.consume(<span class="number">10</span>);</span><br><span class="line">               Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">               System.out.println(<span class="string">"-----------"</span>);</span><br><span class="line">               customer.consume(<span class="number">10</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 生产者</span></span><br><span class="line">       <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line">               <span class="keyword">private</span> Container&lt;Object&gt; container;</span><br><span class="line"></span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="title">Producer</span><span class="params">(Container&lt;Object&gt; container)</span> </span>&#123;</span><br><span class="line">                       <span class="keyword">this</span>.container = container;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// 生产产品：新建一个线程向仓库中生产产品。</span></span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produce</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                       <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">                               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                       <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                                               <span class="comment">// 生产线程生产东西</span></span><br><span class="line">                                               container.put(<span class="string">"produce----"</span> + <span class="keyword">new</span> Random().nextInt(<span class="number">100</span>));</span><br><span class="line">                                       &#125;</span><br><span class="line">                               &#125;</span><br><span class="line">                       &#125;.start();</span><br><span class="line">               &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 消费者</span></span><br><span class="line">       <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer</span> </span>&#123;</span><br><span class="line">               <span class="keyword">private</span> Container&lt;Object&gt; container;</span><br><span class="line"></span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="title">Customer</span><span class="params">(Container&lt;Object&gt; container)</span> </span>&#123;</span><br><span class="line">                       <span class="keyword">this</span>.container = container;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// 消费产品：新建一个线程从仓库中消费产品</span></span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consume</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;<span class="comment">// 消费数量</span></span><br><span class="line">                       <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">                               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                       <span class="keyword">int</span> c = count;</span><br><span class="line">                                       <span class="keyword">while</span> (c &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                               <span class="keyword">if</span> (container.getCount()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">                                                       container.get();</span><br><span class="line">                                                       c--;</span><br><span class="line">                                               &#125;</span><br><span class="line">                                       &#125;</span><br><span class="line">                               &#125;</span><br><span class="line">                       &#125;.start();</span><br><span class="line">               &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 仓库</span></span><br><span class="line">       <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Container</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">               <span class="keyword">private</span> LinkedList&lt;E&gt; list = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">               <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX = <span class="number">6</span>;<span class="comment">// 最大数量</span></span><br><span class="line">               <span class="keyword">private</span> <span class="keyword">int</span> count;<span class="comment">// 已有数量</span></span><br><span class="line">               <span class="keyword">private</span> Lock lock; <span class="comment">// 独占锁</span></span><br><span class="line"></span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                       <span class="keyword">return</span> count;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="title">Container</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                       <span class="keyword">this</span>.count = <span class="number">0</span>;</span><br><span class="line">                       <span class="keyword">this</span>.lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(E e)</span> </span>&#123;<span class="comment">// 生产</span></span><br><span class="line">                       lock.lock();</span><br><span class="line">                       <span class="keyword">try</span> &#123;</span><br><span class="line">                               <span class="keyword">if</span> (list.size()&lt;MAX) &#123;</span><br><span class="line">                                       list.add(e);</span><br><span class="line">                                       System.out.println(<span class="string">"已生产"</span> + e);</span><br><span class="line">                                       count++;</span><br><span class="line">                               &#125;</span><br><span class="line">                       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                               lock.unlock();</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">()</span> </span>&#123;<span class="comment">// 消费</span></span><br><span class="line">                       E e = <span class="keyword">null</span>;</span><br><span class="line">                       lock.lock();</span><br><span class="line">                       <span class="keyword">try</span> &#123;</span><br><span class="line">                               e = list.removeFirst();</span><br><span class="line">                               count--;</span><br><span class="line">                               System.out.println(<span class="string">"已消费"</span> + e);</span><br><span class="line">                       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                               lock.unlock();</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="keyword">return</span> e;</span><br><span class="line">               &#125;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h2><p>Condition是需要和Lock联合使用的：通过Condition中的await()方法，能让线程阻塞[类似于wait()]；通过Condition的signal()方法，能让唤醒线程[类似于notify()]。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">               Container&lt;Object&gt; container = <span class="keyword">new</span> Container&lt;&gt;();</span><br><span class="line">               Producer producer = <span class="keyword">new</span> Producer(container);</span><br><span class="line">               Customer customer = <span class="keyword">new</span> Customer(container);</span><br><span class="line">               producer.produce();<span class="comment">// 启动生产</span></span><br><span class="line">               <span class="comment">// 需要消费多少</span></span><br><span class="line">               customer.consume(<span class="number">10</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 生产者</span></span><br><span class="line">       <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line">               <span class="keyword">private</span> Container&lt;Object&gt; container;</span><br><span class="line">               </span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="title">Producer</span><span class="params">(Container&lt;Object&gt; container)</span> </span>&#123;</span><br><span class="line">                       <span class="keyword">this</span>.container = container;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// 生产产品：新建一个线程向仓库中生产产品。</span></span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produce</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                       <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">                               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                       <span class="keyword">while</span> (container.isPro()) &#123;</span><br><span class="line">                                               <span class="comment">// 生产线程生产东西</span></span><br><span class="line">                                               container.put(<span class="string">"produce----"</span> + <span class="keyword">new</span> Random().nextInt(<span class="number">100</span>));</span><br><span class="line">                                       &#125;</span><br><span class="line">                               &#125;</span><br><span class="line">                       &#125;.start();</span><br><span class="line">               &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 消费者</span></span><br><span class="line">       <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer</span> </span>&#123;</span><br><span class="line">               <span class="keyword">private</span> Container&lt;Object&gt; container;</span><br><span class="line"></span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="title">Customer</span><span class="params">(Container&lt;Object&gt; container)</span> </span>&#123;</span><br><span class="line">                       <span class="keyword">this</span>.container = container;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// 消费产品：新建一个线程从仓库中消费产品</span></span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consume</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;<span class="comment">// 消费数量</span></span><br><span class="line">                       <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">                               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                       <span class="keyword">int</span> c = count;</span><br><span class="line">                                       <span class="keyword">while</span> (c &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                               <span class="keyword">if</span> (container.getCount()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">                                                       container.get();</span><br><span class="line">                                                       c--;</span><br><span class="line">                                               &#125;</span><br><span class="line">                                       &#125;</span><br><span class="line">                                       container.setPro(<span class="keyword">false</span>);</span><br><span class="line">                               &#125;</span><br><span class="line">                       &#125;.start();</span><br><span class="line">               &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 仓库</span></span><br><span class="line">       <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Container</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">               <span class="keyword">private</span> LinkedList&lt;E&gt; list = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">               <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX = <span class="number">6</span>;<span class="comment">// 最大数量</span></span><br><span class="line">               <span class="keyword">private</span> <span class="keyword">int</span> count;<span class="comment">// 已有数量</span></span><br><span class="line">               <span class="keyword">private</span> <span class="keyword">boolean</span> pro;<span class="comment">//是否需要生产</span></span><br><span class="line">               <span class="keyword">private</span> Lock lock; <span class="comment">// 独占锁</span></span><br><span class="line">               <span class="comment">//条件 - Condition， 为Lock增加条件。当条件满足时，做什么事情，如加锁或解锁。如等待或唤醒</span></span><br><span class="line">               <span class="keyword">private</span> Condition fullCondtion;</span><br><span class="line">               <span class="keyword">private</span> Condition emptyCondtion;</span><br><span class="line"></span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                       <span class="keyword">return</span> count;</span><br><span class="line">               &#125;</span><br><span class="line">               </span><br><span class="line"></span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPro</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                       <span class="keyword">return</span> pro;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPro</span><span class="params">(<span class="keyword">boolean</span> pro)</span> </span>&#123;</span><br><span class="line">                       <span class="keyword">this</span>.pro = pro;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="title">Container</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                       <span class="keyword">this</span>.pro = <span class="keyword">true</span>;</span><br><span class="line">                       <span class="keyword">this</span>.count = <span class="number">0</span>;</span><br><span class="line">                       <span class="keyword">this</span>.lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">                       <span class="keyword">this</span>.fullCondtion = lock.newCondition();</span><br><span class="line">                       <span class="keyword">this</span>.emptyCondtion = lock.newCondition();</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(E e)</span> </span>&#123;<span class="comment">// 生产</span></span><br><span class="line">                       lock.lock();</span><br><span class="line">                       <span class="keyword">try</span> &#123;</span><br><span class="line">                               <span class="keyword">while</span> (list.size()==MAX) &#123;<span class="comment">//进入等待状态</span></span><br><span class="line">                                       System.out.println(<span class="string">"等待消费"</span>);</span><br><span class="line">                                       fullCondtion.await();</span><br><span class="line">                               &#125;</span><br><span class="line">                               list.add(e);</span><br><span class="line">                               System.out.println(<span class="string">"已生产"</span> + e);</span><br><span class="line">                               count++;</span><br><span class="line">                               emptyCondtion.signal();<span class="comment">//通知消费者可以消费了</span></span><br><span class="line">                               </span><br><span class="line">                       &#125; <span class="keyword">catch</span> (InterruptedException e1) &#123;</span><br><span class="line">                               e1.printStackTrace();</span><br><span class="line">                       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                               lock.unlock();</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">()</span> </span>&#123;<span class="comment">// 消费</span></span><br><span class="line">                       E e = <span class="keyword">null</span>;</span><br><span class="line">                       lock.lock();</span><br><span class="line">                       <span class="keyword">try</span> &#123;</span><br><span class="line">                               <span class="keyword">while</span> (list.size()==<span class="number">0</span>) &#123;<span class="comment">//进入等待</span></span><br><span class="line">                                       System.out.println(<span class="string">"等待生产"</span>);</span><br><span class="line">                                       emptyCondtion.await();</span><br><span class="line">                               &#125;</span><br><span class="line">                               e = list.removeFirst();</span><br><span class="line">                               count--;</span><br><span class="line">                               System.out.println(<span class="string">"已消费"</span> + e);</span><br><span class="line">                               fullCondtion.signal();</span><br><span class="line">                       &#125; <span class="keyword">catch</span> (InterruptedException e1) &#123;</span><br><span class="line">                               e1.printStackTrace();</span><br><span class="line">                       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                               lock.unlock();</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="keyword">return</span> e;</span><br><span class="line">               &#125;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="公平锁"><a href="#公平锁" class="headerlink" title="公平锁"></a>公平锁</h2><p> CAS(Compare And Swap)，即比较并交换。是解决多线程并行情况下使用锁造成性能损耗的一种机制，CAS操作包含三个操作数–内存位置（V）、预期原值（A）和新值(B)。如果内存位置的值与预期原值相匹配，那么处理器会自动将该位置值更新为新值。否则，处理器不做任何操作。无论哪种情况，它都会在CAS指令之前返回该位置的值。CAS有效地说明了”我认为位置V应该包含值A；如果包含该值，则将B放到这个位置；否则，不要更改该位置，只告诉我这个位置现在的值即可。</p>
<p> AQS(AbstractQueuedSynchronizer)，AQS是JDK下提供的一套用于实现基于FIFO等待队列的阻塞锁和相关的同步器的一个同步框架。这个抽象类被设计为作为一些可用原子int值来表示状态的同步器的基类。如果你有看过类似 CountDownLatch 类的源码实现，会发现其内部有一个继承了 AbstractQueuedSynchronizer 的内部类 Sync。可见 CountDownLatch 是基于AQS框架来实现的一个同步器.类似的同步器在JUC下还有不少。(如：Semaphore)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">lock.lockInterruptibly(); <span class="comment">// 可尝试打断，阻塞等待锁。可以被其他的线程打断阻塞状态</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test_04</span> </span>&#123;</span><br><span class="line">       </span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">               TestReentrantlock t = <span class="keyword">new</span> TestReentrantlock();</span><br><span class="line">               Thread t1 = <span class="keyword">new</span> Thread(t);</span><br><span class="line">               Thread t2 = <span class="keyword">new</span> Thread(t);</span><br><span class="line">               t1.start();</span><br><span class="line">               t2.start();</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestReentrantlock</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">       <span class="comment">// 定义一个公平锁</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">static</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock(<span class="keyword">true</span>);</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">               <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)&#123;</span><br><span class="line">                       lock.lock();</span><br><span class="line">                       <span class="keyword">try</span>&#123;</span><br><span class="line">                               System.out.println(Thread.currentThread().getName() + <span class="string">" get lock"</span>);</span><br><span class="line">                       &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">                               lock.unlock();</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="尝试锁"><a href="#尝试锁" class="headerlink" title="尝试锁"></a>尝试锁</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test_02</span> </span>&#123;</span><br><span class="line">       Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">       </span><br><span class="line">       <span class="function"><span class="keyword">void</span> <span class="title">m1</span><span class="params">()</span></span>&#123;</span><br><span class="line">               <span class="keyword">try</span>&#123;</span><br><span class="line">                       lock.lock();</span><br><span class="line">                       <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)&#123;</span><br><span class="line">                               TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                               System.out.println(<span class="string">"m1() method "</span> + i);</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">                       e.printStackTrace();</span><br><span class="line">               &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">                       lock.unlock();</span><br><span class="line">               &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="function"><span class="keyword">void</span> <span class="title">m2</span><span class="params">()</span></span>&#123;</span><br><span class="line">               <span class="keyword">boolean</span> isLocked = <span class="keyword">false</span>;</span><br><span class="line">               <span class="keyword">try</span>&#123;</span><br><span class="line">                       <span class="comment">// 尝试锁， 如果有锁，无法获取锁标记，返回false;如果获取锁标记，返回true</span></span><br><span class="line">                       <span class="comment">// isLocked = lock.tryLock();</span></span><br><span class="line">                       </span><br><span class="line">                       <span class="comment">// 阻塞尝试锁，阻塞参数代表的时长，尝试获取锁标记。</span></span><br><span class="line">                       <span class="comment">// 如果超时，不等待。直接返回。</span></span><br><span class="line">                       isLocked = lock.tryLock(<span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">                       <span class="keyword">if</span>(isLocked)&#123;</span><br><span class="line">                               System.out.println(<span class="string">"m2() method synchronized"</span>);</span><br><span class="line">                       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                               System.out.println(<span class="string">"m2() method unsynchronized"</span>);</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                       e.printStackTrace();</span><br><span class="line">               &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">                       <span class="keyword">if</span>(isLocked)&#123;</span><br><span class="line">                               <span class="comment">// 尝试锁在解除锁标记的时候，一定要判断是否获取到锁标记。</span></span><br><span class="line">                               <span class="comment">// 如果当前线程没有获取到锁标记，会抛出异常。</span></span><br><span class="line">                               lock.unlock();</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">               <span class="keyword">final</span> Test_02 t = <span class="keyword">new</span> Test_02();</span><br><span class="line">               <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                       <span class="meta">@Override</span></span><br><span class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                               t.m1();</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;).start();</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                       TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                       <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">                       e.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                       <span class="meta">@Override</span></span><br><span class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                               t.m2();</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;).start();</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">m1() method 0</span><br><span class="line">m1() method 1</span><br><span class="line">m1() method 2</span><br><span class="line">m1() method 3</span><br><span class="line">m1() method 4</span><br><span class="line">m2() method unsynchronized</span><br><span class="line">m1() method 5</span><br><span class="line">m1() method 6</span><br><span class="line">m1() method 7</span><br><span class="line">m1() method 8</span><br><span class="line">m1() method 9</span><br></pre></td></tr></table></figure>
<h2 id="非公平锁"><a href="#非公平锁" class="headerlink" title="非公平锁"></a>非公平锁</h2><p>非公平锁和公平锁在获取锁的方法上，流程是一样的；它们的区别主要表现在  尝试获取锁的机制不同。</p>
<p>公平锁在每次尝试获取锁时，都是采用公平策略(根据等待队列依次排序等待)；而非公平锁在每次尝试获取锁时，都是采用的非公平策略(无视等待队列，直接尝试获取锁，如果锁是空闲的，即可获取状态，则获取锁)。</p>
<ol>
<li>lock()</li>
</ol>
<p>公平锁   – 公平锁的lock()函数，会直接调用acquire(1)。</p>
<p>非公平锁 – 非公平锁会先判断当前锁的状态是不是空闲，是的话，就不排队，而是直接获取锁。</p>
<p>2、”公平锁”和”非公平锁”关于tryAcquire()的对比</p>
<p>公平锁和非公平锁，它们尝试获取锁的方式不同。</p>
<p>公平锁在尝试获取锁时，即使”锁”没有被任何线程锁持有，它也会判断自己是不是CLH等待队列的表头；是的话，才获取锁。</p>
<p>而非公平锁在尝试获取锁时，如果”锁”没有被任何线程持有，则不管它在CLH队列的何处，它都直接获取锁。</p>
<h3 id="Condition-1"><a href="#Condition-1" class="headerlink" title="Condition"></a>Condition</h3><p>Condition的作用是对锁进行更精确的控制。Condition中的await()方法相当于Object的wait()方法，Condition中的signal()方法相当于Object的notify()方法，Condition中的signalAll()相当于Object的notifyAll()方法。不同的是，Object中的wait(),notify(),notifyAll()方法是和”同步锁”(synchronized关键字)捆绑使用的；而Condition是需要与”互斥锁”/“共享锁”捆绑使用的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestContainer02</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">final</span> LinkedList&lt;E&gt; list = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX = <span class="number">10</span>;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">private</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">       <span class="keyword">private</span> Condition producer = lock.newCondition();</span><br><span class="line">       <span class="keyword">private</span> Condition consumer = lock.newCondition();</span><br><span class="line">       </span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span></span>&#123;</span><br><span class="line">               <span class="keyword">return</span> count;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(E e)</span></span>&#123;</span><br><span class="line">               lock.lock();</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                       <span class="keyword">while</span>(list.size() == MAX)&#123;</span><br><span class="line">                               System.out.println(Thread.currentThread().getName() + <span class="string">" 等待。。。"</span>);</span><br><span class="line">                               <span class="comment">// 进入等待队列。释放锁标记。</span></span><br><span class="line">                               <span class="comment">// 借助条件，进入的等待队列。</span></span><br><span class="line">                               producer.await();</span><br><span class="line">                       &#125;</span><br><span class="line">                       System.out.println(Thread.currentThread().getName() + <span class="string">" put 。。。"</span>);</span><br><span class="line">                       list.add(e);</span><br><span class="line">                       count++;</span><br><span class="line">                       <span class="comment">// 借助条件，唤醒所有的消费者。</span></span><br><span class="line">                       consumer.signalAll();</span><br><span class="line">               &#125; <span class="keyword">catch</span> (InterruptedException e1) &#123;</span><br><span class="line">                       e1.printStackTrace();</span><br><span class="line">               &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                       lock.unlock();</span><br><span class="line">               &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">()</span></span>&#123;</span><br><span class="line">               E e = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">               lock.lock();</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                       <span class="keyword">while</span>(list.size() == <span class="number">0</span>)&#123;</span><br><span class="line">                               System.out.println(Thread.currentThread().getName() + <span class="string">" 等待。。。"</span>);</span><br><span class="line">                               <span class="comment">// 借助条件，消费者进入等待队列</span></span><br><span class="line">                               consumer.await();</span><br><span class="line">                       &#125;</span><br><span class="line">                       System.out.println(Thread.currentThread().getName() + <span class="string">" get 。。。"</span>);</span><br><span class="line">                       e = list.removeFirst();</span><br><span class="line">                       count--;</span><br><span class="line">                       <span class="comment">// 借助条件，唤醒所有的生产者</span></span><br><span class="line">                       producer.signalAll();</span><br><span class="line">               &#125; <span class="keyword">catch</span> (InterruptedException e1) &#123;</span><br><span class="line">                       e1.printStackTrace();</span><br><span class="line">               &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                       lock.unlock();</span><br><span class="line">               &#125;</span><br><span class="line">               </span><br><span class="line">               <span class="keyword">return</span> e;</span><br><span class="line">       &#125;        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="LockSupport"><a href="#LockSupport" class="headerlink" title="LockSupport"></a>LockSupport</h2><p>LockSupport是用来创建锁和其他同步类的基本线程阻塞原语。</p>
<p>LockSupport中的park() 和 unpark() 的作用分别是阻塞线程和解除阻塞线程，而且park()和unpark()不会遇到”Thread.suspend 和 Thread.resume所可能引发的死锁”问题。</p>
<p>因为park() 和 unpark()有许可的存在；调用 park() 的线程和另一个试图将其 unpark() 的线程之间的竞争将保持活性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回提供给最近一次尚未解除阻塞的 park 方法调用的 blocker 对象，如果该调用不受阻塞，则返回 null。</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> Object <span class="title">getBlocker</span><span class="params">(Thread t)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 为了线程调度，禁用当前线程，除非许可可用。</span></span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">park</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 为了线程调度，在许可可用之前禁用当前线程。</span></span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">park</span><span class="params">(Object blocker)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 为了线程调度禁用当前线程，最多等待指定的等待时间，除非许可可用。</span></span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parkNanos</span><span class="params">(<span class="keyword">long</span> nanos)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 为了线程调度，在许可可用前禁用当前线程，并最多等待指定的等待时间。</span></span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parkNanos</span><span class="params">(Object blocker, <span class="keyword">long</span> nanos)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 为了线程调度，在指定的时限前禁用当前线程，除非许可可用。</span></span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parkUntil</span><span class="params">(<span class="keyword">long</span> deadline)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 为了线程调度，在指定的时限前禁用当前线程，除非许可可用。</span></span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parkUntil</span><span class="params">(Object blocker, <span class="keyword">long</span> deadline)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 如果给定线程的许可尚不可用，则使其可用。</span></span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unpark</span><span class="params">(Thread thread)</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockSupportTest1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> Thread mainThread;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       ThreadA ta = <span class="keyword">new</span> ThreadA(<span class="string">"ta"</span>);</span><br><span class="line">       <span class="comment">// 获取主线程</span></span><br><span class="line">       mainThread = Thread.currentThread();</span><br><span class="line"></span><br><span class="line">       System.out.println(Thread.currentThread().getName()+<span class="string">" start ta"</span>);</span><br><span class="line">       ta.start();</span><br><span class="line"></span><br><span class="line">       System.out.println(Thread.currentThread().getName()+<span class="string">" block"</span>);</span><br><span class="line">       <span class="comment">// 主线程阻塞</span></span><br><span class="line">       LockSupport.park(mainThread);</span><br><span class="line"></span><br><span class="line">       System.out.println(Thread.currentThread().getName()+<span class="string">" continue"</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadA</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">ThreadA</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">super</span>(name);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           System.out.println(Thread.currentThread().getName()+<span class="string">" wakup others"</span>);</span><br><span class="line">           <span class="comment">// 唤醒"主线程"</span></span><br><span class="line">           LockSupport.unpark(mainThread);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="共享锁"><a href="#共享锁" class="headerlink" title="共享锁"></a>共享锁</h2><p>CountDownLatchJUC(java.util.concurrent)中的共享锁有CountDownLatch, CyclicBarrier, Semaphore, ReentrantReadWriteLock等</p>
<p>ReadWriteLock，顾名思义，是读写锁。它维护了一对相关的锁 - - “读取锁”和”写入锁”，一个用于读取操作，另一个用于写入操作。</p>
<pre><code>&quot;读取锁&quot;用于只读操作，它是&quot;共享锁&quot;，能同时被多个线程获取。
&quot;写入锁&quot;用于写入操作，它是&quot;独占锁&quot;，写入锁只能被一个线程锁获取。</code></pre><p>注意：不能同时存在读取锁和写入锁！</p>
<p>ReadWriteLock是一个接口。ReentrantReadWriteLock是它的实现类，ReentrantReadWriteLock包括子类ReadLock和WriteLock。</p>
<h2 id="CountDownLatch"><a href="#CountDownLatch" class="headerlink" title="CountDownLatch"></a>CountDownLatch</h2><p>CountDownLatch是一个同步辅助类，在完成一组正在其他线程中执行的操作之前，它允许一个或多个线程一直等待。</p>
<p>CountDownLatch和CyclicBarrier的区别</p>
<pre><code>(01) CountDownLatch的作用是允许1或N个线程等待其他线程完成执行；而CyclicBarrier则是允许N个线程相互等待。
(02) CountDownLatch的计数器无法被重置；CyclicBarrier的计数器可以被重置后使用，因此它被称为是循环的barrier。</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CountDownLatch(<span class="keyword">int</span> count)</span><br><span class="line"><span class="comment">//构造一个用给定计数初始化的 CountDownLatch。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使当前线程在锁存器倒计数至零之前一直等待，除非线程被中断。</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">await</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 使当前线程在锁存器倒计数至零之前一直等待，除非线程被中断或超出了指定的等待时间。</span></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">await</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 递减锁存器的计数，如果计数到达零，则释放所有等待的线程。</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">countDown</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 返回当前计数。</span></span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">getCount</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 返回标识此锁存器及其状态的字符串。</span></span></span><br><span class="line"><span class="function">String <span class="title">toString</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test_03</span> </span>&#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">               <span class="keyword">final</span> Test_03_Container t = <span class="keyword">new</span> Test_03_Container();</span><br><span class="line">               <span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">               <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable()&#123;</span><br><span class="line">                       <span class="meta">@Override</span></span><br><span class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                               <span class="keyword">if</span>(t.size() != <span class="number">5</span>)&#123;</span><br><span class="line">                                       <span class="keyword">try</span> &#123;</span><br><span class="line">                                               latch.await(); <span class="comment">// 等待门闩的开放。 不是进入等待队列</span></span><br><span class="line">                                       &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                                               e.printStackTrace();</span><br><span class="line">                                       &#125;</span><br><span class="line">                               &#125;</span><br><span class="line">                               System.out.println(<span class="string">"size = 5"</span>);</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;).start();</span><br><span class="line">               </span><br><span class="line">               <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                       <span class="meta">@Override</span></span><br><span class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                               <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)&#123;</span><br><span class="line">                                       System.out.println(<span class="string">"add Object to Container "</span> + i);</span><br><span class="line">                                       t.add(<span class="keyword">new</span> Object());</span><br><span class="line">                                       <span class="keyword">if</span>(t.size() == <span class="number">5</span>)&#123;</span><br><span class="line">                                               latch.countDown(); <span class="comment">// 门闩-1</span></span><br><span class="line">                                       &#125;</span><br><span class="line">                                       <span class="keyword">try</span> &#123;</span><br><span class="line">                                               TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                                       &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                                               e.printStackTrace();</span><br><span class="line">                                       &#125;</span><br><span class="line">                               &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;).start();</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test_03_Container</span></span>&#123;</span><br><span class="line">       List&lt;Object&gt; container = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">       </span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Object o)</span></span>&#123;</span><br><span class="line">               <span class="keyword">this</span>.container.add(o);</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span>&#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">this</span>.container.size();</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line">add Object to Container <span class="number">0</span></span><br><span class="line">add Object to Container <span class="number">1</span></span><br><span class="line">add Object to Container <span class="number">2</span></span><br><span class="line">add Object to Container <span class="number">3</span></span><br><span class="line">add Object to Container <span class="number">4</span></span><br><span class="line">size = <span class="number">5</span></span><br><span class="line">add Object to Container <span class="number">5</span></span><br><span class="line">add Object to Container <span class="number">6</span></span><br><span class="line">add Object to Container <span class="number">7</span></span><br><span class="line">add Object to Container <span class="number">8</span></span><br><span class="line">add Object to Container <span class="number">9</span></span><br></pre></td></tr></table></figure>
<h2 id="CyclicBarrier"><a href="#CyclicBarrier" class="headerlink" title="CyclicBarrier"></a>CyclicBarrier</h2><p>CyclicBarrier是一个同步辅助类，允许一组线程互相等待，直到到达某个公共屏障点 (common barrier point)。因为该 barrier 在释放等待线程后可以重用，所以称它为循环 的 barrier。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">CyclicBarrier(<span class="keyword">int</span> parties)</span><br><span class="line"><span class="comment">//创建一个新的 CyclicBarrier，它将在给定数量的参与者（线程）处于等待状态时启动，但它不会在启动 barrier 时执行预定义的操作。</span></span><br><span class="line">CyclicBarrier(<span class="keyword">int</span> parties, Runnable barrierAction)</span><br><span class="line"><span class="comment">//创建一个新的 CyclicBarrier，它将在给定数量的参与者（线程）处于等待状态时启动，并在启动 barrier 时执行给定的屏障操作，该操作由最后一个进入 barrier 的线程执行。</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">await</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">//在所有参与者都已经在此 barrier 上调用 await 方法之前，将一直等待。</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">await</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="function"><span class="comment">//在所有参与者都已经在此屏障上调用 await 方法之前将一直等待,或者超出了指定的等待时间。</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getNumberWaiting</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">//返回当前在屏障处等待的参与者数目。</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getParties</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">//返回要求启动此 barrier 的参与者数目。</span></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isBroken</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">//查询此屏障是否处于损坏状态。</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">//将屏障重置为其初始状态。</span></span></span><br></pre></td></tr></table></figure>
<h2 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h2><p>Semaphore是一个计数信号量，它的本质是一个”共享锁”。</p>
<p>信号量维护了一个信号量许可集。线程可以通过调用acquire()来获取信号量的许可；当信号量中有可用的许可时，线程能获取该许可；否则线程必须等待，直到有可用的许可为止。 线程可以通过release()来释放它所持有的信号量许可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建具有给定的许可数和非公平的公平设置的 Semaphore。</span></span><br><span class="line">Semaphore(<span class="keyword">int</span> permits)</span><br><span class="line"><span class="comment">// 创建具有给定的许可数和给定的公平设置的 Semaphore。</span></span><br><span class="line">Semaphore(<span class="keyword">int</span> permits, <span class="keyword">boolean</span> fair)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从此信号量获取一个许可，在提供一个许可前一直将线程阻塞，否则线程被中断。</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">acquire</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 从此信号量获取给定数目的许可，在提供这些许可前一直将线程阻塞，或者线程已被中断。</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> permits)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 从此信号量中获取许可，在有可用的许可前将其阻塞。</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">acquireUninterruptibly</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 从此信号量获取给定数目的许可，在提供这些许可前一直将线程阻塞。</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">acquireUninterruptibly</span><span class="params">(<span class="keyword">int</span> permits)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 返回此信号量中当前可用的许可数。</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">availablePermits</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 获取并返回立即可用的所有许可。</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">drainPermits</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 返回一个 collection，包含可能等待获取的线程。</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Collection&lt;Thread&gt; <span class="title">getQueuedThreads</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 返回正在等待获取的线程的估计数目。</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getQueueLength</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 查询是否有线程正在等待获取。</span></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">hasQueuedThreads</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 如果此信号量的公平设置为 true，则返回 true。</span></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isFair</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 根据指定的缩减量减小可用许可的数目。</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reducePermits</span><span class="params">(<span class="keyword">int</span> reduction)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 释放一个许可，将其返回给信号量。</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">release</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 释放给定数目的许可，将其返回到信号量。</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">release</span><span class="params">(<span class="keyword">int</span> permits)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 返回标识此信号量的字符串，以及信号量的状态。</span></span></span><br><span class="line"><span class="function">String <span class="title">toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 仅在调用时此信号量存在一个可用许可，才从信号量获取许可。</span></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 仅在调用时此信号量中有给定数目的许可时，才从此信号量中获取这些许可。</span></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> permits)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 如果在给定的等待时间内此信号量有可用的所有许可，并且当前线程未被中断，则从此信号量获取给定数目的许可。</span></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> permits, <span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 如果在给定的等待时间内，此信号量有可用的许可并且当前线程未被中断，则从此信号量获取一个许可。</span></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br></pre></td></tr></table></figure>
<h2 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h2><p>ThreadLocal线程本地副本</p>
<ul>
<li>就是一个Map，key -&gt; Thread.getCurrentThread().  value -&gt;线程需要保存的变量。</li>
<li>ThreadLocal.set(value) -&gt; map.put(Thread.getCurrentThread(), value);</li>
<li>ThreadLocal.get() -&gt; map.get(Thread.getCurrentThread());</li>
<li>内存问题 ： 在并发量高的时候，可能有内存溢出。</li>
<li>使用ThreadLocal的时候，一定注意回收资源问题，每个线程结束之前，将当前线程保存的线程变量一定要删除 。</li>
<li>ThreadLocal.remove();</li>
</ul>
<h2 id="同步容器"><a href="#同步容器" class="headerlink" title="同步容器"></a>同步容器</h2><h3 id="1、Map和Set"><a href="#1、Map和Set" class="headerlink" title="1、Map和Set"></a>1、Map和Set</h3><p>ConcurrentHashMap/ConcurrentHashSet</p>
<p>底层哈希实现的同步 Map(Set)。效率高，线程安全。使用系统底层技术实现线程安全。量级较 synchronized 低。key 和 value 不能为 null。</p>
<p>ConcurrentSkipListMap/ConcurrentSkipListSet</p>
<p>底层跳表（SkipList）实现的同步 Map(Set)。有序，效率比 ConcurrentHashMap 稍低。</p>
<h3 id="2、List"><a href="#2、List" class="headerlink" title="2、List"></a>2、List</h3><p>CopyOnWriteArrayList/CopyOnWriteSet</p>
<p>写时复制集合，每次写入数据，都会创建一个新的底层数组。写入效率低，读取效率高。</p>
<h3 id="3、-Queue"><a href="#3、-Queue" class="headerlink" title="3、 Queue"></a>3、 Queue</h3><ul>
<li>ConcurrentLinkedQueue 链表同步队列。</li>
<li>LinkedBlockingQueue 阻塞队列，队列容量不足自动阻塞，队列容量为 0 自动阻塞。</li>
<li>ArrayBlockingQueue 底层数组实现的有界队列。自动阻塞。</li>
</ul>
<p>根据调用 API（add/put/offer）不同，有不同特性。</p>
<p>当容量不足的时候，有阻塞能力。</p>
<pre><code>add 方法在容量不足的时候，抛出异常。
put 方法在容量不足的时候，阻塞等待。</code></pre><p>offer 方法</p>
<p>单参数 offer 方法，不阻塞。容量不足的时候，返回 false。当前新增数据操作放弃。</p>
<p>三参数 offer 方法（offer(value,times,timeunit)），容量不足的时候，阻塞 times 时长（单位为 timeunit），如果在阻塞时长内，</p>
<p>有容量空闲，新增数据返回 true。如果阻塞时长范围内，无容量空闲，放弃新增数据，返回 false。</p>
<ul>
<li><p>DelayQueue    延时队列。根据比较机制，实现自定义处理顺序的队列。常用于定时任务。如：定时关机。</p>
</li>
<li><p>LinkedTransferQueue    转移队列，使用 transfer 方法，实现数据的即时处理。没有消费者，就阻塞。</p>
</li>
<li><p>SynchronusQueue    同步队列，是一个容量为 0 的队列。是一个特殊的 TransferQueue。必须现有消费线程等待，才能使用的队列。</p>
<p>  add 方法，无阻塞。若没有消费线程阻塞等待数据，则抛出异常。<br>  put 方法，有阻塞。若没有消费线程阻塞等待数据，则阻塞</p>
</li>
</ul>
<p>List的实现类主要有: LinkedList, ArrayList, Vector, Stack。</p>
<pre><code>(01) LinkedList是双向链表实现的双端队列；它不是线程安全的，只适用于单线程。
(02) ArrayList是数组实现的队列，它是一个动态数组；它也不是线程安全的，只适用于单线程。
(03) Vector是数组实现的矢量队列，它也一个动态数组；不过和ArrayList不同的是，Vector是线程安全的，它支持并发。
(04) Stack是Vector实现的栈；和Vector一样，它也是线程安全的。</code></pre><p>Set的实现类主要有: HastSet和TreeSet。</p>
<pre><code>(01) HashSet是一个没有重复元素的集合，它通过HashMap实现的；HashSet不是线程安全的，只适用于单线程。
(02) TreeSet也是一个没有重复元素的集合，不过和HashSet不同的是，TreeSet中的元素是有序的；它是通过TreeMap实现的；TreeSet也不是线程安全的，只适用于单线程。</code></pre><p>Map的实现类主要有: HashMap，WeakHashMap, Hashtable和TreeMap。</p>
<pre><code>(01) HashMap是存储&quot;键-值对&quot;的哈希表；它不是线程安全的，只适用于单线程。
(02) WeakHashMap是也是哈希表；和HashMap不同的是，HashMap的&quot;键&quot;是强引用类型，而WeakHashMap的&quot;键&quot;是弱引用类型，也就是说当WeakHashMap 中的某个键不再正常使用时，会被从WeakHashMap中被自动移除。WeakHashMap也不是线程安全的，只适用于单线程。
(03) Hashtable也是哈希表；和HashMap不同的是，Hashtable是线程安全的，支持并发。
(04) TreeMap也是哈希表，不过TreeMap中的&quot;键-值对&quot;是有序的，它是通过R-B Tree(红黑树)实现的；TreeMap不是线程安全的，只适用于单线程。</code></pre><h2 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h2><p><img src="https://img.huyunshun.com/img/20200414113139.png" alt="20200414113139"></p>
<h3 id="1-Executor"><a href="#1-Executor" class="headerlink" title="1. Executor"></a>1. Executor</h3><p>它是执行者接口，它是来执行任务的。Executor提供了execute()接口来执行已提交的 Runnable 任务的对象。Executor存在的目的是提供一种将任务提交与任务如何运行分离开来的机制。<br>它只包含一个函数接口：</p>
<p>void execute(Runnable command)//启动线程任务</p>
<h3 id="2-ExecutorService"><a href="#2-ExecutorService" class="headerlink" title="2. ExecutorService"></a>2. ExecutorService</h3><p>ExecutorService继承于Executor。它是执行者服务接口，它是为执行者接口Executor服务而存在的；ExecutorService提供了将任务提交给执行者的接口(submit方法)，让执行者执行任务(invokeAll, invokeAny方法)的接口等等。<br>       submit，有返回值（Future 类型），submit 方法提供了 overload 方法。其中有参数类型为 Runnable 的，不需要提供返回值的；</p>
<p>有参数类型为 Callable，可以提供线程执行后的返回值。Future，是 submit 方法的返回值。代表未来，也就是线程执行结束后的一种结果。如返回值。</p>
<p>常见方法 - void execute(Runnable)， Future submit(Callable)， Future submit(Runnable)</p>
<p>线程池状态： Running， ShuttingDown， Termitnaed</p>
<pre><code>Running - 线程池正在执行中。活动状态。
ShuttingDown - 线程池正在关闭过程中。优雅关闭。一旦进入这个状态，线程池不再接收新的任务，处理所有已接收的任务，处理完毕后，关闭线程池。
Terminated - 线程池已经关闭。</code></pre><h3 id="3-Future"><a href="#3-Future" class="headerlink" title="3 Future"></a>3 Future</h3><p>代表线程任务执行结束后的结果。获取线程执行结果的方式是通过 get 方法获取的。get 无参，阻塞等待线程执行结束，并得到结果。get 有参，阻塞固定时长，等待线程执行结束后的结果，如果在阻塞时长范围内，线程未执行结束，抛出异常。<br>常用方法： T get() T get(long, TimeUnit)</p>
<h3 id="4-AbstractExecutorService"><a href="#4-AbstractExecutorService" class="headerlink" title="4. AbstractExecutorService"></a>4. AbstractExecutorService</h3><p>AbstractExecutorService是一个抽象类，它实现了ExecutorService接口。</p>
<p>AbstractExecutorService存在的目的是为ExecutorService中的函数接口提供了默认实现。函数列表和ExecutorService一样。</p>
<h3 id="5-ScheduledExecutorService"><a href="#5-ScheduledExecutorService" class="headerlink" title="5. ScheduledExecutorService"></a>5. ScheduledExecutorService</h3><p>ScheduledExecutorService是一个接口，它继承于于ExecutorService。它相当于提供了延时和周期执行功能的ExecutorService。</p>
<p>ScheduledExecutorService提供了相应的函数接口，可以安排任务在给定的延迟后执行，也可以让任务周期的执行。</p>
<h3 id="6-Executors"><a href="#6-Executors" class="headerlink" title="6.  Executors"></a>6.  Executors</h3><p>Executors是个静态工厂类。它通过静态工厂方法返回ExecutorService、ScheduledExecutorService、ThreadFactory 和 Callable 等类的对象。</p>
<h3 id="7-FixedThreadPool"><a href="#7-FixedThreadPool" class="headerlink" title="7.  FixedThreadPool"></a>7.  FixedThreadPool</h3><p>容量固定的线程池。活动状态和线程池容量是有上限的线程池。所有的线程池中，都有一个任务队列。使用的是 BlockingQueue&lt;Runnable&gt;作为任务的载体。</p>
<p>当任务数量大于线程池容量的时候，没有运行的任务保存在任务队列中，当线程有空闲的，自动从队列中取出任务执行。</p>
<p>使用场景： 大多数情况下，使用的线程池，首选推荐 FixedThreadPool。OS 系统和硬件是有线程支持上限。不能随意的无限制提供线程池。线程池默认的容量上限是 Integer.MAX_VALUE。</p>
<p>常见的线程池容量： PC - 200。 服务器 - 1000~10000</p>
<pre><code>queued tasks- 任务队列
completed tasks - 结束任务队列</code></pre><h3 id="8-CachedThreadPool"><a href="#8-CachedThreadPool" class="headerlink" title="8.  CachedThreadPool"></a>8.  CachedThreadPool</h3><p>缓存的线程池。容量不限（Integer.MAX_VALUE）。</p>
<p>自动扩容。容量管理策略：如果线程池中的线程数量不满足任务执行，创建新的线程。每次有新任务无法即时处理的时候，都会<br>创建新的线程。当线程池中的线程空闲时长达到一定的临界值（默认 60 秒），自动释放线程。默认线程空闲 60 秒，自动销毁。</p>
<p>应用场景： 内部应用或测试应用。 内部应用，有条件的内部数据瞬间处理时应用，如：平台夜间执行数据整理， 测试应用，在测试的时候，尝试得到硬件或软件的最高负载量，用于提供<br>FixedThreadPool 容量的指导。</p>
<h3 id="9-ScheduledThreadPool"><a href="#9-ScheduledThreadPool" class="headerlink" title="9.  ScheduledThreadPool"></a>9.  ScheduledThreadPool</h3><p>计划任务线程池。可以根据计划自动执行任务的线程池。scheduleAtFixedRate(Runnable, start_limit, limit, timeunit)</p>
<pre><code>runnable - 要执行的任务。
start_limit - 第一次任务执行的间隔。
limit - 多次任务执行的间隔。
timeunit - 多次任务执行间隔的时间单位。</code></pre><p>使用场景： 计划任务时选用（DelaydQueue），如：电信行业中的数据整理，没分钟整理，没消失整理，每天整理等。</p>
<h3 id="10-SingleThreadExceutor"><a href="#10-SingleThreadExceutor" class="headerlink" title="10.  SingleThreadExceutor"></a>10.  SingleThreadExceutor</h3><p>单一容量的线程池。</p>
<p>使用场景： 保证任务顺序时使用。如： 游戏大厅中的公共频道聊天。秒杀。</p>
<h3 id="11-ForkJoinPool"><a href="#11-ForkJoinPool" class="headerlink" title="11.  ForkJoinPool"></a>11.  ForkJoinPool</h3><p>分支合并线程池（mapduce 类似的设计思想）。适合用于处理复杂任务。初始化线程容量与 CPU 核心数相关。<br>线程池中运行的内容必须是 ForkJoinTask 的子类型（RecursiveTask,RecursiveAction）。</p>
<p>ForkJoinPool - 分支合并线程池。 可以递归完成复杂任务。要求可分支合并的任务必须是 ForkJoinTask 类型的子类型。其中提供了分支和合并的能力。ForkJoinTask 类型提供了两个<br>抽象子类型，RecursiveTask 有返回结果的分支合并任务,RecursiveAction 无返回结果的分支合并任务。（Callable/Runnable）compute 方法：就是任务的执行逻辑。</p>
<p>ForkJoinPool 没有所谓的容量。默认都是 1 个线程。根据任务自动的分支新的子线程。当子线程任务结束后，自动合并。所谓自动是根据 fork 和 join 两个方法实现的。</p>
<p>应用： 主要是做科学计算或天文计算的。数据分析的。</p>
<h3 id="12-ThreadPoolExecutor"><a href="#12-ThreadPoolExecutor" class="headerlink" title="12.  ThreadPoolExecutor"></a>12.  ThreadPoolExecutor</h3><p>ThreadPoolExecutor就是大名鼎鼎的”线程池”。它继承于AbstractExecutorService抽象类。线程池底层实现。除 ForkJoinPool 外，其他常用线程池底层都是使用 ThreadPoolExecutor实现的。</p>
<p>public ThreadPoolExecutor(int corePoolSize, // 核心容量，创建线程池的时候，默认有多少线程。也是线程池保持的最少线程数</p>
<pre><code>int maximumPoolSize, // 最大容量，线程池最多有多少线程
long keepAliveTime, // 生命周期，0 为永久。当线程空闲多久后，自动回收。
TimeUnit unit, // 生命周期单位，为生命周期提供单位，如：秒，毫秒
BlockingQueue&lt;Runnable&gt; workQueue // 任务队列，阻塞队列。注意，泛型必须是Runnable).</code></pre><p>使用场景： 默认提供的线程池不满足条件时使用。如：初始线程数据 4，最大线程数200，线程空闲周期 30</p>
<p><strong>线程池的拒绝策略</strong> ：是指当任务添加到线程池中被拒绝，而采取的处理措施。</p>
<p>当任务添加到线程池中之所以被拒绝，可能是由于：第一，线程池异常关闭。第二，任务数量超过线程池的最大限制。</p>
<p>线程池共包括4种拒绝策略，它们分别是：AbortPolicy, CallerRunsPolicy, DiscardOldestPolicy和DiscardPolicy。</p>
<pre><code>AbortPolicy         -- 当任务添加到线程池中被拒绝时，它将抛出 RejectedExecutionException 异常。
CallerRunsPolicy    -- 当任务添加到线程池中被拒绝时，会在线程池当前正在运行的Thread线程池中处理被拒绝的任务。
DiscardOldestPolicy -- 当任务添加到线程池中被拒绝时，线程池会放弃等待队列中最旧的未处理任务，然后将被拒绝的任务添加到等待队列中。
DiscardPolicy       -- 当任务添加到线程池中被拒绝时，线程池将丢弃被拒绝的任务。</code></pre><p>线程池默认的处理策略是AbortPolicy！</p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2017/05/11/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3java%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/11/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3java%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8/" itemprop="url">深入理解java类加载器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-11T00:00:00+08:00">
                2017-05-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="类加载器原理"><a href="#类加载器原理" class="headerlink" title="类加载器原理"></a>类加载器原理</h2><p>类加载器是一个用来加载类文件的类。Java源代码通过javac编译器编译成类文件。然后JVM来执行类文件中的字节码来执行程序。类加载器负责加载文件系统、网络或其他来源的类文件。</p>
<p>Java类加载器的作用就是在运行时加载类。Java类加载器基于三个机制：委托、可见性和单一性。</p>
<p><strong>委托机制：</strong> 将加载一个类的请求交给父类加载器，如果这个父类加载器不能够找到或者加载这个类，那么再加载它。</p>
<p><strong>可见性：</strong> 子类的加载器可以看见所有的父类加载器加载的类，而父类加载器看不到子类加载器加载的类。</p>
<p><strong>单一性：</strong> 仅加载一个类一次，这是由委托机制确保子类加载器不会再次加载父类加载器加载过的类。</p>
<p>正确理解类加载器能够帮你解决NoClassDefFoundError和java.lang.ClassNotFoundException，因为它们和类的加载相关。</p>
<h2 id="加载器树状结构"><a href="#加载器树状结构" class="headerlink" title="加载器树状结构"></a>加载器树状结构</h2><p>Java 中的类加载器大致可以分成两类，一类是系统提供的，另外一类则是自定义。</p>
<p>三种默认使用的类加载器：Bootstrap类加载器、Extension类加载器和System类加载器（或者叫作Application类加载器）。</p>
<p><strong>引导类加载器（bootstrap class loader）：</strong> 它用来加载 Java 的核心库(jre/lib/rt.jar)或-Xbootclasspath参数指定路径的目录，是用原生C++代码来实现的，并不继承自java.lang.ClassLoader。（出于安全考虑，Bootstrap启动类加载器只加载包名为java、javax、sun等开头的类）</p>
<p><strong>扩展类加载器（extensions class loader）：</strong> 它用来加载 Java 的扩展库Java 虚拟机的实现会提供一个扩展库目录JRE/lib/ext或者java.ext.dirs指向的目录。该类加载器在此目录里面查找并加载 Java 类。</p>
<p><strong>系统类加载器（system/Application class loader）：</strong> 它根据 Java 应用的类路径（CLASSPATH）来加载 Java 类。一般来说，Java 应用的类都是由它来完成加载的。可以通过 ClassLoader.getSystemClassLoader()来获取它。</p>
<p><strong>自定义类加载器（custom class loader）：</strong> 除了系统提供的类加载器以外，开发人员可以通过继承 java.lang.ClassLoader类的方式实现自己的类加载器，以满足一些特殊的需求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//application class loader</span></span><br><span class="line">    System.out.println(ClassLoader.getSystemClassLoader());</span><br><span class="line">    <span class="comment">//extensions class loader</span></span><br><span class="line">    System.out.println(ClassLoader.getSystemClassLoader().getParent());</span><br><span class="line">    <span class="comment">//bootstrap class loader</span></span><br><span class="line">    System.out.println(ClassLoader.getSystemClassLoader().getParent().getParent());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://img.huyunshun.com/img/20200412223705.png" alt="20200412223705"></p>
<p>将class文件字节码内容加载到内存中，并将这些静态数据转换成方法去中的运行时数据结构，在怼中生成一个代表这个类的Class对象 ，作为方法去类数据的访问入口。</p>
<h3 id="类缓存"><a href="#类缓存" class="headerlink" title="类缓存"></a>类缓存</h3><p>标准的类加载器可以按要求查找类，但一旦某个类被加载到类加载器中，它将维持加载（缓存）一段时间，不过，JVM垃圾回收器可以回收这些Class。</p>
<h2 id="双亲委托或代理机制"><a href="#双亲委托或代理机制" class="headerlink" title="双亲委托或代理机制"></a>双亲委托或代理机制</h2><p>代理模式：交给其他加载器来加载指定类</p>
<p><strong>双亲委托机制：</strong> 某个特定的类加载器在接到加载类的请求时，首先将加载任务委托交给父类加载器，父类加载器又将加载任务向上委托，直到最父类加载器，如果最父类加载器可以完成类加载任务，就成功返回，如果不行就向下传递委托任务，由其子类加载器进行加载。</p>
<p>双亲委托机制是为了保证Java核心库的类型安全。保证了不会出现用户自定义java.lang.Object类的情况。</p>
<pre><code>类加载器除了用于加载类，也是安全的最基本的屏障</code></pre><p><strong>双亲委托机制是代理模式的一种。</strong></p>
<p>并不是所有的类加载都是双亲模式，比如tomcat服务器也是使用代理模式，不同的是它首先尝试去加载类，如果找不到在代理给父类加载器，这与一般加载器是相反的。</p>
<p>Class.forname()是一个静态方法,最常用的是Class.forname(String className);根据传入的类的全限定名返回一个Class对象.该方法在将Class文件加载到内存的同时,会执行类的初始化.</p>
<p>ClassLoader.loadClass():这是一个实例方法,需要一个ClassLoader对象来调用该方法,该方法将Class文件加载到内存时,并不会执行类的初始化，直到这个类第一次使用时才进行初始化，该方法因为需要得到一个ClassLoader对象,所以可以根据需要指定使用哪个类加载器.</p>
<h2 id="自定义类加载器"><a href="#自定义类加载器" class="headerlink" title="自定义类加载器"></a>自定义类加载器</h2><pre><code>1、继承java.lang.ClassLoader
2、首先检查请求的类型是否已经被这个类装载器装载到命名空间中，如果已经装载，直接返回。
3、委派类加载请求给父类加载器，如果父类加载器能够完成，则返回父类加载器加载的Class实例。
4、重写本类加载器的findClass(...)方法，试图获取对应字节码，如果获取得到，则调用defineClass(...)导入类型到方法区，如果获取不到对应的字节码或者其他原因失败，则终止加载过程。</code></pre><p>注意：被两个类加载器加载的同一个类，JVM不认为是相同的类。</p>
<h3 id="自定义文件系统类加载器"><a href="#自定义文件系统类加载器" class="headerlink" title="自定义文件系统类加载器"></a>自定义文件系统类加载器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义文件类加载器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileSysLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String rootDir;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FileSysLoader</span><span class="params">(String rootDir)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.rootDir = rootDir;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">//检查有没有加载过这个类，如果已经加载直接返回这个类。</span></span><br><span class="line">        Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">        <span class="keyword">if</span> (c!=<span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            ClassLoader parent = <span class="keyword">this</span>.getParent();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//委派给父类加载器</span></span><br><span class="line">                c = parent.loadClass(name);    </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(c!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> c;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//如果父类也没加载，则自己加载，读取文件 进行加载</span></span><br><span class="line">                <span class="keyword">byte</span>[] classData = getClassData(name);</span><br><span class="line">                <span class="keyword">if</span>(classData==<span class="keyword">null</span>)&#123;</span><br><span class="line">                    <span class="comment">//没有读取到文件，抛出异常</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException();</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="comment">//生成Class对象</span></span><br><span class="line">                    c = defineClass(name, classData, <span class="number">0</span>,classData.length);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件内容转为字节数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] getClassData(String classname)&#123;</span><br><span class="line">        String path = rootDir + File.separatorChar + classname.replace(<span class="string">'.'</span>, File.separatorChar)+<span class="string">".class"</span>;</span><br><span class="line">        InputStream is = <span class="keyword">null</span>;</span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            is  = <span class="keyword">new</span> FileInputStream(path);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">int</span> temp=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span>((temp=is.read(buffer))!=-<span class="number">1</span>)&#123;</span><br><span class="line">                baos.write(buffer, <span class="number">0</span>, temp);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> baos.toByteArray();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(is!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                    is.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(baos!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                    baos.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestFileLoader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        FileSysLoader loader = <span class="keyword">new</span> FileSysLoader(<span class="string">"C:/Person"</span>);</span><br><span class="line">        FileSysLoader loader1 = <span class="keyword">new</span> FileSysLoader(<span class="string">"C:/Person"</span>);</span><br><span class="line">        </span><br><span class="line">        Class&lt;?&gt; c1 = loader.loadClass(<span class="string">"com.temp.bytecodeop.Person"</span>);</span><br><span class="line">        Class&lt;?&gt; c2 = loader1.loadClass(<span class="string">"com.temp.bytecodeop.Person"</span>);</span><br><span class="line">        Class&lt;?&gt; c3 = loader1.loadClass(<span class="string">"com.temp.bytecodeop.Person"</span>);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; c4 = loader.loadClass(<span class="string">"java.lang.String"</span>);</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        System.out.println(c1.hashCode());</span><br><span class="line">        System.out.println(c2.hashCode());</span><br><span class="line">        System.out.println(c3.hashCode());</span><br><span class="line">        System.out.println(c4.hashCode());</span><br><span class="line">        System.out.println(c3.getClassLoader());</span><br><span class="line">        System.out.println(c1.getClassLoader().getParent());</span><br><span class="line">        System.out.println(c4.getClassLoader());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自定义网络类加载器"><a href="#自定义网络类加载器" class="headerlink" title="自定义网络类加载器"></a>自定义网络类加载器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NetClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;    </span><br><span class="line">    <span class="keyword">private</span> String rootUrl;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetClassLoader</span><span class="params">(String rootUrl)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.rootUrl = rootUrl;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        </span><br><span class="line">        Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(c!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            ClassLoader parent = <span class="keyword">this</span>.getParent();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                c = parent.loadClass(name);    </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(c!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> c;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">byte</span>[] classData = getClassData(name);</span><br><span class="line">                <span class="keyword">if</span>(classData==<span class="keyword">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException();</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    c = defineClass(name, classData, <span class="number">0</span>,classData.length);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] getClassData(String classname)&#123;   </span><br><span class="line">        String path = rootUrl +<span class="string">"/"</span>+ classname.replace(<span class="string">'.'</span>, <span class="string">'/'</span>)+<span class="string">".class"</span>;</span><br><span class="line">        InputStream is = <span class="keyword">null</span>;</span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            URL url = <span class="keyword">new</span> URL(path);</span><br><span class="line">            <span class="comment">//通过URL获取流</span></span><br><span class="line">            is  = url.openStream();</span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">int</span> temp=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span>((temp=is.read(buffer))!=-<span class="number">1</span>)&#123;</span><br><span class="line">                baos.write(buffer, <span class="number">0</span>, temp);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> baos.toByteArray();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(is!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                    is.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(baos!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                    baos.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="热部署类加载器"><a href="#热部署类加载器" class="headerlink" title="热部署类加载器"></a>热部署类加载器</h3><p>热部署就是利用同一个class文件不同的类加载器在内存创建出两个不同的class对象由于JVM在加载类之前会检测请求的类是否已加载过，如果被加载过，则直接从缓存获取，不会重新加载。</p>
<p>同一个加载器只能加载一次，多次加载将报错，因此实现的热部署必须让同一个class文件可以根据不同的类加载器重复加载，</p>
<p>实现所谓的热部署。自定义加载器后，直接调用findClass()方法，而不是调用loadClass()方法，因为ClassLoader中loadClass()方法体回调用findLoadedClass()方法进行了检测是否已被加载，因此我们直接调用findClass()方法就可以绕过这个问题。</p>
<p>前面的文件加载，使用了父类委托方式，我们这里直接写自己加载。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 热部署类加载器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileDeployLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String rootDir;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FileDeployLoader</span><span class="params">(String rootDir)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.rootDir = rootDir;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">//检查有没有加载过这个类，如果已经加载直接返回这个类。</span></span><br><span class="line">        <span class="keyword">byte</span>[] classData = getClassData(name);</span><br><span class="line">        Class&lt;?&gt; c = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(classData==<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="comment">//没有读取到文件，抛出异常</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//生成Class对象</span></span><br><span class="line">            c = defineClass(name, classData, <span class="number">0</span>,classData.length);</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件内容转为字节数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] getClassData(String classname)&#123;</span><br><span class="line">        String path = rootDir + File.separatorChar + classname.replace(<span class="string">'.'</span>, File.separatorChar)+<span class="string">".class"</span>;</span><br><span class="line">        InputStream is = <span class="keyword">null</span>;</span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            is  = <span class="keyword">new</span> FileInputStream(path);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">int</span> temp=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span>((temp=is.read(buffer))!=-<span class="number">1</span>)&#123;</span><br><span class="line">                baos.write(buffer, <span class="number">0</span>, temp);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> baos.toByteArray();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(is!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                    is.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(baos!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                    baos.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</span><br><span class="line">        FileSysLoader loader = <span class="keyword">new</span> FileSysLoader(<span class="string">"C:/Person"</span>);</span><br><span class="line">        <span class="comment">//直接调用findClass()方法，而不是调用loadClass()方法</span></span><br><span class="line">        <span class="comment">//因为ClassLoader中loadClass()方法体回调用findLoadedClass()方法进行了检测是否已被加载</span></span><br><span class="line">        Class&lt;?&gt; c1 = loader.findClass(<span class="string">"com.temp.bytecodeop.Person"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="加密解密类加载器"><a href="#加密解密类加载器" class="headerlink" title="加密解密类加载器"></a>加密解密类加载器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 简单加密类</span></span><br><span class="line"><span class="comment"> * 字节取反加密</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EncrptUtil</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//调用加密方法加密一个*.class文件</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">encrpt</span><span class="params">(String src, String dest)</span></span>&#123;</span><br><span class="line">        FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">        FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fis = <span class="keyword">new</span> FileInputStream(src);</span><br><span class="line">            fos = <span class="keyword">new</span> FileOutputStream(dest);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">int</span> temp = -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span>((temp=fis.read())!=-<span class="number">1</span>)&#123;</span><br><span class="line">                fos.write(temp^<span class="number">0xff</span>);  <span class="comment">//加密</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(fis!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                    fis.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(fos!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                    fos.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加密解密类加载器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DecrptClassLoader</span>  <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">private</span> String rootDir;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DecrptClassLoader</span><span class="params">(String rootDir)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.rootDir = rootDir;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        </span><br><span class="line">        Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(c!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            ClassLoader parent = <span class="keyword">this</span>.getParent();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                c = parent.loadClass(name);    </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(c!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> c;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">byte</span>[] classData = getClassData(name);</span><br><span class="line">                <span class="keyword">if</span>(classData==<span class="keyword">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException();</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    c = defineClass(name, classData, <span class="number">0</span>,classData.length);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] getClassData(String classname)&#123;  </span><br><span class="line">        String path = rootDir +File.separatorChar+ classname.replace(<span class="string">'.'</span>, File.separatorChar)+<span class="string">".class"</span>;</span><br><span class="line">        InputStream is = <span class="keyword">null</span>;</span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            is  = <span class="keyword">new</span> FileInputStream(path);</span><br><span class="line">            <span class="keyword">int</span> temp = -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span>((temp=is.read())!=-<span class="number">1</span>)&#123;</span><br><span class="line">                baos.write(temp^<span class="number">0xff</span>);  <span class="comment">//解密,再取反</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> baos.toByteArray();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(is!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                    is.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(baos!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                    baos.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="线程上下文类加载器"><a href="#线程上下文类加载器" class="headerlink" title="线程上下文类加载器"></a>线程上下文类加载器</h3><p>在Java中存在着很多服务提供者接口（Service Provider Interface，SPI），SPI 的接口属于 Java 核心库，一般存在rt.jar包中，由Bootstrap类加载器加载。这些接口允许第三方为它们提供实现，如常见的 SPI 有 JDBC、JCE、JAXP、JBI、JNDI等，而这些SPI 的第三方实现代码则是作为Java应用所依赖的 jar 包被存放在classpath路径下，由系统加载器来加载，但SPI的核心接口类是由引导类加载器来加载的，而Bootstrap类加载器无法直接加载SPI的实现类，同时由于双亲委派模式的存在，Bootstrap类加载器也无法反向委托AppClassLoader加载器SPI的实现类。在这种情况下，我们就需要一种特殊的类加载器来加载第三方的类库。</p>
<p>因此，线程类加载器是很好的选择，它为了抛弃双亲委派加载链模式。</p>
<p>每个线程都有一个关联的上下文加载器，如果new一个新的线程，如果没有手动设置上下文类加载器，线程将继承其父线程的上下文类加载器，通过java.lang.Thread类中的getContextClassLoader()和 setContextClassLoader(ClassLoader cl)方法来获取和设置线程的上下文类加载器。</p>
<p><img src="https://img.huyunshun.com/img/20200412224649.png" alt="20200412224649"></p>
<p>rt.jar核心包是有Bootstrap类加载器加载的，其内包含SPI核心接口类，由于SPI中的类经常需要调用外部实现类的方法，而jdbc.jar包含外部实现类(jdbc.jar存在于classpath路径)无法通过Bootstrap类加载器加载，因此只能委派线程上下文类加载器把jdbc.jar中的实现类加载到内存以便SPI相关类使用。它在执行过程中抛弃双亲委派加载链模式，使程序可以逆向使用类加载器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoaderTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</span><br><span class="line">        ClassLoader loader = LoaderTest<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>()</span>;</span><br><span class="line">        System.out.println(loader);        </span><br><span class="line">        </span><br><span class="line">        ClassLoader loader2 = Thread.currentThread().getContextClassLoader();</span><br><span class="line">        System.out.println(loader2);</span><br><span class="line">        </span><br><span class="line">        Thread.currentThread().setContextClassLoader(<span class="keyword">new</span> FileSysLoader(<span class="string">"C:/Person"</span>));</span><br><span class="line">        System.out.println(Thread.currentThread().getContextClassLoader());</span><br><span class="line">        </span><br><span class="line">        Class&lt;LoaderTest&gt; c = (Class&lt;LoaderTest&gt;) Thread.currentThread().getContextClassLoader().loadClass(<span class="string">"com.temp.bytecodeop.Person"</span>);</span><br><span class="line">        System.out.println(c);</span><br><span class="line">        System.out.println(c.getClassLoader());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="服务器类加载器原理和OSGI介绍"><a href="#服务器类加载器原理和OSGI介绍" class="headerlink" title="服务器类加载器原理和OSGI介绍"></a>服务器类加载器原理和OSGI介绍</h2><h3 id="Tomcat服务器的类加载机制"><a href="#Tomcat服务器的类加载机制" class="headerlink" title="Tomcat服务器的类加载机制"></a>Tomcat服务器的类加载机制</h3><p>Tomcat不能使用系统默认的类加载器</p>
<p>如果使用默认类加载器，可以直接操作系统目录，不安全。对于web应用服务器，类加载器的实现方式和一般的Java运用不同。</p>
<p>每个web应用都有一个对应类加载器实例。该类加载器也使用代理模式（不同于双亲模式）所不同的是它首先尝试去加载某个类，如果找不到再代理给父类加载器。这与一般类加载器的顺序是相反的，也是为了保证安全，这样核心库就不在查询范围内。</p>
<p>Tomcat为了安全需要实现自己的类加载器。为每个webapp提供自己的加载器。</p>
<p><img src="https://img.huyunshun.com/img/20200412225008.png" alt="20200412225008"></p>
<h3 id="OSGI"><a href="#OSGI" class="headerlink" title="OSGI"></a>OSGI</h3><p>（Open Service Gateway Initative）是面向Java的动态模块系统，它为开发人员提供了面向服务和基于组件的运行环境，并提供标准的方式用来管理软件的生命周期。</p>
<p>OSGI已经被实现和部署在很多产品上，在开源社区也得到广泛的支持，Eclipse也是基于OSGI技术来构建的。</p>
<p>OSGi 中的每个模块（bundle）都包含 Java 包和类。模块可以声明它所依赖的需要导入（import）的其它模块的 Java 包和类（通过 Import-Package），也可以声明导出（export）自己的包和类，供其它模块使用（通过 Export-Package）。也就是说需要能够隐藏和共享一个模块中的某些 Java 包和类。这是通过 OSGi 特有的类加载器机制来实现的。</p>
<p><strong>OSGi 中的每个模块都有对应的一个类加载器。它负责加载模块自己包含的 Java 包和类。当它需要加载 Java 核心库的类时（以 java开头的包和类），它会代理给父类加载器（通常是启动类加载器）来完成。当它需要加载所导入的 Java 类时，它会代理给导出此 Java 类的模块来完成加载。</strong></p>
<p>模块也可以显式的声明某些 Java 包和类，必须由父类加载器来加载。只需要设置系统属性 org.osgi.framework.bootdelegation的值即可。</p>
<p><strong>OSGi 模块的这种类加载器结构，使得一个类的不同版本可以共存在 Java 虚拟机中，带来了很大的灵活性。</strong></p>
<p>Equinox是OSGI的一个实现框架</p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2017/05/11/java%E6%B3%A8%E8%A7%A3%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/11/java%E6%B3%A8%E8%A7%A3%E4%BB%8B%E7%BB%8D/" itemprop="url">java注解介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-11T00:00:00+08:00">
                2017-05-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Java注解同 classs 和 interface 一样，注解也属于一种类型。它是在 Java SE 5.0 版本中开始引入的概念。</p>
<h2 id="注解的定义"><a href="#注解的定义" class="headerlink" title="注解的定义"></a>注解的定义</h2><p>通过 @interface 关键字进行定义。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> TestAnnotation &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="内置注解"><a href="#内置注解" class="headerlink" title="内置注解"></a>内置注解</h2><p>@Deprecated、@Override、@SuppressWarnings、@SafeVarargs、@FunctionalInterface</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Deprecated 这个元素是用来标记过时的元素，编译器在编译阶段遇到这个注解时会发出提醒警告，告诉开发者正在调用一个过时的元素比如过时的方法、过时的类、过时的成员变量。</span><br><span class="line">@Override 提示子类要复写父类中被 @Override 修饰的方法</span><br><span class="line">@SuppressWarnings阻止警告的意思，把警告取消。</span><br><span class="line">@SafeVarargs参数安全类型注解。它的目的是提醒开发者不要用参数做一些不安全的操作,它的存在会阻止编译器产生 unchecked 这样的警告。它是在 Java 1.7 的版本中加入的。</span><br><span class="line">@FunctionalInterface函数式接口注解，这个是 Java 1.8 版本引入的新特性，函数式编程。</span><br></pre></td></tr></table></figure>
<p>函数式接口 (Functional Interface) 就是一个具有一个方法的普通接口。</p>
<h2 id="元注解"><a href="#元注解" class="headerlink" title="元注解"></a>元注解</h2><p>元注解是可以注解到注解上的注解，或者说元注解是一种基本注解，但是它能够应用到其它的注解上面。</p>
<p>有 @Retention、@Documented、@Target、@Inherited、@Repeatable 5 种。</p>
<h3 id="Retention"><a href="#Retention" class="headerlink" title="@Retention"></a>@Retention</h3><p>当 @Retention 应用到一个注解上的时候，它解释说明了这个注解的的存活时间。<br>它的取值如下： </p>
<pre><code>RetentionPolicy.SOURCE 注解只在源码阶段保留，在编译器进行编译时它将被丢弃忽视。 
RetentionPolicy.CLASS 注解只被保留到编译进行的时候，它并不会被加载到 JVM 中。 
RetentionPolicy.RUNTIME 注解可以保留到程序运行的时候，它会被加载进入到 JVM 中，所以在程序运行时可以获取到它们。</code></pre><h3 id="Documented"><a href="#Documented" class="headerlink" title="@Documented"></a>@Documented</h3><p>它的作用是能够将注解中的元素包含到 Javadoc 中去。</p>
<h3 id="Target"><a href="#Target" class="headerlink" title="@Target"></a>@Target</h3><p>@Target 指定了注解运用的地方。当一个注解被 @Target 注解时，这个注解就被限定了运用的场景。</p>
<pre><code>ElementType.ANNOTATION_TYPE 可以给一个注解进行注解
ElementType.CONSTRUCTOR 可以给构造方法进行注解
ElementType.FIELD 可以给属性进行注解
ElementType.LOCAL_VARIABLE 可以给局部变量进行注解
ElementType.METHOD 可以给方法进行注解
ElementType.PACKAGE 可以给一个包进行注解
ElementType.PARAMETER 可以给一个方法内的参数进行注解
ElementType.TYPE 可以给一个类型进行注解，比如类、接口、枚举</code></pre><h3 id="Inherited"><a href="#Inherited" class="headerlink" title="@Inherited"></a>@Inherited</h3><p>Inherited 是继承的意思，但是它并不是说注解本身可以继承，而是说如果一个类使用了被Inherited标注的注解，那么这个类的子类也继承这个注解。</p>
<h3 id="Repeatable"><a href="#Repeatable" class="headerlink" title="@Repeatable"></a>@Repeatable</h3><p>Repeatable是可重复的意思，注解容器。@Repeatable 是 Java 1.8 才加进来的，所以算是一个新的特性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@interface</span> Persons &#123;</span><br><span class="line">Person[] value();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repeatable</span>(Persons<span class="class">.<span class="keyword">class</span>)//相当于用来保存该注解内容的容器。</span></span><br><span class="line"><span class="class">@<span class="title">interface</span> <span class="title">Person</span></span>&#123;</span><br><span class="line">String role <span class="keyword">default</span> <span class="string">""</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Person</span>(role=<span class="string">"teach"</span>)br/&gt;<span class="meta">@Person</span>(role=<span class="string">"coder"</span>)</span><br><span class="line"><span class="meta">@Person</span>(role=<span class="string">"PM"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Man</span></span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="注解的属性"><a href="#注解的属性" class="headerlink" title="注解的属性"></a>注解的属性</h2><p>注解的属性也叫做成员变量。注解只有成员变量，没有方法。注解的成员变量在注解的定义中以“无形参的方法”形式来声明，其方法名定义了该成员变量的名字，其返回值定义了该成员变量的类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> TestAnnotation &#123;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">id</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TestAnnotation</span>(id=<span class="number">1</span>,value=<span class="string">"xxxxx"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注解中属性可以有默认值，默认值需要用 default 关键值指定。public int id() default -1;</p>
<p>注:</p>
<p>如果一个注解内只有一个属性时，使用注解时可以直接接属性值填写到括号内。<br>如果没有属性，使用的时候可以省略括号。</p>
<h2 id="注解的提取"><a href="#注解的提取" class="headerlink" title="注解的提取"></a>注解的提取</h2><p>一个注解要在运行时被成功提取，那么 @Retention(RetentionPolicy.RUNTIME) 是必须的。</p>
<p>注解通过反射获取。首先可以通过 Class 对象的 isAnnotationPresent() 方法判断它是否应用了某个注解<br>public boolean isAnnotationPresent(Class&lt;? extends Annotation&gt; annotationClass) {}</p>
<p>然后通过 getAnnotation() 方法来获取 Annotation 对象。public <A extends Annotation> A getAnnotation(Class<A> annotationClass) {}</p>
<p>或者是 getAnnotations() 方法。public Annotation[] getAnnotations() {}</p>
<p>前一种方法返回指定类型的注解。</p>
<p>后一种方法返回应用到这个元素上的所有注解。</p>
<p>例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> TestAnnotation &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">id</span><span class="params">()</span> <span class="keyword">default</span> 2</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> "hello"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@TestAnnotation</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">//Class c = Class.forName("com.temp.annotation.AnnotationTest");</span></span><br><span class="line">        <span class="keyword">boolean</span> hasAnnotation = AnnotationTest<span class="class">.<span class="keyword">class</span>.<span class="title">isAnnotationPresent</span>(<span class="title">TestAnnotation</span>.<span class="title">class</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (hasAnnotation ) &#123;</span><br><span class="line">            TestAnnotation testAnnotation = AnnotationTest<span class="class">.<span class="keyword">class</span>.<span class="title">getAnnotation</span>(<span class="title">TestAnnotation</span>.<span class="title">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">            Annotation[] ans = AnnotationTest<span class="class">.<span class="keyword">class</span>.<span class="title">getAnnotations</span>()</span>;</span><br><span class="line"></span><br><span class="line">            System.out.println(ans[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">"id:"</span>+testAnnotation.id());</span><br><span class="line">            System.out.println(<span class="string">"value:"</span>+testAnnotation.value());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@com.temp.annotation.TestAnnotation(value&#x3D;hello, id&#x3D;2)</span><br><span class="line">id:2</span><br><span class="line">value:hello</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2017/05/09/spring-aop/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/09/spring-aop/" itemprop="url">spring AOP</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-09T00:00:00+08:00">
                2017-05-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/spring/" itemprop="url" rel="index">
                    <span itemprop="name">spring</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="面向切面编程（-Aspect-Oriented-Programming）"><a href="#面向切面编程（-Aspect-Oriented-Programming）" class="headerlink" title="面向切面编程（ Aspect Oriented Programming）"></a>面向切面编程（ Aspect Oriented Programming）</h2><pre><code>AOP称为面向切面编程，在程序开发中主要用来解决一些系统层面上的问题，比如日志，事务，权限等待，Struts2的拦截器设计就是基于AOP的思想，是个比较经典的例子。</code></pre><h3 id="AOP的基本概念"><a href="#AOP的基本概念" class="headerlink" title="AOP的基本概念"></a>AOP的基本概念</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(1)Aspect(切面)：通常是一个类，里面可以定义切入点和通知</span><br><span class="line">(2)JointPoint(连接点)：程序执行过程中明确的点，一般是方法的调用</span><br><span class="line">(3)Advice(通知)：AOP在特定的切入点上执行的增强处理</span><br><span class="line">               before（前置通知）在方法执行之前执行</span><br><span class="line">               after（后置通知）在方法执行之后执行</span><br><span class="line">               afterReturning（返回通知）在方法返回结果之后执行</span><br><span class="line">               afterThrowing（异常通知） 在方法抛出异常之后</span><br><span class="line">               around（环绕通知）围绕着方法执行</span><br><span class="line">(4)Pointcut(切入点)：就是带有通知的连接点，在程序中主要体现为书写切入点表达式</span><br><span class="line">(5)AOP代理：AOP框架创建的对象，代理就是目标对象的加强。Spring中的AOP代理可以使JDK动态代理，也可以是CGLIB代理，前者基于接口，后者基于子类</span><br></pre></td></tr></table></figure>
<h3 id="Spring-AOP"><a href="#Spring-AOP" class="headerlink" title="Spring AOP"></a>Spring AOP</h3><pre><code>Spring中的AOP代理还是离不开Spring的IOC容器，代理的生成，管理及其依赖关系都是由IOC容器负责，Spring默认使用JDK动态代理，在需要代理类而不是代理接口的时候，Spring会自动切换为使用CGLIB代理。</code></pre><p>优点：高扩展性；在原有功能相当于释放了部分逻辑，让职责更加明确。</p>
<p>在程序原有纵向执行流程中，针对某一个或某一些方法添加通知，形成横切面过程就叫做面向切面编程。</p>
<p>Spring中常见切面编程概念：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">原有功能：切点pointcut</span><br><span class="line">前置通知：在切点之前执行的功能before advice</span><br><span class="line">后置通知：在切点之后执行的功能after advice</span><br><span class="line">异常通知：如果切点执行过程中出现异常，会触发异常通知throws advice</span><br><span class="line">切面：所有功能总称叫做切面.</span><br><span class="line">织入：把切面嵌入到原有功能的过程叫做织入</span><br></pre></td></tr></table></figure>
<p>Spring 的 AOP 配置元素简化了基于 POJO 切面声明</p>
<p><img src="https://img.huyunshun.com/img/20200407123026.png" alt="20200407123026"></p>
<h3 id="AOP实现方式"><a href="#AOP实现方式" class="headerlink" title="AOP实现方式"></a>AOP实现方式</h3><p>spring 提供了 2 种 AOP 实现方式</p>
<ul>
<li>Schema-based<br>每个通知都需要实现接口或类 配置 spring 配置文件时在&lt;aop:config&gt;配置</li>
<li>AspectJ<br>每个通知不需要实现接口或类，配置 spring 配置文件是在&lt;aop:config&gt;的子标签&lt;aop:aspect&gt;中配置</li>
</ul>
<h4 id="Schema-based实现"><a href="#Schema-based实现" class="headerlink" title="Schema-based实现"></a>Schema-based实现</h4><p>创建前置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBeforeAdvice</span> <span class="keyword">implements</span> <span class="title">MethodBeforeAdvice</span></span>&#123;</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * arg0：切点方法对象Method</span></span><br><span class="line"><span class="comment">        * arg1：切点方法参数</span></span><br><span class="line"><span class="comment">        * arg2：切点在哪个对象中</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(Method arg0, Object[] arg1, Object arg2)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">              System.out.println(<span class="string">"执行前置通知"</span>);               </span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建后置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAfterAdvice</span> <span class="keyword">implements</span> <span class="title">AfterReturningAdvice</span></span>&#123;</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * arg0：切点方法返回值</span></span><br><span class="line"><span class="comment">        * arg1：切点方法对象</span></span><br><span class="line"><span class="comment">        * arg2：切点方法参数</span></span><br><span class="line"><span class="comment">        * arg3：切点方法所在类的对象</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">(Object arg0, Method arg1, Object[] arg2, Object arg3)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">              System.out.println(<span class="string">"执行后置通知"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>切点方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">              System.out.println(<span class="string">"demo01"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo02</span><span class="params">()</span> </span>&#123;</span><br><span class="line">              System.out.println(<span class="string">"demo02"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo03</span><span class="params">()</span> </span>&#123;</span><br><span class="line">              System.out.println(<span class="string">"demo03"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo04</span><span class="params">()</span> </span>&#123;</span><br><span class="line">              System.out.println(<span class="string">"demo04"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置aop：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">      http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">      http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="tag"><span class="string">      http://www.springframework.org/schema/aop/spring-aop.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!-- 配置通知类对象， 在切面中引入 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"mybefore"</span> <span class="attr">class</span>=<span class="string">"com.hu.advice.MyBeforeAdvice"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"myafter"</span> <span class="attr">class</span>=<span class="string">"com.hu.advice.MyAfterAdvice"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!-- 配置切面 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">              <span class="comment">&lt;!-- 配置切点 *通配符 可以比如任意类的任意方法：execution(* com.hu.test.*.*(..)    (..)标识任意参数的方法--&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">expression</span>=<span class="string">"execution(* com.hu.test.Demo.demo02())"</span> <span class="attr">id</span>=<span class="string">"mypoint"</span> /&gt;</span></span><br><span class="line">              <span class="comment">&lt;!-- 引入通知 --&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">"mybefore"</span> <span class="attr">pointcut-ref</span>=<span class="string">"mypoint"</span> /&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">"myafter"</span> <span class="attr">pointcut-ref</span>=<span class="string">"mypoint"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!-- 配置 Demo 类,测试使用 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"demo"</span> <span class="attr">class</span>=<span class="string">"com.hu.test.Demo"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test01</span> </span>&#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">              ApplicationContext ac = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"applicationContext.xml"</span>);</span><br><span class="line">              Demo demo = ac.getBean(<span class="string">"demo"</span>, Demo<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">              demo.demo01();</span><br><span class="line">              demo.demo02();</span><br><span class="line">              demo.demo03();</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="配置异常通知"><a href="#配置异常通知" class="headerlink" title="配置异常通知"></a>配置异常通知</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"mythrow"</span> <span class="attr">class</span>=<span class="string">"com.hu.advice.MyThrowAdvice"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 切点 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">expression</span>=<span class="string">"execution(* com.hu.test.Demo.demo02())"</span> <span class="attr">id</span>=<span class="string">"mypoint"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">"mythrow"</span> <span class="attr">pointcut-ref</span>=<span class="string">"mypoint"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 配置 Demo 类,测试使用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"demo"</span> <span class="attr">class</span>=<span class="string">"com.hu.test.Demo"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThrowAdvice</span> <span class="keyword">implements</span> <span class="title">ThrowsAdvice</span></span>&#123;</span><br><span class="line">      <span class="comment">//参数：Method m, Object[] args,        Object target, Exception ex</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">(Exception ex)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">              System.out.println(<span class="string">"执行异常通过-schema-base 方式"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>切点方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo02</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">int</span> a=<span class="number">3</span>/<span class="number">0</span>;</span><br><span class="line">        System.out.println(<span class="string">"demo02"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="环绕通知"><a href="#环绕通知" class="headerlink" title="环绕通知"></a>环绕通知</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyArround</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span></span>&#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(MethodInvocation arg0)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">              System.out.println(<span class="string">"环绕-前置"</span>);</span><br><span class="line">              Object result = arg0.proceed();<span class="comment">//放行，调用切点方式</span></span><br><span class="line">              System.out.println(<span class="string">"环绕-后置"</span>);</span><br><span class="line">              <span class="keyword">return</span> result;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"myarround"</span> <span class="attr">class</span>=<span class="string">"com.hu.advice.MyArround"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">      </span><br><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 切点 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">expression</span>=<span class="string">"execution(* com.hu.test.Demo.demo02())"</span> <span class="attr">id</span>=<span class="string">"mypoint"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">"myarround"</span> <span class="attr">pointcut-ref</span>=<span class="string">"mypoint"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 配置 Demo 类,测试使用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"demo"</span> <span class="attr">class</span>=<span class="string">"com.hu.test.Demo"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>切点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">              System.out.println(<span class="string">"demo01"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo02</span><span class="params">()</span> </span>&#123;</span><br><span class="line">              System.out.println(<span class="string">"demo02"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo03</span><span class="params">()</span> </span>&#123;</span><br><span class="line">              System.out.println(<span class="string">"demo03"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo04</span><span class="params">()</span> </span>&#123;</span><br><span class="line">              System.out.println(<span class="string">"demo04"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="AspectJ方式实现"><a href="#AspectJ方式实现" class="headerlink" title="AspectJ方式实现"></a>AspectJ方式实现</h4><p>对通知类没有严格的要求，直接配置使用：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"myafter"</span> <span class="attr">class</span>=<span class="string">"com.hu.advice.MyAfterAdvice"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">"myafter"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">expression</span>=<span class="string">"execution(* com.hu.test.Demo.demo02())"</span> <span class="attr">id</span>=<span class="string">"mypoint"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">aop:after</span> <span class="attr">method</span>=<span class="string">"after"</span> <span class="attr">pointcut-ref</span>=<span class="string">"mypoint"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 配置 Demo 类,测试使用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"demo"</span> <span class="attr">class</span>=<span class="string">"com.hu.test.Demo"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="配置通知异常"><a href="#配置通知异常" class="headerlink" title="配置通知异常"></a>配置通知异常</h5><ol>
<li><p>只有当切点报异常才能触发异常通知</p>
</li>
<li><p>在 spring 中有 AspectJ 方式提供了异常通知的办法。</p>
</li>
</ol>
<p>配置信息：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"mythrow"</span> <span class="attr">class</span>=<span class="string">"com.hu.advice.MyThrowAdvice"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 配置切面 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 切点 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">"mythrow"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">expression</span>=<span class="string">"execution(* com.hu.test.Demo.demo02())"</span> <span class="attr">id</span>=<span class="string">"mypoint"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">aop:after-throwing</span> <span class="attr">method</span>=<span class="string">"myException"</span> <span class="attr">pointcut-ref</span>=<span class="string">"mypoint"</span> <span class="attr">throwing</span>=<span class="string">"e"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 配置 Demo 类,测试使用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"demo"</span> <span class="attr">class</span>=<span class="string">"com.hu.test.Demo"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>异常通知类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThrowAdvice</span> </span>&#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">myException</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">              System.out.println(<span class="string">"执行异常通知"</span>+e.getMessage());</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>切点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">              System.out.println(<span class="string">"demo01"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo02</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">              <span class="keyword">int</span> a=<span class="number">3</span>/<span class="number">0</span>;</span><br><span class="line">              System.out.println(<span class="string">"demo02"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo03</span><span class="params">()</span> </span>&#123;</span><br><span class="line">              System.out.println(<span class="string">"demo03"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo04</span><span class="params">()</span> </span>&#123;</span><br><span class="line">              System.out.println(<span class="string">"demo04"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ApplicationContext ac = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"applicationContext.xml"</span>);</span><br><span class="line">        Demo demo = ac.getBean(<span class="string">"demo"</span>, Demo<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        demo.demo01();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">                demo.demo02();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">//e.printStackTrace();</span></span><br><span class="line">        &#125;</span><br><span class="line">        demo.demo03();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="环绕通知-1"><a href="#环绕通知-1" class="headerlink" title="环绕通知"></a>环绕通知</h5><p>通知类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAdvice</span> </span>&#123;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>&#123;</span><br><span class="line">           System.out.println(<span class="string">"before"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>&#123;</span><br><span class="line">           System.out.println(<span class="string">"after"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">()</span></span>&#123;</span><br><span class="line">           System.out.println(<span class="string">"afterReturning Advice"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">()</span></span>&#123;</span><br><span class="line">           System.out.println(<span class="string">"afterThrowing Advice"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> Object <span class="title">around</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">           Object result=<span class="keyword">null</span>;</span><br><span class="line">               System.out.println(<span class="string">"环绕-前置"</span>);</span><br><span class="line">               result = pjp.proceed();<span class="comment">//放行，调用切点方式</span></span><br><span class="line">               System.out.println(<span class="string">"环绕-后置"</span>);</span><br><span class="line">           <span class="keyword">return</span> result;</span><br><span class="line">       &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/aop/spring-aop.xsd"</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"myadvice"</span> <span class="attr">class</span>=<span class="string">"com.hu.advice.MyAdvice"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">"myadvice"</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">expression</span>=<span class="string">"execution(* com.hu.test.Demo.demo02())"</span> <span class="attr">id</span>=<span class="string">"mypoint"</span>/&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">aop:after</span> <span class="attr">method</span>=<span class="string">"after"</span> <span class="attr">pointcut-ref</span>=<span class="string">"mypoint"</span>/&gt;</span></span><br><span class="line">                       <span class="comment">&lt;!-- afterReturning和after类似，执行顺序与这里的顺序有关，但是当切点方法执行异常将不会执行afterReturning --&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">aop:after-returning</span> <span class="attr">method</span>=<span class="string">"afterReturning"</span> <span class="attr">pointcut-ref</span>=<span class="string">"mypoint"</span>/&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">"before"</span> <span class="attr">pointcut-ref</span>=<span class="string">"mypoint"</span>/&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">aop:around</span> <span class="attr">method</span>=<span class="string">"around"</span> <span class="attr">pointcut-ref</span>=<span class="string">"mypoint"</span>/&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">aop:after-throwing</span> <span class="attr">method</span>=<span class="string">"afterThrowing"</span> <span class="attr">pointcut-ref</span>=<span class="string">"mypoint"</span>/&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- 配置 Demo 类,测试使用 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"demo"</span> <span class="attr">class</span>=<span class="string">"com.hu.test.Demo"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br><span class="line">```java</span><br><span class="line">测试：</span><br><span class="line">```java</span><br><span class="line">public class Test01 &#123;</span><br><span class="line">       public static void main(String[] args) &#123;</span><br><span class="line">               ApplicationContext ac = new ClassPathXmlApplicationContext("applicationContext.xml");</span><br><span class="line">               Demo demo = ac.getBean("demo", Demo.class);</span><br><span class="line">               demo.demo01();</span><br><span class="line">               demo.demo02();</span><br><span class="line">               demo.demo03();</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="expression规则"><a href="#expression规则" class="headerlink" title="expression规则"></a>expression规则</h4><p>“aop:pointcut”标签中”expression”的写法规则如下:</p>
<p>execution(modifiers-pattern? ret-type-pattern declaring-type-pattern? name-pattern(param-pattern)  throws-pattern?)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">　　　　ret-type-pattern,name-pattern(param-pattern)是必须的.</span><br><span class="line">　　　　ret-type-pattern:标识方法的返回值，需要使用全路径的类名如java.lang.String,也可以为*表示任何返回值；</span><br><span class="line">　　　　name-pattern:指定方法名,*代表所有,例如set*,代表以set开头的所有方法.</span><br><span class="line">　　　　param-pattern:指定方法参数(声明的类型),(..)代表所有参数,(*)代表一个参数,(*,String)代表第一个参数为任何值,第二个为String类型.</span><br></pre></td></tr></table></figure>
<p>表达式例子如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">　　任意公共方法的执行：</span><br><span class="line">　　　　execution(public * *(..))</span><br><span class="line">　　任何一个以&quot;set&quot;开始的方法的执行：</span><br><span class="line">　　　　execution(* set*(..))</span><br><span class="line">　　AccountService 接口的任意方法的执行：</span><br><span class="line">　　　　execution(* com.xyz.service.AccountService.*(..))</span><br><span class="line">　　定义在service包里的任意方法的执行：</span><br><span class="line">　　　　execution(* com.xyz.service.*.*(..))</span><br><span class="line">　　定义在service包和所有子包里的任意类的任意方法的执行：</span><br><span class="line">　　　　execution(* com.xyz.service..*.*(..))</span><br><span class="line">　　定义在pointcutexp包和所有子包里的JoinPointObjP2类的任意方法的执行：</span><br><span class="line">　　　　execution(* com.test.spring.aop.pointcutexp..JoinPointObjP2.*(..))&quot;)</span><br></pre></td></tr></table></figure>
<p>在多个表达式之间使用 ||,or表示 或，使用 &amp;&amp;,and表示 与，！表示 非.例如：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span>   　　　　</span><br><span class="line"><span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"pointcut"</span> <span class="attr">expression</span>=<span class="string">"(execution(* com.ccboy.dao..*.find*(..))) or (execution(* com.ccboy.dao..*.query*(..)))"</span>/&gt;</span>   　　　　</span><br><span class="line"><span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">"jdbcInterceptor"</span> <span class="attr">pointcut-ref</span>=<span class="string">"pointcut"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="使用注解（基于Aspect）实现AOP"><a href="#使用注解（基于Aspect）实现AOP" class="headerlink" title="使用注解（基于Aspect）实现AOP"></a>使用注解（基于Aspect）实现AOP</h4><p>使用注解实现AOP，它基于Aspect方式实现的。spring 不会自动去寻找注解，必须告诉 spring 哪些包下的类中可能有注解。扫描注解：引入xmlns:context。</p>
<p>配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 告诉spring哪些包下有注解 ，spring才会去扫描注解。--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.hu.advice,com.hu.test"</span>&gt;</span><span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- true 使用cglib动态代理       false 使用jdk动态代理 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span> <span class="attr">proxy-target-class</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">aop:aspectj-autoproxy</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>通知：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@Aspect</span> 相当于&lt;aop:aspect/&gt;表示通知方法在当前类中</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAdvice</span> </span>&#123;</span><br><span class="line">       <span class="meta">@Before</span>(value=<span class="string">"com.hu.test.Demo.demo02(name,id)"</span>,argNames=<span class="string">"name,id"</span>)</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(String name, <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">               System.out.println(<span class="string">"before--name: "</span> + name + <span class="string">" id: "</span> + id);</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>切点方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*        使用spring注解</span></span><br><span class="line"><span class="comment">*        相当于配置的&lt;bean&gt;标签</span></span><br><span class="line"><span class="comment">*        默认名字是类名的首字母小写。</span></span><br><span class="line"><span class="comment">*        也可以自定义名字<span class="doctag">@Component</span>(value="demo12")</span></span><br><span class="line"><span class="comment">*        或者省略value:<span class="doctag">@Component</span>("demo12")</span></span><br><span class="line"><span class="comment">*        不配置参数，默认是类名的首字母小写。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 配置切点方法</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="meta">@Pointcut</span>(value=<span class="string">"execution(* com.hu.test.Demo.demo02(..)) &amp;&amp; args(name,id)"</span>)</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo02</span><span class="params">(String name,<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">               System.out.println(<span class="string">"demo02--name: "</span>+name+<span class="string">" id: "</span>+id);</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test01</span> </span>&#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">               ApplicationContext ac = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"applicationContext.xml"</span>);</span><br><span class="line">               Demo demo = ac.getBean(<span class="string">"demo"</span>, Demo<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">               demo.demo02(<span class="string">"huang xiao ming"</span>,<span class="number">1</span>);</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h2><p>代理设计模式的优点：保护真实对象，让真实对象职责更明确，可以更好的扩展应用程序。</p>
<p>代理设计模式有两种：静态代理和动态代理。</p>
<p>静态代理<br>         * 由代理对象代理所有真实对象的功能，需要自己编写代理类，每个代理的功能需要单独编写。<br>         * 缺点：当代理功能比较多时，代理类中方法需要写很多。</p>
<p>动态代理<br>        *为了解决静态代理频繁编写代理功能的缺点而产生动态代理。</p>
<p>动态代理分为两种：JDK动态代理和cglib动态代理。两种代理方式各有优缺点。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">JDK动态代理：</span><br><span class="line">       优点：jdk 自带，不需要额外导入 jar</span><br><span class="line">       缺点：真实对象必须实现接口，利用反射机制，效率不高。</span><br><span class="line">使用 JDK 动态代理时可能出现ClassCastException异常，出现原因：希望把接口对象转换为具体真实对象。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cglib动态代理：</span><br><span class="line">优点：</span><br><span class="line"></span><br><span class="line">基于字节码，生成真实对象的子类。</span><br><span class="line">运行效率高于 JDK 动态代理，不需要实现接口。</span><br><span class="line"></span><br><span class="line">缺点：</span><br><span class="line">       非 JDK 功能，需要额外导入 jar（cglib-2.2.2.jar&#x2F;asm-3.3.1.jar）</span><br></pre></td></tr></table></figure>

























          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2017/05/09/spring%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/09/spring%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86/" itemprop="url">spring事务管理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-09T00:00:00+08:00">
                2017-05-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/spring/" itemprop="url" rel="index">
                    <span itemprop="name">spring</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>事务分为两种：声明式事务和编程式事务</p>
<p><strong>编程式事务</strong></p>
<p>由程序员编程事务控制代码； OpenSessionInView 编程式事务都是编程式事务。</p>
<p>所谓编程式事务指的是通过编码方式实现事务，允许用户在代码中精确定义事务的边界。即类似于JDBC编程实现事务管理。管理使用TransactionTemplate或者直接使用底层的PlatformTransactionManager。对于编程式事务管理，spring推荐使用TransactionTemplate。</p>
<p><strong>声明式事务</strong></p>
<pre><code>管理建立在AOP之上的。其本质是对方法前后进行拦截，然后在目标方法开始之前创建或者加入一个事务，在执行完目标方法之后根据执行情况提交或者回滚事务。声明式事务最大的优点就是不需要通过编程的方式管理事务，这样就不需要在业务逻辑代码中掺杂事务管理的代码，只需在配置文件中做相关的事务规则声明(或通过基于@Transactional注解的方式)，便可以将事务规则应用到业务逻辑中。</code></pre><p>简单地说，编程式事务侵入到了业务代码里面，但是提供了更加详细的事务管理；而声明式事务由于基于AOP，所以既能起到事务管理的作用，又可以不影响业务代码的具体实现。</p>
<h5 id="Spring编程式事务"><a href="#Spring编程式事务" class="headerlink" title="Spring编程式事务"></a>Spring编程式事务</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 创建模板 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionTemplate"</span> <span class="attr">class</span>=<span class="string">"org.springframework.transaction.support.TransactionTemplate"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"transactionManager"</span> <span class="attr">ref</span>=<span class="string">"txManager"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 配置事务管理器 ,管理器需要事务，事务从Connection获得，连接从连接池DataSource获得 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"txManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Service中声明属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> TransactionTemplate transactionTemplate;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(<span class="keyword">final</span> String outer,<span class="keyword">final</span> String inner,<span class="keyword">final</span> <span class="keyword">int</span> money)</span> </span>&#123;</span><br><span class="line">       transactionTemplate.execute(<span class="keyword">new</span> TransactionCallbackWithoutResult() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doInTransactionWithoutResult</span><span class="params">(TransactionStatus arg0)</span> </span>&#123;</span><br><span class="line">               accountDao.out(outer, money);</span><br><span class="line">               <span class="comment">//int i = 1/0;</span></span><br><span class="line">               accountDao.in(inner, money);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h5 id="Spring声明式事务"><a href="#Spring声明式事务" class="headerlink" title="Spring声明式事务"></a>Spring声明式事务</h5><pre><code>事务控制代码已经由 spring写好，程序员只需要声明出哪些方法需要进行事务控制和如何进行事务控制。声明式事务都是针对于 ServiceImpl 类下方法的，事务管理基于AOP通知（advice）。</code></pre><p>实现细节：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/aop/spring-aop.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">   http://www.springframework.org/schema/tx</span></span></span><br><span class="line"><span class="tag"><span class="string">   http://www.springframework.org/schema/tx/spring-tx.xsd"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">default-autowire</span>=<span class="string">"byName"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">&lt;!-- 加载properties文件  如果加载多个文件，后面用逗号分隔开 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">"classpath:db.properties"</span>/&gt;</span></span><br><span class="line">       </span><br><span class="line">       <span class="comment">&lt;!-- 扫描注解 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.hu.pojo"</span>&gt;</span><span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line">       </span><br><span class="line">       <span class="comment">&lt;!-- true 使用cglib动态代理       false 使用jdk动态代理 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span> <span class="attr">proxy-target-class</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">aop:aspectj-autoproxy</span>&gt;</span></span><br><span class="line">       </span><br><span class="line">       <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.driver&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.url&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.username&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.password&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"factory"</span> <span class="attr">class</span>=<span class="string">"org.mybatis.spring.SqlSessionFactoryBean"</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"typeAliasesPackage"</span> <span class="attr">value</span>=<span class="string">"com.hu.pojo"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">       </span><br><span class="line">       <span class="comment">&lt;!-- 扫描器  --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.mybatis.spring.mapper.MapperScannerConfigurer"</span>&gt;</span></span><br><span class="line">               <span class="comment">&lt;!-- 要扫描 mapper接口 --&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"basePackage"</span> <span class="attr">value</span>=<span class="string">"com.hu.mapper"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sqlSessionFactoryBeanName"</span> <span class="attr">value</span>=<span class="string">"factory"</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- 事务管理在 spring-jdbc-*.jar 中 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"txManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- 配置声明式事务 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">"txAdvice"</span> <span class="attr">transaction-manager</span>=<span class="string">"txManager"</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">                       <span class="comment">&lt;!-- 哪些方法需要有事务控制 使用通配符 方法以 ins 开头事务管理 --&gt;</span></span><br><span class="line">                       <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">                               事务控制属性解析：</span></span><br><span class="line"><span class="comment">                               1、name="" 是哪些方法需要事务控制，支持*通配符</span></span><br><span class="line"><span class="comment">                               2、read-only="" 设置事务是否是只读事务，默认值是false。</span></span><br><span class="line"><span class="comment">                                               true告诉数据库此事务为只读事务，会对性能有一定提升，所以只要是查询的方法，建议使用true。</span></span><br><span class="line"><span class="comment">                                               false（默认值），事务需要提交的事务，建议新增/删除/修改使用。</span></span><br><span class="line"><span class="comment">                                3、propagation="" 控制事务传播行为。</span></span><br><span class="line"><span class="comment">                                        当一个具有事务控制的方法被另一个有事务控制的方法调用后，需要如何管理事务(新建事务、在事务中执行、把事务挂起、报异常？)</span></span><br><span class="line"><span class="comment">                                        REQUIRED（默认值）：如果当前有事务，就在事务中执行；如果当前没有事务，新建一个事务。</span></span><br><span class="line"><span class="comment">                                        SUPPORTS：如果当前有事务就在事务中执行，如果当前没有事务，就在非事务状态下执行。</span></span><br><span class="line"><span class="comment">                                        MANDATORY:必须在事务内部执行，如果当前有事务，就在事务中执行，如果没有事务就会报异常。</span></span><br><span class="line"><span class="comment">                                        REQUIRES_NEW：必须在事务中执行，如果当前没有事务，新建事务；如果当前有事务，把当前事务挂起。</span></span><br><span class="line"><span class="comment">                                        NOT_SUPPORTED：必须在非事务下执行，如果当前没有事务，正常执行；如果当前有事务，把当前事务挂起。</span></span><br><span class="line"><span class="comment">                                        NEVER：必须在非事务状态下执行，如果当前没有事务，正常执行；如果当前有事务就会报异常。</span></span><br><span class="line"><span class="comment">                                        NESTED：必须在事务状态下执行，如果没有事务，新建事务；如果当前有事务，创建一个嵌套事务。</span></span><br><span class="line"><span class="comment">                                4、isolation="" 事务隔离级别。</span></span><br><span class="line"><span class="comment">                                        数据完整性：脏读、不可重复读、幻读。</span></span><br><span class="line"><span class="comment">                                        脏读：一个事务读取到另一个事务中未提交的数据，此时事务读取的数据可能和数据库中数据不一致，此时认为数据是脏数据，读取脏数据过程叫脏读。</span></span><br><span class="line"><span class="comment">                                        不可重复读：主要针对的是某行或某列数据。当一个事务第一次读取后，另一个事务对当前事务读取的数据进行修改，当前事务再次读取数据和之前读取的数据不一致。</span></span><br><span class="line"><span class="comment">                                        幻读：主要针对新增或删除数据。一个事务按照特定条件查询出结果，另一个事务新增了一条符合条件的数据，此时当前事务中查询的数据和数据库中的数据不一致，当前事务好像出现了幻觉。</span></span><br><span class="line"><span class="comment">                                        </span></span><br><span class="line"><span class="comment">                                         DEFAULT: 默认值，由底层数据库自动判断应该使用什么隔离级别。</span></span><br><span class="line"><span class="comment">                                         READ_UNCOMMITTED: 可以读取未提交数据，可能出现脏读，不重复读，幻读。效率最高</span></span><br><span class="line"><span class="comment">                                         READ_COMMITTED：只能读取其他事务已提交数据，可以防止脏读，但是可能出现不可重复读和幻读。</span></span><br><span class="line"><span class="comment">                                         REPEATABLE_READ: 读取的数据被添加锁，防止其他事务修改此数据，可以防止不可重复读，脏读，但是可能出现幻读。（记录级别）</span></span><br><span class="line"><span class="comment">                                         SERIALIZABLE: 对整个表添加锁，一个事务在操作数据时，另一个事务等待事务操作完成后才能操作这个表。（表级别）</span></span><br><span class="line"><span class="comment">                                                                          这种级别最安全的但也是 效率最低。.</span></span><br><span class="line"><span class="comment">                                5、rollback-for="" 回滚事务，当出现什么异常（如：java.lang.Exception）时回滚。（注意：手动抛出异常一定要给定该属性值）</span></span><br><span class="line"><span class="comment">                                6、no-rollback-for="" 当出现什么异常时不滚回事务。</span></span><br><span class="line"><span class="comment">                        --&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"insert*"</span> /&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"delete*"</span> /&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"update*"</span> /&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"*"</span> <span class="attr">read-only</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">               <span class="comment">&lt;!-- spring事务管理是以AOP的方式，切点范围设置 一般事务都是在service中处理--&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">expression</span>=<span class="string">"execution(* com.hu.service.impl.*.*(..))"</span> <span class="attr">id</span>=<span class="string">"mypoint"</span> /&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">"txAdvice"</span> <span class="attr">pointcut-ref</span>=<span class="string">"mypoint"</span> /&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>控制事务传播行为：</p>
<p>当一个具有事务控制的方法被另一个有事务控制的方法调用后，需要如何管理事务(新建事务、在事务中执行、把事务挂起、报异常？)</p>
<ul>
<li>REQUIRED（默认值）：如果当前有事务，就在事务中执行；如果当前没有事务，新建一个事务。</li>
<li>SUPPORTS：如果当前有事务就在事务中执行，如果当前没有事务，就在非事务状态下执行。</li>
<li>MANDATORY:必须在事务内部执行，如果当前有事务，就在事务中执行，如果没有事务就会报异常。</li>
<li>REQUIRES_NEW：必须在事务中执行，如果当前没有事务，新建事务；如果当前有事务，把当前事务挂起。</li>
<li>NOT_SUPPORTED：必须在非事务下执行，如果当前没有事务，正常执行；如果当前有事务，把当前事务挂起。</li>
<li>NEVER：必须在非事务状态下执行，如果当前没有事务，正常执行；如果当前有事务就会报异常。</li>
<li>NESTED：必须在事务状态下执行，如果没有事务，新建事务；如果当前有事务，创建一个嵌套事务。</li>
</ul>
<p>事务隔离级别：</p>
<p>数据完整性：脏读、不可重复读、幻读。</p>
<ul>
<li>脏读：一个事务读取到另一个事务中未提交的数据，此时事务读取的数据可能和数据库中数据不一致，此时认为数据是脏数据，读取脏数据过程叫脏读。</li>
<li>不可重复读：主要针对的是某行或某列数据。当一个事务第一次读取后，另一个事务对当前事务读取的数据进行修改，当前事务再次读取数据和之前读取的数据不一致。</li>
<li>幻读：主要针对新增或删除数据。一个事务按照特定条件查询出结果，另一个事务新增了一条符合条件的数据，此时当前事务中查询的数据和数据库中的数据不一致，当前事务好像出现了幻觉。</li>
</ul>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2017/05/09/spring%20mvc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/09/spring%20mvc/" itemprop="url">spring mvc</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-09T00:00:00+08:00">
                2017-05-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/spring/" itemprop="url" rel="index">
                    <span itemprop="name">spring</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Spring Web MVC是基于Servlet API构建的原始Web框架，从一开始就包含在Spring Framework中。正式名称”Spring Web MVC”来自其源模块（spring-webmvc）的名称，但它通常被称为”Spring MVC”。</p>
<p>Spring MVC 是一个模型 - 视图 - 控制器（MVC）的Web框架建立在中央前端控制器servlet（DispatcherServlet），它负责发送每个请求到合适的处理程序，使用视图来最终返回响应结果的概念。Spring MVC 是 Spring 产品组合的一部分，它享有 Spring IoC容器紧密结合Spring松耦合等特点，因此它有Spring的所有优点。</p>
<h2 id="框架运行原理特点"><a href="#框架运行原理特点" class="headerlink" title="框架运行原理特点"></a>框架运行原理特点</h2><p>SpringMVC架构图所下所示</p>
<p><img src="https://img.huyunshun.com/img/20200410153217.png" alt="20200410153217"></p>
<p><img src="https://img.huyunshun.com/img/20200410153312.png" alt="20200410153312"></p>
<h3 id="Spring-Web-MVC框架特点"><a href="#Spring-Web-MVC框架特点" class="headerlink" title="Spring Web MVC框架特点"></a>Spring Web MVC框架特点</h3><p>清晰的角色划分：控制器（controller）、验证器（validator）、 命令对象（command object）、表单对象（form object）、模型对象（model object）、 Servlet分发器（DispatcherServlet）、 处理器映射（handler mapping）、视图解析器（view resolver）等等。 每一个角色都可以由一个专门的对象来实现。</p>
<h3 id="Spring-MVC大致的执行流程如下"><a href="#Spring-MVC大致的执行流程如下" class="headerlink" title="Spring MVC大致的执行流程如下"></a>Spring MVC大致的执行流程如下</h3><ul>
<li>1、首先浏览器发送请求给前端控制器DispatcherServlet，DispatcherSerlvet根据请求信息，基于一定的原则选择合适的控制器进行处理并把 请求委托给它。</li>
<li>2、页面控制器接收到请求之后进行功能处理，首先需要收集、绑定请求参数到一个对象(命令对象)，并进行验证，然后将该对象委托给业务对象进行处理(service层)；业务对象处理之后控制器将返回一个ModelAndView(模型数据和逻辑视图名)；</li>
<li>3、DispatcherServlet根据返回的逻辑视图名，选择合适的视图进行渲染(界面展示、资源加载)，并把模型数据传入以便视图渲染。</li>
<li>4、前端控制器将响应返回个客户端浏览器。</li>
</ul>
<h4 id="主要类"><a href="#主要类" class="headerlink" title="主要类"></a>主要类</h4><p><strong>HandlerMapping</strong></p>
<p>将请求映射到处理程序以及用于预处理和后处理的拦截器列表 。映射基于某些标准，其细节因HandlerMapping 实施而异。</p>
<p>两个主要HandlerMapping实现RequestMappingHandlerMapping（支持带@RequestMapping注释的方法）和SimpleUrlHandlerMapping（维护URI路径模式到处理程序的显式注册）。</p>
<p><strong>HandlerAdapter</strong></p>
<p>DispatcherServlet无论实际调用处理程序如何，都可以帮助调用映射到请求的处理程序。例如，调用带注释的控制器需要解析注释。主要目是保护DispatcherServlet这些细节。</p>
<p><strong>ViewResolver</strong></p>
<p>将从处理程序返回的基于逻辑的视图名称解析为View 用于呈现给响应的实际视图。</p>
<h4 id="主要组件"><a href="#主要组件" class="headerlink" title="主要组件"></a>主要组件</h4><ul>
<li>1、DispatcherServlet：前端控制器，接收所有请求。</li>
<li>2、HandlerMapping：解析请求格式的，判断希望要执行哪个具体的方法。</li>
<li>3、HandlerAdapter：负责调用具体的方法。</li>
<li>4、ViewResovler：视图解析器，解析结果，准备跳转到具体的物理视图。</li>
</ul>
<h2 id="Spring-容器和-SpringMVC-容器的关系"><a href="#Spring-容器和-SpringMVC-容器的关系" class="headerlink" title="Spring 容器和 SpringMVC 容器的关系"></a>Spring 容器和 SpringMVC 容器的关系</h2><p><img src="https://img.huyunshun.com/img/20200410153705.png" alt="20200410153705"></p>
<p>从源码可以知道：Spring 容器和 SpringMVC 容器是父子容器，SpringMVC 容器中能够调用 Spring 容器的所有内容。</p>
<p><strong>运行原理</strong></p>
<p>当用户发起请求 , 请求 一个控制器 , 首先会执行DispatcherServlet；由DispatcherServlet 调 用 HandlerMapping 的DefaultAnnotationHandlerMapping 解析URL；解析后调用HandlerAdatper 组 件 的 AnnotationMethodHandlerAdapter；调用Controller中的 HandlerMethod，当 HandlerMethod 执行完成后会返回View，会被 ViewResovler 进行视图解析，解析后调用 jsp 对应的class 文件并运行,最终把运行class 文件的结果响应给客户端。</p>
<h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p>配置启动入口web.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">version</span>=<span class="string">"3.0"</span> <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/javaee                      </span></span></span><br><span class="line"><span class="tag"><span class="string">        http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 修改配置文件路径和名称,默认在 WEB-INF下，springmvc-servlet.xml--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:springmvc.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 自启动, 优先级，tomacat启动时启动servlet--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置spring mvc</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"demo"</span> <span class="attr">class</span>=<span class="string">"com.hu.controller.DemoController"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span>  <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.handler.SimpleUrlHandlerMapping"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"urlMap"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">                            <span class="comment">&lt;!-- 解析出来控制器逻辑名 --&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"demo"</span> <span class="attr">value-ref</span>=<span class="string">"demo"</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- SimpleControllerHandlerAdapter 可以执行 Controller 类型的 Handler --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.mvc.SimpleControllerHandlerAdapter"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置视图解析器 把Controller方法返回的视图解析为实际视图  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"viewResolver"</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefix"</span> <span class="attr">value</span>=<span class="string">"/"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suffix"</span> <span class="attr">value</span>=<span class="string">".jsp"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:mvc</span>=<span class="string">"http://www.springframework.org/schema/mvc"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/mvc</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/mvc/spring-mvc.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          <span class="comment">&lt;!-- 配置自动扫描注解的包 --&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.hu.controller"</span>&gt;</span><span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 注解驱动  相当于配置了HandlerMapping和HandlerAdapter</span></span><br><span class="line"><span class="comment">                因为使用的是注解，所以相当于省略配置下面两个，直接使用&lt;mvc:annotation-driven&gt;&lt;/mvc:annotation-driven&gt;--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>&gt;</span><span class="tag">&lt;/<span class="name">mvc:annotation-driven</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--ViewResolver    静态资源处理 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:resources</span> <span class="attr">location</span>=<span class="string">"/js/"</span> <span class="attr">mapping</span>=<span class="string">"/js/**"</span>&gt;</span><span class="tag">&lt;/<span class="name">mvc:resources</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--/css/** 根目录下css下所有子文件及其文件  --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:resources</span> <span class="attr">location</span>=<span class="string">"/css/"</span> <span class="attr">mapping</span>=<span class="string">"/css/**"</span>&gt;</span><span class="tag">&lt;/<span class="name">mvc:resources</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:resources</span> <span class="attr">location</span>=<span class="string">"/images/"</span> <span class="attr">mapping</span>=<span class="string">"/images/**"</span>&gt;</span><span class="tag">&lt;/<span class="name">mvc:resources</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>测试controller和jsp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public class DemoController implements Controller &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public ModelAndView handleRequest(HttpServletRequest request, HttpServletResponse response) throws Exception &#123;</span><br><span class="line">                ModelAndView mav &#x3D; new ModelAndView(&quot;index&quot;);</span><br><span class="line">                return mav;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;%@ page language&#x3D;&quot;java&quot; contentType&#x3D;&quot;text&#x2F;html; charset&#x3D;UTF-8&quot;</span><br><span class="line">    pageEncoding&#x3D;&quot;UTF-8&quot;%&gt;</span><br><span class="line">&lt;!DOCTYPE html PUBLIC &quot;-&#x2F;&#x2F;W3C&#x2F;&#x2F;DTD HTML 4.01 Transitional&#x2F;&#x2F;EN&quot; &quot;http:&#x2F;&#x2F;www.w3.org&#x2F;TR&#x2F;html4&#x2F;loose.dtd&quot;&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv&#x3D;&quot;Content-Type&quot; content&#x3D;&quot;text&#x2F;html; charset&#x3D;UTF-8&quot;&gt;</span><br><span class="line">&lt;title&gt;Insert title here&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">index.jsp</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line"></span><br><span class="line">@Controller</span><br><span class="line">public class HelloController &#123;</span><br><span class="line">        @RequestMapping(&quot;&#x2F;hello&quot;)</span><br><span class="line">        public String helloWord() &#123;</span><br><span class="line">                System.out.println(&quot;hello word&quot;);</span><br><span class="line">                return &quot;index.jsp&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行过程：</p>
<p><img src="https://img.huyunshun.com/img/20200410161856.png" alt="20200410161856"></p>
<h2 id="参数传递"><a href="#参数传递" class="headerlink" title="参数传递"></a>参数传递</h2><p>前台提交表单，SpringMVC 只要有这个内容，就会自动注入内容，HandMethod参数中直接接收参数就行。</p>
<h3 id="1、基本数据类型参数传递"><a href="#1、基本数据类型参数传递" class="headerlink" title="1、基本数据类型参数传递"></a>1、基本数据类型参数传递</h3><p>A、默认保证参数名称和请求中传递的参数名相同，直接能获取到。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">helloWord</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"hello word"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"index.jsp"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>B、 如果请求参数名和方法参数名不对应使用@RequestParam()赋值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">helloWord</span><span class="params">(@RequestParam(value=<span class="string">"name1"</span>)</span>String name, @<span class="title">RequestParam</span><span class="params">(value=<span class="string">"age1"</span>)</span><span class="keyword">int</span> age) </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"hello word"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"index.jsp"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>C、如果方法参数是基本数据类型(不是封装类)可以通过@RequestParam 设置默认初值，防止出现错误，没有参数时 500</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">helloWord</span><span class="params">(@RequestParam(defaultValue=<span class="string">"张三"</span>)</span>String name, @<span class="title">RequestParam</span><span class="params">(defaultValue=<span class="string">"12"</span>)</span><span class="keyword">int</span> age) </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"hello word"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"index.jsp"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>D、如果强制要求必须有某个参数。@RequestParam(required=true)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">helloWord</span><span class="params">(@RequestParam(required=<span class="keyword">true</span>)</span>String name, @<span class="title">RequestParam</span><span class="params">(defaultValue=<span class="string">"12"</span>)</span><span class="keyword">int</span> age) </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"hello word"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"index.jsp"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2、HandlerMethod-中参数是对象类型传递"><a href="#2、HandlerMethod-中参数是对象类型传递" class="headerlink" title="2、HandlerMethod 中参数是对象类型传递"></a>2、HandlerMethod 中参数是对象类型传递</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  请求参数名和对象中属性名对应(get/set 方法)，spring自动注入到对象属性。</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/demo"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">demo</span><span class="params">(People people)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//前端传入的name，age会自动注入到people</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"index.jsp"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3、请求参数中包含多个同名参数的获取方式"><a href="#3、请求参数中包含多个同名参数的获取方式" class="headerlink" title="3、请求参数中包含多个同名参数的获取方式"></a>3、请求参数中包含多个同名参数的获取方式</h3><p>比如： 复选框传递的参数就是多个同名参数。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"hover"</span> <span class="attr">value</span>=<span class="string">"看书"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"hover"</span> <span class="attr">value</span>=<span class="string">"游戏"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"hover"</span> <span class="attr">value</span>=<span class="string">"运动"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<pre><code>传递时，会把这些参数注入到集合元素中。</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/demo"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">demo</span><span class="params">(@RequestParam(<span class="string">"hover"</span>)</span>List&lt;String&gt; hovers) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"index.jsp"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4、-请求参数中对象-属性格式"><a href="#4、-请求参数中对象-属性格式" class="headerlink" title="4、 请求参数中对象.属性格式"></a>4、 请求参数中对象.属性格式</h3><pre><code>&lt;input type=&quot;text&quot; name=&quot;people.name&quot;/&gt;
&lt;input type=&quot;text&quot; name=&quot;people.age&quot;/&gt;

  编写一个类：
  public class Demo {
      private People people;
  }
传递参数方法：
@RequestMapping(&quot;/demo&quot;)
public String demo(Demo demo) {
        return &quot;index.jsp&quot;;
}
这样，就会自动注入到demo属性中。</code></pre><h3 id="5、在请求参数中传递集合对象类型参数"><a href="#5、在请求参数中传递集合对象类型参数" class="headerlink" title="5、在请求参数中传递集合对象类型参数"></a>5、在请求参数中传递集合对象类型参数</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"peoples[0].name"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"peoples[0].age"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"peoples[1].name"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"peoples[1].age"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<pre><code>Java类：</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line">      <span class="keyword">private</span> List&lt;People&gt; peoples;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>方法接收参数：</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/demo"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">demo</span><span class="params">(Demo demo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"index.jsp"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6、restful-传值方式"><a href="#6、restful-传值方式" class="headerlink" title="6、restful 传值方式"></a>6、restful 传值方式</h3><pre><code>当简化参数编写方式时，比如demo?name=zhangsan&amp;age=11这样的格式，简化为特定的如demo/zhangsan/11</code></pre><p>这样的格式处理获取参数的方式，如下：</p>
<pre><code>在@RequestMapping 中一定要和请求格式对应，通过｛名称｝匹配格式：@RequestMapping(&quot;/demo/{name}/{age}&quot;)

使用@PathVariable获取RequestMapping 参数</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/demo/&#123;name&#125;/&#123;age&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">demo</span><span class="params">(@PathVariable String name, @PathVariable <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        System.out.println(name + <span class="string">"  "</span> + age);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"/index.jsp"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试结果：<a href="http://localhost/springMVC_1_/demo/zhangsan/11" target="_blank" rel="noopener">http://localhost/springMVC_1_/demo/zhangsan/11</a><br>      zhangsan  11</p>
<h2 id="字符编码过滤"><a href="#字符编码过滤" class="headerlink" title="字符编码过滤"></a>字符编码过滤</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter</span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>utf-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="转发跳转"><a href="#转发跳转" class="headerlink" title="转发跳转"></a>转发跳转</h2><p>添加 redirect:资源路径 重定向</p>
<p>添加 forward:资源路径 或省略 forward: 转发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/demo"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">demo1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//return "forward:/index.jsp";//转发，可以省略</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"redirect:/index.jsp"</span>;<span class="comment">//重定向</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="视图解析器"><a href="#视图解析器" class="headerlink" title="视图解析器"></a>视图解析器</h2><h3 id="1、视图解析器"><a href="#1、视图解析器" class="headerlink" title="1、视图解析器"></a>1、视图解析器</h3><p>SpringMVC 会提供默认视图解析器，可以自定义视图解析器</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"viewResolver"</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefix"</span> <span class="attr">value</span>=<span class="string">"/"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suffix"</span> <span class="attr">value</span>=<span class="string">".jsp"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>如果不希望执行自定义的视图解析器，可以在方法返回值前面添加forward或redirect。</p>
<h3 id="2、-ResponseBody"><a href="#2、-ResponseBody" class="headerlink" title="2、@ResponseBody"></a>2、@ResponseBody</h3><p>1、在方法上只有@RequestMapping 时，无论方法返回值是什么都会跳转。</p>
<p>2、如果再加上@ResponseBody注解，则不会跳转，会把返回值转化为json字符串后发送到前端（以流的方式响应到前端）。</p>
<pre><code>如果返回值满足对象或map形式，就会把响应头设置为application/json；charset=utf-8
如果返回值不满足对象或者map形式，则返回为string，并且响应头设置为text/html。
返回值中如果有中文，会出现乱码，需要在响应头中设置编码格式。
@RequestMapping(value=&quot;/demo&quot;,produces=&quot;text/html;charset=utf-8&quot;) 如果转为json，需要导入Jackson的jar包。</code></pre><h2 id="作用域传值方式"><a href="#作用域传值方式" class="headerlink" title="作用域传值方式"></a>作用域传值方式</h2><h3 id="JSP九大内置对象和四大作用域"><a href="#JSP九大内置对象和四大作用域" class="headerlink" title="JSP九大内置对象和四大作用域"></a>JSP九大内置对象和四大作用域</h3><p>九大对象：</p>
<pre><code>out对象：用于向客户端、浏览器输出数据。response.getWriter()
request对象：封装了来自客户端、浏览器的各种信息。
response对象：封装了服务器的响应信息。
exception对象：封装了jsp程序执行过程中发生的异常和错误信息。
config对象：封装了应用程序的配置信息。
page对象：指向了当前jsp程序本身。
session对象：用来保存会话信息。也就是说，可以实现在同一用户的不同请求之间共享数req.getSession()
application对象：代表了当前应用程序的上下文。可以在不同的用户之间共享信息。getServletContext();request.getServletContext();
pageContext对象：提供了对jsp页面所有对象以及命名空间的访问。</code></pre><p>jsp四大作用域：<br>        page范围：只在一个页面保留数据（javax.servlet.jsp.PageContext(抽象类)）<br>        request范围：只在一个请求中保存数据（javax.servlet.httpServletRequest）<br>        Session范围：在一次会话中保存数据，仅供单个用户使用(javax.servlet.http.HttpSession)只要客户端 Cookie 中传递的 Jsessionid 不变,Session 不会重新实力会(不超过默认时间.)<br>        Application范围：在整个服务器中保存数据，全部用户共享(javax.servlet.ServletContext)只有在 tomcat 启动项目时菜实例化.关闭tomcat 时销毁application</p>
<h3 id="SpringMVC作用域传值方式"><a href="#SpringMVC作用域传值方式" class="headerlink" title="SpringMVC作用域传值方式"></a>SpringMVC作用域传值方式</h3><p>1、使用原生态Servlet，直接在HandlerMethod参数中添加作用域对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/demo"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">demo</span><span class="params">(HttpServletRequest req,HttpSession session)</span> </span>&#123;</span><br><span class="line">        HttpSession session1 = req.getSession();</span><br><span class="line">        ServletContext application=req.getServletContext();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"/index.jsp"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、使用Map集合，本质是把map中内容放在request作用域中。spring会对map集合通过BindingAwareModelMap进行实例化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/demo1"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">demo1</span><span class="params">(Map&lt;String, Object&gt; map)</span> </span>&#123;</span><br><span class="line">        System.out.println(map.getClass());</span><br><span class="line">        map.put(<span class="string">"map"</span>, <span class="string">"map值"</span>);<span class="comment">//jsp可以直接$&#123;map &#125;获得</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"/index.jsp"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、 使用 SpringMVC 中 Model 接口，把内容最终放入到 request 作用域中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/demo2"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">demo2</span><span class="params">(Model model)</span> </span>&#123;</span><br><span class="line">        model.addAttribute(<span class="string">"mode"</span>, <span class="string">"mode 值"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"/index.jsp"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4、使用 SpringMVC 中 ModelAndView 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/demo3"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">demo3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//通过跳转视图</span></span><br><span class="line">        ModelAndView mav=<span class="keyword">new</span> ModelAndView(<span class="string">"/index.jsp"</span>);</span><br><span class="line">        mav.addObject(<span class="string">"mav"</span>,<span class="string">"mav值"</span>);</span><br><span class="line">        <span class="keyword">return</span> mav;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述作用域值在jsp页面中都可以通过这样直接获取<br>        ${requestScope.req }<br/><br>        ${map }<br/><br>        ${mode }<br/></p>
<h2 id="文件下载和上传实例"><a href="#文件下载和上传实例" class="headerlink" title="文件下载和上传实例"></a>文件下载和上传实例</h2><h3 id="文件下载"><a href="#文件下载" class="headerlink" title="文件下载"></a>文件下载</h3><pre><code>浏览器访问资源时，当是文件下载需要设置响应头Content-Disposition，如果没有设置按照inline处理（inline是能显示文件内容就显示，不能显示就会下载）</code></pre><p>设置文件下载响应头：Context-Dispositon=”attachment;filename=文件名”，是以附件的形式下载。</p>
<p>实现文件下载，需要导入Apache文件处理工具包。<br>        commons-io-2.2.jar<br>        commons-fileupload-1.3.1.jar</p>
<p>实现<br>        springmvc中添加放行静态资源。<br>        &lt;mvc:resources location=”/file/“ mapping=”/file/**”&gt;</mvc:resources><br>jsp代码：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">"java"</span> contentType=<span class="string">"text/html; charset=UTF-8"</span></span><br><span class="line">   pageEncoding=<span class="string">"UTF-8"</span>%&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">&lt;title&gt;文件下载&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;a href="download?fileName=abc.txt"&gt;下载&lt;/a&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>控制器代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"download"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">download</span><span class="params">(String fileName, HttpServletResponse res, HttpServletRequest req)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//设置响应流中文件进行下载</span></span><br><span class="line">        res.setHeader(<span class="string">"Content-Disposition"</span>, <span class="string">"attachment;filename="</span>+fileName);</span><br><span class="line">        <span class="comment">//把二进制流放入到响应体中</span></span><br><span class="line">        ServletOutputStream os = res.getOutputStream();</span><br><span class="line">        String path = req.getServletContext().getRealPath(<span class="string">"files"</span>);</span><br><span class="line">        File file = <span class="keyword">new</span> File(path, fileName);</span><br><span class="line">        <span class="comment">//把文件转换为二进制流</span></span><br><span class="line">        <span class="keyword">byte</span>[] bytes = FileUtils.readFileToByteArray(file);</span><br><span class="line">        os.write(bytes);</span><br><span class="line">        os.flush();</span><br><span class="line">        os.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><ul>
<li><ol>
<li>基于 apache 的 commons-fileupload.jar 完成文件上传.</li>
</ol>
</li>
<li><ol start="2">
<li>MultipartResovler 作用：把客户端上传的文件流转换成 MutipartFile 封装类；通过 MutipartFile 封装类获取到文件流。</li>
</ol>
</li>
<li><ol start="3">
<li><p>表单数据类型分类，&lt;form&gt;的 enctype 属性控制表单类型</p>
<p>  application/x-www-form-urlencoded默认值，普通表单数据(少量文字信息)</p>
<p>  text/plain 大文字量时使用的类型，邮件，论文。</p>
<p>  multipart/form-data 表单中包含二进制文件内容。</p>
</li>
</ol>
</li>
<li><ol start="4">
<li>实现步骤</li>
</ol>
</li>
</ul>
<p>导入 springmvc 包和 apache 文件上传 commons-fileupload 和commons-io 两个 jar</p>
<p>配置文件解析器，因为如果上传大小超过设定，会有异常，对应配置异常解析处理。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">&lt;!-- MultipartResovler 解析器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"multipartResolver"</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.multipart.commons.CommonsMultipartResolver"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxUploadSize"</span> <span class="attr">value</span>=<span class="string">"5000000"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 异常解析器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"exceptionResolver"</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.handler.SimpleMappingExceptionResolver"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"exceptionMappings"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.springframework.web.multipart.MaxUploadSizeExceededException"</span>&gt;</span>/error.jsp<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>JSP 页面：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;title&gt;文件上传&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">      &lt;form action=<span class="string">"upload"</span> enctype=<span class="string">"multipart/form-data"</span> method=<span class="string">"post"</span>&gt;</span><br><span class="line">              姓名：&lt;input type=<span class="string">"text"</span> name=<span class="string">"name"</span> /&gt;&lt;br /&gt;</span><br><span class="line">              文件：&lt;input type=<span class="string">"file"</span> name=<span class="string">"file"</span> /&gt;&lt;br /&gt;</span><br><span class="line">              &lt;input type=<span class="string">"submit"</span> value=<span class="string">"提交 "</span> /&gt;</span><br><span class="line">      &lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>控制器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"upload"</span>)<span class="comment">// MultipartFile 对象名必须和&lt;input type="file"/&gt;的 name 属性值相同    </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">upload</span><span class="params">(MultipartFile file, HttpServletRequest req)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            String fileName = file.getOriginalFilename();</span><br><span class="line">            String suffix = fileName.substring(fileName.lastIndexOf(<span class="string">"."</span>));</span><br><span class="line">            String path = req.getServletContext().getRealPath(<span class="string">"files"</span>);</span><br><span class="line">            <span class="comment">// 判断上传文件类型</span></span><br><span class="line">            <span class="keyword">if</span> (suffix.equalsIgnoreCase(<span class="string">".png"</span>)) &#123;</span><br><span class="line">                    String uuid = UUID.randomUUID().toString();</span><br><span class="line">                    FileUtils.copyInputStreamToFile(file.getInputStream(), <span class="keyword">new</span> File(path + uuid + suffix));</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">"/index.jsp"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">"error.jsp"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h2><p>springMVC拦截器和servlet过滤器类似，通过拦截器可以进行权限验证、记录请求信息的日志、判断用户是否登录等。</p>
<p> 和AOP区分开，AOP针对的是特定方法前后的扩充，主要用于Service。而拦截器针对的是控制器方法。</p>
<p>拦截器和过滤器Controller的区别。</p>
<pre><code>拦截器只能拦截controller；Filter可以拦截任何请求。</code></pre><p>1、通过实现HandlerInterceptor接口，或继承HandlerInterceptor接口的实现类（如HandlerInterceptorAdapter）来定义。</p>
<p>2、通过实现WebRequestInterceptor接口，或继承WebRequestInterceptor接口的实现类来定义。</p>
<p>新建拦截器类，实现HandlerInterceptor：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoHandlerInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span></span>&#123;</span><br><span class="line">      <span class="comment">//在进入控制器之前执行，如果返回false,会阻止进入控制器。</span></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest arg0, HttpServletResponse arg1, Object arg2)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//控制器执行完成，进入到jsp之前执行。</span></span><br><span class="line">      <span class="comment">// 如果控制器出现异常直接到异常处理afterCompletion</span></span><br><span class="line">      <span class="comment">//比如做日志记录、敏感词语过滤</span></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest arg0, HttpServletResponse arg1, Object arg2, ModelAndView arg3)</span></span></span><br><span class="line"><span class="function">                      <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//jsp执行完成后执行</span></span><br><span class="line">      <span class="comment">//异常日志记录</span></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest arg0, HttpServletResponse arg1, Object arg2, Exception arg3)</span></span></span><br><span class="line"><span class="function">                      <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置文件配置拦截器生效</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 方式一：拦截所有的控制器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.hu.interceptor.DemoHandlerInterceptor"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 拦截特定的url --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 配置拦截路径 --!&gt;</span></span><br><span class="line"><span class="comment">                &lt;mvc:mapping path="/demo" /&gt;</span></span><br><span class="line"><span class="comment">                &lt;mvc:mapping path="/demo1" /&gt;</span></span><br><span class="line"><span class="comment">                &lt;mvc:mapping path="/demo2" /&gt;</span></span><br><span class="line"><span class="comment">                &lt;bean class="com.hu.interceptor.DemoHandlerInterceptor"&gt;&lt;/bean&gt;</span></span><br><span class="line"><span class="comment">        &lt;/mvc:interceptor&gt;</span></span><br><span class="line"><span class="comment">&lt;/mvc:interceptors&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="拦截器栈"><a href="#拦截器栈" class="headerlink" title="拦截器栈"></a>拦截器栈</h3><p>当多个拦截器同时生效时，组成了拦截器栈。遵行先进后出的规律。<br>执行顺序和在 springmvc.xml 中配置顺序有关<br>比如：设置先配置拦截器 A 在配置拦截器 B 执行顺序为 preHandle(A) –&gt; preHandle(B) –&gt; 控制器方法 –&gt; postHandle(B)<br>–&gt; postHanle(A) –&gt; JSP –&gt; afterCompletion(B) –&gt; afterCompletion(A)</p>
<h2 id="Spring-MVC中关于关于Content-Type类型应用"><a href="#Spring-MVC中关于关于Content-Type类型应用" class="headerlink" title="Spring MVC中关于关于Content-Type类型应用"></a>Spring MVC中关于关于Content-Type类型应用</h2><p> @RequestMapping注解的定义：<br> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> RequestMapping &#123;</span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//指定请求的实际地址</span></span><br><span class="line">    <span class="meta">@AliasFor</span>(<span class="string">"path"</span>)</span><br><span class="line">    String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="meta">@AliasFor</span>(<span class="string">"value"</span>)</span><br><span class="line">    String[] path() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    <span class="comment">//指定请求的method类型</span></span><br><span class="line">    RequestMethod[] method() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    <span class="comment">//指定request中必须包含某些参数值是，才让该方法处理</span></span><br><span class="line">    String[] params() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    <span class="comment">//指定request中必须包含某些指定的header值，才能让该方法处理请求</span></span><br><span class="line">    String[] headers() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    <span class="comment">//指定处理请求的提交内容类型（Content-Type）</span></span><br><span class="line">    String[] consumes() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    <span class="comment">//指定返回的内容类型，仅当request请求头中的(Accept)类型中包含该指定类型才返回</span></span><br><span class="line">    String[] produces() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/21/">上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><span class="page-number current">22</span><a class="page-number" href="/page/23/">23</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><a class="extend next" rel="next" href="/page/23/">下一页</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://img.huyunshun.com/img/20200522182348.png"
                alt="初晨" />
            
              <p class="site-author-name" itemprop="name">初晨</p>
              <p class="site-description motion-element" itemprop="description">永远不要说你知道本质，更别说真相了。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">249</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">46</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">109</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          
<!--近期文章版块-->
            
                <div class="links-of-blogroll motion-element links-of-blogroll-block">
                  <div class="links-of-blogroll-title">
                    <!-- modify icon to fire by szw -->
                    <i class="fa fa-history fa-" aria-hidden="true"></i>
                    近期文章
                  </div>
                  <ul class="links-of-blogroll-list">
                    
                    
                      <li>
                        <a href="/2020/05/22/WebSocket%E3%80%81Socket%E3%80%81TCP%E3%80%81HTTP%E5%8C%BA%E5%88%AB/" title="WebSocket、Socket、TCP、HTTP区别" target="_blank">WebSocket、Socket、TCP、HTTP区别</a>
                      </li>
                    
                      <li>
                        <a href="/2020/05/19/Springboot%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%8E%A5%E5%8F%A3%E9%98%B2%E5%88%B7/" title="Springboot项目的接口防刷" target="_blank">Springboot项目的接口防刷</a>
                      </li>
                    
                      <li>
                        <a href="/2020/05/03/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Volatile%E5%85%B3%E9%94%AE%E5%AD%97%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" title="深入理解Volatile关键字及其实现原理" target="_blank">深入理解Volatile关键字及其实现原理</a>
                      </li>
                    
                      <li>
                        <a href="/2020/04/20/%E4%BD%BF%E7%94%A8vscode%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0%E7%8E%AF%E5%A2%83/" title="使用vscode搭建个人笔记环境" target="_blank">使用vscode搭建个人笔记环境</a>
                      </li>
                    
                      <li>
                        <a href="/2020/01/20/HBase%E4%BB%8B%E7%BB%8D%E5%AE%89%E8%A3%85%E4%B8%8E%E6%93%8D%E4%BD%9C/" title="HBase介绍安装与操作" target="_blank">HBase介绍安装与操作</a>
                      </li>
                    
                  </ul>
                </div>
            
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Copyright</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  


</body>
</html>
