<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="永远不要说你知道本质，更别说真相了。">
<meta property="og:type" content="website">
<meta property="og:title" content="简">
<meta property="og:url" content="https://huyunshun.com/page/2/index.html">
<meta property="og:site_name" content="简">
<meta property="og:description" content="永远不要说你知道本质，更别说真相了。">
<meta property="article:author" content="初晨">
<meta property="article:tag" content="编程">
<meta property="article:tag" content="开发">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://huyunshun.com/page/2/"/>





  <title>简</title>
  








  <script type="text/javascript" src="/js/src/love.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">

  <!-- 看板娘 -->
    
        <script async src="/live2d-widget/autoload.js"></script>
    
 <!-- 飘动的彩带） -->
  <script src="/js/src/piao.js" type="text/javascript"></script>
<meta name="generator" content="Hexo 4.2.1"></head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">简</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">人生短暂，学海无边，而大道至简。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/08/24/2%E3%80%81%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E4%B8%8E%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/24/2%E3%80%81%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E4%B8%8E%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7/" itemprop="url">虚拟机性能监控与故障处理工具</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-24T00:00:00+08:00">
                2019-08-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="JDK的命令行工具"><a href="#JDK的命令行工具" class="headerlink" title="JDK的命令行工具"></a>JDK的命令行工具</h4><p>JDK开发团队选择采用Java代码来实现这些监控工具是有特别用意的：当应用程序部署到生产环境后，无论是直接接触物理服务器还是远程Telnet到服务器上都可能会受到限制。借助tools.jar类库里面的接口，我们可以直接在应用程序中实现功能强大的监控分析功能。</p>
<h6 id="JDK监控和故障处理工具"><a href="#JDK监控和故障处理工具" class="headerlink" title="JDK监控和故障处理工具"></a>JDK监控和故障处理工具</h6><p>** jps：虚拟机进程状况工具 **</p>
<p>jps命令格式：</p>
<p>jps [ options ] [ hostid ]</p>
<p>jps执行样例：</p>
<p>D:\Develop\Java\jdk1.6.0_21\bin&gt;jps -l 2388 D:\Develop\glassfish\bin..\modules\admin-cli.jar 2764 com.sun.enterprise.glassfish.bootstrap.ASMain 3788 sun.tools.jps.Jps</p>
<p>jps可以通过RMI协议查询开启了RMI服务的远程虚拟机进程状态，hostid为RMI注册表中注册的主机名。</p>
<p>** jstat：虚拟机统计信息监视工具**</p>
<p>jstat（JVM Statistics Monitoring Tool）是用于监视虚拟机各种运行状态信息的命令行工具。它可以显示本地或远程虚拟机进程中的类装载、内存、垃圾收集、JIT编译等运行数据，在没有GUI图形界面，只提供了纯文本控制台环境的服务器上，它将是运行期定位虚拟机性能问题的首选工具。</p>
<p>jstat命令格式为：</p>
<p>jstat [ option vmid [interval[s|ms] [count]] ]</p>
<p>对于命令格式中的VMID与LVMID需要特别说明一下：如果是本地虚拟机进程， VMID与LVMID是一致的，如果是远程虚拟机进程，那VMID的格式应当是：</p>
<p>[protocol:][//]lvmid[@hostname[:port]/servername]</p>
<p>参数interval和count代表查询间隔和次数，如果省略这两个参数，说明只查询一次。假设需要每250毫秒查询一次进程2764垃圾收集的状况，一共查询20次，那命令应当是：</p>
<p>jstat -gc 2764 250 20</p>
<p>选项option代表着用户希望查询的虚拟机信息，主要分为3类：类装载、垃圾收集和运行期编译状况</p>
<p>jstat执行样例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">D:\Develop\Java\jdk1.6.0_21\bin&gt;jstat -gcutil 2764 </span><br><span class="line">S0 S1 E O P YGC YGCT FGC FGCT GCT </span><br><span class="line">0.00 0.00 6.20 41.42 47.20 16 0.105 3 0.472 0.577</span><br></pre></td></tr></table></figure>
<p>查询结果表明：这台服务器的新生代Eden区（E，表示Eden）使用了6.2%的空间，两个Survivor区（S0、S1，表示Survivor0、Survivor1）里面都是空的，老年代（O，表示Old）和永久代（P，表示Permanent）则分别使用了41.42%和47.20%的空间。程序运行以来共发生Minor GC（YGC，表示Young GC）16次，总耗时0.105秒，发生Full GC（FGC，表示Full GC）3次，Full GC总耗时（FGCT，表示Full GC Time）为0.472秒，所有GC总耗时（GCT，表示GC Time）为0.577秒。</p>
<p>使用jstat工具在纯文本状态下监视虚拟机状态的变化，确实不如后面将会提到的VisualVM等可视化的监视工具直接以图表展现的那样直观。但许多服务器管理员都习惯了在文本控制台中工作，直接在控制台中使用jstat命令依然是一种常用的监控方式。</p>
<p>** jinfo：Java配置信息工具**</p>
<p>jinfo（Configuration Info for Java）的作用是实时地查看和调整虚拟机的各项参数。JDK 1.6之后，jinfo在Windows和Linux平台都有提供，并且加入了运行期修改参数的能力，可以使用-flag [+|-]name或-flag name=value修改一部分运行期可写的虚拟机参数值。</p>
<p>jinfo命令格式：</p>
<p>jinfo [ option ] pid</p>
<p>执行样例：查询CMSInitiatingOccupancyFraction参数值。</p>
<p>C:&gt;jinfo -flag CMSInitiatingOccupancyFraction 1444 -XX:CMSInitiatingOccupancyFraction=85</p>
<p>** jmap：Java内存映像工具**</p>
<p>jmap（Memory Map for Java）命令用于生成堆转储快照（一般称为heapdump或dump文件）。如果不使用jmap命令，要想获取Java堆转储快照还有一些比较“暴力”的手段：譬如在第2章中用过的-XX：HeapDumpOnOutOfMemoryError参数，可以让虚拟机在OOM异常出现之后自动生成dump文件，通过-XX：HeapDumpOnCtrlBreak参数则可以使用[Ctrl]+[Break]键让虚拟机生成dump文件，又或者在Linux系统下通过Kill-3命令发送进程退出信号“恐吓”一下虚拟机，也能拿到dump文件。</p>
<p>jmap的作用并不仅仅是为了获取dump文件，它还可以查询finalize执行队列，Java堆和永久代的详细信息，如空间使用率、当前用的是哪种收集器等。</p>
<p>jmap命令格式：</p>
<p>jmap [ option ] vmid</p>
<p><strong>jhat：虚拟机堆转储快照分析工具</strong></p>
<p>Sun JDK提供jhat（JVM Heap Analysis Tool）命令与jmap搭配使用，来分析jmap生成的堆转储快照。jhat内置了一个微型的HTTP/HTML服务器，生成dump文件的分析结果后，可以在浏览器中查看。不过实事求是地说，在实际工作中，除非笔者手上真的没有别的工具可用，否则一般都不会去直接使用jhat命令来分析dump文件，主要原因有二：一是一般不会在部署应用程序的服务器上直接分析dump文件，即使可以这样做，也会尽量将dump文件拷贝到其他机器上进行分析，因为分析工作是一个耗时而且消耗硬件资源的过程，既然都要在其他机器上进行，就没必要受到命令行工具的限制了。另外一个原因是jhat的分析功能相对来说比较简陋，后文将会介绍到的VisualVM，以及专业用于分析dump文件的Eclipse Memory Analyzer、IBM HeapAnalyzer等工具，都能实现比jhat更强大更专业的分析功能。代码清单4-3演示了使用jhat分析上一节采用jmap生成的Eclipse IDE的内存快照文件。</p>
<p>** jstack：Java堆栈跟踪工具**</p>
<p>jstack（Stack Trace for Java）命令用于生成虚拟机当前时刻的线程快照（一般称为threaddump或javacore文件）。线程快照就是当前虚拟机内每一条线程正在执行的方法堆栈的集合，生成线程快照的主要目的是定位线程出现长时间停顿的原因，如线程间死锁、死循环、请求外部资源导致的长时间等待等都是导致线程长时间停顿的常见原因。线程出现停顿的时候通过jstack来查看各个线程的调用堆栈，就可以知道没有响应的线程到底在后台做些什么事情，或者等待着什么资源。</p>
<p>jstack命令格式：</p>
<p>jstack [ option ] vmid</p>
<h6 id="JDK的可视化工具"><a href="#JDK的可视化工具" class="headerlink" title="JDK的可视化工具"></a>JDK的可视化工具</h6><p>JDK中除了提供大量的命令行工具外，还有两个功能强大的可视化工具：JConsole和VisualVM，这两个工具是JDK的正式成员，没有被贴上“unsupported and experimental”的标签。</p>
<p>其中JConsole是在JDK 1.5时期就已经提供的虚拟机监控工具，而VisualVM在JDK 1.6 Update7中才首次发布，现在已经成为Sun（Oracle）主力推动的多合一故障处理工具，并且已经从JDK中分离出来成为可以独立发展的开源项目。</p>
<p>** JConsole：Java监视与管理控制台**</p>
<p>JConsole（Java Monitoring and Management Console）是一款基于JMX的可视化监视和管理的工具。它管理部分的功能是针对JMX MBean进行管理，由于MBean可以使用代码、中间件服务器的管理控制台或者所有符合JMX规范的软件进行访问，所以本节中将会着重介绍JConsole监视部分的功能。<br>** VisualVM：多合一故障处理工具**</p>
<p>VisualVM（All-in-One Java Troubleshooting Tool）是到目前为止，随JDK发布的功能最强大的运行监视和故障处理程序，除了运行监视、故障处理外，还提供了很多其他方面的功能。如性能分析（Profiling），VisualVM的性能分析功能甚至比起JProfiler、YourKit等专业且收费的Profiling工具都不会逊色多少，而且VisualVM的还有一个很大优点：不需要被监视的程序基于特殊Agent运行，因此它对应用程序的实际性能的影响很小，使得它可以直接应用在生产环境中。这个优点是JProfiler、YourKit等工具无法与之媲美的。</p>
<p>除了JDK自带的工具之外，常用的故障处理工具还有很多，如果读者使用的是非Sun系列的JDK，非HotSpot的虚拟机，就需要使用对应的工具进行分析，如：</p>
<p>□ IBM的Support Assistant、Heap Analyzer、Javacore Analyzer、Garbage Collector Analyzer适用于IBM J9VM。</p>
<p>□ HP的HPjmeter、HPjtune适用于HP-UX、SAP、HotSpot VM。</p>
<p>□ Eclipse的Memory Analyzer Tool（MAT）适用于HP-UX、SAP、HotSpot VM，安装IBM DTFJ插件后可支持IBM J9VM。</p>
<p>□ BEA的JRockit Mission Control，适用于JRockit VM。</p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/08/23/%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E3%80%81%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9%EF%BC%8C%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/23/%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E3%80%81%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9%EF%BC%8C%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" itemprop="url">缓存穿透、缓存雪崩，缓存击穿解决方案(转)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-23T14:50:26+08:00">
                2019-08-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index">
                    <span itemprop="name">分布式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="什么样的数据适合缓存"><a href="#什么样的数据适合缓存" class="headerlink" title="什么样的数据适合缓存"></a>什么样的数据适合缓存</h2><table>
    <tr>
        <td rowspan="2">数据访问频率</td> 
        <td>频率高</td> 
        <td>适合缓存</td> 
        <td>效果好</td> 
   </tr>
   <tr>
        <td>频率低</td> 
        <td>不适合缓存</td> 
        <td>效果不好</td> 
   </tr>
    <tr>
        <td rowspan="2">数据读写比例</td> 
        <td>读多写少</td> 
        <td>适合缓存</td> 
        <td>效果好</td> 
   </tr>
   <tr>
        <td>读少写多</td> 
        <td>不适合缓存</td> 
        <td>效果不好</td> 
   </tr>
    <tr>
        <td rowspan="2">数据一致性</td> 
        <td>一致性要求低</td> 
        <td>适合缓存</td> 
        <td>效果好</td> 
   </tr>
   <tr>
        <td>一致性要求高</td> 
        <td>不适合缓存</td> 
        <td>效果不好</td> 
   </tr>
</table>

<h2 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h2><p>缓存穿透是指查询一个一定不存在的数据，由于缓存是不命中时需要从数据库查询，查不到数据则不写入缓存，这将导致这个不存在的数据每次请求都要到数据库去查询，造成缓存穿透。在流量大时，可能DB就挂掉了，要是有人利用不存在的key频繁攻击我们的应用，这就是漏洞。</p>
<p> 解决方案：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1）有很多种方法可以有效地解决缓存穿透问题，最常见的则是采用布隆过滤器，将所有可能存在的数据哈希到一个足够大的bitmap中，一个一定不存在的数据会被这个bitmap拦截掉，从而避免了对底层数据库的查询压力。</span><br><span class="line">2）另外也有一个更为简单粗暴的方法，如果一个查询返回的数据为空（不管是数据不存在，还是系统故障），仍然把这个空结果进行缓存，但它的过期时间会很短，最长不超过五分钟。</span><br></pre></td></tr></table></figure>

<h2 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h2><p>缓存雪崩是指在设置缓存时采用了相同的过期时间，导致缓存在某一时刻同时失效，导致所有的查询都落在数据库上，造成了缓存雪崩。</p>
<p>解决方案：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1）在缓存失效后，通过加锁或者队列来控制读数据库写缓存的线程数量。比如对某个key只允许一个线程查询数据和写缓存，其他线程等待。</span><br><span class="line">2）可以通过缓存reload机制，预先去更新缓存，在即将发生大并发访问前手动触发加载缓存。</span><br><span class="line">3）不同的key，设置不同的过期时间，让缓存失效的时间点尽量均匀。</span><br><span class="line">4）做二级缓存，或者双缓存策略。A1为原始缓存，A2为拷贝缓存，A1失效时，可以访问A2，A1缓存失效时间设置为短期，A2设置为长期。</span><br></pre></td></tr></table></figure>
<h2 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h2><p>对于一些设置了过期时间的key，如果这些key可能会在某些时间点被超高并发地访问，是一种非常“热点”的数据。这个时候，需要考虑一个问题：缓存被“击穿”的问题，这个和缓存雪崩的区别在于这里针对某一key缓存，前者则是很多key。<br>缓存在某个时间点过期的时候，恰好在这个时间点对这个Key有大量的并发请求过来，这些请求发现缓存过期一般都会从后端DB加载数据并回设到缓存，这个时候大并发的请求可能会瞬间把后端DB压垮。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">### 1）后台刷新</span><br><span class="line">后台定义一个job(定时任务)专门主动更新缓存数据.比如,一个缓存中的数据过期时间是30分钟,那么job每隔29分钟定时刷新数据(将从数据库中查到的数据更新到缓存中).</span><br><span class="line">注：这种方案比较容易理解，但会增加系统复杂度。比较适合那些 key 相对固定,cache 粒度较大的业务，key 比较分散的则不太适合，实现起来也比较复杂。</span><br><span class="line"></span><br><span class="line">### 2）检查更新</span><br><span class="line">将缓存key的过期时间(绝对时间)一起保存到缓存中(可以拼接,可以添加新字段,可以采用单独的key保存..不管用什么方式,只要两者建立好关联关系就行).在每次执行get操作后,都将get出来的缓存过期时间与当前系统时间做一个对比,如果缓存过期时间-当前系统时间&lt;&#x3D;1分钟(自定义的一个值),则主动更新缓存.这样就能保证缓存中的数据始终是最新的(和方案一一样,让数据不过期.)</span><br><span class="line"></span><br><span class="line">注：这种方案在特殊情况下也会有问题。假设缓存过期时间是12:00，而 11:59 到 12:00这 1 分钟时间里恰好没有 get 请求过来，又恰好请求都在 11:30 分的时 候高并发过来，那就悲剧了。这种情况比较极端，但并不是没有可能。因为“高 并发”也可能是阶段性在某个时间点爆发。</span><br><span class="line"></span><br><span class="line">### 3）分级缓存</span><br><span class="line">采用 L1 (一级缓存)和 L2(二级缓存) 缓存方式，L1 缓存失效时间短，L2 缓存失效时间长。 请求优先从 L1 缓存获取数据，如果 L1缓存未命中则加锁，只有 1 个线程获取到锁,这个线程再从数据库中读取数据并将数据再更新到到 L1 缓存和 L2 缓存中，而其他线程依旧从 L2 缓存获取数据并返回。</span><br><span class="line"></span><br><span class="line">注：这种方式，主要是通过避免缓存同时失效并结合锁机制实现。所以，当数据更 新时，只能淘汰 L1 缓存，不能同时将 L1 和 L2 中的缓存同时淘汰。L2 缓存中 可能会存在脏数据，需要业务能够容忍这种短时间的不一致。而且，这种方案 可能会造成额外的缓存空间浪费。</span><br><span class="line"></span><br><span class="line">### 4）加锁</span><br><span class="line">    &#x2F;&#x2F; 方法1:</span><br><span class="line">    public synchronized List&lt;String&gt; getData01() &#123;</span><br><span class="line">        List&lt;String&gt; result &#x3D; new ArrayList&lt;String&gt;();</span><br><span class="line">        &#x2F;&#x2F; 从缓存读取数据</span><br><span class="line">        result &#x3D; getDataFromCache();</span><br><span class="line">        if (result.isEmpty()) &#123;</span><br><span class="line">            &#x2F;&#x2F; 从数据库查询数据</span><br><span class="line">            result &#x3D; getDataFromDB();</span><br><span class="line">            &#x2F;&#x2F; 将查询到的数据写入缓存</span><br><span class="line">            setDataToCache(result);</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;　　</span><br><span class="line">注：这种方式确实能够防止缓存失效时高并发到数据库,但是缓存没有失效的时候,在从缓存中拿数据时需要排队取锁,这必然会大大的降低了系统的吞吐量.</span><br><span class="line"></span><br><span class="line">方法2：</span><br><span class="line">    &#x2F;&#x2F; 方法2:</span><br><span class="line">    static Object lock &#x3D; new Object();</span><br><span class="line"> </span><br><span class="line">    public List&lt;String&gt; getData02() &#123;</span><br><span class="line">        List&lt;String&gt; result &#x3D; new ArrayList&lt;String&gt;();</span><br><span class="line">        &#x2F;&#x2F; 从缓存读取数据</span><br><span class="line">        result &#x3D; getDataFromCache();</span><br><span class="line">        if (result.isEmpty()) &#123;</span><br><span class="line">            synchronized (lock) &#123;</span><br><span class="line">                &#x2F;&#x2F; 从数据库查询数据</span><br><span class="line">                result &#x3D; getDataFromDB();</span><br><span class="line">                &#x2F;&#x2F; 将查询到的数据写入缓存</span><br><span class="line">                setDataToCache(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;　　</span><br><span class="line">注：这个方法在缓存命中的时候,系统的吞吐量不会受影响,但是当缓存失效时,请求还是会打到数据库,只不过不是高并发而是阻塞而已.但是,这样会造成用户体验不佳,并且还给数据库带来额外压力.</span><br><span class="line"></span><br><span class="line">方法3：</span><br><span class="line">    &#x2F;&#x2F;方法3</span><br><span class="line">    public List&lt;String&gt; getData03() &#123;</span><br><span class="line">        List&lt;String&gt; result &#x3D; new ArrayList&lt;String&gt;();</span><br><span class="line">        &#x2F;&#x2F; 从缓存读取数据</span><br><span class="line">        result &#x3D; getDataFromCache();</span><br><span class="line">        if (result.isEmpty()) &#123;</span><br><span class="line">            synchronized (lock) &#123;</span><br><span class="line">            &#x2F;&#x2F;双重判断,第二个以及之后的请求不必去找数据库,直接命中缓存</span><br><span class="line">                &#x2F;&#x2F; 查询缓存</span><br><span class="line">                result &#x3D; getDataFromCache();</span><br><span class="line">                if (result.isEmpty()) &#123;</span><br><span class="line">                    &#x2F;&#x2F; 从数据库查询数据</span><br><span class="line">                    result &#x3D; getDataFromDB();</span><br><span class="line">                    &#x2F;&#x2F; 将查询到的数据写入缓存</span><br><span class="line">                    setDataToCache(result);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">注：双重判断虽然能够阻止高并发请求打到数据库,但是第二个以及之后的请求在命中缓存时,还是排队进行的.比如,当30个请求一起并发过来,在双重判断时,第一个请求去数据库查询并更新缓存数据,剩下的29个请求则是依次排队取缓存中取数据.请求排在后面的用户的体验会不爽.</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;方法4：</span><br><span class="line">static Lock reenLock &#x3D; new ReentrantLock();</span><br><span class="line"> </span><br><span class="line">    public List&lt;String&gt; getData04() throws InterruptedException &#123;</span><br><span class="line">        List&lt;String&gt; result &#x3D; new ArrayList&lt;String&gt;();</span><br><span class="line">        &#x2F;&#x2F; 从缓存读取数据</span><br><span class="line">        result &#x3D; getDataFromCache();</span><br><span class="line">        if (result.isEmpty()) &#123;</span><br><span class="line">            if (reenLock.tryLock()) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    System.out.println(&quot;我拿到锁了,从DB获取数据库后写入缓存&quot;);</span><br><span class="line">                    &#x2F;&#x2F; 从数据库查询数据</span><br><span class="line">                    result &#x3D; getDataFromDB();</span><br><span class="line">                    &#x2F;&#x2F; 将查询到的数据写入缓存</span><br><span class="line">                    setDataToCache(result);</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    reenLock.unlock();&#x2F;&#x2F; 释放锁</span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                result &#x3D; getDataFromCache();&#x2F;&#x2F; 先查一下缓存</span><br><span class="line">                if (result.isEmpty()) &#123;</span><br><span class="line">                    System.out.println(&quot;我没拿到锁,缓存也没数据,先小憩一下&quot;);</span><br><span class="line">                    Thread.sleep(100);&#x2F;&#x2F; 小憩一会儿</span><br><span class="line">                    return getData04();&#x2F;&#x2F; 重试</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">注：最后使用互斥锁的方式来实现，可以有效避免前面几种问题.</span><br></pre></td></tr></table></figure>
<p>在实际分布式场景中，我们还可以使用 redis、tair、zookeeper 等提供的分布式锁来实现，如果我们的并发量如果只有几千的话，这些都是很好的方式。</p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/08/23/1%E3%80%81%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/23/1%E3%80%81%E8%87%AA%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%9C%BA%E5%88%B6/" itemprop="url">jvm深入-自动内存管理机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-23T00:00:00+08:00">
                2019-08-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="内存模型"><a href="#内存模型" class="headerlink" title="内存模型"></a>内存模型</h1><p>每个JVM都有两种机制：类装载子系统和执行引擎</p>
<p>每个JVM都包含：方法区、Java堆、Java栈、本地方法栈、程序计数器</p>
<p><img src="https://img.huyunshun.com/img/20200423160634.png" alt="20200423160634"></p>
<p><img src="https://img.huyunshun.com/img/20200423160643.png" alt="20200423160643"></p>
<h2 id="程序计数器（Program-Counter-Register）"><a href="#程序计数器（Program-Counter-Register）" class="headerlink" title="程序计数器（Program Counter Register）"></a>程序计数器（Program Counter Register）</h2><p>&emsp;&emsp;线程私有，它的生命周期与线程相同。它的作用可以看做是当前线程所执行的字节码的行号指示器，是一块较小的内存空间。在虚拟机的概念模型里（仅是概念模型，各种虚拟机可能会通过一些更高效的方式去实现），字节码解释器工作时就是通过改变这个计数器的值来选取下一条需要执行的字节码指令，分支、循环、跳转、异常处理、线程恢复等基础功能都需要依赖这个计数器来完成。</p>
<p>&emsp;&emsp;由于Java虚拟机的多线程是通过线程轮流切换并分配处理器执行时间的方式来实现的，在任何一个确定的时刻，一个处理器（对于多核处理器来说是一个内核）只会执行一条线程中的指令。因此，为了线程切换后能恢复到正确的执行位置，每条线程都需要有一个独立的程序计数器，各条线程之间的计数器互不影响，独立存储，我们称这类内存区域为“线程私有”的内存。</p>
<p>&emsp;&emsp;如果线程正在执行的是一个Java方法，这个计数器记录的是正在执行的虚拟机字节码指令的地址；如果正在执行的是Natvie方法，这个计数器值则为空（Undefined）。此内存区域是唯一一个在Java虚拟机规范中没有规定任何OutOfMemoryError情况的区域。</p>
<h2 id="Java虚拟机栈（JVM-Stacks）"><a href="#Java虚拟机栈（JVM-Stacks）" class="headerlink" title="Java虚拟机栈（JVM Stacks）"></a>Java虚拟机栈（JVM Stacks）</h2><p>&emsp;&emsp;线程私有的，它的生命周期与线程相同。</p>
<p>&emsp;&emsp;虚拟机栈描述的是Java方法执行的内存模型：每个方法被执行的时候都会同时创建一个栈帧（Stack Frame）用于存储局部变量表、操作栈、动态链接、方法出口等信息。每一个方法被调用直至执行完成的过程，就对应着一个栈帧在虚拟机栈中从入栈到出栈的过程。</p>
<p>&emsp;&emsp;局部变量表存放了编译期可知的各种基本数据类型（boolean、byte、char、short、int、float、long、double）、对象引用（reference类型），它不等同于对象本身，根据不同的虚拟机实现，它可能是一个指向对象起始地址的引用指针，也可能指向一个代表对象的句柄或者其他与此对象相关的位置）和returnAddress类型（指向了一条字节码指令的地址）。局部变量表所需的内存空间在编译期间完成分配，当进入一个方法时，这个方法需要在帧中分配多大的局部变量空间是完全确定的，在方法运行期间不会改变局部变量表的大小。</p>
<p>该区域可能抛出以下异常：</p>
<ul>
<li>当线程请求的栈深度超过最大值，会抛出 StackOverflowError 异常；</li>
<li>栈进行动态扩展时如果无法申请到足够内存，会抛出 OutOfMemoryError 异常。</li>
</ul>
<h2 id="本地方法栈（Native-Method-Stacks）"><a href="#本地方法栈（Native-Method-Stacks）" class="headerlink" title="本地方法栈（Native Method Stacks）"></a>本地方法栈（Native Method Stacks）</h2><p>&emsp;&emsp;与虚拟机栈非常相似，其区别不过是虚拟机栈为虚拟机执行Java方法（也就是字节码）服务，而本地方法栈则是为虚拟机使用到的Native 方法服务。</p>
<h2 id="Java堆（Heap）"><a href="#Java堆（Heap）" class="headerlink" title="Java堆（Heap）"></a>Java堆（Heap）</h2><p>&emsp;&emsp;被所有线程共享，在虚拟机启动时创建，用来存放对象实例，几乎所有的对象实例都在这里分配内存。</p>
<p>&emsp;&emsp;对于大多数应用来说，Java堆（Java Heap）是Java虚拟机所管理的内存中最大的一块。Java堆是垃圾收集器管理的主要区域，因此很多时候也被称做”GC堆”。如果从内存回收的角度看，由于现在收集器基本都是采用的分代收集算法，所以Java堆中还可以细分为：新生代和老年代；新生代又有Eden空间、From Survivor空间、To Survivor空间三部分。</p>
<p>Java 堆不需要连续内存，并且可以通过动态增加其内存，增加失败会抛出 OutOfMemoryError 异常。</p>
<h2 id="方法区（Method-Area）"><a href="#方法区（Method-Area）" class="headerlink" title="方法区（Method Area）"></a>方法区（Method Area）</h2><ul>
<li>用于存放已被加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。</li>
<li>和 Java 堆一样不需要连续的内存，并且可以动态扩展，动态扩展失败一样会抛出 OutOfMemoryError 异常。</li>
<li>对这块区域进行垃圾回收的主要目标是对常量池的回收和对类的卸载，但是一般比较难实现，HotSpot 虚拟机把它当成永久代（Permanent Generation）来进行垃圾回收。</li>
</ul>
<p>** 运行时常量池（Runtime Constant Pool）**</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">运行时常量池是方法区的一部分。</span><br><span class="line">Class 文件中的常量池（编译器生成的各种字面量和符号引用）会在类加载后被放入这个区域。</span><br><span class="line">除了在编译期生成的常量，还允许动态生成，例如 String 类的 intern()。这部分常量也会被放入运行时常量池。</span><br></pre></td></tr></table></figure>
<p>在 JDK1.7之前，HotSpot 使用永久代实现方法区；从 JDK1.7 开始HotSpot 开始移除永久代。其中符号引用（Symbols）被移动到 Native Heap中，字符串常量和类引用被移动到 Java Heap中。</p>
<p>在 JDK1.8 中，永久代已完全被元空间(Meatspace)所取代。元空间的本质和永久代类似，都是对JVM规范中方法区的实现。不过元空间与永久代之间最大的区别在于：元空间并不在虚拟机中，而是使用本地内存。因此，默认情况下，元空间的大小仅受本地内存限制。</p>
<p>** 直接内存（Direct Memory）**<br>&emsp;&emsp;直接内存（Direct Memory）并不是虚拟机运行时数据区的一部分，也不是Java虚拟机规范中定义的内存区域，但是这部分内存也被频繁地使用，而且也可能导致OutOfMemoryError 异常出现。<br>在 JDK 1.4 中新加入了 NIO 类，引入了一种基于通道（Channel）与缓冲区（Buffer）的 I/O方式，它可以使用 Native 函数库直接分配堆外内存，然后通过一个存储在 Java 堆里的 DirectByteBuffer 对象作为这块内存的引用进行操作。这样能在一些场景中显著提高性能，因为避免了在Java 堆和 Native 堆中来回复制数据。</p>
<p><img src="https://img.huyunshun.com/img/20200423160656.png" alt="20200423160656"></p>
<p>   （1）如果线程请求的栈深度太深，超出了虚拟机所允许的深度，就会出现StackOverFlowError（比如无限递归。因为每一层栈帧都占用一定空间，而 Xss 规定了栈的最大空间，超出这个值就会报错）</p>
<p>   （2）虚拟机栈可以动态扩展，如果扩展到无法申请足够的内存空间，会出现OOM</p>
<h2 id="OutOfMemoryError异常"><a href="#OutOfMemoryError异常" class="headerlink" title="OutOfMemoryError异常"></a>OutOfMemoryError异常</h2><p>除了程序计数器外，虚拟机内存的其他几个运行时区域都有发生OutOfMemoryError（下文称OOM）异常的可能。</p>
<h3 id="Java堆溢出"><a href="#Java堆溢出" class="headerlink" title="Java堆溢出"></a>Java堆溢出</h3><p>Java堆用于储存对象实例，我们只要不断地创建对象，并且保证GC Roots到对象之间有可达路径来避免垃圾回收机制清除这些对象，就会在对象数量到达最大堆的容量限制后产生内存溢出异常。</p>
<p>Java堆内存溢出异常测试</p>
<p>限制Java堆的大小为20MB，不可扩展（将堆的最小值-Xms参数与最大值-Xmx参数设置为一样即可避免堆自动扩展），通过参数-XX:+HeapDump OnOutOfMemoryError可以让虚拟机在出现内存溢出异常时Dump出当前的内存堆转储快照以便事后进行分析。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** VM Args：-Xms20m -Xmx20m -XX:+HeapDumpOnOutOfMemoryError */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OOMObject</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    List&lt;OOMObject&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        list.add(<span class="keyword">new</span> OOMObject());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java.lang.OutOfMemoryError: Java heap space</span><br><span class="line">Dumping heap to java_pid14104.hprof ...</span><br><span class="line">Heap dump file created [29232817 bytes in 0.273 secs]</span><br><span class="line">Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Java heap space</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Java堆内存的OOM异常是实际应用中最常见的内存溢出异常情况。出现Java堆内存溢出时，异常堆栈信息“java.lang.OutOfMemoryError”会跟着进一步提示“Java heap space”。</p>
<p>内存分析：</p>
<p>上示例所示，生成文件 java_pid14104.hprof，打开文件信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">D:\java-workspaces\idea-work\huajin&gt;jhat java_pid14104.hprof</span><br><span class="line">Reading from java_pid14104.hprof...</span><br><span class="line">Dump file created Tue Oct 08 15:23:06 CST 2019</span><br><span class="line">Snapshot read, resolving...</span><br><span class="line">Resolving 830511 objects...</span><br><span class="line">Chasing references, expect 166 dots......................................................................................................................................................................</span><br><span class="line">Eliminating duplicate references......................................................................................................................................................................</span><br><span class="line">Snapshot resolved.</span><br><span class="line">Started HTTP server on port 7000</span><br><span class="line">Server is ready.</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;  </span><br><span class="line">  若有时dump文件很大，需要设置jhat参数：jhat -J-Xmx2048m &lt;heap dump file&gt;，但是默认情况下是1024m。</span><br><span class="line"></span><br><span class="line">就可以找到文件：   </span><br><span class="line"></span><br><span class="line">![20200423160713](https:&#x2F;&#x2F;img.huyunshun.com&#x2F;img&#x2F;20200423160713.png)</span><br><span class="line"></span><br><span class="line">这种是通过jhat命令打开访问dump文件。</span><br><span class="line"></span><br><span class="line">要解决这个区域的异常，一般通过内存映像分析工具（eclipse里面有 Eclipse Memory Analyzer，在idea中是JProfilerl或Java自带的JVisualVM）对dump出来的堆转储快照进行分析，重点是确认内存中的对象是否是必要的，也就是要先分清楚到底是出现了内存泄漏（Memory Leak）还是内存溢出（Memory Overflow）。</span><br><span class="line"></span><br><span class="line">* 如果是内存泄漏，可进一步通过工具查看泄漏对象到GC Roots的引用链。于是就能找到泄漏对象是通过怎样的路径与GC Roots相关联并导致垃圾收集器无法自动回收它们的。掌握了泄漏对象的类型信息，以及GC Roots引用链的信息，就可以比较准确地定位出泄漏代码的位置。</span><br><span class="line">* 如果不存在泄漏，换句话说就是内存中的对象确实都还必须存活着，那就应当检查虚拟机的堆参数（-Xmx与-Xms），与机器物理内存对比看是否还可以调大，从代码上检查是否存在某些对象生命周期过长、持有状态时间过长的情况，尝试减少程序运行期的内存消耗。</span><br><span class="line"></span><br><span class="line">以上是处理Java堆内存问题的简略思路，处理这些问题所需要的知识、工具与经验是后面三章的主题。</span><br><span class="line"></span><br><span class="line">### 虚拟机栈和本地方法栈溢出</span><br><span class="line"></span><br><span class="line">由于在HotSpot虚拟机中并不区分虚拟机栈和本地方法栈，因此对于HotSpot来说，-Xoss参数（设置本地方法栈大小）虽然存在，但实际上是无效的，栈容量只由-Xss参数设定。关于虚拟机栈和本地方法栈，在Java虚拟机规范中描述了两种异常：</span><br><span class="line"></span><br><span class="line">* 如果线程请求的栈深度大于虚拟机所允许的最大深度，将抛出StackOverflowError异常。</span><br><span class="line">* 如果虚拟机在扩展栈时无法申请到足够的内存空间，则抛出OutOfMemoryError异常。</span><br><span class="line"></span><br><span class="line">这里把异常分成两种情况看似更加严谨，但却存在着一些互相重叠的地方：当栈空间无法继续分配时，到底是内存太小，还是已使用的栈空间太大，其本质上只是对同一件事情的两种描述而已。</span><br><span class="line"></span><br><span class="line">* 使用-Xss参数减少栈内存容量。结果：抛出StackOverflowError异常，异常出现时输出的栈深度相应缩小。</span><br><span class="line">* 定义了大量的本地变量，增加此方法帧中本地变量表的长度。结果：抛出StackOverflowError异常时输出的栈深度相应缩小。</span><br><span class="line"></span><br><span class="line">虚拟机栈和本地方法栈OOM测试（仅作为第1点测试程序）</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;java</span><br><span class="line">    private int stackLength &#x3D; 1;</span><br><span class="line"></span><br><span class="line">    &#x2F;** -Xss128k *&#x2F;</span><br><span class="line">    public void stackLeak() &#123;</span><br><span class="line">        stackLength++;</span><br><span class="line">        stackLeak();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Throwable &#123;</span><br><span class="line">        Demo oom &#x3D; new Demo();</span><br><span class="line">        try &#123;</span><br><span class="line">            oom.stackLeak();</span><br><span class="line">        &#125; catch (Throwable e) &#123;</span><br><span class="line">            System.out.println(&quot;stack length:&quot; + oom.stackLength);</span><br><span class="line">            throw e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stack length:997</span><br><span class="line">Exception in thread &quot;main&quot; java.lang.StackOverflowError</span><br></pre></td></tr></table></figure>

<p>实验结果表明：在单个线程下，无论是由于栈帧太大，还是虚拟机栈容量太小，当内存无法分配的时候，虚拟机抛出的都是StackOverflowError异常。</p>
<p>如果测试时不限于单线程，通过不断地建立线程的方式倒是可以产生内存溢出异常，这样产生的内存溢出异常与栈空间是否足够大并不存在任何联系，或者准确地说，在这种情况下，给每个线程的栈分配的内存越大，反而越容易产生内存溢出异常。</p>
<p>原因其实不难理解，操作系统分配给每个进程的内存是有限制的，譬如32位的Windows限制为2GB。虚拟机提供了参数来控制Java堆和方法区的这两部分内存的最大值。剩余的内存为2GB（操作系统限制）减去Xmx（最大堆容量），再减去MaxPermSize（最大方法区容量），程序计数器消耗内存很小，可以忽略掉。如果虚拟机进程本身耗费的内存不计算在内，剩下的内存就由虚拟机栈和本地方法栈“瓜分”了。每个线程分配到的栈容量越大，可以建立的线程数量自然就越少，建立线程时就越容易把剩下的内存耗尽。</p>
<p>这一点读者需要在开发多线程应用的时候特别注意，出现StackOverflowError异常时有错误堆栈可以阅读，相对来说，比较容易找到问题的所在。而且，如果使用虚拟机默认参数，栈深度在大多数情况下（因为每个方法压入栈的帧大小并不是一样的，所以只能说大多数情况下）达到1000～2000完全没有问题，对于正常的方法调用（包括递归），这个深度应该完全够用了。但是，如果是建立过多线程导致的内存溢出，在不能减少线程数或者更换64位虚拟机的情况下，就只能通过减少最大堆和减少栈容量来换取更多的线程。如果没有这方面的经验，这种通过“减少内存”的手段来解决内存溢出的方式会比较难以想到。</p>
<h3 id="运行时常量池溢出"><a href="#运行时常量池溢出" class="headerlink" title="运行时常量池溢出"></a>运行时常量池溢出</h3><p>如果要向运行时常量池中添加内容，最简单的做法就是使用String.intern()这个Native方法。该方法的作用是：如果池中已经包含一个等于此String对象的字符串，则返回代表池中这个字符串的String对象；否则，将此String对象包含的字符串添加到常量池中，并且返回此String对象的引用。由于常量池分配在方法区内，我们可以通过-XX:PermSize和-XX:MaxPermSize限制方法区的大小，从而间接限制其中常量池的容量，如:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * VM Args：-XX:PermSize=1M -XX:MaxPermSize=1M</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 使用List保持着常量池引用，避免Full GC回收常量池行为</span></span><br><span class="line">    List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">// 10MB的PermSize在integer范围内足够产生OOM了</span></span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        list.add(String.valueOf(i++).intern());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: PermGen space at java.lang.String.intern(Native Method) at</span><br></pre></td></tr></table></figure>
<p>从运行结果中可以看到，运行时常量池溢出，在OutOfMemoryError后面跟随的提示信息是“PermGen space”，说明运行时常量池属于方法区（HotSpot虚拟机中的永久代）的一部分。</p>
<h3 id="方法区溢出"><a href="#方法区溢出" class="headerlink" title="方法区溢出"></a>方法区溢出</h3><p>方法区用于存放Class的相关信息，如类名、访问修饰符、常量池、字段描述、方法描述等。对于这个区域的测试，基本的思路是运行时产生大量的类去填满方法区，直到溢出。虽然直接使用Java SE API也可以动态产生类（如反射时的GeneratedConstructorAccessor和动态代理等），借助CGLib直接操作字节码运行时，生成了大量的动态类。在实际应用中：当前的很多主流框架，如Spring和Hibernate对类进行增强时，都会使用到CGLib这类字节码技术，增强的类越多，就需要越大的方法区来保证动态生成的Class可以加载入内存。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * VM Args：-XX:PermSize=10M -XX:MaxPermSize=10M</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line">        enhancer.setSuperclass(OOMObject<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        enhancer.setUseCache(<span class="keyword">false</span>);</span><br><span class="line">        enhancer.setCallback(<span class="keyword">new</span> MethodInterceptor() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> proxy.invokeSuper(obj, args);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        enhancer.create();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OOMObject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<p>Caused by: java.lang.OutOfMemoryError: PermGen space at java.lang.ClassLoader.defineClass1(Native Method) at java.lang.ClassLoader.defineClassCond(ClassLoader.java:632) at java.lang.ClassLoader.defineClass(ClassLoader.java:616) … 8 more</p>
<p>方法区溢出也是一种常见的内存溢出异常，一个类如果要被垃圾收集器回收掉，判定条件是非常苛刻的。在经常动态生成大量Class的应用中，需要特别注意类的回收状况。这类场景除了上面提到的程序使用了GCLib字节码增强外，常见的还有：大量JSP或动态产生JSP文件的应用（JSP第一次运行时需要编译为Java类）、基于OSGi的应用（即使是同一个类文件，被不同的加载器加载也会视为不同的类）等。</p>
<h3 id="直接内存溢出"><a href="#直接内存溢出" class="headerlink" title="直接内存溢出"></a>直接内存溢出</h3><p>DirectMemory容量可通过-XX:MaxDirectMemorySize指定，如果不指定，则默认与Java堆的最大值（-Xmx指定）一样。上面的示例越过了DirectByteBuffer类，直接通过反射获取Unsafe实例并进行内存分配（Unsafe类的getUnsafe()方法限制了只有引导类加载器才会返回实例，也就是设计者希望只有rt.jar中的类才能使用Unsafe的功能）。因为，虽然使用DirectByteBuffer分配内存也会抛出内存溢出异常，但它抛出异常时并没有真正向操作系统申请分配内存，而是通过计算得知内存无法分配，于是手动抛出异常，真正申请分配内存的方法是unsafe. allocateMemory()。</p>
<p>使用unsafe分配本机内存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * VM Args：-Xmx20M -XX:MaxDirectMemorySize=10M</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> _1MB = <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Field unsafeField = Unsafe.class.getDeclaredFields()[0];</span><br><span class="line">    unsafeField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    Unsafe unsafe = (Unsafe) unsafeField.get(<span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        unsafe.allocateMemory(_1MB);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.OutOfMemoryError</span><br><span class="line">	at sun.misc.Unsafe.allocateMemory(Native Method)</span><br><span class="line">	at com.huajin.Demo.main(Demo.java:28)</span><br></pre></td></tr></table></figure>

<p>参考：《深入理解Java虚拟机》</p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/07/23/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%E5%BC%80%E5%8F%91%E5%87%86%E5%A4%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/23/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%E5%BC%80%E5%8F%91%E5%87%86%E5%A4%87/" itemprop="url">微信公众号开发准备</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-23T16:30:13+08:00">
                2019-07-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BE%AE%E4%BF%A1%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">微信开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>** 通讯机制 **   </p>
<p><img src="https://img.huyunshun.com/img/20200423163057.png" alt="20200423163057"></p>
<p>** 接入步骤 **<br>1、填写服务器配置</p>
<p>2、验证服务器地址的有效性</p>
<p>3、依据接口文档实现业务逻辑</p>
<p>第1步中服务器配置包含服务器地址（URL）、令牌(Token) 和 消息加解密密钥(EncodingAESKey)。 ​ 可在开发–&gt;基本配置–&gt;服务器配置中配置，测试号没有EncodingAESKey</p>
<p>​ 服务器地址即公众号后台提供业务逻辑的入口地址，目前只支持80端口，之后包括接入验证以及任何其它的操作的请求（例如消息的发送、菜单管理、素材管理等）都要从这个地址进入。接入验证和其它请求的区别就是，接入验证时是get请求，其它时候是post请求；</p>
<p>Token可由开发者可以任意填写，用作生成签名（该Token会和接口URL中包含的Token进行比对，从而验证安全性）；</p>
<p>EncodingAESKey由开发者手动填写或随机生成，将用作消息体加解密密钥。本例中全部以未加密的明文消息方式，不涉及此配置项。</p>
<p><img src="https://img.huyunshun.com/img/20200423163107.png" alt="20200423163107"></p>
<p>第2步 开发者提交信息后，微信服务器将发送GET请求到填写的服务器地址URL上，GET请求携带参数如下表所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">参数	描述</span><br><span class="line">signature	微信加密签名，signature结合了开发者填写的token参数和请求中的timestamp参数、nonce参数。</span><br><span class="line">timestamp	时间戳</span><br><span class="line">nonce	随机数</span><br><span class="line">echostr	随机字符串\</span><br></pre></td></tr></table></figure>
<p>开发者通过检验signature对请求进行校验（下面有校验方式）。若确认此次GET请求来自微信服务器，请原样返回echostr参数内容，则接入生效，成为开发者成功，否则接入失败。加密/校验流程如下：</p>
<p>1）将token、timestamp、nonce三个参数进行字典序排序 </p>
<p>2）将三个参数字符串拼接成一个字符串进行sha1加密 </p>
<p>3）开发者获得加密后的字符串可与signature对比，标识该请求来源于微信</p>
<p>Spring Boot实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet</span>(<span class="string">"weixin.do"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeixinServlet</span>  <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        String signature = req.getParameter(<span class="string">"signature"</span>);</span><br><span class="line">        String timestamp = req.getParameter(<span class="string">"timestamp"</span>);</span><br><span class="line">        String nonce = req.getParameter(<span class="string">"nonce"</span>);</span><br><span class="line">        String echostr = req.getParameter(<span class="string">"echostr"</span>);</span><br><span class="line"></span><br><span class="line">        PrintWriter out = resp.getWriter();</span><br><span class="line">        <span class="keyword">if</span> (CheckUtil.checkSignature(signature, timestamp, nonce)) &#123;</span><br><span class="line">            out.print(echostr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        doGet(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hu.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.MessageDigest;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> huyunshun 2019/9/11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CheckUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 自定义token, 用作生成签名,从而验证安全性</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String token = <span class="string">"demodemo"</span>;<span class="comment">//token是在验证的时候进行配置的</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">checkSignature</span><span class="params">(String signature,String timestamp,String nonce)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 接收微信服务器发送请求时传递过来的参数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String[] arr = <span class="keyword">new</span> String[]&#123;token,timestamp,nonce&#125;;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 将token、timestamp、nonce三个参数进行字典序排序</span></span><br><span class="line"><span class="comment">         * 并拼接为一个字符串</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Arrays.sort(arr);</span><br><span class="line">        <span class="comment">//生成字符串</span></span><br><span class="line">        StringBuffer content  = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;arr.length;i++)&#123;</span><br><span class="line">            content.append(arr[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//sha1加密</span></span><br><span class="line">        String temp = getSha1(content.toString());</span><br><span class="line">        <span class="comment">//校验微信服务器传递过来的签名 和  加密后的字符串是否一致, 若一致则签名通过</span></span><br><span class="line">        <span class="keyword">return</span> temp.equals(signature);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getSha1</span><span class="params">(String str)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == str || <span class="number">0</span> == str.length())&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">char</span>[] hexDigits = &#123; <span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>,</span><br><span class="line">                <span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>, <span class="string">'f'</span>&#125;;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            MessageDigest mdTemp = MessageDigest.getInstance(<span class="string">"SHA1"</span>);</span><br><span class="line">            mdTemp.update(str.getBytes(<span class="string">"UTF-8"</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">byte</span>[] md = mdTemp.digest();</span><br><span class="line">            <span class="keyword">int</span> j = md.length;</span><br><span class="line">            <span class="keyword">char</span>[] buf = <span class="keyword">new</span> <span class="keyword">char</span>[j * <span class="number">2</span>];</span><br><span class="line">            <span class="keyword">int</span> k = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; j; i++) &#123;</span><br><span class="line">                <span class="keyword">byte</span> byte0 = md[i];</span><br><span class="line">                buf[k++] = hexDigits[byte0 &gt;&gt;&gt; <span class="number">4</span> &amp; <span class="number">0xf</span>];</span><br><span class="line">                buf[k++] = hexDigits[byte0 &amp; <span class="number">0xf</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> String(buf);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动后保证在本地访问没问题，之后使用内网映射工具（如Ngrok）到公网。然后，在测试号中配置：   </p>
<p><img src="https://img.huyunshun.com/img/20200423163124.png" alt="20200423163124"></p>
<p>配置成功后说明，公众号应用已经能够和微信服务器正常通信，公众号已经接入到微信公众平台了。</p>
<p>** access_token **</p>
<p>access_token是公众号的全局唯一接口调用凭据，公众号调用各接口时都需使用access_token。开发者需要进行妥善保存。access_token的存储至少要保留512个字符空间。access_token的有效期目前为2个小时，需定时刷新，重复获取将导致上次获取的access_token失效。</p>
<p>接口调用上限每天2000次，所以不能调用太频繁。</p>
<p>公众号可以使用AppID和AppSecret调用本接口来获取access_token。AppID和AppSecret可在“微信公众平台-开发-基本配置”页中获得（需要已经成为开发者，且帐号没有异常状态）。</p>
<p>调用接口时，请登录“微信公众平台-开发-基本配置”提前将服务器IP地址添加到IP白名单中，点击查看设置方法，否则将无法调用成功。</p>
<p>接口调用请求说明</p>
<p>https请求方式: GET <a href="https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID&amp;secret=APPSECRET" target="_blank" rel="noopener">https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID&amp;secret=APPSECRET</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">参数	是否必须	说明</span><br><span class="line">grant_type	是	获取access_token填写client_credential</span><br><span class="line">appid	是	第三方用户唯一凭证</span><br><span class="line">secret	是	第三方用户唯一凭证密钥，即appsecret</span><br></pre></td></tr></table></figure>
<p>返回说明</p>
<p>正常情况下，微信会返回下述JSON数据包给公众号：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;access_token&quot;:&quot;ACCESS_TOKEN&quot;,&quot;expires_in&quot;:7200&#125;</span><br></pre></td></tr></table></figure>
<p>参数说明</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">参数	说明</span><br><span class="line">access_token	获取到的凭证</span><br><span class="line">expires_in	凭证有效时间，单位：秒</span><br><span class="line">错误时微信会返回错误码等信息，JSON数据包示例如下（该示例为AppID无效错误）:</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;errcode&quot;:40013,&quot;errmsg&quot;:&quot;invalid appid&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>返回码说明</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">返回码	说明</span><br><span class="line">-1	系统繁忙，此时请开发者稍候再试</span><br><span class="line">0	请求成功</span><br><span class="line">40001	AppSecret错误或者AppSecret不属于这个公众号，请开发者确认AppSecret的正确性</span><br><span class="line">40002	请确保grant_type字段值为client_credential</span><br><span class="line">40164	调用接口的IP地址不在白名单中，请在接口IP白名单中进行设置。（小程序及小游戏调用不要求IP地址在白名单内。）</span><br></pre></td></tr></table></figure>

<p>代码实现获取access_token</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccessToken</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String tokenName; <span class="comment">//获取到的凭证</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> expireSecond;    <span class="comment">//凭证有效时间  单位:秒</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccessTokenInfo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> AccessToken accessToken = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">RestController</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/weixin"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccessTokenController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"getweixintoken"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWeixin</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"-----启动AccessTokenController-----"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String appId = <span class="string">"wxe1fe5190eeb82893"</span>;<span class="comment">//request.getParameter("appId");</span></span><br><span class="line">        <span class="keyword">final</span> String appSecret = <span class="string">"22150a2fd88b02b9ae23dad993dd6f7c"</span>;<span class="comment">//request.getParameter("appSecret");</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//获取accessToken</span></span><br><span class="line">                    AccessTokenInfo.accessToken = getAccessToken(appId, appSecret);</span><br><span class="line">                    <span class="comment">//获取成功</span></span><br><span class="line">                    <span class="keyword">if</span> (AccessTokenInfo.accessToken != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//获取到access_token 休眠7000秒,大约2个小时左右</span></span><br><span class="line">                        Thread.sleep(<span class="number">7000</span> * <span class="number">1000</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//获取失败</span></span><br><span class="line">                        Thread.sleep(<span class="number">1000</span> * <span class="number">3</span>); <span class="comment">//获取的access_token为空 休眠3秒</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">"发生异常："</span> + e.getMessage());</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">1000</span> * <span class="number">10</span>); <span class="comment">//发生异常休眠1秒</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e1) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> AccessToken <span class="title">getAccessToken</span><span class="params">(String appId, String appSecret)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 接口地址为https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID&amp;secret=APPSECRET</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * grant_type固定写为client_credential即可。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String url = String.format(<span class="string">"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=%s&amp;secret=%s"</span>, appId, appSecret);</span><br><span class="line">        <span class="comment">//此请求为https的get请求，返回的数据格式为&#123;"access_token":"ACCESS_TOKEN","expires_in":7200&#125;</span></span><br><span class="line">        JSONObject jsonObject = restTemplate.getForObject(url,JSONObject<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        log.info(<span class="string">"获取到的access_token="</span>+jsonObject.getString(<span class="string">"access_token"</span>));</span><br><span class="line"></span><br><span class="line">        AccessToken token = <span class="keyword">new</span> AccessToken();</span><br><span class="line">        token.setTokenName(jsonObject.getString(<span class="string">"access_token"</span>));</span><br><span class="line">        token.setExpireSecond(jsonObject.getInteger(<span class="string">"expires_in"</span>));</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动项目，浏览器访问，控制台：   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">----启动AccessTokenController-----</span><br><span class="line">2019-09-12 10:25:59.899  INFO 12136 --- [      Thread-10] com.hu.config.AccessTokenController      : 获取到的access_token&#x3D;25_yKsFws5iSmFPTQiHBv9r97cDzEXsjY37skMbzdFzSh73q3mkzaSdCP4WUSICQ1DYMPOcxhk8mk4Ynow3koQ-1C-A53jzuY8VsNfNnNccomvBfDZryZzd5RmyR2OSWQph3uroE258k-n9WWPNHJJgAFARTT</span><br></pre></td></tr></table></figure>
<p>OK！</p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/05/25/docker%E9%83%A8%E7%BD%B2spring_boot%E9%A1%B9%E7%9B%AE%EF%BC%88%E4%B8%A4%E7%A7%8D%E6%9E%84%E5%BB%BADocker%E9%95%9C%E5%83%8F%E6%96%B9%E5%BC%8F%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/25/docker%E9%83%A8%E7%BD%B2spring_boot%E9%A1%B9%E7%9B%AE%EF%BC%88%E4%B8%A4%E7%A7%8D%E6%9E%84%E5%BB%BADocker%E9%95%9C%E5%83%8F%E6%96%B9%E5%BC%8F%EF%BC%89/" itemprop="url">docker部署spring boot项目（两种构建Docker镜像方式）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-25T00:00:00+08:00">
                2019-05-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一、通过插件方式"><a href="#一、通过插件方式" class="headerlink" title="一、通过插件方式"></a>一、通过插件方式</h1><p>代码：   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> huyunshun 2019/8/14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">demo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Docker"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8000</span><br></pre></td></tr></table></figure>

<p>Pom：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.hu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docker-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">docker.image.prefix</span>&gt;</span>springboot<span class="tag">&lt;/<span class="name">docker.image.prefix</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.hu.Application<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- Docker maven plugin --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spotify<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docker-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                    &lt;imageName&gt;$&#123;docker.image.prefix&#125;/$&#123;project.artifactId&#125;&lt;/imageName&gt;--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">imageName</span>&gt;</span>hu/dockerdemo<span class="tag">&lt;/<span class="name">imageName</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">dockerDirectory</span>&gt;</span>src/main/docker<span class="tag">&lt;/<span class="name">dockerDirectory</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">targetPath</span>&gt;</span>/<span class="tag">&lt;/<span class="name">targetPath</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$&#123;project.build.directory&#125;<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">include</span>&gt;</span>$&#123;project.build.finalName&#125;.jar<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- Docker maven plugin --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Dockerfile:   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">FROM openjdk:8-jdk-alpine</span><br><span class="line">VOLUME &#x2F;tmp</span><br><span class="line">ADD docker-demo-1.0-SNAPSHOT.jar app.jar</span><br><span class="line">ENTRYPOINT [&quot;java&quot;,&quot;-Djava.security.egd&#x3D;file:&#x2F;dev&#x2F;.&#x2F;urandom&quot;,&quot;-jar&quot;,&quot;&#x2F;app.jar&quot;]</span><br><span class="line"></span><br><span class="line">#构建 Jdk 基础环境，添加 Spring Boot Jar 到镜像中，简单解释一下:</span><br><span class="line">#</span><br><span class="line">#FROM ，表示使用 Jdk8 环境 为基础镜像，如果镜像不是本地的会从 DockerHub 进行下载</span><br><span class="line">#VOLUME ，VOLUME 指向了一个&#x2F;tmp的目录，由于 Spring Boot 使用内置的Tomcat容器，Tomcat 默认使用&#x2F;tmp作为工作目录。这个命令的效果是：在宿主机的&#x2F;var&#x2F;lib&#x2F;docker目录下创建一个临时文件并把它链接到容器中的&#x2F;tmp目录</span><br><span class="line">#ADD ，拷贝文件并且重命名</span><br><span class="line">#ENTRYPOINT ，为了缩短 Tomcat 的启动时间，添加java.security.egd的系统属性指向&#x2F;dev&#x2F;urandom作为 ENTRYPOINT</span><br></pre></td></tr></table></figure>

<p>首先，保证 通过mvn package 打包运行，没有问题。</p>
<p>再进行构建镜像：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">PS D:\java-workspaces\idea-work\spring-boot-sample-demo\docker-demo&gt; mvn package docker:build</span><br><span class="line">[INFO] Scanning for projects...</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] -------------------------&lt; com.hu:docker-demo &gt;-------------------------</span><br><span class="line">[INFO] Building docker-demo 1.0-SNAPSHOT</span><br><span class="line">[INFO] --------------------------------[ jar ]---------------------------------</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] --- maven-resources-plugin:3.1.0:resources (default-resources) @ docker-demo ---</span><br><span class="line">[WARNING] Using platform encoding (GBK actually) to copy filtered resources, i.e. build is platform dependent!</span><br><span class="line">[INFO] Copying 1 resource</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] --- maven-compiler-plugin:3.8.0:compile (default-compile) @ docker-demo ---</span><br><span class="line">[INFO] Nothing to compile - all classes are up to date</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] --- maven-resources-plugin:3.1.0:testResources (default-testResources) @ docker-demo ---</span><br><span class="line">[WARNING] Using platform encoding (GBK actually) to copy filtered resources, i.e. build is platform dependent!</span><br><span class="line">[INFO] skip non existing resourceDirectory D:\java-workspaces\idea-work\spring-boot-sample-demo\docker-demo\src\test\resources</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] --- maven-compiler-plugin:3.8.0:testCompile (default-testCompile) @ docker-demo ---</span><br><span class="line">[INFO] Nothing to compile - all classes are up to date</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] --- maven-surefire-plugin:2.22.1:test (default-test) @ docker-demo ---</span><br><span class="line">[INFO] No tests to run.</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] --- maven-jar-plugin:3.1.1:jar (default-jar) @ docker-demo ---</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] --- spring-boot-maven-plugin:2.1.3.RELEASE:repackage (default) @ docker-demo ---</span><br><span class="line">[INFO] Replacing main artifact with repackaged archive</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] --- docker-maven-plugin:1.0.0:build (default-cli) @ docker-demo ---</span><br><span class="line">[INFO] Using authentication suppliers: [ConfigFileRegistryAuthSupplier]</span><br><span class="line">[INFO] Copying D:\java-workspaces\idea-work\spring-boot-sample-demo\docker-demo\target\docker-demo-1.0-SNAPSHOT.jar -&gt; D:\java-workspaces\idea-work\spring-boot-sample-demo\docker-demo\target\docker\docker-demo-1.0-SNAPSHOT.jar</span><br><span class="line">[INFO] Copying src\main\docker\Dockerfile -&gt; D:\java-workspaces\idea-work\spring-boot-sample-demo\docker-demo\target\docker\Dockerfile</span><br><span class="line">[INFO] Building image hu&#x2F;dockerdemo</span><br><span class="line">Step 1&#x2F;4 : FROM openjdk:8-jdk-alpine</span><br><span class="line"></span><br><span class="line">Pulling from library&#x2F;openjdk</span><br><span class="line">e7c96db7181b: Pull complete</span><br><span class="line">f910a506b6cb: Pull complete</span><br><span class="line">c2274a1a0e27: Pull complete</span><br><span class="line">Digest: sha256:94792824df2df33402f201713f932b58cb9de94a0cd524164a0f2283343547b3</span><br><span class="line">Status: Downloaded newer image for openjdk:8-jdk-alpine</span><br><span class="line"> ---&gt; a3562aa0b991</span><br><span class="line">Step 2&#x2F;4 : VOLUME &#x2F;tmp</span><br><span class="line"></span><br><span class="line"> ---&gt; Running in 85aea02ce334</span><br><span class="line">Removing intermediate container 85aea02ce334</span><br><span class="line"> ---&gt; b32bc2fbb3f0</span><br><span class="line">Step 3&#x2F;4 : ADD docker-demo-1.0-SNAPSHOT.jar app.jar</span><br><span class="line"></span><br><span class="line"> ---&gt; 909569c00d0d</span><br><span class="line">Step 4&#x2F;4 : ENTRYPOINT [&quot;java&quot;,&quot;-Djava.security.egd&#x3D;file:&#x2F;dev&#x2F;.&#x2F;urandom&quot;,&quot;-jar&quot;,&quot;&#x2F;app.jar&quot;]</span><br><span class="line"></span><br><span class="line"> ---&gt; Running in 88c174756528</span><br><span class="line">Removing intermediate container 88c174756528</span><br><span class="line"> ---&gt; b3ca1f38330a</span><br><span class="line">ProgressMessage&#123;id&#x3D;null, status&#x3D;null, stream&#x3D;null, error&#x3D;null, progress&#x3D;null, progressDetail&#x3D;null&#125;</span><br><span class="line">Successfully built b3ca1f38330a</span><br><span class="line">Successfully tagged hu&#x2F;dockerdemo:latest</span><br><span class="line">[INFO] Built hu&#x2F;dockerdemo</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time:  52.666 s</span><br><span class="line">[INFO] Finished at: 2019-08-15T11:47:14+08:00</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>
<p>查看镜像：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PS D:\java-workspaces\idea-work\spring-boot-sample-demo\docker-demo&gt; docker images</span><br><span class="line">REPOSITORY                                      TAG                 IMAGE ID            CREATED              SIZE</span><br><span class="line">hu&#x2F;dockerdemo                                   latest              b3ca1f38330a        About a minute ago   122MB</span><br></pre></td></tr></table></figure>
<p>运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PS D:\java-workspaces\idea-work\spring-boot-sample-demo\docker-demo&gt; docker run --name docker-demo-springboot -p 8000:8000 b3ca1f38330a</span><br><span class="line"></span><br><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> &#x2F;\\ &#x2F; ___&#39;_ __ _ _(_)_ __  __ _ \ \ \ \</span><br><span class="line">( ( )\___ | &#39;_ | &#39;_| | &#39;_ \&#x2F; _&#96; | \ \ \ \</span><br><span class="line"> \\&#x2F;  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  &#39;  |____| .__|_| |_|_| |_\__, | &#x2F; &#x2F; &#x2F; &#x2F;</span><br><span class="line"> &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;|_|&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;|___&#x2F;&#x3D;&#x2F;_&#x2F;_&#x2F;_&#x2F;</span><br><span class="line"> :: Spring Boot ::        (v2.1.3.RELEASE)</span><br></pre></td></tr></table></figure>
<p>启动完成后；就可以访问。</p>
<p>遇到的问题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] Failed to execute goal com.spotify:docker-maven-plugin:1.0.0:build (default-cli) on project docker-demo: Exception caught: java.util.concurrent.ExecutionException: com.spotify.docker.client.shaded.javax.ws.rs.ProcessingException: org.apache.http.conn.HttpHostConnectException: Connect to localhost:2375 [localhost&#x2F;127.0.0.1, localhost&#x2F;0:0:0:0:0:0:0:1] failed: Connection refused: connect -&gt; [Help 1]</span><br></pre></td></tr></table></figure>
<p>设置下docker  </p>
<p><img src="https://img.huyunshun.com/img1/Docker/weqwdsafasfewrfefimgclip.png" alt=""></p>
<h1 id="二、普通方式"><a href="#二、普通方式" class="headerlink" title="二、普通方式"></a>二、普通方式</h1><p>上面的Dockerfile 和 springBoot 打包的项目(可以在pom中去掉docker插件)docker-demo-1.0-SNAPSHOT.jar放到一个目录中   </p>
<p>执行指令：docker build -t hu-docker-demo .</p>
<p>执行docker build命令，docker就会根据Dockerfile里你定义好的命令进行构建新的镜像。</p>
<p>-t ：指定要创建的目标镜像名  名字:镜像的tag<br>.代表当前目录，也就是Dockerfile所在的目录,可以指定Dockerfile 的绝对路径。    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">PS D:\java-workspaces\idea-work\spring-boot-sample-demo\docker-demo\1111&gt; docker build -t hu-docker-demo .</span><br><span class="line">Sending build context to Docker daemon  16.72MB</span><br><span class="line">Step 1&#x2F;4 : FROM openjdk:8-jdk-alpine</span><br><span class="line"> ---&gt; a3562aa0b991</span><br><span class="line">Step 2&#x2F;4 : VOLUME &#x2F;tmp</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; b32bc2fbb3f0</span><br><span class="line">Step 3&#x2F;4 : ADD docker-demo-1.0-SNAPSHOT.jar app.jar</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 48f1eb33fed5</span><br><span class="line">Step 4&#x2F;4 : ENTRYPOINT [&quot;java&quot;,&quot;-Djava.security.egd&#x3D;file:&#x2F;dev&#x2F;.&#x2F;urandom&quot;,&quot;-jar&quot;,&quot;&#x2F;app.jar&quot;]</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 5e7b25db2cbf</span><br><span class="line">Successfully built 5e7b25db2cbf</span><br><span class="line">Successfully tagged hu-docker-demo:latest</span><br><span class="line">SECURITY WARNING: You are building a Docker image from Windows against a non-Windows Docker host. All files and directories added to build context will have &#39;-rwxr-xr-x&#39; permissions. It is recommended to double check and reset permissions for sensitive files and directories.</span><br><span class="line"></span><br><span class="line">#增加了镜像</span><br><span class="line">PS D:\java-workspaces\idea-work\spring-boot-sample-demo\docker-demo\1111&gt; docker images</span><br><span class="line">REPOSITORY                                      TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">docker                                          latest              5e7b25db2cbf        9 minutes ago       122MB</span><br><span class="line">hu-docker-demo                                  latest              5e7b25db2cbf        9 minutes ago       122MB</span><br><span class="line"></span><br><span class="line">#运行</span><br><span class="line">PS D:\java-workspaces\idea-work\spring-boot-sample-demo\docker-demo\1111&gt; docker run --name docker-demo-hu -p 8000:8000 hu-docker-demo</span><br><span class="line"></span><br><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> &#x2F;\\ &#x2F; ___&#39;_ __ _ _(_)_ __  __ _ \ \ \ \</span><br><span class="line">( ( )\___ | &#39;_ | &#39;_| | &#39;_ \&#x2F; _&#96; | \ \ \ \</span><br><span class="line"> \\&#x2F;  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  &#39;  |____| .__|_| |_|_| |_\__, | &#x2F; &#x2F; &#x2F; &#x2F;</span><br><span class="line"> &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;|_|&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;|___&#x2F;&#x3D;&#x2F;_&#x2F;_&#x2F;_&#x2F;</span><br><span class="line"> :: Spring Boot ::        (v2.1.3.RELEASE)</span><br><span class="line"></span><br><span class="line">2019-08-15 05:50:27.972  INFO 1 --- [           main] com.hu.Application                       : Starting Application on 842d73789909 with PID 1 (&#x2F;app.jar started by root in &#x2F;)</span><br><span class="line">2019-08-15 05:50:27.982  INFO 1 --- [           main] com.hu.Application                       : No active profile set, falling back to default profiles: default</span><br><span class="line">2019-08-15 05:50:29.357  INFO 1 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8000 (http)</span><br><span class="line">2019-08-15 05:50:29.390  INFO 1 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span><br><span class="line">2019-08-15 05:50:29.391  INFO 1 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat&#x2F;9.0.16]</span><br><span class="line">2019-08-15 05:50:29.403  INFO 1 --- [           main] o.a.catalina.core.AprLifecycleListener   : The APR based Apache Tomcat Native library which allows optimal performance in production environments was not found on the java.library.path: [&#x2F;usr&#x2F;lib&#x2F;jvm&#x2F;java-1.8-openjdk&#x2F;jre&#x2F;lib&#x2F;amd64&#x2F;server:&#x2F;usr&#x2F;lib&#x2F;jvm&#x2F;java-1.8-openjdk&#x2F;jre&#x2F;lib&#x2F;amd64:&#x2F;usr&#x2F;lib&#x2F;jvm&#x2F;java-1.8-openjdk&#x2F;jre&#x2F;..&#x2F;lib&#x2F;amd64:&#x2F;usr&#x2F;java&#x2F;packages&#x2F;lib&#x2F;amd64:&#x2F;usr&#x2F;lib64:&#x2F;lib64:&#x2F;lib:&#x2F;usr&#x2F;lib]</span><br><span class="line">2019-08-15 05:50:29.470  INFO 1 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[&#x2F;]       : Initializing Spring embedded WebApplicationContext</span><br><span class="line">2019-08-15 05:50:29.470  INFO 1 --- [           main] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in 1392 ms</span><br><span class="line">2019-08-15 05:50:29.701  INFO 1 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService &#39;applicationTaskExecutor&#39;</span><br><span class="line">2019-08-15 05:50:30.044  INFO 1 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8000 (http) with context path &#39;&#39;</span><br><span class="line">2019-08-15 05:50:30.048  INFO 1 --- [           main] com.hu.Application                       : Started Application in 2.773 seconds (JVM running for 3.202)</span><br></pre></td></tr></table></figure>
<p>完成！</p>
<p>提交镜像到hub.docker.com网站；<br>执行docker login登录，期间会要求输入用户名和密码；   </p>
<p>执行命令docker push hu-docker-demo，即可将本地镜像push到hub.docker.com；   注意镜像名称的前缀，例如我这里的前缀是bolingcavalry，要和账号保持一致；   </p>
<p>提交成功后，在hub.docker.com网站即可看到此镜像，如下图，此时任何人都可以pull来下使用了</p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/05/22/Elastic-Job%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/22/Elastic-Job%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/" itemprop="url">Elastic-Job分布式定时任务</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-22T14:53:34+08:00">
                2019-05-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index">
                    <span itemprop="name">分布式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Elastic-Job是当当网大牛基于Zookepper，Quartz开发并且开源的Java分布式定时任务，解决Quartz不支持分布式的弊端。它由两个相互独立的子项目Elastic-Job-Lite和Elastic-Job-Cloud组成。</p>
<h1 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h1><ul>
<li>分片概念：任务分布式的执行，需要将一个任务拆分成多个独立的任务项，然后由分布式的服务器分别执行某一个或几个分片项</li>
<li>个性化参数：shardingItemParameter，可以和分片项匹配对应关系。比如：将商品的状态分成上架，下架。那么配置0=上架,1=下架，代码中直接使用上架下架的枚举值即可完成分片项与业务逻辑的对应关系</li>
<li>作用高可用：将分片总数设置成1，多台服务器执行作业将采用1主n从的方式执行</li>
<li>弹性扩容：将任务拆分为n个任务项后，各个服务器分别执行各自分配到的任务项。一旦有新的服器加入集群或有服务器宕机。Elastic-Job将保留本次任务不变，下次任务开始前重新分片。</li>
<li>并行调度：采用任务分片方式实现。将一个任务拆分为n个独立的任务项，由分布式的服务器并行执行各自分配到的分片项。</li>
<li>集中管理：采用基于zookepper的注册中心，集中管理和协调分布式作业的状态，分配和监听。外部系统可直接根据Zookeeper的数据管理和监控elastic-job。</li>
<li>定制化流程任务：作业可分为简单和数据流处理两种模式，数据流又分为高吞吐处理模式和顺序性处理模式，其中高吞吐处理模式可以开启足够多的线程快速的处理数据，而顺序性处理模式将每个分片项分配到一个独立线程，用于保证同一分片的顺序性，这点类似于kafka的分区顺序性。</li>
</ul>
<p><img src="https://img.huyunshun.com/img/20200423145846.png" alt="20200423145846"></p>
<h1 id="Elastic-Job的具体模块的底层及如何实现"><a href="#Elastic-Job的具体模块的底层及如何实现" class="headerlink" title="Elastic-Job的具体模块的底层及如何实现"></a>Elastic-Job的具体模块的底层及如何实现</h1><p>Elastic-Job采用去中心化设计，主要分为注册中心、数据分片、分布式协调、定时任务处理和定制化流程型任务等模块。</p>
<p>去中心化：指Elastic-Job没有调度中心这一概念。每个运行在集群中的作业服务器都是对等的，节点之间通过注册中心进行分布式协调。<br>但elastic-job有主节点的概念，主节点用于处理一些集中式任务，如分片，清理运行时信息等，并无调度功能，定时调度都是由作业服务器自行触发。    </p>
<p>  | 中心化 | 去中心化<br>-|-|-<br>实现难度  | 难 | 易<br>部署难度 | 难     | 易<br>触发时间统一控制 | 可以 | 不可以<br>触发延迟 | 有     | 无<br>异构语言支持 | 容易 | 困难</p>
<p>** 注册中心** ：注册中心模块目前直接使用zookeeper，用于记录作业的配置，服务器信息以及作业运行状态。Zookeeper虽然很成熟，但原理复杂，使用较难，在海量数据支持的情况下也会有性能和网络问题。<br>**  数据分片** ：数据分片是elastic-job中实现分布式的重要概念，将真实数据和逻辑分片对应，用于解耦作业框架和数据的关系。作业框架只负责将分片合理的分配给相关的作业服务器，而作业服务器需要根据所分配的分片匹配数据进行处理。服务器分片目前都存储在注册中心中，各个服务器根据自己的IP地址拉取分片。<br>** 分布式协调** ：分布式协调模块用于处理作业服务器的动态扩容缩容。一旦集群中有服务器发生变化，分布式协调将自动监测并将变化结果通知仍存活的作业服务器。协调时将会涉及主节点选举，重分片等操作。目前使用的Zookeeper的临时节点和监听器实现主动检查和通知功能。<br>** 定时任务处理** ：定时任务处理根据cron表达式定时触发任务，目前有防止任务同时触发，错过任务重出发等功能。主要还是使用Quartz本身的定时调度功能，为了便于控制，每个任务都使用独立的线程池。<br>** 定制化流程型任务** ：定制化流程型任务将定时任务分为多种流程，有不经任何修饰的简单任务；有用于处理数据的fetchData/processData的数据流任务；以后还将增加消息流任务，文件任务，工作流任务等。用户能以插件的形式扩展并贡献代码。   </p>
<h2 id="作业开发"><a href="#作业开发" class="headerlink" title="作业开发"></a>作业开发</h2><p>Elastic-Job提供Simple、Dataflow和Script 3种作业类型。方法参数shardingContext包含作业配置、片和运行时信息。可通过getShardingTotalCount(), getShardingItem()等方法分别获取分片总数，运行在本作业服务器的分片序列号等。<br>Simple类型的作业：该类型意为简单实现，只需实现SimpleJob接口，重写它的execute方法即可<br>Dataflow类型作业：用于处理数据流，实现DataflowJob接口，并重写两个方法——用于抓取(fetchData方法)和处理(processData方法)数据。比如在fetchData方法里面查询没有上架的商品，在processData方法修改该商品的状态。<br>注意：可通过DataflowJobConfiguration配置是否流式处理。当配置成流式处理，fetchData方法返回值（返回值是集合）是null或长度是0，作业才停止抓取，否则将一直运行。非流式的则每次作业只执行一次这两个方法就结束该作业。<br>Script类型作业：意为脚本类型作业，支持shell、python、perl等类型脚本。只需通过控制台或代码配置scriptCommandLine即可，无需编码。       </p>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>创建一个项目   配置：   </p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">job1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置zookeeper</span></span><br><span class="line"><span class="attr">regCenter:</span></span><br><span class="line">  <span class="attr">serverList:</span> <span class="string">localhost:2181</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">job1</span></span><br></pre></td></tr></table></figure>
<p>注册中心配置：   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  配置zookeeper</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnExpression</span>(<span class="string">"'$&#123;regCenter.serverList&#125;'.length() &gt; 0"</span>) <span class="comment">//ConditionalOnExpression决定是否生效</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobRegistryCenterConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(initMethod = <span class="string">"init"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ZookeeperRegistryCenter <span class="title">regCenter</span><span class="params">(@Value(<span class="string">"$&#123;regCenter.serverList&#125;"</span>)</span> <span class="keyword">final</span> String serverList,</span></span><br><span class="line"><span class="function">                                             @<span class="title">Value</span><span class="params">(<span class="string">"$&#123;regCenter.namespace&#125;"</span>)</span> <span class="keyword">final</span> String namespace) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ZookeeperRegistryCenter(<span class="keyword">new</span> ZookeeperConfiguration(serverList, namespace));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义一个任务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一个任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySimpleJob</span> <span class="keyword">implements</span> <span class="title">SimpleJob</span> </span>&#123;</span><br><span class="line">    Logger logger = LoggerFactory.getLogger(MySimpleJob<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MySimpleJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MySimpleJob</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(ShardingContext shardingContext)</span> </span>&#123;</span><br><span class="line">        logger.info(String.format(<span class="string">"任务：%s  "</span>+</span><br><span class="line">                        <span class="string">"Thread ID: %s   作业分片总数: %s   "</span> +</span><br><span class="line">                        <span class="string">"当前分片项: %s   当前参数: %s  "</span> +</span><br><span class="line">                        <span class="string">"作业名称: %s   作业自定义参数: %s  "</span></span><br><span class="line">                ,</span><br><span class="line">                <span class="keyword">this</span>.name,</span><br><span class="line">                Thread.currentThread().getId(),</span><br><span class="line">                shardingContext.getShardingTotalCount(),</span><br><span class="line">                shardingContext.getShardingItem(),</span><br><span class="line">                shardingContext.getShardingParameter(),</span><br><span class="line">                shardingContext.getJobName(),</span><br><span class="line">                shardingContext.getJobParameter()</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置任务作业：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyJobConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置任务的时候，这里定义了四个参数，分别是：</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * cron：cron表达式，用于控制作业触发时间。</span></span><br><span class="line"><span class="comment">     * shardingTotalCount：作业分片总数</span></span><br><span class="line"><span class="comment">     * shardingItemParameters：分片序列号和参数用等号分隔，多个键值对用逗号分隔</span></span><br><span class="line"><span class="comment">     * 分片序列号从0开始，不可大于或等于作业分片总数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String cron = <span class="string">"0/10 * * * * ?"</span>; <span class="comment">//每十秒</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> shardingTotalCount = <span class="number">2</span>;<span class="comment">//作业分片总数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String shardingItemParameters = <span class="string">"0=A,1=B"</span>;<span class="comment">//分片序列号和参数用等号分隔，多个键值对用逗号分隔</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jobParameters = <span class="string">"hello"</span>;<span class="comment">//作业自定义参数，可通过传递该参数为作业调度的业务方法传参，用于实现带参数的作业</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ZookeeperRegistryCenter regCenter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SimpleJob <span class="title">stockJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 任务</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MySimpleJob(<span class="string">"One"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化作业</span></span><br><span class="line">    <span class="meta">@Bean</span>(initMethod = <span class="string">"init"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> JobScheduler <span class="title">simpleJobScheduler</span><span class="params">(<span class="keyword">final</span> SimpleJob simpleJob)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpringJobScheduler(simpleJob, regCenter, getLiteJobConfiguration(simpleJob.getClass(),</span><br><span class="line">                cron, shardingTotalCount, shardingItemParameters, jobParameters));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> LiteJobConfiguration <span class="title">getLiteJobConfiguration</span><span class="params">(<span class="keyword">final</span> Class&lt;? extends SimpleJob&gt; jobClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                         <span class="keyword">final</span> String cron,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                         <span class="keyword">final</span> <span class="keyword">int</span> shardingTotalCount,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                         <span class="keyword">final</span> String shardingItemParameters,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                         <span class="keyword">final</span> String jobParameters)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 定义作业核心配置</span></span><br><span class="line">        JobCoreConfiguration simpleCoreConfig = JobCoreConfiguration.newBuilder(jobClass.getName(), cron, shardingTotalCount).</span><br><span class="line">                shardingItemParameters(shardingItemParameters).jobParameter(jobParameters).build();</span><br><span class="line">        <span class="comment">// 定义SIMPLE类型配置</span></span><br><span class="line">        SimpleJobConfiguration simpleJobConfig = <span class="keyword">new</span> SimpleJobConfiguration(simpleCoreConfig, jobClass.getCanonicalName());</span><br><span class="line">        <span class="comment">// 定义Lite作业根配置</span></span><br><span class="line">        LiteJobConfiguration simpleJobRootConfig = LiteJobConfiguration.newBuilder(simpleJobConfig).overwrite(<span class="keyword">true</span>).build();</span><br><span class="line">        <span class="keyword">return</span> simpleJobRootConfig;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动后，两个分片交替执行，并且每次都是新启动一个线程执行作业。</p>
<p>如果，修改端口，启动两个实例，查看日志如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">2019-07-30 16:20:50.227  INFO 14088 --- [b.MySimpleJob-2] com.hu.job.MySimpleJob                   : 任务：One  Thread ID: 57   作业分片总数: 2   当前分片项: 1   当前参数: B  作业名称: com.hu.job.MySimpleJob   作业自定义参数: hello  </span><br><span class="line">2019-07-30 16:20:50.226  INFO 14088 --- [b.MySimpleJob-1] com.hu.job.MySimpleJob                   : 任务：One  Thread ID: 56   作业分片总数: 2   当前分片项: 0   当前参数: A  作业名称: com.hu.job.MySimpleJob   作业自定义参数: hello  </span><br><span class="line">2019-07-30 16:21:00.112  INFO 14088 --- [pleJob_Worker-1] com.hu.job.MySimpleJob                   : 任务：One  Thread ID: 26   作业分片总数: 2   当前分片项: 1   当前参数: B  作业名称: com.hu.job.MySimpleJob   作业自定义参数: hello  </span><br><span class="line">2019-07-30 16:21:10.052  INFO 14088 --- [pleJob_Worker-1] com.hu.job.MySimpleJob                   : 任务：One  Thread ID: 26   作业分片总数: 2   当前分片项: 1   当前参数: B  作业名称: com.hu.job.MySimpleJob   作业自定义参数: hello  </span><br><span class="line">2019-07-30 16:21:20.036  INFO 14088 --- [pleJob_Worker-1] com.hu.job.MySimpleJob                   : 任务：One  Thread ID: 26   作业分片总数: 2   当前分片项: 1   当前参数: B  作业名称: com.hu.job.MySimpleJob   作业自定义参数: hello  </span><br><span class="line">2019-07-30 16:21:30.039  INFO 14088 --- [pleJob_Worker-1] com.hu.job.MySimpleJob                   : 任务：One  Thread ID: 26   作业分片总数: 2   当前分片项: 1   当前参数: B  作业名称: com.hu.job.MySimpleJob   作业自定义参数: hello  </span><br><span class="line">2019-07-30 16:21:40.048  INFO 14088 --- [pleJob_Worker-1] com.hu.job.MySimpleJob                   : 任务：One  Thread ID: 26   作业分片总数: 2   当前分片项: 1   当前参数: B  作业名称: com.hu.job.MySimpleJob   作业自定义参数: hello  </span><br><span class="line">2019-07-30 16:21:50.043  INFO 14088 --- [pleJob_Worker-1] com.hu.job.MySimpleJob                   : 任务：One  Thread ID: 26   作业分片总数: 2   当前分片项: 1   当前参数: B  作业名称: com.hu.job.MySimpleJob   作业自定义参数: hello</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2019-07-30 16:21:00.181  INFO 3348 --- [pleJob_Worker-1] com.hu.job.MySimpleJob                   : ▒▒▒▒One  Thread ID: 20   ▒▒ҵ▒▒Ƭ▒▒▒▒: 2   ▒▒ǰ▒▒Ƭ▒▒: 0   ▒▒ǰ▒▒▒▒: A  ▒▒ҵ▒▒▒▒: com.hu.job.MySimpleJob   ▒▒ҵ▒Զ▒▒▒▒▒▒: hello</span><br><span class="line">2019-07-30 16:21:10.065  INFO 3348 --- [pleJob_Worker-1] com.hu.job.MySimpleJob                   : ▒▒▒▒One  Thread ID: 20   ▒▒ҵ▒▒Ƭ▒▒▒▒: 2   ▒▒ǰ▒▒Ƭ▒▒: 0   ▒▒ǰ▒▒▒▒: A  ▒▒ҵ▒▒▒▒: com.hu.job.MySimpleJob   ▒▒ҵ▒Զ▒▒▒▒▒▒: hello</span><br><span class="line">2019-07-30 16:21:20.048  INFO 3348 --- [pleJob_Worker-1] com.hu.job.MySimpleJob                   : ▒▒▒▒One  Thread ID: 20   ▒▒ҵ▒▒Ƭ▒▒▒▒: 2   ▒▒ǰ▒▒Ƭ▒▒: 0   ▒▒ǰ▒▒▒▒: A  ▒▒ҵ▒▒▒▒: com.hu.job.MySimpleJob   ▒▒ҵ▒Զ▒▒▒▒▒▒: hello</span><br><span class="line">2019-07-30 16:21:30.052  INFO 3348 --- [pleJob_Worker-1] com.hu.job.MySimpleJob                   : ▒▒▒▒One  Thread ID: 20   ▒▒ҵ▒▒Ƭ▒▒▒▒: 2   ▒▒ǰ▒▒Ƭ▒▒: 0   ▒▒ǰ▒▒▒▒: A  ▒▒ҵ▒▒▒▒: com.hu.job.MySimpleJob   ▒▒ҵ▒Զ▒▒▒▒▒▒: hello</span><br></pre></td></tr></table></figure>
<p>可以看出，刚开始没有启动第二个实例的时候，分片交替作业，，当第二个实例启动以后，由于分成两片，就分别执行。</p>
<h2 id="注册中心数据结构"><a href="#注册中心数据结构" class="headerlink" title="注册中心数据结构"></a>注册中心数据结构</h2><p><img src="https://img.huyunshun.com/img/20200423145907.png" alt="20200423145907"></p>
<p>作业名称节点下又包含4个数据子节点，分别是config, instances, sharding, servers和leader。</p>
<h3 id="config节点"><a href="#config节点" class="headerlink" title="config节点"></a>config节点</h3><p>作业配置信息，以JSON格式存储</p>
<h3 id="instances节点"><a href="#instances节点" class="headerlink" title="instances节点"></a>instances节点</h3><p>作业运行实例信息，子节点是当前作业运行实例的主键。作业运行实例主键由作业运行服务器的IP地址和PID构成。作业运行实例主键均为临时节点，当作业实例上线时注册，下线时自动清理。注册中心监控这些节点的变化来协调分布式作业的分片以及高可用。 可在作业运行实例节点写入TRIGGER表示该实例立即执行一次。</p>
<h3 id="sharding节点"><a href="#sharding节点" class="headerlink" title="sharding节点"></a>sharding节点</h3><p>作业分片信息，子节点是分片项序号，从零开始，至分片总数减一。分片项序号的子节点存储详细信息。每个分片项下的子节点用于控制和记录分片运行状态。节点详细信息说明：</p>
<table>
<thead>
<tr>
<th>子节点名</th>
<th>临时节点</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>instance</td>
<td>否</td>
<td>执行该分片项的作业运行实例主键</td>
</tr>
<tr>
<td>running</td>
<td>是</td>
<td>分片项正在运行的状态 仅配置monitorExecution时有效</td>
</tr>
<tr>
<td>failover</td>
<td>是</td>
<td>如果该分片项被失效转移分配给其他作业服务器，则此节点值记录执行此分片的作业服务器IP</td>
</tr>
<tr>
<td>misfire</td>
<td>否</td>
<td>是否开启错过任务重新执行</td>
</tr>
<tr>
<td>disabled</td>
<td>否</td>
<td>是否禁用此分片项</td>
</tr>
</tbody></table>
<h3 id="servers节点"><a href="#servers节点" class="headerlink" title="servers节点"></a>servers节点</h3><p>作业服务器信息，子节点是作业服务器的IP地址。可在IP地址节点写入DISABLED表示该服务器禁用。 在新的cloud native架构下，servers节点大幅弱化，仅包含控制服务器是否可以禁用这一功能。为了更加纯粹的实现job核心，servers功能未来可能删除，控制服务器是否禁用的能力应该下放至自动化部署系统。</p>
<h3 id="leader节点"><a href="#leader节点" class="headerlink" title="leader节点"></a>leader节点</h3><p>作业服务器主节点信息，分为election，sharding和failover三个子节点。分别用于主节点选举，分片和失效转移处理。</p>
<p>leader节点是内部使用的节点，如果对作业框架原理不感兴趣，可不关注此节点。</p>
<table>
<thead>
<tr>
<th>子节点名</th>
<th>临时节点</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>election\instance</td>
<td>是</td>
<td>主节点服务器IP地址</br> 一旦该节点被删除将会触发重新选举</br> 重新选举的过程中一切主节点相关的操作都将阻塞</td>
</tr>
<tr>
<td>election\latch</td>
<td>否</td>
<td>主节点选举的分布式锁</br> 为curator的分布式锁使用</td>
</tr>
<tr>
<td>sharding\necessary</td>
<td>否</td>
<td>是否需要重新分片的标记</br> 如果分片总数变化，或作业服务器节点上下线或启用/禁用，以及主节点选举，会触发设置重分片标记</br> 作业在下次执行时使用主节点重新分片，且中间不会被打断</br> 作业执行时不会触发分片</td>
</tr>
<tr>
<td>sharding\processing</td>
<td>是</td>
<td>主节点在分片时持有的节点</br> 如果有此节点，所有的作业执行都将阻塞，直至分片结束</br> 主节点分片结束或主节点崩溃会删除此临时节点</td>
</tr>
<tr>
<td>failover\items\分片项</td>
<td>否</td>
<td>一旦有作业崩溃，则会向此节点记录</br> 当有空闲作业服务器时，会从此节点抓取需失效转移的作业项</td>
</tr>
<tr>
<td>failover\items\latch</td>
<td>否</td>
<td>分配失效转移分片项时占用的分布式锁</br> 为curator的分布式锁使用</td>
</tr>
</tbody></table>
<p><a href="https://blog.csdn.net/qq924862077/article/details/82956790" target="_blank" rel="noopener">https://blog.csdn.net/qq924862077/article/details/82956790</a></p>
<p>代码见：<a href="https://github.com/huingsn/tech-point-record" target="_blank" rel="noopener">https://github.com/huingsn/tech-point-record</a></p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/05/21/Docker_Kubernetes%E9%A1%B9%E7%9B%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/21/Docker_Kubernetes%E9%A1%B9%E7%9B%AE/" itemprop="url">Docker Kubernetes项目</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-21T00:00:00+08:00">
                2019-05-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>Kubernetes 是 Google 团队发起并维护的基于 Docker 的开源容器集群管理系统，它不仅支持常见的云平台，而且支持内部数据中心。</p>
<p>建于 Docker 之上的 Kubernetes 可以构建一个容器的调度服务，其目的是让用户透过 Kubernetes 集群来进行云端容器集群的管理，而无需用户进行复杂的设置工作。系统会自动选取合适的工作节点来执行具体的容器集群调度处理工作。其核心概念是 Container Pod。一个 Pod 由一组工作于同一物理工作节点的容器构成。这些组容器拥有相同的网络命名空间、IP以及存储配额，也可以根据实际情况对每一个 Pod 进行端口映射。此外，Kubernetes 工作节点会由主系统进行管理，节点包含了能够运行 Docker 容器所用到的服务。</p>
<p>它的目标是管理跨多个主机的容器，提供基本的部署，维护以及运用伸缩，主要实现语言为 Go 语言。Kubernetes 是：</p>
<ul>
<li>易学：轻量级，简单，容易理解</li>
<li>便携：支持公有云，私有云，混合云，以及多种云平台</li>
<li>可拓展：模块化，可插拔，支持钩子，可任意组合</li>
<li>自修复：自动重调度，自动重启，自动复制</li>
</ul>
<p>Kubernetes 构建于 Google 数十年经验，一大半来源于 Google 生产环境规模的经验。结合了社区最佳的想法和实践。</p>
<p>在分布式系统中，部署，调度，伸缩一直是最为重要的也最为基础的功能。Kubernetes 就是希望解决这一序列问题的。</p>
<h1 id="基本说明"><a href="#基本说明" class="headerlink" title="基本说明"></a>基本说明</h1><p><img src="https://img.huyunshun.com/img1/Docker/sdfgdgd43543fdf323s257imgclip_1.png" alt=""></p>
<p>具体见 Kubernetes 学习笔记</p>
<h1 id="快速部署"><a href="#快速部署" class="headerlink" title="快速部署"></a>快速部署</h1><p><img src="https://img.huyunshun.com/img1/Docker/sdfgdgd43543fdf323s257imgclip.png" alt=""></p>
<p>Kubernetes 依赖 Etcd 服务来维护所有主节点的状态。Etcd 参见etcd项目介绍。</p>
<h3 id="启动-Etcd-服务"><a href="#启动-Etcd-服务" class="headerlink" title="启动 Etcd 服务"></a>启动 Etcd 服务</h3><p>docker run –net=host -d gcr.io/google_containers/etcd:2.0.9 /usr/local/bin/etcd –addr=127.0.0.1:4001 –bind-addr=0.0.0.0:4001 –data-dir=/var/etcd/data</p>
<h3 id="启动主节点（启动-kubelet）"><a href="#启动主节点（启动-kubelet）" class="headerlink" title="启动主节点（启动 kubelet）"></a>启动主节点（启动 kubelet）</h3><p>docker run –net=host -d -v /var/run/docker.sock:/var/run/docker.sock  gcr.io/google_containers/hyperkube:v0.17.0 /hyperkube kubelet –api_servers=<a href="http://localhost:8080" target="_blank" rel="noopener">http://localhost:8080</a> –v=2 –address=0.0.0.0 –enable_server –hostname_override=127.0.0.1 –config=/etc/kubernetes/manifests</p>
<h3 id="启动服务代理"><a href="#启动服务代理" class="headerlink" title="启动服务代理"></a>启动服务代理</h3><p>docker run -d –net=host –privileged gcr.io/google_containers/hyperkube:v0.17.0 /hyperkube proxy –master=<a href="http://127.0.0.1:8080" target="_blank" rel="noopener">http://127.0.0.1:8080</a> –v=2</p>
<p>测试：在本地访问 8080 端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ curl 127.0.0.1:8080</span><br><span class="line">&#123;</span><br><span class="line">  &quot;paths&quot;: [</span><br><span class="line">    &quot;&#x2F;api&quot;,</span><br><span class="line">    &quot;&#x2F;api&#x2F;v1beta1&quot;,</span><br><span class="line">    &quot;&#x2F;api&#x2F;v1beta2&quot;,</span><br><span class="line">    &quot;&#x2F;api&#x2F;v1beta3&quot;,</span><br><span class="line">    &quot;&#x2F;healthz&quot;,</span><br><span class="line">    &quot;&#x2F;healthz&#x2F;ping&quot;,</span><br><span class="line">    &quot;&#x2F;logs&#x2F;&quot;,</span><br><span class="line">    &quot;&#x2F;metrics&quot;,</span><br><span class="line">    &quot;&#x2F;static&#x2F;&quot;,</span><br><span class="line">    &quot;&#x2F;swagger-ui&#x2F;&quot;,</span><br><span class="line">    &quot;&#x2F;swaggerapi&#x2F;&quot;,</span><br><span class="line">    &quot;&#x2F;validate&quot;,</span><br><span class="line">    &quot;&#x2F;version&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="查看服务"><a href="#查看服务" class="headerlink" title="查看服务"></a>查看服务</h3><p>所有服务启动后，查看本地实际运行的 Docker 容器，有如下几个。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CONTAINER ID        IMAGE                                        COMMAND                CREATED             STATUS              PORTS               NAMES</span><br><span class="line">ee054db2516c        gcr.io&#x2F;google_containers&#x2F;hyperkube:v0.17.0   &quot;&#x2F;hyperkube schedule   2 days ago          Up 1 days                               k8s_scheduler.509f29c9_k8s-master-127.0.0.1_default_9941e5170b4365bd4aa91f122ba0c061_e97037f5</span><br><span class="line">3b0f28de07a2        gcr.io&#x2F;google_containers&#x2F;hyperkube:v0.17.0   &quot;&#x2F;hyperkube apiserve   2 days ago          Up 1 days                               k8s_apiserver.245e44fa_k8s-master-127.0.0.1_default_9941e5170b4365bd4aa91f122ba0c061_6ab5c23d</span><br><span class="line">2eaa44ecdd8e        gcr.io&#x2F;google_containers&#x2F;hyperkube:v0.17.0   &quot;&#x2F;hyperkube controll   2 days ago          Up 1 days                               k8s_controller-manager.33f83d43_k8s-master-127.0.0.1_default_9941e5170b4365bd4aa91f122ba0c061_1a60106f</span><br><span class="line">30aa7163cbef        gcr.io&#x2F;google_containers&#x2F;hyperkube:v0.17.0   &quot;&#x2F;hyperkube proxy --   2 days ago          Up 1 days                               jolly_davinci</span><br><span class="line">a2f282976d91        gcr.io&#x2F;google_containers&#x2F;pause:0.8.0         &quot;&#x2F;pause&quot;               2 days ago          Up 2 days                               k8s_POD.e4cc795_k8s-master-127.0.0.1_default_9941e5170b4365bd4aa91f122ba0c061_e8085b1f</span><br><span class="line">c060c52acc36        gcr.io&#x2F;google_containers&#x2F;hyperkube:v0.17.0   &quot;&#x2F;hyperkube kubelet    2 days ago          Up 1 days                               serene_nobel</span><br><span class="line">cc3cd263c581        gcr.io&#x2F;google_containers&#x2F;etcd:2.0.9          &quot;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;etcd   2 days ago          Up 1 days                               happy_turing</span><br></pre></td></tr></table></figure>
<p>这些服务大概分为三类：主节点服务、工作节点服务和其它服务。</p>
<h3 id="主节点服务"><a href="#主节点服务" class="headerlink" title="主节点服务"></a>主节点服务</h3><p>apiserver 是整个系统的对外接口，提供 RESTful 方式供客户端和其它组件调用；</p>
<p>scheduler 负责对资源进行调度，分配某个 pod 到某个节点上；</p>
<p>controller-manager 负责管理控制器，包括 endpoint-controller（刷新服务和 pod 的关联信息）和 replication-controller（维护某个 pod 的复制为配置的数值）。</p>
<h3 id="工作节点服务"><a href="#工作节点服务" class="headerlink" title="工作节点服务"></a>工作节点服务</h3><p>kubelet 是工作节点执行操作的 agent，负责具体的容器生命周期管理，根据从数据库中获取的信息来管理容器，并上报 pod 运行状态等；</p>
<p>proxy 为 pod 上的服务提供访问的代理。</p>
<h3 id="其它服务"><a href="#其它服务" class="headerlink" title="其它服务"></a>其它服务</h3><p>Etcd 是所有状态的存储数据库；</p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/05/20/Docker_Etcd%E9%A1%B9%E7%9B%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/20/Docker_Etcd%E9%A1%B9%E7%9B%AE/" itemprop="url">Docker Etcd项目</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-20T00:00:00+08:00">
                2019-05-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Etcd 是 CoreOS 团队发起的一个管理配置信息和服务发现（Service Discovery）的项目。</p>
<p>它的目标是构建一个高可用的分布式键值（key-value）数据库，基于 Go 语言实现。在分布式系统中，各种服务的配置信息的管理分享，服务的发现是一个很基本同时也是很重要的问题。CoreOS 项目就希望基于 etcd 来解决这一问题。etcd 目前在 github.com/etcd-io/etcd 进行维护。</p>
<p>受到 Apache ZooKeeper 项目和 doozer 项目的启发，etcd 在设计的时候重点考虑了下面四个要素：</p>
<ul>
<li><p>简单：具有定义良好、面向用户的 API (gRPC)</p>
</li>
<li><p>安全：支持 HTTPS 方式的访问</p>
</li>
<li><p>快速：支持并发 10 k/s 的写操作</p>
</li>
<li><p>可靠：支持分布式结构，基于 Raft 的一致性算法</p>
</li>
<li><p>Apache ZooKeeper 是一套知名的分布式系统中进行同步和一致性管理的工具。</p>
</li>
<li><p>doozer 是一个一致性分布式数据库。</p>
</li>
<li><p>Raft 是一套通过选举主节点来实现分布式系统一致性的算法，相比于大名鼎鼎的 Paxos 算法，它的过程更容易被人理解，由 Stanford 大学的 Diego Ongaro 和 John Ousterhout 提出。更多细节可以参考 raftconsensus.github.io。</p>
</li>
</ul>
<p>一般情况下，用户使用 etcd 可以在多个节点上启动多个实例，并添加它们为一个集群。同一个集群中的 etcd 实例将会保持彼此信息的一致性。</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="二进制文件方式下载"><a href="#二进制文件方式下载" class="headerlink" title="二进制文件方式下载"></a>二进制文件方式下载</h2><p>编译好的二进制文件都在 github.com/etcd-io/etcd/releases 页面，用户可以选择需要的版本：</p>
<p>下载解压：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_3_centos ~]#curl -L https:&#x2F;&#x2F;github.com&#x2F;etcd-io&#x2F;etcd&#x2F;releases&#x2F;download&#x2F;v3.4.0&#x2F;etcd-v3.4.0-linux-amd64.tar.gz -o etcd-v3.4.0-linux-amd64.tar.gz</span><br><span class="line">[root@VM_0_3_centos ~]#tar xzf etcd-v3.4.0-linux-amd64.tar.gz</span><br><span class="line">[root@VM_0_3_centos ~]# ls</span><br><span class="line">dockerfile  etcd-v3.4.0-linux-amd64  etcd-v3.4.0-linux-amd64.tar.gz</span><br><span class="line">[root@VM_0_3_centos ~]# mv etcd-v3.4.0-linux-amd64 &#x2F;usr&#x2F;local&#x2F;etcd3.4&#x2F;</span><br><span class="line"></span><br><span class="line">[root@VM_0_3_centos ~]# ls &#x2F;usr&#x2F;local&#x2F;etcd3.4&#x2F;</span><br><span class="line">Documentation  etcd  etcdctl  README-etcdctl.md  README.md  READMEv2-etcdctl.md</span><br><span class="line">[root@VM_0_3_centos ~]# cd &#x2F;usr&#x2F;local&#x2F;etcd3.4&#x2F;</span><br></pre></td></tr></table></figure>
<p>复制到目录，并且复制到bin，etcd 是服务主文件，etcdctl 是提供给用户的命令客户端。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_3_centos etcd3.4]# cp etcd* &#x2F;usr&#x2F;local&#x2F;bin&#x2F;</span><br><span class="line">[root@VM_0_3_centos etcd3.4]# ls &#x2F;usr&#x2F;local&#x2F;bin&#x2F;</span><br><span class="line">etcd  etcdctl</span><br></pre></td></tr></table></figure>
<p>启动</p>
<p>默认 2379 端口处理客户端的请求，2380 端口用于集群各成员间的通信。启动 etcd 显示类似如下的信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_3_centos etcd3.4]# etcd</span><br><span class="line">[WARNING] Deprecated &#39;--logger&#x3D;capnslog&#39; flag is set; use &#39;--logger&#x3D;zap&#39; flag instead</span><br><span class="line">2019-11-05 15:19:01.909992 I | etcdmain: etcd Version: 3.4.0</span><br><span class="line">.......</span><br><span class="line">2019-11-05 15:19:02.634795 I | embed: ready to serve client requests</span><br><span class="line">2019-11-05 15:19:02.635348 N | embed: serving insecure client requests on 127.0.0.1:2379, this is strongly discouraged!</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#使用 etcdctl 命令进行测试，设置和获取键值 testkey: &quot;hello world&quot;，检查 etcd 服务是否启动成功：</span><br><span class="line">[root@VM_0_3_centos ~]# ETCDCTL_API&#x3D;3 etcdctl member list</span><br><span class="line">8e9e05c52164694d, started, default, http:&#x2F;&#x2F;localhost:2380, http:&#x2F;&#x2F;localhost:2379, false</span><br><span class="line">[root@VM_0_3_centos ~]# ETCDCTL_API&#x3D;3 etcdctl put testkey &quot;hello world&quot;</span><br><span class="line">OK</span><br><span class="line">[root@VM_0_3_centos ~]# etcdctl get testkey</span><br><span class="line">testkey</span><br><span class="line">hello world</span><br></pre></td></tr></table></figure>
<p>也可以通过 HTTP 访问本地 2379 或 4001 端口的方式来进行操作，例如查看 testkey 的值：curl -L <a href="http://localhost:4001/v2/keys/testkey" target="_blank" rel="noopener">http://localhost:4001/v2/keys/testkey</a></p>
<h2 id="Docker-镜像方式运行"><a href="#Docker-镜像方式运行" class="headerlink" title="Docker 镜像方式运行"></a>Docker 镜像方式运行</h2><p>镜像名称为 quay.io/coreos/etcd，可以通过下面的命令启动 etcd 服务监听到 2379 和 2380 端口。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ docker run \</span><br><span class="line">-p 2379:2379 \</span><br><span class="line">-p 2380:2380 \</span><br><span class="line">--mount type&#x3D;bind,source&#x3D;&#x2F;tmp&#x2F;etcd-data.tmp,destination&#x3D;&#x2F;etcd-data \</span><br><span class="line">--name etcd-gcr-v3.4.0 \</span><br><span class="line">quay.io&#x2F;coreos&#x2F;etcd:v3.4.0 \</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;bin&#x2F;etcd \</span><br><span class="line">--name s1 \</span><br><span class="line">--data-dir &#x2F;etcd-data \</span><br><span class="line">--listen-client-urls http:&#x2F;&#x2F;0.0.0.0:2379 \</span><br><span class="line">--advertise-client-urls http:&#x2F;&#x2F;0.0.0.0:2379 \</span><br><span class="line">--listen-peer-urls http:&#x2F;&#x2F;0.0.0.0:2380 \</span><br><span class="line">--initial-advertise-peer-urls http:&#x2F;&#x2F;0.0.0.0:2380 \</span><br><span class="line">--initial-cluster s1&#x3D;http:&#x2F;&#x2F;0.0.0.0:2380 \</span><br><span class="line">--initial-cluster-token tkn \</span><br><span class="line">--initial-cluster-state new \</span><br><span class="line">--log-level info \</span><br><span class="line">--logger zap \</span><br><span class="line">--log-outputs stderr</span><br></pre></td></tr></table></figure>
<p>打开新的终端按照上一步的方法测试 etcd 是否成功启动。</p>
<h2 id="macOS-中运行"><a href="#macOS-中运行" class="headerlink" title="macOS 中运行"></a>macOS 中运行</h2><p>$ brew install etcd</p>
<p>$ etcd</p>
<p>$ etcdctl member list</p>
<h1 id="Etcd-集群"><a href="#Etcd-集群" class="headerlink" title="Etcd 集群"></a>Etcd 集群</h1><p>使用 Docker Compose 模拟启动一个 3 节点的 etcd 集群。</p>
<p>docker-compose.yml 文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;3.6&quot;</span><br><span class="line">services:</span><br><span class="line"></span><br><span class="line">  node1:</span><br><span class="line">    image: quay.io&#x2F;coreos&#x2F;etcd:v3.4.0</span><br><span class="line">    volumes:</span><br><span class="line">      - node1-data:&#x2F;etcd-data</span><br><span class="line">    expose:</span><br><span class="line">      - 2379</span><br><span class="line">      - 2380</span><br><span class="line">    networks:</span><br><span class="line">      cluster_net:</span><br><span class="line">        ipv4_address: 172.16.238.100</span><br><span class="line">    environment:</span><br><span class="line">      - ETCDCTL_API&#x3D;3</span><br><span class="line">    command:</span><br><span class="line">      - &#x2F;usr&#x2F;local&#x2F;bin&#x2F;etcd</span><br><span class="line">      - --data-dir&#x3D;&#x2F;etcd-data</span><br><span class="line">      - --name</span><br><span class="line">      - node1</span><br><span class="line">      - --initial-advertise-peer-urls</span><br><span class="line">      - http:&#x2F;&#x2F;172.16.238.100:2380</span><br><span class="line">      - --listen-peer-urls</span><br><span class="line">      - http:&#x2F;&#x2F;0.0.0.0:2380</span><br><span class="line">      - --advertise-client-urls</span><br><span class="line">      - http:&#x2F;&#x2F;172.16.238.100:2379</span><br><span class="line">      - --listen-client-urls</span><br><span class="line">      - http:&#x2F;&#x2F;0.0.0.0:2379</span><br><span class="line">      - --initial-cluster</span><br><span class="line">      - node1&#x3D;http:&#x2F;&#x2F;172.16.238.100:2380,node2&#x3D;http:&#x2F;&#x2F;172.16.238.101:2380,node3&#x3D;http:&#x2F;&#x2F;172.16.238.102:2380</span><br><span class="line">      - --initial-cluster-state</span><br><span class="line">      - new</span><br><span class="line">      - --initial-cluster-token</span><br><span class="line">      - docker-etcd</span><br><span class="line"></span><br><span class="line">  node2:</span><br><span class="line">    image: quay.io&#x2F;coreos&#x2F;etcd:v3.4.0</span><br><span class="line">    volumes:</span><br><span class="line">      - node2-data:&#x2F;etcd-data</span><br><span class="line">    networks:</span><br><span class="line">      cluster_net:</span><br><span class="line">        ipv4_address: 172.16.238.101</span><br><span class="line">    environment:</span><br><span class="line">      - ETCDCTL_API&#x3D;3</span><br><span class="line">    expose:</span><br><span class="line">      - 2379</span><br><span class="line">      - 2380</span><br><span class="line">    command:</span><br><span class="line">      - &#x2F;usr&#x2F;local&#x2F;bin&#x2F;etcd</span><br><span class="line">      - --data-dir&#x3D;&#x2F;etcd-data</span><br><span class="line">      - --name</span><br><span class="line">      - node2</span><br><span class="line">      - --initial-advertise-peer-urls</span><br><span class="line">      - http:&#x2F;&#x2F;172.16.238.101:2380</span><br><span class="line">      - --listen-peer-urls</span><br><span class="line">      - http:&#x2F;&#x2F;0.0.0.0:2380</span><br><span class="line">      - --advertise-client-urls</span><br><span class="line">      - http:&#x2F;&#x2F;172.16.238.101:2379</span><br><span class="line">      - --listen-client-urls</span><br><span class="line">      - http:&#x2F;&#x2F;0.0.0.0:2379</span><br><span class="line">      - --initial-cluster</span><br><span class="line">      - node1&#x3D;http:&#x2F;&#x2F;172.16.238.100:2380,node2&#x3D;http:&#x2F;&#x2F;172.16.238.101:2380,node3&#x3D;http:&#x2F;&#x2F;172.16.238.102:2380</span><br><span class="line">      - --initial-cluster-state</span><br><span class="line">      - new</span><br><span class="line">      - --initial-cluster-token</span><br><span class="line">      - docker-etcd</span><br><span class="line"></span><br><span class="line">  node3:</span><br><span class="line">    image: quay.io&#x2F;coreos&#x2F;etcd:v3.4.0</span><br><span class="line">    volumes:</span><br><span class="line">      - node3-data:&#x2F;etcd-data</span><br><span class="line">    networks:</span><br><span class="line">      cluster_net:</span><br><span class="line">        ipv4_address: 172.16.238.102</span><br><span class="line">    environment:</span><br><span class="line">      - ETCDCTL_API&#x3D;3</span><br><span class="line">    expose:</span><br><span class="line">      - 2379</span><br><span class="line">      - 2380</span><br><span class="line">    command:</span><br><span class="line">      - &#x2F;usr&#x2F;local&#x2F;bin&#x2F;etcd</span><br><span class="line">      - --data-dir&#x3D;&#x2F;etcd-data</span><br><span class="line">      - --name</span><br><span class="line">      - node3</span><br><span class="line">      - --initial-advertise-peer-urls</span><br><span class="line">      - http:&#x2F;&#x2F;172.16.238.102:2380</span><br><span class="line">      - --listen-peer-urls</span><br><span class="line">      - http:&#x2F;&#x2F;0.0.0.0:2380</span><br><span class="line">      - --advertise-client-urls</span><br><span class="line">      - http:&#x2F;&#x2F;172.16.238.102:2379</span><br><span class="line">      - --listen-client-urls</span><br><span class="line">      - http:&#x2F;&#x2F;0.0.0.0:2379</span><br><span class="line">      - --initial-cluster</span><br><span class="line">      - node1&#x3D;http:&#x2F;&#x2F;172.16.238.100:2380,node2&#x3D;http:&#x2F;&#x2F;172.16.238.101:2380,node3&#x3D;http:&#x2F;&#x2F;172.16.238.102:2380</span><br><span class="line">      - --initial-cluster-state</span><br><span class="line">      - new</span><br><span class="line">      - --initial-cluster-token</span><br><span class="line">      - docker-etcd</span><br><span class="line"></span><br><span class="line">volumes:</span><br><span class="line">  node1-data:</span><br><span class="line">  node2-data:</span><br><span class="line">  node3-data:</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  cluster_net:</span><br><span class="line">    driver: bridge</span><br><span class="line">    ipam:</span><br><span class="line">      driver: default</span><br><span class="line">      config:</span><br><span class="line">      -</span><br><span class="line">        subnet: 172.16.238.0&#x2F;24</span><br></pre></td></tr></table></figure>
<p>使用 docker-compose up 启动集群之后使用 docker exec 命令登录到任一节点测试 etcd 集群。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_3_centos tmp]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE                        COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">45c34fa7d4d5        quay.io&#x2F;coreos&#x2F;etcd:v3.4.0   &quot;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;etcd…&quot;   25 minutes ago      Up 20 minutes       2379-2380&#x2F;tcp       etcd_node1_1</span><br><span class="line">b1d9ecc03d64        quay.io&#x2F;coreos&#x2F;etcd:v3.4.0   &quot;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;etcd…&quot;   25 minutes ago      Up 25 minutes       2379-2380&#x2F;tcp       etcd_node3_1</span><br><span class="line">dae9d24f3197        quay.io&#x2F;coreos&#x2F;etcd:v3.4.0   &quot;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;etcd…&quot;   25 minutes ago      Up 25 minutes       2379-2380&#x2F;tcp       etcd_node2_1</span><br><span class="line">[root@VM_0_3_centos tmp]# docker exec -it 45 &#x2F;bin&#x2F;sh</span><br><span class="line"># etcdctl member list</span><br><span class="line">daf3fd52e3583ff, started, node3, http:&#x2F;&#x2F;172.16.238.102:2380, http:&#x2F;&#x2F;172.16.238.102:2379, false</span><br><span class="line">422a74f03b622fef, started, node1, http:&#x2F;&#x2F;172.16.238.100:2380, http:&#x2F;&#x2F;172.16.238.100:2379, false</span><br><span class="line">ed635d2a2dbef43d, started, node2, http:&#x2F;&#x2F;172.16.238.101:2380, http:&#x2F;&#x2F;172.16.238.101:2379, false</span><br></pre></td></tr></table></figure>

<h1 id="使用-etcdctl"><a href="#使用-etcdctl" class="headerlink" title="使用 etcdctl"></a>使用 etcdctl</h1><p>etcdctl 支持如下的命令，大体上分为数据库操作和非数据库操作两类。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">NAME:</span><br><span class="line">    etcdctl - A simple command line client for etcd3.</span><br><span class="line"></span><br><span class="line">USAGE:</span><br><span class="line">    etcdctl</span><br><span class="line"></span><br><span class="line">VERSION:</span><br><span class="line">    3.4.0</span><br><span class="line"></span><br><span class="line">API VERSION:</span><br><span class="line">    3.4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">COMMANDS:</span><br><span class="line">    get            Gets the key or a range of keys</span><br><span class="line">    put            Puts the given key into the store</span><br><span class="line">    del            Removes the specified key or range of keys [key, range_end)</span><br><span class="line">    txn            Txn processes all the requests in one transaction</span><br><span class="line">    compaction        Compacts the event history in etcd</span><br><span class="line">    alarm disarm        Disarms all alarms</span><br><span class="line">    alarm list        Lists all alarms</span><br><span class="line">    defrag            Defragments the storage of the etcd members with given endpoints</span><br><span class="line">    endpoint health        Checks the healthiness of endpoints specified in &#96;--endpoints&#96; flag</span><br><span class="line">    endpoint status        Prints out the status of endpoints specified in &#96;--endpoints&#96; flag</span><br><span class="line">    watch            Watches events stream on keys or prefixes</span><br><span class="line">    version            Prints the version of etcdctl</span><br><span class="line">    lease grant        Creates leases</span><br><span class="line">    lease revoke        Revokes leases</span><br><span class="line">    lease timetolive    Get lease information</span><br><span class="line">    lease keep-alive    Keeps leases alive (renew)</span><br><span class="line">    member add        Adds a member into the cluster</span><br><span class="line">    member remove        Removes a member from the cluster</span><br><span class="line">    member update        Updates a member in the cluster</span><br><span class="line">    member list        Lists all members in the cluster</span><br><span class="line">    snapshot save        Stores an etcd node backend snapshot to a given file</span><br><span class="line">    snapshot restore    Restores an etcd member snapshot to an etcd directory</span><br><span class="line">    snapshot status        Gets backend snapshot status of a given file</span><br><span class="line">    make-mirror        Makes a mirror at the destination etcd cluster</span><br><span class="line">    migrate            Migrates keys in a v2 store to a mvcc store</span><br><span class="line">    lock            Acquires a named lock</span><br><span class="line">    elect            Observes and participates in leader election</span><br><span class="line">    auth enable        Enables authentication</span><br><span class="line">    auth disable        Disables authentication</span><br><span class="line">    user add        Adds a new user</span><br><span class="line">    user delete        Deletes a user</span><br><span class="line">    user get        Gets detailed information of a user</span><br><span class="line">    user list        Lists all users</span><br><span class="line">    user passwd        Changes password of user</span><br><span class="line">    user grant-role        Grants a role to a user</span><br><span class="line">    user revoke-role    Revokes a role from a user</span><br><span class="line">    role add        Adds a new role</span><br><span class="line">    role delete        Deletes a role</span><br><span class="line">    role get        Gets detailed information of a role</span><br><span class="line">    role list        Lists all roles</span><br><span class="line">    role grant-permission    Grants a key to a role</span><br><span class="line">    role revoke-permission    Revokes a key from a role</span><br><span class="line">    check perf        Check the performance of the etcd cluster</span><br><span class="line">    help            Help about any command</span><br><span class="line"></span><br><span class="line">OPTIONS:</span><br><span class="line">      --cacert&#x3D;&quot;&quot;                verify certificates of TLS-enabled secure servers using this CA bundle</span><br><span class="line">      --cert&#x3D;&quot;&quot;                    identify secure client using this TLS certificate file</span><br><span class="line">      --command-timeout&#x3D;5s            timeout for short running command (excluding dial timeout)</span><br><span class="line">      --debug[&#x3D;false]                enable client-side debug logging</span><br><span class="line">      --dial-timeout&#x3D;2s                dial timeout for client connections</span><br><span class="line">      --endpoints&#x3D;[127.0.0.1:2379]        gRPC endpoints</span><br><span class="line">      --hex[&#x3D;false]                print byte strings as hex encoded strings</span><br><span class="line">      --insecure-skip-tls-verify[&#x3D;false]    skip server certificate verification</span><br><span class="line">      --insecure-transport[&#x3D;true]        disable transport security for client connections</span><br><span class="line">      --key&#x3D;&quot;&quot;                    identify secure client using this TLS key file</span><br><span class="line">      --user&#x3D;&quot;&quot;                    username[:password] for authentication (prompt if password is not supplied)</span><br><span class="line">  -w, --write-out&#x3D;&quot;simple&quot;            set the output format (fields, json, protobuf, simple, table)</span><br></pre></td></tr></table></figure>
<h2 id="数据库操作"><a href="#数据库操作" class="headerlink" title="数据库操作"></a>数据库操作</h2><p>数据库操作围绕对键值和目录的 CRUD （符合 REST 风格的一套操作：Create）完整生命周期的管理。</p>
<p>etcd 在键的组织上采用了层次化的空间结构（类似于文件系统中目录的概念），用户指定的键可以为单独的名字，如 testkey，此时实际上放在根目录 / 下面，也可以为指定目录结构，如 cluster1/node2/testkey，则将创建相应的目录结构。</p>
<p>注：CRUD 即 Create, Read, Update, Delete，是符合 REST 风格的一套 API 操作。</p>
<h3 id="put-set"><a href="#put-set" class="headerlink" title="put/set"></a>put/set</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ etcdctl put &#x2F;testdir&#x2F;testkey &quot;Hello world&quot;</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<h3 id="get"><a href="#get" class="headerlink" title="get"></a>get</h3><p>获取指定键的值。例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ etcdctl put testkey hello</span><br><span class="line">OK</span><br><span class="line">$ etcdctl get testkey</span><br><span class="line">testkey</span><br><span class="line">hello</span><br></pre></td></tr></table></figure>
<p>支持的选项为</p>
<p>–sort 对结果进行排序</p>
<p>–consistent 将请求发给主节点，保证获取内容的一致性</p>
<h3 id="del"><a href="#del" class="headerlink" title="del"></a>del</h3><p>删除某个键值。例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ etcdctl del testkey</span><br><span class="line">1</span><br></pre></td></tr></table></figure>
<h3 id="update"><a href="#update" class="headerlink" title="update"></a>update</h3><p>当键存在时，更新值内容。例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ etcdctl set testkey hello</span><br><span class="line">hello</span><br><span class="line">$ etcdctl update testkey world</span><br><span class="line">world</span><br></pre></td></tr></table></figure>
<p>当键不存在时，则会报错。例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ etcdctl update testkey2 world</span><br><span class="line">Error:  100: Key not found (&#x2F;testkey2) [1]</span><br></pre></td></tr></table></figure>
<h2 id="非数据库操作"><a href="#非数据库操作" class="headerlink" title="非数据库操作"></a>非数据库操作</h2><h3 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h3><p>监测一个键值的变化，一旦键值发生更新，就会输出最新的值。</p>
<p>例如，用户更新 testkey 键值为 Hello world。</p>
<p>$ etcdctl watch testkey</p>
<h3 id="PUT"><a href="#PUT" class="headerlink" title="PUT"></a>PUT</h3><p>testkey<br>2</p>
<h3 id="member"><a href="#member" class="headerlink" title="member"></a>member</h3><p>通过 list、add、update、remove 命令列出、添加、更新、删除 etcd 实例到 etcd 集群中。</p>
<p>例如本地启动一个 etcd 服务实例后，可以用如下命令进行查看。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ etcdctl member list</span><br><span class="line">422a74f03b622fef, started, node1, http:&#x2F;&#x2F;172.16.238.100:2380, http:&#x2F;&#x2F;172.16.238.100:23</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/05/19/Docker_Swarm_%E9%A1%B9%E7%9B%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/19/Docker_Swarm_%E9%A1%B9%E7%9B%AE/" itemprop="url">Docker Swarm 项目</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-19T00:00:00+08:00">
                2019-05-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Docker Swarm 是 Docker 官方三剑客项目之一，提供 Docker 容器集群服务，是 Docker 官方对容器云生态进行支持的核心方案。</p>
<p>使用它，用户可以将多个 Docker 主机封装为单个大型的虚拟 Docker 主机，快速打造一套容器云平台。</p>
<p>注意：Docker 1.12.0+ Swarm mode 已经内嵌入 Docker 引擎，成为了 docker 子命令 docker swarm，绝大多数用户已经开始使用 Swarm mode，Docker 引擎 API 已经删除 Docker Swarm。Swarm mode 内置 kv 存储功能，提供了众多的新特性，比如：具有容错能力的去中心化设计、内置服务发现、负载均衡、路由网格、动态伸缩、滚动更新、安全传输等。使得 Docker 原生的 Swarm 集群具备与 Mesos、Kubernetes 竞争的实力。</p>
<h1 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h1><h2 id="节点"><a href="#节点" class="headerlink" title="节点"></a>节点</h2><p>运行 Docker 的主机可以主动初始化一个 Swarm 集群或者加入一个已存在的 Swarm 集群，这样这个运行 Docker 的主机就成为一个 Swarm 集群的节点 (node) 。</p>
<p>节点分为管理 (manager) 节点和工作 (worker) 节点。</p>
<p>管理节点用于 Swarm 集群的管理，docker swarm 命令基本只能在管理节点执行（节点退出集群命令 docker swarm leave 可以在工作节点执行）。一个 Swarm 集群可以有多个管理节点，但只有一个管理节点可以成为 leader，leader 通过 raft 协议实现。</p>
<p>工作节点是任务执行节点，管理节点将服务 (service) 下发至工作节点执行。管理节点默认也作为工作节点。你也可以通过配置让服务只运行在管理节点。</p>
<h2 id="服务和任务"><a href="#服务和任务" class="headerlink" title="服务和任务"></a>服务和任务</h2><p>任务 （Task）是 Swarm 中的最小的调度单位，目前来说就是一个单一的容器。</p>
<p>服务 （Services） 是指一组任务的集合，服务定义了任务的属性。服务有两种模式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">replicated services 按照一定规则在各个工作节点上运行指定个数的任务。</span><br><span class="line">global services 每个工作节点上运行一个任务</span><br><span class="line">两种模式通过 docker service create 的 --mode 参数指定。</span><br></pre></td></tr></table></figure>

<h1 id="创建-Swarm-集群"><a href="#创建-Swarm-集群" class="headerlink" title="创建 Swarm 集群"></a>创建 Swarm 集群</h1><p>创建好docker主机后，在管理主机上初始化集群。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ docker-machine ssh manager #进入该docker主机</span><br><span class="line"></span><br><span class="line">docker@manager:~$ docker swarm init --advertise-addr 192.168.99.100</span><br><span class="line">Swarm initialized: current node (dxn1zf6l61qsb1josjja83ngz) is now a manager.</span><br><span class="line"></span><br><span class="line">To add a worker to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">    docker swarm join \</span><br><span class="line">    --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c \</span><br><span class="line">    192.168.99.100:2377</span><br><span class="line"></span><br><span class="line">To add a manager to this swarm, run &#39;docker swarm join-token manager&#39; and follow the instructions.</span><br></pre></td></tr></table></figure>
<h2 id="增加工作节点"><a href="#增加工作节点" class="headerlink" title="增加工作节点"></a>增加工作节点</h2><p>创建主机</p>
<p>$ docker-machine create -d virtualbox worker1</p>
<p>进入虚拟主机 worker1</p>
<p>$ docker-machine ssh worker1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker-machine ssh worker1</span><br><span class="line"></span><br><span class="line">docker@worker1:~$ docker swarm join \</span><br><span class="line">    --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c \</span><br><span class="line">    192.168.99.100:2377</span><br><span class="line"></span><br><span class="line">This node joined a swarm as a worker.</span><br></pre></td></tr></table></figure>
<h2 id="查看集群"><a href="#查看集群" class="headerlink" title="查看集群"></a>查看集群</h2><p>经过上边的两步，我们已经拥有了一个最小的 Swarm 集群，包含一个管理节点和两个工作节点。</p>
<p>在管理节点使用 docker node ls 查看集群。</p>
<p>$ docker node ls </p>
<p>命令 docker info 可以查看 swarm 集群状态</p>
<h2 id="部署服务"><a href="#部署服务" class="headerlink" title="部署服务"></a>部署服务</h2><h3 id="新建服务"><a href="#新建服务" class="headerlink" title="新建服务"></a>新建服务</h3><p>进入集群管理节点：</p>
<p>docker-machine ssh manager1</p>
<p>使用 docker 中国镜像：docker pull registry.docker-cn.com/….</p>
<p>在Swarm 集群中运行一个名为 nginx 服务。</p>
<p>$ docker service create –replicas 3 -p 80:80 –name nginx nginx:1.13.7-alpine ping baidu.com</p>
<p>现在我们使用浏览器，输入任意节点 IP ，即可看到 nginx 默认页面。</p>
<p>命令解释</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker service create 命令创建一个服务</span><br><span class="line">--name 服务名称命名为 nginx</span><br><span class="line">--replicas 设置启动的示例数</span><br><span class="line">alpine指的是使用的镜像名称，ping  指的是容器运行的bash</span><br></pre></td></tr></table></figure>

<h3 id="查看服务"><a href="#查看服务" class="headerlink" title="查看服务"></a>查看服务</h3><p>使用 docker service ls 来查看当前 Swarm 集群运行的服务。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker service ls</span><br><span class="line">ID                  NAME                MODE                REPLICAS            IMAGE                 PORTS</span><br><span class="line">kc57xffvhul5        nginx               replicated          3&#x2F;3                 nginx:1.13.7-alpine   *:80-&gt;80&#x2F;tcp</span><br></pre></td></tr></table></figure>
<p>使用 docker service ps 来查看某个服务的详情。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker service ps nginx</span><br><span class="line">ID                  NAME                IMAGE                 NODE                DESIRED STATE       CURRENT STATE                ERROR               PORTS</span><br><span class="line">pjfzd39buzlt        nginx.1             nginx:1.13.7-alpine   swarm2              Running             Running about a minute ago</span><br><span class="line">hy9eeivdxlaa        nginx.2             nginx:1.13.7-alpine   swarm1              Running             Running about a minute ago</span><br><span class="line">36wmpiv7gmfo        nginx.3             nginx:1.13.7-alpine   swarm3              Running             Running about a minute ago</span><br></pre></td></tr></table></figure>
<p>使用 docker service logs 来查看某个服务的日志。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker service logs nginx</span><br><span class="line">nginx.3.36wmpiv7gmfo@swarm3    | 10.255.0.4 - - [25&#x2F;Nov&#x2F;2017:02:10:30 +0000] &quot;GET &#x2F; HTTP&#x2F;1.1&quot; 200 612 &quot;-&quot; &quot;Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko&#x2F;20100101 Firefox&#x2F;58.0&quot; &quot;-&quot;</span><br><span class="line">nginx.3.36wmpiv7gmfo@swarm3    | 10.255.0.4 - - [25&#x2F;Nov&#x2F;2017:02:10:30 +0000] &quot;GET &#x2F;favicon.ico HTTP&#x2F;1.1&quot; 404 169 &quot;-&quot; &quot;Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko&#x2F;20100101 Firefox&#x2F;58.0&quot; &quot;-&quot;</span><br><span class="line">nginx.3.36wmpiv7gmfo@swarm3    | 2017&#x2F;11&#x2F;25 02:10:30 [error] 5#5: *1 open() &quot;&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;favicon.ico&quot; failed (2: No such file or directory), client: 10.255.0.4, server: localhost, request: &quot;GET &#x2F;favicon.ico HTTP&#x2F;1.1&quot;, host: &quot;192.168.99.102&quot;</span><br><span class="line">nginx.1.pjfzd39buzlt@swarm2    | 10.255.0.2 - - [25&#x2F;Nov&#x2F;2017:02:10:26 +0000] &quot;GET &#x2F; HTTP&#x2F;1.1&quot; 200 612 &quot;-&quot; &quot;Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko&#x2F;20100101 Firefox&#x2F;58.0&quot; &quot;-&quot;</span><br><span class="line">nginx.1.pjfzd39buzlt@swarm2    | 10.255.0.2 - - [25&#x2F;Nov&#x2F;2017:02:10:27 +0000] &quot;GET &#x2F;favicon.ico HTTP&#x2F;1.1&quot; 404 169 &quot;-&quot; &quot;Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.13; rv:58.0) Gecko&#x2F;20100101 Firefox&#x2F;58.0&quot; &quot;-&quot;</span><br><span class="line">nginx.1.pjfzd39buzlt@swarm2    | 2017&#x2F;11&#x2F;25 02:10:27 [error] 5#5: *1 open() &quot;&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;favicon.ico&quot; failed (2: No such file or directory), client: 10.255.0.2, server: localhost, request: &quot;GET &#x2F;favicon.ico HTTP&#x2F;1.1&quot;, host: &quot;192.168.99.101&quot;</span><br></pre></td></tr></table></figure>

<h3 id="删除服务"><a href="#删除服务" class="headerlink" title="删除服务"></a>删除服务</h3><p>使用 docker service rm 来从 Swarm 集群移除某个服务。</p>
<p>$ docker service rm nginx</p>
<h3 id="查看加入集群manager管理节点的命令"><a href="#查看加入集群manager管理节点的命令" class="headerlink" title="查看加入集群manager管理节点的命令"></a>查看加入集群manager管理节点的命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#docker swarm join-token manager</span><br><span class="line">To add a manager to this swarm, run the following command:</span><br><span class="line">    docker swarm join --token SWMTKN-1-3sp9uxzokgr252u1jauoowv74930s7f8f5tsmm5mlk5oim359e-7tdlpdnkyfl1bnq34ftik9wxw 192.168.139.175:2377</span><br><span class="line">	</span><br><span class="line">	查看加入集群worker节点的命令</span><br><span class="line">	</span><br><span class="line">	# docker swarm join-token worker</span><br><span class="line">To add a worker to this swarm, run the following command:</span><br><span class="line">    docker swarm join --token SWMTKN-1-3sp9uxzokgr252u1jauoowv74930s7f8f5tsmm5mlk5oim359e-dk52k5uul50w49gbq4j1y7zzb 192.168.139.175:2377</span><br><span class="line">&#96;&#96;&#96;	</span><br><span class="line">### 查docker swarm的管理网络</span><br></pre></td></tr></table></figure>
<p>#docker network ls<br>NETWORK ID          NAME                DRIVER              SCOPE<br>05efca714d2f        bridge              bridge              local<br>c9cd9c37edd7        docker_gwbridge     bridge              local<br>10ac9e48d81b        host                host                local<br>n60tdenc5jy7        ingress             overlay             swarm<br>a9284277dc18        none                null                local</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">## 服务伸缩</span><br><span class="line">我们可以使用 docker service scale 对一个服务运行的容器数量进行伸缩。当业务处于高峰期时，我们需要扩展服务运行的容器数量。</span><br><span class="line"></span><br><span class="line">$ docker service scale nginx&#x3D;5</span><br><span class="line"></span><br><span class="line">当业务平稳时，我们需要减少服务运行的容器数量。</span><br><span class="line"></span><br><span class="line">$ docker service scale nginx&#x3D;2</span><br><span class="line"></span><br><span class="line">调整实例个数  调整 nginx 的服务实例数为2个</span><br><span class="line"></span><br><span class="line">docker service update --replicas 2 nginx</span><br><span class="line"></span><br><span class="line">## 监控集群状态</span><br><span class="line"></span><br><span class="line">登录管理节点 manager1：docker-machine ssh manager1</span><br><span class="line"></span><br><span class="line">运行 docker service inspect --pretty &lt;SERVICE-ID&gt; 查询服务概要状态，以 nginx 服务为例：</span><br></pre></td></tr></table></figure>
<p>docker@manager1:~$  docker service inspect –pretty nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">### 查询服务详细信息</span><br><span class="line">docker service inspect nginx </span><br><span class="line">### 查看那个节点正在运行服务</span><br><span class="line">运行docker service ps &lt;SERVICE-ID&gt;</span><br></pre></td></tr></table></figure>
<p>docker@manager1:~$  docker service ps helloworld</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">### 在工作节点查看任务的执行情况</span><br><span class="line">首先进入docker-machine ssh  worker1</span><br><span class="line"></span><br><span class="line">再在节点执行docker ps 查看容器的运行状态。</span><br><span class="line"></span><br><span class="line">### 查看容器的运行状态</span><br><span class="line">docker@worker1:~$   docker ps</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">这样的话，我们在 Swarm 集群中成功的运行了一个 helloworld 服务，根据命令可以看出在 worker1 节点上运行。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 退出 Swarm 集群</span><br><span class="line"></span><br><span class="line">如果 Manager 想要退出 Swarm 集群， 在 Manager Node 上执行如下命令：</span><br><span class="line"></span><br><span class="line">docker swarm leave  </span><br><span class="line"></span><br><span class="line">就可以退出集群，如果集群中还存在其它的 Worker Node，还希望 Manager 退出集群，则加上一个强制选项，命令行如下所示：</span><br><span class="line"></span><br><span class="line">docker swarm leave --force</span><br><span class="line"></span><br><span class="line">在 Worker2 上进行退出测试，登录 worker2 节点</span><br><span class="line"></span><br><span class="line">docker-machine ssh  worker2</span><br><span class="line"></span><br><span class="line">执行退出命令</span><br><span class="line"></span><br><span class="line">docker swarm leave </span><br><span class="line"></span><br><span class="line">重新搭建命令，使用 VirtualBox 做测试的时候，如果想重复实验可以将实验节点删掉再重来。</span><br></pre></td></tr></table></figure>
<p>#停止虚拟机<br>docker-machine stop [arg…]  #一个或多个虚拟机名称</p>
<p>docker-machine stop   manager1 worker1 worker2<br>#移除虚拟机<br>docker-machine rm [OPTIONS] [arg…]</p>
<p>docker-machine rm manager1 worker1 worker2<br>停止、删除虚拟主机后，再重新创建即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">排空节点上的集群容器 。</span><br><span class="line">docker node update --availability drain g36lvv23ypjd8v7ovlst2n3yt</span><br><span class="line"></span><br><span class="line">主动离开集群，让节点处于down状态，才能删除</span><br><span class="line">docker swarm leave</span><br><span class="line"></span><br><span class="line">删除指定节点 （管理节点上操作）</span><br><span class="line">docker node rm g36lvv23ypjd8v7ovlst2n3yt</span><br><span class="line"></span><br><span class="line">管理节点，解散集群</span><br><span class="line">docker swarm leave --force</span><br><span class="line"></span><br><span class="line">解散集群步骤：</span><br></pre></td></tr></table></figure>
<p>[root@server2 ~]# docker swarm leave   #server2对应的node节点离开集群<br>[root@server3 ~]# docker swarm leave   #server3对应的node节点离开集群<br>[root@server1 ~]# docker swarm leave –force   #必须使用参数–force,强制离开集群,否则会报错<br>[root@server1 ~]# docker node ls   #此时再次查看集群的节点,会报错。这是因为i集群已经散了,该节点不再是manager节点,而只有manager节点才能查看集群的节点。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># Portainer</span><br><span class="line">使用Portainer管理集群</span><br></pre></td></tr></table></figure>
<p>#docker service create <br>–name portainer <br>–publish 9000:9000 <br>–constraint ‘node.role == manager’ <br>–mount type=bind,src=//var/run/docker.sock,dst=/var/run/docker.sock <br>portainer/portainer <br>-H unix:///var/run/docker.sock<br>#docker images |grep portainer<br>portainer/portainer  latest  07cde96d4789   2 weeks ago  10.4MB</p>
<p>#docker service ls                    ###查看集群列表<br>ID              NAME        MODE     REPLICAS      IMAGE             PORTS<br>p5bo3n0fmqgz  portainer  replicated    1/1   portainer/portainer:latest   *:9000-&gt;9000/tcp</p>
<pre><code>这就部署好了  浏览器输入http://localhost:9000</code></pre>
          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/05/19/Docker%E5%AE%B9%E5%99%A8%E9%87%8C%E7%9A%84centos%E3%80%81unbuntu%E6%97%A0%E6%B3%95%E4%BD%BF%E7%94%A8_systemctl_%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/19/Docker%E5%AE%B9%E5%99%A8%E9%87%8C%E7%9A%84centos%E3%80%81unbuntu%E6%97%A0%E6%B3%95%E4%BD%BF%E7%94%A8_systemctl_%E5%91%BD%E4%BB%A4/" itemprop="url">Docker容器里的centos、unbuntu无法使用 systemctl 命令</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-19T00:00:00+08:00">
                2019-05-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>据说在 Linux Docker中无法使用 systemd(systemctl) 相关命令的原因是 1号进程不是 init ，而是其他例如 /bin/bash ，所以导致缺少相关文件无法运行。（System has not been booted with systemd as init system (PID 1). Can’t operat）</p>
<p>解决方案：/sbin/init</p>
<p>docker run -dit –privileged 07d413ca6e34 /usr/sbin/init</p>
<p>docker exec -it test /bin/bash</p>
<p>–privilaged=true一定要加上的。</p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/">上一页</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><a class="extend next" rel="next" href="/page/3/">下一页</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://img.huyunshun.com/img/20200522182348.png"
                alt="初晨" />
            
              <p class="site-author-name" itemprop="name">初晨</p>
              <p class="site-description motion-element" itemprop="description">永远不要说你知道本质，更别说真相了。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">249</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">46</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">109</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          
<!--近期文章版块-->
            
                <div class="links-of-blogroll motion-element links-of-blogroll-block">
                  <div class="links-of-blogroll-title">
                    <!-- modify icon to fire by szw -->
                    <i class="fa fa-history fa-" aria-hidden="true"></i>
                    近期文章
                  </div>
                  <ul class="links-of-blogroll-list">
                    
                    
                      <li>
                        <a href="/2020/05/22/WebSocket%E3%80%81Socket%E3%80%81TCP%E3%80%81HTTP%E5%8C%BA%E5%88%AB/" title="WebSocket、Socket、TCP、HTTP区别" target="_blank">WebSocket、Socket、TCP、HTTP区别</a>
                      </li>
                    
                      <li>
                        <a href="/2020/05/19/Springboot%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%8E%A5%E5%8F%A3%E9%98%B2%E5%88%B7/" title="Springboot项目的接口防刷" target="_blank">Springboot项目的接口防刷</a>
                      </li>
                    
                      <li>
                        <a href="/2020/05/03/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Volatile%E5%85%B3%E9%94%AE%E5%AD%97%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" title="深入理解Volatile关键字及其实现原理" target="_blank">深入理解Volatile关键字及其实现原理</a>
                      </li>
                    
                      <li>
                        <a href="/2020/04/20/%E4%BD%BF%E7%94%A8vscode%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0%E7%8E%AF%E5%A2%83/" title="使用vscode搭建个人笔记环境" target="_blank">使用vscode搭建个人笔记环境</a>
                      </li>
                    
                      <li>
                        <a href="/2020/01/20/HBase%E4%BB%8B%E7%BB%8D%E5%AE%89%E8%A3%85%E4%B8%8E%E6%93%8D%E4%BD%9C/" title="HBase介绍安装与操作" target="_blank">HBase介绍安装与操作</a>
                      </li>
                    
                  </ul>
                </div>
            
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Copyright</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  


</body>
</html>
