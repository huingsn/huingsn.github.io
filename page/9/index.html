<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="永远不要说你知道本质，更别说真相了。">
<meta property="og:type" content="website">
<meta property="og:title" content="简">
<meta property="og:url" content="https://huyunshun.com/page/9/index.html">
<meta property="og:site_name" content="简">
<meta property="og:description" content="永远不要说你知道本质，更别说真相了。">
<meta property="article:author" content="初晨">
<meta property="article:tag" content="编程">
<meta property="article:tag" content="开发">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://huyunshun.com/page/9/"/>





  <title>简</title>
  








  <script type="text/javascript" src="/js/src/love.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">

  <!-- 看板娘 -->
    
        <script async src="/live2d-widget/autoload.js"></script>
    
 <!-- 飘动的彩带） -->
  <script src="/js/src/piao.js" type="text/javascript"></script>
<meta name="generator" content="Hexo 4.2.1"></head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">简</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">人生短暂，学海无边，而大道至简。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/03/14/Elasticsearch%E6%90%9C%E7%B4%A2%EF%BC%88API%E5%92%8CDSL%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/14/Elasticsearch%E6%90%9C%E7%B4%A2%EF%BC%88API%E5%92%8CDSL%EF%BC%89/" itemprop="url">Elasticsearch搜索（API和DSL）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-14T00:00:00+08:00">
                2019-03-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="搜索API"><a href="#搜索API" class="headerlink" title="搜索API"></a>搜索API</h1><h2 id="搜索API-端点地址"><a href="#搜索API-端点地址" class="headerlink" title="搜索API 端点地址"></a>搜索API 端点地址</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;bank&#x2F;accounts&#x2F;_search?q&#x3D;account_number:222</span><br><span class="line"></span><br><span class="line">#从索引bank里面搜索字段firstname为Rachelle的记录</span><br><span class="line"></span><br><span class="line">GET &#x2F;bank&#x2F;_search?q&#x3D;firstname:Rachelle</span><br><span class="line"></span><br><span class="line">#从索引bank、user里面搜索字段firstname为Rachelle的记录</span><br><span class="line"></span><br><span class="line">GET &#x2F;bank,user&#x2F;_search?q&#x3D;firstname:Rachelle</span><br><span class="line"></span><br><span class="line">#从所有索引里面搜索字段firstname为Rachelle的记录</span><br><span class="line">GET &#x2F;_all&#x2F;_search?q&#x3D;firstname:Rachelle</span><br><span class="line">GET &#x2F;_search?q&#x3D;firstname:Rachelle</span><br><span class="line"></span><br><span class="line">#说明：搜索的端点地址可以是多索引多mapping type的。</span><br><span class="line">#搜索的参数可作为URI请求参数给出，也可用 request body 给出</span><br></pre></td></tr></table></figure>

<h2 id="URI-Search"><a href="#URI-Search" class="headerlink" title="URI Search"></a>URI Search</h2><p>URI 搜索方式通过URI参数来指定查询相关参数。</p>
<p>GET /bank/_search?q=account_number:222</p>
<p>可用的参数请参考： <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-uri-request.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/search-uri-request.html</a></p>
<p>查询结果说明</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 3,#耗时（ms）</span><br><span class="line">  &quot;timed_out&quot;: false,#是否超时</span><br><span class="line">  &quot;_shards&quot;: &#123;#查询了多少分片</span><br><span class="line">    &quot;total&quot;: 5,</span><br><span class="line">    &quot;successful&quot;: 5,</span><br><span class="line">    &quot;skipped&quot;: 0,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot;: &#123;#命中结果</span><br><span class="line">    &quot;total&quot;: 1, #命中总数</span><br><span class="line">    &quot;max_score&quot;: 1,#最高得分</span><br><span class="line">    &quot;hits&quot;: [#本页结果文档数组</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;bank&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;accounts&quot;, </span><br><span class="line">        &quot;_id&quot;: &quot;222&quot;,</span><br><span class="line">        &quot;_score&quot;: 1,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;account_number&quot;: 222,</span><br><span class="line">          &quot;balance&quot;: 14764,</span><br><span class="line">          &quot;firstname&quot;: &quot;Rachelle&quot;,</span><br><span class="line">          &quot;lastname&quot;: &quot;Rice&quot;,</span><br><span class="line">          &quot;age&quot;: 36,</span><br><span class="line">          &quot;gender&quot;: &quot;M&quot;,</span><br><span class="line">          &quot;address&quot;: &quot;333 Narrows Avenue&quot;,</span><br><span class="line">          &quot;employer&quot;: &quot;Enaut&quot;,</span><br><span class="line">          &quot;email&quot;: &quot;rachellerice@enaut.com&quot;,</span><br><span class="line">          &quot;city&quot;: &quot;Wright&quot;,</span><br><span class="line">          &quot;state&quot;: &quot;AZ&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="特殊的查询参数用法"><a href="#特殊的查询参数用法" class="headerlink" title="特殊的查询参数用法"></a>特殊的查询参数用法</h3><p>有多少文档匹配某个查询：GET /bank/_search?q=city:b*&amp;size=0</p>
<p>有没有文档匹配某个查询：GET /bank/_search?q=city:b*&amp;size=0&amp;terminate_after=1 #”terminated_early”: true,</p>
<h2 id="Request-body-Search"><a href="#Request-body-Search" class="headerlink" title="Request body Search"></a>Request body Search</h2><p>Request body 搜索方式以JSON格式在请求体中定义查询 query。请求方式可以是 GET 、POST 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;term&quot;:&#123;&quot;firstname&quot;:&quot;Effie&quot;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可用的参数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">timeout：请求超时时长，限定在指定时长内响应（即使没查完）；</span><br><span class="line">from： 分页的起始行，默认0；</span><br><span class="line">size：分页大小；</span><br><span class="line">request_cache：是否缓存请求结果，默认true。</span><br><span class="line">terminate_after：限定每个分片取几个文档。如果设置，则响应将有一个布尔型字段terminated_early来指示查询执行是否实际已经terminate_early。缺省为no terminate_after；</span><br><span class="line">search_type：查询的执行方式，可选值dfs_query_then_fetch or query_then_fetch ，默认： query_then_fetch ；</span><br><span class="line">batched_reduce_size：一次在协调节点上应该减少的分片结果的数量。如果请求中的潜在分片数量可能很大，则应将此值用作保护机制以减少每个搜索请求的内存开销。</span><br></pre></td></tr></table></figure>
<h3 id="query-元素定义查询"><a href="#query-元素定义查询" class="headerlink" title="query 元素定义查询"></a>query 元素定义查询</h3><p>query 元素用Query DSL 来定义查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123;&quot;firstname&quot;:&quot;Effie&quot;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="指定返回哪些内容"><a href="#指定返回哪些内容" class="headerlink" title="指定返回哪些内容"></a>指定返回哪些内容</h3><h4 id="source-filter-对-source字段进行选择"><a href="#source-filter-对-source字段进行选择" class="headerlink" title="source filter  对_source字段进行选择"></a>source filter  对_source字段进行选择</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;_source&quot;: false,</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123;&quot;firstname&quot;:&quot;Virginia&quot;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#通配符查询</span><br><span class="line"></span><br><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;_source&quot;: [ &quot;obj1.*&quot;, &quot;obj2.*&quot; ],</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123;&quot;firstname&quot;:&quot;Virginia&quot;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;_source&quot;: &quot;obj.*&quot;,</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123;&quot;firstname&quot;:&quot;Virginia&quot;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#包含什么不包含什么</span><br><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;_source&quot;: &#123;</span><br><span class="line">        &quot;includes&quot;: [ &quot;obj1.*&quot;, &quot;obj2.*&quot; ],</span><br><span class="line">        &quot;excludes&quot;: [ &quot;*.description&quot; ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123;&quot;firstname&quot;:&quot;Virginia&quot;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="stored-fields-来指定返回哪些stored字段"><a href="#stored-fields-来指定返回哪些stored字段" class="headerlink" title="stored_fields 来指定返回哪些stored字段"></a>stored_fields 来指定返回哪些stored字段</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;stored_fields&quot; : [&quot;account_number&quot;, &quot;age&quot;],</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123;&quot;firstname&quot;:&quot;Virginia&quot;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>说明：* 可用来指定返回所有存储字段</p>
<h4 id="docValue-Field-返回存储了docValue的字段值"><a href="#docValue-Field-返回存储了docValue的字段值" class="headerlink" title="docValue Field 返回存储了docValue的字段值"></a>docValue Field 返回存储了docValue的字段值</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;docvalue_fields&quot; : [&quot;account_number&quot;, &quot;age&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="version-来指定返回文档的版本字段"><a href="#version-来指定返回文档的版本字段" class="headerlink" title="version 来指定返回文档的版本字段"></a>version 来指定返回文档的版本字段</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;version&quot;: true,</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123;&quot;firstname&quot;:&quot;Virginia&quot;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="explain-返回文档的评分解释"><a href="#explain-返回文档的评分解释" class="headerlink" title="explain 返回文档的评分解释"></a>explain 返回文档的评分解释</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;explain&quot;: true,</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123;&quot;firstname&quot;:&quot;Virginia&quot;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Script-Field-用脚本来对命中的每个文档的字段进行运算后返回"><a href="#Script-Field-用脚本来对命中的每个文档的字段进行运算后返回" class="headerlink" title="Script Field 用脚本来对命中的每个文档的字段进行运算后返回"></a>Script Field 用脚本来对命中的每个文档的字段进行运算后返回</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;script_fields&quot;: &#123;</span><br><span class="line">    &quot;test1&quot;: &#123;</span><br><span class="line">      &quot;script&quot;: &#123;</span><br><span class="line">        &quot;lang&quot;: &quot;painless&quot;,</span><br><span class="line">        &quot;source&quot;: &quot;doc[&#39;balance&#39;].value * 2&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;test2&quot;: &#123;</span><br><span class="line">      &quot;script&quot;: &#123;</span><br><span class="line">        &quot;lang&quot;: &quot;painless&quot;,</span><br><span class="line">        &quot;source&quot;: &quot;doc[&#39;age&#39;].value * params.factor&quot;,</span><br><span class="line">        &quot;params&quot;: &#123;</span><br><span class="line">          &quot;factor&quot;: 2</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>说明：params  _source 取 _source字段值，官方推荐使用doc，理由是用doc效率比取_source 高</p>
<h4 id="min-score-限制最低评分得分"><a href="#min-score-限制最低评分得分" class="headerlink" title="min_score  限制最低评分得分"></a>min_score  限制最低评分得分</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;min_score&quot;: 0.5,</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123;&quot;firstname&quot;: &quot;Virginia&quot;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="post-filter-后置过滤：在查询命中文档、完成聚合后，再对命中的文档进行过滤。"><a href="#post-filter-后置过滤：在查询命中文档、完成聚合后，再对命中的文档进行过滤。" class="headerlink" title="post_filter  后置过滤：在查询命中文档、完成聚合后，再对命中的文档进行过滤。"></a>post_filter  后置过滤：在查询命中文档、完成聚合后，再对命中的文档进行过滤。</h4><p>如：要在一次查询中查询品牌为gucci且颜色为红色的shirts，同时还要得到gucci品牌各颜色的shirts的分面统计。</p>
<p>创建索引并指定mappping：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;shirts</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">        &quot;_doc&quot;: &#123;</span><br><span class="line">            &quot;properties&quot;: &#123;</span><br><span class="line">                &quot;brand&quot;: &#123; &quot;type&quot;: &quot;keyword&quot;&#125;,</span><br><span class="line">                &quot;color&quot;: &#123; &quot;type&quot;: &quot;keyword&quot;&#125;,</span><br><span class="line">                &quot;model&quot;: &#123; &quot;type&quot;: &quot;keyword&quot;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>往索引里面放入文档即类似数据库里面的向表插入一行数据，并立即刷新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;shirts&#x2F;_doc&#x2F;1?refresh</span><br><span class="line">&#123;</span><br><span class="line">    &quot;brand&quot;: &quot;gucci&quot;,</span><br><span class="line">    &quot;color&quot;: &quot;red&quot;,</span><br><span class="line">    &quot;model&quot;: &quot;slim&quot;</span><br><span class="line">&#125;</span><br><span class="line">PUT &#x2F;shirts&#x2F;_doc&#x2F;2?refresh</span><br><span class="line">&#123;</span><br><span class="line">    &quot;brand&quot;: &quot;gucci&quot;,</span><br><span class="line">    &quot;color&quot;: &quot;green&quot;,</span><br><span class="line">    &quot;model&quot;: &quot;seec&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行查询：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;shirts&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;term&quot;: &#123; &quot;brand&quot;: &quot;gucci&quot; &#125; </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;colors&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123; &quot;field&quot;: &quot;color&quot; &#125; </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;post_filter&quot;: &#123; </span><br><span class="line">    &quot;term&quot;: &#123; &quot;color&quot;: &quot;red&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="sort-排序"><a href="#sort-排序" class="headerlink" title="sort  排序"></a>sort  排序</h4><p>可以指定按一个或多个字段排序。也可通过_score指定按评分值排序，_doc按索引顺序排序。默认是按相关性评分从高到低排序。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [&#123;</span><br><span class="line">      &quot;age&quot;: &#123; &quot;order&quot;: &quot;desc&quot; &#125;    </span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;balance&quot;: &#123; &quot;order&quot;: &quot;asc&quot; &#125;  </span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;_score&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>说明：order 值：asc、desc。如果不给定，默认是asc，_score默认是desc</p>
<p>结果中每个文档会有排序字段值给出</p>
<p>** 多值字段排序 **</p>
<p>对于值是数组或多值的字段，也可进行排序，通过mode参数指定按多值的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;my_index&#x2F;_doc&#x2F;1?refresh</span><br><span class="line">&#123;</span><br><span class="line">   &quot;product&quot;: &quot;chocolate&quot;,</span><br><span class="line">   &quot;price&quot;: [20, 4]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">   &quot;query&quot; : &#123;</span><br><span class="line">      &quot;term&quot; : &#123; &quot;product&quot; : &quot;chocolate&quot; &#125;</span><br><span class="line">   &#125;,</span><br><span class="line">   &quot;sort&quot; : [</span><br><span class="line">      &#123;&quot;price&quot; : &#123;&quot;order&quot; : &quot;asc&quot;, &quot;mode&quot; : &quot;avg&quot;&#125;&#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>** Missing values  缺失该字段的文档 **</p>
<p>missing 的值可以是 _last, _first</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;sort&quot; : [</span><br><span class="line">        &#123; &quot;price&quot; : &#123;&quot;missing&quot; : &quot;_last&quot;&#125; &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;product&quot; : &quot;chocolate&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>** 地理空间距离排序 **</p>
<p>官方文档：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-sort.html#geo-sorting" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-sort.html#geo-sorting</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;sort&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_geo_distance&quot; : &#123;</span><br><span class="line">                &quot;pin.location&quot; : [-70, 40],</span><br><span class="line">                &quot;order&quot; : &quot;asc&quot;,</span><br><span class="line">                &quot;unit&quot; : &quot;km&quot;,</span><br><span class="line">                &quot;mode&quot; : &quot;min&quot;,</span><br><span class="line">                &quot;distance_type&quot; : &quot;arc&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_geo_distance 距离排序关键字</span><br><span class="line">pin.location是 geo_point 类型的字段</span><br><span class="line">distance_type：距离计算方式 arc球面 、plane 平面。</span><br><span class="line">unit: 距离单位 km 、m 默认m</span><br></pre></td></tr></table></figure>
<p>** Script Based Sorting 基于脚本计算的排序 **</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;sort&quot; : &#123;</span><br><span class="line">        &quot;_script&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;number&quot;,</span><br><span class="line">            &quot;script&quot; : &#123;</span><br><span class="line">                &quot;lang&quot;: &quot;painless&quot;,</span><br><span class="line">                &quot;source&quot;: &quot;doc[&#39;field_name&#39;].value * params.factor&quot;,</span><br><span class="line">                &quot;params&quot; : &#123;</span><br><span class="line">                    &quot;factor&quot; : 1.1</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;order&quot; : &quot;asc&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="折叠"><a href="#折叠" class="headerlink" title="折叠"></a>折叠</h4><p>用 collapse指定根据某个字段对命中结果进行折叠</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;collapse&quot; : &#123;</span><br><span class="line">        &quot;field&quot; : &quot;age&quot; </span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;sort&quot;: [&quot;balance&quot;] </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>** 高级折叠 **</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># 指定inner_hits来解释折叠 </span><br><span class="line"># 自命名&quot;name&quot;: &quot;details&quot;,  </span><br><span class="line"># 指定每组取几个文档 &quot;size&quot;: 5, </span><br><span class="line"># 组内排序 &quot;sort&quot;: [&#123; &quot;balance&quot;: &quot;asc&quot; &#125;]  </span><br><span class="line"># 指定组查询的并发数  &quot;max_concurrent_group_searches&quot;: 4 </span><br><span class="line"></span><br><span class="line">GET &#x2F;bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;collapse&quot; : &#123;</span><br><span class="line">        &quot;field&quot; : &quot;age&quot; ,</span><br><span class="line">        </span><br><span class="line">        &quot;inner_hits&quot;: &#123;</span><br><span class="line">            &quot;name&quot;: &quot;details&quot;, </span><br><span class="line">            &quot;size&quot;: 5,   </span><br><span class="line">            &quot;sort&quot;: [&#123; &quot;balance&quot;: &quot;asc&quot; &#125;] </span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;max_concurrent_group_searches&quot;: 4  </span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;sort&quot;: [&quot;balance&quot;] </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h4><p>** from and size **</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;from&quot; : 0, &quot;size&quot; : 10,</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;firstname&quot; : &quot;Virginia&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注：搜索请求耗用的堆内存和时间与 from + size 大小成正比。分页越深耗用越大，为了不因分页导致OOM或严重影响性能，ES中规定from + size 不能大于索引setting参数 index.max_result_window 的值，默认值为 10,000。</p>
<p>** Search after  在指定文档后取文档， 可用于深度分页 **<br>首次查询第一页</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot;: 10,</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match&quot; : &#123;</span><br><span class="line">            &quot;age&quot; : &quot;37&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;sort&quot;: [</span><br><span class="line">        &#123;&quot;account_number&quot;: &quot;asc&quot;&#125;,</span><br><span class="line">        &#123;&quot;balance&quot;: &quot;desc&quot;&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后续页的查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot;: 10,</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match&quot; : &#123;</span><br><span class="line">            &quot;age&quot; : &quot;37&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;search_after&quot;: [44, 34487],</span><br><span class="line">    &quot;sort&quot;: [</span><br><span class="line">        &#123;&quot;account_number&quot;: &quot;asc&quot;&#125;,</span><br><span class="line">        &#123;&quot;balance&quot;: &quot;desc&quot;&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用search_after，要求查询必须指定排序，并且这个排序组合值每个文档唯一（最好排序中包含_id字段）。 search_after的值用的就是这个排序值。 用search_after时 from 只能为0、-1。</p>
<h4 id="高亮"><a href="#高亮" class="headerlink" title="高亮"></a>高亮</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;lastname&quot;: &quot;Justice&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;highlight&quot;: &#123;</span><br><span class="line">    &quot;fields&quot;: &#123;</span><br><span class="line">      &quot;firstname&quot;: &#123;&#125;,</span><br><span class="line">      &quot;lastname&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 0,</span><br><span class="line">  &quot;timed_out&quot;: false,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 5,</span><br><span class="line">    &quot;successful&quot;: 5,</span><br><span class="line">    &quot;skipped&quot;: 0,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 1,</span><br><span class="line">    &quot;max_score&quot;: 4.8520303,</span><br><span class="line">    &quot;hits&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;bank&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;accounts&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;59&quot;,</span><br><span class="line">        &quot;_score&quot;: 4.8520303,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;account_number&quot;: 59,</span><br><span class="line">          &quot;balance&quot;: 37728,</span><br><span class="line">          &quot;firstname&quot;: &quot;Malone&quot;,</span><br><span class="line">          &quot;lastname&quot;: &quot;Justice&quot;,</span><br><span class="line">          &quot;age&quot;: 37,</span><br><span class="line">          &quot;gender&quot;: &quot;F&quot;,</span><br><span class="line">          &quot;address&quot;: &quot;721 Russell Street&quot;,</span><br><span class="line">          &quot;employer&quot;: &quot;Emoltra&quot;,</span><br><span class="line">          &quot;email&quot;: &quot;malonejustice@emoltra.com&quot;,</span><br><span class="line">          &quot;city&quot;: &quot;Trucksville&quot;,</span><br><span class="line">          &quot;state&quot;: &quot;HI&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;highlight&quot;: &#123;</span><br><span class="line">          &quot;lastname&quot;: [</span><br><span class="line">            &quot;&lt;em&gt;Justice&lt;&#x2F;em&gt;&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>多字段高亮，在highlight中加入：”require_field_match”: false,即可。</p>
<p>指定高亮标签</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  &quot;highlight&quot;: &#123;</span><br><span class="line">    &quot;require_field_match&quot;: false,</span><br><span class="line">    &quot;fields&quot;: &#123;</span><br><span class="line">      &quot;firstname&quot;: &#123;</span><br><span class="line">        &quot;pre_tags&quot;:[&quot;&lt;strong&gt;&quot;],</span><br><span class="line">        &quot;post_tags&quot;: [&quot;&lt;&#x2F;strong&gt;&quot;]</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;firstname&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Profile-为了调试、优化"><a href="#Profile-为了调试、优化" class="headerlink" title="Profile  为了调试、优化"></a>Profile  为了调试、优化</h4><p>查询上加入上 profile 来获得详细的执行步骤、耗时信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;lastname&quot;: &quot;Justice&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="count-api-查询数量"><a href="#count-api-查询数量" class="headerlink" title="count api 查询数量"></a>count api 查询数量</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;bank&#x2F;accounts&#x2F;_count?q&#x3D;firstname:Malone</span><br><span class="line"># 或 </span><br><span class="line">GET &#x2F;bank&#x2F;accounts&#x2F;_count</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;firstname&quot; : &quot;Malone&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="validate-api"><a href="#validate-api" class="headerlink" title="validate api"></a>validate api</h2><p>用来检查我们的查询是否正确，以及查看底层生成查询。</p>
<p>GET /bank/_validate/query?q=firstname:Malone</p>
<h3 id="校验查询"><a href="#校验查询" class="headerlink" title="校验查询"></a>校验查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;bank&#x2F;accounts&#x2F;_validate&#x2F;query</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;query_string&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;firstname:Malone&quot;,</span><br><span class="line">      &quot;lenient&quot;: false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="获得查询解释"><a href="#获得查询解释" class="headerlink" title="获得查询解释"></a>获得查询解释</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;bank&#x2F;accounts&#x2F;_validate&#x2F;query?explain&#x3D;true</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;query_string&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;firstname:Malone&quot;,</span><br><span class="line">      &quot;lenient&quot;: false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>** 用rewrite获得比explain 更详细的解释 **</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;bank&#x2F;accounts&#x2F;_validate&#x2F;query?rewrite&#x3D;true</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;query_string&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;firstname:Malone&quot;,</span><br><span class="line">      &quot;lenient&quot;: false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;bank&#x2F;accounts&#x2F;_validate&#x2F;query?rewrite&#x3D;true</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;more_like_this&quot;: &#123;	</span><br><span class="line">      &quot;like&quot;: &#123;</span><br><span class="line">        &quot;_id&quot;: &quot;3&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;boost_terms&quot;: 1</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="获得所有分片上的查询解释"><a href="#获得所有分片上的查询解释" class="headerlink" title="获得所有分片上的查询解释"></a>获得所有分片上的查询解释</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;bank&#x2F;_doc&#x2F;_validate&#x2F;query?rewrite&#x3D;true&amp;all_shards&#x3D;true</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">        &quot;firstname&quot;: &quot;Virginia&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Explain-api"><a href="#Explain-api" class="headerlink" title="Explain api"></a>Explain api</h2><p>获得某个查询的评分解释，及某个文档是否被这个查询命中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;bank&#x2F;accounts&#x2F;0&#x2F;_explain</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot; : &#123;</span><br><span class="line">      &quot;match&quot; : &#123;&quot;firstname&quot;: &quot;Virginia&quot;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>官网链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-explain.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/search-explain.html</a></p>
<h2 id="Search-Shards-API"><a href="#Search-Shards-API" class="headerlink" title="Search Shards API"></a>Search Shards API</h2><p>让我们可以获取查询的索引分片节点情况</p>
<p>GET /bank/_search_shards</p>
<p>指定routing值的查询将在哪些分片节点上执行</p>
<p>GET /bank/_search_shards?routing=25,56</p>
<p>这里使用默认的路由，就是文档ID</p>
<h2 id="Search-Template-查询模板"><a href="#Search-Template-查询模板" class="headerlink" title="Search Template 查询模板"></a>Search Template 查询模板</h2><p>注册一个模板</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST _scripts&#x2F;bank_accounts_tm1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;script&quot;: &#123;</span><br><span class="line">        &quot;lang&quot;: &quot;mustache&quot;,</span><br><span class="line">        &quot;source&quot;: &#123;</span><br><span class="line">            &quot;query&quot;: &#123;</span><br><span class="line">                &quot;match&quot;: &#123;</span><br><span class="line">                    &quot;email&quot;: &quot;&#123;&#123;query_string&#125;&#125;&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用模板进行查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET _search&#x2F;template</span><br><span class="line">&#123;</span><br><span class="line">    &quot;id&quot;: &quot;bank_accounts_tm1&quot;, </span><br><span class="line">    &quot;params&quot;: &#123;</span><br><span class="line">        &quot;query_string&quot;: &quot;virginiaayala@filodyne.com&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Query-DSL"><a href="#Query-DSL" class="headerlink" title="Query DSL"></a>Query DSL</h1><p>Domain Specific Language：领域特定语言</p>
<p>Elasticsearch 提供了一个完整的 query DSL，并且是 JSON 形式的。它和 AST 比较类似，并且包含两种类型的语句：</p>
<ul>
<li><p>叶子查询语句（Leaf Query)，用于查询某个特定的字段，如 match , term 或 range 等</p>
</li>
<li><p>复合查询语句 (Compound query clauses) 用于合并其他的叶查询或复合查询语句，也就是说复合语句之间可以嵌套，用来表示一个复杂的单一查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">​ ** DSL ** （domain-specific language），领域特定语言指的是专注于某个应用程序领域的计算机语言，又译作领域专用语言。不同于普通的跨领域通用计算机语言(GPL)，领域特定语言只用在某些特定的领域。</span><br><span class="line">​ ** AST** （abstract syntax tree), 抽象语法树是源代码的抽象语法结构的树形表现形式。树上的每个节点都表示源代码中的一种结构。之所以说语法是“抽象”的，是因为这里的语法并不会表示出真实语法中出现的每个细节。比如，嵌套括号被隐含在树的结构中，并没有以节点的形式呈现；而类似于if-condition-then这样的条件跳转语句，可以使用带有两个分支的节点来表示。</span><br><span class="line">——百度百科</span><br></pre></td></tr></table></figure></li>
<li><ul>
<li>Query and filter context **<br>一个查询语句究竟具有什么样的行为和得到什么结果，主要取决于它到底是处于查询上下文(Query Context) 还是过滤上下文(Filter Context)。两者有很大区别，我们来看下：</li>
</ul>
</li>
<li><p>Query context 查询上下文：这种语句在执行时既要计算文档是否匹配，还要计算文档相对于其他文档的匹配度有多高，匹配度越高，<em>_score</em> 分数就越高</p>
</li>
<li><p>Filter context 过滤上下文：过滤上下文中的语句在执行时只关心文档是否和查询匹配，不会计算匹配度，也就是得分。</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; </span><br><span class="line">    &quot;bool&quot;: &#123; </span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;title&quot;:   &quot;Search&quot;        &#125;&#125;, </span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;content&quot;: &quot;Elasticsearch&quot; &#125;&#125;  </span><br><span class="line">      ],</span><br><span class="line">      &quot;filter&quot;: [ </span><br><span class="line">        &#123; &quot;term&quot;:  &#123; &quot;status&quot;: &quot;published&quot; &#125;&#125;, </span><br><span class="line">        &#123; &quot;range&quot;: &#123; &quot;publish_date&quot;: &#123; &quot;gte&quot;: &quot;2015-01-01&quot; &#125;&#125;&#125; </span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">query 参数表示整个语句是处于 query context 中</span><br><span class="line">bool 和 match 语句被用在 query context 中，也就是说它们会计算每个文档的匹配度（_score)</span><br><span class="line">filter 参数则表示这个子查询处于 filter context 中</span><br><span class="line">filter 语句中的 term 和 range 语句用在 filter context 中，它们只起到过滤的作用，并不会计算文档的得分。</span><br></pre></td></tr></table></figure>

<h2 id="Match-all-query"><a href="#Match-all-query" class="headerlink" title="Match all query"></a>Match all query</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 什么都不查 </span><br><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_none&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="全文查询-Full-text-queries"><a href="#全文查询-Full-text-queries" class="headerlink" title="全文查询 Full text queries"></a>全文查询 Full text queries</h2><p>全文查询，用于对分词的字段进行搜索。会用查询字段的分词器对查询的文本进行分词生成查询。可用于短语查询、模糊查询、前缀查询、临近查询等查询场景。</p>
<p>官网链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/full-text-queries.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/full-text-queries.html</a></p>
<h3 id="match-query"><a href="#match-query" class="headerlink" title="match query"></a>match query</h3><p>全文查询的标准查询，它可以对一个字段进行模糊、短语查询。 match queries 接收 text/numerics/dates, 对它们进行分词分析, 再组织成一个boolean查询。可通过operator 指定bool组合操作（or、and 默认是 or ）， 以及minimum_should_match 指定至少需多少个should(or)字句需满足。还可用ananlyzer指定查询用的特殊分析器。包括模糊查询(fuzzy matching) 或者临近查询(proximity queries)。</p>
<p>新增文档：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;ftq&#x2F;_doc&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;lucene solr and elasticsearch&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;lucene solr and elasticsearch for search&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT &#x2F;ftq&#x2F;_doc&#x2F;2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;java spring boot&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;lucene is writerd by java&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 查询：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">GET ftq&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &quot;lucene java&quot;  #分词后用or</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET ftq&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;lucene java&quot;,</span><br><span class="line">        &quot;operator&quot;: &quot;and&quot;  #指定分词后用and</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>** 模糊查询，可以指定fuzziness最大编辑数 **</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">最大编辑数为2，说明query字符串中分词后，每个词允许编辑两次单个字符，可删除、新增、修改字符</span><br><span class="line">fuzziness 参数可以被设置为 AUTO，此时字符串只有 1 到 2 个字符时是 0；字符串有 3 、4 或者 5 个字符时是 1；字符串大于 5 个字符时是 2</span><br><span class="line">有时编辑距离 2 仍然是太多了，返回的结果似乎并不相关。 把最大 fuzziness 设置为 1 ，可以得到更好的结果和更好的性能</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET ftq&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;ucen elatic&quot;,</span><br><span class="line">        &quot;fuzziness&quot;: 2</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>** 指定最少需满足两个词匹配 ** </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET ftq&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;content&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;ucen elatic java&quot;,</span><br><span class="line">        &quot;fuzziness&quot;: 2,</span><br><span class="line">        &quot;minimum_should_match&quot;: 2</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>** max_expansions 指定模糊匹配的最大词项数，默认是50。**</p>
<p>比如：反向索引中有 100 个词项与 ucen 模糊匹配，只选用前50 个。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET ftq&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;content&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;ucen elatic java&quot;,</span><br><span class="line">        &quot;fuzziness&quot;: 2,</span><br><span class="line">        &quot;minimum_should_match&quot;: 2,</span><br><span class="line">        &quot;max_expansions &quot;: 50</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="match-phrase-query"><a href="#match-phrase-query" class="headerlink" title="match_phrase query"></a>match_phrase query</h3><p>match_phrase 查询用来对一个字段进行短语查询，可以指定 analyzer、slop移动因子。和 match 查询比较类似，但是它会保留包含所有搜索词项，且位置与搜索词项相同的文档。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#短语查询</span><br><span class="line">GET ftq&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_phrase&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &quot;lucene solr&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#指定移动因子  </span><br><span class="line">GET ftq&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_phrase&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;lucene elasticsearch&quot;,</span><br><span class="line">        &quot;slop&quot;: 2</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="match-phrase-prefix-query"><a href="#match-phrase-prefix-query" class="headerlink" title="match_phrase_prefix query"></a>match_phrase_prefix query</h3><p>是一种输入即搜索(search-as-you-type) 的查询，它和 match_phrase 比较类似，区别就是会将查询字符串的最后一个词作为前缀来使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_phrase_prefix&quot; : &#123;</span><br><span class="line">            &quot;message&quot; : &quot;quick brown f&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 指定前缀匹配选用的最大词项数量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_phrase_prefix&quot; : &#123;</span><br><span class="line">            &quot;message&quot; : &#123;</span><br><span class="line">                &quot;query&quot; : &quot;quick brown f&quot;,</span><br><span class="line">                &quot;max_expansions&quot; : 10</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="multi-match-query"><a href="#multi-match-query" class="headerlink" title="multi_match query"></a>multi_match query</h3><p>需要在多个字段上进行文本搜索，可用multi_match 。 multi_match在 match的基础上支持对多个字段进行文本查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET ftq&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot; : &#123;</span><br><span class="line">      &quot;query&quot;:    &quot;lucene java&quot;, </span><br><span class="line">      &quot;fields&quot;: [ &quot;title&quot;, &quot;content&quot; ] </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">还可以使用*匹配多个字段：</span><br><span class="line"></span><br><span class="line">GET ftq&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot; : &#123;</span><br><span class="line">      &quot;query&quot;:    &quot;lucene java&quot;, </span><br><span class="line">      &quot;fields&quot;: [ &quot;title&quot;, &quot;cont*&quot; ] </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="query-string-query"><a href="#query-string-query" class="headerlink" title="query_string query"></a>query_string query</h3><p>支持复杂的 Lucene query String 语法，可以直接用lucene查询语法写一个查询串进行查询，ES中接到请求后，通过查询解析器解析查询串生成对应的查询。使用它要求掌握lucene的查询语法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 单字段</span><br><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;query_string&quot; : &#123;</span><br><span class="line">            &quot;default_field&quot; : &quot;content&quot;,</span><br><span class="line">            &quot;query&quot; : &quot;this AND that OR thus&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"># 多字段通配符查询</span><br><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;query_string&quot; : &#123;</span><br><span class="line">            &quot;fields&quot; : [&quot;content&quot;,  &quot;name.*^5&quot;],</span><br><span class="line">            &quot;query&quot; : &quot;this AND that OR thus&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="common-terms-query"><a href="#common-terms-query" class="headerlink" title="common terms query"></a>common terms query</h3><p>common 常用词查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">问1、什么是停用词？索引时做停用词处理的目的是什么？</span><br><span class="line">不再使用的词，做停用词处理的目的是提高索引的效率，去掉不需要的索引操作，即停用词不需要索引</span><br><span class="line"></span><br><span class="line">问2、如果在索引时应用停用词处理，下面的两个查询会查询什么词项？</span><br><span class="line">the brown fox—— brown fox</span><br><span class="line">not happy——happy</span><br><span class="line"></span><br><span class="line">问3、索引时应用停用词处理对搜索精度是否有影响？如果不做停用词处理又会有什么影响？如何协调这两个问题？如何保证搜索的精确度又兼顾搜索性能？</span><br><span class="line">索引时应用停用词处理对搜索精度有影响，不做停用词处理又会影响索引的效率，要协调这两个问题就必须要使用tf-idf 相关性计算模型</span><br></pre></td></tr></table></figure>
<p>** tf-idf 相关性计算模型 **<br>tf：term frequency   词频 ：指一个词在一篇文档中出现的频率。</p>
<p>如“世界杯”在文档A中出现3次，那么可以定义“世界杯”在文档A中的词频为3。请问在一篇3000字的文章中出现“世界杯”3次和一篇150字的文章中出现3词，哪篇文章更是与“世界杯”有关的。也就是说，简单用出现次数作为频率不够准确。那就用占比来表示：</p>
<p><img src="https://img.huyunshun.com/img1/Elasticsearch/sdafasdgsdg524535478imgclip.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">问：tf值越大是否就一定说明这个词更相关？</span><br><span class="line"> 不是，出现太多了说明不重要</span><br><span class="line"></span><br><span class="line"> 说明：tf的计算不一定非是这样的，可以定义不同的计算方式。</span><br><span class="line">	df：document frequency 词的文档频率 ：指包含某个词的文档数（有多少文档中包含这个词）。 df越大的词越常见，哪些词会是高频词？</span><br><span class="line"></span><br><span class="line">问：词的df值越大说明这个词在这个文档集中是越重要还是越不重要？</span><br><span class="line"> 越不重要</span><br><span class="line"></span><br><span class="line">问：词t的tf高，在文档集中的重要性也高，是否说明文档与该词越相关？举例：整个文档集中只有3篇文档中有“世界杯”，文档A中就出现了“世界杯”好几次。 </span><br><span class="line"> 不能说明文档与该词越相关</span><br><span class="line"></span><br><span class="line">问：如何用数值体现词t在文档集中的重要性？df可以吗？</span><br><span class="line"> 不可以</span><br></pre></td></tr></table></figure>
<p>idf：inverse document frequency   词的逆文档频率 ：用来表示词在文档集中的重要性。文档总数/ df ，df越小，词越重要，这个值会很大，那就对它取个自然对数，将值映射到一个较小的取值范围。</p>
<p><img src="https://img.huyunshun.com/img1/Elasticsearch/sdafasdgsdg524535478imgclip_1.png" alt=""> </p>
<p>说明： +1 是为了避免除0（即词t在文档集中未出现的情况）</p>
<p>tf-idf 相关性性计算模型：tf-idf t = tf t,d * idf t</p>
<p> 说明： tf-idf 相关性性计算模型的值为词频（ tf t,d）乘以词的逆文档频率（idf t）</p>
<p>** Common terms query **</p>
<p>common 区分常用（高频）词查询让我们可以通过cutoff_frequency来指定一个分界文档频率值，将搜索文本中的词分为高频词和低频词，低频词的重要性高于高频词，先对低频词进行搜索并计算所有匹配文档相关性得分；然后再搜索和高频词匹配的文档，这会搜到很多文档，但只对和低频词重叠的文档进行相关性得分计算（这可保证搜索精确度，同时大大提高搜索性能），和低频词累加作为文档得分。实际执行的搜索是 必须包含低频词 + 或包含高频词。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">思考：这样处理下，如果用户输入的都是高频词如 “to be or not to be”结果会是怎样的？你希望是怎样的？</span><br><span class="line">优化：如果都是高频词，那就对这些词进行and 查询。</span><br><span class="line">进一步优化：让用户可以自己定对高频词做and&#x2F;or 操作，自己定对低频词进行and&#x2F;or 操作；或指定最少得多少个同时匹配</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;common&quot;: &#123;</span><br><span class="line">            &quot;address&quot;: &#123;</span><br><span class="line">                &quot;query&quot;: &quot;171 Putnam Avenue&quot;,</span><br><span class="line">                &quot;cutoff_frequency&quot;: 0.001</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>说明：cutoff_frequency : 值大于1表示文档数，0-1.0表示占比。 此处界定 文档频率大于 0.1%的词为高频词。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;common&quot;: &#123;</span><br><span class="line">          &quot;address&quot;: &#123;</span><br><span class="line">                &quot;query&quot;: &quot;171 Putnam Avenue&quot;,</span><br><span class="line">                &quot;cutoff_frequency&quot;: 0.001,</span><br><span class="line">                &quot;low_freq_operator&quot;: &quot;and&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>说明：low_freq_operator指定对低频词做与操作。</p>
<p>可用参数：minimum_should_match (high_freq, low_freq), low_freq_operator (default “or”) and high_freq_operator (default “or”)、 boost and analyzer</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;common&quot;: &#123;</span><br><span class="line">            &quot;address&quot;: &#123;</span><br><span class="line">                &quot;query&quot;: &quot;171 Putnam Avenue&quot;,</span><br><span class="line">                &quot;cutoff_frequency&quot;: 0.001,</span><br><span class="line">                &quot;minimum_should_match&quot;: 2</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;common&quot;: &#123;</span><br><span class="line">            &quot;address&quot;: &#123;</span><br><span class="line">                &quot;query&quot;: &quot;171 Putnam Avenue&quot;,</span><br><span class="line">                &quot;cutoff_frequency&quot;: 0.001,</span><br><span class="line">                &quot;minimum_should_match&quot;: &#123;</span><br><span class="line">                    &quot;low_freq&quot; : 2,</span><br><span class="line">                    &quot;high_freq&quot; : 3</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="simple-query-string-query"><a href="#simple-query-string-query" class="headerlink" title="simple_query_string query"></a>simple_query_string query</h3><p>简化版的 query_string ，simple_query_string 查同 query_string 查询一样用lucene查询语法写查询串，较query_string不同的地方：更小的语法集；查询串有错误，它会忽略错误的部分，不抛出错误。更适合给用户使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;simple_query_string&quot; : &#123;</span><br><span class="line">        &quot;query&quot;: &quot;\&quot;fried eggs\&quot; +(eggplant | potato) -frittata&quot;,</span><br><span class="line">        &quot;fields&quot;: [&quot;title^5&quot;, &quot;body&quot;],</span><br><span class="line">        &quot;default_operator&quot;: &quot;and&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="词项查询"><a href="#词项查询" class="headerlink" title="词项查询"></a>词项查询</h2><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/term-level-queries.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/term-level-queries.html</a></p>
<h3 id="term-terms-query"><a href="#term-terms-query" class="headerlink" title="term/terms query"></a>term/terms query</h3><p>term 查询用于查询指定字段包含某个词项的文档。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">POST _search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot; : &#123; &quot;address&quot; : &quot;Putnam&quot; &#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 权重boost </span><br><span class="line">POST _search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">            &quot;balance&quot;: &#123;&quot;value&quot;: 40540,&quot;boost&quot;: 2&#125;</span><br><span class="line">          &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#  terms 查询用于查询指定字段包含某些词项的文档。</span><br><span class="line">POST _search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;terms&quot; : &#123; &quot;address&quot; : [&quot;171&quot;,&quot;Putnam&quot;] &#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Terms 还可以查询支持嵌套查询的方式来获得查询词项，相当于 in (select term from other)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;terms&quot; : &#123;</span><br><span class="line">        &quot;firstname&quot; : &#123;</span><br><span class="line">          &quot;index&quot;: &quot;bank&quot;,</span><br><span class="line">          &quot;type&quot;: &quot;accounts&quot;,</span><br><span class="line">          &quot;id&quot;: &quot;25&quot;,</span><br><span class="line">          &quot;path&quot;: &quot;followers&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="range-query"><a href="#range-query" class="headerlink" title="range query"></a>range query</h3><p>范围查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gte：大于等于</span><br><span class="line">gt：大于</span><br><span class="line">lte：小于等于</span><br><span class="line">lt：小于</span><br><span class="line">boost：查询权重</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">GET _search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;range&quot; : &#123;</span><br><span class="line">            &quot;age&quot; : &#123;</span><br><span class="line">                &quot;gte&quot; : 10,</span><br><span class="line">                &quot;lte&quot; : 20,</span><br><span class="line">                &quot;boost&quot; : 2.0</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET _search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;range&quot; : &#123;</span><br><span class="line">            &quot;date&quot; : &#123;</span><br><span class="line">                &quot;gte&quot; : &quot;now-1d&#x2F;d&quot;,  #当前时间减1天后转成天数</span><br><span class="line">                &quot;lt&quot; :  &quot;now&#x2F;d&quot;  #当前时间转成条数</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET _search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;range&quot; : &#123;</span><br><span class="line">            &quot;born&quot; : &#123;</span><br><span class="line">                &quot;gte&quot;: &quot;01&#x2F;01&#x2F;2012&quot;,</span><br><span class="line">                &quot;lte&quot;: &quot;2013&quot;,</span><br><span class="line">                &quot;format&quot;: &quot;dd&#x2F;MM&#x2F;yyyy||yyyy&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>时间舍入||说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gt：大于的情况下，四舍五入，比如2014-11-18||&#x2F;M变成2014-11-30T23:59:59:999，不包含整个月</span><br><span class="line">gte：大于等于的情况下，向下取整，比如2014-11-18||&#x2F;M变成2014-11-01，包含整个月</span><br><span class="line">lt：小于的情况下，向下取整，比如2014-11-18||&#x2F;M变成2014-11-01，不包含整个月</span><br><span class="line">lte：小于等于的情况下，四舍五入，比如2014-11-18||&#x2F;M变成2014-11-30T23:59:59:999，包含整个月</span><br></pre></td></tr></table></figure>

<h3 id="exits-query"><a href="#exits-query" class="headerlink" title="exits query"></a>exits query</h3><p>查询指定字段值不为空的文档。相当 SQL 中的 column is not null</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;exists&quot; : &#123; &quot;field&quot; : &quot;balance&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="prefix-query-词项前缀查询"><a href="#prefix-query-词项前缀查询" class="headerlink" title="prefix query 词项前缀查询"></a>prefix query 词项前缀查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123; &quot;query&quot;: &#123;</span><br><span class="line">    &quot;prefix&quot; : &#123; &quot;address&quot; : &quot;171&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="wildcard-query-通配符查询"><a href="#wildcard-query-通配符查询" class="headerlink" title="wildcard query 通配符查询"></a>wildcard query 通配符查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;wildcard&quot; : &#123; &quot;lastname&quot; : &quot;A*a*&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"># 加权 </span><br><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;wildcard&quot;: &#123;</span><br><span class="line">      &quot;lastname&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;ki*y&quot;,</span><br><span class="line">        &quot;boost&quot;: 2</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="regexp-query-正则查询"><a href="#regexp-query-正则查询" class="headerlink" title="regexp query 正则查询"></a>regexp query 正则查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;regexp&quot;:&#123;</span><br><span class="line">            &quot;name.first&quot;: &quot;s.*y&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;regexp&quot;:&#123;</span><br><span class="line">            &quot;name.first&quot;:&#123;</span><br><span class="line">                &quot;value&quot;:&quot;s.*y&quot;,</span><br><span class="line">                &quot;boost&quot;:1.2</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>正则语法参考：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-regexp-query.html#regexp-syntax" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-regexp-query.html#regexp-syntax</a></p>
<h3 id="fuzzy-query-模糊查询"><a href="#fuzzy-query-模糊查询" class="headerlink" title="fuzzy query 模糊查询"></a>fuzzy query 模糊查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">       &quot;fuzzy&quot; : &#123; &quot;address&quot; : &quot;Avenue&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;fuzzy&quot; : &#123;</span><br><span class="line">            &quot;address&quot; : &#123;</span><br><span class="line">                &quot;value&quot;: &quot;Avenue&quot;,</span><br><span class="line">                &quot;boost&quot;: 1.0,</span><br><span class="line">                &quot;fuzziness&quot;: 2,</span><br><span class="line">                &quot;prefix_length&quot;: 0,</span><br><span class="line">                &quot;max_expansions&quot;: 100</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ids-根据文档id查询"><a href="#ids-根据文档id查询" class="headerlink" title="ids 根据文档id查询"></a>ids 根据文档id查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;ids&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;_doc&quot;,</span><br><span class="line">            &quot;values&quot; : [&quot;1&quot;, &quot;4&quot;, &quot;100&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="复合查询"><a href="#复合查询" class="headerlink" title="复合查询"></a>复合查询</h2><h3 id="constant-score-query"><a href="#constant-score-query" class="headerlink" title="constant score query"></a>constant score query</h3><p>用来包装另一个查询，将查询匹配的文档的评分设为一个常值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;constant_score&quot; : &#123;</span><br><span class="line">            &quot;filter&quot; : &#123;</span><br><span class="line">                &quot;term&quot; : &#123; &quot;age&quot; : &quot;39&quot;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;boost&quot; : 1.2</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="bool-query"><a href="#bool-query" class="headerlink" title="bool query"></a>bool query</h3><p>Bool 查询用bool操作来组合多个查询字句为一个查询。 可用的关键字：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">must：必须满足</span><br><span class="line">filter：必须满足，但执行的是filter上下文，不参与、不影响评分</span><br><span class="line">should：或</span><br><span class="line">must_not：必须不满足，在filter上下文中执行，不参与、不影响评分</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">POST _search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot; : &#123;</span><br><span class="line">      &quot;must&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;lastname&quot;: &quot;Ayala&quot;&#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;state&quot;: &quot;PA&quot; &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;must_not&quot; : &#123;</span><br><span class="line">        &quot;range&quot; : &#123;</span><br><span class="line">          &quot;age&quot; : &#123; &quot;gte&quot; : 10, &quot;lte&quot; : 20 &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;should&quot; : [</span><br><span class="line">        &#123; &quot;term&quot; : &#123; &quot;city&quot;: &quot;Nicholson&quot; &#125; &#125;,</span><br><span class="line">        &#123; &quot;term&quot; : &#123; &quot;city&quot;: &quot;Shaft&quot; &#125; &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;minimum_should_match&quot; : 1,</span><br><span class="line">      &quot;boost&quot; : 1.0</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/03/13/Elasticsearch%E8%B7%AF%E7%94%B1%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/13/Elasticsearch%E8%B7%AF%E7%94%B1%E8%AF%A6%E8%A7%A3/" itemprop="url">Elasticsearch路由详解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-13T00:00:00+08:00">
                2019-03-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ELasticSearch路由"><a href="#ELasticSearch路由" class="headerlink" title="ELasticSearch路由"></a>ELasticSearch路由</h1><p>在ELasticSearch 里面，路由功能算是一个高级用法，大多数时候我们用的都是系统默认的路由功能，一个es索引可以分成shard和每个shard又可以有多个replia，那么添加进去的数据，在如何分布在各个shard上面的，而查询的时候文档是如何路由的。</p>
<p>默认情况下，索引数据的分片规则，是下面的公式：</p>
<p>shard  = hash(_routing) % num_primary_shards</p>
<p>routing 是用来进行hash计算的路由值，默认是使用文档id值。我们可以在索引文档时通过routing参数指定别的路由值，number_of_primary_shards：创建索引时指定的主分片数</p>
<p>ES默认是基于hash的分片，保证在每个shard上数据量都近似平均，这样就不会出现负载不均衡的情况，然后在检索的时候，ES默认会搜索所有的shard上的数据，然后在master节点上面汇聚处理后，返回最终结果。</p>
<p>有时候，会有另外一种情况，比如说存储一年的数据，如果按照hash去索引，那就是分布非常的均匀，这样的话无论查询什么数据都会去所有的shard上面查询，如果数据量比较大，那么响应速度就比较慢，但这时，我们通过调查发现，一年12个月的数据本身分布并不均匀，有几个月的数据偏多，有几个月的数据偏少，理想情况下，数据偏少的月，查询性能应该更快，但如果是基于hash分片，那么我们并不能实现这种需求，因为hash分片，查询时候必须命中所有的shard之后，查询的结果才是准的，这样一来每次查询都要扫描所有的shard，比如我已经知道数据本身就是1月份的，那其实最好情况下，只查询1月份的数据就行，而不需要把一年的数据都扫描一遍，导致最终结果就是慢的更慢，快的也慢所以我们要针对性的做优化。</p>
<p>那么如何优化，其实思路也比较明确了，那就是按照月份分区，每一个月份的数据都存放在指定的分区中，如果mysql那就是每一个月份一张表，然后查询的时候，直接查询对应月份的数据即可，在es和solr中原理也大致如此，唯一不同的地方在以es 和 solr都比较方便的支持了路由字段的设置而如果数据库，则需要自己通过中间件的方式来搞定，比如说mycat等。</p>
<h2 id="使用路由"><a href="#使用路由" class="headerlink" title="使用路由"></a>使用路由</h2><p>es中使用路由字段，看一个官网给的一个例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#指定了一个用户的属性作为路由进行分区，然后查询的时候也必须指定路由。</span><br><span class="line"></span><br><span class="line">PUT my_index&#x2F;my_type&#x2F;1?routing&#x3D;user1&amp;refresh&#x3D;true </span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;This is a document&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET my_index&#x2F;my_type&#x2F;1?routing&#x3D;user1</span><br></pre></td></tr></table></figure>
<p>注意，只要在索引的时候加入了路由字段，那么在以后的get、delete、update中都必须指定使用路由字段，否则会出现问题。</p>
<p>路由字段，也是可以被查询的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET my_index&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;terms&quot;: &#123;</span><br><span class="line">      &quot;_routing&quot;: [ &quot;user1&quot; ] </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也可以指定多个路由字段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET my_index&#x2F;_search?routing&#x3D;user1,user2 </span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &quot;document&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果指定了多个用户属性，那么只会查询关联了这两个route属性的shard</p>
<p>如果加入路由字段之后，其他的操作都必须指定字段，为了避免在使用时忘了添加路由字段，导致同类型数据会分布在多个shard上面，这就违反了路由的原则，所以我们可以在mapping中设置路由字段是必需字段，否则会提示错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;my_type&quot;: &#123;</span><br><span class="line">      &quot;_routing&quot;: &#123;</span><br><span class="line">        &quot;required&quot;: true </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_index2&#x2F;my_type&#x2F;1 </span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;: &quot;No routing value provided&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>缺失字段会抛出异常：routing_missing_exception</p>
<p>还需要注意的是如果使用了路由字段，那么_id字段只能由用户来保证唯一性，因为同一个id的数据，如果路由字段不一样，他是可以被存在到多个shard中的，而默认情况下是不会出现这种情况的。</p>
<h1 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h1><h2 id="集群组成"><a href="#集群组成" class="headerlink" title="集群组成"></a>集群组成</h2><p>首先启动的一定是主节点，主节点存储的是集群的元数据信息；</p>
<p>Node2节点启动之前会配置集群的名称Cluster-name：ess，然后配置可以作为主节点的ip地址信息discovery.zen.ping.unicast.hosts: [“10.0.1.11”,“10.0.1.12”]，配置自己的ip地址networ.host: 10.0.1.12；</p>
<p>Node2启动的过程中会去找到主节点Node1告诉Node1我要加入到集群里面了，主节点Node1接收到请求以后看Node2是否满足加入集群的条件，如果满足就把node2的ip地址加入的元信息里面，然后广播给集群中的其他节点有新节点加入，并把最新的元信息发送给其他的节点去更新；</p>
<p>集群中的所有节点的元信息都是和主节点一致的，因为一旦有新的节点加入进来，主节点会通知其他的节点同步元信息。</p>
<p>集群有节点出现故障，如主节点挂了，会重新选择主节点。</p>
<h2 id="集群中创建索引的流程"><a href="#集群中创建索引的流程" class="headerlink" title="集群中创建索引的流程"></a>集群中创建索引的流程</h2><ul>
<li>1、首先请求转发到master节点；</li>
<li>2、选择节点 的分片、副本、记录元信息；</li>
<li>3、通知给参与存放索引分片、副本的节点从节点创建分片、副本；</li>
<li>4、参与的节点向主节点反馈结果；</li>
<li>5、等待时间到了，master向一个节点反馈信息，节点响应请求；</li>
<li>6、主节点将元信息广播给所有的从节点。</li>
</ul>
<p><img src="https://img.huyunshun.com/img1/Elasticsearch/asdfdasgsdg324324265dghfghdfg.png" alt=""></p>
<h2 id="在集群中索引文档"><a href="#在集群中索引文档" class="headerlink" title="在集群中索引文档"></a>在集群中索引文档</h2><p>索引文档的步骤：</p>
<ul>
<li>1、node2计算文档的路由值得到文档存放的分片（假定路由选定的是分片0）。</li>
<li>2、将文档转发给分片0(P0)的主分片节点 node1。</li>
<li>3、node1索引文档，同步给副本（R0）节点node3索引文档。</li>
<li>4、node1向node2反馈结果</li>
<li>5、node2作出响应</li>
</ul>
<h2 id="文档是如何路由的"><a href="#文档是如何路由的" class="headerlink" title="文档是如何路由的"></a>文档是如何路由的</h2><p>shard  = hash(_routing) % num_primary_shards</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">number_of_primary_shards：创建索引时候指定的主分片数参数值</span><br><span class="line">routing：用来进行hash计算的路由值，默认是使用文档id值。我们可以在索引文档时通过routing参数指定别的路由值</span><br><span class="line">在索引、删除、更新、查询中都可以使用routing参数（可多值）指定操作的分片。</span><br></pre></td></tr></table></figure>

<h2 id="在集群中进行搜索流程"><a href="#在集群中进行搜索流程" class="headerlink" title="在集群中进行搜索流程"></a>在集群中进行搜索流程</h2><p>搜索的步骤：如要搜索 索引 s0</p>
<ul>
<li>1、node2解析查询。</li>
<li>2、node2将查询发给索引s0的分片/副本（R1,R2,R0）节点</li>
<li>3、各节点执行查询，将结果发给Node2</li>
<li>4、Node2合并结果，作出响应。</li>
</ul>
<h2 id="Master节点的工作任务"><a href="#Master节点的工作任务" class="headerlink" title="Master节点的工作任务"></a>Master节点的工作任务</h2><ul>
<li><ol>
<li>存储集群的元信息，如集群名称、集群中的节点</li>
</ol>
</li>
<li><ol start="2">
<li>转发创建索引和索引文档的请求</li>
</ol>
</li>
<li><ol start="3">
<li>和其他的节点进行通信，告诉其他节点有新的节点加入等</li>
</ol>
</li>
</ul>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/03/12/Elasticsearch%E5%88%86%E8%AF%8D%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/12/Elasticsearch%E5%88%86%E8%AF%8D%E5%99%A8/" itemprop="url">Elasticsearch分词器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-12T00:00:00+08:00">
                2019-03-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>因为Elasticsearch中默认的标准分词器分词器对中文分词不是很友好，会将中文词语拆分成一个一个中文的汉子，因此引入中文分词器。</p>
<p> 在ES中一个Analyzer 由下面三种组件组合而成：</p>
<ul>
<li>character filter ：字符过滤器，对文本进行字符过滤处理，如处理文本中的html标签字符。处理完后再交给tokenizer进行分词。一个analyzer中可包含0个或多个字符过滤器，多个按配置顺序依次进行处理。</li>
<li>tokenizer：分词器，对文本进行分词。一个analyzer必需且只可包含一个tokenizer。</li>
<li>token filter：词项过滤器，对tokenizer分出的词进行过滤处理。如转小写、停用词处理、同义词处理。一个analyzer可包含0个或多个词项过滤器，按配置顺序进行过滤。<h1 id="测试默认的分词"><a href="#测试默认的分词" class="headerlink" title="测试默认的分词"></a>测试默认的分词</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_analyze </span><br><span class="line">&#123;</span><br><span class="line">	&quot;analyzer&quot;:&quot;standard&quot;,</span><br><span class="line">	&quot;text&quot;:&quot;中国china&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
#或 <a href="http://127.0.0.1:9200/_analyze" target="_blank" rel="noopener">http://127.0.0.1:9200/_analyze</a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">参数：</span><br><span class="line">&#123;</span><br><span class="line">	&quot;analyzer&quot;:&quot;standard&quot;,</span><br><span class="line">	&quot;text&quot;:&quot;中国china&quot;</span><br><span class="line">&#125;</span><br><span class="line">结果：</span><br><span class="line">&#123;</span><br><span class="line">    &quot;tokens&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;中&quot;,</span><br><span class="line">            &quot;start_offset&quot;: 0,</span><br><span class="line">            &quot;end_offset&quot;: 1,</span><br><span class="line">            &quot;type&quot;: &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">            &quot;position&quot;: 0</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;国&quot;,</span><br><span class="line">            &quot;start_offset&quot;: 1,</span><br><span class="line">            &quot;end_offset&quot;: 2,</span><br><span class="line">            &quot;type&quot;: &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">            &quot;position&quot;: 1</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;china&quot;,</span><br><span class="line">            &quot;start_offset&quot;: 2,</span><br><span class="line">            &quot;end_offset&quot;: 7,</span><br><span class="line">            &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">            &quot;position&quot;: 2</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">position：第几个词</span><br><span class="line">offset：词的偏移位置</span><br></pre></td></tr></table></figure>
<h2 id="character-filter"><a href="#character-filter" class="headerlink" title="character filter"></a>character filter</h2></li>
<li><ul>
<li>HTML Strip Character Filter **<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HTML Strip Character Filter</span><br><span class="line">　　html_strip ：过滤html标签，解码HTML entities like &amp;.</span><br><span class="line">Mapping Character Filter</span><br><span class="line">　　mapping ：用指定的字符串替换文本中的某字符串。</span><br><span class="line">Pattern Replace Character Filter</span><br><span class="line">　　pattern_replace ：进行正则表达式替换。</span><br></pre></td></tr></table></figure>
测试：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;:      &quot;keyword&quot;, </span><br><span class="line">  &quot;char_filter&quot;:  [ &quot;html_strip&quot; ],</span><br><span class="line">  &quot;text&quot;: &quot;&lt;p&gt; I &lt;br&#x2F;&gt; Love &lt;br&#x2F;&gt; You!&lt;&#x2F;p&gt;&quot;</span><br><span class="line">&#125;</span><br><span class="line">结果：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"> I </span><br><span class="line"> Love </span><br><span class="line"> You!</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 31,</span><br><span class="line">      &quot;type&quot; : &quot;word&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
在索引中配置：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;my_analyzer&quot;: &#123;</span><br><span class="line">          &quot;tokenizer&quot;: &quot;keyword&quot;,</span><br><span class="line">          &quot;char_filter&quot;: [&quot;my_char_filter&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;char_filter&quot;: &#123;</span><br><span class="line">        &quot;my_char_filter&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;html_strip&quot;,</span><br><span class="line">          &quot;escaped_tags&quot;: [&quot;b&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#escaped_tags 用来指定例外的标签。</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><ul>
<li>Mapping character filter **<br>创建一个：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">PUT demo_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;my_analyzer&quot;: &#123;</span><br><span class="line">          &quot;tokenizer&quot;: &quot;keyword&quot;,</span><br><span class="line">          &quot;char_filter&quot;: [</span><br><span class="line">            &quot;my_char_filter&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;char_filter&quot;: &#123;</span><br><span class="line">        &quot;my_char_filter&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;mapping&quot;,</span><br><span class="line">          &quot;mappings&quot;: [</span><br><span class="line">            &quot;零 &#x3D;&gt; 0&quot;,</span><br><span class="line">            &quot;一 &#x3D;&gt; 1&quot;,</span><br><span class="line">            &quot;二 &#x3D;&gt; 2&quot;,</span><br><span class="line">            &quot;三 &#x3D;&gt; 3&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
测试：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST demo_index&#x2F;_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;my_analyzer&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;一二三四五六零&quot;</span><br><span class="line">&#125;</span><br><span class="line">结果：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;123四五六0&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 7,</span><br><span class="line">      &quot;type&quot; : &quot;word&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><ul>
<li>Pattern Replace Character Filter **<br>创建：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">PUT demo_index1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;my_analyzer&quot;: &#123;</span><br><span class="line">          &quot;tokenizer&quot;: &quot;standard&quot;,</span><br><span class="line">          &quot;char_filter&quot;: [</span><br><span class="line">            &quot;my_char_filter&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;char_filter&quot;: &#123;</span><br><span class="line">        &quot;my_char_filter&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;pattern_replace&quot;,</span><br><span class="line">          &quot;pattern&quot;: &quot;(\\d+)-(?&#x3D;\\d)&quot;,</span><br><span class="line">          &quot;replacement&quot;: &quot;$1_&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
测试：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">POST demo_index1&#x2F;_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;my_analyzer&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;My credit card is 123-456-789&quot;</span><br><span class="line">&#125;</span><br><span class="line">结果：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;My&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 2,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;credit&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 3,</span><br><span class="line">      &quot;end_offset&quot; : 9,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;card&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 10,</span><br><span class="line">      &quot;end_offset&quot; : 14,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;is&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 15,</span><br><span class="line">      &quot;end_offset&quot; : 17,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 3</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;123_456_789&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 18,</span><br><span class="line">      &quot;end_offset&quot; : 29,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;NUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 4</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Tokenizer"><a href="#Tokenizer" class="headerlink" title="Tokenizer"></a>Tokenizer</h2>Standard Tokenizer<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Letter Tokenizer</span><br><span class="line">Lowercase Tokenizer</span><br><span class="line">Whitespace Tokenizer</span><br><span class="line">UAX URL Email Tokenizer</span><br><span class="line">Classic Tokenizer</span><br><span class="line">Thai Tokenizer</span><br><span class="line">NGram Tokenizer</span><br><span class="line">Edge NGram Tokenizer</span><br></pre></td></tr></table></figure>
Keyword Tokenizer<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Pattern Tokenizer</span><br><span class="line">Simple Pattern Tokenizer</span><br><span class="line">Simple Pattern Split Tokenizer</span><br><span class="line">Path Hierarchy Tokenizer</span><br><span class="line">Keyword Tokenizer</span><br><span class="line">Pattern Tokenizer</span><br><span class="line">Simple Pattern Tokenizer</span><br><span class="line">Simple Pattern Split Tokenizer</span><br><span class="line">Path Hierarchy Tokenizer</span><br></pre></td></tr></table></figure>
测试：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;ik_smart&quot;, </span><br><span class="line">  &quot;text&quot;: &quot;中国china&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h2 id="Token-Filter"><a href="#Token-Filter" class="headerlink" title="Token Filter"></a>Token Filter</h2><p>ES中内建了很多Token filter </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Lowercase Token Filter ：lowercase 转小写</span><br><span class="line">Stop Token Filter ：stop 停用词过滤器</span><br><span class="line">Synonym Token Filter： synonym 同义词过滤器</span><br><span class="line"></span><br><span class="line"> 说明：中文分词器Ikanalyzer中自带有停用词过滤功能。</span><br></pre></td></tr></table></figure>
<p>** Synonym Token Filter 同义词过滤器 **</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;demo_index1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot;: &#123;</span><br><span class="line">        &quot;index&quot;: &#123;</span><br><span class="line">            &quot;analysis&quot;: &#123;</span><br><span class="line">                &quot;analyzer&quot;: &#123;</span><br><span class="line">                    &quot;my_ik_synonym&quot;: &#123;</span><br><span class="line">                        &quot;tokenizer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">                        &quot;filter&quot;: [</span><br><span class="line">                            &quot;synonym&quot;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;filter&quot;: &#123;</span><br><span class="line">                    &quot;synonym&quot;: &#123;</span><br><span class="line">                        &quot;type&quot;: &quot;synonym&quot;,</span><br><span class="line">                        &quot;synonyms_path&quot;: &quot;analysis&#x2F;synonym.txt&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#synonyms_path 指定同义词文件（相对config的位置）</span><br></pre></td></tr></table></figure>
<p>ES同义词格式支持 solr、 WordNet 两种格式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">张三,李四</span><br><span class="line">电饭煲,电饭锅 &#x3D;&gt; 电饭煲</span><br><span class="line">电脑 &#x3D;&gt; 计算机,computer</span><br></pre></td></tr></table></figure>
<h2 id="Analyzer"><a href="#Analyzer" class="headerlink" title="Analyzer"></a>Analyzer</h2><p>集成的中文分词器Ikanalyzer中提供的Analyzer：ik_smart 、 ik_max_word</p>
<p>内建的和集成的analyzer可以直接使用。如果它们不能满足我们的需要，则我们可自己组合字符过滤器、分词器、词项过滤器来定义自定义的analyzer</p>
<p>自定义 Analyzer</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">PUT demo_index3&#123;</span><br><span class="line">    &quot;settings&quot;: &#123;</span><br><span class="line">        &quot;analysis&quot;: &#123;</span><br><span class="line">            &quot;analyzer&quot;: &#123;</span><br><span class="line">                &quot;my_ik_analyzer&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">                    &quot;tokenizer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">                    &quot;char_filter&quot;: [</span><br><span class="line">                        &quot;html_strip&quot;</span><br><span class="line">                    ],</span><br><span class="line">                    &quot;filter&quot;: [</span><br><span class="line">                        &quot;synonym&quot;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;filter&quot;: &#123;</span><br><span class="line">                &quot;synonym&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;synonym&quot;,</span><br><span class="line">                    &quot;synonyms_path&quot;: &quot;analysis&#x2F;synonym.txt&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为字段指定分词器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT demo_index4&#x2F;_mapping&#x2F;user</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;my_ik_analyzer&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果该字段的查询需要使用不同的analyzer</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT demo_index4&#x2F;_mapping&#x2F;user</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;my_ik_analyzer&quot;,</span><br><span class="line">        &quot;search_analyzer&quot;: &quot;other_analyzer&quot; </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>索引定义default分词器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;demo_index4</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;default&quot;: &#123;</span><br><span class="line">          &quot;tokenizer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">          &quot;filter&quot;: [</span><br><span class="line">            &quot;synonym&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;synonym&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;synonym&quot;,</span><br><span class="line">          &quot;synonyms_path&quot;: &quot;analysis&#x2F;synonym.txt&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;user&quot;: &#123;</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>** Analyzer的使用顺序 **</p>
<p>可以为每个查询、每个字段、每个索引指定分词器。</p>
<p>在索引阶段ES将按如下顺序来选用分词：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">首先选用字段mapping定义中指定的analyzer</span><br><span class="line">字段定义中没有指定analyzer，则选用 index settings中定义的名字为default 的analyzer。</span><br><span class="line">如index setting中没有定义default分词器，则使用 standard analyzer.</span><br><span class="line">&#96;&#96;</span><br><span class="line">查询阶段ES将按如下顺序来选用分词：</span><br></pre></td></tr></table></figure>
<p>The analyzer defined in a full-text query.<br>The search_analyzer defined in the field mapping.<br>The analyzer defined in the field mapping.<br>An analyzer named default_search in the index settings.<br>An analyzer named default in the index settings.<br>The standard analyzer.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 中文分词器IK</span><br><span class="line"></span><br><span class="line">下载es的IK插件，解压重命名为ik，放到&#x2F;usr&#x2F;local&#x2F;elasticsearch&#x2F;plugins目录中，重启elasticsearch即可。</span><br><span class="line"></span><br><span class="line">测试上面的例子得到：</span><br></pre></td></tr></table></figure>
<p>{<br>    “tokens”: [<br>        {<br>            “token”: “中国”,<br>            “start_offset”: 0,<br>            “end_offset”: 2,<br>            “type”: “CN_WORD”,<br>            “position”: 0<br>        },<br>        {<br>            “token”: “china”,<br>            “start_offset”: 2,<br>            “end_offset”: 7,<br>            “type”: “ENGLISH”,<br>            “position”: 1<br>        }<br>    ]<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ik_max_word 和 ik_smart 区别：</span><br></pre></td></tr></table></figure>
<p>IK 5.0 以后，移除名为 ik 的analyzer和tokenizer 只能使用 ik_smart 和 ik_max_word<br>ik_max_word: 会将文本做最细粒度的拆分，比如会将“中华人民共和国国歌”拆分为“中华人民共和国,中华人民,中华,华人,人民共和国,人民,人,民,共和国,共和,和,国国,国歌”，会穷尽各种可能的组合；<br>ik_smart: 会做最粗粒度的拆分，比如会将“中华人民共和国国歌”拆分为“中华人民共和国,国歌”。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 扩展IK分词</span><br><span class="line">扩展配置文件：ik\config\IKAnalyzer.cfg.xml</span><br></pre></td></tr></table></figure>
<properties>
    <comment>IK Analyzer 扩展配置</comment>
    <!--用户可以在这里配置自己的扩展字典 -->
    <entry key="ext_dict"></entry>
     <!--用户可以在这里配置自己的扩展停止词字典-->
    <entry key="ext_stopwords"></entry>
    <!--用户可以在这里配置远程扩展字典 -->
    <!-- <entry key="remote_ext_dict">words_location</entry> -->
    <!--用户可以在这里配置远程扩展停止词字典-->
    <!-- <entry key="remote_ext_stopwords">words_location</entry> -->
</properties>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">修改配置：</span><br></pre></td></tr></table></figure>
<properties>
    <comment>IK Analyzer 扩展配置</comment>
    <!--用户可以在这里配置自己的扩展字典 -->
    <entry key="ext_dict">./custom/new_word.dic</entry>
     <!--用户可以在这里配置自己的扩展停止词字典-->
    <entry key="ext_stopwords"></entry>
    <!--用户可以在这里配置远程扩展字典 -->
    <!-- <entry key="remote_ext_dict">words_location</entry> -->
    <!--用户可以在这里配置远程扩展停止词字典-->
    <!-- <entry key="remote_ext_stopwords">words_location</entry> -->
</properties>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">就可以在对应位置写一些分词。vi .&#x2F;custom&#x2F;new_word.dic 如：</span><br></pre></td></tr></table></figure>
# cat ./custom/new_word.dic
我爱你
中国china
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">例子：</span><br><span class="line"></span><br><span class="line">请求体不变</span><br></pre></td></tr></table></figure>
{
    "analyzer":"ik_smart",
    "text":"中国china"
}
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">结果：</span><br></pre></td></tr></table></figure>
{
    "tokens": [
        {
            "token": "中国china",
            "start_offset": 0,
            "end_offset": 7,
            "type": "CN_WORD",
            "position": 0
        }
    ]
}
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">新增扩展词后让历史数据生效：</span><br><span class="line"></span><br><span class="line">POST &#x2F;索引,,,&#x2F;_update_by_query?conflicts&#x3D;proceed</span><br><span class="line"></span><br><span class="line"># 项目中使用IK扩展分词器</span><br><span class="line">1、把包引入pom.xml</span><br><span class="line">2、在项目的src根目录下建立IKAnalyzer.cfg.xml文件，文件中配置扩展词库和停用词库的路径</span><br></pre></td></tr></table></figure>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
    <comment>IK Analyzer 扩展配置</comment>
    <!--用户可以在这里配置自己的扩展字典 -->
    <entry key="ext_dict"></entry>
     <!--用户可以在这里配置自己的扩展停止词字典-->
    <entry key="ext_stopwords"></entry>
    <!--用户可以在这里配置远程扩展字典 -->
    <!-- <entry key="remote_ext_dict">words_location</entry> -->
    <!--用户可以在这里配置远程扩展停止词字典-->
    <!-- <entry key="remote_ext_stopwords">words_location</entry> -->
</properties>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">在配置文件中，用户可一次配置多个词典文件。文件名使用;号分隔，文件路径为相对 java 包的起始根路径。</span><br><span class="line"></span><br><span class="line">配置文件和字典文件都放在java包的根目录，上述配置文件的字典路径应该去掉开头的”&#x2F;”，否则扩展无法生效。</span><br><span class="line"></span><br><span class="line">3、通过代码扩展</span><br><span class="line">IK 分词器支持使用 API 编程模型扩充您的词典和停止词典。API 如下：</span><br></pre></td></tr></table></figure>
类 org.wltea.analyzer.dic.Dictionary   
说明：  IK 分词器的词典对象。它负责中文词汇的加载，内存管理和匹配检索。
    public static Dictionary initial(Configuration cfg)  //初始化字典实例。字典采用单例模式，只执行一次。参数 1：Configuration cfg，词典路径配置 返回值：Dictionary IK 词典单例 

<p>  public static Dictionary getSingleton() //获取初始化完毕的字典单例 返回值：Dictionary   IK 词典单例<br>  public void addWords(Collection<String> words)  //加载用户扩展的词汇列表到 IK 的主词典中，增加分词器的可识别词语。 参数 1：Collection<String> words  ，  扩展的词汇列表<br>  public void disableWords(Collection<String> words) //屏蔽词典中的词元 参数 1：Collection<String> words，  待删除的词列表 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">示例：</span><br><span class="line">&#96;&#96;&#96;java</span><br><span class="line">Configuration cfg&#x3D;DefaultConfig.getInstance();</span><br><span class="line">System.out.println(cfg.getMainDictionary());</span><br><span class="line">Dictionary.initial(cfg);</span><br><span class="line">Dictionary dic&#x3D;Dictionary.getSingleton();</span><br><span class="line">HashSet&lt;String&gt; set&#x3D;new HashSet&lt;&gt;();</span><br><span class="line">set.add(&quot;中国china&quot;);</span><br><span class="line">dic.addWords(set);</span><br></pre></td></tr></table></figure>

<p>** 通过java看分词 **</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构造一个IKAnalyzer对象，构造器参数为true说明使用智能分词，默认为最细粒度切分</span></span><br><span class="line">IKAnalyzer analyzer=<span class="keyword">new</span> IKAnalyzer(<span class="keyword">true</span>);</span><br><span class="line">TokenStream ts=<span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">	ts=analyzer.tokenStream(<span class="string">"title"</span>, <span class="string">"中国china"</span>);</span><br><span class="line">	CharTermAttribute cta=ts.addAttribute(CharTermAttribute<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	<span class="comment">//IKAnalyzer.tokenStream（fieldName，text）返回TokenStream对象，Token指分词后的词元；</span></span><br><span class="line">	<span class="comment">//TokenStream对象中包含了text的分词结果，fieldName指文档的域名，一片文档包含多个域，如title，abstract，content等等，这里任意指定即可。</span></span><br><span class="line">	<span class="comment">//TokenStream.incrementToken()的功能相当于迭代器，用来遍历每个词元。</span></span><br><span class="line">	<span class="comment">//CharTermAttribute是具体的词元对象，每次调用incrementToken()方法后，该对象所持有的词元会更新。</span></span><br><span class="line">	ts.reset(); </span><br><span class="line">	  <span class="keyword">while</span> (ts.incrementToken()) &#123;</span><br><span class="line">		  System.out.println(<span class="string">"term: "</span> + cta.toString());</span><br><span class="line">	  &#125;</span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">	e.printStackTrace();</span><br><span class="line">&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(ts!=<span class="keyword">null</span>)</span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">			ts.close();</span><br><span class="line">		&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">if</span>(analyzer!=<span class="keyword">null</span>)&#123;</span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">			analyzer.close();</span><br><span class="line">		&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/03/11/Elasticsearch%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/11/Elasticsearch%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C/" itemprop="url">Elasticsearch文档操作</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-11T00:00:00+08:00">
                2019-03-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="新建文档"><a href="#新建文档" class="headerlink" title="新建文档"></a>新建文档</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PUT my_demo&#x2F;_doc&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;id&quot;: 1,</span><br><span class="line">    &quot;user&quot; : &quot;hu&quot;,</span><br><span class="line">    &quot;post_date&quot; : &quot;2021-12-15T15:22:32&quot;,</span><br><span class="line">    &quot;message&quot; : &quot;dsgasdgsdg&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#自动生成索引</span><br><span class="line">PUT  my_demo&#x2F;_doc&#x2F;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;id&quot;: 1,</span><br><span class="line">    &quot;user&quot; : &quot;hu&quot;,</span><br><span class="line">    &quot;post_date&quot; : &quot;2021-12-15T15:22:32&quot;,</span><br><span class="line">    &quot;message&quot; : &quot;dsgasdgsdg&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<p>创建一个索引：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">PUT my_demo</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">        &quot;index&quot; : &#123;</span><br><span class="line">            &quot;number_of_shards&quot; : 3, </span><br><span class="line">            &quot;number_of_replicas&quot; : 2 </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">   &quot;mappings&quot; : &#123;</span><br><span class="line">        &quot;_doc&quot; : &#123;</span><br><span class="line">            &quot;properties&quot; : &#123;</span><br><span class="line">                &quot;user&quot; : &#123; &quot;type&quot; : &quot;text&quot; &#125;,</span><br><span class="line">                &quot;post_date&quot; : &#123; &quot;type&quot; : &quot;text&quot; &#125;,</span><br><span class="line">                &quot;message&quot; : &#123; &quot;type&quot; : &quot;text&quot; &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>建立文档：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT  &#x2F;my_demo&#x2F;_doc&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;id&quot;: 1,</span><br><span class="line">    &quot;user&quot; : &quot;hu&quot;,</span><br><span class="line">    &quot;post_date&quot; : &quot;2021-12-15T15:22:32&quot;,</span><br><span class="line">    &quot;message&quot; : &quot;dsgasdgsdg&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回值说明</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;my_demo&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;_doc&quot;,  #所属mapping type</span><br><span class="line">  &quot;_id&quot; : &quot;1&quot;, #文档id</span><br><span class="line">  &quot;_version&quot; : 1,</span><br><span class="line">  &quot;result&quot; : &quot;created&quot;,</span><br><span class="line">  &quot;_shards&quot; : &#123; #分片写入情况</span><br><span class="line">    &quot;total&quot; : 3,#所在分片有三个副本</span><br><span class="line">    &quot;successful&quot; : 1, #一个副本上成功写入</span><br><span class="line">    &quot;failed&quot; : 0 #失败副本数</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_seq_no&quot; : 0, #第几次操作该文档</span><br><span class="line">  &quot;_primary_term&quot; : 1 #词项数</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="获取单个文档"><a href="#获取单个文档" class="headerlink" title="获取单个文档"></a>获取单个文档</h2><p>HEAD my_demo/_doc/1</p>
<p>GET my_demo/_doc/1</p>
<p>不获取文档的source： GET my_demo/_doc/1?_source=false</p>
<p> 获取文档的source：GET twitter/_doc/1/_source</p>
<h2 id="获取多个文档-mget"><a href="#获取多个文档-mget" class="headerlink" title="获取多个文档 _mget"></a>获取多个文档 _mget</h2><p>多种方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_mget</span><br><span class="line">&#123;</span><br><span class="line">    &quot;docs&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_index&quot; : &quot;my_demo&quot;,</span><br><span class="line">            &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">            &quot;_id&quot; : &quot;1&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_index&quot; : &quot;my_demo1&quot;,</span><br><span class="line">            &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">            &quot;_id&quot; : &quot;2&quot;</span><br><span class="line">            &quot;stored_fields&quot; : [&quot;field3&quot;, &quot;field4&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET &#x2F;my_demo&#x2F;_mget</span><br><span class="line">&#123;</span><br><span class="line">    &quot;docs&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">            &quot;_id&quot; : &quot;1&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">            &quot;_id&quot; : &quot;2&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET &#x2F;my_demo&#x2F;_doc&#x2F;_mget</span><br><span class="line">&#123;</span><br><span class="line">    &quot;docs&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_id&quot; : &quot;1&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_id&quot; : &quot;2&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET &#x2F;my_demo&#x2F;_doc&#x2F;_mget</span><br><span class="line">&#123;</span><br><span class="line">    &quot;ids&quot; : [&quot;1&quot;, &quot;2&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h2><p>指定文档id进行删除 DELETE my_demo/_doc/1</p>
<p>用版本来控制删除 DELETE my_demo/_doc/1?version=1</p>
<p>查询删除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST my_demo&#x2F;_delete_by_query</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; </span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;message&quot;: &quot;4654515&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当有文档有版本冲突时，不放弃删除操作（记录冲突的文档，继续删除其他复合查询的文档）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST my_demo&#x2F;_doc&#x2F;_delete_by_query?conflicts&#x3D;proceed</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">通过task api 来查看 查询删除任务</span><br><span class="line">GET _tasks?detailed&#x3D;true&amp;actions&#x3D;*&#x2F;delete&#x2F;byquery</span><br><span class="line">查询具体任务的状态GET &#x2F;_tasks&#x2F;taskId:1</span><br><span class="line">取消任务 POST _tasks&#x2F;task_id:1&#x2F;_cancel</span><br></pre></td></tr></table></figure>

<h2 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h2><p>指定文档id进行修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT my_demo&#x2F;_doc&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;id&quot;: 1,</span><br><span class="line">    &quot;user&quot; : &quot;hu&quot;,</span><br><span class="line">    &quot;post_date&quot; : &quot;fsadfs&quot;,</span><br><span class="line">    &quot;message&quot; : &quot;sadgsd&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>乐观锁并发更新控制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT my_demo&#x2F;_doc&#x2F;1?version&#x3D;1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;id&quot;: 1,</span><br><span class="line">    &quot;user&quot; : &quot;yun&quot;,</span><br><span class="line">    &quot;post_date&quot; : &quot;adfasdfa&quot;,</span><br><span class="line">    &quot;message&quot; : &quot;ewetgege&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="通过脚本来更新文档"><a href="#通过脚本来更新文档" class="headerlink" title="通过脚本来更新文档"></a>通过脚本来更新文档</h3><p>对文档的counter + 1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST my_demo&#x2F;_doc&#x2F;1&#x2F;_update</span><br><span class="line">&#123;</span><br><span class="line">    &quot;script&quot; : &#123;</span><br><span class="line">        &quot;source&quot;: &quot;ctx._source.counter +&#x3D; params.count&quot;,</span><br><span class="line">        &quot;lang&quot;: &quot;painless&quot;,</span><br><span class="line">        &quot;params&quot; : &#123;</span><br><span class="line">            &quot;count&quot; : 1</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>往数组中加入元素</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST my_demo&#x2F;_doc&#x2F;1&#x2F;_update</span><br><span class="line">&#123;</span><br><span class="line">    &quot;script&quot; : &#123;</span><br><span class="line">        &quot;source&quot;: &quot;ctx._source.tags.add(params.tag)&quot;,</span><br><span class="line">        &quot;lang&quot;: &quot;painless&quot;,</span><br><span class="line">        &quot;params&quot; : &#123;</span><br><span class="line">            &quot;tag&quot; : &quot;blue&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>painless是es内置的一种脚本语言，ctx执行上下文对象（通过它还可访问_index, _type, _id, _version, _routing and _now (the current timestamp) ），params是参数集合</p>
<p>脚本更新要求索引的_source 字段是启用的。更新执行流程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a、获取到原文档</span><br><span class="line">b、通过_source字段的原始数据，执行脚本修改。</span><br><span class="line">c、删除原索引文档</span><br><span class="line">d、索引修改后的文档</span><br><span class="line">它只是降低了一些网络往返，并减少了get和索引之间版本冲突的可能性。</span><br></pre></td></tr></table></figure>
<p>其他操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">添加一个字段</span><br><span class="line">POST my_demo&#x2F;_doc&#x2F;1&#x2F;_update</span><br><span class="line">&#123;</span><br><span class="line">    &quot;script&quot; : &quot;ctx._source.new_field &#x3D; &#39;value_of_new_field&#39;&quot;</span><br><span class="line">&#125;</span><br><span class="line">移除一个字段</span><br><span class="line">POST my_demo&#x2F;_doc&#x2F;1&#x2F;_update</span><br><span class="line">&#123;</span><br><span class="line">    &quot;script&quot; : &quot;ctx._source.remove(&#39;new_field&#39;)&quot;</span><br><span class="line">&#125;</span><br><span class="line">判断删除或不做什么</span><br><span class="line">POST my_demo&#x2F;_doc&#x2F;1&#x2F;_update</span><br><span class="line">&#123;</span><br><span class="line">    &quot;script&quot; : &#123;</span><br><span class="line">        &quot;source&quot;: &quot;if (ctx._source.tags.contains(params.tag)) &#123; ctx.op &#x3D; &#39;delete&#39; &#125; else &#123; ctx.op &#x3D; &#39;none&#39; &#125;&quot;,</span><br><span class="line">        &quot;lang&quot;: &quot;painless&quot;,</span><br><span class="line">        &quot;params&quot; : &#123;</span><br><span class="line">            &quot;tag&quot; : &quot;green&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">合并传人的文档字段进行更新</span><br><span class="line">POST my_demo&#x2F;_doc&#x2F;1&#x2F;_update</span><br><span class="line">&#123;</span><br><span class="line">    &quot;doc&quot; : &#123;</span><br><span class="line">        &quot;name&quot; : &quot;new_name&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">设置不做noop检测</span><br><span class="line"></span><br><span class="line">复制代码</span><br><span class="line">POST my_demo&#x2F;_doc&#x2F;1&#x2F;_update</span><br><span class="line">&#123;</span><br><span class="line">    &quot;doc&quot; : &#123;</span><br><span class="line">        &quot;name&quot; : &quot;new_name&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;detect_noop&quot;: false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">noop检测：已经执行过的脚本不再执行</span><br><span class="line"></span><br><span class="line">upsert 操作：如果要更新的文档存在，则执行脚本进行更新，如不存在，则把 upsert中的内容作为一个新文档写入。</span><br><span class="line"></span><br><span class="line">POST my_demo&#x2F;_doc&#x2F;1&#x2F;_update</span><br><span class="line">&#123;</span><br><span class="line">    &quot;script&quot; : &#123;</span><br><span class="line">        &quot;source&quot;: &quot;ctx._source.counter +&#x3D; params.count&quot;,</span><br><span class="line">        &quot;lang&quot;: &quot;painless&quot;,</span><br><span class="line">        &quot;params&quot; : &#123;</span><br><span class="line">            &quot;count&quot; : 4</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;upsert&quot; : &#123;</span><br><span class="line">        &quot;counter&quot; : 1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="通过条件查询来更新文档"><a href="#通过条件查询来更新文档" class="headerlink" title="通过条件查询来更新文档"></a>通过条件查询来更新文档</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST my_demo&#x2F;_update_by_query</span><br><span class="line">&#123;</span><br><span class="line">  &quot;script&quot;: &#123;</span><br><span class="line">    &quot;source&quot;: &quot;ctx._source.likes++&quot;,</span><br><span class="line">    &quot;lang&quot;: &quot;painless&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;user&quot;: &quot;hu&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="批量操作"><a href="#批量操作" class="headerlink" title="批量操作"></a>批量操作</h2><p>批量操作API /_bulk 可以在一次调用中执行多个索引、删除操作。这可以大大提高索引数据的速度。批量操作内容体需按如下以新行分割的json结构格式给出：</p>
<p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">action_and_meta_data\n</span><br><span class="line">optional_source\n</span><br><span class="line">action_and_meta_data\n</span><br><span class="line">optional_source\n</span><br><span class="line">....</span><br><span class="line">action_and_meta_data\n</span><br><span class="line">optional_source\n</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<p>action_and_meta_data: action可以是 index, create, delete and update ，meta_data 指: _index ,_type,_id 请求端点可以是: /_bulk, /{index}/_bulk, {index}/{type}/_bulk</p>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST _bulk</span><br><span class="line">&#123; &quot;index&quot; : &#123; &quot;_index&quot; : &quot;test&quot;, &quot;_type&quot; : &quot;_doc&quot;, &quot;_id&quot; : &quot;1&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;field1&quot; : &quot;value1&quot; &#125;</span><br><span class="line">&#123; &quot;delete&quot; : &#123; &quot;_index&quot; : &quot;test&quot;, &quot;_type&quot; : &quot;_doc&quot;, &quot;_id&quot; : &quot;2&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;create&quot; : &#123; &quot;_index&quot; : &quot;test&quot;, &quot;_type&quot; : &quot;_doc&quot;, &quot;_id&quot; : &quot;3&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;field1&quot; : &quot;value3&quot; &#125;</span><br><span class="line">&#123; &quot;update&quot; : &#123;&quot;_id&quot; : &quot;1&quot;, &quot;_type&quot; : &quot;_doc&quot;, &quot;_index&quot; : &quot;test&quot;&#125; &#125;</span><br><span class="line">&#123; &quot;doc&quot; : &#123;&quot;field2&quot; : &quot;value2&quot;&#125; &#125;</span><br></pre></td></tr></table></figure>

<p>curl + json 文件 批量索引多个文档</p>
<p>类似于导入文件数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H &quot;Content-Type: application&#x2F;json&quot; -XPOST &quot;localhost:9200&#x2F;my_demo&#x2F;_doc&#x2F;_bulk?pretty&amp;refresh&quot; --data-binary &quot;@my_demo.json&quot;</span><br></pre></td></tr></table></figure>
<p>数据格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;1&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;字段1&quot;:值1,&quot;字段2&quot;:值2...&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;6&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;字段1&quot;:值1,&quot;字段2&quot;:值2...&#125;</span><br><span class="line">···</span><br></pre></td></tr></table></figure>

<h2 id="reindex-重索引"><a href="#reindex-重索引" class="headerlink" title="reindex 重索引"></a>reindex 重索引</h2><p>Reindex API /_reindex 让我们可以将一个索引中的数据重索引到另一个索引中（拷贝），要求源索引的_source 是开启的。目标索引的setting 、mapping 信息与源索引无关。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  &quot;source&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;my_demo&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;dest&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;my_demo_1&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数据有重复的处理：</p>
<p>1、如果没有指定version_type 或指定为 internal，则会是采用目标索引中的版本，重索引过程中，执行的就是新增、更新操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  &quot;source&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;my_demo&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;dest&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;my_demo_1&quot;,</span><br><span class="line">    &quot;version_type&quot;: &quot;internal&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、如果想使用源索引中的版本来进行版本控制更新，则设置 version_type 为extenal。重索引操作将写入不存在的，更新旧版本的数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  &quot;source&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;my_demo&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;dest&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;my_demo_1&quot;,</span><br><span class="line">    &quot;version_type&quot;: &quot;external&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、如果只想从源索引中复制目标索引中不存在的文档数据，可以指定 op_type 为 create 。此时存在的文档将触发 版本冲突（会导致放弃操作），可设置“conflicts”: “proceed“，跳过继续。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  &quot;conflicts&quot;: &quot;proceed&quot;,</span><br><span class="line">  &quot;source&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;my_demo&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;dest&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;my_demo_1&quot;,</span><br><span class="line">    &quot;op_type&quot;: &quot;create&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4、可以只索引源索引的一部分数据，通过 type 或 查询来指定你需要的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  &quot;source&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;my_demo&quot;,</span><br><span class="line">    &quot;type&quot;: &quot;_doc&quot;,</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">      &quot;term&quot;: &#123;</span><br><span class="line">        &quot;user&quot;: &quot;hu&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;dest&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;my_demo_1&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以从多个源获取数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  &quot;source&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: [&quot;my_demo&quot;, &quot;my_demo_1&quot;],</span><br><span class="line">    &quot;type&quot;: [&quot;_doc&quot;, &quot;post&quot;]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;dest&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;my_demo_2&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以限定文档数量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 10000,</span><br><span class="line">  &quot;source&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;my_demo&quot;,</span><br><span class="line">    &quot;sort&quot;: &#123; &quot;date&quot;: &quot;desc&quot; &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;dest&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;my_demo_1&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以选择复制源文档的哪些字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  &quot;source&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;my_demo&quot;,</span><br><span class="line">    &quot;_source&quot;: [&quot;user&quot;, &quot;_doc&quot;]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;dest&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;my_demo_1&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以用script来改变文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  &quot;source&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;my_demo&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;dest&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;my_demo_1&quot;,</span><br><span class="line">    &quot;version_type&quot;: &quot;external&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;script&quot;: &#123;</span><br><span class="line">    &quot;source&quot;: &quot;if (ctx._source.foo &#x3D;&#x3D; &#39;bar&#39;) &#123;ctx._version++; ctx._source.remove(&#39;foo&#39;)&#125;&quot;,</span><br><span class="line">    &quot;lang&quot;: &quot;painless&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以指定路由值把文档放到哪个分片上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  &quot;source&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;source&quot;,</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">      &quot;match&quot;: &#123;</span><br><span class="line">        &quot;company&quot;: &quot;cat&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;dest&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;my_demo_1&quot;,</span><br><span class="line">    &quot;routing&quot;: &quot;&#x3D;cat&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从远程源复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  &quot;source&quot;: &#123;</span><br><span class="line">    &quot;remote&quot;: &#123;</span><br><span class="line">      &quot;host&quot;: &quot;http:&#x2F;&#x2F;15151515:9200&quot;,</span><br><span class="line">      &quot;username&quot;: &quot;user&quot;,</span><br><span class="line">      &quot;password&quot;: &quot;pass&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;index&quot;: &quot;my_demo&quot;,</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">      &quot;match&quot;: &#123;</span><br><span class="line">        &quot;test&quot;: &quot;data&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;dest&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;my_demo_1&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过_task 来查询执行状态</p>
<p>GET _tasks?detailed=true&amp;actions=*reindex</p>
<h2 id="refresh"><a href="#refresh" class="headerlink" title="refresh"></a>refresh</h2><p>对于索引、更新、删除操作如果想操作完后立马重刷新可见，可带上refresh参数</p>
<p>PUT /demo/_doc/1?refresh</p>
<p>refresh 可选值说明</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">未给值或&#x3D;true，则立马会重刷新读索引。</span><br><span class="line">&#x3D;false ，相当于没带refresh 参数，遵循内部的定时刷新。</span><br><span class="line">&#x3D;wait_for ，登记等待刷新，当登记的请求数达到index.max_refresh_listeners 参数设定的值时(defaults to 1000)，将触发重刷新。</span><br></pre></td></tr></table></figure>




          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/03/10/Elasticsearch%E7%B4%A2%E5%BC%95%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/10/Elasticsearch%E7%B4%A2%E5%BC%95%E8%AF%A6%E8%A7%A3/" itemprop="url">Elasticsearch索引详解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-10T00:00:00+08:00">
                2019-03-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在ES中创建一个mapping映射类似于在数据库中定义表结构，即表里面有哪些字段、字段是什么类型、字段的默认值，分词器等；也类似于solr里面的模式schema的定义。</p>
<p>获取映射关系</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;mydemo_01&#x2F;_mapping</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mydemo_01&quot; : &#123;</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;user&quot; : &#123;</span><br><span class="line">        &quot;properties&quot; : &#123;</span><br><span class="line">          &quot;age&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;long&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;idcard&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot; : &#123;</span><br><span class="line">              &quot;keyword&quot; : &#123;</span><br><span class="line">                &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot; : 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;name&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot; : &#123;</span><br><span class="line">              &quot;keyword&quot; : &#123;</span><br><span class="line">                &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot; : 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h1><h2 id="1、创建索引"><a href="#1、创建索引" class="headerlink" title="1、创建索引"></a>1、创建索引</h2><p>在ES中创建一个索引类似于在数据库中建立一个数据库(ES6.0之后类似于创建一个表)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT demo_index</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">        &quot;index&quot; : &#123; #可以省略</span><br><span class="line">            &quot;number_of_shards&quot; : 3, </span><br><span class="line">            &quot;number_of_replicas&quot; : 2 </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建索引时加入别名定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT twitter</span><br><span class="line">&#123;</span><br><span class="line">    &quot;aliases&quot; : &#123;</span><br><span class="line">        &quot;alias_1&quot; : &#123;&#125;,</span><br><span class="line">        &quot;alias_2&quot; : &#123;</span><br><span class="line">            &quot;filter&quot; : &#123;</span><br><span class="line">                &quot;term&quot; : &#123;&quot;user&quot; : &quot;hu&quot; &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;routing&quot; : &quot;hu&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2、创建mapping映射"><a href="#2、创建mapping映射" class="headerlink" title="2、创建mapping映射"></a>2、创建mapping映射</h2><p>mapping映射类似于在数据库中定义表结构，即表里面有哪些字段、字段是什么类型、字段的默认值等</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PUT demo_index</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">        &quot;index&quot; : &#123;</span><br><span class="line">            &quot;number_of_shards&quot; : 3, </span><br><span class="line">            &quot;number_of_replicas&quot; : 2 </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">#映射</span><br><span class="line">   &quot;mappings&quot; : &#123;</span><br><span class="line">        &quot;type1&quot; : &#123;</span><br><span class="line">            &quot;properties&quot; : &#123;</span><br><span class="line">                &quot;field1&quot; : &#123; &quot;type&quot; : &quot;text&quot; &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回说明</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;acknowledged&quot; : true, #索引创建成功</span><br><span class="line">  &quot;shards_acknowledged&quot; : true, #所需数量的分片和副本创建成功</span><br><span class="line">  &quot;index&quot; : &quot;demo_index&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3、删除索引"><a href="#3、删除索引" class="headerlink" title="3、删除索引"></a>3、删除索引</h2><p>DELETE /twitter   可以一次删除多个索引（以逗号间隔） 删除所有索引 _all 或 通配符 *</p>
<h2 id="4、判断索引是否存在"><a href="#4、判断索引是否存在" class="headerlink" title="4、判断索引是否存在"></a>4、判断索引是否存在</h2><p>HEAD twitter  #HTTP status code 表示结果 404 不存在 ， 200 存在</p>
<h2 id="5、修改索引的settings信息"><a href="#5、修改索引的settings信息" class="headerlink" title="5、修改索引的settings信息"></a>5、修改索引的settings信息</h2><p>索引的设置信息分为静态信息和动态信息两部分。静态信息不可更改，如索引的分片数。动态信息可以修改。</p>
<p>/_settings 更新所有索引的。</p>
<p>{index}/_settings 更新一个或多个索引的settings。</p>
<h2 id="6、修改备份数"><a href="#6、修改备份数" class="headerlink" title="6、修改备份数"></a>6、修改备份数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;demo_index&#x2F;_settings</span><br><span class="line">&#123;</span><br><span class="line">    &quot;index&quot; : &#123;</span><br><span class="line">        &quot;number_of_replicas&quot; : 2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7、设置其他"><a href="#7、设置其他" class="headerlink" title="7、设置其他"></a>7、设置其他</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;demo_index&#x2F;_settings</span><br><span class="line">&#123;</span><br><span class="line">    &quot;index&quot; : &#123;</span><br><span class="line">        &quot;refresh_interval&quot; : null  #设置默认值</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">索引的读写</span><br><span class="line">index.blocks.read_only：设为true,则索引以及索引的元数据只可读</span><br><span class="line">index.blocks.read_only_allow_delete：设为true，只读时允许删除。</span><br><span class="line">index.blocks.read：设为true，则不可读。</span><br><span class="line">index.blocks.write：设为true，则不可写。</span><br><span class="line">index.blocks.metadata：设为true，则索引元数据不可读写。</span><br></pre></td></tr></table></figure>

<h2 id="8、索引模板"><a href="#8、索引模板" class="headerlink" title="8、索引模板"></a>8、索引模板</h2><p>模板中定义好settings、mapping、以及一个模式定义来匹配创建的索引。</p>
<p>注意：模板只在索引创建时被参考，修改模板不会影响已创建的索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#新增&#x2F;修改名为tempae_1的模板，匹配名称为te* 或 demo*的索引创建</span><br><span class="line">PUT _template&#x2F;template_1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;index_patterns&quot;: [&quot;te*&quot;, &quot;demo*&quot;],</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 1</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;type1&quot;: &#123;</span><br><span class="line">      &quot;_source&quot;: &#123;</span><br><span class="line">        &quot;enabled&quot;: false</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;host_name&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;created_at&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;date&quot;,</span><br><span class="line">          &quot;format&quot;: &quot;EEE MMM dd HH:mm:ss Z YYYY&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看索引模板</p>
<p>GET /_template/template_1</p>
<p>GET /_template/temp*</p>
<p>GET /_template/template_1,template_2</p>
<p>GET /_template</p>
<p>删除模板</p>
<p>DELETE /_template/template_1</p>
<h2 id="9、-打开-关闭索引"><a href="#9、-打开-关闭索引" class="headerlink" title="9、 打开/关闭索引"></a>9、 打开/关闭索引</h2><p>POST /demo_index/_close</p>
<p>POST /demo_index/_open</p>
<h2 id="10、Shrink-Index-收缩索引"><a href="#10、Shrink-Index-收缩索引" class="headerlink" title="10、Shrink Index 收缩索引"></a>10、Shrink Index 收缩索引</h2><p>索引的分片数是不可更改的，如要减少分片数可以通过收缩方式收缩为一个新的索引。新索引的分片数必须是原分片数的因子值，如原分片数是8，则新索引的分片数可以为4、2、1 。</p>
<p>收缩的流程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">先把所有主分片都转移到一台主机上；</span><br><span class="line">在这台主机上创建一个新索引，分片数较小，其他设置和原索引一致；</span><br><span class="line">把原索引的所有分片，复制（或硬链接）到新索引的目录下；</span><br><span class="line">对新索引进行打开操作恢复分片数据；</span><br><span class="line">(可选)重新把新索引的分片均衡到其他节点上。</span><br></pre></td></tr></table></figure>
<p>将原索引设置为只读；</p>
<p>将原索引各分片的一个副本重分配到同一个节点上，并且要是健康绿色状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;my_source_index&#x2F;_settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &lt;!-- 指定进行收缩的节点的名称 --&gt;</span><br><span class="line">    &quot;index.routing.allocation.require._name&quot;: &quot;shrink_node_name&quot;, </span><br><span class="line">    &lt;!-- 阻止写，只读 --&gt;</span><br><span class="line">     &quot;index.blocks.write&quot;: true </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进行收缩：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST my_source_index&#x2F;_shrink&#x2F;my_target_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;index.number_of_replicas&quot;: 1,</span><br><span class="line">    &quot;index.number_of_shards&quot;: 1, </span><br><span class="line">    &quot;index.codec&quot;: &quot;best_compression&quot; </span><br><span class="line">  &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>监控收缩过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET _cat&#x2F;recovery?v</span><br><span class="line">GET _cluster&#x2F;health</span><br></pre></td></tr></table></figure>

<h2 id="11、Split-Index-拆分索引"><a href="#11、Split-Index-拆分索引" class="headerlink" title="11、Split Index 拆分索引"></a>11、Split Index 拆分索引</h2><p>当索引的分片容量过大时，可以通过拆分操作将索引拆分为一个倍数分片数的新索引。能拆分为几倍由创建索引时指定的index.number_of_routing_shards 路由分片数决定。这个路由分片数决定了根据一致性hash路由文档到分片的散列空间。</p>
<p>如index.number_of_routing_shards = 30 ，指定的分片数是5，则可按如下倍数方式进行拆分：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">5 → 10 → 30 (split by 2, then by 3)</span><br><span class="line">5 → 15 → 30 (split by 3, then by 2)</span><br><span class="line">5 → 30 (split by 6)</span><br></pre></td></tr></table></figure>
<p>压缩索引相反</p>
<p>但是只有在创建时指定了index.number_of_routing_shards 的索引才可以进行拆分，ES7开始将不再有这个限制。</p>
<p>和solr的区别是，solr是对一个分片进行拆分，es中是整个索引进行拆分。</p>
<p>拆分步骤：</p>
<p>准备一个索引来做拆分：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT my_source_index</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot;: &#123;</span><br><span class="line">        &quot;index.number_of_shards&quot; : 1,</span><br><span class="line">        &lt;!-- 创建时需要指定路由分片数 --&gt;</span><br><span class="line">        &quot;index.number_of_routing_shards&quot; : 2 </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先设置索引只读：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;my_source_index&#x2F;_settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;index.blocks.write&quot;: true </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>做拆分：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST my_source_index&#x2F;_split&#x2F;my_target_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &lt;!--新索引的分片数需符合拆分规则--&gt;</span><br><span class="line">    &quot;index.number_of_shards&quot;: 2</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>监控拆分过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET _cat&#x2F;recovery?v</span><br><span class="line">GET _cluster&#x2F;health</span><br></pre></td></tr></table></figure>
<h2 id="12、Rollover-Index-别名滚动指向新创建的索引"><a href="#12、Rollover-Index-别名滚动指向新创建的索引" class="headerlink" title="12、Rollover Index 别名滚动指向新创建的索引"></a>12、Rollover Index 别名滚动指向新创建的索引</h2><p>ES的rollover index API 让我们可以根据满足指定的条件（时间、文档数量、索引大小）创建新的索引，并把别名滚动指向新的索引。</p>
<p>创建一个名字为logs-0000001 、别名为logs_write 的索引：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;logs-000001 </span><br><span class="line">&#123;</span><br><span class="line">  &quot;aliases&quot;: &#123;</span><br><span class="line">    &quot;logs_write&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加1000个文档到索引logs-000001，然后设置别名滚动的条件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;logs_write&#x2F;_rollover </span><br><span class="line">&#123;</span><br><span class="line">  &quot;conditions&quot;: &#123;</span><br><span class="line">    &quot;max_age&quot;:   &quot;7d&quot;,</span><br><span class="line">    &quot;max_docs&quot;:  1000,</span><br><span class="line">    &quot;max_size&quot;:  &quot;5gb&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>说明：如果别名logs_write指向的索引是7天前（含）创建的或索引的文档数&gt;=1000或索引的大小&gt;= 5gb，则会创建一个新索引 logs-000002，并把别名logs_writer指向新创建的logs-000002索引</p>
<p>** Rollover Index 新建索引的命名规则：**</p>
<p>如果索引的名称是-数字结尾，如logs-000001，则新建索引的名称也会是这个模式，数值增1。</p>
<p>如果索引的名称不是-数值结尾，则在请求rollover api时需指定新索引的名称</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;my_alias&#x2F;_rollover&#x2F;my_new_index_name</span><br><span class="line">&#123;</span><br><span class="line">  &quot;conditions&quot;: &#123;</span><br><span class="line">    &quot;max_age&quot;:   &quot;7d&quot;,</span><br><span class="line">    &quot;max_docs&quot;:  1000,</span><br><span class="line">    &quot;max_size&quot;: &quot;5gb&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>** 在名称中使用Date math（时间表达式）**</p>
<p>如果你希望生成的索引名称中带有日期，如logstash-2016.02.03-1 ，则可以在创建索引时采用时间表达式来命名：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># PUT &#x2F;&lt;logs-&#123;now&#x2F;d&#125;-1&gt; with URI encoding:</span><br><span class="line">PUT &#x2F;%3Clogs-%7Bnow%2Fd%7D-1%3E </span><br><span class="line">&#123;</span><br><span class="line">  &quot;aliases&quot;: &#123;</span><br><span class="line">    &quot;logs_write&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT logs_write&#x2F;_doc&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;a dummy log&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST logs_write&#x2F;_refresh</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;logs_write&#x2F;_rollover </span><br><span class="line">&#123;</span><br><span class="line">  &quot;conditions&quot;: &#123;</span><br><span class="line">    &quot;max_docs&quot;:   &quot;1&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>** Rollover时可对新的索引作定义 **</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;logs-000001</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aliases&quot;: &#123;</span><br><span class="line">    &quot;logs_write&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST &#x2F;logs_write&#x2F;_rollover</span><br><span class="line">&#123;</span><br><span class="line">  &quot;conditions&quot; : &#123;</span><br><span class="line">    &quot;max_age&quot;: &quot;7d&quot;,</span><br><span class="line">    &quot;max_docs&quot;: 1000,</span><br><span class="line">    &quot;max_size&quot;: &quot;5gb&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;index.number_of_shards&quot;: 2</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Dry run  实际操作前先测试是否达到条件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;logs_write&#x2F;_rollover?dry_run</span><br><span class="line">&#123;</span><br><span class="line">  &quot;conditions&quot; : &#123;</span><br><span class="line">    &quot;max_age&quot;: &quot;7d&quot;,</span><br><span class="line">    &quot;max_docs&quot;: 1000,</span><br><span class="line">    &quot;max_size&quot;: &quot;5gb&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<p>rollover是你请求它才会进行操作，并不是自动在后台进行的。你可以周期性地去请求它。</p>
<h1 id="索引监控"><a href="#索引监控" class="headerlink" title="索引监控"></a>索引监控</h1><h2 id="查看索引状态信息"><a href="#查看索引状态信息" class="headerlink" title="查看索引状态信息"></a>查看索引状态信息</h2><p>查看所有的索引状态：</p>
<p>GET /_stats</p>
<p>查看指定索引的状态信息：</p>
<p>GET /index1,index2/_stats</p>
<h2 id="查看索引段信息"><a href="#查看索引段信息" class="headerlink" title="查看索引段信息"></a>查看索引段信息</h2><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-segments.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-segments.html</a></p>
<p> GET /test/_segments</p>
<p>GET /index1,index2/_segments</p>
<p>GET /_segments</p>
<h2 id="查看索引恢复信息"><a href="#查看索引恢复信息" class="headerlink" title="查看索引恢复信息"></a>查看索引恢复信息</h2><p>GET index1,index2/_recovery?human</p>
<p>GET /_recovery?human</p>
<h2 id="查看索引分片的存储信息"><a href="#查看索引分片的存储信息" class="headerlink" title="查看索引分片的存储信息"></a>查看索引分片的存储信息</h2><p>GET /test/_shard_stores</p>
<p>GET /test1,test2/_shard_stores</p>
<p>GET /_shard_stores</p>
<h2 id="索引状态管理"><a href="#索引状态管理" class="headerlink" title="索引状态管理"></a>索引状态管理</h2><p>** Clear Cache 清理缓存** </p>
<p>POST /demo_index/_cache/clear</p>
<p>默认会清理所有缓存，可指定清理query, fielddata or request 缓存</p>
<p>POST /_cache/clear</p>
<p>**  Refresh，重新打开读取索引** </p>
<p>POST /demo_index/_refresh</p>
<p>POST /_refresh</p>
<p>** Flush，将缓存在内存中的索引数据刷新到持久存储中 ** </p>
<p>POST demo_index/_flush</p>
<p>**  Force merge 强制段合并 ** </p>
<p>POST /demo_index/_forcemerge?only_expunge_deletes=false&amp;max_num_segments=100&amp;flush=true<br>可选参数说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">max_num_segments 合并为几个段，默认1</span><br><span class="line">only_expunge_deletes 是否只合并含有删除文档的段，默认false</span><br><span class="line">flush 合并后是否刷新，默认true</span><br><span class="line"></span><br><span class="line">POST &#x2F;demo_index,elasticsearch&#x2F;_forcemerge</span><br><span class="line">POST &#x2F;_forcemerge</span><br></pre></td></tr></table></figure>
<h1 id="映射Mapping"><a href="#映射Mapping" class="headerlink" title="映射Mapping"></a>映射Mapping</h1><p>静态映射</p>
<p>在ElasticSearch中也可以事先定义好映射，包含文档的各个字段及其类型等，这种方式称之为静态映射。</p>
<p>动态映射</p>
<p>ElasticSearch中不需要事先定义映射（Mapping），文档写入ElasticSearch时，会根据文档字段自动识别类型，这种机制称之为动态映射。</p>
<p>索引创建mapping</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PUT demo_index</span><br><span class="line">&#123;</span><br><span class="line">&lt;!--映射定义 --&gt;</span><br><span class="line">&quot;mappings&quot; : &#123;</span><br><span class="line">&lt;!--名为type1的映射类别 mapping type--&gt;</span><br><span class="line">        &quot;type1&quot; : &#123;</span><br><span class="line">        &lt;!-- 字段定义 --&gt;</span><br><span class="line">            &quot;properties&quot; : &#123;</span><br><span class="line">            &lt;!-- 名为field1的字段，它的field datatype 为 text --&gt;</span><br><span class="line">                &quot;field1&quot; : &#123; &quot;type&quot; : &quot;text&quot; &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="映射类别-Mapping-type"><a href="#映射类别-Mapping-type" class="headerlink" title="映射类别 Mapping type"></a>映射类别 Mapping type</h2><p>从6.0.0开始限定仅包含一个映射类别定义（ “index.mapping.single_type”: true ），兼容5.x中的多映射类别。从7.0开始将移除映射类别。为了与未来的规划匹配，请现在将这个唯一的映射类别名定义为“_doc”,因为索引的请求地址将规范为：PUT {index}/_doc/{id} and POST {index}/_doc</p>
<h2 id="字段类型-datatypes"><a href="#字段类型-datatypes" class="headerlink" title="字段类型 datatypes"></a>字段类型 datatypes</h2><p>Core Datatypes     核心类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">string</span><br><span class="line">    text and keyword </span><br><span class="line">Numeric datatypes</span><br><span class="line">    long, integer, short, byte, double, float, half_float, scaled_float </span><br><span class="line">Date datatype</span><br><span class="line">    date </span><br><span class="line">Boolean datatype</span><br><span class="line">    boolean </span><br><span class="line">Binary datatype</span><br><span class="line">    binary </span><br><span class="line">Range datatypes     范围</span><br><span class="line">    integer_range, float_range, long_range, double_range, date_range</span><br></pre></td></tr></table></figure>
<p>Complex datatypes 复合类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Array datatype</span><br><span class="line">    数组就是多值，不需要专门的类型</span><br><span class="line">Object datatype</span><br><span class="line">    object ：表示值为一个JSON 对象 </span><br><span class="line">Nested datatype</span><br><span class="line">    nested：for arrays of JSON objects（表示值为JSON对象数组 ）</span><br></pre></td></tr></table></figure>
<p>Geo datatypes  地理数据类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Geo-point datatype</span><br><span class="line">    geo_point： for lat&#x2F;lon points  （经纬坐标点）</span><br><span class="line">Geo-Shape datatype</span><br><span class="line">    geo_shape： for complex shapes like polygons （形状表示）</span><br></pre></td></tr></table></figure>
<p>Specialised datatypes 特别的类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">IP datatype</span><br><span class="line">    ip： for IPv4 and IPv6 addresses </span><br><span class="line">Completion datatype</span><br><span class="line">    completion： to provide auto-complete suggestions </span><br><span class="line">Token count datatype</span><br><span class="line">    token_count： to count the number of tokens in a string </span><br><span class="line">mapper-murmur3</span><br><span class="line">    murmur3： to compute hashes of values at index-time and store them in the index </span><br><span class="line">Percolator type</span><br><span class="line">    Accepts queries from the query-dsl </span><br><span class="line">join datatype</span><br><span class="line">    Defines parent&#x2F;child relation for documents within the same index</span><br></pre></td></tr></table></figure>
<h2 id="字段定义属性介绍"><a href="#字段定义属性介绍" class="headerlink" title="字段定义属性介绍"></a>字段定义属性介绍</h2><p>字段的type (Datatype)定义了如何索引存储字段值，还有一些属性可以让我们根据需要来覆盖默认的值或进行特别定义。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">analyzer   指定分词器</span><br><span class="line">normalizer   指定标准化器</span><br><span class="line">boost        指定权重值</span><br><span class="line">coerce      强制类型转换</span><br><span class="line">copy_to    值复制给另一字段</span><br><span class="line">doc_values  是否存储docValues</span><br><span class="line">dynamic</span><br><span class="line">enabled    字段是否可用</span><br><span class="line">fielddata</span><br><span class="line">eager_global_ordinals</span><br><span class="line">format    指定时间值的格式</span><br><span class="line">ignore_above</span><br><span class="line">ignore_malformed</span><br><span class="line">index_options</span><br><span class="line">index</span><br><span class="line">fields</span><br><span class="line">norms</span><br><span class="line">null_value</span><br><span class="line">position_increment_gap</span><br><span class="line">properties</span><br><span class="line">search_analyzer</span><br><span class="line">similarity</span><br><span class="line">store</span><br><span class="line">term_vector</span><br></pre></td></tr></table></figure>
<p>如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;_doc&quot;: &#123;</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;date&quot;: &#123;</span><br><span class="line">          &quot;type&quot;:   &quot;date&quot;,</span><br><span class="line">           &lt;!--格式化日期 --&gt;</span><br><span class="line">          &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Multi-Field-多重字段"><a href="#Multi-Field-多重字段" class="headerlink" title="Multi Field 多重字段"></a>Multi Field 多重字段</h2><p>当我们需要对一个字段进行多种不同方式的索引时，可以使用fields多重字段定义。如一个字符串字段即需要进行text分词索引，也需要进行keyword 关键字索引来支持排序、聚合；或需要用不同的分词器进行分词索引。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;_doc&quot;: &#123;</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;city&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot;: &#123;</span><br><span class="line">            &quot;raw&quot;: &#123; </span><br><span class="line">              &quot;type&quot;:  &quot;keyword&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>往多重字段里面添加文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index&#x2F;_doc&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;city&quot;: &quot;New York&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_index&#x2F;_doc&#x2F;2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;city&quot;: &quot;York&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取多重字段的值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET my_index&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;city&quot;: &quot;york&quot; </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: &#123;</span><br><span class="line">    &quot;city.raw&quot;: &quot;asc&quot; </span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;Cities&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;city.raw&quot; </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="元字段"><a href="#元字段" class="headerlink" title="元字段"></a>元字段</h2><p>元字段是ES中定义的文档字段，有这几种：_index，_uid，_type，_id。</p>
<h2 id="动态映射"><a href="#动态映射" class="headerlink" title="动态映射"></a>动态映射</h2><p>动态映射：ES中提供的重要特性，让我们可以快速使用ES，而不需要先创建索引、定义映射。 如我们直接向ES提交文档进行索引：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PUT data&#x2F;_doc&#x2F;1 </span><br><span class="line">&#123; &quot;count&quot;: 5 &#125;</span><br></pre></td></tr></table></figure>
<p>ES将自动为我们创建data索引、_doc 映射、类型为 long 的字段 count</p>
<p>索引文档时，当有新字段时， ES将根据我们字段的json的数据类型为我们自动加人字段定义到mapping中。</p>
<p>字段动态映射规则</p>
<p><img src="https://img.huyunshun.com/img1/Elasticsearch/imgsddasdasdfdfvrtyhclip.png" alt=""></p>
<p>Date detection 时间侦测：指我们往ES里面插入数据的时候会去自动检测我们的数据是不是日期格式的，是的话就会给我们自动转为设置的格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">date_detection 默认是开启的，默认的格式dynamic_date_formats为：</span><br><span class="line"></span><br><span class="line">[ &quot;strict_date_optional_time&quot;,&quot;yyyy&#x2F;MM&#x2F;dd HH:mm:ss Z||yyyy&#x2F;MM&#x2F;dd Z&quot;]</span><br><span class="line">PUT my_index&#x2F;_doc&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;create_date&quot;: &quot;2015&#x2F;09&#x2F;02&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET my_index&#x2F;_mapping</span><br><span class="line"></span><br><span class="line"> 自定义时间格式：</span><br><span class="line"></span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;_doc&quot;: &#123;</span><br><span class="line">      &quot;dynamic_date_formats&quot;: [&quot;MM&#x2F;dd&#x2F;yyyy&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">禁用时间侦测：</span><br><span class="line"></span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;_doc&quot;: &#123;</span><br><span class="line">      &quot;date_detection&quot;: false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Numeric detection  数值侦测</p>
<p>开启数值侦测（默认是禁用的）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;_doc&quot;: &#123;</span><br><span class="line">      &quot;numeric_detection&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="索引别名"><a href="#索引别名" class="headerlink" title="索引别名"></a>索引别名</h1><ol>
<li>别名的用途<br>如果希望一次查询可查询多个索引。<br>如果希望通过索引的视图来操作索引，就像数据库库中的视图一样。</li>
</ol>
<p>索引的别名机制，就是让我们可以以视图的方式来操作集群中的索引，这个视图可是多个索引，也可是一个索引或索引的一部分。</p>
<ol start="2">
<li><p>新建索引时定义别名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;logs_20162801</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">        &quot;type&quot; : &#123;</span><br><span class="line">            &quot;properties&quot; : &#123;</span><br><span class="line">                &quot;year&quot; : &#123;&quot;type&quot; : &quot;integer&quot;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &lt;!-- 定义了两个别名 --&gt;</span><br><span class="line">    &quot;aliases&quot; : &#123;</span><br><span class="line">        &quot;current_day&quot; : &#123;&#125;,</span><br><span class="line">        &quot;2016&quot; : &#123;</span><br><span class="line">            &quot;filter&quot; : &#123;</span><br><span class="line">                &quot;term&quot; : &#123;&quot;year&quot; : 2016 &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建别名     /_aliases</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;_aliases</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot; : [</span><br><span class="line">        &#123; &quot;add&quot; : &#123; &quot;index&quot; : &quot;test1&quot;, &quot;alias&quot; : &quot;alias1&quot; &#125; &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><p>删除别名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;_aliases</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot; : [</span><br><span class="line">        &#123; &quot;remove&quot; : &#123; &quot;index&quot; : &quot;test1&quot;, &quot;alias&quot; : &quot;alias1&quot; &#125; &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"> 还可以这样写</span><br><span class="line"></span><br><span class="line">DELETE &#x2F;&#123;index&#125;&#x2F;_alias&#x2F;&#123;name&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>批量操作别名</p>
<p>删除索引test1的别名alias1，同时为索引test2添加别名alias1</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;_aliases</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot; : [</span><br><span class="line">        &#123; &quot;remove&quot; : &#123; &quot;index&quot; : &quot;test1&quot;, &quot;alias&quot; : &quot;alias1&quot; &#125; &#125;,</span><br><span class="line">        &#123; &quot;add&quot; : &#123; &quot;index&quot; : &quot;test2&quot;, &quot;alias&quot; : &quot;alias1&quot; &#125; &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>为多个索引定义一样的别名</li>
</ol>
<p>方式1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;_aliases</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot; : [</span><br><span class="line">        &#123; &quot;add&quot; : &#123; &quot;index&quot; : &quot;test1&quot;, &quot;alias&quot; : &quot;alias1&quot; &#125; &#125;,</span><br><span class="line">        &#123; &quot;add&quot; : &#123; &quot;index&quot; : &quot;test2&quot;, &quot;alias&quot; : &quot;alias1&quot; &#125; &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方式2：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;_aliases</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot; : [</span><br><span class="line">        &#123; &quot;add&quot; : &#123; &quot;indices&quot; : [&quot;test1&quot;, &quot;test2&quot;], &quot;alias&quot; : &quot;alias1&quot; &#125; &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：只可通过多索引别名进行搜索，不可进行文档索引和根据id获取文档。</p>
<p>方式3：通过统配符*模式来指定要别名的索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;_aliases</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot; : [</span><br><span class="line">        &#123; &quot;add&quot; : &#123; &quot;index&quot; : &quot;test*&quot;, &quot;alias&quot; : &quot;all_test_indices&quot; &#125; &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">注意：在这种情况下，别名是一个点时间别名，它将对所有匹配的当前索引进行别名，当添加&#x2F;删除与此模式匹配的新索引时，它不会自动更新。</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>带过滤器的别名</li>
</ol>
<p>索引中需要有字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;test1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;type1&quot;: &#123;</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;user&quot; : &#123;</span><br><span class="line">          &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>过滤器通过Query DSL来定义，将作用于通过该别名来进行的所有Search, Count, Delete By Query and More Like This 操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;_aliases</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;add&quot; : &#123;</span><br><span class="line">                 &quot;index&quot; : &quot;test1&quot;,</span><br><span class="line">                 &quot;alias&quot; : &quot;alias2&quot;,</span><br><span class="line">                 &quot;filter&quot; : &#123; &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125; &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>带routing的别名</li>
</ol>
<p>可在别名定义中指定路由值，可和filter一起使用，用来限定操作的分片，避免不需要的其他分片操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;_aliases</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;add&quot; : &#123;</span><br><span class="line">                 &quot;index&quot; : &quot;test&quot;,</span><br><span class="line">                 &quot;alias&quot; : &quot;alias1&quot;,</span><br><span class="line">                 &quot;routing&quot; : &quot;1&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为搜索、索引指定不同的路由值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;_aliases</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;add&quot; : &#123;</span><br><span class="line">                 &quot;index&quot; : &quot;test&quot;,</span><br><span class="line">                 &quot;alias&quot; : &quot;alias2&quot;,</span><br><span class="line">                 &quot;search_routing&quot; : &quot;1,2&quot;,</span><br><span class="line">                 &quot;index_routing&quot; : &quot;2&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>以PUT方式来定义一个别名<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;&#123;index&#125;&#x2F;_alias&#x2F;&#123;name&#125;</span><br><span class="line">PUT &#x2F;logs_201305&#x2F;_alias&#x2F;2013</span><br></pre></td></tr></table></figure>
带filter 和 routing   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;users</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">        &quot;user&quot; : &#123;</span><br><span class="line">            &quot;properties&quot; : &#123;</span><br><span class="line">                &quot;user_id&quot; : &#123;&quot;type&quot; : &quot;integer&quot;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;users&#x2F;_alias&#x2F;user_12</span><br><span class="line">&#123;</span><br><span class="line">    &quot;routing&quot; : &quot;12&quot;,</span><br><span class="line">    &quot;filter&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123;</span><br><span class="line">            &quot;user_id&quot; : 12</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>查看别名定义信息<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;&#123;index&#125;&#x2F;_alias&#x2F;&#123;alias&#125;</span><br><span class="line">GET &#x2F;logs_20162801&#x2F;_alias&#x2F;*</span><br><span class="line">GET &#x2F;_alias&#x2F;2016</span><br><span class="line">GET &#x2F;_alias&#x2F;20*</span><br></pre></td></tr></table></figure>
</li>
</ol>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/03/09/Elasticsearch%E4%BB%8B%E7%BB%8D%E5%92%8C%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/09/Elasticsearch%E4%BB%8B%E7%BB%8D%E5%92%8C%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/" itemprop="url">Elasticsearch介绍和基本使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-09T00:00:00+08:00">
                2019-03-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ES特性"><a href="#ES特性" class="headerlink" title="ES特性"></a>ES特性</h1><p>官网的介绍： <a href="https://www.elastic.co/cn/products/elasticsearch" target="_blank" rel="noopener">https://www.elastic.co/cn/products/elasticsearch</a></p>
<p>速度快、易扩展、弹性、灵活、操作简单、多语言客户端、X-Pack、hadoop/spark强强联手、开箱即用。</p>
<ul>
<li>分布式：横向扩展非常灵活</li>
<li>全文检索：基于lucene的强大的全文检索能力；</li>
<li>近实时搜索和分析：数据进入ES，可达到近实时搜索，还可进行聚合分析</li>
<li>高可用：容错机制，自动发现新的或失败的节点，重组和重新平衡数据</li>
<li>模式自由：ES的动态mapping机制可以自动检测数据的结构和类型，创建索引并使数据可搜索。</li>
<li>RESTful API：JSON + HTTP<h1 id="ES架构"><a href="#ES架构" class="headerlink" title="ES架构"></a>ES架构</h1><img src="https://img.huyunshun.com/img1/Elasticsearch/123432edsfdsfimgclip_3.png" alt=""></li>
</ul>
<p>说明:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Gateway是ES用来存储索引的文件系统，支持多种类型。</span><br><span class="line">Gateway的上层是一个分布式的lucene框架。</span><br><span class="line">Lucene之上是ES的模块，包括：索引模块、搜索模块、映射解析模块等</span><br><span class="line">ES模块之上是 Discovery、Scripting和第三方插件。Discovery是ES的节点发现模块，不同机器上的ES节点要组成集群需要进行消息通信，集群内部需要选举master节点，这些工作都是由Discovery模块完成。支持多种发现机制，如 Zen 、EC2、gce、Azure。Scripting用来支持在查询语句中插入javascript、python等脚本语言，scripting模块负责解析这些脚本，使用脚本语句性能稍低。ES也支持多种第三方插件。</span><br><span class="line">再上层是ES的传输模块和JMX.传输模块支持多种传输协议，如 Thrift、memecached、http，默认使用http。JMX是java的管理框架，用来管理ES应用。</span><br><span class="line">最上层是ES提供给用户的接口，可以通过RESTful接口和ES集群进行交互。</span><br></pre></td></tr></table></figure>

<h1 id="ES应用场景"><a href="#ES应用场景" class="headerlink" title="ES应用场景"></a>ES应用场景</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">维基百科</span><br><span class="line">The Guardian（国外新闻网站）</span><br><span class="line">Stack Overflow（国外的程序异常讨论论坛）</span><br><span class="line">GitHub（开源代码管理）</span><br><span class="line">电商网站</span><br><span class="line">日志数据分析</span><br><span class="line">商品价格监控网站</span><br><span class="line">BI系统</span><br><span class="line">站内搜索</span><br></pre></td></tr></table></figure>
<p>Elasticsearch的使用场景深入详解</p>
<h2 id="场景—：使用Elasticsearch作为主要的后端"><a href="#场景—：使用Elasticsearch作为主要的后端" class="headerlink" title="场景—：使用Elasticsearch作为主要的后端"></a>场景—：使用Elasticsearch作为主要的后端</h2><p>传统项目中，搜索引擎是部署在成熟的数据存储的顶部，以提供快速且相关的搜索能力。这是因为早期的搜索引擎不能提供耐用的​​存储或其他经常需要的功能，如统计。</p>
<p><img src="https://img.huyunshun.com/img1/Elasticsearch/123432edsfdsfimgclip.png" alt=""></p>
<p>Elasticsearch是提供持久存储、统计等多项功能的现代搜索引擎。</p>
<p>如果你开始一个新项目，考虑使用Elasticsearch作为唯一的数据存储，此种场景不支持包含频繁更新、事务（transaction）的操作。</p>
<p>例如新建一个博客系统使用es作为存储。</p>
<p>1）我们可以向ES提交新的博文；</p>
<p>2）使用ES检索、搜索、统计数据。</p>
<p>ES作为存储的优势：</p>
<p>如果一台服务器出现故障时会发生什么？你可以通过复制 数据到不同的服务器以达到容错的目的。</p>
<p>注意：整体架构设计时，需要我们权衡是否有必要增加额外的存储。</p>
<h2 id="场景二：在现有系统中增加elasticsearch"><a href="#场景二：在现有系统中增加elasticsearch" class="headerlink" title="场景二：在现有系统中增加elasticsearch"></a>场景二：在现有系统中增加elasticsearch</h2><p>由于ES不能提供存储的所有功能，一些场景下需要在现有系统数据存储的基础上新增ES支持。</p>
<p><img src="https://img.huyunshun.com/img1/Elasticsearch/123432edsfdsfimgclip_1.png" alt=""></p>
<p>举例1：ES不支持事务、复杂的关系（至少1.X版本不支持，2.X有改善，但支持的仍然不好），如果你的系统中需要上述特征的支持，需要考虑在原有架构、原有存储的基础上的新增ES的支持。</p>
<p>举例2：如果你已经有一个在运行的复杂的系统，你的需求之一是在现有系统中添加检索服务。一种非常冒险的方式是重构系统以支持ES。而相对安全的方式是：将ES作为新的组件添加到现有系统中。</p>
<p>如果你使用了如下图所示的SQL数据库和ES存储，你需要找到一种方式使得两存储之间实时同步。需要根据数据的组成、数据库选择对应的同步插件。可供选择的插件包括：</p>
<p>1）mysql、oracle选择 logstash-input-jdbc 插件。</p>
<p>2）mongo选择 mongo-connector工具。</p>
<p>假设你的在线零售商店的产品信息存储在SQL数据库中。 为了快速且相关的搜索，你安装Elasticsearch。</p>
<p>为了索引数据，您需要部署一个同步机制，该同步机制可以是Elasticsearch插件或你建立一个自定义的服务。此同步机制可以将对应于每个产品的所有数据和索引都存储在Elasticsearch，每个产品作为一个document存储（相当于关系据库中的一行/row数据）。</p>
<p>当在该网页上的搜索条件中输入“用户的类型”，店面网络应用程序通过Elasticsearch查询该信息。 Elasticsearch返回符合标准的产品documents，并根据你喜欢的方式来分类文档。 排序可以根据每个产品的被搜索次数所得到的相关分数，或任何存储在产品document信息，例如：最新最近加入的产品、平均得分，或者是那些插入或更新信息。 所以你可以只使用Elasticsearch处理搜索。这取决于同步机制来保持Elasticsearch获取最新变化。</p>
<h2 id="场景三：使用elasticsearch和现有的工具"><a href="#场景三：使用elasticsearch和现有的工具" class="headerlink" title="场景三：使用elasticsearch和现有的工具"></a>场景三：使用elasticsearch和现有的工具</h2><p>在一些使用情况下，不必写一行代码就能通过elasticssearch完成一项工作。很多工具都可以与Elasticsearch一起工作，所以你不必到你从头开始编写。</p>
<p>例如，假设要部署一个大规模的日志框架存储，搜索，并分析了大量的事件。</p>
<p>如图下图，处理日志和输出到Elasticsearch，您可以使用日志记录工具，如rsyslog（<a href="http://www.rsyslog.com），Logstash（www.elastic.co/products/logstash），或Apache" target="_blank" rel="noopener">www.rsyslog.com），Logstash（www.elastic.co/products/logstash），或Apache</a> Flume（<a href="http://flume.apache.org）。" target="_blank" rel="noopener">http://flume.apache.org）。</a><br>搜索和可视化界面分析这些日志，你可以使用Kibana（<a href="http://www.elastic.co/产品/" target="_blank" rel="noopener">www.elastic.co/产品/</a> kibana）。</p>
<p><img src="https://img.huyunshun.com/img1/Elasticsearch/123432edsfdsfimgclip_2.png" alt=""></p>
<p>出处：<a href="http://blog.csdn.net/laoyang360/article/details/52227541" target="_blank" rel="noopener">http://blog.csdn.net/laoyang360/article/details/52227541</a></p>
<h1 id="ES的特点"><a href="#ES的特点" class="headerlink" title="ES的特点"></a>ES的特点</h1><p>可以作为一个大型分布式集群（数百台服务器）技术，处理PB级数据，服务大公司；也可以运行在单机上，服务小公司</p>
<p>Elasticsearch不是什么新技术，主要是将全文检索、数据分析以及分布式技术，合并在了一起</p>
<p>对用户而言，是开箱即用的，非常简单，作为中小型的应用，直接3分钟部署一下ES</p>
<p>Elasticsearch作为传统数据库的一个补充,比如全文检索，同义词处理，相关度排名，复杂数据分析，海量数据的近实时处理；</p>
<h1 id="ES的核心概念"><a href="#ES的核心概念" class="headerlink" title="ES的核心概念"></a>ES的核心概念</h1><ul>
<li>** Near Realtime（NRT）** 近实时。数据提交索引后，立马就可以搜索到。</li>
<li>** Cluster 集群**，一个集群由一个唯一的名字标识，默认为“elasticsearch”。集群名称非常重要，具有相同集群名的节点才会组成一个集群。集群名称可以在配置文件中指定。</li>
<li>** Node 节点**：存储集群的数据，参与集群的索引和搜索功能。像集群有名字，节点也有自己的名称，默认在启动时会以一个随机的UUID的前七个字符作为节点的名字，你可以为其指定任意的名字。通过集群名在网络中发现同伴组成集群。一个节点也可是集群。</li>
<li>** Index 索引**: 一个索引是一个文档的集合（等同于solr中的集合）。每个索引有唯一的名字，通过这个名字来操作它。一个集群中可以有任意多个索引。</li>
<li>** Type 类型**：指在一个索引中，可以索引不同类型的文档，如用户数据、博客数据。从6.0.0 版本起已废弃，一个索引中只存放一类数据。</li>
<li>** Document 文档**：被索引的一条数据，索引的基本信息单元，以JSON格式来表示。</li>
<li>** Shard 分片**：在创建一个索引时可以指定分成多少个分片来存储。每个分片本身也是一个功能完善且独立的“索引”，可以被放置在集群的任意节点上。分片的好处：</li>
</ul>
<p>-允许我们水平切分/扩展容量<br>-可在多个分片上进行分布式的、并行的操作，提高系统的性能和吞吐量。</p>
<p>注意：分片数创建索引时指定，创建后不可改了。备份数可以随时改。</p>
<p>Replication 备份: 一个分片可以有多个备份（副本）。备份的好处：高可用。一个主分片挂了，副本分片就顶上去；扩展搜索的并发能力、吞吐量。搜索可以在所有的副本上并行运行。-高并发下副本也可搜索。</p>
<p><img src="https://img.huyunshun.com/img1/Elasticsearch/123432edsfdsfimgclip_4.png" alt=""></p>
<h1 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h1><p>略</p>
<p>注意：在linux 虚拟机上运行可能的失败问题</p>
<ul>
<li>内存不够用，默认es配置使用1G堆内存，如果的你学习用的虚拟机没有这么大的内存，请在config/jvm.options中调整</li>
<li>可能会报如下的错误<br><img src="https://img.huyunshun.com/img1/Elasticsearch/123432edsfdsfimgclip_5.png" alt=""></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">问题一：max file descriptors [4096] for elasticsearch process likely too low, increase to at least [65536]</span><br><span class="line">解决：修改切换到root用户修改配置limits.conf 添加下面两行</span><br><span class="line">命令:vi &#x2F;etc&#x2F;security&#x2F;limits.conf</span><br><span class="line">* hard nofile 65536</span><br><span class="line">* soft nofile 65536</span><br><span class="line"></span><br><span class="line">问题二：max number of threads [1024] for user [lish] likely too low, increase to at least [2048]</span><br><span class="line">解决：切换到root用户，进入limits.d目录下修改配置文件。</span><br><span class="line">vi &#x2F;etc&#x2F;security&#x2F;limits.d&#x2F;90-nproc.conf</span><br><span class="line">修改如下内容：</span><br><span class="line">* soft nproc 1024</span><br><span class="line">#修改为</span><br><span class="line">* soft nproc 2048</span><br><span class="line"></span><br><span class="line">问题三：max virtual memory areas vm.max_map_count [65530] likely too low, increase to at least [262144]</span><br><span class="line">解决：切换到root用户修改配置sysctl.conf</span><br><span class="line">vi &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">添加下面配置：</span><br><span class="line">vm.max_map_count&#x3D;655360</span><br><span class="line"></span><br><span class="line">并执行命令：</span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line">切换到es的用户。</span><br><span class="line">然后，重新启动elasticsearch，即可启动成功。</span><br></pre></td></tr></table></figure>

<p>** 后台运行ES **<br>使用守护进程运行：./elasticsearch -d</p>
<p>** ES 重要的配置参数 **<br>** 1、** 数据目录和日志目录，生成环境下应与软件分离</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">path:</span><br><span class="line">        logs: &#x2F;var&#x2F;.....</span><br><span class="line">        data: &#x2F;var&#x2F;data&#x2F;...</span><br></pre></td></tr></table></figure>
<p>** 2、** 所属的集群名，默认为 elasticsearch ，可修改：cluster.name: dddd</p>
<p>** 3、** 节点名称，默认为 UUID前7个字符，可自定义</p>
<p>** 4、** network.host  IP绑定</p>
<p>** 5、** http.port: 9200-9300 对外服务的http 端口， 默认 9200-9300 。可以为它指定一个值或一个区间，当为区间时会取用区间第一个可用的端口。</p>
<p>** 6、** transport.tcp.port: 9300-9400 节点间交互的端口， 默认 9300-9400 。</p>
<p>** 7、** Discovery Config  节点发现配置</p>
<p>ES中默认采用的节点发现方式是  zen（基于组播（多播）、单播）。在应用于生产前有两个重要参数需配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">discovery.zen.ping.unicast.hosts: [&quot;host1&quot;,&quot;host2:port&quot;,&quot;host3[portX-portY]&quot;] 单播模式下，设置具有master资格的节点列表，新加入的节点向这个列表中的节点发送请求来加入集群</span><br><span class="line">discovery.zen.minimum_master_nodes: 1 这个参数控制的是，一个节点需要看到具有master资格的节点的最小数量，然后才能在集群中做操作。官方的推荐值是(N&#x2F;2)+1，其中N是具有master资格的节点的数量。</span><br></pre></td></tr></table></figure>
<p>** 8、** Jvm heap 大小设置</p>
<p>生产环境中一定要在jvm.options中调大它的jvm内存。</p>
<p>** 9、** JVM heap dump path 设置</p>
<p>生产环境中指定当发生OOM异常时，heap的dump path，好分析问题。在jvm.options中配置：</p>
<p>-XX:HeapDumpPath=/var/lib/elasticsearch</p>
<p>** 10、** 其他配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">transport.tcp.compress: false</span><br><span class="line">    是否压缩tcp传输的数据，默认false</span><br><span class="line">http.cors.enabled: true</span><br><span class="line">    是否使用http协议对外提供服务，默认true</span><br><span class="line">http.max_content_length: 100mb</span><br><span class="line">    http传输内容的最大容量，默认100mb</span><br><span class="line">node.master: true   </span><br><span class="line">    指定该节点是否可以作为master节点，默认是true。ES集群默认是以第一个节点为master，如果该节点出故障就会重新选举master。</span><br><span class="line">node.data: true</span><br><span class="line">    该节点是否存索引数据，默认true。</span><br><span class="line">discover.zen.ping.timeout: 3s</span><br><span class="line">    设置集群中自动发现其他节点时ping连接超时时长，默认为3秒。在网络环境较差的情况下，增加这个值，会增加节点等待响应的时间，从一定程度上会减少误判。</span><br><span class="line">discovery.zen.ping.multicast.enabled: false</span><br><span class="line">    是否启用多播来发现节点。</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/03/08/ES-Spring_JPA%E6%93%8D%E4%BD%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/08/ES-Spring_JPA%E6%93%8D%E4%BD%9C/" itemprop="url">ES-Spring JPA操作</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-08T00:00:00+08:00">
                2019-03-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>ElasticSearch在JPA与原生操作接口的对应关系</p>
<table>
<thead>
<tr>
<th align="center">关键字</th>
<th align="center">例子</th>
<th align="center">Elasticsearch查询语句</th>
</tr>
</thead>
<tbody><tr>
<td align="center">And</td>
<td align="center">findByNameAndPrice</td>
<td align="center">{“bool” : {“must” : [ {“field” : {“name” : “?”}}, {“field” : {“price” : “?”}} ]}}</td>
</tr>
<tr>
<td align="center">Or</td>
<td align="center">findByNameOrPrice</td>
<td align="center">{“bool” : {“should” : [ {“field” : {“name” : “?”}}, {“field” : {“price” : “?”}} ]}}</td>
</tr>
<tr>
<td align="center">Is</td>
<td align="center">findByName</td>
<td align="center">{“bool” : {“must” : {“field” : {“name” : “?”}}}}</td>
</tr>
<tr>
<td align="center">Not</td>
<td align="center">findByNameNot</td>
<td align="center">{“bool” : {“must_not” : {“field” : {“name” : “?”}}}}</td>
</tr>
<tr>
<td align="center">Between</td>
<td align="center">findByPriceBetween</td>
<td align="center">{“bool” : {“must” : {“range” : {“price” : {“from” : ?,“to” : ?,“include_lower” : true,“include_upper” : true}}}}}</td>
</tr>
<tr>
<td align="center">LessThanEqual</td>
<td align="center">findByPriceLessThan</td>
<td align="center">{“bool” : {“must” : {“range” : {“price” : {“from” : null,”to” : ?,”include_lower” : true,”include_upper” : true}}}}}</td>
</tr>
<tr>
<td align="center">GreaterThanEqual</td>
<td align="center">findByPriceGreaterThan</td>
<td align="center">{“bool” : {“must” : {“range” : {“price” : {“from” : ?,”to” : null,”include_lower” : true,”include_upper” : true}}}}}</td>
</tr>
<tr>
<td align="center">Before</td>
<td align="center">findByPriceBefore</td>
<td align="center">{“bool” : {“must” : {“range” : {“price” : {“from” : null,”to” : ?,”include_lower” : true,”include_upper” : true}}}}}</td>
</tr>
<tr>
<td align="center">After</td>
<td align="center">findByPriceAfter</td>
<td align="center">{“bool” : {“must” : {“range” : {“price” : {“from” : ?,”to” : null,”include_lower” : true,”include_upper” : true}}}}}</td>
</tr>
<tr>
<td align="center">Like</td>
<td align="center">findByNameLike</td>
<td align="center">{“bool” : {“must” : {“field” : {“name” : {“query” : “?*”,”analyze_wildcard” : true}}}}}</td>
</tr>
<tr>
<td align="center">StartingWith</td>
<td align="center">findByNameStartingWith</td>
<td align="center">{“bool” : {“must” : {“field” : {“name” : {“query” : “?*”,”analyze_wildcard” : true}}}}}</td>
</tr>
<tr>
<td align="center">EndingWith</td>
<td align="center">findByNameEndingWith</td>
<td align="center">{“bool” : {“must” : {“field” : {“name” : {“query” : “*?”,”analyze_wildcard” : true}}}}}</td>
</tr>
<tr>
<td align="center">Contains/Containing</td>
<td align="center">findByNameContaining</td>
<td align="center">{“bool” : {“must” : {“field” : {“name” : {“query” : “?”,”analyze_wildcard” : true}}}}}</td>
</tr>
<tr>
<td align="center">In</td>
<td align="center">findByNameIn(Collectionnames)</td>
<td align="center">{“bool” : {“must” : {“bool” : {“should” : [ {“field” : {“name” : “?”}}, {“field” : {“name” : “?”}} ]}}}}</td>
</tr>
<tr>
<td align="center">NotIn</td>
<td align="center">findByNameNotIn(Collectionnames)</td>
<td align="center">{“bool” : {“must_not” : {“bool” : {“should” : {“field” : {“name” : “?”}}}}}}</td>
</tr>
<tr>
<td align="center">Near</td>
<td align="center">findByStoreNear</td>
<td align="center">暂不支持</td>
</tr>
<tr>
<td align="center">True</td>
<td align="center">findByAvailableTrue</td>
<td align="center">{“bool” : {“must” : {“field” : {“available” : true}}}}</td>
</tr>
<tr>
<td align="center">False</td>
<td align="center">findByAvailableFalse</td>
<td align="center">{“bool” : {“must” : {“field” : {“available” : false}}}}</td>
</tr>
<tr>
<td align="center">OrderBy</td>
<td align="center">findByAvailableTrueOrderByNameDesc</td>
<td align="center">{“sort” : [{ “name” : {“order” : “desc”} }],”bool” : {“must” : {“field” : {“available” : true}}}}</td>
</tr>
</tbody></table>
<p>实体声明</p>
<ul>
<li>1、类上注解：@Document (相当于Hibernate实体的@Entity/@Table)</li>
</ul>
<table>
<thead>
<tr>
<th align="center">类型</th>
<th align="center">属性名</th>
<th align="center">默认值</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">String</td>
<td align="center">indexName</td>
<td align="center">无</td>
<td align="center">索引库的名称</td>
</tr>
<tr>
<td align="center">String</td>
<td align="center">type</td>
<td align="center">“”</td>
<td align="center">类型</td>
</tr>
<tr>
<td align="center">short</td>
<td align="center">shards</td>
<td align="center">5</td>
<td align="center">默认分区数</td>
</tr>
<tr>
<td align="center">short</td>
<td align="center">replica</td>
<td align="center">1</td>
<td align="center">每个分区默认的备份数</td>
</tr>
<tr>
<td align="center">String</td>
<td align="center">refreshInterval</td>
<td align="center">“1s”</td>
<td align="center">刷新间隔</td>
</tr>
<tr>
<td align="center">String</td>
<td align="center">indexStoreType</td>
<td align="center">“fs”</td>
<td align="center">索引文件存储类型</td>
</tr>
</tbody></table>
<ul>
<li>2、主键注解：@Id (相当于Hibernate实体的主键@Id注解) 只是一个标识，并没有属性。   </li>
<li>3、属性注解 @Field (相当于Hibernate实体的@Column注解)   </li>
</ul>
<p>@Field默认是可以不加的，默认所有属性都会添加到ES中。</p>
<table>
<thead>
<tr>
<th align="center">类型</th>
<th align="center">属性名</th>
<th align="center">默认值</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">FileType</td>
<td align="center">type</td>
<td align="center">FieldType.Auto</td>
<td align="center">自动检测属性的类型</td>
</tr>
<tr>
<td align="center">FileType</td>
<td align="center">index</td>
<td align="center">FieldIndex.analyzed</td>
<td align="center">默认情况下分词</td>
</tr>
<tr>
<td align="center">boolean</td>
<td align="center">store</td>
<td align="center">false</td>
<td align="center">默认情况下不存储原文</td>
</tr>
<tr>
<td align="center">String</td>
<td align="center">searchAnalyzer</td>
<td align="center">“”</td>
<td align="center">指定字段搜索时使用的分词器</td>
</tr>
<tr>
<td align="center">String</td>
<td align="center">indexAnalyzer</td>
<td align="center">“”</td>
<td align="center">指定字段建立索引时指定的分词器</td>
</tr>
<tr>
<td align="center">String[]</td>
<td align="center">ignoreFields</td>
<td align="center">{}</td>
<td align="center">如果某个字段需要被忽略</td>
</tr>
</tbody></table>
<h6 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h6><p>实体：   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * index</span></span><br><span class="line"><span class="comment"> * 索引，相当于Mysql中的一个库，例如有一个叫『jd』的库，那么里面可以建立很多表，存储不同类型的数据，而表在ES中就是type。</span></span><br><span class="line"><span class="comment"> * type</span></span><br><span class="line"><span class="comment"> * 类型，相当于Mysql中的一张表，存储json类型的数据</span></span><br><span class="line"><span class="comment"> * document</span></span><br><span class="line"><span class="comment"> * 文档，一个文档相当于Mysql一行的数据</span></span><br><span class="line"><span class="comment"> * shards</span></span><br><span class="line"><span class="comment"> * 分片，通俗理解，就是数据分成几块区域来存储，可以理解为mysql中的分库分表(不太恰当)</span></span><br><span class="line"><span class="comment"> * replicas</span></span><br><span class="line"><span class="comment"> * 备份，就是分片的备份数,相当于mysql的备份库</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Document</span>(indexName = <span class="string">"account"</span>, type = <span class="string">"_doc"</span>, refreshInterval = <span class="string">"0s"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Account</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> String realName;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="comment">//这三个注解是为了前台序列化java8 LocalDateTime使用的，需要引入jsr310的包才可以使用</span></span><br><span class="line">    <span class="meta">@JsonSerialize</span>(using = LocalDateTimeSerializer<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    @<span class="title">JsonDeserialize</span>(<span class="title">using</span> </span>= LocalDateTimeDeserializer<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    @<span class="title">JsonFormat</span>(<span class="title">pattern</span> </span>= <span class="string">"yyyy-MM-dd HH:mm"</span>)</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime birth;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DAO:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> huyunshun 2019/8/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountRepository</span> <span class="keyword">extends</span> <span class="title">ElasticsearchRepository</span>&lt;<span class="title">Account</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询账户名为username的账户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Account&gt; <span class="title">findByUserName</span><span class="params">(String userName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询账户名为username并且真实姓名为realname的账户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> realName</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Account&gt; <span class="title">findByUserNameAndRealName</span><span class="params">(String userName, String realName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询账户名为userName或者姓名为realName的账户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Account&gt; <span class="title">findByUserNameOrRealName</span><span class="params">(String userName, String realName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询账户名不是username的所有账户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Account&gt; <span class="title">findByUserNameNot</span><span class="params">(String userName)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询年龄段为ageFrom到ageTo的账户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ageFrom</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ageTo</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Account&gt; <span class="title">findByAgeBetween</span><span class="params">(Integer ageFrom, Integer ageTo)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询生日小于birth的账户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Account&gt; <span class="title">findByBirthLessThan</span><span class="params">(LocalDateTime birth)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询生日段大于birthFrom的账户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> birth</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Account&gt; <span class="title">findByBirthGreaterThan</span><span class="params">(LocalDateTime birth)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询年龄小于或等于age的账户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Account&gt; <span class="title">findByAgeBefore</span><span class="params">(Integer age)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询年龄大于或等于age的账户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> age</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Account&gt; <span class="title">findByAgeAfter</span><span class="params">(Integer age)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 账户名模糊查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Account&gt; <span class="title">findByUserNameLike</span><span class="params">(String userName)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询以start开头的账户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> start</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Account&gt; <span class="title">findByUserNameStartingWith</span><span class="params">(String start)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询以end结尾的账户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Account&gt; <span class="title">findByUserNameEndingWith</span><span class="params">(String end)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询账户名包含word的账户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> word</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Account&gt; <span class="title">findByUserNameContaining</span><span class="params">(String word)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询名字属于usernames中的账户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userNames</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Account&gt; <span class="title">findByUserNameIn</span><span class="params">(Collection&lt;String&gt; userNames)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询名字不属于userNames中的账户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userNames</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Account&gt; <span class="title">findByUserNameNotIn</span><span class="params">(Collection&lt;String&gt; userNames)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *查询年龄小于age,姓名以start开头，id大于id的账户，并且按照年龄倒序</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Account&gt; <span class="title">findByAgeBeforeAndUserNameStartingWithAndIdGreaterThanOrderByAgeDesc</span><span class="params">(Integer age, String start, Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 写ES的查询语句</span></span><br><span class="line"><span class="comment">     * 查询名字为name的账户 分页</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pageable</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Query</span>(<span class="string">"&#123;\"bool\" : &#123;\"must\" : &#123;\"field\" : &#123;\"name\" : \"?0\"&#125;&#125;&#125;&#125;"</span>)</span><br><span class="line">    <span class="function">Page&lt;Account&gt; <span class="title">findByName</span><span class="params">(String name, Pageable pageable)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Hibernate中criteria的方式进行查询   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;Account&gt; <span class="title">getAccounts</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//创建builder</span></span><br><span class="line">    BoolQueryBuilder builder = QueryBuilders.boolQuery();</span><br><span class="line">    <span class="comment">//设置模糊搜索,真实姓名中包含胡的用户</span></span><br><span class="line">    builder.must(QueryBuilders.fuzzyQuery(<span class="string">"realName"</span>, <span class="string">"胡"</span>));</span><br><span class="line">    <span class="comment">//设置用户名为huing</span></span><br><span class="line">    builder.must(<span class="keyword">new</span> QueryStringQueryBuilder(<span class="string">"huing"</span>).field(<span class="string">"userName"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//排序</span></span><br><span class="line">    FieldSortBuilder sort = SortBuilders.fieldSort(<span class="string">"age"</span>).order(SortOrder.DESC);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置分页</span></span><br><span class="line">    PageRequest page = <span class="keyword">new</span> PageRequest(<span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构建查询</span></span><br><span class="line">    NativeSearchQueryBuilder nativeSearchQueryBuilder = <span class="keyword">new</span> NativeSearchQueryBuilder();</span><br><span class="line">    <span class="comment">//将搜索条件设置到构建中</span></span><br><span class="line">    nativeSearchQueryBuilder.withQuery(builder);</span><br><span class="line">    <span class="comment">//将分页设置到构建中</span></span><br><span class="line">    nativeSearchQueryBuilder.withPageable(page);</span><br><span class="line">    <span class="comment">//将排序设置到构建中</span></span><br><span class="line">    nativeSearchQueryBuilder.withSort(sort);</span><br><span class="line">    <span class="comment">//生产NativeSearchQuery</span></span><br><span class="line">    NativeSearchQuery query = nativeSearchQueryBuilder.build();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行,返回包装结果的分页</span></span><br><span class="line">    Page&lt;Account&gt; resutlList = accountRepository.search(query);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resutlList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">Analysis（分析）</span><br><span class="line">​ 分析的过程就是将全文（full text）转换成 术语／分词（terms）。 这取决于使用那个分析器,这些短语:“FOO BAR”, “Foo-Bar”, “foo,bar”，可能会拆分成” foo”和“bar”。这些拆分后的词实际上是存储在索引中。一个完整的文本查询(而不是一个分词查询) “FoO:bAR”，将被分解成 “foo”,“bar”,来匹配存储在索引中的分词。正是这一过程的分析(包括在索引时间和搜索时间),允许elasticsearch执行全文查询。</span><br><span class="line"></span><br><span class="line">Cluster （集群）</span><br><span class="line">​ 一个集群包含一个或多个分配了相同的集群名称的节点。每个集群都有一个主节点是集群自动选择产生,并且可以决定如果当前主节点失败，哪些可以替换。</span><br><span class="line"></span><br><span class="line">Document（文档）</span><br><span class="line">​ 文档是存储在elasticsearch中的一个JSON文件。这是相当与关系数据库中表的一行数据。每个文档被存储在索引中，并具有一个类型和一个id。一个文档是一个JSON对象（也被称为在其他语言中的 hash &#x2F; hashmap &#x2F; associative array（关联数组）），其中包含零个或多个字段 或者 键值对。原始JSON文档将被存储在索引的_source字段，在获得（getting）或者 搜索（searching）默认的返回时，得到或搜索文档。</span><br><span class="line"></span><br><span class="line">Id（标识）</span><br><span class="line">​ 每个文档ID标识了一个文档。一个文档的索引&#x2F;类型&#x2F; ID必须是唯一的。如果没有提供ID，将是自动生成。（还可以看到路由）</span><br><span class="line"></span><br><span class="line">Field（字段）</span><br><span class="line">​ 文档中包含的一组字段或键值对。字段的值可以是一个简单的（标量）值（如字符串，整数，日期），或者一个嵌套的结构就像一个数组或对象。一个字段就是类似关系数据库表中的一列。映射的每个字段有一个字段的类型“type”（不要与文档类型混淆），表示那种类型的数据可以存储在该字段里，如：整数，字符串，对象。映射还允许你定义（除其他事项外）一个字段的值如何进行分析。</span><br><span class="line"></span><br><span class="line">Index（索引）</span><br><span class="line">​ 索引就是像关系数据库中的“数据库”。通过映射可以定义成多种类型。索引是一个逻辑命名空间映射到一个或多个主要的分片，可以有零个或多个副本分片。</span><br><span class="line"></span><br><span class="line">Mapping（映射）</span><br><span class="line">​ 映射是像关系数据库中的”模式定义“。每个索引都有一个映射，它定义了每个索引的类型，再加上一些索引范围的设置。映射可以被明确地定义，或者在一个文档被索引的时候自动生成。</span><br><span class="line"></span><br><span class="line">Node（节点）</span><br><span class="line">​ 节点是属于elasticsearch群集的运行实例。测试的时候，在一台服务器可以启动多个节点，但通常情况下应该在一台服务器运行一个节点。在启动时，节点将使用单播（或组播，但是必须指定）来发现使用相同的群集名称的群集，并会尝试加入该群集。</span><br><span class="line"></span><br><span class="line">Primary shard（主分片）</span><br><span class="line">​ 每个文档都存储在一个主要分片上。当你索引一个文档时，索引首先生成在主分片上，然后才到主分片的所有副本上。默认情况下，索引有5个主分片。您可以指定更多或更少的主分片来适应索引可以处理的文档数。一旦创建了索引，就不能改变索引中主分片的数量。</span><br><span class="line"></span><br><span class="line">Replica shard（副本分片）</span><br><span class="line">​ 每个主分片可以有零个或多个副本。副本是主分片的一个拷贝，有两个作用：</span><br><span class="line"></span><br><span class="line">​ 1、故障转移：如果主分片有问题，副本分片可以提升为主分片；</span><br><span class="line"></span><br><span class="line">​ 2、提高性能：获取和搜索请求可以处理主分片或副本分片。</span><br><span class="line"></span><br><span class="line">​ 默认情况下，每个主分片有一个副本，不过索引的副本数量可以动态地改变。在同一个节点上，一个副本分片将永远不会和其主分片一起运行。</span><br><span class="line"></span><br><span class="line">Routing（路由）</span><br><span class="line">​ 当你索引一个文档，它是存储在一个主分片里。这分片的选择是通过哈希的路由值。默认情况下，路由值来自文档的ID；如果该文档指定了父文档，则使用父文档的ID（以确保这个子文档和父文件都存储在相同的分片上）。这个路由值可以在索引的时候，通过指定数值或者配置字段映射来覆盖。</span><br><span class="line"></span><br><span class="line">Shard（分片）</span><br><span class="line">​ 一个分片是一个单一的Lucene的实例。这是一个低级别的通过ElasticSearch自动管理的“工作者”单元。索引是一个逻辑命名空间指向主分片和副本分片。索引的主分片和副本分片的数量需要明确的指定。然而你的代码应该只处理一个索引。Elasticsearch分配集群中所有节点的分片。在节点出现故障或增加新节点的时候，可以自动的将一个节点上的分片移动到另一个节点上。</span><br><span class="line"></span><br><span class="line">Source field（源字段）</span><br><span class="line">​ 默认情况下，你的JSON文档将被索引存储在_source字段里面，所有的get（获取）和search（搜索）请求将返回的该字段。这将允许你直接从搜索结果中访问到源数据，而不需要再次发起请求检索。</span><br><span class="line"></span><br><span class="line">​ 注：索引将返回完整的的JSON字符串给你，即使它包含无效的JSON。此字段里的内容不表示任何该对象里面的数据如何被索引。</span><br><span class="line"></span><br><span class="line">Term（术语）</span><br><span class="line">​ 在elasticsearch里，术语(term)是一个被索引的精确值。术语 foo, Foo,FOO 是不想等的。术语（即精确值）可以使用“term”查询接口来查询。</span><br><span class="line"></span><br><span class="line">Text(文本)</span><br><span class="line">​ 文本（或全文）是普通非结构化的文本，如本段。默认情况下，文本将被分析成术语，术语才是实际存储在索引中。文本字段在索引时需要进行分析，以便全文搜索，全文查询的关键字在搜索时，必须分析产生（搜索）与索引时相同的术语。</span><br><span class="line"></span><br><span class="line">Type(类型)</span><br><span class="line">​ Type是相当于关系数据库中的“表”。每种类型都有一列字段，用来定义文档的类型。映射定义了对在文档中的每个字段如何进行分析。</span><br></pre></td></tr></table></figure>
<h6 id="QueryBuilders构建查询"><a href="#QueryBuilders构建查询" class="headerlink" title="QueryBuilders构建查询"></a>QueryBuilders构建查询</h6><p>QueryBuilder如：MatchAllQueryBuilder.class，FuzzyQueryBuilder.class等，它们是具体的查询实现类，它们是QueryBuilders抽象类的子类并实现了BoostableQueryBuilder&lt;&gt;接口。</p>
<p>而QueryBuilders的主要作用就是提供了静态方法去创建一个子类的对象，方便QueryBuilder的构建与管理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">匹配所有文档的查询。</span><br><span class="line">matchAllQuery()</span><br><span class="line">为提供的字段名和文本创建类型为“BOOLEAN”的匹配查询。(解释过来就是单个匹配，可以模糊匹配)</span><br><span class="line">matchQuery(String name, Object text) &#x2F;&#x2F;name 字段值 ，text 查询文本（不支持通配符）</span><br><span class="line">为提供的字段名和文本创建一个通用查询。</span><br><span class="line">commonTermsQuery(String name, Object text)</span><br><span class="line">为提供的字段名和文本创建类型为“BOOLEAN”的匹配查询。</span><br><span class="line">multiMatchQuery(Object text, String... fieldNames) </span><br><span class="line">为提供的字段名和文本创建一个文本查询，并输入“短句”。</span><br><span class="line">matchPhraseQuery(String name, Object text)</span><br><span class="line">为提供的字段名和文本创建一个与类型“PHRASE_PREFIX”匹配的查询。</span><br><span class="line">matchPhrasePrefixQuery(String name, Object text)</span><br><span class="line">匹配包含术语的文档的查询。</span><br><span class="line">termQuery(String name, Object value)</span><br><span class="line">使用模糊查询匹配文档的查询</span><br><span class="line">fuzzyQuery(String name, Object value)</span><br><span class="line">与包含指定前缀的术语的文档相匹配的查询。</span><br><span class="line">prefixQuery(String name, String prefix)</span><br><span class="line">在一定范围内匹配文档的查询。</span><br><span class="line">rangeQuery(String name)</span><br><span class="line">实现通配符搜索查询。支持的通配符是*，它匹配任何字符序列(包括空字符)，而?它匹配任何单个字符。注意，这个查询可能很慢，因为它需要遍历许多项。为了防止异常缓慢的通配符查询，通配符项不应该以一个通配符*或?开头。</span><br><span class="line"></span><br><span class="line">wildcardQuery(String name, String query) &#x2F;&#x2F;query 通配符查询字符串</span><br><span class="line">将包含术语的文档与指定的正则表达式匹配的查询</span><br><span class="line">regexpQuery(String name, String regexp) &#x2F;&#x2F;regexp的正则表达式</span><br><span class="line">解析查询字符串并运行它的查询。有两种模式。第一,当没有字段添加(使用QueryStringQueryBuilder.field(字符串),将运行查询一次,非前缀字段将使用QueryStringQueryBuilder.defaultField(字符串)。第二,当一个或多个字段添加(使用QueryStringQueryBuilder.field(String)),将运行提供的解析查询字段,并结合使用DisMax或普通的布尔查询(参见QueryStringQueryBuilder.useDisMax(布尔))。</span><br><span class="line"></span><br><span class="line">queryStringQuery(String queryString)</span><br><span class="line">类似于query_string查询的查询，但不会为任何奇怪的字符串语法抛出异常。</span><br><span class="line">simpleQueryStringQuery(String queryString)</span><br><span class="line">可以使用BoostingQuery类来有效地降级与给定查询匹配的结果。</span><br><span class="line">boostingQuery()</span><br><span class="line">匹配与其他查询的布尔组合匹配的文档的查询</span><br><span class="line">boolQuery()</span><br><span class="line">创建一个可用于实现MultiTermQueryBuilder的子查询的SpanQueryBuilder。</span><br><span class="line">spanMultiTermQueryBuilder(MultiTermQueryBuilder multiTermQueryBuilder)</span><br><span class="line">允许定义自定义得分函数的查询。</span><br><span class="line">functionScoreQuery(QueryBuilder queryBuilder, ScoreFunctionBuilder function)</span><br><span class="line">更像这样的查询，查找“like”提供的文档，例如提供的MoreLikeThisQueryBuilder.likeText(String)，它是针对查询所构造的字段进行检查的</span><br><span class="line"></span><br><span class="line">moreLikeThisQuery(String... fields)</span><br><span class="line">构造一个新的非计分子查询，包含子类型和要在子文档上运行的查询。这个查询的结果是这些子文档匹配的父文档。</span><br><span class="line">hasChildQuery(String type, QueryBuilder query)</span><br><span class="line">构造一个新的非评分父查询，父类型和在父文档上运行的查询。这个查询的结果是父文档匹配的子文档。</span><br><span class="line">hasParentQuery(String type, QueryBuilder query)</span><br><span class="line">基于对其中任何一个项进行匹配的若干项的字段文件</span><br><span class="line">termsQuery(String name, String... values)</span><br><span class="line">一个查询构建器，它允许构建给定JSON字符串或二进制数据作为输入的查询。当您希望使用Java Builder API，但仍然需要将JSON查询字符串与其他查询构建器结合时，这是非常有用的。</span><br><span class="line"></span><br><span class="line">wrapperQuery(String source)</span><br><span class="line">这些都是官方提供的注释，有些晦涩难懂，还有很多，我这里不一一列举。</span><br></pre></td></tr></table></figure>
<p>我们使用上述静态方法只是为了方便创建QueryBuilder系列对象。</p>
<h6 id="条件查询"><a href="#条件查询" class="headerlink" title="条件查询"></a>条件查询</h6><p>调用QueryBuilders 的静态方法创建完具体的QueryBuilder对象之后，传入.withQuery(QueryBuilder)方法就可以实现的自定义查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">1.完全匹配</span><br><span class="line">MatchQueryBuilder queryBuilder &#x3D; QueryBuilders.matchQuery(&quot;字段名&quot;, &quot;查询文本&quot;);</span><br><span class="line">2.短语匹配</span><br><span class="line">比如你要查询短语Love You，当你使用QueryBuilders.matchQuery(&quot;name&quot;, &quot;Love You&quot;)时，可能会查询到Love And You这样分开的结果，这时候我们指定为短语进行查询：</span><br><span class="line"></span><br><span class="line">QueryBuilder queryBuilder &#x3D; QueryBuilders.matchPhraseQuery(&quot;name&quot;, &quot;Love You&quot;);</span><br><span class="line">3.模糊匹配</span><br><span class="line">        MoreLikeThisQueryBuilder queryBuilder &#x3D; QueryBuilders</span><br><span class="line">                .moreLikeThisQuery(&quot;name&quot;)&#x2F;&#x2F; 要匹配的字段, 不填默认_all</span><br><span class="line">                .like(&quot;西游&quot;)&#x2F;&#x2F; 匹配的文本</span><br><span class="line">                .minTermFreq(1);&#x2F;&#x2F; 文本最少出现的次数（默认是2，我们设为1）</span><br><span class="line">我们再从源码去看其它方法</span><br><span class="line"></span><br><span class="line">添加一些文本以查找“类似”的文档</span><br><span class="line">addLikeText(String... likeTexts)</span><br><span class="line">查找类似文档</span><br><span class="line">like(Item... likeItems)</span><br><span class="line">设置不从其中选择（比如我们调用.like(&quot;西游&quot;).unlike(&quot;西游记&quot;)这样会导致啥也查不到）</span><br><span class="line">unlike(String... unlikeTexts)</span><br><span class="line">添加一些文本以查找与此不同的文档</span><br><span class="line">addUnlikeText(String... unlikeTexts)</span><br><span class="line">设置将包含在任何生成查询中的查询条件的最大数量。默认25</span><br><span class="line">maxQueryTerms(int maxQueryTerms)</span><br><span class="line">设置单词被忽略的频率，默认5，小于将不会被发现</span><br><span class="line">minDocFreq(int minDocFreq)</span><br><span class="line">设置单词仍然出现的最大频率。单词出现更多的文档将被忽略。默认为无限</span><br><span class="line">maxDocFreq(int maxDocFreq)</span><br><span class="line">设置将被忽略的单词的最小单词长度，默认0</span><br><span class="line">minWordLength(int minWordLength)</span><br><span class="line">设置将被忽略的单词的最大单词长度，默认无限</span><br><span class="line">maxWordLength(int maxWordLength)</span><br><span class="line">设置停止词，匹配时会忽略停止词</span><br><span class="line">stopWords(String... stopWords)</span><br><span class="line">设置词语权重，默认是1</span><br><span class="line">boostTerms(float boostTerms)</span><br><span class="line">查询权重（默认1）</span><br><span class="line">boost(float boost)</span><br><span class="line">设置不从其中选择术语的文本（文档Item）</span><br><span class="line">ignoreLike(String... likeText)</span><br><span class="line">4.组合查询</span><br><span class="line">        QueryBuilder queryBuilder &#x3D; QueryBuilders.boolQuery()</span><br><span class="line">                .must(QueryBuilders.matchQuery(&quot;name&quot;, &quot;西游&quot;)) &#x2F;&#x2F;AND</span><br><span class="line">                .must(QueryBuilders.wildcardQuery(&quot;name&quot;, &quot;西游?&quot;)) &#x2F;&#x2F;Not</span><br><span class="line">                .should(QueryBuilders.matchQuery(&quot;name&quot;, &quot;西游记&quot;)); &#x2F;&#x2F;Or</span><br><span class="line">5.包裹查询</span><br><span class="line">高于设定分数, 不计算相关性</span><br><span class="line"></span><br><span class="line">        QueryBuilder queryBuilder &#x3D; QueryBuilders</span><br><span class="line">                .constantScoreQuery(QueryBuilders.matchQuery(&quot;name&quot;, &quot;西游记&quot;))</span><br><span class="line">                .boost(2.0f);</span><br><span class="line">6.范围查询</span><br><span class="line">查询id值在20-50之间的</span><br><span class="line"></span><br><span class="line">        QueryBuilder queryBuilder &#x3D; QueryBuilders.rangeQuery(&quot;id&quot;)</span><br><span class="line">                .from(&quot;20&quot;)</span><br><span class="line">                .to(&quot;50&quot;)</span><br><span class="line">                .includeLower(true)     &#x2F;&#x2F; 包含上界</span><br><span class="line">                .includeUpper(true);      &#x2F;&#x2F; 包含下届</span><br><span class="line">7.通配符查询</span><br><span class="line">通配符查询, 支持 * 匹配任何字符序列, 包括空</span><br><span class="line"></span><br><span class="line">避免* 开始, 会检索大量内容造成效率缓慢</span><br><span class="line"></span><br><span class="line">单个字符用?</span><br><span class="line"></span><br><span class="line">QueryBuilder queryBuilder &#x3D; QueryBuilders.wildcardQuery(&quot;user&quot;, &quot;ki*hy&quot;);</span><br><span class="line">8.过滤查询</span><br><span class="line">QueryBuilders.constantScoreQuery(FilterBuilders.termQuery(&quot;name&quot;, &quot;kimchy&quot;)).boost(2.0f);</span><br></pre></td></tr></table></figure>

























          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/03/07/ES%E5%8E%9F%E7%94%9F%E6%9F%A5%E8%AF%A2%E6%93%8D%E4%BD%9C%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/07/ES%E5%8E%9F%E7%94%9F%E6%9F%A5%E8%AF%A2%E6%93%8D%E4%BD%9C%E6%80%BB%E7%BB%93/" itemprop="url">ES原生查询操作总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-07T00:00:00+08:00">
                2019-03-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>ES的查询有query、URL两种方式，一种是通过REST请求URI发送检索参数，另一种是通过REST请求体发送检索参数。</p>
<h1 id="1、URL方式"><a href="#1、URL方式" class="headerlink" title="1、URL方式"></a>1、URL方式</h1><h2 id="1-1、语法"><a href="#1-1、语法" class="headerlink" title="1.1、语法"></a>1.1、语法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl [ -s][ -g][ -X&lt;REST Verb&gt;][ -H <span class="string">'Content-Type: application/json'</span>] <span class="string">'&lt;Node&gt;:&lt;Port&gt;/&lt;Index&gt;[/Type][/ID]/_search?pretty&amp;q=&lt;search string&gt;'</span></span><br></pre></td></tr></table></figure>

<p>　　-s 不输出查询的时间那些东西<br>　　-g 做转义用　　<br>　　<REST Verb>：REST风格的语法谓词，GET/POST/PUT<br>　　<Node>:节点ip，默认使用localhost<br>　　<port>:节点端口号，默认80，ES默认使用9200<br>　　<Index>:索引名，支持通配符，power_json*<br>　　<Type>:索引类型，由于一个index只有一个type，可不输入<br>　　<ID>:操作对象的ID号，可不输入<br>　　q  ：前面加&amp;，后跟查询语句   </p>
<h2 id="1-2、常用参数"><a href="#1-2、常用参数" class="headerlink" title="1.2、常用参数"></a>1.2、常用参数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">q ：查询字符串</span><br><span class="line">sort ：排序执行。 fieldName:asc&#x2F;fieldName:desc。fieldName可以是文档中的实际字段，也可以是特殊_score名称，表示基于分数的排序。可以有几个sort参数 。</span><br><span class="line">from ：从命中的索引开始返回。默认为0。</span><br><span class="line">size ：表示要返回的命中数。默认值为10。</span><br><span class="line">_source_include ：查询包含某些source字段的文档。</span><br><span class="line">_source_exclude ：查询不包含某些source字段的文档。</span><br><span class="line">timeout ：搜索超时，将搜索请求限制在指定的时间值内执行，默认为无超时。</span><br><span class="line">default_field ：默认为index.query.default_field，即未指定字段前缀时返回所有字段，索引设置为*</span><br><span class="line">default_operator ：默认查询运算符，未指定时默认为OR。</span><br><span class="line">analyzer ：用于分析查询字符串的分析器名称。</span><br><span class="line">_source ：设置为false禁用_source字段检索。</span><br><span class="line">analyze_wildcard ：是否应分析通配符和前缀查询,默认为false</span><br><span class="line">status:active ：where the status field contains active  ——（status相当于fieldname,active相当于值——&gt;TESTID：39232032303039,由于&#x3D;被用在了前面“q&#x3D;”,所以这里用“：”代替了“&#x3D;”）</span><br><span class="line">title:(quick OR brown) ——where the title field contains quick or brown. If you omit the OR operator the default operator will be used</span><br><span class="line">author:&quot;John Smith&quot;——where the author field contains the exact phrase &quot;john smith&quot;</span><br><span class="line">_exists_:title——where the field title has any non-null value</span><br><span class="line">date:[2012-01-01 TO 2012-12-31]——All days in 2012</span><br><span class="line">count:[10 TO *]——Numbers from 10 upwards</span><br><span class="line">count:&gt;&#x3D;10——Numbers from 10 upwards</span><br></pre></td></tr></table></figure>
<h2 id="1-3、示例"><a href="#1-3、示例" class="headerlink" title="1.3、示例"></a>1.3、示例</h2><p>** 基本操作 ** </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">#创建索引</span><br><span class="line">PUT &#x2F;mydemo_01</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">        &quot;index&quot; : &#123;</span><br><span class="line">            &quot;number_of_shards&quot; : 3, </span><br><span class="line">            &quot;number_of_replicas&quot; : 2 </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">#索引的分片数为3，备份数为2</span><br><span class="line"></span><br><span class="line">GET &#x2F;mydemo_01</span><br><span class="line"></span><br><span class="line">#创建文档  &#x2F;索引&#x2F;类型&#x2F;ID  如果没有id会自动生成id</span><br><span class="line">PUT &#x2F;mydemo_01&#x2F;user&#x2F;3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;hu&quot;,</span><br><span class="line">  &quot;idcard&quot;:&quot;2430&quot;,</span><br><span class="line">  &quot;age&quot;:24</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET &#x2F;mydemo_01&#x2F;user&#x2F;1 </span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 1, #耗时</span><br><span class="line">  &quot;timed_out&quot;: false,#是否超时</span><br><span class="line">  &quot;_shards&quot;: &#123;	</span><br><span class="line">    &quot;total&quot;: 3,	#查询了多少分片</span><br><span class="line">    &quot;successful&quot;: 3,</span><br><span class="line">    &quot;skipped&quot;: 0,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot;: &#123;#命中结果</span><br><span class="line">    &quot;total&quot;: 1,#命中数</span><br><span class="line">    &quot;max_score&quot;: 0.2876821,#最高得分</span><br><span class="line">    &quot;hits&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;mydemo_01&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;3&quot;,</span><br><span class="line">        &quot;_score&quot;: 0.2876821,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;hu&quot;,</span><br><span class="line">          &quot;idcard&quot;: &quot;2430&quot;,</span><br><span class="line">          &quot;age&quot;: 24</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#删除文档</span><br><span class="line">DELETE &#x2F;mydemo_01&#x2F;user&#x2F;2?pretty</span><br><span class="line"></span><br><span class="line">#删除索引</span><br><span class="line">DELETE &#x2F;mydemo_01</span><br><span class="line"></span><br><span class="line">#查数据</span><br><span class="line">GET &#x2F;mydemo_01&#x2F;_search</span><br><span class="line"></span><br><span class="line">GET &#x2F;mydemo_01?pretty</span><br></pre></td></tr></table></figure>
<p>** 查看节点情况 ** </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#查看node状态</span><br><span class="line">GET &#x2F;_cat&#x2F;nodes?v</span><br><span class="line"></span><br><span class="line">#查看集群健康状况　 s&#x3D;sort排序</span><br><span class="line">GET &#x2F;_cat&#x2F;health?v</span><br><span class="line">#查看索引，并以索引名字排序</span><br><span class="line">GET &#x2F;_cat&#x2F;indices?v&amp;s&#x3D;index</span><br><span class="line"></span><br><span class="line">#只看mydemo_01索引，并以索引名字排序</span><br><span class="line">GET &#x2F;_cat&#x2F;indices&#x2F;mydemo_01*?v&amp;s&#x3D;index</span><br><span class="line"></span><br><span class="line">#查询索引的具体记录信息  #pretty表示返回漂亮打印的JSON结果</span><br><span class="line">GET &#x2F;mydemo_01*?pretty </span><br><span class="line"></span><br><span class="line">GET &#x2F;_cat&#x2F;indices?v&amp;s&#x3D;index&#39;        &#x2F;&#x2F;查看索引，并以索引名字排序（s&#x3D;sort）</span><br><span class="line"></span><br><span class="line">#查看所有索引</span><br><span class="line">http:&#x2F;&#x2F;localhost:9200&#x2F;_cat&#x2F;indices?v</span><br><span class="line"></span><br><span class="line">#disk.percent显示占用的硬盘空间</span><br><span class="line">GET &#x2F;_cat&#x2F;allocation?v&amp;s&#x3D;node</span><br></pre></td></tr></table></figure>
<ul>
<li>Green - everything is good (cluster is fully functional)，即最佳状态</li>
<li>Yellow - all data is available but some replicas are not yet allocated (cluster is fully functional)，即数据和集群可用，但是集群的备份有的是坏的</li>
<li>Red - some data is not available for whatever reason (cluster is partially functional)，即数据和集群都不可用</li>
</ul>
<p>结果解释：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">heap.percent：堆内存，1&#x2F;2最大内存-1和31之间取较小的值，高的话就是ES集群负担比较重，解决：关闭一些索引（阈值差不多可以定在80左右）后会释放一部分heap.percent，但不会释放disk.percent</span><br><span class="line">ram.percent：一直挺高，物理内存的使用情况，Lucene会将闲置的内存都占用做cache，如果有应用使用内存时，cache会被释放出来</span><br><span class="line">cpu：一般不会很高，5以下吧，如果有很多query的话会高，如果一直高释放不掉可能查询语句有问题</span><br><span class="line">node.role：【mdi】master  data  i查询接口（可否在节点上查询）</span><br></pre></td></tr></table></figure>

<p>** 数据查询 **</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;mydemo_01*&#x2F;_search?pretty&amp;q&#x3D;_exists_:name #查指定字段是否存在</span><br><span class="line">GET &#x2F;mydemo_01*&#x2F;_search?pretty&amp;q&#x3D;name:hu&amp;size&#x3D;3 #查指定字段值显示3个</span><br><span class="line">#如果在浏览器中可以直接http:&#x2F;&#x2F;127.0.0.1:9200&#x2F;mydemo_01*&#x2F;_search?pretty&amp;q&#x3D;name:hu&amp;size&#x3D;3</span><br><span class="line"></span><br><span class="line">GET &#x2F;mydemo_01*&#x2F;_search?pretty&amp;q&#x3D;name:hu&amp;from&#x3D;2&amp;size&#x3D;3 #从第3个开始只显示3个</span><br><span class="line">GET &#x2F;mydemo_01*&#x2F;_search?pretty&amp;sort&#x3D;id:desc # 排序desc降序，默认为升序</span><br><span class="line">GET &#x2F;mydemo_01*&#x2F;_search?pretty&amp;analyze_wildcard&amp;q&#x3D;idcard:12 #模糊查询</span><br><span class="line">GET &#x2F;mydemo_01*&#x2F;_search?pretty&amp;q&#x3D;age:&lt;22 #比较大小 </span><br><span class="line">GET &#x2F;mydemo_01*&#x2F;_search?pretty&amp;q&#x3D;age[10 TO 30] #范围 </span><br><span class="line">GET &#x2F;mydemo_01*&#x2F;_search?pretty&amp;_source&#x3D;false #是否显示 </span><br><span class="line">GET &#x2F;mydemo_01*&#x2F;_search?pretty&amp;_source_includes&#x3D;name,idcard #查询包含的字段</span><br><span class="line">GET &#x2F;mydemo_01*&#x2F;_search?pretty&amp;q&#x3D;(name:hu AND idcard:243) #组合查询</span><br><span class="line"></span><br><span class="line">#查询多个索引（index），多个类型（type）</span><br><span class="line">GET &#x2F;mydemo_01,demo&#x2F;_search?q&#x3D;name:hu</span><br><span class="line"></span><br><span class="line">#还可以指定类型参数，例如</span><br><span class="line">GET &#x2F;mydemo_01&#x2F;user,fdf&#x2F;_search?q&#x3D;name:hu</span><br><span class="line">#由于类型在未来的版本中将被移除，所以这种用法也不那么重要了。</span><br><span class="line"></span><br><span class="line">#或者要在全部的索引中查询</span><br><span class="line">GET &#x2F;_all&#x2F;_search?q&#x3D;name:hu</span><br><span class="line"></span><br><span class="line">或者</span><br><span class="line"></span><br><span class="line">#多索引（搜索存在于所有索引或一些特定索引中的文档）</span><br><span class="line">GET &#x2F;_search?q&#x3D;name:huangxiaoming</span><br><span class="line"></span><br><span class="line">#多类型（搜索所有类型或某种指定类型的索引中搜索所有文档）</span><br><span class="line">GET &#x2F;mydemo_01&#x2F;_search?q&#x3D;age:100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#关闭和打开索引</span><br><span class="line"></span><br><span class="line">POST &#x2F;mydemo_01&#x2F;_close</span><br><span class="line">POST &#x2F;mydemo_01&#x2F;_open</span><br><span class="line"></span><br><span class="line">#删除符合条件的记录</span><br><span class="line"></span><br><span class="line">POST &#x2F;mydemo_01*&#x2F;_delete_by_query?pretty&amp;q&#x3D;name:zhangsanfeng</span><br><span class="line"></span><br><span class="line">#查询多个Id</span><br><span class="line">GET &#x2F;mydemo_01&#x2F;user&#x2F;_mget</span><br><span class="line">&#123;</span><br><span class="line">  &quot;ids&quot;:[1,3,2,4]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#为了保持_version与外部版本控制的数值一致，使用version_type&#x3D;external检查数据当前的version值是否小于请求中的version值</span><br><span class="line">#查询指定版本数据</span><br><span class="line"></span><br><span class="line">PUT &#x2F;mydemo_01&#x2F;user&#x2F;3?version&#x3D;2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;huv2&quot;,</span><br><span class="line">  &quot;idcard&quot;:&quot;2430&quot;,</span><br><span class="line">  &quot;age&quot;:24</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET &#x2F;mydemo_01&#x2F;user&#x2F;3?version&#x3D;2</span><br></pre></td></tr></table></figure>
<p>** 批量操作 **<br>Elasticsearch还可以使用_bulk API批量执行上述任何操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#同时更新两个文档</span><br><span class="line">POST &#x2F;mydemo_01&#x2F;user&#x2F;_bulk?pretty</span><br><span class="line"> &#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;1&quot;&#125;&#125;</span><br><span class="line"> &#123;&quot;name&quot;: &quot;xiaoming1&quot; &#125;</span><br><span class="line"> &#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;3&quot;&#125;&#125;</span><br><span class="line"> &#123;&quot;name&quot;: &quot;xiaoming2&quot; &#125;</span><br><span class="line"></span><br><span class="line">GET &#x2F;mydemo_01&#x2F;_search</span><br><span class="line">#更新第一个文档（ID为1），删除第二个文档（ID为2）</span><br><span class="line">POST &#x2F;mydemo_01&#x2F;user&#x2F;_bulk?pretty</span><br><span class="line">&#123;&quot;update&quot;:&#123;&quot;_id&quot;:&quot;1&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;doc&quot;: &#123; &quot;name&quot;: &quot;chas&quot; &#125; &#125;</span><br><span class="line">&#123;&quot;delete&quot;:&#123;&quot;_id&quot;:&quot;2&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h1 id="2、结构化查询（DSL）"><a href="#2、结构化查询（DSL）" class="headerlink" title="2、结构化查询（DSL）"></a>2、结构化查询（DSL）</h1><p><img src="https://img.huyunshun.com/img1/Elasticsearch/imgclidfdfpsasfasfasfsf.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;mydemo_01&#x2F;user&#x2F;_search</span><br><span class="line">#精确查询</span><br><span class="line">#Term查询不会对字段进行分词查询，会采用精确匹配。</span><br><span class="line">GET &#x2F;mydemo_01&#x2F;user&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &quot;宋小明&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">#term是代表完全匹配，即不进行分词器分析，文档中必须包含整个搜索的词汇</span><br><span class="line"></span><br><span class="line">#模糊查询</span><br><span class="line">#Match会根据该字段的分词器，进行分词查询。</span><br><span class="line">GET &#x2F;mydemo_01&#x2F;user&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;from&quot;: 0,</span><br><span class="line">  &quot;size&quot;: 2, </span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">       &quot;name&quot;: &quot;明&quot;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#filter过滤查询</span><br><span class="line">GET &#x2F;mydemo_01&#x2F;user&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;bool&quot;: &#123;</span><br><span class="line">            &quot;must&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;match_all&quot;: &#123;</span><br><span class="line">                        </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            &quot;filter&quot;: &#123;</span><br><span class="line">                &quot;range&quot;: &#123;</span><br><span class="line">                    &quot;age&quot;: &#123;</span><br><span class="line">                        &quot;gt&quot;: 10,</span><br><span class="line">                        &quot;lte&quot;: 20</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;from&quot;: 0,</span><br><span class="line">    &quot;size&quot;: 10,</span><br><span class="line">    &quot;_source&quot;: [</span><br><span class="line">        &quot;name&quot;,</span><br><span class="line">        &quot;age&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






































          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/03/05/ES%E5%9C%A8docker%E4%B8%AD%E9%83%A8%E7%BD%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/05/ES%E5%9C%A8docker%E4%B8%AD%E9%83%A8%E7%BD%B2/" itemprop="url">ES在docker中部署</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-05T00:00:00+08:00">
                2019-03-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="部署Elasticsearch"><a href="#部署Elasticsearch" class="headerlink" title="部署Elasticsearch"></a>部署Elasticsearch</h5><p>拉取部署Elasticsearch：   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.elastic.co&#x2F;elasticsearch&#x2F;elasticsearch:7.3.0</span><br></pre></td></tr></table></figure>
<p>运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\hua&gt; docker run -d --name Elasticsearch-7.3 -p 9200:9200 -p 9300:9300 -e &quot;discovery.type&#x3D;single-node&quot; docker.elastic.co&#x2F;elasticsearch&#x2F;elasticsearch:7.3.0</span><br><span class="line">0c93badc5f5f3474e79ebd5711e4173a8492c5cc66a39540be44db0f5a5e0d0d</span><br></pre></td></tr></table></figure>
<p>配置跨域：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\hua&gt; docker exec -it Elasticsearch-7.3 &#x2F;bin&#x2F;bash</span><br><span class="line">[root@0c93badc5f5f elasticsearch]# ls</span><br><span class="line">LICENSE.txt  NOTICE.txt  README.textile  bin  config  data  jdk  lib  logs  modules  plugins</span><br><span class="line"></span><br><span class="line">[root@0c93badc5f5f elasticsearch]# cd config&#x2F;</span><br><span class="line">[root@0c93badc5f5f config]# ll</span><br><span class="line">total 28</span><br><span class="line">-rw-rw---- 1 elasticsearch root  199 Aug 14 05:42 elasticsearch.keystore</span><br><span class="line">-rw-r--r-- 1 elasticsearch root   53 Jul 24 18:32 elasticsearch.yml</span><br><span class="line">-rw-rw---- 1 elasticsearch root 3524 Jul 24 18:26 jvm.options</span><br><span class="line">-rw-r--r-- 1 elasticsearch root 7543 Jul 24 18:32 log4j2.properties</span><br><span class="line">-rw-rw---- 1 elasticsearch root  473 Jul 24 18:32 role_mapping.yml</span><br><span class="line">-rw-rw---- 1 elasticsearch root  197 Jul 24 18:32 roles.yml</span><br><span class="line">-rw-rw---- 1 elasticsearch root    0 Jul 24 18:32 users</span><br><span class="line">-rw-rw---- 1 elasticsearch root    0 Jul 24 18:32 users_roles</span><br><span class="line">[root@0c93badc5f5f config]# vi elasticsearch.yml</span><br><span class="line"></span><br><span class="line"># 加入跨域配置</span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br><span class="line"></span><br><span class="line">#保存退出</span><br><span class="line">[root@0c93badc5f5f config]# exit</span><br><span class="line">exit</span><br><span class="line">#重启</span><br><span class="line">PS C:\Users\hua&gt; docker restart Elasticsearch-7.3</span><br><span class="line">Elasticsearch-7.3</span><br></pre></td></tr></table></figure>
<p>浏览，<a href="http://127.0.0.1:9200/" target="_blank" rel="noopener">http://127.0.0.1:9200/</a>   ：    </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span> : <span class="string">"0c93badc5f5f"</span>,</span><br><span class="line">  <span class="attr">"cluster_name"</span> : <span class="string">"docker-cluster"</span>,</span><br><span class="line">  <span class="attr">"cluster_uuid"</span> : <span class="string">"C1imvsbpT36iC98Yd2nEyQ"</span>,</span><br><span class="line">  <span class="attr">"version"</span> : &#123;</span><br><span class="line">    <span class="attr">"number"</span> : <span class="string">"7.3.0"</span>,</span><br><span class="line">    <span class="attr">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="attr">"build_type"</span> : <span class="string">"docker"</span>,</span><br><span class="line">    <span class="attr">"build_hash"</span> : <span class="string">"de777fa"</span>,</span><br><span class="line">    <span class="attr">"build_date"</span> : <span class="string">"2019-07-24T18:30:11.767338Z"</span>,</span><br><span class="line">    <span class="attr">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"lucene_version"</span> : <span class="string">"8.1.0"</span>,</span><br><span class="line">    <span class="attr">"minimum_wire_compatibility_version"</span> : <span class="string">"6.8.0"</span>,</span><br><span class="line">    <span class="attr">"minimum_index_compatibility_version"</span> : <span class="string">"6.0.0-beta1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="部署kibana"><a href="#部署kibana" class="headerlink" title="部署kibana"></a>部署kibana</h5><p>拉取：   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.elastic.co&#x2F;kibana&#x2F;kibana:7.3.0</span><br></pre></td></tr></table></figure>
<p>部署：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\hua&gt; docker run --name kibana-7.3 -d -p 5601:5601 --link Elasticsearch-7.3 -e &quot;ELASTICSEARCH_URL&#x3D;http:&#x2F;&#x2F;127.0.0.1:9200&quot; 8bcee4a4f79d</span><br><span class="line">071ee706a4a22b548c409d3ee06e1890a7ed5239a56a49a85449a140b6431745</span><br><span class="line">PS C:\Users\hua&gt; docker ps</span><br><span class="line">CONTAINER ID        IMAGE                                                 COMMAND                  CREATED             STATUS              PORTS                                            NAMES</span><br><span class="line">3443c83c30c4        8bcee4a4f79d                                          &quot;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;kiba…&quot;   32 seconds ago      Up 30 seconds       0.0.0.0:5601-&gt;5601&#x2F;tcp                           kibana-7.3</span><br><span class="line">0c93badc5f5f        docker.elastic.co&#x2F;elasticsearch&#x2F;elasticsearch:7.3.0   &quot;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;dock…&quot;   19 minutes ago      Up 8 minutes        0.0.0.0:9200-&gt;9200&#x2F;tcp, 0.0.0.0:9300-&gt;9300&#x2F;tcp   Elasticsearch-7.3</span><br><span class="line"></span><br><span class="line">#进入容器配置</span><br><span class="line">PS C:\Users\hua&gt; docker exec -it c69996736e3b &#x2F;bin&#x2F;bash                                                                                                                                                                                                                        </span><br><span class="line">bash-4.2$ vi config&#x2F;kibana.yml</span><br><span class="line"></span><br><span class="line">编辑 config\kibana.yml 配置文件，将配置项 elasticsearch.hosts 的地址改成 Elasticsearch 地址。不要使用 location、127.0.0.1 或者容器名:端口，这样是无法访问的，会造成 Kibana 的 [Kibana server is not ready yet] 错误。</span><br><span class="line">启动成功后访问 ip:5601 看到 Kibana 界面即表示安装成功。</span><br></pre></td></tr></table></figure>
<p>浏览：     <a href="http://192.168.6.238:5601" target="_blank" rel="noopener">http://192.168.6.238:5601</a> </p>
<p><img src="https://img.huyunshun.com/img1/Elasticsearch/imgclipdasdsfg3435.png" alt="">   </p>
<h5 id="部署Head"><a href="#部署Head" class="headerlink" title="部署Head"></a>部署Head</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\hua&gt; docker pull mobz&#x2F;elasticsearch-head:5</span><br><span class="line">PS C:\Users\hua&gt; docker run -di --name myhead -p 9100:9100 b19a5c98e43b</span><br><span class="line">85fc9db69f43cea485b0a61004a296469727847f4563260cf09a4561c89c8bea</span><br></pre></td></tr></table></figure>
<p><img src="https://img.huyunshun.com/img1/Elasticsearch/imgclip_1dasdsfg3435.png" alt=""></p>
<h5 id="Sense"><a href="#Sense" class="headerlink" title="Sense"></a>Sense</h5><p>Sense是一款Kibana应用。要启动并运行，首先需要下载Kibana并按照此处的说明进行安装。您将需要Kibana 4.2或更高版本。安装Kibana后，您可以从Kibana文件夹中运行Sense运行以下命令：</p>
<p>$./bin/kibana plugin –install elastic/sense</p>
<p>这将下载并安装最新版本的Sense。</p>
<p>你现在需要开始Kibana：</p>
<p>$ ./ bin / kibana<br>您现在应该可以使用http：// localhost：5601 / app / sense上的Web浏览器访问Sense （如果您在Kibana中以不同方式配置它们，则替换主机和端口）。</p>
<p>这里写图片描述</p>
<p>可以看到在内存为2G的主机上，Elasticsearch的运行内存为 -Xms256m -Xmx1g</p>
<h1 id="内存优化"><a href="#内存优化" class="headerlink" title="内存优化"></a>内存优化</h1><p>查看内存  ps -ef|grep elasticsearch<br>1、设置内存：指定ES_HEAP_SIZE环境变量。服务进程在启动时候会读取这个变量，并相应的设置堆的大小。设置命令：export ES_HEAP_SIZE=1g   </p>
<p>2、可以在启动程序时限制内存大小，并不是每个情况都可以成功的，命令行如下 ./elasticsearch -Xms256m -Xmx256m -d</p>
<p>备注: 设置时Xmx和Xms相同，目的是为了能够在java垃圾回收机制清理完堆区后不需要重新分隔计算堆区的大小而浪费资源，可以减轻伸缩堆大小带来的压力。 一般来说设置ES_HEAP_SIZE环境变量，比直接写-Xmx10g -Xms10g更好一点。</p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/03/04/%E9%85%8D%E7%BD%AEhead%E6%8F%92%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/04/%E9%85%8D%E7%BD%AEhead%E6%8F%92%E4%BB%B6/" itemprop="url">配置head插件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-04T00:00:00+08:00">
                2019-03-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前都安装好ES，接下来直接安装插件，安装head插件，必然是要先安装好nodejs和grunt才行。<br>（1）安装nodejs<br>（2）安装grunt：nodejs的目录下，输入指令：npm install -g grunt-cli<br>（3）配置head<br>进入<a href="https://github.com/mobz/elasticsearch-head地址，下载zip，解压head直接放在了D:\elasticsearch\elasticsearch-head-master" target="_blank" rel="noopener">https://github.com/mobz/elasticsearch-head地址，下载zip，解压head直接放在了D:\elasticsearch\elasticsearch-head-master</a><br>在head/Gruntfile.js里，添加一行 hostname: ‘*’   </p>
<p><img src="https://img.huyunshun.com/img1/Elasticsearch/imddddddddddddddddsfgclip.png" alt=""></p>
<p>在head/_site/app.js，把localhost修改成你es的服务器地址，如：this.base_uri = this.config.base_uri || this.prefs.get(“app-base_uri”) || “<a href="https://000:9200&quot;;非必须">https://000:9200&quot;;非必须</a>   </p>
<p>修改elasticsearch：D:\elasticsearch\elasticsearch-6.3.1\config\elasticsearch.yml里    </p>
<p>文件的最后添加<br>http.cors.enabled: true<br>http.cors.allow-origin: “*”   </p>
<p>修改配置(可略)   </p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#集群的名字 </span></span><br><span class="line"><span class="attr">cluster.name:</span>   <span class="string">es_cmazxiaoma_cluster</span></span><br><span class="line"><span class="comment">#节点名字   </span></span><br><span class="line"><span class="attr">node.name:</span>      <span class="string">node-1</span></span><br><span class="line"><span class="comment">#数据存储目录(多个路径)</span></span><br><span class="line"><span class="attr">path.data:</span>      <span class="string">/home/elasticsearch/data</span></span><br><span class="line"><span class="comment">#日志目录     </span></span><br><span class="line"><span class="attr">path.logs:</span>      <span class="string">/home/elasticsearch/logs</span></span><br><span class="line"><span class="comment">#本机的ip地址</span></span><br><span class="line"><span class="attr">network.host:</span>   <span class="number">192.168</span><span class="number">.12</span><span class="number">.6</span></span><br><span class="line"><span class="comment">#设置集群中master节点的初始列表，可以通过这些节点来自动发现新加入集群的节点</span></span><br><span class="line"><span class="attr">discovery.zen.ping.unicast.hosts:</span>       <span class="string">["192.168.12.6"]</span></span><br><span class="line"><span class="comment">#设置节点间tcp端口(集群)，默认9300</span></span><br><span class="line"><span class="attr">transport.tcp.port:</span>     <span class="number">9300</span></span><br><span class="line"><span class="comment">#监听端口(默认) </span></span><br><span class="line"><span class="attr">http.port:</span>      <span class="number">9200</span></span><br><span class="line"><span class="comment">#增加参数，使head插件可以访问es</span></span><br><span class="line"><span class="attr">http.cors.enabled:</span>      <span class="literal">true</span></span><br><span class="line"><span class="attr">http.cors.allow-origin:</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure>

<p>保存完毕之后，到bin目录下，双击“elasticsearch.bat”启动。</p>
<p>然后在cmd命令行里，转到head目录下，输入 npm install</p>
<p>会很慢，修改npm镜像：npm install -g cnpm –registry=<a href="https://registry.npm.taobao.org" target="_blank" rel="noopener">https://registry.npm.taobao.org</a></p>
<p>cnpm install</p>
<p>我初次运行报错了，但是重新输入指令，再运行下就好了。</p>
<p>然后还是head目录下，输入grunt server 启动nodejs，出现下面的提示，就启动成功。</p>
<p><a href="https://127.0.0.1:9100，正确浏览表示配置成功！">https://127.0.0.1:9100，正确浏览表示配置成功！</a></p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/8/">上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><a class="extend next" rel="next" href="/page/10/">下一页</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://img.huyunshun.com/img/20200522182348.png"
                alt="初晨" />
            
              <p class="site-author-name" itemprop="name">初晨</p>
              <p class="site-description motion-element" itemprop="description">永远不要说你知道本质，更别说真相了。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">249</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">46</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">109</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          
<!--近期文章版块-->
            
                <div class="links-of-blogroll motion-element links-of-blogroll-block">
                  <div class="links-of-blogroll-title">
                    <!-- modify icon to fire by szw -->
                    <i class="fa fa-history fa-" aria-hidden="true"></i>
                    近期文章
                  </div>
                  <ul class="links-of-blogroll-list">
                    
                    
                      <li>
                        <a href="/2020/05/22/WebSocket%E3%80%81Socket%E3%80%81TCP%E3%80%81HTTP%E5%8C%BA%E5%88%AB/" title="WebSocket、Socket、TCP、HTTP区别" target="_blank">WebSocket、Socket、TCP、HTTP区别</a>
                      </li>
                    
                      <li>
                        <a href="/2020/05/19/Springboot%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%8E%A5%E5%8F%A3%E9%98%B2%E5%88%B7/" title="Springboot项目的接口防刷" target="_blank">Springboot项目的接口防刷</a>
                      </li>
                    
                      <li>
                        <a href="/2020/05/03/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Volatile%E5%85%B3%E9%94%AE%E5%AD%97%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" title="深入理解Volatile关键字及其实现原理" target="_blank">深入理解Volatile关键字及其实现原理</a>
                      </li>
                    
                      <li>
                        <a href="/2020/04/20/%E4%BD%BF%E7%94%A8vscode%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0%E7%8E%AF%E5%A2%83/" title="使用vscode搭建个人笔记环境" target="_blank">使用vscode搭建个人笔记环境</a>
                      </li>
                    
                      <li>
                        <a href="/2020/01/20/HBase%E4%BB%8B%E7%BB%8D%E5%AE%89%E8%A3%85%E4%B8%8E%E6%93%8D%E4%BD%9C/" title="HBase介绍安装与操作" target="_blank">HBase介绍安装与操作</a>
                      </li>
                    
                  </ul>
                </div>
            
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Copyright</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  


</body>
</html>
