<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="永远不要说你知道本质，更别说真相了。">
<meta property="og:type" content="website">
<meta property="og:title" content="简">
<meta property="og:url" content="https://huyunshun.com/page/17/index.html">
<meta property="og:site_name" content="简">
<meta property="og:description" content="永远不要说你知道本质，更别说真相了。">
<meta property="article:author" content="初晨">
<meta property="article:tag" content="编程">
<meta property="article:tag" content="开发">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://huyunshun.com/page/17/"/>





  <title>简</title>
  








  <script type="text/javascript" src="/js/src/love.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">

  <!-- 看板娘 -->
    
        <script async src="/live2d-widget/autoload.js"></script>
    
 <!-- 飘动的彩带） -->
  <script src="/js/src/piao.js" type="text/javascript"></script>
<meta name="generator" content="Hexo 4.2.1"></head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">简</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">人生短暂，学海无边，而大道至简。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2018/04/05/%E7%BC%93%E5%AD%98Redis%20%E5%9C%A8%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E6%95%B4%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/05/%E7%BC%93%E5%AD%98Redis%20%E5%9C%A8%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E6%95%B4%E7%90%86/" itemprop="url">缓存Redis 在项目总结整理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-05T00:00:00+08:00">
                2018-04-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index">
                    <span itemprop="name">Redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="数据类型的运用"><a href="#数据类型的运用" class="headerlink" title="数据类型的运用"></a>数据类型的运用</h2><h3 id="string"><a href="#string" class="headerlink" title="string"></a>string</h3><ul>
<li>缓存数据<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">不管是简单和复杂的数据都可以直接转为string存储。</span><br><span class="line">商品信息，省市区信息，活动配置等一系列不常变化的冷数据缓存</span><br><span class="line">非常热门数据的缓存，游戏排行，后台每秒更新一次数据</span><br></pre></td></tr></table></figure></li>
<li>简单计数：活动参加人数</li>
<li>定时过期：一个人一天只能进行一次签到</li>
<li>分布式锁</li>
</ul>
<h3 id="list"><a href="#list" class="headerlink" title="list"></a>list</h3><ul>
<li>用户排队 push，pop</li>
<li>有序消息 push，pop</li>
<li>实现生产者和消费者模型，阻塞式访问 BRPOP 和 BLPOP 命令</li>
</ul>
<h3 id="set"><a href="#set" class="headerlink" title="set"></a>set</h3><ul>
<li>去重列表：活动参加人数</li>
<li>标签：用户标签，商家标签</li>
<li>交并补<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">春节活动一共有 abcde 5个任务，用户A已经完成a,b，用户B已经完成 c,d</span><br><span class="line"></span><br><span class="line">交集：用户A，用户B 都完成的任务</span><br><span class="line">并集：用户A，用户B 任一完成的任务</span><br><span class="line">差集：用户A还没有完成的任务</span><br></pre></td></tr></table></figure></li>
<li>获取随机元素：从礼品库 set 中随机获得一个礼品</li>
</ul>
<h3 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h3><p>同一资源的不同属性，如：用户在一共获得了不同种类奖品数量。可以对单个奖品直接更新操作。</p>
<h3 id="zset"><a href="#zset" class="headerlink" title="zset"></a>zset</h3><ul>
<li>排行榜：商品收藏排行，点赞排行等</li>
<li>根据分数获取 top 10</li>
<li>查询某个用户的分数：查询 得分在90-100 之间的用户</li>
</ul>
<p>有时候我们的得分并不是由某一项业务值决定的，可能是由两项业务值来排序的，比如先看用户的实际得分，在看用户等级，那么我们在设计score的时候可以用小数点之前的值表示得分，小数点之后的值表示等级，如果有其他特殊要求，还可以考虑得分加上某个极大值来处理。</p>
<p>注意事项</p>
<ol>
<li><p>每个 key 都应该有合理的失效时间</p>
</li>
<li><p>string的过期时间在重新设值后会被覆盖</p>
</li>
<li><p>string类型的 set 操作可以覆盖类型</p>
</li>
<li><p>合理使用相应的数据结构</p>
</li>
<li><p>不要用list存大量数据并检索</p>
</li>
<li><p>合理规划 key 的数量：判断用户有没有参加应该用set，不应该每个用户一个key</p>
</li>
<li><p>业务数据隔离 用户 redis 业务 redis 活动 redis 应该做区分，活动的 redis 在活动结束后可以自由清理</p>
</li>
<li><p>合理使用管道，lua 脚本和 redis 事务，提高性能，尤其是在脚本中使用 redis 的时候</p>
</li>
<li><p>在有大量 key 的 Reids 线上系统，要在主库禁用 keys * 操作，防止卡死</p>
</li>
</ol>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2018/04/05/Redis-%E4%BD%BF%E7%94%A8Jedis%E6%93%8D%E4%BD%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/05/Redis-%E4%BD%BF%E7%94%A8Jedis%E6%93%8D%E4%BD%9C/" itemprop="url">Redis-使用Jedis操作</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-05T00:00:00+08:00">
                2018-04-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index">
                    <span itemprop="name">Redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Jedis提供了JedisPool这个类作为对Jedis的连接池，同时使用了Apache的通用对象池工具common-pool作为资源的管理工具，下面是使用JedisPool操作Redis的代码示例：</p>
<p><strong>1.Jedis连接池（通常JedisPool是单例的）</strong></p>
<pre><code>GenericObjectPoolConfig poolConfig = new GenericObjectPoolConfig();
JedisPool jedisPool = new JedisPool(poolConfig, &quot;127.0.0.1&quot;, 6379);</code></pre><p><strong>2.获取Jedis对象不再是直接生成一个Jedis对象，而是直接从连接池里获取</strong></p>
<p>示例代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">   <span class="comment">// 1. 从连接池获取 jedis 对象</span></span><br><span class="line">   jedis = jedisPool.getResource();</span><br><span class="line">   <span class="comment">// 2. 执行操作</span></span><br><span class="line">   jedis.get(<span class="string">"hello"</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">   <span class="comment">// 如果使用 JedisPool ， close 操作不是关闭连接，代表归还连接池</span></span><br><span class="line">   jedis.close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里可以看到在finally中依然是jedis.close（）操作，为什么会把连接关闭呢，这不和连接池的原则违背了吗？但实际上Jedis的close（）实现方式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 使用 Jedis 连接池</span></span><br><span class="line">   <span class="keyword">if</span> (dataSource != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (client.isBroken()) &#123;</span><br><span class="line">                                   <span class="keyword">this</span>.dataSource.returnBrokenResource(<span class="keyword">this</span>);</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                   <span class="keyword">this</span>.dataSource.returnResource(<span class="keyword">this</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="comment">// 直连</span></span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   client.close();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参数说<br>    dataSource！=null代表使用的是连接池，所以jedis.close（）代表归还        连接给连接池，而且Jedis会判断当前连接是否已经断开。<br>    dataSource=null代表直连，jedis.close（）代表关闭连接。</p>
<pre><code>前面GenericObjectPoolConfig使用的是默认配置，实际它提供有很多参数，例如池子中最大连接数、最大空闲连接数、最小空闲连接数、连接活性检测，等等，例如下面代码：
GenericObjectPoolConfig poolConfig = new GenericObjectPoolConfig();
// 设置最大连接数为默认值的 5 倍
poolConfig.setMaxTotal(GenericObjectPoolConfig.DEFAULT_MAX_TOTAL * 5);
// 设置最大空闲连接数为默认值的 3 倍
poolConfig.setMaxIdle(GenericObjectPoolConfig.DEFAULT_MAX_IDLE * 3);
// 设置最小空闲连接数为默认值的 2 倍
poolConfig.setMinIdle(GenericObjectPoolConfig.DEFAULT_MIN_IDLE * 2);
// 设置开启 jmx 功能
poolConfig.setJmxEnabled(true);
// 设置连接池没有连接后客户端的最大等待时间 ( 单位为毫秒 )
poolConfig.setMaxWaitMillis(3000);</code></pre><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Jedis <span class="title">getRedisConnect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   GenericObjectPoolConfig poolConfig = <span class="keyword">new</span> GenericObjectPoolConfig();</span><br><span class="line">   <span class="comment">// 设置最大连接数为默认值的 5 倍</span></span><br><span class="line">   poolConfig.setMaxTotal(GenericObjectPoolConfig.DEFAULT_MAX_TOTAL * <span class="number">5</span>);</span><br><span class="line">   <span class="comment">// 设置最大空闲连接数为默认值的 3 倍</span></span><br><span class="line">   poolConfig.setMaxIdle(GenericObjectPoolConfig.DEFAULT_MAX_IDLE * <span class="number">3</span>);</span><br><span class="line">   <span class="comment">// 设置最小空闲连接数为默认值的 2 倍</span></span><br><span class="line">   poolConfig.setMinIdle(GenericObjectPoolConfig.DEFAULT_MIN_IDLE * <span class="number">2</span>);</span><br><span class="line">   <span class="comment">// 设置开启 jmx 功能</span></span><br><span class="line">   poolConfig.setJmxEnabled(<span class="keyword">true</span>);</span><br><span class="line">   <span class="comment">// 设置连接池没有连接后客户端的最大等待时间 ( 单位为毫秒 )</span></span><br><span class="line">   poolConfig.setMaxWaitMillis(<span class="number">3000</span>);</span><br><span class="line">   JedisPool jedisPool = <span class="keyword">new</span> JedisPool(poolConfig, <span class="string">"127.0.0.1"</span>, <span class="number">6379</span>);</span><br><span class="line">   Jedis jedis = jedisPool.getResource();</span><br><span class="line">   <span class="keyword">return</span> jedis;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Demo</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">maven项目</span><br><span class="line">pom.xml</span><br><span class="line">       <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Java demo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo01</span> </span>&#123;</span><br><span class="line">       <span class="meta">@Test</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRedis</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">               Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">"192.168.18.140"</span>,<span class="number">6379</span>);</span><br><span class="line">               List&lt;String&gt; list = jedis.mget(<span class="string">"user"</span>);</span><br><span class="line">               <span class="keyword">for</span> (String string : list) &#123;</span><br><span class="line">                       System.out.println(string);</span><br><span class="line">               &#125;</span><br><span class="line">jedis.close();</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>连接不到Redis，是因为在redis3.2之后，redis增加了protected-mode，在这个模式下，即使注释掉了bind 127.0.0.1，再访问redisd时候还是报错。</p>
<pre><code>#bind 127.0.0.1
protected-mode 修改为no
protected-mode no

测试没问题
zhangsanfeng
100</code></pre><p><strong>相关操作方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 连接redis ，redis的默认端口是6379</span></span><br><span class="line">Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">"ip"</span>, <span class="number">6379</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证密码，如果没有设置密码这段代码省略</span></span><br><span class="line">jedis.auth(<span class="string">"password"</span>);jedis.connect();<span class="comment">// 连接</span></span><br><span class="line">jedis.disconnect();<span class="comment">// 断开连接</span></span><br><span class="line"></span><br><span class="line">Set&lt;String&gt; keys = jedis.keys(<span class="string">"*"</span>); <span class="comment">// 列出所有的key</span></span><br><span class="line">Set&lt;String&gt; keys = jedis.keys(<span class="string">"key"</span>); <span class="comment">// 查找特定的key</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除给定的一个或多个key,如果key不存在,则忽略该命令.</span></span><br><span class="line">jedis.del(<span class="string">"key1"</span>);jedis.del(<span class="string">"key1"</span>,<span class="string">"key2"</span>,<span class="string">"key3"</span>,<span class="string">"key4"</span>,<span class="string">"key5"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除给定key的生存时间(设置这个key永不过期)</span></span><br><span class="line">jedis.persist(<span class="string">"key1"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//检查给定key是否存在</span></span><br><span class="line">jedis.exists(<span class="string">"key1"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将key改名为newkey,当key和newkey相同或者key不存在时,返回一个错误</span></span><br><span class="line">jedis.rename(<span class="string">"key1"</span>,<span class="string">"key2"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回key所储存的值的类型。</span></span><br><span class="line"><span class="comment">// none(key不存在),string(字符串),list(列表),set(集合),zset(有序集),hash(哈希表)</span></span><br><span class="line">jedis.type(<span class="string">"key1"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置key生存时间，当key过期时，它会被自动删除。</span></span><br><span class="line">jedis.expire(<span class="string">"key1"</span>,<span class="number">5</span>);<span class="comment">// 5秒过期</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 字符串值value关联到key。</span></span><br><span class="line">jedis.set(<span class="string">"key1"</span>,<span class="string">"value1"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将值value关联到key，并将key的生存时间设为seconds(秒)。</span></span><br><span class="line">jedis.setex(<span class="string">"foo"</span>,<span class="number">5</span>,<span class="string">"haha"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 清空所有的key</span></span><br><span class="line">jedis.flushAll();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回key的个数</span></span><br><span class="line">jedis.dbSize();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 哈希表key中的域field的值设为value。</span></span><br><span class="line">jedis.hset(<span class="string">"key1"</span>,<span class="string">"field1"</span>,<span class="string">"field1-value"</span>);jedis.hset(<span class="string">"key1"</span>,<span class="string">"field2"</span>,<span class="string">"field2-value"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Map map = <span class="keyword">new</span> HashMap();map.put(<span class="string">"field1"</span>,<span class="string">"field1-value"</span>);map.put(<span class="string">"field2"</span>,<span class="string">"field2-value"</span>);jedis.hmset(<span class="string">"key1"</span>,map);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回哈希表key中给定域field的值</span></span><br><span class="line">jedis.hget(<span class="string">"key1"</span>,<span class="string">"field1"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回哈希表key中给定域field的值(多个)</span></span><br><span class="line">List list = jedis.hmget(<span class="string">"key1"</span>,<span class="string">"field1"</span>,<span class="string">"field2"</span>);<span class="keyword">for</span>(</span><br><span class="line"><span class="keyword">int</span> i = <span class="number">0</span>;i&lt;list.size();i++)</span><br><span class="line">&#123;</span><br><span class="line">           System.out.println(list.get(i));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回哈希表key中所有域和值</span></span><br><span class="line">Map&lt;String, String&gt; map = jedis.hgetAll(<span class="string">"key1"</span>);<span class="keyword">for</span>(</span><br><span class="line">Map.Entry entry:map.entrySet())</span><br><span class="line">&#123;</span><br><span class="line">           System.out.print(entry.getKey() + <span class="string">":"</span> + entry.getValue() + <span class="string">"\t"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除哈希表key中的一个或多个指定域</span></span><br><span class="line">jedis.hdel(<span class="string">"key1"</span>,<span class="string">"field1"</span>);jedis.hdel(<span class="string">"key1"</span>,<span class="string">"field1"</span>,<span class="string">"field2"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 查看哈希表key中，给定域field是否存在。</span></span><br><span class="line">jedis.hexists(<span class="string">"key1"</span>,<span class="string">"field1"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回哈希表key中的所有域</span></span><br><span class="line">jedis.hkeys(<span class="string">"key1"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回哈希表key中的所有值</span></span><br><span class="line">jedis.hvals(<span class="string">"key1"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将值value插入到列表key的表头。</span></span><br><span class="line">jedis.lpush(<span class="string">"key1"</span>,<span class="string">"value1-0"</span>);jedis.lpush(<span class="string">"key1"</span>,<span class="string">"value1-1"</span>);jedis.lpush(<span class="string">"key1"</span>,<span class="string">"value1-2"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回列表key中指定区间内的元素,区间以偏移量start和stop指定.</span></span><br><span class="line"><span class="comment">// 下标(index)参数start和stop从0开始;</span></span><br><span class="line"><span class="comment">// 负数下标代表从后开始(-1表示列表的最后一个元素,-2表示列表的倒数第二个元素,以此类推)</span></span><br><span class="line">List list = jedis.lrange(<span class="string">"key1"</span>, <span class="number">0</span>, -<span class="number">1</span>);<span class="comment">// stop下标也在取值范围内(闭区间)</span></span><br><span class="line"><span class="keyword">for</span>(</span><br><span class="line"><span class="keyword">int</span> i = <span class="number">0</span>;i&lt;list.size();i++)</span><br><span class="line">&#123;</span><br><span class="line">           System.out.println(list.get(i));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回列表key的长度。</span></span><br><span class="line">jedis.llen(<span class="string">"key1"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将member元素加入到集合key当中。</span></span><br><span class="line">jedis.sadd(<span class="string">"key1"</span>,<span class="string">"value0"</span>);jedis.sadd(<span class="string">"key1"</span>,<span class="string">"value1"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除集合中的member元素。</span></span><br><span class="line">jedis.srem(<span class="string">"key1"</span>,<span class="string">"value1"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回集合key中的所有成员。</span></span><br><span class="line">Set set = jedis.smembers(<span class="string">"key1"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断元素是否是集合key的成员</span></span><br><span class="line">jedis.sismember(<span class="string">"key1"</span>,<span class="string">"value2"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回集合key的元素的数量</span></span><br><span class="line">jedis.scard(<span class="string">"key1"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回一个集合的全部成员，该集合是所有给定集合的交集</span></span><br><span class="line">jedis.sinter(<span class="string">"key1"</span>,<span class="string">"key2"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回一个集合的全部成员，该集合是所有给定集合的并集</span></span><br><span class="line">jedis.sunion(<span class="string">"key1"</span>,<span class="string">"key2"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回一个集合的全部成员，该集合是所有给定集合的差集</span></span><br><span class="line">jedis.sdiff(<span class="string">"key1"</span>,<span class="string">"key2"</span>);</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2018/04/05/mybaits%E5%BB%B6%E8%BF%9F%E5%8A%A0%E8%BD%BD%E5%92%8CInterceptor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/05/mybaits%E5%BB%B6%E8%BF%9F%E5%8A%A0%E8%BD%BD%E5%92%8CInterceptor/" itemprop="url">mybaits延迟加载和Interceptor</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-05T00:00:00+08:00">
                2018-04-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mybatis/" itemprop="url" rel="index">
                    <span itemprop="name">mybatis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="延迟加载"><a href="#延迟加载" class="headerlink" title="延迟加载"></a>延迟加载</h2><p>MyBatis中的延迟加载，也称为懒加载，是指在进行关联查询时，按照设置延迟规则推迟对关联对象的select查询。延迟加载可以有效的减少数据库压力。</p>
<h3 id="直接加载"><a href="#直接加载" class="headerlink" title="直接加载"></a>直接加载</h3><p>执行完对主加载对象的select语句，马上执行对关联对象的select查询。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 延迟加载总开关 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"lazyLoadingEnabled"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="侵入式延迟"><a href="#侵入式延迟" class="headerlink" title="侵入式延迟"></a>侵入式延迟</h3><p>执行对主加载对象的查询时，不会执行对关联对象的查询。但当要访问主加载对象的详情时，就会马上执行关联对象的select查询。即对关联对象的查询执行，侵入到了主加载对象的详情访问中。也可以这样理解：将关联对象的详情侵入到了主加载对象的详情中，即将关联对象的详情作为主加载对象的详情的一部分出现了。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 延迟加载总开关 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"lazyLoadingEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 侵入式延迟加载开关 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"aggressiveLazyLoading"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="深度延迟"><a href="#深度延迟" class="headerlink" title="深度延迟"></a>深度延迟</h3><p>执行对主加载对象的查询时，不会执行对关联对象的查询。访问主加载对象的详情时也不会执行关联对象的select查询。只有当真正访问关联对象的详情时，才会执行对关联对象的select查询。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 延迟加载总开关 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"lazyLoadingEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 侵入式延迟加载开关 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"aggressiveLazyLoading"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Interceptor（转）"><a href="#Interceptor（转）" class="headerlink" title="Interceptor（转）"></a>Interceptor（转）</h2><h3 id="Mybatis核心对象"><a href="#Mybatis核心对象" class="headerlink" title="Mybatis核心对象"></a>Mybatis核心对象</h3><ul>
<li>Configuration 初始化基础配置，比如MyBatis的别名等，一些重要的类型对象，如，插件，映射器，ObjectFactory和typeHandler对象，MyBatis所有的配置信息都维持在Configuration对象之中</li>
<li>SqlSessionFactory  SqlSession工厂</li>
<li>SqlSession 作为MyBatis工作的主要顶层API，表示和数据库交互的会话，完成必要数据库增删改查功能</li>
<li>Executor MyBatis执行器，是MyBatis 调度的核心，负责SQL语句的生成和查询缓存的维护</li>
<li>StatementHandler   封装了JDBC Statement操作，负责对JDBC statement 的操作，如设置参数、将Statement结果集转换成List集合。</li>
<li>ParameterHandler   负责对用户传递的参数转换成JDBC Statement 所需要的参数，</li>
<li>ResultSetHandler    负责将JDBC返回的ResultSet结果集对象转换成List类型的集合；</li>
<li>TypeHandler          负责java数据类型和jdbc数据类型之间的映射和转换</li>
<li>MappedStatement   MappedStatement维护了一条&lt;select|update|delete|insert&gt;节点的封装， </li>
<li>SqlSource            负责根据用户传递的parameterObject，动态地生成SQL语句，将信息封装到BoundSql对象中，并返回</li>
<li>BoundSql 表示动态生成的SQL语句以及相应的参数信息</li>
</ul>
<h3 id="MyBatis-拦截器原理实现"><a href="#MyBatis-拦截器原理实现" class="headerlink" title="MyBatis 拦截器原理实现"></a>MyBatis 拦截器原理实现</h3><p>Mybatis支持对Executor、StatementHandler、PameterHandler和ResultSetHandler 接口进行拦截，也就是说会对这4种对象进行代理。</p>
<p><img src="https://img.huyunshun.com/img/20200410094537.png" alt="20200410094537"></p>
<p><a href="https://blog.csdn.net/weixin_39494923/article/details/91534658" target="_blank" rel="noopener">https://blog.csdn.net/weixin_39494923/article/details/91534658</a></p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2018/04/05/mybatis%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/05/mybatis%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" itemprop="url">mybatis简单环境搭建例子</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-05T00:00:00+08:00">
                2018-04-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mybatis/" itemprop="url" rel="index">
                    <span itemprop="name">mybatis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="MyBatis-简介"><a href="#MyBatis-简介" class="headerlink" title="MyBatis  简介"></a>MyBatis  简介</h3><pre><code>Mybatis 开源免费框架，原名叫iBatis，2010在google code，2013年迁移到 github是数据访问层框架，底层是对 JDBC 的封装。不需要编写实现类，只需要写需要执行的 sql 命令。</code></pre><h3 id="导入包"><a href="#导入包" class="headerlink" title="导入包"></a>导入包</h3><p><img src="https://img.huyunshun.com/img/20200401092549.png" alt="20200401092549"></p>
<h3 id="在-src-下新建全局配置文件-编写-JDBC连接信息"><a href="#在-src-下新建全局配置文件-编写-JDBC连接信息" class="headerlink" title="在 src 下新建全局配置文件(编写 JDBC连接信息)"></a>在 src 下新建全局配置文件(编写 JDBC连接信息)</h3><p>在全局配置文件中引入 DTD 或 schema 如果导入 dtd 后没有提示Window–&gt; preference –&gt; XML –&gt; XMl catalog –&gt; add 按钮。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Config 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- 默认当前所使用的环境 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"default"</span>&gt;</span></span><br><span class="line">               <span class="comment">&lt;!-- 声明可以使用的环境 --&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"default"</span>&gt;</span></span><br><span class="line">                       <span class="comment">&lt;!-- 使用原生态JDBC事务 --&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>&gt;</span><span class="tag">&lt;/<span class="name">transactionManager</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></span><br><span class="line">                               <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">                               <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/ssm"</span>/&gt;</span></span><br><span class="line">                               <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">                               <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"123456"</span>/&gt;</span></span><br><span class="line">                       <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"com/hu/mapper/UserMapper.xml"</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><transactionManager/> type 属性可取值JDBC事务管理使用 JDBC 原生事务管理方式MANAGED 把事务管理转交给其他容器，相当于把JDBC 事务setAutoMapping(false);</p>
<p><dataSouce/>type 属性       POOLED 使用数据库连接池       UNPOOLED 不实用数据库连接池,和直接使用 JDBC 一样</p>
<h3 id="新建以-mapper-结尾的包-在包下新建-实体类名-Mapper-xml"><a href="#新建以-mapper-结尾的包-在包下新建-实体类名-Mapper-xml" class="headerlink" title="新建以 mapper 结尾的包,在包下新建:实体类名+Mapper.xml"></a>新建以 mapper 结尾的包,在包下新建:实体类名+Mapper.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span></span></span><br><span class="line"><span class="meta"> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- namespace 理解成实现类的全路径（包名+类名） --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.hu.mapper.UserMapper"</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">               id:方法名</span></span><br><span class="line"><span class="comment">               parameterType:定义参数类型</span></span><br><span class="line"><span class="comment">               resultType:返回值类型</span></span><br><span class="line"><span class="comment">               </span></span><br><span class="line"><span class="comment">               如果方法返回值是List，在resultType中写List的泛型，因为MyBatis是对JDBC封装，一行一行读取数据。</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectAll"</span> <span class="attr">resultType</span>=<span class="string">"com.hu.pojo.User"</span>&gt;</span></span><br><span class="line">               select * from user</span><br><span class="line">       <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectById"</span> <span class="attr">resultType</span>=<span class="string">"int"</span>&gt;</span></span><br><span class="line">               select count(*) from user</span><br><span class="line">       <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectAllMap"</span> <span class="attr">resultType</span>=<span class="string">"com.hu.pojo.User"</span>&gt;</span></span><br><span class="line">               select * from user</span><br><span class="line">       <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1</span> </span>&#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">               InputStream inputStream = Resources.getResourceAsStream(<span class="string">"mybatis.xml"</span>);</span><br><span class="line">               <span class="comment">//使用了工厂设计模式    实例化工厂对象用了构建者设计模式。</span></span><br><span class="line">               <span class="comment">//构建者设计模式的意义：简化对象实例化过程。</span></span><br><span class="line">               SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</span><br><span class="line">               SqlSession session = sqlSessionFactory.openSession();<span class="comment">//生产SqlSession</span></span><br><span class="line">               <span class="comment">//获得list</span></span><br><span class="line">               List&lt;User&gt; users = session.selectList(<span class="string">"com.hu.mapper.UserMapper.selectAll"</span>);</span><br><span class="line">               <span class="keyword">for</span> (User user : users) &#123;</span><br><span class="line">                       System.out.println(user.toString());</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">//获得单个值</span></span><br><span class="line">               <span class="keyword">int</span> count = session.selectOne(<span class="string">"com.hu.mapper.UserMapper.selectById"</span>);</span><br><span class="line">               System.out.println(count);</span><br><span class="line">               <span class="comment">//获得Map</span></span><br><span class="line">               Map&lt;Long, User&gt; map = session.selectMap(<span class="string">"com.hu.mapper.UserMapper.selectAllMap"</span>, <span class="string">"id"</span>);</span><br><span class="line">               System.out.println(map);</span><br><span class="line">               session.close();</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1  李宁   44</span><br><span class="line">2  谢晓峰   30</span><br><span class="line">3  张三丰   100</span><br><span class="line">3</span><br><span class="line">&#123;1&#x3D;1  李宁   44, 2&#x3D;2  谢晓峰   30, 3&#x3D;3  张三丰   100&#125;</span><br></pre></td></tr></table></figure>
<p>三种查询方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.selectList() 返回值为 List&lt;resultType 属性控制&gt;，适用于查询结果都需要遍历的需求</span><br><span class="line">2.selectOne() 返回值 Object，适用于返回结果只是变量或一行数据时</span><br><span class="line">3.selectMap() 返回值 Map，适用于需要在查询结果中通过某列的值取到这行数据的需求</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2018/03/14/springboot%E6%95%B4%E5%90%88web/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/14/springboot%E6%95%B4%E5%90%88web/" itemprop="url">springboot整合web</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-14T00:00:00+08:00">
                2018-03-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/spring-boot/" itemprop="url" rel="index">
                    <span itemprop="name">spring boot</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="整合Servlet、Filter、Listener"><a href="#整合Servlet、Filter、Listener" class="headerlink" title="整合Servlet、Filter、Listener"></a>整合Servlet、Filter、Listener</h2><h3 id="servlet"><a href="#servlet" class="headerlink" title="servlet"></a>servlet</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@WebServlet(name = "HelloServlet",urlPatterns = "/helloservlet")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.service(req, resp);</span><br><span class="line">        System.out.println(<span class="string">"HelloServlet"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppServlet</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        SpringApplication.run(AppServlet<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Servlet 组件的注册，不用再在Servlet上添加注解</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletRegistrationBean <span class="title">getServletRegistrationBean</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ServletRegistrationBean bean = <span class="keyword">new</span> ServletRegistrationBean(<span class="keyword">new</span> HelloServlet());</span><br><span class="line">        bean.addUrlMappings(<span class="string">"/helloservlet"</span>);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行可以直接在浏览器访问</p>
<h3 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@WebFilter</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest arg0, ServletResponse arg1, FilterChain arg2)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"进入 Filter"</span>);</span><br><span class="line">        arg2.doFilter(arg0, arg1);</span><br><span class="line">        System.out.println(<span class="string">"离开 Filter"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig arg0)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppFilter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        SpringApplication.run(AppFilter<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Servlet 组件的注册，不用再在Servlet上添加注解</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> ServletRegistrationBean <span class="title">getServletRegistrationBean</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ServletRegistrationBean bean = <span class="keyword">new</span> ServletRegistrationBean(<span class="keyword">new</span> HelloServlet());</span><br><span class="line">        bean.addUrlMappings(<span class="string">"/helloservlet"</span>);<span class="comment">//bean.addInitParameter("paramName", "paramValue");</span></span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册 Filter</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">getFilterRegistrationBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        FilterRegistrationBean bean = <span class="keyword">new</span> FilterRegistrationBean(<span class="keyword">new</span> HelloFilter());</span><br><span class="line">        <span class="comment">//bean.addUrlPatterns(new String[]&#123;"*.do","*.jsp"&#125;);</span></span><br><span class="line">        bean.addUrlPatterns(<span class="string">"/helloservlet"</span>);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Listener"><a href="#Listener" class="headerlink" title="Listener"></a>Listener</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@WebListener</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloListener</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextDestroyed</span><span class="params">(ServletContextEvent arg0)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(ServletContextEvent arg0)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"HelloListener..init....."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 注册 listener</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ServletListenerRegistrationBean&lt;HelloListener&gt; <span class="title">getServletListenerRegistrationBean</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ServletListenerRegistrationBean&lt;HelloListener&gt; bean= <span class="keyword">new</span> ServletListenerRegistrationBean&lt;HelloListener&gt;(<span class="keyword">new</span> HelloListener());</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行后直接在控制台显示HelloListener..init…..</p>
<h2 id="访问静态资源和上传"><a href="#访问静态资源和上传" class="headerlink" title="访问静态资源和上传"></a>访问静态资源和上传</h2><p>注意目录名称必须是 static，在 src/main/webapp 目录名称必须要 webapp</p>
<p>html放在static中</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>文件上传<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"fileUploadController"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">                上传文件：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"filename"</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span> <span class="comment">//表示该类下的方法的返回值会自动做 json 格式的转换</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileUploadController</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 处理文件上传</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/fileUploadController"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">fileUpload</span><span class="params">(MultipartFile filename)</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        System.out.println(filename.getOriginalFilename());</span><br><span class="line">        filename.transferTo(<span class="keyword">new</span> File(<span class="string">"C:/"</span>+filename.getOriginalFilename()));</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"msg"</span>, <span class="string">"ok"</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        SpringApplication.run(App<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动访问index.html</p>
<p>上传成功</p>
<h2 id="数据访问"><a href="#数据访问" class="headerlink" title="数据访问"></a>数据访问</h2><p>@RestController<br>默认类中的方法都会以json的格式返回。</p>
<p>自定义Property，配置在application.properties中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">com.hu.title&#x3D;QQQ</span><br><span class="line">com.hu.description&#x3D;QQQa</span><br></pre></td></tr></table></figure>
<p>自定义配置类@Component</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NeoProperties</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;com.hu.title&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;com.hu.description&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">    <span class="comment">//省略getter settet方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="整合视图层"><a href="#整合视图层" class="headerlink" title="整合视图层"></a>整合视图层</h2><h3 id="jsp"><a href="#jsp" class="headerlink" title="jsp"></a>jsp</h3><p>在maven项目main文件夹下创建webapp/WEB-INF/jsp，添加user.jsp文件：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">"java"</span> contentType=<span class="string">"text/html; charset=UTF-8"</span> pageEncoding=<span class="string">"UTF-8"</span> %&gt;</span><br><span class="line">&lt;%@ taglib uri=<span class="string">"http://java.sun.com/jsp/jstl/core"</span> prefix=<span class="string">"c"</span> %&gt;</span><br><span class="line">&lt;!DOCTYPE html PUBLIC <span class="string">"-//W3C//DTD HTML 4.01 Transitional//EN"</span></span><br><span class="line"><span class="string">"http://www.w3.org/TR/html4/loose.dtd"</span>&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;Insert title here&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;table border=<span class="string">"1"</span> align=<span class="string">"center"</span> width=<span class="string">"50%"</span>&gt;</span><br><span class="line">    &lt;tr&gt;</span><br><span class="line">        &lt;th&gt;ID&lt;/th&gt;</span><br><span class="line">        &lt;th&gt;Name&lt;/th&gt;</span><br><span class="line">        &lt;th&gt;Age&lt;/th&gt;</span><br><span class="line">    &lt;/tr&gt;</span><br><span class="line">    &lt;c:forEach items=<span class="string">"$&#123;list &#125;"</span> <span class="keyword">var</span>=<span class="string">"user"</span>&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;$&#123;user.id &#125;&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;$&#123;user.name &#125;&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;$&#123;user.age &#125;&lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">    &lt;/c:forEach&gt;</span><br><span class="line">&lt;/table&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>IDEA中设置</p>
<p><img src="https://img.huyunshun.com/img/20200420155905.png" alt="20200420155905"></p>
<p>控制器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="comment">//此处模拟由数据库得到的数据</span></span><br><span class="line">    <span class="keyword">static</span> List&lt;User&gt; list;</span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        list.add(<span class="keyword">new</span> User(<span class="number">1</span>, <span class="string">"江小白"</span>, <span class="number">20</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> User(<span class="number">2</span>, <span class="string">"张三丰"</span>, <span class="number">22</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> User(<span class="number">3</span>, <span class="string">"王八蛋"</span>, <span class="number">24</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"show"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">showUser</span><span class="params">(Model model)</span> </span>&#123;</span><br><span class="line">        model.addAttribute(<span class="string">"list"</span>, list);</span><br><span class="line">        <span class="comment">//跳转视图</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"user"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>application.properties配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spring.mvc.view.prefix&#x3D;&#x2F;WEB-INF&#x2F;jsp&#x2F;</span><br><span class="line">spring.mvc.view.suffix&#x3D;.jsp</span><br></pre></td></tr></table></figure>
<p>POM.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 需要继承父项目--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.8.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-view<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 注入 SpringBoot 启动坐标 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 测试 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 对jsp的支持的依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-jasper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- jstl标签库 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>启动器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启动器存放的位置。启动器可以和 controller 位于同一个包下，或者位于 controller 的上一级包中;</span></span><br><span class="line"><span class="comment">// 如放到 controller 的平级或及子包以下不能访问到，除非加上@ComponentScan("com.hu.controller")。</span></span><br><span class="line"><span class="comment">// @ComponentScan("com.hu.controller")</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewApp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ViewApp<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：There was an unexpected error (type=Not Found, status=404).</p>
<p>/WEB-INF/jsp/user.jsp问题：</p>
<p>解决方式：</p>
<p><img src="https://img.huyunshun.com/img/20200420155827.png" alt="20200420155827"></p>
<h3 id="freemarker"><a href="#freemarker" class="headerlink" title="freemarker"></a>freemarker</h3><p>application.properties配置，这里基本是默认配置，可以不写也可以运行成功。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">spring.freemarker.template-loader-path&#x3D;classpath:&#x2F;templates&#x2F;</span><br><span class="line">spring.freemarker.charset&#x3D;utf-8</span><br><span class="line">spring.freemarker.cache&#x3D;false</span><br><span class="line">spring.freemarker.expose-request-attributes&#x3D;true</span><br><span class="line">spring.freemarker.expose-session-attributes&#x3D;true</span><br><span class="line">spring.freemarker.expose-spring-macro-helpers&#x3D;true</span><br><span class="line">spring.freemarker.suffix&#x3D;.ftl</span><br></pre></td></tr></table></figure>
<p>加入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- freemarker 依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>创建文件：src\main\resources\templates\userhtml.ftl</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>展示用户数据<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-9"</span>&gt;</span><span class="tag">&lt;/<span class="name">meta</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">border</span>=<span class="string">"1"</span> <span class="attr">align</span>=<span class="string">"center"</span> <span class="attr">width</span>=<span class="string">"50%"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>ID<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>姓名<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>年龄<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">#list</span> <span class="attr">list</span> <span class="attr">as</span> <span class="attr">user</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>$&#123;user.id&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>$&#123;user.name&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>$&#123;user.age&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">#list</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>控制器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="comment">//此处模拟由数据库得到的数据</span></span><br><span class="line">    <span class="keyword">static</span> List&lt;User&gt; list;</span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        list.add(<span class="keyword">new</span> User(<span class="number">1</span>, <span class="string">"江小白"</span>, <span class="number">20</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> User(<span class="number">2</span>, <span class="string">"张三丰"</span>, <span class="number">22</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> User(<span class="number">3</span>, <span class="string">"王八蛋"</span>, <span class="number">24</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"userhtml"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">showUserToHTML</span><span class="params">(Model model)</span> </span>&#123;</span><br><span class="line">        model.addAttribute(<span class="string">"list"</span>, list);</span><br><span class="line">        <span class="comment">//跳转视图</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"userhtml"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Thymeleaf"><a href="#Thymeleaf" class="headerlink" title="Thymeleaf"></a>Thymeleaf</h3><p>主要代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- thymeleaf 依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>模板：templates/userthy.html</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Thymeleaf Demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-9"</span>&gt;</span><span class="tag">&lt;/<span class="name">meta</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">border</span>=<span class="string">"1"</span> <span class="attr">align</span>=<span class="string">"center"</span> <span class="attr">width</span>=<span class="string">"50%"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>ID<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>姓名<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>年龄<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span> <span class="attr">th:each</span>=<span class="string">"user : $&#123;list&#125;"</span>&gt;</span></span><br><span class="line">        &lt;td th:text="$&#123;user.id&#125;"&lt;/td&gt;</span><br><span class="line">        &lt;td th:text="$&#123;user.name&#125;"&lt;/td&gt;</span><br><span class="line">        &lt;td th:text="$&#123;user.age&#125;"&lt;/td&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>控制器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="comment">//此处模拟由数据库得到的数据</span></span><br><span class="line">    <span class="keyword">static</span> List&lt;User&gt; list;</span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        list.add(<span class="keyword">new</span> User(<span class="number">1</span>, <span class="string">"江小白"</span>, <span class="number">20</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> User(<span class="number">2</span>, <span class="string">"张三丰"</span>, <span class="number">22</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> User(<span class="number">3</span>, <span class="string">"王八蛋"</span>, <span class="number">24</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"userthy"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">showUserToThy</span><span class="params">(Model model)</span> </span>&#123;</span><br><span class="line">        model.addAttribute(<span class="string">"list"</span>, list);</span><br><span class="line">        <span class="comment">//跳转视图</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"userthy"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2018/02/23/Shiro%E4%B8%8Espringmvc%20spring%20mybatis%E6%95%B4%E5%90%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/23/Shiro%E4%B8%8Espringmvc%20spring%20mybatis%E6%95%B4%E5%90%88/" itemprop="url">Shiro与springmvc spring mybatis简单整合</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-23T00:00:00+08:00">
                2018-02-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/shiro/" itemprop="url" rel="index">
                    <span itemprop="name">shiro</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="web-xml中配置shiro的filter"><a href="#web-xml中配置shiro的filter" class="headerlink" title="web.xml中配置shiro的filter"></a>web.xml中配置shiro的filter</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- shiro过虑器，DelegatingFilterProxy通过代理模式将spring容器中的bean和filter关联起来 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>shiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 设置true由servlet容器控制filter的生命周期 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>targetFilterLifecycle<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 设置spring容器filter的bean id，如果不设置则找与filter-name一致的bean--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>targetBeanName<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>shiroFilter<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>shiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="在spring中配置shiro"><a href="#在spring中配置shiro" class="headerlink" title="在spring中配置shiro"></a>在spring中配置shiro</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- web.xml中shiro的filter对应的bean --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Shiro 的Web过滤器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"shiroFilter"</span> <span class="attr">class</span>=<span class="string">"org.apache.shiro.spring.web.ShiroFilterFactoryBean"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"securityManager"</span> <span class="attr">ref</span>=<span class="string">"securityManager"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- loginUrl认证提交地址，如果没有认证将会请求此地址进行认证，请求此地址将由formAuthenticationFilter进行表单认证 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"loginUrl"</span> <span class="attr">value</span>=<span class="string">"/login.do"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 认证成功统一跳转到index.do，建议不配置，shiro认证成功自动到上一个请求路径 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"successUrl"</span> <span class="attr">value</span>=<span class="string">"/index.do"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 通过unauthorizedUrl指定没有权限操作时跳转页面--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"unauthorizedUrl"</span> <span class="attr">value</span>=<span class="string">"/refuse.jsp"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 过虑器链定义，从上向下顺序执行，一般将/**放在最下边 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"filterChainDefinitions"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- /** = authc 所有url都必须认证通过才可以访问--&gt;</span></span><br><span class="line">                        /login.jsp=anon</span><br><span class="line">                        /** = authc</span><br><span class="line">                        <span class="comment">&lt;!-- /** = anon所有url都可以匿名访问 --&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- securityManager安全管理器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"securityManager"</span> <span class="attr">class</span>=<span class="string">"org.apache.shiro.web.mgt.DefaultWebSecurityManager"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"realm"</span> <span class="attr">ref</span>=<span class="string">"userRealm"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- realm --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"userRealm"</span> <span class="attr">class</span>=<span class="string">"cn.siggy.realm.UserRealm"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 将凭证匹配器设置到realm中，realm按照凭证匹配器的要求进行散列 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"credentialsMatcher"</span> <span class="attr">ref</span>=<span class="string">"credentialsMatcher"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 凭证匹配器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"credentialsMatcher"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">"org.apache.shiro.authc.credential.HashedCredentialsMatcher"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hashAlgorithmName"</span> <span class="attr">value</span>=<span class="string">"md5"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hashIterations"</span> <span class="attr">value</span>=<span class="string">"1"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h2><p>原理</p>
<p>Shiro 内置了很多默认的过滤器，比如身份验证、授权等相关的。默认过滤器可以参考   org.apache.shiro.web.filter.mgt.DefaultFilter中的过滤器：</p>
<table>
<thead>
<tr>
<th>过滤器简称</th>
<th>对应的java类</th>
</tr>
</thead>
<tbody><tr>
<td>anon</td>
<td>org.apache.shiro.web.filter.authc.AnonymousFilter</td>
</tr>
<tr>
<td>authc</td>
<td>org.apache.shiro.web.filter.authc.FormAuthenticationFilter</td>
</tr>
<tr>
<td>authcBasic</td>
<td>org.apache.shiro.web.filter.authc.BasicHttpAuthenticationFilter</td>
</tr>
<tr>
<td>perms</td>
<td>org.apache.shiro.web.filter.authz.PermissionsAuthorizationFilter</td>
</tr>
<tr>
<td>port</td>
<td>org.apache.shiro.web.filter.authz.PortFilter</td>
</tr>
<tr>
<td>rest</td>
<td>org.apache.shiro.web.filter.authz.HttpMethodPermissionFilter</td>
</tr>
<tr>
<td>roles</td>
<td>org.apache.shiro.web.filter.authz.RolesAuthorizationFilter</td>
</tr>
<tr>
<td>ssl</td>
<td>org.apache.shiro.web.filter.authz.SslFilter</td>
</tr>
<tr>
<td>user</td>
<td>org.apache.shiro.web.filter.authc.UserFilter</td>
</tr>
<tr>
<td>logout</td>
<td>org.apache.shiro.web.filter.authc.LogoutFilter</td>
</tr>
</tbody></table>
<pre><code>anon:例子/admins/**=anon 没有参数，表示可以匿名使用。
authc:例如/admins/user/**=authc表示需要认证(登录)才能使用，FormAuthenticationFilter是表单认证，没有参数</code></pre><p>使用FormAuthenticationFilter过虑器实现 ，原理如下：</p>
<pre><code>将用户没有认证时，请求loginurl进行认证，用户身份和用户密码提交数据到loginurl
FormAuthenticationFilter拦截住取出request中的username和password（两个参数名称是可以配置的）
FormAuthenticationFilter调用realm传入一个token（username和password）
realm认证时根据username查询用户信息（在Activeuser中存储，包括 userid、usercode、username、menus）。
如果查询不到，realm返回null，FormAuthenticationFilter向request域中填充一个参数（记录了异常信息）</code></pre><p>登陆页面</p>
<p>由于FormAuthenticationFilter的用户身份和密码的input的默认值（username和password），修改页面的账号和密码 的input的名称为username和password</p>
<p>代码实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginController</span> </span>&#123;</span><br><span class="line">       </span><br><span class="line">       <span class="meta">@RequestMapping</span>(<span class="string">"/login.do"</span>)</span><br><span class="line">       <span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(HttpServletRequest req,Model model)</span></span>&#123;</span><br><span class="line">               String exceptionClassName = (String)req.getAttribute(<span class="string">"shiroLoginFailure"</span>);</span><br><span class="line">               String error = <span class="keyword">null</span>;</span><br><span class="line">               <span class="keyword">if</span>(UnknownAccountException<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>().<span class="title">equals</span>(<span class="title">exceptionClassName</span>)) </span>&#123;</span><br><span class="line">               error = <span class="string">"用户名/密码错误"</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span>(IncorrectCredentialsException<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>().<span class="title">equals</span>(<span class="title">exceptionClassName</span>))</span></span><br><span class="line"><span class="class">               </span>&#123;</span><br><span class="line">               error = <span class="string">"用户名/密码错误"</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span>(exceptionClassName != <span class="keyword">null</span>) &#123;</span><br><span class="line">               error = <span class="string">"其他错误："</span> + exceptionClassName;</span><br><span class="line">               &#125;</span><br><span class="line">               model.addAttribute(<span class="string">"error"</span>, error);</span><br><span class="line">               <span class="keyword">return</span> <span class="string">"redirect:login.jsp"</span>;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2018/02/21/shiro%E4%BB%8B%E7%BB%8D%E5%92%8C%E8%BF%90%E8%A1%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/21/shiro%E4%BB%8B%E7%BB%8D%E5%92%8C%E8%BF%90%E8%A1%8C/" itemprop="url">shiro介绍和使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-21T00:00:00+08:00">
                2018-02-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/shiro/" itemprop="url" rel="index">
                    <span itemprop="name">shiro</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="框架介绍"><a href="#框架介绍" class="headerlink" title="框架介绍"></a>框架介绍</h2><h3 id="1、shiro框架及其基本功能"><a href="#1、shiro框架及其基本功能" class="headerlink" title="1、shiro框架及其基本功能"></a>1、shiro框架及其基本功能</h3><p>Apache Shiro 是Java 的一个安全框架。Shiro 可以非常容易的开发出足够好的应用，其不仅可以用在JavaSE 环境，也可以用在JavaEE 环境。Shiro 可以帮助我们完成：认证、授权、加密、会话管理、与Web 集成、缓存等。<br>Shiro 的 API 也是非常简单；其基本功能点如下图所示：</p>
<p><img src="https://img.huyunshun.com/img/20200421181655.png" alt="20200421181655"></p>
<pre><code>Authentication ：身份认证/登录，验证用户是不是拥有相应的身份；
Authorization ：授权，即权限验证，验证某个已认证的用户是否拥有某个权限；即判断用户是否能做事情，常见的如：验证某个用户是否拥有某个角色。或者细粒度的验证某个用户对某个资源是否具有某个权限；
Session Manager ：会话管理，即用户登录后就是一次会话，在没有退出之前，它的所有信息都在会话中；会话可以是普通 JavaSE 环境的，也可以是如 Web 环境的；
Cryptography ：加密，保护数据的安全性，如密码加密存储到数据库，而不是明文存储；
Web Support ：Web 支持，可以非常容易的集成到 Web 环境；
Caching：缓存，比如用户登录后，其用户信息、拥有的角色/权限不必每次去查，这样可以提高效率；
Concurrency ：shiro 支持多线程应用的并发验证，即如在一个线程中开启另一个线程，能把权限自动传播过去；
Testing ：提供测试支持；
Run As ：允许一个用户假装为另一个用户（如果他们允许）的身份进行访问；
Remember Me ：记住我，这个是非常常见的功能，即一次登录后，下次再来的话不用登录了。</code></pre><p><strong>注：Shiro  不会去维护用户、维护权限；这 些需要我们 自己去 设计/ 提供 ； 然后通过相应的 接口注入给 给 Shiro  即可。</strong></p>
<h3 id="2、shiro架构原理"><a href="#2、shiro架构原理" class="headerlink" title="2、shiro架构原理"></a>2、shiro架构原理</h3><p><img src="https://img.huyunshun.com/img/20200421181738.png" alt="20200421181738"></p>
<p>应用代码直接交互的对象是Subject，也就是说Shiro的对外API核心就是Subject；其每个 API 的含义：</p>
<pre><code>Subject ：主体，代表了当前&quot;用户&quot;，这个用户不一定是一个具体的人，与当前应用交互的任何东西都是 Subject，如网络爬虫，机器人等；即一个抽象概念；所有 Subject 都绑定到 SecurityManager，与 Subject 的所有交互都会委托给 SecurityManager；可以把 Subject 认为是一个门面；SecurityManager 才是实际的执行者；SecurityManager ：安全管理器；即所有与安全有关的操作都会与 SecurityManager 交互；且它管理着所有 Subject；可以看出它是 Shiro 的核心，它负责与后边介绍的其他组件进行交互，如果学习过 SpringMVC，你可以把它看成 DispatcherServlet 前端控制器；
Realm： 域，Shiro 从从 Realm 获取安全数据（如用户、角色、权限），就是说 SecurityManager要验证用户身份，那么它需要从 Realm 获取相应的用户进行比较以确定用户身份是否合法；也需要从 Realm 得到用户相应的角色/权限进行验证用户是否能进行操作；可以把 Realm 看成 DataSource，即安全数据源。</code></pre><p>也就是说对于我们而言，最简单的一个 Shiro 应用：</p>
<pre><code>1、 应用代码通过 Subject 来进行认证和授权，而 Subject 又委托给 SecurityManager；
2、 我们需要给 Shiro 的 SecurityManager 注入 Realm，从而让 SecurityManager 能得到合法的用户及其权限进行判断。</code></pre><p>注：从以上也可以看出 ，Shiro  不提供维护用户/ 权限， 而是通过 Realm  让开发人员自己注入。</p>
<p><img src="https://img.huyunshun.com/img/20200421181854.png" alt="20200421181854"></p>
<pre><code>Subject ：主体，可以看到主体可以是任何可以与应用交互的&quot;用户&quot;；
SecurityManager ：  相 当 于 SpringMVC 中 的 DispatcherServlet 或 者 Struts2 中 的FilterDispatcher；是 Shiro 的心脏；所有具体的交互都通过 SecurityManager 进行控制；它管理着所有 Subject、且负责进行认证和授权、及会话、缓存的管理。
Authenticator ：认证器，负责主体认证的，这是一个扩展点，如果用户觉得 Shiro 默认的不好，可以自定义实现；其需要认证策略（Authentication Strategy），即什么情况下算用户认证通过了；
Authrizer ：授权器，或者访问控制器，用来决定主体是否有权限进行相应的操作；即控制着用户能访问应用中的哪些功能；
Realm ：可以有 1 个或多个 Realm，可以认为是安全实体数据源，即用于获取安全实体的；可以是 JDBC 实现，也可以是 LDAP 实现，或者内存实现等等；由用户提供；注意：Shiro不知道你的用户/权限存储在哪及以何种格式存储；所以我们一般在应用中都需要实现自己的 Realm；
SessionManager ：如果写过 Servlet 就应该知道 Session 的概念，Session 呢需要有人去管理它的生命周期，这个组件就是 SessionManager；而 Shiro 并不仅仅可以用在 Web 环境，也可以用在如普通的 JavaSE 环境、EJB 等环境；所有呢，Shiro 就抽象了一个自己的 Session来管理主体与应用之间交互的数据；这样的话，比如我们在 Web 环境用，刚开始是一台Web 服务器；接着又上了台 EJB 服务器；这时想把两台服务器的会话数据放到一个地方，这个时候就可以实现自己的分布式会话（如把数据放到 Memcached 服务器）；
SessionDAO：DAO 大家都用过，数据访问对象，用于会话的 CRUD，比如我们想把 Session保存到数据库，那么可以实现自己的 SessionDAO，通过如 JDBC 写到数据库；比如想把Session 放到 Memcached 中，可以实现自己的 Memcached SessionDAO；另外 SessionDAO中可以使用 Cache 进行缓存，以提高性能。
CacheManager ：缓存控制器，来管理如用户、角色、权限等的缓存的；因为这些数据基本上很少去改变，放到缓存中后可以提高访问的性能。
Cryptography ：密码模块，Shiro 提高了一些常见的加密组件用于如密码加密/解密的。</code></pre><h2 id="一个简单的示例"><a href="#一个简单的示例" class="headerlink" title="一个简单的示例"></a>一个简单的示例</h2><p>maven配置文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.hu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro_01<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在src下创建shiro的ini配置文件/shiro_01/src/main/resources/shiro.ini：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[users]</span><br><span class="line">zhang&#x3D;123</span><br></pre></td></tr></table></figure>
<p>登录测试java代码，这里使用junit测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginLogoutTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testHelloworld</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 1、获取 SecurityManager 工厂，此处使用ini配置文件初始化 SecurityManager</span></span><br><span class="line">            Factory&lt;org.apache.shiro.mgt.SecurityManager&gt; factory = <span class="keyword">new</span> IniSecurityManagerFactory(<span class="string">"classpath:shiro.ini"</span>);</span><br><span class="line">            <span class="comment">// 2、获得SecurityManager 实例 并绑定给 SecurityUtils，全局设置，设置一次即可</span></span><br><span class="line">            org.apache.shiro.mgt.SecurityManager securityManager = factory.getInstance();</span><br><span class="line">            SecurityUtils.setSecurityManager(securityManager);</span><br><span class="line">            <span class="comment">// 3、得到 Subject，并且通过用户名/密码创建 身份验证 Token（即用户身份/凭证）</span></span><br><span class="line">            Subject subject = SecurityUtils.getSubject();</span><br><span class="line">            <span class="comment">//封装token信息</span></span><br><span class="line">            UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(<span class="string">"zhang"</span>, <span class="string">"123"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 4、登录，即身份验证</span></span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                    * 用户认证：</span></span><br><span class="line"><span class="comment">                    * Subject接收token，通过其实现类DelegatingSubject将token委托给SecurityManager来完成认证。</span></span><br><span class="line"><span class="comment">                    * 默认情况下：SecurityManager接口是通过DefaultSecurityManager类来完成相关的功能，并且由DefaultSecurityManager中的login方法来完成认证过程。</span></span><br><span class="line"><span class="comment">                    * 在login中调用了该类的authenticate()方法来完成认证，而该方法由AuthenticatingSecurityManager来完成的。</span></span><br><span class="line"><span class="comment">                    * 在该类的authenticate()方法中，通过调用认证器authenticator来完成工作。</span></span><br><span class="line"><span class="comment">                    * 而认证器authenticator又是通过ModularRealmAuthenticator类来完成认证;</span></span><br><span class="line"><span class="comment">                    * 通过ModularRealmAuthenticator中的doAuthenticate方法来获取Realm信息。</span></span><br><span class="line"><span class="comment">                    * 如果是单个realm直接将token和realm中的数据进行比较判断是否认证成功;如果是多个realm则通过Authentication Strategy来完成对应的操作。</span></span><br><span class="line"><span class="comment">                    * subject.isAuthenticated()判断是否认证成功。</span></span><br><span class="line"><span class="comment">                    */</span></span><br><span class="line">                    subject.login(token);</span><br><span class="line">                    <span class="keyword">if</span> (subject.isAuthenticated()) &#123;</span><br><span class="line">                            System.out.println(<span class="string">"登录成功"</span>);</span><br><span class="line">                    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                            System.out.println(<span class="string">"用户名或密码错误！"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">                    <span class="comment">// 5、身份验证失败</span></span><br><span class="line">                    System.out.println(<span class="string">"登录失败"</span>);</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            Assert.assertEquals(<span class="keyword">true</span>, subject.isAuthenticated()); <span class="comment">// 断言用户已经登录</span></span><br><span class="line">            <span class="comment">// 6、退出</span></span><br><span class="line">            subject.logout();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果输出登录成功</p>
<p>注：如果身份验证失败请捕获 AuthenticationException 或其子类</p>
<p>常见的如 ：DisabledAccountException（禁用的帐号）、LockedAccountException（锁定的帐号）、UnknownAccountException（错误的帐号）、ExcessiveAttemptsException（登录失败次数过多）、IncorrectCredentialsException （错误的凭证）、ExpiredCredentialsException（过期的<br>凭证）等，具体请查看其继承关系；对于页面的错误消息展示，最好使用如”用户名/密码错误”而不是”用户名错误”/“密码错误”，防止一些恶意用户非法扫描帐号库；</p>
<p>最后可以调用 subject.logout 退出，其会自动委托给 SecurityManager.logout 方法退出。</p>
<pre><code>1、收集用户身份/凭证，即如用户名/密码；
2、调用 Subject.login 进行登录，如果失败将得到相应的 AuthenticationException 异常，根据异常提示用户错误信息；否则登录成功；
3、最后调用 Subject.logout 进行退出操作。</code></pre><h2 id="认证Authentication"><a href="#认证Authentication" class="headerlink" title="认证Authentication"></a>认证Authentication</h2><p>在应用中谁能证明他就是他本人。一般提供如他们的身份ID 一些标识信息来表明他就是他本人，如提供身份证，用户名/密码来证明。</p>
<p>在 shiro 中，用户需要提供principals （身份）和credentials（证明）给shiro，从而应用能验证用户身份：</p>
<pre><code>principals：身份，即主体的标识属性，可以是任何东西，如用户名、邮箱等，唯一即可。一个主体可以有多个 principals，但只有一个 Primary principals，一般是用户名/密码/手机号。
credentials：证明/凭证，即只有主体知道的安全值，如密码/数字证书等。</code></pre><p>最常见的 principals 和 credentials 组合就是用户名/密码了。接下来先进行一个基本的身份认证。</p>
<p>另外两个相关的概念是之前提到的 Subject 及 Realm，分别是主体及验证主体的数据源。</p>
<h3 id="认证流程"><a href="#认证流程" class="headerlink" title="认证流程"></a>认证流程</h3><p><img src="https://img.huyunshun.com/img/20200421182228.png" alt="20200421182228"></p>
<pre><code>1、首先调用 Subject.login(token)进行登录，其会自动委托给 Security Manager，调用之前必须通过 SecurityUtils. setSecurityManager()设置；
2、SecurityManager 负责真正的身份验证逻辑；它会委托给 Authenticator 进行身份验证；
3、Authenticator 才是真正的身份验证者，Shiro API 中核心的身份认证入口点，此处可以自定义插入自己的实现；
4、Authenticator 可能会委托给相应的 AuthenticationStrategy 进行多 Realm 身份验证，默认ModularRealmAuthenticator 会调用 AuthenticationStrategy 进行多 Realm 身份验证；
5、Authenticator 会把相应的 token 传入 Realm，从 Realm 获取身份验证信息，如果没有返回/抛出异常表示身份验证失败了。此处可以配置多个 Realm，将按照相应的顺序及策略进行访问。</code></pre><h3 id="Realm"><a href="#Realm" class="headerlink" title="Realm"></a>Realm</h3><p>域，Shiro 从从 Realm 获取安全数据（如用户、角色、权限），就是说 SecurityManager要验证用户身份，那么它需要从 Realm 获取相应的用户进行比较以确定用户身份是否合法；也需要从 Realm 得到用户相应的角色/权限进行验证用户是否能进行操作；可以把 Realm 看成 DataSource，安全数据源。前面的例子使用的是ini配置org.apache.shiro.realm.text.IniRealm。</p>
<p>Realm接口：</p>
<p><img src="https://img.huyunshun.com/img/20200421182328.png" alt="20200421182328"></p>
<pre><code>String getName(); //返回一个唯一的 Realm 名字
boolean supports(AuthenticationToken token); //判断此 Realm 是否支持此 Token
AuthenticationInfo getAuthenticationInfo(AuthenticationToken token) throws AuthenticationException; //根据 Token 获取认证信息</code></pre><p><img src="https://img.huyunshun.com/img/20200421182355.png" alt="20200421182355"></p>
<p>最基础的是Realm接口，CachingRealm负责缓存处理，AuthenticationRealm负责认证，AuthorizingRealm负责授权，通常自定义的realm继承AuthorizingRealm。</p>
<h4 id="单个Realm配置"><a href="#单个Realm配置" class="headerlink" title="单个Realm配置"></a>单个Realm配置</h4><p>类可以通过实现接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRealm</span> <span class="keyword">implements</span> <span class="title">Realm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="string">"my Realm "</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(AuthenticationToken token)</span> </span>&#123;</span><br><span class="line">               <span class="comment">// 仅支持 UsernamePasswordToken 类型的 Token</span></span><br><span class="line">               <span class="keyword">return</span> token <span class="keyword">instanceof</span> UsernamePasswordToken;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> AuthenticationInfo <span class="title">getAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">               String username = (String) token.getPrincipal(); <span class="comment">// 得到用户名</span></span><br><span class="line">               String password = <span class="keyword">new</span> String((<span class="keyword">char</span>[]) token.getCredentials()); <span class="comment">// 得到密码</span></span><br><span class="line">               System.out.println(getName()+<span class="string">"    "</span>+username+<span class="string">"        "</span>+password);</span><br><span class="line">               <span class="keyword">if</span> (!<span class="string">"zhang"</span>.equals(username)) &#123;</span><br><span class="line">                       <span class="keyword">throw</span> <span class="keyword">new</span> UnknownAccountException(); <span class="comment">// 如果用户名错误</span></span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (!<span class="string">"123"</span>.equals(password)) &#123;</span><br><span class="line">                       <span class="keyword">throw</span> <span class="keyword">new</span> IncorrectCredentialsException(); <span class="comment">// 如果密码错误</span></span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// 返回认证信息：如果身份认证验证成功，返回一个 AuthenticationInfo 实现；</span></span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(username, password, getName());</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或者继承来实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRealm1</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="string">"my Realm 1"</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 用于授权</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">               <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 用于认证</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">               <span class="comment">// 从token中获取信息</span></span><br><span class="line">               String username = (String) token.getPrincipal(); <span class="comment">// 得到用户名</span></span><br><span class="line">               <span class="comment">// 根据用户名到数据库中取出用户信息 如果查询不到 返回null</span></span><br><span class="line">               String password = <span class="string">"123"</span>;<span class="comment">// 假如从数据库中获取密码为123</span></span><br><span class="line">               System.out.println(getName()+<span class="string">"    "</span>+username+<span class="string">"        "</span>+password);</span><br><span class="line">               <span class="comment">// 返回认证信息：如果身份认证验证成功，返回一个 AuthenticationInfo 实现；</span></span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(username, password, getName());</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ini配置：</p>
<pre><code>[users]
hu=123</code></pre><p>[main]</p>
<pre><code>#引入 自定义 realm
userRealm=com.hu.test.MyRealm
#将realm设置到securityManager
securityManager.realms=$userRealm</code></pre><h4 id="多个Realm配置"><a href="#多个Realm配置" class="headerlink" title="多个Realm配置"></a>多个Realm配置</h4><pre><code>ini配置：
#声明一个 realm
myRealm1=com.hu.realm.MyRealm1
myRealm2=com.hu.realm.MyRealm2
#指定 securityManager 的 realms 实现
securityManager.realms=$myRealm1,$myRealm2</code></pre><p>securityManager 会按照 realms 指定的顺序进行身份认证。此处我们使用显示指定顺序的方式指定了 Realm 的顺序，如果删除”securityManager.realms=$myRealm1,$myRealm2”，那么 securityManager 会按照 realm 声明的顺序进行使用（即无需设置 realms 属性，其会自动发现 ）。<br>当我们显示指定realm后，其他没有指定realm将被忽略，”securityManager.realms=$myRealm1”，那么 myRealm2 不会被自动设置进去。</p>
<h4 id="Shiro默认提供的的Realm"><a href="#Shiro默认提供的的Realm" class="headerlink" title="Shiro默认提供的的Realm"></a>Shiro默认提供的的Realm</h4><p><img src="https://img.huyunshun.com/img/20200421182617.png" alt="20200421182617"></p>
<p>一般使用继承 AuthorizingRealm（授权），其继承了 AuthenticatingRealm（即身份验证），而且也间接继承了 CachingRealm（带有缓存实现）。其中主要默认实现如下：</p>
<p>org.apache.shiro.realm.text.IniRealm：[users]部分指定用户名/密码及其角色；[roles]部分指定角色即权限信息；</p>
<p>org.apache.shiro.realm.text.PropertiesRealm：  user.username=password,role1,role2 指定用户名/密码及其角色；role.role1=permission1,permission2 指定角色及权限信息；</p>
<pre><code>org.apache.shiro.realm.jdbc.JdbcRealm： 通过 sql 查询相应的信息，如：
select password fromusers where username = ? 获取用户密码
select password, password_salt from users whereusername = ? 获取用户密码
select role_name from user_roles where username = ? 获取用户角色；
select permission from roles_permissions where role_name = ? 获取角色对应的权限信息，也可以调用相应的 api 进行自定义 sql；</code></pre><h4 id="JDBC-Realm-使用"><a href="#JDBC-Realm-使用" class="headerlink" title="JDBC Realm 使用"></a>JDBC Realm 使用</h4><p>数据库及依赖： mysql 数据库及 druid 连接池</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 数据库依赖  使用 mysql 数据库及 druid 连接池 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.25<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.2.23<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>ini配置</p>
<pre><code>jdbcRealm=org.apache.shiro.realm.jdbc.JdbcRealm
dataSource=com.alibaba.druid.pool.DruidDataSource
dataSource.driverClassName=com.mysql.jdbc.Driver
dataSource.url=jdbc:mysql://localhost:3306/maven_shiro
dataSource.username=root
dataSource.password=123456
jdbcRealm.dataSource=$dataSource
securityManager.realms=$jdbcRealm</code></pre><p>变量名=全限定类名 会自动创建一个类实例</p>
<p>变量名.属性=值 自动调用相应的 setter 方法进行赋值</p>
<p>$变量名 引用之前的一个对象实例</p>
<p>Junit测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginLogoutTest2</span> </span>&#123;</span><br><span class="line">       <span class="meta">@Test</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testHelloworld</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               Factory&lt;org.apache.shiro.mgt.SecurityManager&gt; factory = <span class="keyword">new</span> IniSecurityManagerFactory(<span class="string">"classpath:shiro-jdbc-realm.ini"</span>);</span><br><span class="line">               org.apache.shiro.mgt.SecurityManager securityManager = factory.getInstance();</span><br><span class="line">               SecurityUtils.setSecurityManager(securityManager);</span><br><span class="line">               Subject subject = SecurityUtils.getSubject();</span><br><span class="line">               UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(<span class="string">"hu"</span>, <span class="string">"123"</span>);</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                       subject.login(token);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">                       System.out.println(<span class="string">"登录失败"</span>);</span><br><span class="line">                       e.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line">               Assert.assertEquals(<span class="keyword">true</span>, subject.isAuthenticated());  </span><br><span class="line">               subject.logout();</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：信息: {dataSource-1} inited  登录成功</p>
<h3 id="Authenticator-及-AuthenticationStrategy"><a href="#Authenticator-及-AuthenticationStrategy" class="headerlink" title="Authenticator 及 AuthenticationStrategy"></a>Authenticator 及 AuthenticationStrategy</h3><p>Authenticator 的职责是验证用户帐号，是 Shiro API 中身份验证核心的入口点。</p>
<p>public AuthenticationInfo authenticate(AuthenticationToken authenticationToken) throws AuthenticationException;<br>如果验证成功，将返回 AuthenticationInfo 验证信息；此信息中包含了身份及凭证；如果验证失败将抛出相应的 AuthenticationException 实现。</p>
<p>SecurityManager 接口继承了 Authenticator，另外还有一个 ModularRealmAuthenticator 实现，其委托给多个 Realm 进行验证，验证规则通过 AuthenticationStrategy 接口指定，默认提供的实现，三种认证策略：</p>
<pre><code>FirstSuccessfulStrategy：只要有一个 Realm 验证成功即可，只返回第一个 Realm 身份验证成功的认证信息，其他的忽略；
AtLeastOneSuccessfulStrategy：只要有一个 Realm 验证成功即可，和 FirstSuccessfulStrategy不同，返回所有 Realm 身份验证成功的认证信息；
AllSuccessfulStrategy：所有 Realm 验证成功才算成功，且返回所有 Realm 身份验证成功的认证信息，如果有一个失败就失败了。</code></pre><p>ModularRealmAuthenticator 默认使用 AtLeastOneSuccessfulStrategy 策略。</p>
<p>ini 配置文件：</p>
<pre><code>#配置验证器  指定 securityManager 的 authenticator 实现
authenticator=org.apache.shiro.authc.pam.ModularRealmAuthenticator
securityManager.authenticator=$authenticator
#配置验证策略  指定 securityManager.authenticator 的 authenticationStrategy
allSuccessfulStrategy=org.apache.shiro.authc.pam.AllSuccessfulStrategy
securityManager.authenticator.authenticationStrategy=$allSuccessfulStrategy</code></pre><p>假如有三个realm：<br>realm1，realm2，realm3</p>
<pre><code>realm1=com.hu.realm.Realm1
realm2=com.hu.realm.Realm2
realm3=com.hu.realm.Realm3
securityManager.realms=$realm1,$realm3

测试成功</code></pre><h2 id="自定义Realm"><a href="#自定义Realm" class="headerlink" title="自定义Realm"></a>自定义Realm</h2><h3 id="散列算法"><a href="#散列算法" class="headerlink" title="散列算法"></a>散列算法</h3><p>一般用于生成数据的摘要信息，是一种不可逆的算法，一般适合存储密码之类的数据，常见的散列算法如MD5、SHA等。一般进行散列时最好提供一个salt，比如加密密码admin产生的散列值是21232f297a57a5a743894a0e4a801fc3，可以到一些md5 解密网站很容易的通过散列值得到密码admin，即如果直接对密码进行散列相对来说破解更容易，此时我们可以加一些只有系统知道的干扰数据，如用户名和ID（即盐）；这样散列的对象是”密码+用户名+ID”，这样生成的散列值相对来说更难破解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroMD5</span> </span>&#123;</span><br><span class="line">   <span class="comment">//shiro提供了现成的加密类 Md5Hash</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMd5</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="comment">// MD5加密</span></span><br><span class="line">           String password = <span class="keyword">new</span> Md5Hash(<span class="string">"123"</span>).toString();</span><br><span class="line">           System.out.println(<span class="string">"直接加密："</span> + password);</span><br><span class="line">           <span class="comment">// 加盐 salt 默认一次散列</span></span><br><span class="line">           String password_salt = <span class="keyword">new</span> Md5Hash(<span class="string">"123"</span>, <span class="string">"hu"</span>).toString();</span><br><span class="line">           System.out.println(<span class="string">"加盐salt后散列："</span> + password_salt);</span><br><span class="line">           <span class="comment">// 散列2次</span></span><br><span class="line">           String password_salt_2 = <span class="keyword">new</span> Md5Hash(<span class="string">"123"</span>, <span class="string">"hu"</span>, <span class="number">2</span>).toString();</span><br><span class="line">           System.out.println(<span class="string">"散列2次："</span> + password_salt_2);</span><br><span class="line">           <span class="comment">// 使用SimpleHash</span></span><br><span class="line">           SimpleHash hash = <span class="keyword">new</span> SimpleHash(<span class="string">"MD5"</span>, <span class="string">"123"</span>, <span class="string">"hu"</span>, <span class="number">2</span>);</span><br><span class="line">           System.out.println(<span class="string">"simpleHash:"</span> + hash.toString());</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自定义散列"><a href="#自定义散列" class="headerlink" title="自定义散列"></a>自定义散列</h3><pre><code>ini配置：
[users]
hu=123

[main]
#定义凭证匹配器
credentialsMatcher=org.apache.shiro.authc.credential.HashedCredentialsMatcher
#散列算法
credentialsMatcher.hashAlgorithmName=md5
#散列次数
credentialsMatcher.hashIterations=2

#引入 自定义 realm
userRealm=com.hu.test.MyRealmMD5
userRealm.credentialsMatcher=$credentialsMatcher
#将realm设置到securityManager
securityManager.realms=$userRealm</code></pre><h3 id="自定义Realm-1"><a href="#自定义Realm-1" class="headerlink" title="自定义Realm"></a>自定义Realm</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRealmMD5</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"my Realm MD5"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 用于授权</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 用于认证</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        System.out.println(getName());</span><br><span class="line">        <span class="comment">// 从token中获取信息</span></span><br><span class="line">        String username = (String) token.getPrincipal(); <span class="comment">// 得到用户名</span></span><br><span class="line">        <span class="comment">// 根据用户名到数据库中取出用户信息 如果查询不到 返回null</span></span><br><span class="line">        <span class="comment">// 按照固定规则加密码结果 ，此密码 要在数据库存储，原始密码 是123，盐是hu 2次散列</span></span><br><span class="line">        String password = <span class="string">"5f97546d9e0f0d775b9175286a484c09"</span>;<span class="comment">// 假如从数据库中获取密码加密</span></span><br><span class="line">        <span class="comment">// 返回认证信息</span></span><br><span class="line">        SimpleAuthenticationInfo simpleAuthenticationInfo = <span class="keyword">new</span> SimpleAuthenticationInfo(username, password, ByteSource.Util.bytes(<span class="string">"hu"</span>), getName());</span><br><span class="line">        <span class="keyword">return</span> simpleAuthenticationInfo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testHelloworld() &#123;</span><br><span class="line">          Factory&lt;org.apache.shiro.mgt.SecurityManager&gt; factory &#x3D; new IniSecurityManagerFactory(&quot;classpath:shiromd5.ini&quot;);</span><br><span class="line">          org.apache.shiro.mgt.SecurityManager securityManager &#x3D; factory.getInstance();</span><br><span class="line">          SecurityUtils.setSecurityManager(securityManager);</span><br><span class="line">          Subject subject &#x3D; SecurityUtils.getSubject();</span><br><span class="line">          UsernamePasswordToken token &#x3D; new UsernamePasswordToken(&quot;hu&quot;, &quot;123&quot;);</span><br><span class="line">          try &#123;</span><br><span class="line">                          subject.login(token);</span><br><span class="line">                          System.out.println(&quot;登录成功&quot;);</span><br><span class="line">          &#125; catch (AuthenticationException e) &#123;</span><br><span class="line">                          System.out.println(&quot;登录失败&quot;);</span><br><span class="line">                          e.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">          Assert.assertEquals(true, subject.isAuthenticated());</span><br><span class="line">          subject.logout();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<pre><code>SLF4J: See http://www.slf4j.org/codes.html#StaticLoggerBinder for further details.
my Realm MD5
登录成功</code></pre><h2 id="授权Authorization"><a href="#授权Authorization" class="headerlink" title="授权Authorization"></a>授权Authorization</h2><p>授权，也叫访问控制，即在应用中控制谁能访问哪些资源（如访问页面/编辑数据/页面操作等）。在授权中需了解的几个关键对象：主体（Subject）、资源（Resource）、权限（Permission）、角色（Role）。</p>
<p>主体：即访问应用的用户，在Shiro中使用Subject代表该用户。用户只有授权后才允许访问相应的资源。</p>
<p>资源：在应用中用户可以访问的任何东西，比如访问JSP 页面、查看/编辑某些数据、访问某个业务方法、打印文本等等都是资源。用户只要授权后才能访问。</p>
<p>权限：安全策略中的原子授权单位，通过权限我们可以表示在应用中用户有没有操作某个资源的<br>权力。即权限表示在应用中用户能不能访问某个资源，如：访问用户列表页面查看/新增/修改/删除用户数据（即很多时候都是CRUD（增查改删）式权限控制）打印文档等等。</p>
<p>角色：角色代表了操作集合，可以理解为权限的集合，一般情况下我们会赋予用户角色而不是权限，即这样用户可以拥有一组权限，赋予权限时比较方便。典型的如：项目经理、技术总监、CTO、开发工程师等都是角色，不同的角色拥有一组不同的权限。</p>
<h3 id="授权流程"><a href="#授权流程" class="headerlink" title="授权流程"></a>授权流程</h3><p><img src="https://img.huyunshun.com/img/20200421184616.png" alt="20200421184616"></p>
<h3 id="授权方式"><a href="#授权方式" class="headerlink" title="授权方式"></a>授权方式</h3><p>Shiro 支持三种方式的授权。</p>
<p>编程式：通过写 if/else 授权代码块完成：</p>
<pre><code>Subject subject = SecurityUtils.getSubject();
if(subject.hasRole(&quot;admin&quot;)) {
//有权限
} else {
    //无权限
}</code></pre><p>注解式：通过在执行的 Java 方法上放置相应的注解完成：</p>
<pre><code>@RequiresRoles(&quot;admin&quot;)
public void hello() {
    //有权限
}
没有权限将抛出相应的异常；</code></pre><p>JSP/GSP 标签：在 JSP/GSP 页面通过相应的标签完成：</p>
<pre><code>&lt;shiro:hasRole name=&quot;admin&quot;&gt;
    &lt;!- 有权限 -&gt;
&lt;/shiro:hasRole&gt;</code></pre><h3 id="授权实现"><a href="#授权实现" class="headerlink" title="授权实现"></a>授权实现</h3><p>ini配置文件配置用户拥有的角色及角色-权限关系（shiro-permission.ini）</p>
<pre><code>[users]
hu=123,role1,role2
yun=121,role1
[roles]
role1=user:create,user:update
role2=user:create,user:delete

规则：&quot;用户名=密码，角色1，角色2&quot; &quot;角色=权限1，权限2&quot;，即首先根据用户名找到角色，然后根据角色再找到权限，角色是权限集合。
Shiro  不进行权限的维护，需要我们通过Realm返回相应的权限信息。只需要维护&quot;用户--角色&quot;之间的关系即可。
权限字符串的规则是：&quot;资源标识符：操作：资源实例标识符&quot;，意思是对哪个资源的哪个实例具有什么操作，&quot;:&quot;是资源/操作/实例的分割符，权限字符串也可以使用*通配符。

例子：
用户创建权限：user:create，或user:create:*
用户修改实例001的权限：user:update:001
用户实例001的所有权限：user：*：001</code></pre><h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><pre><code>[users]
hu=123,role1,role2
yun=121,role2
[roles]
role1=user:create,user:update
role2=user:create,user:delete</code></pre><p>java伪代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用户认证状态</span></span><br><span class="line"><span class="keyword">boolean</span> isAuthenticated = subject.isAuthenticated();</span><br><span class="line">System.out.println(<span class="string">"用户认证状态："</span> + isAuthenticated+<span class="string">"\n-------------------------"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断拥有角色：role1</span></span><br><span class="line">System.out.println(subject.hasRole(<span class="string">"role1"</span>));</span><br><span class="line"><span class="comment">// 判断拥有角色：role1 and role2</span></span><br><span class="line">System.out.println(subject.hasAllRoles(Arrays.asList(<span class="string">"role1"</span>, <span class="string">"role2"</span>)));</span><br><span class="line"><span class="comment">// 判断拥有角色：role1 role2 role3</span></span><br><span class="line"><span class="keyword">boolean</span>[] result = subject.hasRoles(Arrays.asList(<span class="string">"role1"</span>, <span class="string">"role2"</span>, <span class="string">"role3"</span>));</span><br><span class="line">System.out.println(Arrays.toString(result));</span><br><span class="line"></span><br><span class="line"><span class="comment">//还可以通过checkRole来检测是否具有某个角色，如果不具有这个角色，则抛出UnauthorizedException异常</span></span><br><span class="line">subject.checkRole(<span class="string">"role1"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断拥有权限：user:create</span></span><br><span class="line">System.out.println(subject.isPermitted(<span class="string">"user:create"</span>));</span><br><span class="line"><span class="comment">// 判断拥有权限：user:update and user:delete</span></span><br><span class="line">System.out.println(subject.isPermittedAll(<span class="string">"user:update"</span>, <span class="string">"user:delete"</span>));</span><br><span class="line"><span class="comment">// 判断没有权限：user:view</span></span><br><span class="line">System.out.println(subject.isPermitted(<span class="string">"user:view"</span>));</span><br><span class="line"></span><br><span class="line">subject.logout();</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<pre><code>登录成功
用户认证状态：true
-------------------------
true
true
[true, true, false]
true
true
false</code></pre><h3 id="Permission"><a href="#Permission" class="headerlink" title="Permission"></a>Permission</h3><p>字符串通配符权限</p>
<p>规则：资源标识符:操作:对象实例ID，即对哪个资源的哪个实例可以进行什么操作。<br>其默认支持通配符权限字符串，:表示资源/操作/实例的分割；,表示操作的分割；*表示任意资源/操作/实例。</p>
<pre><code>1 、单个资源单个权限
    subject().checkPermissions(&quot;system:user:update&quot;);
2、单个资源多个权限
ini：role1=system:user:update,system:user:delete
Java：subject().checkPermissions(&quot;system:user:update&quot;, &quot;system:user:delete&quot;);
用户拥有资源system:user的update和delete权限。如上可以简写成：
ini：role1=&quot;system:user:update,delete&quot;
Java：subject().checkPermissions(&quot;system:user:update,delete&quot;);

3、单个资源全部权限
ini：role1=system:user:create,update,delete,view
Java：subject().checkPermissions(&quot;system:user:create,delete,update:view&quot;);
用户拥有资源system:user的create、update、delete和view所有权限。
如上可以简写成：
ini：role1=system:user:*

4、所有资源全部权限
ini：role1=*:view
Java：subject().checkPermissions(&quot;user:view&quot;);
用户拥有所有资源的&quot;view&quot;所有权限。

5、实例级别的权限
单个实例单个权限
ini：roll=user:view:1
Java：subject().checkPermissions(&quot;user:view:1&quot;);

单个实例多个权限
ini：roll=&quot;user:update,delete:1&quot;
Java：
subject().checkPermissions(&quot;user:delete,update:1&quot;);
subject().checkPermissions(&quot;user:update:1&quot;, &quot;user:delete:1&quot;);

单个实例所有权限
ini：roll=user:*:1
Java：subject().checkPermissions(&quot;user:update:1&quot;, &quot;user:delete:1&quot;, &quot;user:view:1&quot;);

所有实例单个权限
ini：roll=user:auth:*
Java：subject().checkPermissions(&quot;user:auth:1&quot;, &quot;user:auth:2&quot;);

所有实例所有权限
ini：roll=user:*:*
Java：subject().checkPermissions(&quot;user:view:1&quot;, &quot;user:auth:2&quot;);</code></pre><h3 id="自定义Realm实现授权"><a href="#自定义Realm实现授权" class="headerlink" title="自定义Realm实现授权"></a>自定义Realm实现授权</h3><pre><code>ini：
[users]
hu=123,role1
yun=121,role2
[roles]
role1=user:create,user:update
role2=user:create,user:delete

[main]
#自定义 realm
userRealm=com.hu.test.MyRealmRole
#将realm设置到securityManager
securityManager.realms=$userRealm</code></pre><p>Realm：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 用于授权</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取身份信息</span></span><br><span class="line">        String username = (String) principals.getPrimaryPrincipal();</span><br><span class="line">        <span class="comment">// 根据身份信息获取权限数据</span></span><br><span class="line">        <span class="comment">// 模拟</span></span><br><span class="line">        List&lt;String&gt; permissions = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        permissions.add(<span class="string">"user:create"</span>);</span><br><span class="line">        permissions.add(<span class="string">"user:update"</span>);</span><br><span class="line">        <span class="comment">// 将权限信息保存到AuthorizationInfo中</span></span><br><span class="line">        SimpleAuthorizationInfo simpleAuthorizationInfo = <span class="keyword">new</span> SimpleAuthorizationInfo();</span><br><span class="line">        <span class="keyword">for</span> (String permission : permissions) &#123;</span><br><span class="line">                simpleAuthorizationInfo.addStringPermission(permission);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> simpleAuthorizationInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginLogoutTestRole</span> </span>&#123;</span><br><span class="line">       <span class="meta">@Test</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testHelloworld</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               Factory&lt;org.apache.shiro.mgt.SecurityManager&gt; factory = <span class="keyword">new</span> IniSecurityManagerFactory(<span class="string">"classpath:shiro.ini"</span>);</span><br><span class="line">               org.apache.shiro.mgt.SecurityManager securityManager = factory.getInstance();</span><br><span class="line">               SecurityUtils.setSecurityManager(securityManager);</span><br><span class="line">               Subject subject = SecurityUtils.getSubject();</span><br><span class="line">               <span class="comment">// 封装token信息</span></span><br><span class="line">               UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(<span class="string">"hu"</span>, <span class="string">"123"</span>);</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                       subject.login(token);</span><br><span class="line">                       <span class="keyword">if</span> (subject.isAuthenticated()) &#123;</span><br><span class="line">                               System.out.println(<span class="string">"登录成功"</span>);</span><br><span class="line">                       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                               System.out.println(<span class="string">"用户名或密码错误！"</span>);</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125; <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">                       System.out.println(<span class="string">"登录失败"</span>);</span><br><span class="line">                       e.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// 用户认证状态</span></span><br><span class="line">               <span class="keyword">boolean</span> isAuthenticated = subject.isAuthenticated();</span><br><span class="line">               System.out.println(<span class="string">"用户认证状态："</span> + isAuthenticated+<span class="string">"\n-------------------------"</span>);</span><br><span class="line"></span><br><span class="line">               <span class="comment">// 判断拥有权限：user:create</span></span><br><span class="line">               System.out.println(subject.isPermitted(<span class="string">"user:create"</span>));</span><br><span class="line">               System.out.println(subject.isPermitted(<span class="string">"user:update"</span>));</span><br><span class="line">               System.out.println(subject.isPermitted(<span class="string">"user:delete"</span>));</span><br><span class="line">               </span><br><span class="line">               subject.logout();</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<pre><code>my Realm Role    hu        123
登录成功
用户认证状态：true
-------------------------
true
true
false</code></pre><p>Authorizer 的职责是进行授权（访问控制），是 Shiro API 中授权核心的入口点，其提供了相应的角色/权限判断接口，具体请参考其 Javadoc。SecurityManager 继承了 Authorizer 接口，且提供了 ModularRealmAuthorizer 用于多 Realm 时的授权匹配。PermissionResolver 用于解析权限字符串到 Permission 实例，而 RolePermissionResolver 用于根据角色解析相应的权限集合。</p>
<p>我们可以通过如下 ini 配置更改 Authorizer 实现：</p>
<pre><code>authorizer=org.apache.shiro.authz.ModularRealmAuthorizer
securityManager.authorizer=$authorizer</code></pre><p>对于 ModularRealmAuthorizer，相应的 AuthorizingSecurityManager 会在初始化完成后自动将相应的 realm 设置进去，我们也可以通过调用其 setRealms()方法进行设置。</p>
<p>设置 ModularRealmAuthorizer 的 permissionResolver，其会自动设置到相应的 Realm 上（其实现了 PermissionResolverAware 接口）</p>
<pre><code>permissionResolver=org.apache.shiro.authz.permission.WildcardPermissionResolver
authorizer.permissionResolver=$permissionResolver</code></pre><p>设置 ModularRealmAuthorizer 的 rolePermissionResolver，其会自动设置到相应的 Realm 上（其实现了 RolePermissionResolverAware 接口）</p>
<pre><code>rolePermissionResolver=com.hu.test.MyRolePermissionResolver
authorizer.rolePermissionResolver=$rolePermissionResolver</code></pre><h2 id="会话管理"><a href="#会话管理" class="headerlink" title="会话管理"></a>会话管理</h2><p>Shiro 提供了完整的企业级会话管理功能，不依赖于底层容器（如 web 容器 tomcat），不管JavaSE 还是 JavaEE 环境都可以使用，提供了会话管理、会话事件监听、会话存储/持久化、容器无关的集群、失效/过期支持、对 Web 的透明支持、SSO 单点登录的支持等特性。即直接使用 Shiro 的会话管理可以直接替换如 Web 容器的会话管理。是完整的会话模块。</p>
<p>登录成功后使用 Subject.getSession()即可获取会话；其等价于 Subject.getSession(true)，即如果当前没有创建 Session 对象会创建一个；另外 Subject.getSession(false)，如果当前没有创建 Session 则返回 null（不过默认情况下如果启用会话存储功能的话在创建 Subject 时会主动创建一个 Session）。</p>
<pre><code>Subject subject = SecurityUtils.getSubject();
Session session = subject.getSession();

session.getId();//获取当前会话的唯一标识。
session.getHost();//获取当前 Subject 的主机地址，该地址是通过 HostAuthenticationToken.getHost()提供的。

session.getTimeout();
session.setTimeout(毫秒);</code></pre><p>获取/设置当前 Session 的过期时间；如果不设置默认是会话管理器的全局过期时间。</p>
<pre><code>session.getStartTimestamp();
session.getLastAccessTime();
获取会话的启动时间及最后访问时间；如果是 JavaSE 应用需要自己定期调用 session.touch()去更新最后访问时间；如果是 Web 应用，每次进入 ShiroFilter 都会自动调用 session.touch()来更新最后访问时间。

session.touch();
session.stop();</code></pre><p>更新会话最后访问时间及销毁会话；当 Subject.logout()时会自动调用 stop 方法来销毁会话。如果在web中，调用javax.servlet.http.HttpSession. invalidate()也会自动调用Shiro Session.stop方法进行销毁 Shiro 的会话。</p>
<pre><code>session.setAttribute(&quot;key&quot;, &quot;123&quot;);
session.getAttribute(&quot;key&quot;)
session.removeAttribute(&quot;key&quot;);</code></pre><p>设置/获取/删除会话属性；在整个会话范围内都可以对这些属性进行操作。</p>
<h3 id="会话管理器"><a href="#会话管理器" class="headerlink" title="会话管理器"></a>会话管理器</h3><p>会话管理器管理着应用中所有 Subject 的会话的创建、维护、删除、失效、验证等工作。是Shiro 的核心组件，顶层组件 SecurityManager 直接继承了 SessionManager，且提供了SessionsSecurityManager 实 现 直 接 把 会 话 管 理 委 托 给 相 应 的 SessionManager ，DefaultSecurityManager 及 DefaultWebSecurityManager 默认 SecurityManager 都继承了SessionsSecurityManager。</p>
<pre><code>Session start(SessionContext context); //启动会话
Session getSession(SessionKey key) throws SessionException; //根据会话 Key 获取会话</code></pre><p>用于 Web 环境的 WebSessionManager 又提供了如下接口</p>
<pre><code>boolean isServletContainerSessions();//是否使用 Servlet 容器的会话  
void validateSessions();//验证所有会话是否过期</code></pre><p>Shiro 提供了三个默认实现：</p>
<pre><code>DefaultSessionManager：DefaultSecurityManager 使用的默认实现，用于 JavaSE 环境；
ServletContainerSessionManager：DefaultWebSecurityManager 使用的默认实现，用于 Web环境，其直接使用 Servlet 容器的会话；
DefaultWebSessionManager ： 用于Web环境的实现 ， 可以替代ServletContainerSessionManager，自己维护着会话，直接废弃了 Servlet 容器的会话管理。


替换 SecurityManager 默认的 SessionManager 可以在 ini 中配置（shiro.ini）
[main]
sessionManager=org.apache.shiro.session.mgt.DefaultSessionManager
securityManager.sessionManager=$sessionManager

Web 环境下的 ini 配置(shiro-web.ini)：
[main]
sessionManager=org.apache.shiro.web.session.mgt.ServletContainerSessionManager
securityManager.sessionManager=$sessionManager</code></pre><p>设置会话的全局过期时间（毫秒为单位），默认 30 分钟</p>
<pre><code>sessionManager. globalSessionTimeout=1800000</code></pre><p>默认情况下 globalSessionTimeout 将应用给所有 Session。可以单独设置每个 Session 的timeout 属性来为每个 Session 设置其超时时间。</p>
<p>如果使用 ServletContainerSessionManager 进行会话管理，Session 的超时依赖于底层Servlet 容器的超时时间，可以在 web.xml 中配置其会话的超时时间（分钟为单位）</p>
<pre><code>&lt;session-config&gt;
&lt;session-timeout&gt;30&lt;/session-timeout&gt;
&lt;/session-config&gt;</code></pre><p>在 Servlet 容器中，默认使用 JSESSIONID Cookie 维护会话，且会话默认是跟容器绑定的；在某些情况下可能需要使用自己的会话机制，此时我们可以使用DefaultWebSessionManager来维护会话：</p>
<pre><code>sessionIdCookie=org.apache.shiro.web.servlet.SimpleCookie
sessionManager=org.apache.shiro.web.session.mgt.DefaultWebSessionManager
sessionIdCookie.name=sid
#sessionIdCookie.domain=sishuok.com
#sessionIdCookie.path=
sessionIdCookie.maxAge=1800
sessionIdCookie.httpOnly=true
sessionManager.sessionIdCookie=$sessionIdCookie
sessionManager.sessionIdCookieEnabled=true
securityManager.sessionManager=$sessionManager</code></pre><h3 id="会话监听"><a href="#会话监听" class="headerlink" title="会话监听"></a>会话监听</h3><p>会话监听器用于监听会话创建、过期及停止事件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySessionListener1</span> <span class="keyword">implements</span> <span class="title">SessionListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">(Session session)</span> </span>&#123;<span class="comment">//会话创建时触发</span></span><br><span class="line">        System.out.println(<span class="string">"会话创建："</span> + session.getId());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onExpiration</span><span class="params">(Session session)</span> </span>&#123;<span class="comment">//会话过期时触发</span></span><br><span class="line">    System.out.println(<span class="string">"会话过期："</span> + session.getId());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">(Session session)</span> </span>&#123;<span class="comment">//退出/会话过期时触发</span></span><br><span class="line">        System.out.println(<span class="string">"会话停止："</span> + session.getId());</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    如果只想监听某一个事件，可以继承 SessionListenerAdapter 实现：</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySessionListener2</span> <span class="keyword">extends</span> <span class="title">SessionListenerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">(Session session)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"会话创建："</span> + session.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 shiro-web.ini 配置文件中可以进行如下配置设置会话监听器：</p>
<pre><code>sessionListener1=com.github.zhangkaitao.shiro.chapter10.web.listener.MySessionListener1
sessionListener2=com.github.zhangkaitao.shiro.chapter10.web.listener.MySessionListener2
sessionManager.sessionListeners=$sessionListener1,$sessionListener2</code></pre><h3 id="会话存储-持久化"><a href="#会话存储-持久化" class="headerlink" title="会话存储/持久化"></a>会话存储/持久化</h3><p>Shiro 提供 SessionDAO 用于会话的 CRUD，即 DAO（Data Access Object）模式实现，如 DefaultSessionManager 在创建完 session 后会调用该方法；如保存到关系数据库/文件系统/NoSQL 数据库；即可以实现会话的持久化；返回会话 ID；主要此处返回的ID.equals(session.getId())；</p>
<pre><code>Serializable create(Session session);
//根据会话 ID 获取会话
Session readSession(Serializable sessionId) throws UnknownSessionException;
//更新会话；如更新会话最后访问时间/停止会话/设置超时时间/设置移除属性等会调用
void update(Session session) throws UnknownSessionException;
//删除会话；当会话过期/会话停止（如用户退出时）会调用
void delete(Session session);
//获取当前所有活跃用户，如果用户量多此方法影响性能</code></pre><p><img src="https://img.huyunshun.com/img/20200421184538.png" alt="20200421184538"></p>
<p>AbstractSessionDAO提供了SessionDAO的基础实现，如生成会话ID等；CachingSessionDAO提供了对开发者透明的会话缓存的功能，只需要设置相应的 CacheManager 即可；MemorySessionDAO 直接在内存中进行会话维护；而 EnterpriseCacheSessionDAO 提供了缓存功能的会话维护，默认情况下使用 MapCache 实现，内部使用 ConcurrentHashMap 保存缓存的会话。</p>
<pre><code>sessionDAO=org.apache.shiro.session.mgt.eis.EnterpriseCacheSessionDAO
sessionManager.sessionDAO=$sessionDAO</code></pre><p>Shiro 提供了使用 Ehcache 进行会话存储，Ehcache 可以配合 TerraCotta 实现容器无关的布式集群。</p>
<h2 id="缓存机制"><a href="#缓存机制" class="headerlink" title="缓存机制"></a>缓存机制</h2><p>Shiro 提供了类似于 Spring 的 Cache 抽象，即 Shiro 本身不实现 Cache，但是对 Cache 进行了又抽象，方便更换不同的底层 Cache 实现。</p>
<p>Shiro  提供的 的 Cache ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Cache</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"><span class="comment">//根据 Key 获取缓存中的值</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(K key)</span> <span class="keyword">throws</span> CacheException</span>;</span><br><span class="line"><span class="comment">//往缓存中放入 key-value，返回缓存中之前的值</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> <span class="keyword">throws</span> CacheException</span>;</span><br><span class="line"><span class="comment">//移除缓存中 key 对应的值，返回该值</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">remove</span><span class="params">(K key)</span> <span class="keyword">throws</span> CacheException</span>;</span><br><span class="line"><span class="comment">//清空整个缓存</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> <span class="keyword">throws</span> CacheException</span>;</span><br><span class="line"><span class="comment">//返回缓存大小</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">//获取缓存中所有的 key</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;K&gt; <span class="title">keys</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">//获取缓存中所有的 value</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Collection&lt;V&gt; <span class="title">values</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Shiro  提供的 的 CacheManager  接口：</p>
<pre><code>public interface CacheManager {
    //根据缓存名字获取一个 Cache
    public &lt;K, V&gt; Cache&lt;K, V&gt; getCache(String name) throws CacheException;
}</code></pre><p>Shiro  还 提供了 了 CacheManagerAware  用 于注入 CacheManager ：</p>
<pre><code>public interface CacheManagerAware {
    //注入 CacheManager
    void setCacheManager(CacheManager cacheManager);
}</code></pre><p>Shiro 内部相应的组件（DefaultSecurityManager）会自动检测相应的对象（如 Realm）是实现了 CacheManagerAware 并自动注入相应的 CacheManager。</p>
<h3 id="Realm缓存"><a href="#Realm缓存" class="headerlink" title="Realm缓存"></a>Realm缓存</h3><p>Shiro 提供了 CachingRealm，其实现了 CacheManagerAware 接口，提供了缓存的一些基础实现；另外 AuthenticatingRealm 及 AuthorizingRealm 分别提供了对 AuthenticationInfo 和AuthorizationInfo 信息的缓存。</p>
<pre><code>userRealm=com......realm.UserRealm
userRealm.credentialsMatcher=$credentialsMatcher
userRealm.cachingEnabled=true
userRealm.authenticationCachingEnabled=true
userRealm.authenticationCacheName=authenticationCache
userRealm.authorizationCachingEnabled=true
userRealm.authorizationCacheName=authorizationCache
securityManager.realms=$userRealm
cacheManager=org.apache.shiro.cache.ehcache.EhCacheManager
cacheManager.cacheManagerConfigFile=classpath:shiro-ehcache.xml
securityManager.cacheManager=$cacheManager

userRealm.cachingEnabled：启用缓存，默认 false；
userRealm.authenticationCachingEnabled：启用身份验证缓存，即缓存 AuthenticationInfo 信息，默认 false；
userRealm.authenticationCacheName：缓存 AuthenticationInfo 信息的缓存名称；
userRealm. authorizationCachingEnabled：启用授权缓存，即缓存 AuthorizationInfo 信息，默认 false；
userRealm. authorizationCacheName：缓存 AuthorizationInfo 信息的缓存名称；
cacheManager：缓存管理器，此处使用 EhCacheManager，即 Ehcache 实现，需要导入相应的 Ehcache 依赖，</code></pre><h3 id="Session缓存"><a href="#Session缓存" class="headerlink" title="Session缓存"></a>Session缓存</h3><p>当我们设置了 SecurityManager 的 CacheManager 时，如：securityManager.cacheManager=$cacheManager<br>当我们设置 SessionManager 时：</p>
<pre><code>sessionManager=org.apache.shiro.session.mgt.DefaultSessionManager
securityManager.sessionManager=$sessionManager</code></pre><p>如 securityManager 实现了 SessionsSecurityManager，其会自动判断 SessionManager 是否实现了 CacheManagerAware 接口，如果实现了会把 CacheManager 设置给它。然后sessionManager 会判断相应的 sessionDAO（如继承自 CachingSessionDAO）是否实现了CacheManagerAware，如果实现了会把 CacheManager 设置给它；其会先查缓存，如果找不到才查数据库。</p>
<p>对于 CachingSessionDAO，可以通过如下配置设置缓存的名称：</p>
<pre><code>sessionDAO=com.github.zhangkaitao.shiro.chapter11.session.dao.MySessionDAO
sessionDAO.activeSessionsCacheName=shiro-activeSessionCache</code></pre><p>activeSessionsCacheName 默认就是 shiro-activeSessionCache。</p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2018/02/20/MySQL+MyCat%20%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/20/MySQL+MyCat%20%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" itemprop="url">MySQL+MyCat 分库分表</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-20T00:00:00+08:00">
                2018-02-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="MyCat介绍"><a href="#MyCat介绍" class="headerlink" title="MyCat介绍"></a>MyCat介绍</h2><p>系统开发中，数据库是非常重要的一个点。除了程序的本身的优化，如：SQL语句优化、代码优化，数据库的处理本身优化也是非常重要的。主从、热备、分表分库等都是系统发展迟早会遇到的技术问题问题。</p>
<p>MyCat是一个开源的分布式数据库系统，是一个实现了MySQL协议的服务器，前端用户可以把它看作是一个数据库代理，用MySQL客户端工具和命令行访问，而其后端可以用MySQL原生协议与多个MySQL服务器通信，也可以用JDBC协议与大多数主流数据库服务器通信，其核心功能是分表分库，即将一个大表水平分割为N个小表，存储在后端MySQL服务器里或者其他数据库里。</p>
<p>MyCat发展到目前的版本，已经不是一个单纯的MySQL代理了，它的后端可以支持MySQL、SQL Server、Oracle、DB2、PostgreSQL等主流数据库，也支持MongoDB这种新型NoSQL方式的存储，未来还会支持更多类型的存储。而在最终用户看来，无论是那种存储方式，在MyCat里，都是一个传统的数据库表，支持标准的SQL语句进行数据的操作，这样一来，对前端业务系统来说，可以大幅降低开发难度，提升开发速度。</p>
<p><img src="https://img.huyunshun.com/img/20200420190855.png" alt="20200420190855"></p>
<p>MyCat 是使用 Java 编写的数据库中间件，运行在代码应用和 MySQL 数据库之间的应用。它的前身是阿里开发的数据库中间件corba，实现 MySQL 数据库分库分表集群管理的中间件，曾经出现过重大事故而放弃，被部分人员进行二次开发，形成 Mycat，使用 MyCat 之后，编写的所有的 SQL 语句必须严格遵守 SQL 标准规范.<br>使用 MyCat 中间件后的结构图如下：</p>
<p><img src="https://img.huyunshun.com/img/20200420190928.png" alt="20200420190928"></p>
<p>当我们的应用只需要一台数据库服务器的时候我们并不需要Mycat，而如果你需要分库甚至分表，这时候应用要面对很多个数据库的时候，这个时候就需要对数据库层做一个抽象，来管理这些数据库，而最上面的应用只需要面对一个数据库层的抽象或者说数据库中间件就好了，这就是Mycat的核心作用。</p>
<p>所以可以这样理解：数据库是对底层存储文件的抽象，而Mycat是对数据库的抽象。</p>
<h3 id="数据库切分"><a href="#数据库切分" class="headerlink" title="数据库切分"></a>数据库切分</h3><pre><code>逻辑上的切分，在物理层面，是使用多库[database]，多表[table]实现切分。分为横向和纵向切分；
横向切分：把一个表切分成多个表，相比纵向切分配置麻烦，无法实现表连接查询. 将一张表的字段，分散到若干张表中，将若干表连接到一起，才是当前表的完整数据。
纵向切分：把一个数据库切分成多个数据库，配置方便，只能实现两张表的表连接查询，将一张表中的数据，分散到若干个 database 的同结构表中。多个表的数据的集合是当前表格的数据。</code></pre><h3 id="Mycat-中的DB"><a href="#Mycat-中的DB" class="headerlink" title="Mycat 中的DB"></a>Mycat 中的DB</h3><pre><code>Mycat 中定义的 database是逻辑上的，但是物理上未必存在。主要是针对纵向切分提供的概念，访问 MyCat，就是将 MyCat 当做 MySQL 使用。</code></pre><p>db 数据库是 MyCat 中定义的 database。通过 SQL 访问 MyCat 中的 db 库的时候，对应的是 MySQL 中的 db1，db2，db3 三个库。物理上的 database 是 db1，db2，db3.逻辑上的<br>database 就是 db。</p>
<h3 id="Mycat-中的表"><a href="#Mycat-中的表" class="headerlink" title="Mycat 中的表"></a>Mycat 中的表</h3><p>逻辑意义上的表，一个MaCat的table可以对应物理库上的多个表。</p>
<p>Mycat 默认端口：8066</p>
<pre><code>数据主机：dataHost

物理 MySQL 存放的主机地址，可以使用主机名、IP、域名定义。
数据节点：dataNode 物理的 database 是什么，数据保存的物理节点就是 database。
分片规则：当控制数据的时候，如何访问物理 database 和 table， 就是访问 dataHost 和 dataNode 的算法。
在 Mycat 处理具体的数据 CRUD 的时候，如何访问 dataHost 和 dataNode 的算法.如:哈希算法,crc16 算法等</code></pre><h2 id="MyCat实现分库分表读写分离"><a href="#MyCat实现分库分表读写分离" class="headerlink" title="MyCat实现分库分表读写分离"></a>MyCat实现分库分表读写分离</h2><h3 id="一、搭建准备"><a href="#一、搭建准备" class="headerlink" title="一、搭建准备"></a>一、搭建准备</h3><pre><code>MyCat：192.168.1.105
MySQL master：192.168.1.103
MySQL slave：192.168.1.104

在需要搭建环境的机器上安装jdk，MySQL。这里使用上个例子的节点，关闭MySQL-Proxy功能，在原有的MySQL-Proxy机器上安装MyCat。
两台数据库上设置可供mycat访问的用户密码
mysql&gt; grant all privileges on *.* to &apos;mycat&apos;@&apos;%&apos; identified by &apos;mycat&apos; with grant option;
mysql&gt; flush privileges;</code></pre><h3 id="二、安装配置MyCat"><a href="#二、安装配置MyCat" class="headerlink" title="二、安装配置MyCat"></a>二、安装配置MyCat</h3><h4 id="1、下载Mycat官网：http-www-mycat-io"><a href="#1、下载Mycat官网：http-www-mycat-io" class="headerlink" title="1、下载Mycat官网：http://www.mycat.io/"></a>1、下载Mycat官网：<a href="http://www.mycat.io/" target="_blank" rel="noopener">http://www.mycat.io/</a></h4><pre><code>下载Mycat-server-1.6.6.1-release-20181031195535-linux.tar.gz到Linux并解压到/usr/local/mycat
bin        mycat命令，启动、重启、停止等
catlet        catlet为Mycat的一个扩展功能
conf        Mycat 配置信息,重点关注
lib        Mycat引用的jar包，Mycat是java开发的
logs        日志文件，包括Mycat启动的日志和运行的日志。
直接运行测试一下：
[root@localhost mycat]# bin/mycat start
Starting Mycat-server...
[root@localhost mycat]# bin/mycat status
Mycat-server is running (20038).
远程登录看一下
[root@localhost mysql-proxy]# mysql -uroot -p123456 -h192.168.1.105 -P8066
mysql&gt; show databases;
+----------+
| DATABASE |
+----------+
| TESTDB   |
+----------+
mysql&gt; use TESTDB;
mysql&gt; show tables;
+------------------+
| Tables in TESTDB |
+------------------+
| company          |
| customer         |
| customer_addr    |
| employee         |
| goods            |
| hotnews          |
| orders           |
| order_items      |
| travelrecord     |
+------------------+</code></pre><p>初步测试MyCat没问题，配置文件中配置的逻辑表和库都能查到，但是不能查看数据，因为数据永远在物理库中，并且默认也米有配置对应真实的物理库。</p>
<h4 id="2、配置示例测试"><a href="#2、配置示例测试" class="headerlink" title="2、配置示例测试"></a>2、配置示例测试</h4><p>示例、配置分库，比如一个库demo的user表中有20w数据，现在进行分3个库，表结构一样，大概分别存6w左右数据。</p>
<p>第一步，创建好分库，表可以先不用创建。分别为demo1，demo2，demo3。</p>
<pre><code>schema.xml配置如下：需要分库的数据库也放进来。</code></pre><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mycat</span>:schema <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"schema.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">"http://io.mycat/"</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!--逻辑库表创建--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">"demo"</span> <span class="attr">checkSQLschema</span>=<span class="string">"false"</span> <span class="attr">sqlMaxLimit</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">dataNode</span>=<span class="string">"demo1,demo2,demo3"</span> <span class="attr">rule</span>=<span class="string">"crc32slot"</span> /&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">"olddemo"</span> <span class="attr">checkSQLschema</span>=<span class="string">"false"</span> <span class="attr">sqlMaxLimit</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">dataNode</span>=<span class="string">"demo_old"</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">       </span><br><span class="line">       <span class="comment">&lt;!--逻辑节点，对应物理库--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">"demo1"</span> <span class="attr">dataHost</span>=<span class="string">"host103"</span> <span class="attr">database</span>=<span class="string">"demo1"</span> /&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">"demo2"</span> <span class="attr">dataHost</span>=<span class="string">"host103"</span> <span class="attr">database</span>=<span class="string">"demo2"</span> /&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">"demo3"</span> <span class="attr">dataHost</span>=<span class="string">"host103"</span> <span class="attr">database</span>=<span class="string">"demo3"</span> /&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">"demo_old"</span> <span class="attr">dataHost</span>=<span class="string">"host103"</span> <span class="attr">database</span>=<span class="string">"demo"</span> /&gt;</span></span><br><span class="line">       </span><br><span class="line">       <span class="comment">&lt;!--物理库配置--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">"host103"</span> <span class="attr">maxCon</span>=<span class="string">"1000"</span> <span class="attr">minCon</span>=<span class="string">"10"</span> <span class="attr">balance</span>=<span class="string">"0"</span> <span class="attr">writeType</span>=<span class="string">"0"</span> <span class="attr">dbType</span>=<span class="string">"mysql"</span> <span class="attr">dbDriver</span>=<span class="string">"native"</span> <span class="attr">switchType</span>=<span class="string">"1"</span> <span class="attr">slaveThreshold</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"hostM1"</span> <span class="attr">url</span>=<span class="string">"192.168.1.103:3306"</span> <span class="attr">user</span>=<span class="string">"mycat"</span> <span class="attr">password</span>=<span class="string">"mycat"</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">"hostS1"</span> <span class="attr">url</span>=<span class="string">"192.168.1.104:3306"</span> <span class="attr">user</span>=<span class="string">"mycat"</span> <span class="attr">password</span>=<span class="string">"mycat"</span> /&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br><span class="line">               rule.xml中修改，因为使用crc32slot分片规则，这个规要配置分片的数据库节点数量</span><br><span class="line">                       <span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">"crc32slot"</span> <span class="attr">class</span>=<span class="string">"io.mycat.route.function.PartitionByCRC32PreSlot"</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"count"</span>&gt;</span>3<span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="comment">&lt;!-- 要分片的数据库节点数量，必须指定，否则没法分片 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line">               server.xml配置用户和该用户使用规则</span><br><span class="line">                       <span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">"root"</span> <span class="attr">defaultAccount</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"schemas"</span>&gt;</span>demo,olddemo<span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="comment">&lt;!---可以访问哪些逻辑库----&gt;</span></span><br><span class="line">               </span><br><span class="line">               <span class="comment">&lt;!-- 表级 DML 权限设置 --&gt;</span></span><br><span class="line">               <span class="comment">&lt;!--                 </span></span><br><span class="line"><span class="comment">               &lt;privileges check="false"&gt;</span></span><br><span class="line"><span class="comment">                       &lt;schema name="TESTDB" dml="0110" &gt;</span></span><br><span class="line"><span class="comment">                               &lt;table name="tb01" dml="0000"&gt;&lt;/table&gt;</span></span><br><span class="line"><span class="comment">                               &lt;table name="tb02" dml="1111"&gt;&lt;/table&gt;</span></span><br><span class="line"><span class="comment">                       &lt;/schema&gt;</span></span><br><span class="line"><span class="comment">               &lt;/privileges&gt;                </span></span><br><span class="line"><span class="comment">                --&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p> 第二步：创建表，直接在MyCat里创建，都会分别同步到demo123库中</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user`</span> (</span><br><span class="line"> <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line"> <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line"> PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>在三个库查看表结构，都ok，slave节点也查看。</p>
<pre><code>mysql&gt; show tables from demo3;
+-----------------+
| Tables_in_demo3 |
+-----------------+
| user            |
+-----------------+

mysql&gt; desc demo1.user;
+-------+-------------+------+-----+---------+-------+
| Field | Type        | Null | Key | Default | Extra |
+-------+-------------+------+-----+---------+-------+
| id    | int(10)     | NO   | PRI | NULL    |       |
| name  | varchar(20) | YES  |     | NULL    |       |
| _slot | int(11)     | YES  |     | NULL    |       |
+-------+-------------+------+-----+---------+-------+
3 rows in set (0.00 sec)</code></pre><p>发现多了一个_slot字段，这是因为使用了crc32slot分片规则得到的hash值。、</p>
<p>通过写脚本或者其他方式把源数据通过到新库。</p>
<h4 id="读写分离设置"><a href="#读写分离设置" class="headerlink" title="读写分离设置"></a>读写分离设置</h4><p>balance=”1”，全部的 readHost 与 stand by writeHost 参与 select 语句的负载均衡，简单的说，当双主双从模式(M1-&gt;S1，M2-&gt;S2，并且 M1 与 M2 互为主备)，正常情况下，M2,S1,S2 都参与 select 语句的负载均衡。</p>
<p>balance=”3”，所有读请求随机的分发到 wiriterHost 对应的 readhost 执行，writerHost 不负担读压力，注意 balance=3 只在 1.4 及其以后版本有，1.3 没有。</p>
<p>示例：分表，单裤分表</p>
<p>场景：demo库中t_user表分成两个库t_users1/t_users2</p>
<p> 核心配置：<br> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">"olddemo"</span> <span class="attr">checkSQLschema</span>=<span class="string">"false"</span> <span class="attr">sqlMaxLimit</span>=<span class="string">"1000000"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">dataNode</span>=<span class="string">"demo_old"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"t_users"</span> <span class="attr">subTables</span>=<span class="string">"t_users$1-2"</span> <span class="attr">primaryKey</span>=<span class="string">"id"</span> <span class="attr">dataNode</span>=<span class="string">"demo_old"</span> <span class="attr">rule</span>=<span class="string">"mod-long"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">               rule：</span><br><span class="line">                 <span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">"mod-long"</span> <span class="attr">class</span>=<span class="string">"io.mycat.route.function.PartitionByMod"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"count"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure><br>在数据库分别创建好t_users1/t_users2</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_users1`</span> (</span><br><span class="line"> <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line"> <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line"> PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>启动并连接到MyCat：把老表中的数据通过MyCat复制到新表，在、查看数据，可以看出，根据mod-long规则每条数据交替存储到新表。</p>
<p>查询分析可以看出去两个物理表中查询数据：</p>
<p><img src="https://img.huyunshun.com/img/20200420190612.png" alt="20200420190612"></p>
<p>查询结果是把两个表结果合并起来：</p>
<p><img src="https://img.huyunshun.com/img/20200420190637.png" alt="20200420190637"></p>
<pre><code>bin/mycat console 启动不成功可以通过这个命令查看原因
logs/wrapper.log   日志中记录的是所有的 mycat 操作. 查看的时候主要看异常信息 caused by 信息    </code></pre><p> 注：<strong>使用分片规则，MyCat启动后会在conf目录中创建一个ruledata下有使用规则信息分配的一个缓存文件，如果修改的分配规则，再次重启MyCat发现运用这个规则的缓存文件在就不会去重新生成，可能就得不到预计结果，所以，在重启前把这个目录对应的文件删除，让MyCat重新生成。</strong></p>
<pre><code>不能创建未在 schema.xml 中配置的逻辑表            </code></pre><p>注意：如何部署</p>
<pre><code>1、停机部署法：大致思路就是半夜停机升级，服务停了，跑数据迁移程序，进行数据迁移。
        写一个迁移程序，读db-old数据库，通过中间件写入新库db-new1和db-new2。
        校验迁移前后一致性，没问题就切该部分业务到新库
缺点：只能是访问量不高的，而且部署或有问题，没部署好，早上又要把数据切回去，晚上有的忙，身心累。

2、双写部署1
        上线一段代码：和表有关业务之前加一段代码，同时往老新库写。
                历史数据：在该次部署前，数据库表test_tb的有关数据，我们称之为历史数据。
                增量数据：在该次部署后，数据库表test_tb的新产生的数据，我们称之为增量数据。
        多加一条往消息队列中发消息的代码，只是写的sql。
        等到db-old中的历史数据迁移完毕，则开始迁移增量数据，也就是在消息队列里的数据。将迁移程序下线，写一段订阅程序订阅消息队列中的数据，订阅程序将订阅到到数据，通过中间件写入新库，新老库一致性验证，去除代码中的双写代码，将涉及到test_tb表的读写操作，指向新库。
3、双写部署2
        上面方式造成了严重的代码入侵。将非业务代码嵌入业务代码。
        替代办法是，记录日志。往消息队列里发的消息，都是写操作的消息。而binlog日志记录的也是写操作。所以订阅该日志，也能满足我们的需求。
        打开binlog日志，迁移好历史数据后，写一个订阅程序，订阅binlog(mysql中有canal)。然后将订阅到的数据通过中间件，写入新库。</code></pre><h2 id="MyCat配置文件介绍"><a href="#MyCat配置文件介绍" class="headerlink" title="MyCat配置文件介绍"></a>MyCat配置文件介绍</h2><p>Mycat的配置文件都在conf目录里面，这里介绍几个常用的文件：</p>
<pre><code>server.xml        Mycat的配置文件，设置账号、参数等
schema.xml        Mycat对应的物理数据库和数据库表的配置
rule.xml        Mycat分片（分库分表）规则</code></pre><h3 id="server-xml"><a href="#server-xml" class="headerlink" title="server.xml"></a>server.xml</h3><p>配置 Mycat 服务信息，如: Mycat中的用户，用户可以访问的逻辑库/表，服务的端口号等等。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mycat:server</span> <span class="attr">xmlns:mycat</span>=<span class="string">"http://io.mycat/"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">system</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"nonePasswordLogin"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span> <span class="comment">&lt;!-- 0为需要密码登陆、1为不需要密码登陆 ,默认为0，设置为1则需要指定默认账户--&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useHandshakeV10"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useSqlStat"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span>  <span class="comment">&lt;!-- 1为开启实时统计、0为关闭 --&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useGlobleTableCheck"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span>  <span class="comment">&lt;!-- 1为开启全加班一致性检测、0为关闭 --&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sequnceHandlerType"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"subqueryRelationshipCheck"</span>&gt;</span>false<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!-- 子查询中存在关联查询的情况下,检查关联字段中是否有分片字段 .默认 false --&gt;</span></span><br><span class="line">         <span class="comment">&lt;!--&lt;property name="useCompression"&gt;1&lt;/property&gt;--&gt;</span> <span class="comment">&lt;!--1为开启mysql压缩协议--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;property name="fakeMySQLVersion"&gt;5.6.20&lt;/property&gt;--&gt;</span> <span class="comment">&lt;!--设置模拟的MySQL版本号--&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--&lt;property name="processorBufferChunk"&gt;40960&lt;/property&gt; --&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--&lt;property name="processors"&gt;1&lt;/property&gt;</span></span><br><span class="line"><span class="comment">           &lt;property name="processorExecutor"&gt;32&lt;/property&gt; --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--默认为type 0: DirectByteBufferPool | type 1 ByteBufferArena | type 2 NettyBufferPool --&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"processorBufferPoolType"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--默认是65535 64K 用于sql解析时最大文本长度 --&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--&lt;property name="maxStringLiteralLength"&gt;65535&lt;/property&gt;--&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--&lt;property name="sequnceHandlerType"&gt;0&lt;/property&gt;--&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--&lt;property name="backSocketNoDelay"&gt;1&lt;/property&gt;--&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--&lt;property name="frontSocketNoDelay"&gt;1&lt;/property&gt;--&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--&lt;property name="processorExecutor"&gt;16&lt;/property&gt;--&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">           &lt;property name="serverPort"&gt;8066&lt;/property&gt;</span></span><br><span class="line"><span class="comment">           &lt;property name="managerPort"&gt;9066&lt;/property&gt;</span></span><br><span class="line"><span class="comment">           &lt;property name="idleTimeout"&gt;300000&lt;/property&gt;</span></span><br><span class="line"><span class="comment">           &lt;property name="bindIp"&gt;0.0.0.0&lt;/property&gt;</span></span><br><span class="line"><span class="comment">           &lt;property name="frontWriteQueueSize"&gt;4096&lt;/property&gt;</span></span><br><span class="line"><span class="comment">           &lt;property name="processors"&gt;32&lt;/property&gt; --&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--分布式事务开关，0为不过滤分布式事务，</span></span><br><span class="line"><span class="comment">                                           1为过滤分布式事务（如果分布式事务内只涉及全局表，则不过滤），</span></span><br><span class="line"><span class="comment">                                           2为不过滤分布式事务,但是记录分布式事务日志--&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"handleDistributedTransactions"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--off heap for merge/order/group/limit      1开启   0关闭--&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useOffHeapForMerge"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--单位为m--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"memoryPageSize"</span>&gt;</span>64k<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--单位为k--&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"spillsFileBufferSize"</span>&gt;</span>1k<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useStreamOutput"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--单位为m--&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"systemReserveMemorySize"</span>&gt;</span>384m<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--是否采用zookeeper协调切换  --&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useZKSwitch"</span>&gt;</span>false<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!-- XA Recovery Log日志路径 --&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--&lt;property name="XARecoveryLogBaseDir"&gt;./&lt;/property&gt;--&gt;</span></span><br><span class="line">           <span class="comment">&lt;!-- XA Recovery Log日志名称 --&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--&lt;property name="XARecoveryLogBaseName"&gt;tmlog&lt;/property&gt;--&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--如果为 true的话 严格遵守隔离级别,不会在仅仅只有select语句的时候在事务中切换连接--&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"strictTxIsolation"</span>&gt;</span>false<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useZKSwitch"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">system</span>&gt;</span>       </span><br><span class="line">   <span class="comment">&lt;!-- 全局SQL防火墙设置 --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--白名单可以使用通配符%或着*--&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--例如&lt;host host="127.0.0.*" user="root"/&gt;--&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--例如&lt;host host="127.0.*" user="root"/&gt;--&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--例如&lt;host host="127.*" user="root"/&gt;--&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--例如&lt;host host="1*7.*" user="root"/&gt;--&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--这些配置情况下对于127.0.0.1都能以root账户登录--&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">   &lt;firewall&gt;</span></span><br><span class="line"><span class="comment">          &lt;whitehost&gt;</span></span><br><span class="line"><span class="comment">                 &lt;host host="1*7.0.0.*" user="root"/&gt;</span></span><br><span class="line"><span class="comment">          &lt;/whitehost&gt;</span></span><br><span class="line"><span class="comment">  &lt;blacklist check="false"&gt;</span></span><br><span class="line"><span class="comment">  &lt;/blacklist&gt;</span></span><br><span class="line"><span class="comment">   &lt;/firewall&gt;</span></span><br><span class="line"><span class="comment">   --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">"root"</span> <span class="attr">defaultAccount</span>=<span class="string">"true"</span>&gt;</span><span class="comment">&lt;!--user--&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"schemas"</span>&gt;</span>TESTDB<span class="tag">&lt;/<span class="name">property</span>&gt;</span>               </span><br><span class="line">           <span class="comment">&lt;!-- 表级 DML 权限设置 --&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--               </span></span><br><span class="line"><span class="comment">           &lt;privileges check="false"&gt;</span></span><br><span class="line"><span class="comment">                           &lt;schema name="TESTDB" dml="0110" &gt;</span></span><br><span class="line"><span class="comment">                                           &lt;table name="tb01" dml="0000"&gt;&lt;/table&gt;</span></span><br><span class="line"><span class="comment">                                           &lt;table name="tb02" dml="1111"&gt;&lt;/table&gt;</span></span><br><span class="line"><span class="comment">                           &lt;/schema&gt;</span></span><br><span class="line"><span class="comment">           &lt;/privileges&gt;               </span></span><br><span class="line"><span class="comment">                --&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">"user"</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span>&gt;</span>user<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"schemas"</span>&gt;</span>TESTDB<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"readOnly"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:server</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="rule-xml"><a href="#rule-xml" class="headerlink" title="rule.xml"></a>rule.xml</h3><p>用于定义分片规则的配置文件，主要是查看，很少修改。里边定义了很多分配规则比如：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">"auto-sharding-long"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>rang-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">........</span><br><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">"crc32slot"</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>crc32slot<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>auto-sharding-long：mycat 默认的分片规则：以 500 万为单位，实现分片规则。逻辑库 A 对应 dataNode - db1 和 db2. 1-500 万保存在 db1 中, 500 万零 1 到 1000 万保存在 db2 中，1000 万零 1 到 1500 万保存在 db1 中，依次类推。<br>crc32slot：在 CRUD 操作时,根据具体数据的 crc32 算法计算,数据应该保存在哪一个dataNode 中. 算法类似模运算。</p>
<h3 id="server-xml-1"><a href="#server-xml-1" class="headerlink" title="server.xml"></a>server.xml</h3><p>用于定义逻辑库和逻辑表的配置文件.在配置文件中可以定义读写分离,逻辑库,逻辑表,dataHost,dataNode 等信息。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">"http://io.mycat/"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">"TESTDB"</span> <span class="attr">checkSQLschema</span>=<span class="string">"false"</span> <span class="attr">sqlMaxLimit</span>=<span class="string">"100"</span>&gt;</span>               </span><br><span class="line">           <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"travelrecord"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2,dn3"</span> <span class="attr">rule</span>=<span class="string">"auto-sharding-long"</span> /&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"hotnews"</span> <span class="attr">primaryKey</span>=<span class="string">"ID"</span> <span class="attr">autoIncrement</span>=<span class="string">"true"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2,dn3"</span> <span class="attr">rule</span>=<span class="string">"mod-long"</span> /&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"dual"</span> <span class="attr">primaryKey</span>=<span class="string">"ID"</span> <span class="attr">dataNode</span>=<span class="string">"dnx,dnoracle2"</span> <span class="attr">type</span>=<span class="string">"global"</span> <span class="attr">needAddLimit</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"customer"</span> <span class="attr">primaryKey</span>=<span class="string">"ID"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2"</span> <span class="attr">rule</span>=<span class="string">"sharding-by-intfile"</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">"orders"</span> <span class="attr">primaryKey</span>=<span class="string">"ID"</span> <span class="attr">joinKey</span>=<span class="string">"customer_id"</span> <span class="attr">parentKey</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">                                           <span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">"order_items"</span> <span class="attr">joinKey</span>=<span class="string">"order_id"</span> <span class="attr">parentKey</span>=<span class="string">"id"</span> /&gt;</span></span><br><span class="line">                           <span class="tag">&lt;/<span class="name">childTable</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">"customer_addr"</span> <span class="attr">primaryKey</span>=<span class="string">"ID"</span> <span class="attr">joinKey</span>=<span class="string">"customer_id"</span> <span class="attr">parentKey</span>=<span class="string">"id"</span> /&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">table</span>&gt;</span>               </span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">"dn1$0-743"</span> <span class="attr">dataHost</span>=<span class="string">"localhost1"</span> <span class="attr">database</span>=<span class="string">"db$0-743"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">"localhost1"</span> <span class="attr">maxCon</span>=<span class="string">"1000"</span> <span class="attr">minCon</span>=<span class="string">"10"</span> <span class="attr">balance</span>=<span class="string">"0"</span> <span class="attr">writeType</span>=<span class="string">"0"</span> <span class="attr">dbType</span>=<span class="string">"mysql"</span> <span class="attr">dbDriver</span>=<span class="string">"native"</span> <span class="attr">switchType</span>=<span class="string">"1"</span>  <span class="attr">slaveThreshold</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span>               </span><br><span class="line">           <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"hostM1"</span> <span class="attr">url</span>=<span class="string">"localhost:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span>  <span class="attr">password</span>=<span class="string">"123456"</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">"hostS2"</span> <span class="attr">url</span>=<span class="string">"192.168.1.200:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"xxx"</span> /&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"hostS1"</span> <span class="attr">url</span>=<span class="string">"localhost:3316"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"123456"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span>       </span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="配置解释"><a href="#配置解释" class="headerlink" title="配置解释"></a>配置解释</h3><pre><code>schema：数据库设置，此数据库为逻辑数据库
name        逻辑数据库名，与server.xml中的schema对应
checkSQLschema        数据库前缀相关设置，是否检测SQL语法的schema信息，比如逻辑库名称是D，SQL：select * from D.table 当为true时：mycat发送到数据库的sql是select * from table;false时：发送的是select * from A.table

sqlMaxLimit select 时默认的limit，Mycat 在执行 SQL 的时候,如果 SQL 语法中没有 limit 子句.自动增加 limit 子句.避免查询全表

table标签：定义逻辑表，要求逻辑表和物理表的名字一致。
name        表名，物理数据库中表名
dataNode        表存储到哪些节点，多个节点用逗号分隔。节点为下文dataNode设置的name，多个也就分库了
primaryKey        主键字段名，自动生成主键时需要设置
autoIncrement          是否自增
rule        使用分片规则名，规则都在rule.xml。SQL 语句发送到 Mycat 中后，Mycat 如何计算，应该将当期的 SQL 发送到哪一个物理数
              据库管理系统或物理 database 中
ruleRequired    表是否绑定分片规则，如果配置为 true，但没有配置具体 rule 的话 ，程序会报错。
type   逻辑表的类型，目前逻辑表只有&quot;全局表&quot;和&quot;普通表&quot;两种类型。全局表：global。
       childTable 标签
       name 定义子表的表名。
       joinKey 插入子表的时候会使用这个列的值查找父表存储的数据节点。
parentKey 属性指定的值一般为与父表建立关联关系的列名。程序首先获取 joinkey 的值，再通过 parentKey 属性指定的列名产生查询语句，通过执行该语句得到父表存储在哪个分片上。从而确定子表存储的位置。

dataNode   分片信息，也就是分库相关配置
name        节点名，定义的逻辑名称,对应具体的物理数据库 database
datahost        物理数据库名，代表使用的物理数据库所在位置和配置信息，与datahost中name对应
database        物理数据库中数据库名

dataHost   物理数据库，真正存储数据的数据库
name        物理数据库名，与dataNode中dataHost对应
balance        均衡负载的方式
       balance=&quot;0&quot;, 不开启读写分离机制，所有读操作都发送到当前可用的 writeHost 上。
       balance=&quot;1&quot;，全部的 readHost 与 stand by writeHost 参与 select 语句的负载均衡，简单的说，当双   主双从模式(M1-&gt;S1，M2-&gt;S2，并且 M1 与 M2 互为主备)，正常情况下，M2,S1,S2 都参与 select 语句的负载均衡。
       balance=&quot;2&quot;，所有读操作都随机的在 writeHost、readhost 上分发。
       balance=&quot;3&quot;，所有读请求随机的分发到 wiriterHost 对应的 readhost 执行，writerHost 不负担读压力，注意 balance=3 只在 1.4 及其以后版本有，1.3 没有。

maxCon/minCon  最大最小连接数
writeType        负载均衡类型，目前的取值有 3 种：

1. writeType=&quot;0&quot;, 所有写操作发送到配置的第一个 writeHost，第一个挂了切到还生存的第二个writeHost，重新启动后已切换后的为准，切换记录在配置文件中:dnindex.properties .
2. writeType=&quot;1&quot;，所有写操作都随机的发送到配置的 writeHost，1.5 以后废弃不推荐。

dbType        数据库类型
dbDriver     数据库驱动类型,，native,使用 mycat 提供的本地驱动
switchType         
       -1 表示不自动切换
       1 默认值，自动切换 可能有IO延迟问题
       2 基于 MySQL 主从同步的状态决定是否切换   心跳语句为 show slave status
       3 基于 MySQL galary cluster 的切换机制（适合集群） 心跳语句为 show status like &apos;wsrep%&apos;
heartbeat        心跳检测语句，注意语句结尾的分号要加。
       子标签 writeHost：写数据的数据库定义标签. 实现读写分离操作，下面的readHost表示只读
host 数据库命名
url  数据库访问路径
user  数据库访问用户名
password  密码</code></pre>
          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2018/02/20/HAProxy%20%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/20/HAProxy%20%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/" itemprop="url">HAProxy 配置文件详解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-20T00:00:00+08:00">
                2018-02-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" itemprop="url" rel="index">
                    <span itemprop="name">负载均衡</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <pre><code>haproxy 配置中分成五部分内容，分别如下：
global：参数是进程级的，通常是和操作系统相关。这些参数一般只设置一次，如果配置无误，就不需要再次进行修改；
defaults：配置默认参数，这些参数可以被用到frontend，backend，Listen组件；
frontend：接收请求的前端虚拟节点，Frontend可以更加规则直接指定具体使用后端的backend；
backend：后端服务集群的配置，是真实服务器，一个Backend对应一个或者多个实体服务器；
Listen Fronted和backend的组合体。

global   # 全局参数的设置
# log语法：log &lt;address_1&gt;[max_level_1] # 全局的日志配置，使用log关键字，指定使用127.0.0.1上的syslog服务中的local0日志设备，记录日志等级为info的日志
log 127.0.0.1 local0 info
# 设置运行haproxy的用户和组，也可使用uid，gid关键字替代之
user haproxy
group haproxy
# 以守护进程的方式运行
daemon
    #改变当前工作目录，可以提升 haproxy 的安全级别
chroot      /usr/share/haproxy  
    # 设置haproxy启动时的进程数，用于守护进程模式的 haproxy；默认为止启动 1 个进程。该值的设置应该和服务器的CPU核心数一致，即常见的2颗8核心CPU的服务器，即共有16核心，则可以将其值设置为：&lt;=16 ，创建多个进程数，可以减少每个进程的任务队列，但是过多的进程数也可能会导致进程的崩溃。
nbproc 1
# 定义每个haproxy进程的最大连接数 ，由于每个连接包括一个客户端和一个服务器端，所以单个进程的TCP会话最大数目将是该值的两倍。
maxconn 4096
# 设置最大打开的文件描述符数，该值会自动计算，所以不建议进行设置
#ulimit -n 65536
# 定义haproxy的pid
#pidfile /var/run/haproxy.pid
    # 定义当前节点的名称，用于 HA 场景中多 haproxy 进程共享同一个 IP        地址时
    node                 haproxy1                           
    # 当前实例的描述信息
    description haproxy1  

defaults # 默认部分的定义
# mode语法：mode {http|tcp|health} 。http是七层模式，tcp是四层模式，health是健康检测，返回OK
                    # tcp: 实例运行于纯 tcp 模式，在客户端和服务器端之间将建立一个全双工的连接，且不会对 7 层报文做任何类型的检查，此为默认模式
                    # http:实例运行于 http 模式，客户端请求在转发至后端服务器之前将被深度分析，所有不与 RFC 模式兼容的请求都会被拒绝
                    # health：实例运行于 health 模式，其对入站请求仅响应&quot;OK&quot;信息并关闭连接，且不会记录任何日志信息 ，此模式将用于相应外部组件的监控状态检测请求
    mode http
# 使用127.0.0.1上的syslog服务的local3设备记录错误信息
log 127.0.0.1 local3 err
# 定义连接后端服务器的失败重连次数，连接失败次数超过此值后将会将对应后端服务器标记为不可用
retries 3
# 启用日志记录HTTP请求，默认haproxy日志记录是不记录HTTP请求的，只记录&quot;时间[Jan 5 13:23:46] 日志服务器[127.0.0.1] 实例名已经pid[haproxy[25218]] 信息[Proxy http_80_in stopped.]&quot;，日志格式很简单。
option httplog
# 当使用了cookie时，haproxy将会将其请求的后端服务器的serverID插入到cookie中，以保证会话的SESSION持久性；而此时，如果后端的服务器宕掉了，但是客户端的cookie是不会刷新的，如果设置此参数，将会将客户的请求强制定向到另外一个后端server上，以保证服务的正常。
option redispatch
# 当服务器负载很高的时候，自动结束掉当前队列处理比较久的链接
option abortonclose
# 启用该项，日志中将不会记录空连接。所谓空连接就是在上游的负载均衡器或者监控系统为了探测该服务是否存活可用时，需要定期的连接或者获取某一固定的组件或页面，或者探测扫描端口是否在监听或开放等动作被称为空连接；官方文档中标注，如果该服务上游没有其他的负载均衡器的话，建议不要使用该参数，因为互联网上的恶意扫描或其他动作就不会被记录下来
option dontlognull
# 每处理完一个request时，haproxy都会去检查http头中的Connection的值，如果该值不是close，haproxy将会将其删除，如果该值为空将会添加为：Connection: close。使每个客户端和服务器端在完成一次传输后都会主动关闭TCP连接。与该参数类似的另外一个参数是&quot;option forceclose&quot;，该参数的作用是强制关闭对外的服务通道，因为有的服务器端收到Connection: close时，也不会自动关闭TCP连接，如果客户端也不关闭，连接就会一直处于打开，直到超时。
    #每次请求完毕后主动关闭http通道
#option                 http-server-close                           
    option httpclose
    # 前端的最大并发连接数（默认为 2000）
maxconn         2000                                                                         
    # 连接超时,设置成功连接到一台服务器的最长等待时间,默认单位是毫秒
timeout connect 5000ms
# 客户端超时 设置连接客户端发送数据时的成功连接最长等待时间，默认单位是毫秒
timeout client 50000ms
# 服务器超时 设置服务器端回应客户度数据发送的最长等待时间，默认单位是毫秒
    timeout server 50000ms

listen admin_status # 定义一个名为admin_status的部分,状态信息统计页面
# 定义监听的套接字
bind 0.0.0.0:1080
# 定义为HTTP模式
mode http
# 继承global中log的定义
log global
# stats是haproxy的一个统计页面的套接字，该参数设置统计页面的刷新间隔为30s
stats refresh 30s
# 设置统计页面的uri为/admin?stats
stats uri /admin?stats
# 设置统计页面认证时的提示内容
stats realm Private lands
# 设置统计页面认证的用户和密码，如果要设置多个，另起一行写入即可
stats auth admin:password
# 隐藏统计页面上的haproxy版本信息
stats hide-version
    # 启用日志记录 HTTP 请求
    option httplog

frontend http_80_in # 定义一个名为http_80_in的前端部分
# http_80_in定义前端部分监听的套接字
bind 0.0.0.0:80
# 定义为HTTP模式
mode http
# 继承global中log的定义
log global
# 启用X-Forwarded-For，在requests头部插入客户端IP发送给后端的server，使后端server获取到客户端的真实IP
option forwardfor

    # 当请求是以这些结尾的交给url_static处理策略
    acl    url_static    url_reg /*.(css|jpg|png|jpeg|js|gif)$
    #或者path_end      /*.(css|jpg|png|jpeg|js|gif)$
    # 当请求的url末尾是以.jsp结尾的，交给jsp_web策略
    acl   jsp_web    path_end .jsp

    #如果url_static策略满足，交给static_server
    use_backend static_server if url_static
    use_backend jsp_server if jsp_web
    #其他请求交给my_webserver
default_backend       my_webserver

#jsp_server的后端部分
backend jsp_server  
# 设置为http模式
mode http
# 负载均衡调度算法可用于&quot;defaults&quot;、&quot;listen&quot;和&quot;backend&quot;中,默认为轮询方式，有hash，roundrobin 轮询， source 保存session值，支持static-rr，leastconn，first，uri等参数
balance source
# 允许向cookie插入SERVERID，每台服务器的SERVERID可在下面使用cookie关键字定义
cookie SERVERID
# 开启对后端服务器的健康检测，通过GET /test/index.php来判断后端服务器的健康情况
option httpchk GET /test/index.php
    #抵不过一后端server
server jsp_server_1 192.169.1.111:80 cookie 1 check inter 2000 rise 3 fall 3 weight 1
server jsp_server_2 192.169.1.112:80 cookie 2 check inter 2000 rise 3 fall 3 weight 1
# server语法：server &lt;name&gt; &lt;address&gt;[:[port]] [param*]    只能用于 listen 和 backend 区段。
    #  &lt;name&gt;为此服务器指定的内部名称，其将会出现在日志及警告信息中；后端服务器的IP地址，支持端口映射:[port]；
    #  [param*]为此 server 设定的一系列参数，均为可选项，参数比较多，下面仅说明几个常用的参数：
    #  weight：权重，默认为 1，最大值为 256，0 表示不参与负载均衡
    #  backup：设定为备用服务器，仅在负载均衡场景中的其他 server 均不可以启用此server
    #  check：启动对此 server 执行监控状态检查
    #  inter：设定监控状态检查的时间间隔，单位为毫秒，默认为 2000，也可以使用 fastinter 和 downinter 来根据服务器端专题优化此事件延迟
    #  rise：设置 server 从离线状态转换至正常状态需要检查的次数（不设置的情况下，默认值为 2）
    #  fall：设置 server 从正常状态转换至离线状态需要检查的次数（不设置的情况下，默认值为 3）
    # cookie：为指定 server 设定 cookie 值，此处指定的值将会在请求入站时被检查，第一次为此值挑选的 server 将会被后续的请求所选中，其目的在于实现持久连接的功能
    # maxconn：指定此服务器接受的最大并发连接数，如果发往此服务器的连接数目高于此处指定的值，其将被放置于请求队列，以等待其他连接被释放

#定义static_server
backend static_server
mode http
server static_server_1 127.0.0.1:80 cookie 3 check inter 2000 rise 3 fall 3

#定义my_webserver，名字需要与frontend里面配置项default_backend 值相一致
backend my_webserver        
    # 负载均衡算法
balance     roundrobin                              
server  web01 192.169.1.33:80  check inter 2000 fall 3 weight 30              #定义的多个后端
server  web02 192.169.1.34:80  check inter 2000 fall 3 weight 30              #定义的多个后端
server  web03 192.169.1.35:80  check inter 2000 fall 3 weight 30              #定义的多个后端</code></pre><p>注意：多节点部署时 node 、 description 的值要做相应调整</p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2018/02/20/HAProxy+Keepalived+MyCat+MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/20/HAProxy+Keepalived+MyCat+MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4/" itemprop="url">HAProxy+Keepalived+MyCat+MySQL高可用集群</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-20T00:00:00+08:00">
                2018-02-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" itemprop="url" rel="index">
                    <span itemprop="name">负载均衡</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1、集群环境分配"><a href="#1、集群环境分配" class="headerlink" title="1、集群环境分配"></a>1、集群环境分配</h2><pre><code>由于硬件有限，安装了6台Linux虚拟机，做如下分配：
MySQL master1：192.168.1.103
MySQL slave1：192.168.1.104
MySQL master2/MyCat1：192.168.1.105
MySQL slave2/MyCat2：192.168.1.106
HAProxy1：192.168.1.107
HAProxy2：192.168.1.108
        VIP：192.168.1.8
使用软件：
        haproxy-1.7.1.tar.gz
        keepalived-1.2.18.tar.gz
        Mycat-server-1.6.6.1-release-20181031195535-linux.tar.gz
MySQL在最初的时候就安装好，每台机器克隆后都有MySQL，需要说明的是，把需要使用MySQL的uuid修改，因为都是克隆的，所以这个值是一样的[root@localhost ~]# cat /usr/local/mysql-5.6.31/data/auto.cnf 修改文件里边，随机改一下就即可。
其他文件，分别对应上传到服务器。</code></pre><h2 id="2、配置MySQL主从和主主"><a href="#2、配置MySQL主从和主主" class="headerlink" title="2、配置MySQL主从和主主"></a>2、配置MySQL主从和主主</h2><pre><code>在103和105配置主库，分别执行如下操作，其中105的auto_increment_offset=2
 vim /etc/my.cnf 修改配置
 [client]
 port = 3306 #客户端端口
 default-character-set = utf8mb4  #客户端默认字符集
 [mysqld]
 default_storage_engine = InnoDB #默认数据库引擎
 port = 3306
 character_set_server=utf8
 log_bin=master_bin #开启二进制日志
 server_id=1 #设置server_id
 #步进值，一般有n台主MySQL就填n
 auto_increment_increment=2  
 #起始值，一般填第n台主MySQL。
 auto_increment_offset=1  
 # 做为从库时，数据库的修改也会写到bin-log里
 log-slave-updates  
 # 表示自动删除5天以前的binlog，可选
 expire_logs_days=5
 #忽略mysql库
 #binlog-ignore=mysql  
 #忽略information_schema库
 #binlog-ignore=information_schema  
 #要同步的数据库，默认所有库
 #replicate-do-db=demo

 103/104/105/106的server_id分别是1/3/2/4

 在104和106配置从库，分别执行如下操作：
 vim /etc/my.cnf 修改配置
 [client]
 port = 3306 #客户端端口
 default-character-set = utf8mb4  #客户端默认字符集
 [mysqld]
 default_storage_engine = InnoDB #默认数据库引擎
 port = 3306
 character_set_server=utf8
 server_id=3 #设置server_id

 分别启动两台master，在两台master中的MySQL中创建用户供Slave使用
 mysql&gt; grant all privileges on *.* to &apos;slave&apos;@&apos;192.168.1.%&apos; identified by &apos;slave&apos; with grant option;
 mysql&gt; flush privileges;</code></pre><p>查看master状态，记录文件名</p>
<p>SHOW MASTER STATUS;</p>
<p>分别启动Slave，配置Slave，登录MySQL，先停止stop slave;再执行Slave配置，执行代码如下：</p>
<pre><code>103：CHANGE MASTER TO MASTER_HOST=&apos;192.168.1.105&apos;,MASTER_USER=&apos;slave&apos;,MASTER_PASSWORD=&apos;slave&apos;,MASTER_LOG_FILE=&apos;master_bin.000001&apos;;
104：CHANGE MASTER TO MASTER_HOST=&apos;192.168.1.103&apos;,MASTER_USER=&apos;slave&apos;,MASTER_PASSWORD=&apos;slave&apos;,MASTER_LOG_FILE=&apos;master_bin.000001&apos;;
105：CHANGE MASTER TO MASTER_HOST=&apos;192.168.1.103&apos;,MASTER_USER=&apos;slave&apos;,MASTER_PASSWORD=&apos;slave&apos;,MASTER_LOG_FILE=&apos;master_bin.000001&apos;;  因为两个master互为主从，所以在两边都要配置对方的master
106：CHANGE MASTER TO MASTER_HOST=&apos;192.168.1.105&apos;,MASTER_USER=&apos;slave&apos;,MASTER_PASSWORD=&apos;slave&apos;,MASTER_LOG_FILE=&apos;master_bin.000001&apos;;</code></pre><p>再次启动start slave</p>
<p>通过命令 show slave status\G; 查看每个节点信息，主从都是一致的。没问题。数据测试也ok。</p>
<p>测试双主从：开启日志查询set global general_log = on;，动态监控日志信息tail -f /usr/local/mysql-5.6.31/data/localhost.log</p>
<pre><code>都不宕机的情况下，不管是从哪一台master修改数据，其他节点都能显示，同步一致性。
当master1停止MySQL情况下，master2修改了数据，master再次启动也会把master2修改的同步到master1和Slave1。反之亦然没问题。</code></pre><h2 id="3、配置MyCat"><a href="#3、配置MyCat" class="headerlink" title="3、配置MyCat"></a>3、配置MyCat</h2><p>分别在105、106解压MyCat文件到/usr/local/mycat下</p>
<p>直接运行测试一下：</p>
<pre><code>[root@localhost mycat]# bin/mycat start</code></pre><p>没问题，配置MyCat逻辑表，进行测试，两个都一致。这里配置只是为了测试用，实际中按照实际需求配置。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mycat</span>:schema <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"schema.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">"http://io.mycat/"</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!--逻辑库表创建--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">"demo"</span> <span class="attr">checkSQLschema</span>=<span class="string">"false"</span> <span class="attr">sqlMaxLimit</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">dataNode</span>=<span class="string">"demo1"</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">"demo1"</span> <span class="attr">checkSQLschema</span>=<span class="string">"true"</span> <span class="attr">sqlMaxLimit</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">dataNode</span>=<span class="string">"demo111"</span> /&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="comment">&lt;!--逻辑节点，对应物理库--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">"demo1"</span> <span class="attr">dataHost</span>=<span class="string">"host103"</span> <span class="attr">database</span>=<span class="string">"demo"</span> /&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">"demo2"</span> <span class="attr">dataHost</span>=<span class="string">"host105"</span> <span class="attr">database</span>=<span class="string">"demo"</span> /&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">"demo111"</span> <span class="attr">dataHost</span>=<span class="string">"host111"</span> <span class="attr">database</span>=<span class="string">"demo"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">&lt;!--物理库配置--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">"host103"</span> <span class="attr">maxCon</span>=<span class="string">"1000"</span> <span class="attr">minCon</span>=<span class="string">"10"</span> <span class="attr">balance</span>=<span class="string">"1"</span> <span class="attr">writeType</span>=<span class="string">"0"</span> <span class="attr">dbType</span>=<span class="string">"mysql"</span> <span class="attr">dbDriver</span>=<span class="string">"native"</span> <span class="attr">switchType</span>=<span class="string">"2"</span> <span class="attr">slaveThreshold</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>show slave status<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"hostM1"</span> <span class="attr">url</span>=<span class="string">"192.168.1.103:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"123456"</span>/&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"hostS1"</span> <span class="attr">url</span>=<span class="string">"192.168.1.104:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"123456"</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">"host105"</span> <span class="attr">maxCon</span>=<span class="string">"1000"</span> <span class="attr">minCon</span>=<span class="string">"10"</span> <span class="attr">balance</span>=<span class="string">"1"</span> <span class="attr">writeType</span>=<span class="string">"0"</span> <span class="attr">dbType</span>=<span class="string">"mysql"</span> <span class="attr">dbDriver</span>=<span class="string">"native"</span> <span class="attr">switchType</span>=<span class="string">"2"</span> <span class="attr">slaveThreshold</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>show slave status<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"hostM2"</span> <span class="attr">url</span>=<span class="string">"192.168.1.105:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"123456"</span>/&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"hostS2"</span> <span class="attr">url</span>=<span class="string">"192.168.1.106:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"123456"</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">"host111"</span> <span class="attr">maxCon</span>=<span class="string">"1000"</span> <span class="attr">minCon</span>=<span class="string">"10"</span> <span class="attr">balance</span>=<span class="string">"1"</span> <span class="attr">writeType</span>=<span class="string">"0"</span> <span class="attr">dbType</span>=<span class="string">"mysql"</span> <span class="attr">dbDriver</span>=<span class="string">"native"</span> <span class="attr">switchType</span>=<span class="string">"2"</span> <span class="attr">slaveThreshold</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>show slave status<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"hosstM1"</span> <span class="attr">url</span>=<span class="string">"192.168.1.103:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"123456"</span>&gt;</span></span><br><span class="line">                                       <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">"hostsS1"</span> <span class="attr">url</span>=<span class="string">"192.168.1.104:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"123456"</span>/&gt;</span></span><br><span class="line">                               <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">                               <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"hostsM2"</span> <span class="attr">url</span>=<span class="string">"192.168.1.105:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"123456"</span>&gt;</span></span><br><span class="line">                                       <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">"hostsS2"</span> <span class="attr">url</span>=<span class="string">"192.168.1.106:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"123456"</span>/&gt;</span></span><br><span class="line">                               <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>server.xml中增加逻辑库访问。在远程分别访问两台MyCat并测试。</p>
<pre><code> ①、每个节点都不宕机的情况下测试都没任何问题。
 ②、如果master1宕机，停止MySQL，在插入数据，日志可以看到往master2插入，salve2同步，再次恢复master1，数据变化将同步回master1
 ③、读数据，通常都分配到Slave和master2上，只有出现io延迟才会在master1读取。
两台MyCat搭配MySQL都没问题，下一步：</code></pre><h2 id="4、安装xinetd"><a href="#4、安装xinetd" class="headerlink" title="4、安装xinetd"></a>4、安装xinetd</h2><pre><code>xinetd是新一代的网络守护进程服务程序，又叫超级internet服务器。经常用来托管轻量级服务。
这里安装xinetd的目的是检测MyCat的服务状态，为HAProxy提供MyCat服务状态的依据。
A、安装如下：
        yum install -y xinetd
        检查/etc/xinetd.conf 的末尾是否有 includedir /etc/xinetd.d ，没有就加上
        检查 /etc/xinetd.d 目录是否存在，不存在则创建mkdir /etc/xinetd.d/

B、增加 Mycat 存活状态检测服务配置：vim /etc/xinetd.d/mycat_status
        service mycat_status
        {
                flags = REUSE
                ## 使用该标记的 socket_type 为 stream，需要设置 wait 为 no
                socket_type = stream ## 封包处理方式，Stream 为 TCP 数据包
                port = 48700 ## 服务监听端口
                wait = no ## 表示不需等待，即服务将以多线程的方式运行
                user = root ## 执行此服务进程的用户
                server =/usr/local/bin/mycat_status ## 需要启动的服务脚本
                log_on_failure += USERID ## 登录失败记录的内容
                disable = no ## 要启动服务，将此参数设置为 no
        }

C、添加 /usr/local/bin/mycat_status 服务脚本 vim /usr/local/bin/mycat_status
        #!/bin/bash
        Mycat=`/usr/local/mycat/bin/mycat status | grep &apos;not running&apos; | wc -l`
        if [ &quot;$Mycat&quot; = &quot;0&quot; ]; then
                /bin/echo -e &quot;HTTP/1.1 200 OK\r\n&quot;
                else
                /bin/echo -e &quot;HTTP/1.1 503 Service Unavailable\r\n&quot;
        fi  
D、脚本赋予可执行权限
        chmod 755 /usr/local/bin/mycat_status

E、在 /etc/services 中加入 mycat_status 服务
        vim /etc/services 在末尾加入：
        mycat_status 48700/tcp # mycat_status
        保存后，重启 xinetd 服务 service xinetd restart

F、验证 mycat_status 服务是否成功启动
        netstat -antup|grep 48700

G、测试脚本
        /usr/local/bin/mycat_status</code></pre><h2 id="5、安装HAProxy"><a href="#5、安装HAProxy" class="headerlink" title="5、安装HAProxy"></a>5、安装HAProxy</h2><pre><code>在107和108中安装HAProxy，解压文件到/usr/local下。
①、编译安装：
        依赖yum install -y gcc gcc-c++ pcre pcre-devel zlib zlib-devel openssl openssl-devel
        编译：make TARGET=linux2628 ARCH=x86_64 USE_PCRE=1 USE_OPENSSL=1 USE_ZLIB=1 PREFIX=/usr/local/haproxy
                TARGET 是指定内核版本，高于 2.6.28 的建议设置为 linux2628，低于的是多少写多少。内核版本查看命令# uname -r， ARCH 指定系统架构，openssl pcre zlib 这三个包需要安装不然不支持
        安装：创建安装目录mkdir /usr/local/haproxy
        执行make install PREFIX=/usr/local/haproxy安装
②、配置：
        创建配置文件目录
                mkdir -p /usr/local/haproxy/conf
                mkdir -p /etc/haproxy/
        添加配置文件并创建软连接
                vi /usr/local/haproxy/conf/haproxy.cfg
                        # Simple configuration for an HTTP proxy listening on port 80 on all
                        # interfaces and forwarding requests to a single backend &quot;servers&quot; with a
                        # single server &quot;server1&quot; listening on 127.0.0.1:8000
                        global
                                daemon
                                maxconn 256
                                defaults
                                mode http
                                timeout connect 5000ms
                                timeout client 50000ms
                                timeout server 50000ms
                                frontend http-in
                                bind *:80
                        default_backend servers
                        backend servers
                        server server1 127.0.0.1:8000 maxconn 32
                        # The same configuration defined with a single listen block. Shorter but
                        # less expressive, especially in HTTP mode. global
                        daemon
                        maxconn 256
                        defaults
                        mode http
                        timeout connect 5000ms
                        timeout client 50000ms
                        timeout server 50000ms
                        listen http-in
                        bind *:80
                        server server1 127.0.0.1:8000 maxconn 32
                创建软连接：ln -s /usr/local/haproxy/conf/haproxy.cfg /etc/haproxy/haproxy.cfg

        ③、拷贝错误页面并创建软连接
                cp -r /usr/local/haproxy-1.7.1/examples/errorfiles /usr/local/haproxy/
                ln -s /usr/local/haproxy/errorfiles /etc/haproxy/errorfiles

        ④、添加 HAProxy 命令脚本软连接
                ln -s /usr/local/haproxy/sbin/haproxy /usr/sbin
        设置自启动（可选）
                cp /usr/local/haproxy-1.7.1/examples/haproxy.init /etc/rc.d/init.d/haproxy
                chmod +x /etc/rc.d/init.d/haproxy

                chkconfig --add haproxy
                chkconfig haproxy on
        ⑤、配置MyCat负载均衡集群
                修改配置；vi /usr/local/haproxy/conf/haproxy.cfg
                107：        
                        global
                                log 127.0.0.1 local0 info
                                chroot /usr/share/haproxy
                                group haproxy
                                user haproxy
                                daemon
                                nbproc 1
                                maxconn 4096
                                node haproxy1
                                description haproxy1
                        defaults
                                log global
                                mode http
                                option httplog
                                retries 3
                                option redispatch
                                maxconn 2000
                                timeout connect 5000ms
                                timeout client 50000ms
                                timeout server 50000ms
                        listen admin_stats
                                bind :48800
                                stats uri /admin-status
                                stats auth admin:admin
                                mode http
                                option httplog
                        listen mycat_servers
                                bind :3307
                                mode tcp
                                option tcplog
                                option tcpka
                                option httpchk OPTIONS * HTTP/1.1\r\nHost:\ www
                                balance roundrobin
                                server mycat_01 192.168.1.105:8066 check port 48700 inter 2000ms rise 2 fall 3 weight 10
                                server mycat_02 192.168.1.106:8066 check port 48700 inter 2000ms rise 2 fall 3 weight 10                                

                108：
                        global
                                log 127.0.0.1 local0 info
                                chroot /usr/share/haproxy
                                group haproxy
                                user haproxy
                                daemon
                                nbproc 1
                                maxconn 4096
                                node haproxy2
                                description haproxy2
                        defaults
                                log global
                                mode http
                                option httplog
                                retries 3
                                option redispatch
                                maxconn 2000
                                timeout connect 5000ms
                                timeout client 50000ms
                                timeout server 50000ms
                        listen admin_stats
                                bind :48800
                                stats uri /admin-status
                                stats auth admin:admin
                                mode http
                                option httplog
                        listen mycat_servers
                                bind :3307
                                mode tcp
                                option tcplog
                                option tcpka
                                option httpchk OPTIONS * HTTP/1.1\r\nHost:\ www
                                balance roundrobin
                                server mycat_01 192.168.1.105:8066 check port 48700 inter 2000ms rise 2 fall 3 weight 10
                                server mycat_02 192.168.1.106:8066 check port 48700 inter 2000ms rise 2 fall 3 weight 10

        ⑥、为 HAProxy 创建 Linux 系统用户                
                groupadd haproxy
                useradd -g haproxy haproxy

        ⑦、创建 chroot 运行的路径mkdir /usr/share/haproxy

        ⑧、开启 rsyslog 的 haproxy 日志记录功能
                默认情况下 haproxy 是不记录日志的，如果需要记录日志，还需要配置系统的 syslog，在 linux 系统中是 rsyslog 服务。syslog 服务器可以用作一个网络中的日志监控中心，rsyslog是一个开源工具，被广泛用于 Linux 系统以通过 TCP/UDP 协议转发或接收日志消息。安装配置 rsyslog 服务。
                        yum install -y rsyslog  
                修改配置：
                        vi /etc/rsyslog.conf                                
                                $ModLoad imudp # 模块名，支持 UDP 协议
                                $UDPServerRun 514  #允许 514 端口接收使用 UDP 和 TCP 协议转发过来的日志，默认端口
                        确认 #### GLOBAL DIRECTIVES #### 段中是否有 $IncludeConfig /etc/rsyslog.d/*.conf 没有则增加上此配置。rsyslog 服务会来此目录加载配置                                
                        创建 haproxy 的日志配置文件
                        vi /etc/rsyslog.d/haproxy.conf
                                local0.* /var/log/haproxy.log
                                &amp;~
                        注：如果不加上&amp;~,除了在/var/log/haproxy.log中写日志之外，也会写入/var/log/massage中

                        保存后重启rsyslog服务service rsyslog restart
                等到 HAProxy 服务启动后，就能在/var/log/haproxy.log中就会有日志。                                
        ⑨、配置系统内核IP包转发规则，Linux默认不会转发tcp层的包
                vi /etc/sysctl.conf
                                net.ipv4.ip_forward = 1
                生效： sysctl -p                
        ⑩、启动HAProxy
                service haproxy start
                ps -ef | grep haproxy


                测试：查看 HAProxy 提供的 WEB 统计应用
                        http://192.168.1.107:48800/admin-status
                        http://192.168.1.108:48800/admin-status</code></pre><p><img src="https://img.huyunshun.com/img/20200420192551.png" alt="20200420192551"></p>
<h2 id="6、安装Keepalived"><a href="#6、安装Keepalived" class="headerlink" title="6、安装Keepalived"></a>6、安装Keepalived</h2><pre><code> A、安装
         yum -y install keepalived
         keepalived相关文件：
         /etc/keepalived
         /etc/keepalived/keepalived.conf     #keepalived服务主配置文件
         /etc/rc.d/init.d/keepalived         #服务启动脚本（centos 7 之前的用init.d 脚本启动，之后的systemd启动）
         /etc/sysconfig/keepalived
         /usr/bin/genhash
         /usr/libexec/keepalived
         /usr/sbin/keepalived
 B、配置 /etc/keepalived/keepalived.conf  
 192.168.1.107：
         ! Configuration File for keepalived
         global_defs {
                 # keepalived 自带的邮件提醒需要开启 sendmail 服务。建议用独立的监控或第三方SMTP
                 router_id haproxy1 ## 标识本节点的字符串，通常为 hostname，需要修改/etc/hosts
         }
         # keepalived 会定时执行脚本并对脚本执行的结果进行分析，动态调整 vrrp_instance的优先级。
         # 如果脚本执行结果为 0，并且 weight 配置的值大于 0，则优先级相应的增加。
         # 如果脚本执行结果非 0，并且 weight 配置的值小于 0，则优先级相应的减少。
         # 其他情况，维持原本配置的优先级，即配置文件中 priority 对应的值。
         vrrp_script chk_haproxy {
                 script &quot;/etc/keepalived/haproxy_check.sh&quot;  # 检测 haproxy 状态的脚本路径
                 interval 2  # 检测时间间隔
                 weight 2    # 如果条件成立，权重+2
         }
         # 定义虚拟路由， VI_1 为虚拟路由的标示符，自己定义名称
         vrrp_instance VI_1 {
                 state BACKUP         # 默认主设备（priority 值大的）和备用设备（priority 值小的）都设置为 BACKUP，通常由priority 来控制同时启动情况下的默认主备，否则先启动的为主设备
                 interface eth4         # 绑定虚拟 IP 的网络接口，与本机 IP 地址所在的网络接口相同
                 virtual_router_id 35 # 虚拟路由的 ID 号，两个节点设置必须一样，可选 IP 最后一段使用，相同的 VRID 为一个组，他将决定多播的 MAC 地址
                 priority 100         # 节点优先级，值范围 0-254， MASTER 要比 BACKUP 高
                 nopreempt                 # 主设备（priority 值大的）配置一定要加上 nopreempt，否则非抢占也不起作用
                 advert_int 1         # 组播信息发送间隔，两个节点设置必须一样，默认 1s
                 # 设置验证信息，两个节点必须一致
                 authentication {
                         auth_type PASS
                         auth_pass 1111  
                 }
                 # 将 track_script 块加入 instance 配置块
                 track_script {
                         chk_haproxy   # 检查 HAProxy 是否正常运行
                 }
                 # 虚拟 IP 池, 两个节点设置必须一样
                 virtual_ipaddress {
                         192.168.1.10  # 虚拟 ip，可以定义多个，每行一个
                 }
         }

192.168.1.108：
         ! Configuration File for keepalived
         global_defs {
                 # keepalived 自带的邮件提醒需要开启 sendmail 服务。建议用独立的监控或第三方SMTP
                 router_id haproxy2 ## 标识本节点的字符串，通常为 hostname，需要修改/etc/hosts
         }
         # keepalived 会定时执行脚本并对脚本执行的结果进行分析，动态调整 vrrp_instance的优先级。
         # 如果脚本执行结果为 0，并且 weight 配置的值大于 0，则优先级相应的增加。
         # 如果脚本执行结果非 0，并且 weight 配置的值小于 0，则优先级相应的减少。
         # 其他情况，维持原本配置的优先级，即配置文件中 priority 对应的值。
         vrrp_script chk_haproxy {
                 script &quot;/etc/keepalived/haproxy_check.sh&quot;  # 检测 haproxy 状态的脚本路径
                 interval 2  # 检测时间间隔
                 weight 2    # 如果条件成立，权重+2
         }
         # 定义虚拟路由， VI_1 为虚拟路由的标示符，自己定义名称
         vrrp_instance VI_1 {
                 state BACKUP         # 默认主设备（priority 值大的）和备用设备（priority 值小的）都设置为 BACKUP，通常由priority 来控制同时启动情况下的默认主备，否则先启动的为主设备
                 interface eth4         # 绑定虚拟 IP 的网络接口，与本机 IP 地址所在的网络接口相同
                 virtual_router_id 35 # 虚拟路由的 ID 号，两个节点设置必须一样，可选 IP 最后一段使用，相同的 VRID 为一个组，他将决定多播的 MAC 地址
                 priority 99         # 节点优先级，值范围 0-254， MASTER 要比 BACKUP 高
                 advert_int 1         # 组播信息发送间隔，两个节点设置必须一样，默认 1s
                 # 设置验证信息，两个节点必须一致
                 authentication {
                         auth_type PASS
                         auth_pass 1111  
                 }
                 # 将 track_script 块加入 instance 配置块
                 track_script {
                         chk_haproxy   # 检查 HAProxy 是否正常运行
                 }
                 # 虚拟 IP 池, 两个节点设置必须一样
                 virtual_ipaddress {
                         192.168.1.10  # 虚拟 ip，可以定义多个，每行一个
                 }
         }

如果非抢占模式不生效， 在 Keepalived 的故障节点恢复后会再次导抢占vip，从而因 vip 切换而闪断带来的风险。
按以上配置，配置了 Keepalived 非抢占模式， 配置及注意点如下：
        (1) 主设备、 从设备中的 state 都设置为 BACKUP
        (2) 主设备、从设备中都不要配置 mcast_src_ip （本机 IP 地址）
        (3) 默认主设备（priority 值大的 Keepalived 节点） 配置一定要加上 nopreempt，否则非抢占不起作用
        (4) 防火墙配置允许组播（主、备两台设备上都需要配置， keepalived 使用 224.0.0.18作为 Master 和 Backup 健康检查的通信 IP）


 ③、配置检测 haproxy 状态的脚本
 /etc/keepalived/haproxy_check.sh
 创建一个日志，如果发生haproxy异常需要切换，记录到日志中。
 mkdir -p /usr/share/haproxy/log
 脚本如下：如果 haproxy 停止运行，尝试启动，如果无法启动则杀死本机的 keepalived 进程，keepalied 自动将虚拟 ip 绑定到 BACKUP 机器上。
         #!/bin/bash
         START_HAPROXY=&quot;/etc/rc.d/init.d/haproxy start&quot;
         STOP_HAPROXY=&quot;/etc/rc.d/init.d/haproxy stop&quot;
         LOG_FILE=&quot;/usr/share/haproxy/log/haproxy-check.log&quot;
         HAPS=`ps -C haproxy --no-header |wc -l`
         date &quot;+%Y-%m-%d %H:%M:%S&quot; &gt;&gt; $LOG_FILE
         echo &quot;check haproxy status&quot; &gt;&gt; $LOG_FILE
         if [ $HAPS -eq 0 ];then
                 echo $START_HAPROXY &gt;&gt; $LOG_FILE
                 $START_HAPROXY &gt;&gt; $LOG_FILE 2&gt;&amp;1
                 sleep 3
                 if [ `ps -C haproxy --no-header |wc -l` -eq 0 ];then
                         echo &quot;start haproxy failed, killall keepalived&quot; &gt;&gt; $LOG_FILE
                         killall keepalived
                 fi
         fi
 保存赋权：
 chmod +x /etc/keepalived/haproxy_check.sh

 ④、启动 Keepalived
 停止： service keepalived stop
 启动： service keepalived start
 重启： service keepalived restart
 看状态： service keepalived status</code></pre><h2 id="7、测试Keepalived-HAProxy"><a href="#7、测试Keepalived-HAProxy" class="headerlink" title="7、测试Keepalived+HAProxy"></a>7、测试Keepalived+HAProxy</h2><p>两台服务器启动Keepalived+HAProxy，测试：</p>
<p><img src="https://img.huyunshun.com/img/20200420192826.png" alt="20200420192826"></p>
<p>此时，keepalived，VIP是在108上，如果停止108的haproxy，如下效果：</p>
<p><img src="https://img.huyunshun.com/img/20200420192848.png" alt="20200420192848"></p>
<p>停止108的haproxy，keepalived检测haproxy异常，并且重启haproxy，所以haproxy继续运行且日志中记录重启haproxy记录，这样就实现keepalived对haproxy高可用。</p>
<p>如果直接停止108keepalived，VIP飘到107：</p>
<p><img src="https://img.huyunshun.com/img/20200421123303.png" alt="20200421123303"></p>
<p>如果把107的/usr/local/haproxy/conf/haproxy.cfg配置文件修改错误，让haproxy不能重启，停止haproxy后测试效果如下：</p>
<p><img src="https://img.huyunshun.com/img/20200421123317.png" alt="20200421123317"></p>
<p>可以看到，VIP漂移到108，而且107也访问不了haproxy，并且107keepalived状态：keepalived dead but subsys locked。<br>日志中显示启动haproxy报错信息，和杀死keepalived进程信息。</p>
<p><img src="https://img.huyunshun.com/img/20200421123334.png" alt="20200421123334"></p>
<h2 id="8、测试HAProxy-Keepalived-MyCat-MySQL高可用集群"><a href="#8、测试HAProxy-Keepalived-MyCat-MySQL高可用集群" class="headerlink" title="8、测试HAProxy+Keepalived+MyCat+MySQL高可用集群"></a>8、测试HAProxy+Keepalived+MyCat+MySQL高可用集群</h2><pre><code>全部机器启动并启动相关服务测试，通过VIP访问到mysql数据库，对数据的操作，没有问题。</code></pre>
          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/16/">上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><span class="page-number current">17</span><a class="page-number" href="/page/18/">18</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><a class="extend next" rel="next" href="/page/18/">下一页</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://img.huyunshun.com/img/20200522182348.png"
                alt="初晨" />
            
              <p class="site-author-name" itemprop="name">初晨</p>
              <p class="site-description motion-element" itemprop="description">永远不要说你知道本质，更别说真相了。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">249</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">46</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">109</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          
<!--近期文章版块-->
            
                <div class="links-of-blogroll motion-element links-of-blogroll-block">
                  <div class="links-of-blogroll-title">
                    <!-- modify icon to fire by szw -->
                    <i class="fa fa-history fa-" aria-hidden="true"></i>
                    近期文章
                  </div>
                  <ul class="links-of-blogroll-list">
                    
                    
                      <li>
                        <a href="/2020/05/22/WebSocket%E3%80%81Socket%E3%80%81TCP%E3%80%81HTTP%E5%8C%BA%E5%88%AB/" title="WebSocket、Socket、TCP、HTTP区别" target="_blank">WebSocket、Socket、TCP、HTTP区别</a>
                      </li>
                    
                      <li>
                        <a href="/2020/05/19/Springboot%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%8E%A5%E5%8F%A3%E9%98%B2%E5%88%B7/" title="Springboot项目的接口防刷" target="_blank">Springboot项目的接口防刷</a>
                      </li>
                    
                      <li>
                        <a href="/2020/05/03/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Volatile%E5%85%B3%E9%94%AE%E5%AD%97%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" title="深入理解Volatile关键字及其实现原理" target="_blank">深入理解Volatile关键字及其实现原理</a>
                      </li>
                    
                      <li>
                        <a href="/2020/04/20/%E4%BD%BF%E7%94%A8vscode%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0%E7%8E%AF%E5%A2%83/" title="使用vscode搭建个人笔记环境" target="_blank">使用vscode搭建个人笔记环境</a>
                      </li>
                    
                      <li>
                        <a href="/2020/01/20/HBase%E4%BB%8B%E7%BB%8D%E5%AE%89%E8%A3%85%E4%B8%8E%E6%93%8D%E4%BD%9C/" title="HBase介绍安装与操作" target="_blank">HBase介绍安装与操作</a>
                      </li>
                    
                  </ul>
                </div>
            
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Copyright</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  


</body>
</html>
