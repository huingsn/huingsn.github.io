<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="永远不要说你知道本质，更别说真相了。">
<meta property="og:type" content="website">
<meta property="og:title" content="简">
<meta property="og:url" content="https://huyunshun.com/page/4/index.html">
<meta property="og:site_name" content="简">
<meta property="og:description" content="永远不要说你知道本质，更别说真相了。">
<meta property="article:author" content="初晨">
<meta property="article:tag" content="编程">
<meta property="article:tag" content="开发">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://huyunshun.com/page/4/"/>





  <title>简</title>
  








  <script type="text/javascript" src="/js/src/love.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">

  <!-- 看板娘 -->
    
        <script async src="/live2d-widget/autoload.js"></script>
    
 <!-- 飘动的彩带） -->
  <script src="/js/src/piao.js" type="text/javascript"></script>
<meta name="generator" content="Hexo 4.2.1"></head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">简</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">人生短暂，学海无边，而大道至简。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/05/09/windows_docker%E8%AE%BF%E9%97%AEdockerVM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/09/windows_docker%E8%AE%BF%E9%97%AEdockerVM/" itemprop="url">windows docker访问dockerVM</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-09T00:00:00+08:00">
                2019-05-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>先执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --privileged -it -v &#x2F;var&#x2F;run&#x2F;docker.sock:&#x2F;var&#x2F;run&#x2F;docker.sock jongallant&#x2F;ubuntu-docker-client</span><br></pre></td></tr></table></figure>
<p>在执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --net&#x3D;host --ipc&#x3D;host --uts&#x3D;host --pid&#x3D;host -it --security-opt&#x3D;seccomp&#x3D;unconfined --privileged --rm -v &#x2F;:&#x2F;host alpine &#x2F;bin&#x2F;sh</span><br></pre></td></tr></table></figure>
<p>最后登陆到宿主host:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chroot &#x2F;host</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/05/09/koa%E6%A1%86%E6%9E%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/09/koa%E6%A1%86%E6%9E%B6/" itemprop="url">koa框架</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-09T00:00:00+08:00">
                2019-05-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Node/" itemprop="url" rel="index">
                    <span itemprop="name">Node</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一、Koa介绍"><a href="#一、Koa介绍" class="headerlink" title="一、Koa介绍"></a>一、Koa介绍</h1><p>Koa是一个类似于Express的Web开发框架，创始人也是同一个人。它的主要特点是，使用了ES6的Generator函数，进行了架构的重新设计。也就是说，Koa的原理和内部结构很像Express，但是语法和内部结构进行了升级。</p>
<p>官方faq有这样一个问题：”为什么koa不是Express 4.0？“，回答是这样的：”Koa与Express有很大差异，整个设计都是不同的，所以如果将Express 0按照这种写法升级到4.0，就意味着重写整个程序。所以，我们觉得创造一个新的库，是更合适的做法。“</p>
<h4 id="1、示例"><a href="#1、示例" class="headerlink" title="1、示例"></a>1、示例</h4><p>安装好nodejs，创建项目文件，按照如下操作引入koa。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#初始化项目</span><br><span class="line">D:\mydoc\NodeJs\koa-study-demo\Demo-01&gt;npm init -y</span><br><span class="line">Wrote to D:\mydoc\NodeJs\koa-study-demo\Demo-01\package.json:</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;Demo-01&quot;,</span><br><span class="line">  &quot;version&quot;: &quot;1.0.0&quot;,</span><br><span class="line">  &quot;description&quot;: &quot;&quot;,</span><br><span class="line">  &quot;main&quot;: &quot;my-koa-node.js&quot;,</span><br><span class="line">  &quot;scripts&quot;: &#123;</span><br><span class="line">    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;keywords&quot;: [],</span><br><span class="line">  &quot;author&quot;: &quot;&quot;,</span><br><span class="line">  &quot;license&quot;: &quot;ISC&quot;</span><br><span class="line">&#125;</span><br><span class="line"># 安装koa</span><br><span class="line">D:\mydoc\NodeJs\koa-study-demo\Demo-01&gt;npm install koa</span><br><span class="line">npm notice created a lockfile as package-lock.json. You should commit this file.</span><br><span class="line">npm WARN Demo-01@1.0.0 No description</span><br><span class="line">npm WARN Demo-01@1.0.0 No repository field.</span><br><span class="line"></span><br><span class="line">+ koa@2.11.0</span><br><span class="line">added 43 packages from 23 contributors and audited 55 packages in 8.114s</span><br><span class="line">found 0 vulnerabilities</span><br></pre></td></tr></table></figure>

<p>创建一个js文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入koa模块</span></span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="comment">// 创建koa的实例app</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*app.use(async ctx =&gt; &#123;</span></span><br><span class="line"><span class="comment">    ctx.body = "Hello World"</span></span><br><span class="line"><span class="comment">&#125;)*/</span></span><br><span class="line">app.use(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.body = <span class="string">'Hello World'</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 监听端口</span></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"服务器已启动，http://localhost:3000"</span>);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">// 导入koa，和koa 1.x不同，在koa2中，我们导入的是一个class，因此用大写的Koa表示:</span></span><br><span class="line"><span class="comment">const Koa = require('koa');</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">// 创建一个Koa对象表示web app本身:</span></span><br><span class="line"><span class="comment">const app = new Koa();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">// 对于任何请求，app将调用该异步函数处理请求：</span></span><br><span class="line"><span class="comment">app.use(async (ctx, next) =&gt; &#123;</span></span><br><span class="line"><span class="comment">    await next();</span></span><br><span class="line"><span class="comment">    ctx.response.type = 'text/html';</span></span><br><span class="line"><span class="comment">    ctx.response.body = '&lt;h1&gt;Hello, koa2!&lt;/h1&gt;';</span></span><br><span class="line"><span class="comment">&#125;);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">// 在端口3000监听:</span></span><br><span class="line"><span class="comment">app.listen(3000);</span></span><br><span class="line"><span class="comment">console.log('app started at port 3000...');</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>运行文件，浏览器即可访问。</p>
<p>app.use方法用于向middleware数组添加Generator函数。</p>
<p>listen方法指定监听端口，并启动当前应用。它实际上等同于下面的代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ar http &#x3D; require(&#39;http&#39;);</span><br><span class="line">var koa &#x3D; require(&#39;koa&#39;);</span><br><span class="line">var app &#x3D; new koa();</span><br><span class="line">http.createServer(app.callback()).listen(3000);</span><br></pre></td></tr></table></figure>

<p>参数ctx是由koa传入的封装了request和response的变量，next是koa传入的将要处理的下一个异步函数，然后，设置response的Content-Type和内容。</p>
<p>由async标记的函数称为异步函数，在异步函数中，可以用await调用另一个异步函数，这两个关键字将在ES7中引入。</p>
<p>引入包方式：</p>
<p>命令  npm install <a href="mailto:koa@2.0.0">koa@2.0.0</a>；</p>
<p>项目的package.json中的 dependencies引入，在使用命令 npm install即会吧项目的包都安装好！</p>
<p>直接用命令node app.js在命令行启动程序，或者用npm start启动。npm start命令会让npm执行定义在package.json文件中的start对应命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">    &quot;start&quot;: &quot;node app.js&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2、级联"><a href="#2、级联" class="headerlink" title="2、级联"></a>2、级联</h4><p>在上述的代码中，node每收到一个http请求，koa就会调用通过app.use()注册的async函数，并传入ctx和next参数。</p>
<p>这里的await next()的作用是：处理函数的执行顺序。</p>
<p>koa把很多中间件组成一个处理链，每个async函数做自己任务，然后用await next()来调用下一个async函数。</p>
<p>就是停止该中间件，继续执行下一个符合请求的中间件(‘downstrem’)，然后控制权再逐级返回给上层中间件(‘upstream’)。</p>
<p>例如，4个中间件组成处理链，依次请求，打印日志，记录处理时间，输出HTML：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"请求数据"</span>);</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;ctx.request.method&#125;</span> <span class="subst">$&#123;ctx.request.url&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> start = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime();</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">    <span class="keyword">const</span> ms = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime() - start;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Time: <span class="subst">$&#123;ms&#125;</span>ms`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">    ctx.response.type = <span class="string">'text/html'</span>;</span><br><span class="line">    ctx.response.body = <span class="string">'&lt;h1&gt;Hello, koa！&lt;/h1&gt;'</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"服务器已启动，http://localhost:3000"</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>运行后访问，后台打印出结果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">请求数据</span><br><span class="line">GET &#x2F;</span><br><span class="line">Time: 0ms</span><br><span class="line">请求数据</span><br><span class="line">GET &#x2F;favicon.ico</span><br><span class="line">Time: 0ms</span><br></pre></td></tr></table></figure>
<p>如果一个没有调用await next()，后续的代码将不再执行了。</p>
<h4 id="3、配置"><a href="#3、配置" class="headerlink" title="3、配置"></a>3、配置</h4><p>应用配置是 app 实例属性，目前支持的配置项如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.env 默认为 NODE_ENV or &quot;development&quot;</span><br><span class="line">app.proxy 如果为 true，则解析 &quot;Host&quot; 的 header 域，并支持 X-Forwarded-Host</span><br><span class="line">app.subdomainOffset 默认为2，表示 .subdomains 所忽略的字符偏移量。</span><br></pre></td></tr></table></figure>
<p><strong>app.listen(…)</strong></p>
<p>Koa 应用并非是一个 1-to-1 表征关系的 HTTP 服务器。 一个或多个Koa应用可以被挂载到一起组成一个包含单一 HTTP 服务器的大型应用群。</p>
<p>如下为一个绑定3000端口的简单 Koa 应用，其创建并返回了一个 HTTP 服务器，为 Server#listen() 传递指定参数（参数的详细文档请查看nodejs.org）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p><strong>同时支持 HTTPS 和 HTTPS</strong>，或者在多个端口监听同一个应用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> https = <span class="built_in">require</span>(<span class="string">'https'</span>);</span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line">http.createServer(app.callback()).listen(<span class="number">3000</span>);</span><br><span class="line">https.createServer(app.callback()).listen(<span class="number">3001</span>);</span><br></pre></td></tr></table></figure>
<p><strong>app.callback()</strong></p>
<p>返回一个适合 http.createServer() 方法的回调函数用来处理请求。 </p>
<p><strong>app.use(function)</strong></p>
<p>为应用添加指定的中间件，详情请看 Middleware</p>
<p><strong>app.keys=</strong></p>
<p>设置签名cookie密钥。</p>
<p>该密钥会被传递给KeyGrip, 当然，您也可以自己生成 KeyGrip. 例如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app.keys &#x3D; [&#39;im a newer secret&#39;, &#39;i like turtle&#39;];</span><br><span class="line">app.keys &#x3D; new KeyGrip([&#39;im a newer secret&#39;, &#39;i like turtle&#39;], &#39;sha256&#39;);</span><br></pre></td></tr></table></figure>
<p>在进行cookie签名时，只有设置 signed 为 true 的时候，才会使用密钥进行加密：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx.cookies.set(<span class="string">'name'</span>, <span class="string">'tobi'</span>, &#123; <span class="attr">signed</span>: <span class="literal">true</span> &#125;);</span><br></pre></td></tr></table></figure>
<p><strong>app.context</strong></p>
<p>app.context是从中创建ctx的原型。 可以通过编辑app.context向ctx添加其他属性。当需要将ctx添加到整个应用程序中使用的属性或方法时，这将会非常有用。这可能会更加有效（不需要中间件）和/或更简单（更少的require()），而不必担心更多的依赖于ctx，这可以被看作是一种反向模式。</p>
<p>例如，从ctx中添加对数据库的引用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.context.db = db();</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(ctx.db);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>注:ctx上的很多属性是被限制的，在app.context只能通过使用Object.defineProperty()来编辑这些属性（不推荐）。可以在 <a href="https://github.com/koajs/koa/issues/652上查阅" target="_blank" rel="noopener">https://github.com/koajs/koa/issues/652上查阅</a><br>已安装的APP沿用父级的ctx和配置。因此，安装的应用程序只是一组中间件。</p>
<h4 id="4、错误处理"><a href="#4、错误处理" class="headerlink" title="4、错误处理"></a>4、错误处理</h4><p>默认情况下Koa会将所有错误信息输出到 stderr， 除非 app.silent 是true.当err.status是404或者err.expose时，默认错误处理程序也不会输出错误。要执行自定义错误处理逻辑，如集中式日志记录，您可以添加一个”错误”事件侦听器：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.on(<span class="string">'error'</span>, err =&gt; &#123;</span><br><span class="line">  log.error(<span class="string">'server error'</span>, err)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>如果错误发生在 请求/响应 环节，并且其不能够响应客户端时，Contenxt 实例也会被传递到 error 事件监听器的回调函数里。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.on(<span class="string">'error'</span>, (err, ctx) =&gt; &#123;</span><br><span class="line">  log.error(<span class="string">'server error'</span>, err, ctx)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>当发生错误但仍能够响应客户端时（比如没有数据写到socket中），Koa会返回一个500错误(Internal Server Error)。 无论哪种情况，Koa都会生成一个应用级别的错误信息，以便实现日志记录等目的。</p>
<h1 id="二、Context-上下文"><a href="#二、Context-上下文" class="headerlink" title="二、Context(上下文)"></a>二、Context(上下文)</h1><p>Koa Context 将 node 的 request 和 response 对象封装在一个单独的对象里面，其为编写 web 应用和 API 提供了很多有用的方法。</p>
<p>context 在每个 request 请求中被创建，在中间件中作为接收器(receiver)来引用，或者通过 this 标识符来引用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  ctx; <span class="comment">// is the Context</span></span><br><span class="line">  ctx.request; <span class="comment">// is a koa Request</span></span><br><span class="line">  ctx.response; <span class="comment">// is a koa Response</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>许多 context 的访问器和方法为了便于访问和调用，简单的委托给他们的 ctx.request 和 ctx.response 所对应的等价方法， 比如说 ctx.type 和 ctx.length 代理了 response 对象中对应的方法，ctx.path 和 ctx.method 代理了 request 对象中对应的方法。</p>
<p>具体API见<a href="https://www.koajs.com.cn/" target="_blank" rel="noopener">https://www.koajs.com.cn/</a></p>
<h1 id="三、Request和Response"><a href="#三、Request和Response" class="headerlink" title="三、Request和Response"></a>三、Request和Response</h1><p>Koa Request 对象是对 node 的 request、response进一步抽象和封装，提供了日常 HTTP 服务器开发中一些有用的功能。</p>
<p>详细api见<a href="https://www.koajs.com.cn/" target="_blank" rel="noopener">https://www.koajs.com.cn/</a></p>
<h1 id="四、处理URL"><a href="#四、处理URL" class="headerlink" title="四、处理URL"></a>四、处理URL</h1><p>通常情况下需要对不同的URL调用不同的处理函数，这样才能返回不同的结果。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (ctx.request.path === <span class="string">'/'</span>) &#123;</span><br><span class="line">        ctx.response.body = <span class="string">'index page'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (ctx.request.path === <span class="string">'/test'</span>) &#123;</span><br><span class="line">        ctx.response.body = <span class="string">'TEST page'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>但是我们可以借助中间件来处理不同的URL调用不同的处理函数。</p>
<h4 id="koa-router"><a href="#koa-router" class="headerlink" title="koa-router"></a>koa-router</h4><p>koa-router这个middleware负责处理URL映射。</p>
<p>在中增加，之后执行npm install执行安装模块。</p>
<p>创建文件，写入代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="comment">// 注意require('koa-router')返回的是函数:相当于</span></span><br><span class="line"><span class="comment">/*const fn_router = require('koa-router');</span></span><br><span class="line"><span class="comment">const router = fn_router();</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Process <span class="subst">$&#123;ctx.request.method&#125;</span> <span class="subst">$&#123;ctx.request.url&#125;</span>...`</span>);</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// add url-route:</span></span><br><span class="line">router.get(<span class="string">'/hello/:name'</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> name = ctx.params.name;</span><br><span class="line">    ctx.response.body = <span class="string">`&lt;h1&gt;Hello, <span class="subst">$&#123;name&#125;</span>!&lt;/h1&gt;`</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/'</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    ctx.response.body = <span class="string">'&lt;h1&gt;Index&lt;/h1&gt;'</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// add router middleware:</span></span><br><span class="line">app.use(router.routes());</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'app started at port 3000...'</span>);</span><br></pre></td></tr></table></figure>
<h4 id="处理post请求"><a href="#处理post请求" class="headerlink" title="处理post请求"></a>处理post请求</h4><p>router.get(‘/path’, async fn)处理的是get请求；router.post(‘/path’, async fn)处理post请求。</p>
<p>post请求通常会发送一个表单，或者JSON，它作为request的body发送，但无论是Node.js提供的原始request对象，还是koa提供的request对象，都不提供解析request的body的功能！所以，需要引入另一个middleware来解析原始request请求，然后，把解析后的参数，绑定到ctx.request.body中。</p>
<p>步骤：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1、package.json中添加依赖项：&quot;koa-bodyparser&quot;: &quot;3.2.0&quot;然后使用npm install安装。</span><br><span class="line">2、修改app.js，引入koa-bodyparser：const bodyParser &#x3D; require(&#39;koa-bodyparser&#39;);在合适的位置加上：app.use(bodyParser());</span><br><span class="line">3、因为middleware有顺序，这个koa-bodyparser必须在router之前被注册到app对象上。</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'koa-bodyparser'</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)();</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line">app.use(bodyParser());</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Process <span class="subst">$&#123;ctx.request.method&#125;</span> <span class="subst">$&#123;ctx.request.url&#125;</span>...`</span>);</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">&#125;);</span><br><span class="line">router.get(<span class="string">'/'</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    ctx.response.body = <span class="string">`&lt;h1&gt;Index&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;form action="/admin" method="post"&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;Name: &lt;input name="name" value="admin"&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;Password: &lt;input name="password" type="password"&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;&lt;input type="submit" value="Submit"&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;/form&gt;`</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'/admin'</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> name = ctx.request.body.name || <span class="string">''</span>,</span><br><span class="line">        password = ctx.request.body.password || <span class="string">''</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`admin with name: <span class="subst">$&#123;name&#125;</span>, password: <span class="subst">$&#123;password&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">if</span> (name === <span class="string">'admin'</span> &amp;&amp; password === <span class="string">'111111'</span>) &#123;</span><br><span class="line">        ctx.response.body = <span class="string">`&lt;h1&gt;Welcome, <span class="subst">$&#123;name&#125;</span>!&lt;/h1&gt;`</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ctx.response.body = <span class="string">`&lt;h1&gt;Login failed!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;&lt;a href="/"&gt;Try again&lt;/a&gt;&lt;/p&gt;`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">app.use(router.routes());</span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'app started at port 3000...'</span>);</span><br></pre></td></tr></table></figure>

<p>在之前的示例中都是全部写在app.js里，每加一个URL，就需要修改app.js。随着URL越来越多，app.js就会越来越长。如果把URL处理函数集中分类写到其他js文件，让app.js自动导入所有处理URL的函数，代码一分离比较清楚：</p>
<p>新建目录结构：</p>
<p><img src="https://img.huyunshun.com/img1/11111imgclip.png" alt=""></p>
<p>把路由信息分别写在不同的文件：</p>
<p>hello.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fn_hello = <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> name = ctx.params.name;</span><br><span class="line">    ctx.response.body = <span class="string">`&lt;h1&gt;Hello, <span class="subst">$&#123;name&#125;</span>!&lt;/h1&gt;`</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="string">'GET /hello/:name'</span>: fn_hello</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> fn_index = <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    ctx.response.body = <span class="string">`&lt;h1&gt;Index&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;form action="/admin" method="post"&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;Name: &lt;input name="name" value="admin"&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;Password: &lt;input name="password" type="password"&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;&lt;input type="submit" value="Submit"&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;/form&gt;`</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fn_admin = <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> name = ctx.request.body.name || <span class="string">''</span>,</span><br><span class="line">        password = ctx.request.body.password || <span class="string">''</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`admin with name: <span class="subst">$&#123;name&#125;</span>, password: <span class="subst">$&#123;password&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">if</span> (name === <span class="string">'admin'</span> &amp;&amp; password === <span class="string">'11111'</span>) &#123;</span><br><span class="line">        ctx.response.body = <span class="string">`&lt;h1&gt;Welcome, <span class="subst">$&#123;name&#125;</span>!&lt;/h1&gt;`</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ctx.response.body = <span class="string">`&lt;h1&gt;Login failed!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;&lt;a href="/"&gt;Try again&lt;/a&gt;&lt;/p&gt;`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="string">'GET /'</span>: fn_index,</span><br><span class="line">    <span class="string">'POST /admin'</span>: fn_admin</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>app.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'koa-bodyparser'</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)();</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Process <span class="subst">$&#123;ctx.request.method&#125;</span> <span class="subst">$&#123;ctx.request.url&#125;</span>...`</span>);</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">&#125;);</span><br><span class="line">app.use(bodyParser());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 先导入fs模块，然后用readdirSync列出文件</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="comment">// 这里可以用sync是因为启动时只运行一次，不存在性能问题:</span></span><br><span class="line"><span class="keyword">var</span> files = fs.readdirSync(__dirname + <span class="string">'/controllers'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 过滤出.js文件:</span></span><br><span class="line"><span class="keyword">var</span> js_files = files.filter(<span class="function">(<span class="params">f</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> f.endsWith(<span class="string">'.js'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理每个js文件:</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> f <span class="keyword">of</span> js_files) &#123;</span><br><span class="line">    <span class="comment">// 处理每个js文件</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> url <span class="keyword">in</span> mapping) &#123;</span><br><span class="line">        <span class="keyword">if</span> (url.startsWith(<span class="string">'GET '</span>)) &#123;</span><br><span class="line">            <span class="comment">// 如果url类似"GET xxx":</span></span><br><span class="line">            <span class="keyword">var</span> path = url.substring(<span class="number">4</span>);</span><br><span class="line">            router.get(path, mapping[url]);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (url.startsWith(<span class="string">'POST '</span>)) &#123;</span><br><span class="line">            <span class="comment">// 如果url类似"POST xxx":</span></span><br><span class="line">            <span class="keyword">var</span> path = url.substring(<span class="number">5</span>);</span><br><span class="line">            router.post(path, mapping[url]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 无效的URL:</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`invalid URL: <span class="subst">$&#123;url&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.use(router.routes());</span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'app started at port 3000...'</span>);</span><br></pre></td></tr></table></figure>

<p>启动后测试没问题，这里app.js中整理下代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'koa-bodyparser'</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)();</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Process <span class="subst">$&#123;ctx.request.method&#125;</span> <span class="subst">$&#123;ctx.request.url&#125;</span>...`</span>);</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addMapping</span>(<span class="params">router, mapping</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> url <span class="keyword">in</span> mapping) &#123;</span><br><span class="line">        <span class="keyword">if</span> (url.startsWith(<span class="string">'GET '</span>)) &#123;</span><br><span class="line">            <span class="keyword">var</span> path = url.substring(<span class="number">4</span>);</span><br><span class="line">            router.get(path, mapping[url]);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (url.startsWith(<span class="string">'POST '</span>)) &#123;</span><br><span class="line">            <span class="keyword">var</span> path = url.substring(<span class="number">5</span>);</span><br><span class="line">            router.post(path, mapping[url]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`invalid URL: <span class="subst">$&#123;url&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addControllers</span>(<span class="params">router</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> files = fs.readdirSync(__dirname + <span class="string">'/controllers'</span>);</span><br><span class="line">    <span class="keyword">var</span> js_files = files.filter(<span class="function">(<span class="params">f</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> f.endsWith(<span class="string">'.js'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> f <span class="keyword">of</span> js_files) &#123;</span><br><span class="line">        <span class="keyword">let</span> mapping = <span class="built_in">require</span>(__dirname + <span class="string">'/controllers/'</span> + f);</span><br><span class="line">        addMapping(router, mapping);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">addControllers(router);</span><br><span class="line"></span><br><span class="line">app.use(bodyParser());</span><br><span class="line">app.use(router.routes());</span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'app started at port 3000...'</span>);</span><br></pre></td></tr></table></figure>

<h4 id="Controller-Middleware"><a href="#Controller-Middleware" class="headerlink" title="Controller Middleware"></a>Controller Middleware</h4><p>我们把扫描controllers目录和创建router的代码从app.js中提取出来，作为一个简单的middleware使用，命名为controller.js：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addMapping</span>(<span class="params">router, mapping</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> url <span class="keyword">in</span> mapping) &#123;</span><br><span class="line">        <span class="keyword">if</span> (url.startsWith(<span class="string">'GET '</span>)) &#123;</span><br><span class="line">            <span class="keyword">var</span> path = url.substring(<span class="number">4</span>);</span><br><span class="line">            router.get(path, mapping[url]);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`register URL mapping: GET <span class="subst">$&#123;path&#125;</span>`</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (url.startsWith(<span class="string">'POST '</span>)) &#123;</span><br><span class="line">            <span class="keyword">var</span> path = url.substring(<span class="number">5</span>);</span><br><span class="line">            router.post(path, mapping[url]);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`register URL mapping: POST <span class="subst">$&#123;path&#125;</span>`</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (url.startsWith(<span class="string">'PUT '</span>)) &#123;</span><br><span class="line">            <span class="keyword">var</span> path = url.substring(<span class="number">4</span>);</span><br><span class="line">            router.put(path, mapping[url]);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`register URL mapping: PUT <span class="subst">$&#123;path&#125;</span>`</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (url.startsWith(<span class="string">'DELETE '</span>)) &#123;</span><br><span class="line">            <span class="keyword">var</span> path = url.substring(<span class="number">7</span>);</span><br><span class="line">            router.del(path, mapping[url]);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`register URL mapping: DELETE <span class="subst">$&#123;path&#125;</span>`</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`invalid URL: <span class="subst">$&#123;url&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addControllers</span>(<span class="params">router, dir</span>) </span>&#123;</span><br><span class="line">    fs.readdirSync(__dirname + <span class="string">'/'</span> + dir).filter(<span class="function">(<span class="params">f</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> f.endsWith(<span class="string">'.js'</span>);</span><br><span class="line">    &#125;).forEach(<span class="function">(<span class="params">f</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`process controller: <span class="subst">$&#123;f&#125;</span>...`</span>);</span><br><span class="line">        <span class="keyword">let</span> mapping = <span class="built_in">require</span>(__dirname + <span class="string">'/'</span> + dir + <span class="string">'/'</span> + f);</span><br><span class="line">        addMapping(router, mapping);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">dir</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> controllers_dir = dir || <span class="string">'controllers'</span>,</span><br><span class="line">        router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)();</span><br><span class="line">    addControllers(router, controllers_dir);</span><br><span class="line">    <span class="keyword">return</span> router.routes();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>app中简化为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'koa-bodyparser'</span>);</span><br><span class="line"><span class="keyword">const</span> controller = <span class="built_in">require</span>(<span class="string">'./controller'</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Process <span class="subst">$&#123;ctx.request.method&#125;</span> <span class="subst">$&#123;ctx.request.url&#125;</span>...`</span>);</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(bodyParser());</span><br><span class="line"></span><br><span class="line"><span class="comment">// add controllers:</span></span><br><span class="line">app.use(controller());</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'app started at port 3000...'</span>);</span><br></pre></td></tr></table></figure>
<p>经过重新整理后的代码具有非常好的模块化，所有处理URL的函数按功能组存放在controllers目录，只需要不断往这个目录下加东西就可以了，app.js保持不变。</p>
<h1 id="五、Nunjucks"><a href="#五、Nunjucks" class="headerlink" title="五、Nunjucks"></a>五、Nunjucks</h1><h4 id="模板引擎"><a href="#模板引擎" class="headerlink" title="模板引擎"></a>模板引擎</h4><p>模板引擎就是基于模板配合数据构造出字符串输出的一个组件。比如下面的函数就是一个模板引擎：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function examResult (data) &#123;</span><br><span class="line">    return &#96;$&#123;data.name&#125;同学一年级期末考试语文$&#123;data.chinese&#125;分，数学$&#123;data.math&#125;分，位于年级第$&#123;data.ranking&#125;名。&#96;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果我们输入数据如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">examResult(&#123;</span><br><span class="line">    name: &#39;小明&#39;,</span><br><span class="line">    chinese: 78,</span><br><span class="line">    math: 87,</span><br><span class="line">    ranking: 999</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>该模板引擎把模板字符串里面对应的变量替换以后，就可以得到以下输出：</p>
<p>小明同学一年级期末考试语文78分，数学87分，位于年级第999名。</p>
<p>模板引擎最常见的输出就是输出网页，也就是HTML文本。当然，也可以输出任意格式的文本，比如Text，XML，Markdown等等。</p>
<p>有同学要问了：既然JavaScript的模板字符串可以实现模板功能，那为什么我们还需要另外的模板引擎？</p>
<p>因为JavaScript的模板字符串必须写在JavaScript代码中，要想写出新浪首页这样复杂的页面，是非常困难的。</p>
<p>输出HTML有几个特别重要的问题需要考虑：</p>
<h5 id="转义"><a href="#转义" class="headerlink" title="转义"></a>转义</h5><p>对特殊字符要转义，避免受到XSS攻击。比如，如果变量name的值不是小明，而是小明<script>...</script>，模板引擎输出的HTML到了浏览器，就会自动执行恶意JavaScript代码。</p>
<h5 id="格式化"><a href="#格式化" class="headerlink" title="格式化"></a>格式化</h5><p>对不同类型的变量要格式化，比如，货币需要变成12,345.00这样的格式，日期需要变成2016-01-01这样的格式。</p>
<h5 id="简单逻辑"><a href="#简单逻辑" class="headerlink" title="简单逻辑"></a>简单逻辑</h5><p>模板还需要能执行一些简单逻辑，比如，要按条件输出内容，需要if实现如下输出：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; name &#125;&#125;同学，</span><br><span class="line">&#123;% <span class="keyword">if</span> score &gt;= <span class="number">90</span> %&#125;</span><br><span class="line">    成绩优秀，应该奖励</span><br><span class="line">&#123;% elif score &gt;=<span class="number">60</span> %&#125;</span><br><span class="line">    成绩良好，继续努力</span><br><span class="line">&#123;% <span class="keyword">else</span> %&#125;</span><br><span class="line">    不及格，建议回家打屁股</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
<p>所以，我们需要一个功能强大的模板引擎，来完成页面输出的功能。</p>
<h4 id="Nunjucks"><a href="#Nunjucks" class="headerlink" title="Nunjucks"></a>Nunjucks</h4><p>Nunjucks是Mozilla开发的一个纯JavaScript编写的模板引擎，既可以用在Node环境下，又可以运行在浏览器端。但是，主要还是运行在Node环境下，因为浏览器端有更好的模板解决方案，例如MVVM框架。</p>
<p>如果你使用过Python的模板引擎jinja2，那么使用Nunjucks就非常简单，两者的语法几乎是一模一样的，因为Nunjucks就是用JavaScript重新实现了jinjia2。</p>
<p>从上面的例子我们可以看到，虽然模板引擎内部可能非常复杂，但是使用一个模板引擎是非常简单的，因为本质上我们只需要构造这样一个函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function render(view, model) &#123;</span><br><span class="line">    &#x2F;&#x2F; TODO:...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中，view是模板的名称（又称为视图），因为可能存在多个模板，需要选择其中一个。model就是数据，在JavaScript中，它就是一个简单的Object。render函数返回一个字符串，就是模板的输出。</p>
<p>下面我们来使用Nunjucks这个模板引擎来编写几个HTML模板，并且用实际数据来渲染模板并获得最终的HTML输出。</p>
<p>创建项目：</p>
<p><img src="https://img.huyunshun.com/img1/11111imgclip_1.png" alt=""></p>
<p>package.json中引入：”nunjucks”: “2.4.2”</p>
<p>模板引擎是可以独立使用的，并不需要依赖koa。</p>
<p>在app.js中编写代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> nunjucks = <span class="built_in">require</span>(<span class="string">'nunjucks'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createEnv</span>(<span class="params">path, opts</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> autoescape = opts.autoescape === <span class="literal">undefined</span> ? <span class="literal">true</span> : opts.autoescape,</span><br><span class="line">        noCache = opts.noCache || <span class="literal">false</span>,</span><br><span class="line">        watch = opts.watch || <span class="literal">false</span>,</span><br><span class="line">        throwOnUndefined = opts.throwOnUndefined || <span class="literal">false</span>,</span><br><span class="line">        env = <span class="keyword">new</span> nunjucks.Environment(</span><br><span class="line">            <span class="keyword">new</span> nunjucks.FileSystemLoader(<span class="string">'views'</span>, &#123;</span><br><span class="line">                noCache: noCache,</span><br><span class="line">                watch: watch,</span><br><span class="line">            &#125;), &#123;</span><br><span class="line">                autoescape: autoescape,</span><br><span class="line">                throwOnUndefined: throwOnUndefined</span><br><span class="line">            &#125;);</span><br><span class="line">    <span class="keyword">if</span> (opts.filters) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> f <span class="keyword">in</span> opts.filters) &#123;</span><br><span class="line">            env.addFilter(f, opts.filters[f]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> env;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//变量env就表示Nunjucks模板引擎对象，它有一个render(view, model)方法，正好传入view和model两个参数，并返回字符串。</span></span><br><span class="line"><span class="keyword">var</span> env = createEnv(<span class="string">'views'</span>, &#123;</span><br><span class="line">    watch: <span class="literal">true</span>,</span><br><span class="line">    filters: &#123;</span><br><span class="line">        hex: <span class="function"><span class="keyword">function</span> (<span class="params">n</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'0x'</span> + n.toString(<span class="number">16</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>创建env需要的参数可以查看文档获知。我们用autoescape = opts.autoescape &amp;&amp; true这样的代码给每个参数加上默认值，最后使用new nunjucks.FileSystemLoader(‘views’)创建一个文件系统加载器，从views目录读取模板。</p>
<p>我们编写一个hello.html模板文件，放到views目录下，内容如下：</p>
<h1>Hello </h1>

<p>然后，我们就可以用下面的代码来渲染这个模板：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var s &#x3D; env.render(&#39;hello.html&#39;, &#123; name: &#39;小明&#39; &#125;);</span><br><span class="line">console.log(s);</span><br></pre></td></tr></table></figure>
<p>运行获得输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;D:\Program Files\nodejs\node.exe&quot; D:\mydoc\NodeJs\koa-study-demo\Demo-03\app.js</span><br><span class="line">&lt;h1&gt;Hello 小明&lt;&#x2F;h1&gt;</span><br></pre></td></tr></table></figure>
<p>咋一看，这和使用JavaScript模板字符串没啥区别嘛。不过，试试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var s &#x3D; env.render(&#39;hello.html&#39;, &#123; name: &#39;&lt;script&gt;alert(&quot;小明&quot;)&lt;&#x2F;script&gt;&#39; &#125;);</span><br><span class="line">console.log(s);</span><br></pre></td></tr></table></figure>
<p>获得输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;h1&gt;Hello &lt;script&gt;alert(&quot;小明&quot;)&lt;&#x2F;script&gt;&lt;&#x2F;h1&gt;</span><br></pre></td></tr></table></figure>
<p>这样就避免了输出恶意脚本。</p>
<p>此外，可以使用Nunjucks提供的功能强大的tag，编写条件判断、循环等功能，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 循环输出名字 --&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h3&gt;Fruits List&lt;&#x2F;h3&gt;</span><br><span class="line">    &#123;% for f in fruits %&#125;</span><br><span class="line">    &lt;p&gt;&#123;&#123; f &#125;&#125;&lt;&#x2F;p&gt;</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br></pre></td></tr></table></figure>
<p>Nunjucks模板引擎最强大的功能在于模板的<strong>继承</strong>。</p>
<p>仔细观察各种网站可以发现，网站的结构实际上是类似的，头部、尾部都是固定格式，只有中间页面部分内容不同。如果每个模板都重复头尾，一旦要修改头部或尾部，那就需要改动所有模板。</p>
<p>更好的方式是使用继承。先定义一个基本的网页框架base.html：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&#123;% block header %&#125;</span><br><span class="line">&lt;h3&gt;Unnamed&lt;&#x2F;h3&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line">&#123;% block body %&#125;</span><br><span class="line">&lt;div&gt;No body&lt;&#x2F;div&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line">&#123;% block footer %&#125;</span><br><span class="line">&lt;div&gt;copyright&lt;&#x2F;div&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br></pre></td></tr></table></figure>

<p>base.html定义了三个可编辑的块，分别命名为header、body和footer。子模板可以有选择地对块进行重新定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &#39;base.html&#39; %&#125;</span><br><span class="line">&#123;% block header %&#125;&lt;h1&gt;&#123;&#123; header &#125;&#125;&lt;&#x2F;h1&gt;&#123;% endblock %&#125;</span><br><span class="line">&#123;% block body %&#125;&lt;p&gt;&#123;&#123; body &#125;&#125;&lt;&#x2F;p&gt;&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<p>然后，我们对子模板进行渲染：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>输出HTML如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Hello&lt;&#x2F;h1&gt;</span><br><span class="line">&lt;p&gt;哈哈哈哈...&lt;&#x2F;p&gt;</span><br><span class="line"></span><br><span class="line">&lt;div&gt;copyright&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;body&gt;</span><br></pre></td></tr></table></figure>

<p><strong>性能</strong></p>
<p>对于模板渲染本身来说，速度是非常非常快的，因为就是拼字符串嘛，纯CPU操作。</p>
<p>性能问题主要出现在从文件读取模板内容这一步。这是一个IO操作，在Node.js环境中，我们知道，单线程的JavaScript最不能忍受的就是同步IO，但Nunjucks默认就使用同步IO读取模板文件。</p>
<p>但是Nunjucks会缓存已读取的文件内容，也就是说，模板文件最多读取一次，就会放在内存中，后面的请求是不会再次读取文件的，只要我们指定了noCache: false这个参数。</p>
<p>在开发环境下，可以关闭cache，这样每次重新加载模板，便于实时修改模板。在生产环境下，一定要打开cache，这样就不会有性能问题。</p>
<p>Nunjucks也提供了异步读取的方式，但是这样写起来很麻烦，有简单的写法我们就不会考虑复杂的写法。保持代码简单是可维护性的关键。</p>
<h4 id="实现简单编写View实现"><a href="#实现简单编写View实现" class="headerlink" title="实现简单编写View实现"></a>实现简单编写View实现</h4><p><img src="https://img.huyunshun.com/img1/11111imgclip_2.png" alt=""></p>
<h5 id="处理静态文件"><a href="#处理静态文件" class="headerlink" title="处理静态文件"></a>处理静态文件</h5><p>我们把所有静态资源文件全部放入/static目录，目的就是能统一处理静态文件。在koa中，我们需要编写一个middleware，处理以/static/开头的URL。</p>
<h5 id="编写middleware"><a href="#编写middleware" class="headerlink" title="编写middleware"></a>编写middleware</h5><p>处理静态文件的middleware，static-files.js的文件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> mime = <span class="built_in">require</span>(<span class="string">'mime'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'mz/fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// url: 类似 '/static/'</span></span><br><span class="line"><span class="comment">// dir: 类似 __dirname + '/static'</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">staticFiles</span>(<span class="params">url, dir</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> rpath = ctx.request.path;</span><br><span class="line">        <span class="comment">// 判断是否以指定的url开头:</span></span><br><span class="line">        <span class="keyword">if</span> (rpath.startsWith(url)) &#123;</span><br><span class="line">            <span class="comment">// 获取文件完整路径:</span></span><br><span class="line">            <span class="keyword">let</span> fp = path.join(dir, rpath.substring(url.length));</span><br><span class="line">            <span class="comment">// 判断文件是否存在:</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">await</span> fs.exists(fp)) &#123;</span><br><span class="line">                <span class="comment">// 查找文件的mime:</span></span><br><span class="line">                ctx.response.type = mime.lookup(rpath);</span><br><span class="line">                <span class="comment">// 读取文件内容并赋值给response.body:</span></span><br><span class="line">                ctx.response.body = <span class="keyword">await</span> fs.readFile(fp);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 文件不存在:</span></span><br><span class="line">                ctx.response.status = <span class="number">404</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 不是指定前缀的URL，继续处理下一个middleware:</span></span><br><span class="line">            <span class="keyword">await</span> next();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = staticFiles;</span><br></pre></td></tr></table></figure>
<p>staticFiles是一个普通函数，它接收两个参数：URL前缀和一个目录，然后返回一个async函数。这个async函数会判断当前的URL是否以指定前缀开头，如果是，就把URL的路径视为文件，并发送文件内容。如果不是，这个async函数就不做任何事情，而是简单地调用await next()让下一个middleware去处理请求。</p>
<p>mz提供的API和Node.js的fs模块完全相同，但fs模块使用回调，而mz封装了fs对应的函数，并改为Promise。这样，我们就可以非常简单的用await调用mz的函数，而不需要任何回调。</p>
<p>所有的第三方包都可以通过npm官网搜索并查看其文档：<a href="https://www.npmjs.com/" target="_blank" rel="noopener">https://www.npmjs.com/</a></p>
<p>最后，这个middleware使用起来也很简单，在app.js里加一行代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let staticFiles &#x3D; require(&#39;.&#x2F;static-files&#39;);</span><br><span class="line">app.use(staticFiles(&#39;&#x2F;static&#x2F;&#39;, __dirname + &#39;&#x2F;static&#39;));</span><br></pre></td></tr></table></figure>
<p>注意：也可以去npm搜索能用于koa2的处理静态文件的包并直接使用。</p>
<h5 id="集成Nunjucks"><a href="#集成Nunjucks" class="headerlink" title="集成Nunjucks"></a>集成Nunjucks</h5><p>集成Nunjucks实际上也是编写一个middleware，这个middleware的作用是给ctx对象绑定一个render(view, model)的方法，这样，后面的Controller就可以调用这个方法来渲染模板了。</p>
<p>我们创建一个templating.js来实现这个middleware：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> nunjucks = <span class="built_in">require</span>(<span class="string">'nunjucks'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createEnv</span>(<span class="params">path, opts</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> autoescape = opts.autoescape === <span class="literal">undefined</span> ? <span class="literal">true</span> : opts.autoescape,</span><br><span class="line">        noCache = opts.noCache || <span class="literal">false</span>,</span><br><span class="line">        watch = opts.watch || <span class="literal">false</span>,</span><br><span class="line">        throwOnUndefined = opts.throwOnUndefined || <span class="literal">false</span>,</span><br><span class="line">        env = <span class="keyword">new</span> nunjucks.Environment(</span><br><span class="line">            <span class="keyword">new</span> nunjucks.FileSystemLoader(path || <span class="string">'views'</span>, &#123;</span><br><span class="line">                noCache: noCache,</span><br><span class="line">                watch: watch,</span><br><span class="line">            &#125;), &#123;</span><br><span class="line">                autoescape: autoescape,</span><br><span class="line">                throwOnUndefined: throwOnUndefined</span><br><span class="line">            &#125;);</span><br><span class="line">    <span class="keyword">if</span> (opts.filters) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> f <span class="keyword">in</span> opts.filters) &#123;</span><br><span class="line">            env.addFilter(f, opts.filters[f]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> env;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">templating</span>(<span class="params">path, opts</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 创建Nunjucks的env对象:</span></span><br><span class="line">    <span class="keyword">var</span> env = createEnv(path, opts);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 给ctx绑定render函数:</span></span><br><span class="line">        ctx.render = <span class="function"><span class="keyword">function</span> (<span class="params">view, model</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 把render后的内容赋值给response.body:</span></span><br><span class="line">            ctx.response.body = env.render(view, <span class="built_in">Object</span>.assign(&#123;&#125;, ctx.state || &#123;&#125;, model || &#123;&#125;));</span><br><span class="line">            <span class="comment">// 设置Content-Type:</span></span><br><span class="line">            ctx.response.type = <span class="string">'text/html'</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 继续处理请求:</span></span><br><span class="line">        <span class="keyword">await</span> next();</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = templating;</span><br></pre></td></tr></table></figure>
<p>在这个middleware中，主要的是templating，给ctx绑定render函数，就继续调用下一个middleware。</p>
<p>使用的时候，我们在app.js添加如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const isProduction &#x3D; process.env.NODE_ENV &#x3D;&#x3D;&#x3D; &#39;production&#39;;</span><br><span class="line"></span><br><span class="line">app.use(templating(&#39;views&#39;, &#123;</span><br><span class="line">    noCache: !isProduction,</span><br><span class="line">    watch: !isProduction</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
<p>isProduction，它判断当前环境是否是production环境。如果是，就使用缓存，如果不是，就关闭缓存。在开发环境下，关闭缓存后，我们修改View，可以直接刷新浏览器看到效果，否则，每次修改都必须重启Node程序，会极大地降低开发效率。</p>
<p>全局变量process中定义了一个环境变量env.NODE_ENV，开发的时候，环境变量应该设置为’development’，而部署到服务器时，环境变量应该设置为’production’。</p>
<p>注意：生产环境上必须配置环境变量NODE_ENV = ‘production’，而开发环境不需要配置，实际上NODE_ENV可能是undefined，所以判断的时候，不要用NODE_ENV === ‘development’。</p>
<p>类似的，我们在使用上面编写的处理静态文件的middleware时，也可以根据环境变量判断：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (! isProduction) &#123;</span><br><span class="line">    let staticFiles &#x3D; require(&#39;.&#x2F;static-files&#39;);</span><br><span class="line">    app.use(staticFiles(&#39;&#x2F;static&#x2F;&#39;, __dirname + &#39;&#x2F;static&#39;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在生产环境下，静态文件是由部署在最前面的反向代理服务器（如Nginx）处理的，Node程序不需要处理静态文件。而在开发环境下，我们希望koa能顺带处理静态文件，否则，就必须手动配置一个反向代理服务器，这样会导致开发环境非常复杂。</p>
<h5 id="编写View"><a href="#编写View" class="headerlink" title="编写View"></a>编写View</h5><h5 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h5><p>再检查一下app.js里的middleware的顺序：</p>
<p>第一个middleware是记录URL以及页面执行时间：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Process <span class="subst">$&#123;ctx.request.method&#125;</span> <span class="subst">$&#123;ctx.request.url&#125;</span>...`</span>);</span><br><span class="line">    <span class="keyword">var</span></span><br><span class="line">        start = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime(),</span><br><span class="line">        execTime;</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">    execTime = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime() - start;</span><br><span class="line">    ctx.response.set(<span class="string">'X-Response-Time'</span>, <span class="string">`<span class="subst">$&#123;execTime&#125;</span>ms`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>第二个middleware处理静态文件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (! isProduction) &#123;</span><br><span class="line">    <span class="keyword">let</span> staticFiles = <span class="built_in">require</span>(<span class="string">'./static-files'</span>);</span><br><span class="line">    app.use(staticFiles(<span class="string">'/static/'</span>, __dirname + <span class="string">'/static'</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第三个middleware解析POST请求：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(bodyParser());</span><br></pre></td></tr></table></figure>
<p>第四个middleware负责给ctx加上render()来使用Nunjucks：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.use(templating(<span class="string">'view'</span>, &#123;</span><br><span class="line">    noCache: !isProduction,</span><br><span class="line">    watch: !isProduction</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
<p>最后一个middleware处理URL路由：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(controller());</span><br></pre></td></tr></table></figure>
<p>现在，在VS Code中运行代码，不出意外的话，在浏览器输入localhost:3000/，可以看到首页内容：</p>
<p>koa-index</p>
<p>直接在首页登录，如果输入正确的Email和Password，进入登录成功的页面：</p>
<p>koa-admin-ok</p>
<p>如果输入的Email和Password不正确，进入登录失败的页面：</p>
<p>koa-admin-failed</p>
<p>怎么判断正确的name和Password？目前我们在admin.js中是这么判断的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (name &#x3D;&#x3D;&#x3D; &#39;admin&#39; &amp;&amp; password &#x3D;&#x3D;&#x3D; &#39;111111&#39;) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h5><p>注意到ctx.render内部渲染模板时，Model对象并不是传入的model变量，而是：</p>
<p>Object.assign({}, ctx.state || {}, model || {})</p>
<p>首先，model || {}确保了即使传入undefined，model也会变为默认值{}。Object.assign()会把除第一个参数外的其他参数的所有属性复制到第一个参数中。第二个参数是ctx.state || {}，这个目的是为了能把一些公共的变量放入ctx.state并传给View。</p>
<p>例如，某个middleware负责检查用户权限，它可以把当前用户放入ctx.state中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> user = tryGetUserFromCookie(ctx.request);</span><br><span class="line">    <span class="keyword">if</span> (user) &#123;</span><br><span class="line">        ctx.state.user = user;</span><br><span class="line">        <span class="keyword">await</span> next();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ctx.response.status = <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这样就没有必要在每个Controller的async函数中都把user变量放入model中。</p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/05/08/docker%E4%BB%8E%E5%AE%B9%E5%99%A8%E9%87%8C%E9%9D%A2%E6%8B%B7%E6%96%87%E4%BB%B6%E5%88%B0%E5%AE%BF%E4%B8%BB%E6%9C%BA%E6%88%96%E4%BB%8E%E5%AE%BF%E4%B8%BB%E6%9C%BA%E6%8B%B7%E6%96%87%E4%BB%B6%E5%88%B0docker%E5%AE%B9%E5%99%A8%E9%87%8C%E9%9D%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/08/docker%E4%BB%8E%E5%AE%B9%E5%99%A8%E9%87%8C%E9%9D%A2%E6%8B%B7%E6%96%87%E4%BB%B6%E5%88%B0%E5%AE%BF%E4%B8%BB%E6%9C%BA%E6%88%96%E4%BB%8E%E5%AE%BF%E4%B8%BB%E6%9C%BA%E6%8B%B7%E6%96%87%E4%BB%B6%E5%88%B0docker%E5%AE%B9%E5%99%A8%E9%87%8C%E9%9D%A2/" itemprop="url">docker从容器里面拷文件到宿主机或从宿主机拷文件到docker容器里面</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-08T00:00:00+08:00">
                2019-05-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>docker从容器里面拷文件到宿主机或从宿主机拷文件到docker容器里面</p>
<p>1、从容器里面拷文件到宿主机</p>
<pre><code>docker cp 容器名：要拷贝的文件在容器里面的路径       要拷贝到宿主机的相应路径 </code></pre><p>docker cp ae46b6f81c6a:/usr/share/elasticsearch/plugins/ ik</p>
<p>2、从宿主机拷文件到容器里面</p>
<pre><code>          docker cp 要拷贝的文件路径 容器名：要拷贝到容器里面对应的路径

docker cp ik ae46b6f81c6a:/usr/share/elasticsearch/plugins/</code></pre>
          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/05/03/synchronized%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/03/synchronized%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/" itemprop="url">synchronized原理分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-03T17:25:29+08:00">
                2019-05-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Synchronized是Java中解决并发问题的一种最常用的方法，也是最简单的一种方法。Synchronized的作用主要有三个：</p>
<ul>
<li>原子性：确保线程互斥的访问同步代码；</li>
<li>可见性：保证共享变量的修改能够及时可见，其实是通过Java内存模型中的 “对一个变量unlock操作之前，必须要同步到主内存中；如果对一个变量进行lock操作，则将会清空工作内存中此变量的值，在执行引擎使用此变量前，需要重新从主内存中load操作或assign操作初始化变量值” 来保证的；</li>
<li>有序性：有效解决重排序问题，即 “一个unlock操作先行发生(happen-before)于后面对同一个锁的lock操作”；</li>
</ul>
<p>Synchronized总共有三种用法：</p>
<p>Synchronized修饰静态方法，对类对象进行加锁，是类锁。</p>
<p>Synchronized修饰实例方法，对方法所属对象进行加锁，是对象锁。</p>
<p>Synchronized修饰代码块时，对一段代码块进行加锁，是对象锁。</p>
<p>注意，synchronized 内置锁 是一种 对象锁（锁的是对象而非引用变量），作用粒度是对象 ，可以用来实现对 临界资源的同步互斥访问 ，是可重入 的。其可重入最大的作用是避免死锁，如：</p>
<p>子类同步方法调用了父类同步方法，如没有可重入的特性，则会发生死锁；</p>
<h2 id="Synchronized底层实现原理"><a href="#Synchronized底层实现原理" class="headerlink" title="Synchronized底层实现原理"></a>Synchronized底层实现原理</h2><p>当一个线程访问同步代码块时，首先是需要得到锁才能执行同步代码，当退出或者抛出异常时必须要释放锁，那么它是如何来实现这个机制的呢？</p>
<p>在 Java 中，每个对象都会有一个 monitor 对象，监视器。<br>1)某一线程占有这个对象的时候，先monitor 的计数器是不是0，如果是0还没有线程占有，这个时候线程占有这个对象，并且对这个对象的monitor+1；如果不为0，表示这个线程已经被其他线程占有，这个线程等待。当线程释放占有权的时候，monitor-1；<br>2)同一线程可以对同一对象进行多次加锁，+1，+1，重入性</p>
<h3 id="1、线程堆栈分析（互斥）"><a href="#1、线程堆栈分析（互斥）" class="headerlink" title="1、线程堆栈分析（互斥）"></a>1、线程堆栈分析（互斥）</h3><p>可以通过Jconsole工具看对象的堆栈情况，</p>
<p>还有就是通过 JVM指令分析</p>
<p>  Javap -V  反编译</p>
<p><img src="https://img.huyunshun.com/img/20200503173621.png" alt="20200503173621"></p>
<p><strong>monitorenter：</strong> 每个对象都是一个监视器锁（monitor）。当monitor被占用时就会处于锁定状态，线程执行monitorenter指令时尝试获取monitor的所有权，过程如下：</p>
<pre><code>如果monitor的进入数为0，则该线程进入monitor，然后将进入数设置为1，该线程即为monitor的所有者；
如果线程已经占有该monitor，只是重新进入，则进入monitor的进入数加1；
如果其他线程已经占用了monitor，则该线程进入阻塞状态，直到monitor的进入数为0，再重新尝试获取monitor的所有权；</code></pre><p><strong>monitorexit：</strong> 执行monitorexit的线程必须是objectref所对应的monitor的所有者。指令执行时，monitor的进入数减1，如果减1后进入数为0，那线程退出monitor，不再是这个monitor的所有者。其他被这个monitor阻塞的线程可以尝试去获取这个 monitor 的所有权。</p>
<p>monitorexit指令出现了两次，第1次为同步正常退出释放锁；第2次为发生异步退出释放锁；</p>
<p>Synchronized的语义底层是通过一个monitor的对象来完成，其实wait/notify等方法也依赖于monitor对象，这就是为什么只有在同步的块或者方法中才能调用wait/notify等方法，否则会抛出java.lang.IllegalMonitorStateException的异常的原因。</p>
<h4 id="对方法的加锁"><a href="#对方法的加锁" class="headerlink" title="对方法的加锁"></a>对方法的加锁</h4><p>ACC_SYNCHRONIZED</p>
<p><img src="https://img.huyunshun.com/img/20200503173949.png" alt="20200503173949"></p>
<p>方法的同步并没有通过指令 monitorenter 和 monitorexit 来完成（理论上其实也可以通过这两条指令来实现），不过相对于普通方法，其常量池中多了 ACC_SYNCHRONIZED 标示符。JVM就是根据该标示符来实现方法的同步的：</p>
<p>当方法调用时，调用指令将会检查方法的 ACC_SYNCHRONIZED 访问标志是否被设置，如果设置了，执行线程将先获取monitor，获取成功之后才能执行方法体，方法执行完后再释放monitor。在方法执行期间，其他任何线程都无法再获得同一个monitor对象。</p>
<p>两种同步方式本质上没有区别，只是方法的同步是一种隐式的方式来实现，无需通过字节码来完成。两个指令的执行是JVM通过调用操作系统的互斥原语mutex来实现，被阻塞的线程会被挂起、等待重新调度，会导致“用户态和内核态”两个态之间来回切换，对性能有较大影响。</p>
<h2 id="同步原理"><a href="#同步原理" class="headerlink" title="同步原理"></a>同步原理</h2><p>锁是加在对象上的，无论是类对象还是实例对象。每个对象主要由一个对象头、实例变量、填充数据三部分组成，结构如图：</p>
<p><img src="https://img.huyunshun.com/img/20200503174148.png" alt="20200503174148"></p>
<p>Synchronized用的锁就是存在Java对象头里的，那么什么是Java对象头呢？Hotspot虚拟机的对象头主要包括两部分数据：Mark Word（标记字段）、Class Pointer（类型指针）。其中 Class Pointer是对象指向它的类元数据的指针，虚拟机通过这个指针来确定这个对象是哪个类的实例，Mark Word用于存储对象自身的运行时数据，它是实现轻量级锁和偏向锁的关键。，其结构说明如下：</p>
<p><img src="https://img.huyunshun.com/img/20200503174437.png" alt="20200503174437"></p>
<p>Mark Word在默认情况下存储着对象的HashCode、分代年龄、锁标记位等以下是32位JVM的Mark Word默认存储结构：</p>
<p><img src="https://img.huyunshun.com/img/20200503174636.png" alt="20200503174636"></p>
<p>由于对象头的信息是与对象自身定义的数据没有关系的额外存储成本，因此考虑到JVM的空间效率，Mark Word 被设计成为一个非固定的数据结构，以便存储更多有效的数据，它会根据对象本身的状态复用自己的存储空间，如32位JVM下，除了上述列出的Mark Word默认存储结构外，还有如下可能变化的结构：</p>
<p><img src="https://img.huyunshun.com/img/20200503174737.png" alt="20200503174737"></p>
<h3 id="monitor"><a href="#monitor" class="headerlink" title="monitor"></a>monitor</h3><p>Synchronized属于结构中的重量级锁，锁标识位为10，其中指针指向的是monitor对象的起始地址。每个对象都存在着一个 monitor 与之关联，对象与其 monitor 之间的关系有存在多种实现方式，如monitor可以与对象一起创建销毁或当线程试图获取对象锁时自动生成，但当一个 monitor 被某个线程持有后，它便处于锁定状态。在Java虚拟机(HotSpot)中，monitor是由ObjectMonitor实现的，其主要数据结构如下（位于HotSpot虚拟机源码ObjectMonitor.hpp文件，C++实现的）</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ObjectMonitor() &#123;</span><br><span class="line">    _header       = <span class="literal">NULL</span>;</span><br><span class="line">    _count        = <span class="number">0</span>; <span class="comment">//记录个数</span></span><br><span class="line">    _waiters      = <span class="number">0</span>,</span><br><span class="line">            _recursions   = <span class="number">0</span>;</span><br><span class="line">    _object       = <span class="literal">NULL</span>;</span><br><span class="line">    _owner        = <span class="literal">NULL</span>;</span><br><span class="line">    _WaitSet      = <span class="literal">NULL</span>; <span class="comment">//处于wait状态的线程，会被加入到_WaitSet</span></span><br><span class="line">    _WaitSetLock  = <span class="number">0</span> ;</span><br><span class="line">    _Responsible  = <span class="literal">NULL</span> ;</span><br><span class="line">    _succ         = <span class="literal">NULL</span> ;</span><br><span class="line">    _cxq          = <span class="literal">NULL</span> ;</span><br><span class="line">    FreeNext      = <span class="literal">NULL</span> ;</span><br><span class="line">    _EntryList    = <span class="literal">NULL</span> ; <span class="comment">//处于等待锁block状态的线程，会被加入到该列表</span></span><br><span class="line">    _SpinFreq     = <span class="number">0</span> ;</span><br><span class="line">    _SpinClock    = <span class="number">0</span> ;</span><br><span class="line">    OwnerIsThread = <span class="number">0</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>任何一个对象都有一个Monitor与之关联，当且一个Monitor被持有后，它将处于锁定状态。Synchronized在JVM里的实现都是 基于进入和退出Monitor对象来实现方法同步和代码块同步，虽然具体实现细节不一样，但是都可以通过成对的MonitorEnter和MonitorExit指令来实现。 </p>
<pre><code>MonitorEnter指令：插入在同步代码块的开始位置，当代码执行到该指令时，将会尝试获取该对象Monitor的所有权，即尝试获得该对象的锁；
MonitorExit指令：插入在方法结束处和异常处，JVM保证每个MonitorEnter必须有对应的MonitorExit；</code></pre><p>ObjectMonitor中有两个队列，_WaitSet 和 _EntryList，用来保存ObjectWaiter对象列表（ 每个等待锁的线程都会被封装成ObjectWaiter对象 ），_owner指向持有ObjectMonitor对象的线程，当多个线程同时访问一段同步代码时：</p>
<pre><code>首先会进入 _EntryList 集合，当线程获取到对象的monitor后，进入 _Owner区域并把monitor中的owner变量设置为当前线程，同时monitor中的计数器count加1；
若线程调用 wait() 方法，将释放当前持有的monitor，owner变量恢复为null，count自减1，同时该线程进入 WaitSet集合中等待被唤醒；
若当前线程执行完毕，也将释放monitor（锁）并复位count的值，以便其他线程进入获取monitor(锁)；</code></pre><h3 id="对象头中Mark-Word与线程中Lock-Record"><a href="#对象头中Mark-Word与线程中Lock-Record" class="headerlink" title="对象头中Mark Word与线程中Lock Record"></a>对象头中Mark Word与线程中Lock Record</h3><p>在线程进入同步代码块的时候，如果此同步对象没有被锁定，即它的锁标志位是01，则虚拟机首先在当前线程的栈中创建我们称之为“锁记录（Lock Record）”的空间，用于存储锁对象的Mark Word的拷贝，官方把这个拷贝称为Displaced Mark Word。整个Mark Word及其拷贝至关重要。</p>
<p>Lock Record是线程私有的数据结构，每一个线程都有一个可用Lock Record列表，同时还有一个全局的可用列表。每一个被锁住的对象Mark Word都会和一个Lock Record关联（对象头的MarkWord中的Lock Word指向Lock Record的起始地址），同时Lock Record中有一个Owner字段存放拥有该锁的线程的唯一标识（或者object mark word），表示该锁被这个线程占用。如下图所示为Lock Record的内部结构：</p>
<table>
<thead>
<tr>
<th>Lock Record</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Owner</td>
<td>初始时为NULL表示当前没有任何线程拥有该monitor record，当线程成功拥有该锁后保存线程唯一标识，当锁被释放时又设置为NULL；</td>
</tr>
<tr>
<td>EntryQ</td>
<td>关联一个系统互斥锁（semaphore），阻塞所有试图锁住monitor record失败的线程；</td>
</tr>
<tr>
<td>RcThis</td>
<td>表示blocked或waiting在该monitor record上的所有线程的个数；</td>
</tr>
<tr>
<td>Nest</td>
<td>用来实现 重入锁的计数；</td>
</tr>
<tr>
<td>HashCode</td>
<td>保存从对象头拷贝过来的HashCode值（可能还包含GC age）。</td>
</tr>
<tr>
<td>Candidate</td>
<td>用来避免不必要的阻塞或等待线程唤醒，因为每一次只有一个线程能够成功拥有锁，如果每次前一个释放锁的线程唤醒所有正在阻塞或等待的线程，会引起不必要的上下文切换（从阻塞到就绪然后因为竞争锁失败又被阻塞）从而导致性能严重下降。Candidate只有两种可能的值0表示没有需要唤醒的线程1表示要唤醒一个继任线程来竞争锁。</td>
</tr>
</tbody></table>
<p>监视器Monitor有两种同步方式：互斥与协作。多线程环境下线程之间如果需要共享数据，需要解决互斥访问数据的问题，监视器可以确保监视器上的数据在同一时刻只会有一个线程在访问。</p>
<p>什么时候需要协作？ 比如：</p>
<p>一个线程向缓冲区写数据，另一个线程从缓冲区读数据，如果读线程发现缓冲区为空就会等待，当写线程向缓冲区写入数据，就会唤醒读线程，这里读线程和写线程就是一个合作关系。JVM通过Object类的wait方法来使自己等待，在调用wait方法后，该线程会释放它持有的监视器，直到其他线程通知它才有执行的机会。一个线程调用notify方法通知在等待的线程，这个等待的线程并不会马上执行，而是要通知线程释放监视器后，它重新获取监视器才有执行的机会。如果刚好唤醒的这个线程需要的监视器被其他线程抢占，那么这个线程会继续等待。Object类中的notifyAll方法可以解决这个问题，它可以唤醒所有等待的线程，总有一个线程执行。</p>
<p><img src="https://img.huyunshun.com/img/20200503175734.png" alt="20200503175734"></p>
<p>如上图所示，一个线程通过1号门进入Entry Set(入口区)，如果在入口区没有线程等待，那么这个线程就会获取监视器成为监视器的Owner，然后执行监视区域的代码。如果在入口区中有其它线程在等待，那么新来的线程也会和这些线程一起等待。线程在持有监视器的过程中，有两个选择，一个是正常执行监视器区域的代码，释放监视器，通过5号门退出监视器；还有可能等待某个条件的出现，于是它会通过3号门到Wait Set（等待区）休息，直到相应的条件满足后再通过4号门进入重新获取监视器再执行。</p>
<p><strong>当一个线程释放监视器时，在入口区和等待区的等待线程都会去竞争监视器，如果入口区的线程赢了，会从2号门进入；如果等待区的线程赢了会从4号门进入。只有通过3号门才能进入等待区，在等待区中的线程只有通过4号门才能退出等待区，也就是说一个线程只有在持有监视器时才能执行wait操作，处于等待的线程只有再次获得监视器才能退出等待状态。</strong></p>
<h2 id="锁的优化"><a href="#锁的优化" class="headerlink" title="锁的优化"></a>锁的优化</h2><p>从JDK5引入了现代操作系统新增加的CAS原子操作（ JDK5中并没有对synchronized关键字做优化，而是体现在J.U.C中，所以在该版本concurrent包有更好的性能 ），从JDK6开始，就对synchronized的实现机制进行了较大调整，包括使用JDK5引进的CAS自旋之外，还增加了自适应的CAS自旋、锁消除、锁粗化、偏向锁、轻量级锁这些优化策略。</p>
<h3 id="自旋锁"><a href="#自旋锁" class="headerlink" title="自旋锁"></a>自旋锁</h3><p>所谓自旋锁，就是指当一个线程尝试获取某个锁时，如果该锁已被其他线程占用，就一直循环检测锁是否被释放，而不是进入线程挂起或睡眠状态。</p>
<p>自旋等待的时间（自旋的次数）必须要有一个限度，如果自旋超过了定义的时间仍然没有获取到锁，则应该被挂起。在JDK1.6中默认开启。同时自旋的默认次数为10次，可以通过参数-XX:PreBlockSpin来调整。</p>
<p>自旋次数，不一定能设置合理，有时候多线程都是等你刚刚退出的时候就释放了锁。于是JDK1.6引入自适应的自旋锁，让虚拟机会变得越来越聪明。</p>
<h4 id="适应性自旋锁"><a href="#适应性自旋锁" class="headerlink" title="适应性自旋锁"></a>适应性自旋锁</h4><p>所谓自适应就意味着自旋的次数不再是固定的，它是由前一次在同一个锁上的自旋时间及锁的拥有者的状态来决定。</p>
<p>线程如果自旋成功了，那么下次自旋的次数会更加多，因为虚拟机认为既然上次成功了，那么此次自旋也很有可能会再次成功，那么它就会允许自旋等待持续的次数更多。反之，如果对于某个锁，很少有自旋能够成功，那么在以后要或者这个锁的时候自旋的次数会减少甚至省略掉自旋过程，以免浪费处理器资源。</p>
<p>锁消除：为了保证数据的完整性，在进行操作时需要对这部分操作进行同步控制，但是在有些情况下，JVM检测到不可能存在共享数据竞争，这是JVM会对这些同步锁进行锁消除。<br>锁粗化：在使用同步锁的时候，需要让同步块的作用范围尽可能小—仅在共享数据的实际作用域中才进行同步，这样做的目的是 为了使需要同步的操作数量尽可能缩小，如果存在锁竞争，那么等待锁的线程也能尽快拿到锁。</p>
<h3 id="偏向锁"><a href="#偏向锁" class="headerlink" title="偏向锁"></a>偏向锁</h3><p>偏向锁是JDK6中的重要引进，因为HotSpot作者经过研究实践发现，在大多数情况下，锁不仅不存在多线程竞争，而且总是由同一线程多次获得，为了让线程获得锁的代价更低，引进了偏向锁。<br>轻量级锁是为了在线程交替执行同步块时提高性能，而偏向锁则是在只有一个线程执行同步块时进一步提高性能。</p>
<p>现在几乎所有的锁都是可重入的，即已经获得锁的线程可以多次锁住/解锁监视对象，按照之前的HotSpot设计，每次加锁/解锁都会涉及到一些CAS操作（比如对等待队列的CAS操作），CAS操作会延迟本地调用，因此偏向锁的想法是 一旦线程第一次获得了监视对象，之后让监视对象“偏向”这个线程，之后的多次调用则可以避免CAS操作，说白了就是置个变量，如果发现为true则无需再走各种加锁/解锁流程。</p>
<h3 id="轻量级锁"><a href="#轻量级锁" class="headerlink" title="轻量级锁"></a>轻量级锁</h3><p>引入轻量级锁的主要目的是 在没有多线程竞争的前提下，减少传统的重量级锁使用操作系统互斥量产生的性能消耗。当关闭偏向锁功能或者多个线程竞争偏向锁导致偏向锁升级为轻量级锁，则会尝试获取轻量级锁。</p>
<h3 id="重量级锁"><a href="#重量级锁" class="headerlink" title="重量级锁"></a>重量级锁</h3><p>Synchronized是通过对象内部的一个叫做 监视器锁（Monitor）来实现的。但是监视器锁本质又是依赖于底层的操作系统的Mutex Lock来实现的。而操作系统实现线程之间的切换这就需要从用户态转换到核心态，这个成本非常高，状态之间的转换需要相对比较长的时间，这就是为什么Synchronized效率低的原因。因此，这种依赖于操作系统Mutex Lock所实现的锁我们称之为 “重量级锁”。</p>
<h3 id="重量级锁、轻量级锁和偏向锁之间转换"><a href="#重量级锁、轻量级锁和偏向锁之间转换" class="headerlink" title="重量级锁、轻量级锁和偏向锁之间转换"></a>重量级锁、轻量级锁和偏向锁之间转换</h3><p><img src="https://img.huyunshun.com/img/20200503182042.png" alt="20200503182042"></p>
<p>每种锁是只能升级，不能降级，即由偏向锁-&gt;轻量级锁-&gt;重量级锁，而这个过程就是开销逐渐加大的过程。</p>
<pre><code>如果是单线程使用，那偏向锁毫无疑问代价最小，并且它就能解决问题，连CAS都不用做，仅仅在内存中比较下对象头就可以了；
如果出现了其他线程竞争，则偏向锁就会升级为轻量级锁；
如果其他线程通过一定次数的CAS尝试没有成功，则进入重量级锁；</code></pre><p><img src="https://img.huyunshun.com/img/20200503182223.png" alt="20200503182223"></p>
<p><a href="https://www.cnblogs.com/aspirant/p/11470858.html" target="_blank" rel="noopener">https://www.cnblogs.com/aspirant/p/11470858.html</a></p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/05/03/%E6%9F%A5%E7%9C%8Bdocker%E5%AE%B9%E5%99%A8%E6%97%A5%E5%BF%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/03/%E6%9F%A5%E7%9C%8Bdocker%E5%AE%B9%E5%99%A8%E6%97%A5%E5%BF%97/" itemprop="url">查看docker容器日志</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-03T00:00:00+08:00">
                2019-05-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>命令格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ docker logs [OPTIONS] CONTAINER</span><br><span class="line">  Options:</span><br><span class="line">        --details        显示更多的信息</span><br><span class="line">    -f, --follow         跟踪实时日志</span><br><span class="line">        --since string   显示自某个timestamp之后的日志，或相对时间，如42m（即42分钟）</span><br><span class="line">        --tail string    从日志末尾显示多少行日志， 默认是all</span><br><span class="line">    -t, --timestamps     显示时间戳</span><br><span class="line">        --until string   显示自某个timestamp之前的日志，或相对时间，如42m（即42分钟）</span><br></pre></td></tr></table></figure>

<p>查看指定时间后的日志，只显示最后100行：</p>
<p>$ docker logs -f -t –since=”2019-08-08” –tail=100 CONTAINER_ID</p>
<p>查看最近20分钟的日志:</p>
<p>$ docker logs –since 20m CONTAINER_ID</p>
<p>查看某时间之后的日志：</p>
<p>$ docker logs -t –since=”2019-08-08T13:23:37” CONTAINER_ID</p>
<p>查看某时间段日志：</p>
<p>$ docker logs -t –since=”2019-08-08T13:23:37” –until “2019-08-09T12:23:37” CONTAINER_ID</p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/05/01/CentOS_Docker_%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/01/CentOS_Docker_%E5%AE%89%E8%A3%85/" itemprop="url">CentOS Docker 安装</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-01T00:00:00+08:00">
                2019-05-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">1、卸载旧版本</span><br><span class="line">命令：yum remove -y docker docker-common docker-selinux dockerengine</span><br><span class="line">2、设置仓库 REPOSITORY</span><br><span class="line">命令：yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">设置 docker 稳定的源</span><br><span class="line">命令：yum-config-manager --add-repo \https:&#x2F;&#x2F;download.docker.com&#x2F;linux&#x2F;centos&#x2F;docker-ce.repo</span><br><span class="line">更新 yum 的安装索引</span><br><span class="line">命令：yum makecache fast</span><br><span class="line">3、安装 docker 版本</span><br><span class="line">yum install -y docker-ce</span><br><span class="line">4、启动 docker 服务</span><br><span class="line">systemctl start docker.service</span><br><span class="line">docker 服务开机自启动</span><br><span class="line">systemctl enable docker.service</span><br><span class="line">5、测试</span><br><span class="line">[root@localhost redata]# docker run hello-world</span><br><span class="line">Unable to find image &#39;hello-world:latest&#39; locally</span><br><span class="line">latest: Pulling from library&#x2F;hello-world</span><br><span class="line">1b930d010525: Pull complete</span><br><span class="line">Digest: sha256:2557e3c07ed1e38f26e389462d03ed943586f744621577a99efb77324b0fe535</span><br><span class="line">Status: Downloaded newer image for hello-world:latest</span><br><span class="line"></span><br><span class="line">Hello from Docker!</span><br><span class="line">This message shows that your installation appears to be working correctly.</span><br><span class="line"></span><br><span class="line">由于本地没有hello-world这个镜像，所以会下载一个hello-world的镜像，并在容器内运行。</span><br><span class="line"></span><br><span class="line">常用Docker命令</span><br><span class="line">镜像管理：</span><br><span class="line">docker images：列出本地所有镜像</span><br><span class="line">docker search &lt;IMAGE_ID&#x2F;NAME&gt;：查找image</span><br><span class="line">docker pull &lt;IMAGE_ID&gt;：下载image</span><br><span class="line">docker push &lt;IMAGE_ID&gt;：上传image</span><br><span class="line">docker rmi &lt;IMAGE_ID&gt;：删除image</span><br><span class="line">容器管理：</span><br><span class="line">docker run -i -t &lt;IMAGE_ID&gt; &#x2F;bin&#x2F;bash：-i：标准输入给容器    -t：分配一个虚拟终端    &#x2F;bin&#x2F;bash：执行bash脚本</span><br><span class="line">-d：以守护进程方式运行（后台）</span><br><span class="line">-P：默认匹配docker容器的5000端口号到宿主机的49153 to 65535端口</span><br><span class="line">-p &lt;HOT_PORT&gt;:&lt;CONTAINER_PORT&gt;：指定端口号</span><br><span class="line">- -name： 指定容器的名称</span><br><span class="line">- -rm：退出时删除容器</span><br><span class="line">docker stop：停止container</span><br><span class="line">docker start：重新启动container</span><br><span class="line">docker ps - Lists containers.</span><br><span class="line">-l：显示最后启动的容器</span><br><span class="line">-a：同时显示停止的容器，默认只显示启动状态</span><br><span class="line">docker attach &lt;CONTAINER_ID&gt; 连接到启动的容器</span><br><span class="line">docker logs &lt;CONTAINER_ID&gt; 输出容器日志</span><br><span class="line">       -f：实时输出</span><br><span class="line">docker cp &lt;CONTAINER_ID&gt;:path hostpath：复制容器内的文件到宿主机目录上</span><br><span class="line">docker rm：删除container</span><br><span class="line">docker rm &#96;docker ps -a -q&#96;：删除所有容器</span><br><span class="line">docker kill &#96;docker ps -q&#96;</span><br><span class="line">docker rmi &#96;docker images -q -a&#96;</span><br><span class="line">docker wait &lt;CONTAINER_ID&gt;：阻塞对容器的其他调用方法，直到容器停止后退出</span><br><span class="line">docker top &lt;CONTAINER_ID&gt;：查看容器中运行的进程</span><br><span class="line">docker diff：查看容器中的变化</span><br><span class="line">docker inspect：查看容器详细信息（输出为Json）</span><br><span class="line">       -f：查找特定信息，如docker inspect&#123; .NetworkSettings.IPAddress &#125;&#39;</span><br><span class="line">docker commit -m &quot;comment&quot; -a &quot;author&quot; &lt;CONTAINER_ID&gt;</span><br><span class="line">docker extc -it &lt;CONTAINER&gt; &lt;COMMAND&gt;：在容器里执行命令，并输出结果</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/04/24/mybatis%E6%9E%B6%E6%9E%84%E5%92%8C%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E9%87%8A/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/24/mybatis%E6%9E%B6%E6%9E%84%E5%92%8C%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E9%87%8A/" itemprop="url">mybatis架构和源码分析释</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-24T22:49:08+08:00">
                2019-04-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mybatis/" itemprop="url" rel="index">
                    <span itemprop="name">mybatis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="mybatis架构"><a href="#mybatis架构" class="headerlink" title="mybatis架构"></a>mybatis架构</h2><p><img src="https://img.huyunshun.com/img/20200506220853.png" alt="20200506220853"></p>
<p>三层：</p>
<p>(1)API接口层：提供给外部使用的接口API，开发人员通过这些本地API来操纵数据库。接口层一接收到调用请求就会调用数据处理层来完成具体的数据处理。</p>
<p>(2)数据处理层：负责具体的SQL查找、SQL解析、SQL执行和执行结果映射处理等。它主要的目的是根据调用的请求完成一次数据库操作。</p>
<p>(3)基础支撑层：负责最基础的功能支撑，包括连接管理、事务管理、配置加载和缓存处理，这些都是共用的东西，将他们抽取出来作为最基础的组件。为上层的数据处理层提供最基础的支撑。</p>
<h3 id="主要的构建及其关系"><a href="#主要的构建及其关系" class="headerlink" title="主要的构建及其关系"></a>主要的构建及其关系</h3><p><img src="https://img.huyunshun.com/img/20200506221308.png" alt="20200506221308"></p>
<h3 id="层次结构"><a href="#层次结构" class="headerlink" title="层次结构"></a>层次结构</h3><p><img src="https://img.huyunshun.com/img/20200506221448.png" alt="20200506221448"></p>
<pre><code>SqlSession 作为MyBatis工作的主要顶层API，表示和数据库交互的会话，完成必要数据库增删改查功能
Executor MyBatis执行器，是MyBatis 调度的核心，负责SQL语句的生成和查询缓存的维护
StatementHandler 封装了JDBC Statement操作，负责对JDBCstatement的操作，如设置参数、将Statement结果集转换成List集合。
ParameterHandler 负责对用户传递的参数转换成JDBC Statement 所需要的参数
ResultSetHandler *负责将JDBC返回的ResultSet结果集对象转换成List类型的集合；
TypeHandler 负责java数据类型和jdbc数据类型之间的映射和转换
MappedStatement MappedStatement维护了一条&lt;select|update|delete|insert&gt;节点的封
SqlSource 负责根据用户传递的parameterObject，动态地生成SQL语句，将信息封装到BoundSql对象中，并返回
BoundSql 表示动态生成的SQL语句以及相应的参数信息
Configuration MyBatis所有的配置信息都维持在Configuration对象之中</code></pre><h3 id="处理流程"><a href="#处理流程" class="headerlink" title="处理流程"></a>处理流程</h3><p>MyBatis的初始化，会从mybatis-config.xml配置文件，解析构造成Configuration这个类。</p>
<p>(1)加载配置：配置来源于两个地方，一处是配置文件，一处是Java代码的注解，将SQL的配置信息加载成为一个个MappedStatement对象（包括了传入参数映射配置、执行的SQL语句、结果映射配置），存储在内存中。</p>
<p>(2)SQL解析：当API接口层接收到调用请求时，会接收到传入SQL的ID和传入对象（可以是Map、JavaBean或者基本数据类型），Mybatis会根据SQL的ID找到对应的MappedStatement，然后根据传入参数对象对MappedStatement进行解析，解析后可以得到最终要执行的SQL语句和参数。</p>
<p>(3)SQL执行：将最终得到的SQL和参数拿到数据库进行执行，得到操作数据库的结果。</p>
<p>(4)结果映射：将操作数据库的结果按照映射的配置进行转换，可以转换成HashMap、JavaBean或者基本数据类型，并将最终结果返回。</p>
<h3 id="核心类"><a href="#核心类" class="headerlink" title="核心类"></a>核心类</h3><h4 id="1、SqlSessionFactoryBuilder"><a href="#1、SqlSessionFactoryBuilder" class="headerlink" title="1、SqlSessionFactoryBuilder"></a>1、SqlSessionFactoryBuilder</h4><p>每一个MyBatis的应用程序的入口是SqlSessionFactoryBuilder。</p>
<p>它的作用是通过XML配置文件创建Configuration对象，然后通过build方法创建SqlSessionFactory对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> SqlSessionFactoryBuilder sqlSessionFactoryBuilder;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> SqlSessionFactory sqlSessionFactory;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String resource = <span class="string">"mybatis-config.xml"</span>;</span><br><span class="line">    Reader reader = Resources.getResourceAsReader(resource);</span><br><span class="line">    sqlSessionFactoryBuilder = <span class="keyword">new</span> SqlSessionFactoryBuilder();</span><br><span class="line">    sqlSessionFactory = sqlSessionFactoryBuilder.build(reader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>org.apache.ibatis.session.Configuration 是mybatis初始化的核心。</p>
<p>mybatis-config.xml中的配置，最后会解析xml成Configuration这个类。</p>
<p>SqlSessionFactoryBuilder根据传入的数据流(XML)生成Configuration对象，然后根据Configuration对象创建默认的SqlSessionFactory实例。</p>
<h4 id="2、SqlSessionFactory对象由SqlSessionFactoryBuilder创建："><a href="#2、SqlSessionFactory对象由SqlSessionFactoryBuilder创建：" class="headerlink" title="2、SqlSessionFactory对象由SqlSessionFactoryBuilder创建："></a>2、SqlSessionFactory对象由SqlSessionFactoryBuilder创建：</h4><p>它的主要功能是创建SqlSession对象，和SqlSessionFactoryBuilder对象一样，全局的对象。SqlSessionFactory对象一个必要的属性是Configuration对象，它是保存Mybatis全局配置的一个配置对象，通常由SqlSessionFactoryBuilder从XML配置文件创建。</p>
<h4 id="3、SqlSession"><a href="#3、SqlSession" class="headerlink" title="3、SqlSession"></a>3、SqlSession</h4><p>SqlSession对象的主要功能是完成一次数据库的访问和结果的映射，它类似于数据库的session概念，由于不是线程安全的，所以SqlSession对象的作用域需限制方法内。SqlSession的默认实现类是DefaultSqlSession，它有两个必须配置的属性：Configuration和Executor。SqlSession对数据库的操作都是通过Executor来完成的。</p>
<p>SqlSession ：默认创建DefaultSqlSession 并且开启一级缓存，创建执行器 、赋值。</p>
<p>SqlSession有一个重要的方法getMapper，顾名思义，这个方式是用来获取Mapper对象的。什么是Mapper对象？根据Mybatis的官方手册，应用程序除了要初始并启动Mybatis之外，还需要定义一些接口，接口里定义访问数据库的方法，存放接口的包路径下需要放置同名的XML配置文件。</p>
<p>应用程序访问getMapper时，Mybatis会根据传入的接口类型和对应的XML配置文件生成一个代理对象，应用程序获得Mapper对象后，就应该通过这个Mapper对象来访问Mybatis的SqlSession对象。</p>
<h4 id="4、Executor"><a href="#4、Executor" class="headerlink" title="4、Executor"></a>4、Executor</h4><p>Executor对象在创建Configuration对象的时候创建，并且缓存在Configuration对象里。Executor对象的主要功能是调用StatementHandler访问数据库，并将查询结果存入缓存中（如果配置了缓存的话）。</p>
<h4 id="5、StatementHandler"><a href="#5、StatementHandler" class="headerlink" title="5、StatementHandler"></a>5、StatementHandler</h4><p>StatementHandler是真正访问数据库的地方，并调用ResultSetHandler处理查询结果。</p>
<h4 id="6、ResultSetHandler"><a href="#6、ResultSetHandler" class="headerlink" title="6、ResultSetHandler"></a>6、ResultSetHandler</h4><p>处理查询结果。</p>
<h2 id="源码分析释"><a href="#源码分析释" class="headerlink" title="源码分析释"></a>源码分析释</h2><h3 id="初始化配置信息"><a href="#初始化配置信息" class="headerlink" title="初始化配置信息"></a>初始化配置信息</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> SqlSessionFactoryBuilder sqlSessionFactoryBuilder;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> SqlSessionFactory sqlSessionFactory;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String resource = <span class="string">"mybatis-config.xml"</span>;</span><br><span class="line">    Reader reader = Resources.getResourceAsReader(resource);</span><br><span class="line">    sqlSessionFactoryBuilder = <span class="keyword">new</span> SqlSessionFactoryBuilder();</span><br><span class="line">    sqlSessionFactory = sqlSessionFactoryBuilder.build(reader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">build</span><span class="params">(InputStream inputStream, String environment, Properties properties)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//解析配置文件的对象</span></span><br><span class="line">        XMLConfigBuilder parser = <span class="keyword">new</span> XMLConfigBuilder(inputStream, environment, properties);</span><br><span class="line">        <span class="keyword">return</span> build(parser.parse());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">"Error building SqlSession."</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ErrorContext.instance().reset();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        inputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">// Intentionally ignore. Prefer previous error.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="解析器"><a href="#解析器" class="headerlink" title="解析器"></a>解析器</h4><p>例如配置dataSource的时候使用了 ${driver} 这种表达式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertyParser</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">parse</span><span class="params">(String string, Properties variables)</span> </span>&#123;</span><br><span class="line">    VariableTokenHandler handler = <span class="keyword">new</span> VariableTokenHandler(variables);</span><br><span class="line">    GenericTokenParser parser = <span class="keyword">new</span> GenericTokenParser(<span class="string">"$&#123;"</span>, <span class="string">"&#125;"</span>, handler);</span><br><span class="line">    <span class="keyword">return</span> parser.parse(string);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">VariableTokenHandler</span> <span class="keyword">implements</span> <span class="title">TokenHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Properties variables;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">VariableTokenHandler</span><span class="params">(Properties variables)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.variables = variables;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">handleToken</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (variables != <span class="keyword">null</span> &amp;&amp; variables.containsKey(content)) &#123;</span><br><span class="line">        <span class="keyword">return</span> variables.getProperty(content);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"$&#123;"</span> + content + <span class="string">"&#125;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="解析别名"><a href="#解析别名" class="headerlink" title="解析别名"></a>解析别名</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析typeAliases节点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">typeAliasesElement</span><span class="params">(XNode parent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (XNode child : parent.getChildren()) &#123;</span><br><span class="line">        <span class="comment">//如果子节点是package, 那么就获取package节点的name属性， mybatis会扫描指定的package</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"package"</span>.equals(child.getName())) &#123;</span><br><span class="line">          String typeAliasPackage = child.getStringAttribute(<span class="string">"name"</span>);</span><br><span class="line">          <span class="comment">//TypeAliasRegistry 负责管理别名， 这儿就是通过TypeAliasRegistry 进行别名注册， 下面就会看看TypeAliasRegistry源码</span></span><br><span class="line">          configuration.getTypeAliasRegistry().registerAliases(typeAliasPackage);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">//如果子节点是typeAlias节点，那么就获取alias属性和type的属性值</span></span><br><span class="line">          String alias = child.getStringAttribute(<span class="string">"alias"</span>);</span><br><span class="line">          String type = child.getStringAttribute(<span class="string">"type"</span>);</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = Resources.classForName(type);</span><br><span class="line">            <span class="keyword">if</span> (alias == <span class="keyword">null</span>) &#123;</span><br><span class="line">              typeAliasRegistry.registerAlias(clazz);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              typeAliasRegistry.registerAlias(alias, clazz);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"Error registering typeAlias for '"</span> + alias + <span class="string">"'. Cause: "</span> + e, e);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TypeAliasRegistry</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 别名就仅仅通过一个HashMap来实现， key为别名， value就是别名对应的类型（class对象）</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Class&lt;?&gt;&gt; TYPE_ALIASES = <span class="keyword">new</span> HashMap&lt;String, Class&lt;?&gt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 以下就是mybatis默认为我们注册的别名</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">TypeAliasRegistry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    registerAlias(<span class="string">"string"</span>, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    registerAlias(<span class="string">"byte"</span>, Byte<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"long"</span>, Long<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"short"</span>, Short<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"int"</span>, Integer<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"integer"</span>, Integer<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"double"</span>, Double<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"float"</span>, Float<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"boolean"</span>, Boolean<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    registerAlias(<span class="string">"byte[]"</span>, Byte[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"long[]"</span>, Long[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"short[]"</span>, Short[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"int[]"</span>, Integer[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"integer[]"</span>, Integer[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"double[]"</span>, Double[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"float[]"</span>, Float[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"boolean[]"</span>, Boolean[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    registerAlias(<span class="string">"_byte"</span>, <span class="keyword">byte</span><span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"_long"</span>, <span class="keyword">long</span><span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"_short"</span>, <span class="keyword">short</span><span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"_int"</span>, <span class="keyword">int</span><span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"_integer"</span>, <span class="keyword">int</span><span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"_double"</span>, <span class="keyword">double</span><span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"_float"</span>, <span class="keyword">float</span><span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"_boolean"</span>, <span class="keyword">boolean</span><span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    registerAlias(<span class="string">"_byte[]"</span>, <span class="keyword">byte</span>[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"_long[]"</span>, <span class="keyword">long</span>[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"_short[]"</span>, <span class="keyword">short</span>[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"_int[]"</span>, <span class="keyword">int</span>[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"_integer[]"</span>, <span class="keyword">int</span>[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"_double[]"</span>, <span class="keyword">double</span>[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"_float[]"</span>, <span class="keyword">float</span>[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"_boolean[]"</span>, <span class="keyword">boolean</span>[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    registerAlias(<span class="string">"date"</span>, Date<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"decimal"</span>, BigDecimal<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"bigdecimal"</span>, BigDecimal<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"biginteger"</span>, BigInteger<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"object"</span>, Object<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    registerAlias(<span class="string">"date[]"</span>, Date[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"decimal[]"</span>, BigDecimal[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"bigdecimal[]"</span>, BigDecimal[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"biginteger[]"</span>, BigInteger[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"object[]"</span>, Object[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    registerAlias(<span class="string">"map"</span>, Map<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"hashmap"</span>, HashMap<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"list"</span>, List<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"arraylist"</span>, ArrayList<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"collection"</span>, Collection<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    registerAlias(<span class="string">"iterator"</span>, Iterator<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    registerAlias(<span class="string">"ResultSet"</span>, ResultSet<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 处理别名， 直接从保存有别名的hashMap中取出即可</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function">Class&lt;T&gt; <span class="title">resolveAlias</span><span class="params">(String string)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (string == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      String key = string.toLowerCase(Locale.ENGLISH); <span class="comment">// issue #748</span></span><br><span class="line">      Class&lt;T&gt; value;</span><br><span class="line">      <span class="keyword">if</span> (TYPE_ALIASES.containsKey(key)) &#123;</span><br><span class="line">        value = (Class&lt;T&gt;) TYPE_ALIASES.get(key);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        value = (Class&lt;T&gt;) Resources.classForName(string);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">"Could not resolve type alias '"</span> + string + <span class="string">"'.  Cause: "</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 配置文件中配置为package的时候， 会调用此方法，根据配置的报名去扫描javabean ，然后自动注册别名</span></span><br><span class="line"><span class="comment">   * 默认会使用 Bean 的首字母小写的非限定类名来作为它的别名</span></span><br><span class="line"><span class="comment">   * 也可在javabean 加上注解<span class="doctag">@Alias</span> 来自定义别名， 例如： <span class="doctag">@Alias</span>(user)</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerAliases</span><span class="params">(String packageName)</span></span>&#123;</span><br><span class="line">    registerAliases(packageName, Object<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerAliases</span><span class="params">(String packageName, Class&lt;?&gt; superType)</span></span>&#123;</span><br><span class="line">    ResolverUtil&lt;Class&lt;?&gt;&gt; resolverUtil = <span class="keyword">new</span> ResolverUtil&lt;Class&lt;?&gt;&gt;();</span><br><span class="line">    resolverUtil.find(<span class="keyword">new</span> ResolverUtil.IsA(superType), packageName);</span><br><span class="line">    Set&lt;Class&lt;? extends Class&lt;?&gt;&gt;&gt; typeSet = resolverUtil.getClasses();</span><br><span class="line">    <span class="keyword">for</span>(Class&lt;?&gt; type : typeSet)&#123;</span><br><span class="line">      <span class="comment">// Ignore inner classes and interfaces (including package-info.java)</span></span><br><span class="line">      <span class="comment">// Skip also inner classes. See issue #6</span></span><br><span class="line">      <span class="keyword">if</span> (!type.isAnonymousClass() &amp;&amp; !type.isInterface() &amp;&amp; !type.isMemberClass()) &#123;</span><br><span class="line">        registerAlias(type);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerAlias</span><span class="params">(Class&lt;?&gt; type)</span> </span>&#123;</span><br><span class="line">    String alias = type.getSimpleName();</span><br><span class="line">    Alias aliasAnnotation = type.getAnnotation(Alias<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">if</span> (aliasAnnotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">      alias = aliasAnnotation.value();</span><br><span class="line">    &#125; </span><br><span class="line">    registerAlias(alias, type);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//这就是注册别名的本质方法， 其实就是向保存别名的hashMap新增值而已， 呵呵， 别名的实现太简单了，对吧</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerAlias</span><span class="params">(String alias, Class&lt;?&gt; value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (alias == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">"The parameter alias cannot be null"</span>);</span><br><span class="line">    String key = alias.toLowerCase(Locale.ENGLISH); <span class="comment">// issue #748</span></span><br><span class="line">    <span class="keyword">if</span> (TYPE_ALIASES.containsKey(key) &amp;&amp; TYPE_ALIASES.get(key) != <span class="keyword">null</span> &amp;&amp; !TYPE_ALIASES.get(key).equals(value)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">"The alias '"</span> + alias + <span class="string">"' is already mapped to the value '"</span> + TYPE_ALIASES.get(key).getName() + <span class="string">"'."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    TYPE_ALIASES.put(key, value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerAlias</span><span class="params">(String alias, String value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      registerAlias(alias, Resources.classForName(value));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">"Error registering type alias "</span>+alias+<span class="string">" for "</span>+value+<span class="string">". Cause: "</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取保存别名的HashMap, Configuration对象持有对TypeAliasRegistry的引用，因此，如果需要，我们可以通过Configuration对象获取</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> Map&lt;String, Class&lt;?&gt;&gt; getTypeAliases() &#123;</span><br><span class="line">    <span class="keyword">return</span> Collections.unmodifiableMap(TYPE_ALIASES);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="TypeHandler配置"><a href="#TypeHandler配置" class="headerlink" title="TypeHandler配置"></a>TypeHandler配置</h3><p>无论是 MyBatis 在预处理语句（PreparedStatement）中设置一个参数时，还是从结果集中取出一个值时，都会用类型处理器将获取的值以合适的方式转换成 Java 类型。Mybatis默认为我们实现了许多TypeHandler, 当我们没有配置指定TypeHandler时，Mybatis会根据参数或者返回结果的不同，默认为我们选择合适的TypeHandler处理。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeHandlers</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- handler属性直接配置我们要指定的TypeHandler --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">handler</span>=<span class="string">""</span>/&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- javaType 配置java类型，例如String, 如果配上javaType, 那么指定的typeHandler就只作用于指定的类型 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">javaType</span>=<span class="string">""</span> <span class="attr">handler</span>=<span class="string">""</span>/&gt;</span>      </span><br><span class="line">      <span class="comment">&lt;!-- jdbcType 配置数据库基本数据类型，例如varchar, 如果配上jdbcType, 那么指定的typeHandler就只作用于指定的类型  --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">jdbcType</span>=<span class="string">""</span> <span class="attr">handler</span>=<span class="string">""</span>/&gt;</span>      </span><br><span class="line">      <span class="comment">&lt;!-- 也可两者都配置 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">javaType</span>=<span class="string">""</span> <span class="attr">jdbcType</span>=<span class="string">""</span> <span class="attr">handler</span>=<span class="string">""</span>/&gt;</span>      </span><br><span class="line">  <span class="tag">&lt;/<span class="name">typeHandlers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>首先解析，再TypeHandler的管理注册</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * typeHandler注册管理类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TypeHandlerRegistry</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//源码一上来，二话不说，几个大大的HashMap就出现，这不又跟上次讲的typeAliases的注册类似么</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//基本数据类型与其包装类</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Class&lt;?&gt;&gt; reversePrimitiveMap = <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, Class&lt;?&gt;&gt;() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    &#123;</span><br><span class="line">      put(Byte<span class="class">.<span class="keyword">class</span>, <span class="title">byte</span>.<span class="title">class</span>)</span>;</span><br><span class="line">      put(Short<span class="class">.<span class="keyword">class</span>, <span class="title">short</span>.<span class="title">class</span>)</span>;</span><br><span class="line">      put(Integer<span class="class">.<span class="keyword">class</span>, <span class="title">int</span>.<span class="title">class</span>)</span>;</span><br><span class="line">      put(Long<span class="class">.<span class="keyword">class</span>, <span class="title">long</span>.<span class="title">class</span>)</span>;</span><br><span class="line">      put(Float<span class="class">.<span class="keyword">class</span>, <span class="title">float</span>.<span class="title">class</span>)</span>;</span><br><span class="line">      put(Double<span class="class">.<span class="keyword">class</span>, <span class="title">double</span>.<span class="title">class</span>)</span>;</span><br><span class="line">      put(Boolean<span class="class">.<span class="keyword">class</span>, <span class="title">boolean</span>.<span class="title">class</span>)</span>;</span><br><span class="line">      put(Character<span class="class">.<span class="keyword">class</span>, <span class="title">char</span>.<span class="title">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//这几个MAP不用说就知道存的是什么东西吧，命名的好处</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt; JDBC_TYPE_HANDLER_MAP = <span class="keyword">new</span> EnumMap&lt;JdbcType, TypeHandler&lt;?&gt;&gt;(JdbcType<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Type, Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt;&gt; TYPE_HANDLER_MAP = <span class="keyword">new</span> HashMap&lt;Type, Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt;&gt;();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> TypeHandler&lt;Object&gt; UNKNOWN_TYPE_HANDLER = <span class="keyword">new</span> UnknownTypeHandler(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, TypeHandler&lt;?&gt;&gt; ALL_TYPE_HANDLERS_MAP = <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, TypeHandler&lt;?&gt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//就像上篇文章讲的typeAliases一样，mybatis也默认给我们注册了不少的typeHandler</span></span><br><span class="line">  <span class="comment">//具体如下</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">TypeHandlerRegistry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    register(Boolean<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">BooleanTypeHandler</span>())</span>;</span><br><span class="line">    register(<span class="keyword">boolean</span><span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">BooleanTypeHandler</span>())</span>;</span><br><span class="line">    register(JdbcType.BOOLEAN, <span class="keyword">new</span> BooleanTypeHandler());</span><br><span class="line">    register(JdbcType.BIT, <span class="keyword">new</span> BooleanTypeHandler());</span><br><span class="line"></span><br><span class="line">    register(Byte<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">ByteTypeHandler</span>())</span>;</span><br><span class="line">    register(<span class="keyword">byte</span><span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">ByteTypeHandler</span>())</span>;</span><br><span class="line">    register(JdbcType.TINYINT, <span class="keyword">new</span> ByteTypeHandler());</span><br><span class="line"></span><br><span class="line">    register(Short<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">ShortTypeHandler</span>())</span>;</span><br><span class="line">    register(<span class="keyword">short</span><span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">ShortTypeHandler</span>())</span>;</span><br><span class="line">    register(JdbcType.SMALLINT, <span class="keyword">new</span> ShortTypeHandler());</span><br><span class="line"></span><br><span class="line">    register(Integer<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">IntegerTypeHandler</span>())</span>;</span><br><span class="line">    register(<span class="keyword">int</span><span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">IntegerTypeHandler</span>())</span>;</span><br><span class="line">    register(JdbcType.INTEGER, <span class="keyword">new</span> IntegerTypeHandler());</span><br><span class="line"></span><br><span class="line">    register(Long<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">LongTypeHandler</span>())</span>;</span><br><span class="line">    register(<span class="keyword">long</span><span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">LongTypeHandler</span>())</span>;</span><br><span class="line"></span><br><span class="line">    register(Float<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">FloatTypeHandler</span>())</span>;</span><br><span class="line">    register(<span class="keyword">float</span><span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">FloatTypeHandler</span>())</span>;</span><br><span class="line">    register(JdbcType.FLOAT, <span class="keyword">new</span> FloatTypeHandler());</span><br><span class="line"></span><br><span class="line">    register(Double<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">DoubleTypeHandler</span>())</span>;</span><br><span class="line">    register(<span class="keyword">double</span><span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">DoubleTypeHandler</span>())</span>;</span><br><span class="line">    register(JdbcType.DOUBLE, <span class="keyword">new</span> DoubleTypeHandler());</span><br><span class="line"></span><br><span class="line">    register(String<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">StringTypeHandler</span>())</span>;</span><br><span class="line">    register(String<span class="class">.<span class="keyword">class</span>, <span class="title">JdbcType</span>.<span class="title">CHAR</span>, <span class="title">new</span> <span class="title">StringTypeHandler</span>())</span>;</span><br><span class="line">    register(String<span class="class">.<span class="keyword">class</span>, <span class="title">JdbcType</span>.<span class="title">CLOB</span>, <span class="title">new</span> <span class="title">ClobTypeHandler</span>())</span>;</span><br><span class="line">    register(String<span class="class">.<span class="keyword">class</span>, <span class="title">JdbcType</span>.<span class="title">VARCHAR</span>, <span class="title">new</span> <span class="title">StringTypeHandler</span>())</span>;</span><br><span class="line">    register(String<span class="class">.<span class="keyword">class</span>, <span class="title">JdbcType</span>.<span class="title">LONGVARCHAR</span>, <span class="title">new</span> <span class="title">ClobTypeHandler</span>())</span>;</span><br><span class="line">    register(String<span class="class">.<span class="keyword">class</span>, <span class="title">JdbcType</span>.<span class="title">NVARCHAR</span>, <span class="title">new</span> <span class="title">NStringTypeHandler</span>())</span>;</span><br><span class="line">    register(String<span class="class">.<span class="keyword">class</span>, <span class="title">JdbcType</span>.<span class="title">NCHAR</span>, <span class="title">new</span> <span class="title">NStringTypeHandler</span>())</span>;</span><br><span class="line">    register(String<span class="class">.<span class="keyword">class</span>, <span class="title">JdbcType</span>.<span class="title">NCLOB</span>, <span class="title">new</span> <span class="title">NClobTypeHandler</span>())</span>;</span><br><span class="line">    register(JdbcType.CHAR, <span class="keyword">new</span> StringTypeHandler());</span><br><span class="line">    register(JdbcType.VARCHAR, <span class="keyword">new</span> StringTypeHandler());</span><br><span class="line">    register(JdbcType.CLOB, <span class="keyword">new</span> ClobTypeHandler());</span><br><span class="line">    register(JdbcType.LONGVARCHAR, <span class="keyword">new</span> ClobTypeHandler());</span><br><span class="line">    register(JdbcType.NVARCHAR, <span class="keyword">new</span> NStringTypeHandler());</span><br><span class="line">    register(JdbcType.NCHAR, <span class="keyword">new</span> NStringTypeHandler());</span><br><span class="line">    register(JdbcType.NCLOB, <span class="keyword">new</span> NClobTypeHandler());</span><br><span class="line"></span><br><span class="line">    register(Object<span class="class">.<span class="keyword">class</span>, <span class="title">JdbcType</span>.<span class="title">ARRAY</span>, <span class="title">new</span> <span class="title">ArrayTypeHandler</span>())</span>;</span><br><span class="line">    register(JdbcType.ARRAY, <span class="keyword">new</span> ArrayTypeHandler());</span><br><span class="line"></span><br><span class="line">    register(BigInteger<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">BigIntegerTypeHandler</span>())</span>;</span><br><span class="line">    register(JdbcType.BIGINT, <span class="keyword">new</span> LongTypeHandler());</span><br><span class="line"></span><br><span class="line">    register(BigDecimal<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">BigDecimalTypeHandler</span>())</span>;</span><br><span class="line">    register(JdbcType.REAL, <span class="keyword">new</span> BigDecimalTypeHandler());</span><br><span class="line">    register(JdbcType.DECIMAL, <span class="keyword">new</span> BigDecimalTypeHandler());</span><br><span class="line">    register(JdbcType.NUMERIC, <span class="keyword">new</span> BigDecimalTypeHandler());</span><br><span class="line"></span><br><span class="line">    register(Byte[]<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">ByteObjectArrayTypeHandler</span>())</span>;</span><br><span class="line">    register(Byte[]<span class="class">.<span class="keyword">class</span>, <span class="title">JdbcType</span>.<span class="title">BLOB</span>, <span class="title">new</span> <span class="title">BlobByteObjectArrayTypeHandler</span>())</span>;</span><br><span class="line">    register(Byte[]<span class="class">.<span class="keyword">class</span>, <span class="title">JdbcType</span>.<span class="title">LONGVARBINARY</span>, <span class="title">new</span> <span class="title">BlobByteObjectArrayTypeHandler</span>())</span>;</span><br><span class="line">    register(<span class="keyword">byte</span>[]<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">ByteArrayTypeHandler</span>())</span>;</span><br><span class="line">    register(<span class="keyword">byte</span>[]<span class="class">.<span class="keyword">class</span>, <span class="title">JdbcType</span>.<span class="title">BLOB</span>, <span class="title">new</span> <span class="title">BlobTypeHandler</span>())</span>;</span><br><span class="line">    register(<span class="keyword">byte</span>[]<span class="class">.<span class="keyword">class</span>, <span class="title">JdbcType</span>.<span class="title">LONGVARBINARY</span>, <span class="title">new</span> <span class="title">BlobTypeHandler</span>())</span>;</span><br><span class="line">    register(JdbcType.LONGVARBINARY, <span class="keyword">new</span> BlobTypeHandler());</span><br><span class="line">    register(JdbcType.BLOB, <span class="keyword">new</span> BlobTypeHandler());</span><br><span class="line"></span><br><span class="line">    register(Object<span class="class">.<span class="keyword">class</span>, <span class="title">UNKNOWN_TYPE_HANDLER</span>)</span>;</span><br><span class="line">    register(Object<span class="class">.<span class="keyword">class</span>, <span class="title">JdbcType</span>.<span class="title">OTHER</span>, <span class="title">UNKNOWN_TYPE_HANDLER</span>)</span>;</span><br><span class="line">    register(JdbcType.OTHER, UNKNOWN_TYPE_HANDLER);</span><br><span class="line"></span><br><span class="line">    register(Date<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">DateTypeHandler</span>())</span>;</span><br><span class="line">    register(Date<span class="class">.<span class="keyword">class</span>, <span class="title">JdbcType</span>.<span class="title">DATE</span>, <span class="title">new</span> <span class="title">DateOnlyTypeHandler</span>())</span>;</span><br><span class="line">    register(Date<span class="class">.<span class="keyword">class</span>, <span class="title">JdbcType</span>.<span class="title">TIME</span>, <span class="title">new</span> <span class="title">TimeOnlyTypeHandler</span>())</span>;</span><br><span class="line">    register(JdbcType.TIMESTAMP, <span class="keyword">new</span> DateTypeHandler());</span><br><span class="line">    register(JdbcType.DATE, <span class="keyword">new</span> DateOnlyTypeHandler());</span><br><span class="line">    register(JdbcType.TIME, <span class="keyword">new</span> TimeOnlyTypeHandler());</span><br><span class="line"></span><br><span class="line">    register(java.sql.Date<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">SqlDateTypeHandler</span>())</span>;</span><br><span class="line">    register(java.sql.Time<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">SqlTimeTypeHandler</span>())</span>;</span><br><span class="line">    register(java.sql.Timestamp<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">SqlTimestampTypeHandler</span>())</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// issue #273</span></span><br><span class="line">    register(Character<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">CharacterTypeHandler</span>())</span>;</span><br><span class="line">    register(<span class="keyword">char</span><span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">CharacterTypeHandler</span>())</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasTypeHandler</span><span class="params">(Class&lt;?&gt; javaType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> hasTypeHandler(javaType, <span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasTypeHandler</span><span class="params">(TypeReference&lt;?&gt; javaTypeReference)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> hasTypeHandler(javaTypeReference, <span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasTypeHandler</span><span class="params">(Class&lt;?&gt; javaType, JdbcType jdbcType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> javaType != <span class="keyword">null</span> &amp;&amp; getTypeHandler((Type) javaType, jdbcType) != <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasTypeHandler</span><span class="params">(TypeReference&lt;?&gt; javaTypeReference, JdbcType jdbcType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> javaTypeReference != <span class="keyword">null</span> &amp;&amp; getTypeHandler(javaTypeReference, jdbcType) != <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> TypeHandler&lt;?&gt; getMappingTypeHandler(Class&lt;? extends TypeHandler&lt;?&gt;&gt; handlerType) &#123;</span><br><span class="line">    <span class="keyword">return</span> ALL_TYPE_HANDLERS_MAP.get(handlerType);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function">TypeHandler&lt;T&gt; <span class="title">getTypeHandler</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getTypeHandler((Type) type, <span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function">TypeHandler&lt;T&gt; <span class="title">getTypeHandler</span><span class="params">(TypeReference&lt;T&gt; javaTypeReference)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getTypeHandler(javaTypeReference, <span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> TypeHandler&lt;?&gt; getTypeHandler(JdbcType jdbcType) &#123;</span><br><span class="line">    <span class="keyword">return</span> JDBC_TYPE_HANDLER_MAP.get(jdbcType);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function">TypeHandler&lt;T&gt; <span class="title">getTypeHandler</span><span class="params">(Class&lt;T&gt; type, JdbcType jdbcType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getTypeHandler((Type) type, jdbcType);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function">TypeHandler&lt;T&gt; <span class="title">getTypeHandler</span><span class="params">(TypeReference&lt;T&gt; javaTypeReference, JdbcType jdbcType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getTypeHandler(javaTypeReference.getRawType(), jdbcType);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> &lt;T&gt; <span class="function">TypeHandler&lt;T&gt; <span class="title">getTypeHandler</span><span class="params">(Type type, JdbcType jdbcType)</span> </span>&#123;</span><br><span class="line">    Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt; jdbcHandlerMap = TYPE_HANDLER_MAP.get(type);</span><br><span class="line">    TypeHandler&lt;?&gt; handler = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (jdbcHandlerMap != <span class="keyword">null</span>) &#123;</span><br><span class="line">      handler = jdbcHandlerMap.get(jdbcType);</span><br><span class="line">      <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        handler = jdbcHandlerMap.get(<span class="keyword">null</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (handler == <span class="keyword">null</span> &amp;&amp; type != <span class="keyword">null</span> &amp;&amp; type <span class="keyword">instanceof</span> Class &amp;&amp; Enum<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>((<span class="title">Class</span>&lt;?&gt;) <span class="title">type</span>)) </span>&#123;</span><br><span class="line">      handler = <span class="keyword">new</span> EnumTypeHandler((Class&lt;?&gt;) type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="comment">// type drives generics here</span></span><br><span class="line">    TypeHandler&lt;T&gt; returned = (TypeHandler&lt;T&gt;) handler;</span><br><span class="line">    <span class="keyword">return</span> returned;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> TypeHandler&lt;Object&gt; <span class="title">getUnknownTypeHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> UNKNOWN_TYPE_HANDLER;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(JdbcType jdbcType, TypeHandler&lt;?&gt; handler)</span> </span>&#123;</span><br><span class="line">    JDBC_TYPE_HANDLER_MAP.put(jdbcType, handler);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// REGISTER INSTANCE</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 只配置了typeHandler, 没有配置jdbcType 或者javaType</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(TypeHandler&lt;T&gt; typeHandler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> mappedTypeFound = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//在自定义typeHandler的时候，可以加上注解MappedTypes 去指定关联的javaType</span></span><br><span class="line">    <span class="comment">//因此，此处需要扫描MappedTypes注解</span></span><br><span class="line">    MappedTypes mappedTypes = typeHandler.getClass().getAnnotation(MappedTypes<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">if</span> (mappedTypes != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (Class&lt;?&gt; handledType : mappedTypes.value()) &#123;</span><br><span class="line">        register(handledType, typeHandler);</span><br><span class="line">        mappedTypeFound = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// @since 3.1.0 - try to auto-discover the mapped type</span></span><br><span class="line">    <span class="keyword">if</span> (!mappedTypeFound &amp;&amp; typeHandler <span class="keyword">instanceof</span> TypeReference) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        TypeReference&lt;T&gt; typeReference = (TypeReference&lt;T&gt;) typeHandler;</span><br><span class="line">        register(typeReference.getRawType(), typeHandler);</span><br><span class="line">        mappedTypeFound = <span class="keyword">true</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="comment">// maybe users define the TypeReference with a different type and are not assignable, so just ignore it</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!mappedTypeFound) &#123;</span><br><span class="line">      register((Class&lt;T&gt;) <span class="keyword">null</span>, typeHandler);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 配置了typeHandlerhe和javaType</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(Class&lt;T&gt; javaType, TypeHandler&lt;? extends T&gt; typeHandler)</span> </span>&#123;</span><br><span class="line">    register((Type) javaType, typeHandler);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(Type javaType, TypeHandler&lt;? extends T&gt; typeHandler)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//扫描注解MappedJdbcTypes</span></span><br><span class="line">    MappedJdbcTypes mappedJdbcTypes = typeHandler.getClass().getAnnotation(MappedJdbcTypes<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">if</span> (mappedJdbcTypes != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (JdbcType handledJdbcType : mappedJdbcTypes.value()) &#123;</span><br><span class="line">        register(javaType, handledJdbcType, typeHandler);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (mappedJdbcTypes.includeNullJdbcType()) &#123;</span><br><span class="line">        register(javaType, <span class="keyword">null</span>, typeHandler);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      register(javaType, <span class="keyword">null</span>, typeHandler);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(TypeReference&lt;T&gt; javaTypeReference, TypeHandler&lt;? extends T&gt; handler)</span> </span>&#123;</span><br><span class="line">    register(javaTypeReference.getRawType(), handler);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * typeHandlerhe、javaType、jdbcType都配置了</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(Class&lt;T&gt; type, JdbcType jdbcType, TypeHandler&lt;? extends T&gt; handler)</span> </span>&#123;</span><br><span class="line">    register((Type) type, jdbcType, handler);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 注册typeHandler的核心方法</span></span><br><span class="line"><span class="comment">   * 就是向Map新增数据而已</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Type javaType, JdbcType jdbcType, TypeHandler&lt;?&gt; handler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (javaType != <span class="keyword">null</span>) &#123;</span><br><span class="line">      Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt; map = TYPE_HANDLER_MAP.get(javaType);</span><br><span class="line">      <span class="keyword">if</span> (map == <span class="keyword">null</span>) &#123;</span><br><span class="line">        map = <span class="keyword">new</span> HashMap&lt;JdbcType, TypeHandler&lt;?&gt;&gt;();</span><br><span class="line">        TYPE_HANDLER_MAP.put(javaType, map);</span><br><span class="line">      &#125;</span><br><span class="line">      map.put(jdbcType, handler);</span><br><span class="line">      <span class="keyword">if</span> (reversePrimitiveMap.containsKey(javaType)) &#123;</span><br><span class="line">        register(reversePrimitiveMap.get(javaType), jdbcType, handler);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ALL_TYPE_HANDLERS_MAP.put(handler.getClass(), handler);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// REGISTER CLASS</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Only handler type</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Class&lt;?&gt; typeHandlerClass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> mappedTypeFound = <span class="keyword">false</span>;</span><br><span class="line">    MappedTypes mappedTypes = typeHandlerClass.getAnnotation(MappedTypes<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">if</span> (mappedTypes != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (Class&lt;?&gt; javaTypeClass : mappedTypes.value()) &#123;</span><br><span class="line">        register(javaTypeClass, typeHandlerClass);</span><br><span class="line">        mappedTypeFound = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!mappedTypeFound) &#123;</span><br><span class="line">      register(getInstance(<span class="keyword">null</span>, typeHandlerClass));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// java type + handler type</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Class&lt;?&gt; javaTypeClass, Class&lt;?&gt; typeHandlerClass)</span> </span>&#123;</span><br><span class="line">    register(javaTypeClass, getInstance(javaTypeClass, typeHandlerClass));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// java type + jdbc type + handler type</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Class&lt;?&gt; javaTypeClass, JdbcType jdbcType, Class&lt;?&gt; typeHandlerClass)</span> </span>&#123;</span><br><span class="line">    register(javaTypeClass, jdbcType, getInstance(javaTypeClass, typeHandlerClass));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Construct a handler (used also from Builders)</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function">TypeHandler&lt;T&gt; <span class="title">getInstance</span><span class="params">(Class&lt;?&gt; javaTypeClass, Class&lt;?&gt; typeHandlerClass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (javaTypeClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        Constructor&lt;?&gt; c = typeHandlerClass.getConstructor(Class<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">return</span> (TypeHandler&lt;T&gt;) c.newInstance(javaTypeClass);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (NoSuchMethodException ignored) &#123;</span><br><span class="line">        <span class="comment">// ignored</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">"Failed invoking constructor for handler "</span> + typeHandlerClass, e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Constructor&lt;?&gt; c = typeHandlerClass.getConstructor();</span><br><span class="line">      <span class="keyword">return</span> (TypeHandler&lt;T&gt;) c.newInstance();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">"Unable to find a usable constructor for "</span> + typeHandlerClass, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 根据指定的pacakge去扫描自定义的typeHander，然后注册</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">    ResolverUtil&lt;Class&lt;?&gt;&gt; resolverUtil = <span class="keyword">new</span> ResolverUtil&lt;Class&lt;?&gt;&gt;();</span><br><span class="line">    resolverUtil.find(<span class="keyword">new</span> ResolverUtil.IsA(TypeHandler<span class="class">.<span class="keyword">class</span>), <span class="title">packageName</span>)</span>;</span><br><span class="line">    Set&lt;Class&lt;? extends Class&lt;?&gt;&gt;&gt; handlerSet = resolverUtil.getClasses();</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; type : handlerSet) &#123;</span><br><span class="line">      <span class="comment">//Ignore inner classes and interfaces (including package-info.java) and abstract classes</span></span><br><span class="line">      <span class="keyword">if</span> (!type.isAnonymousClass() &amp;&amp; !type.isInterface() &amp;&amp; !Modifier.isAbstract(type.getModifiers())) &#123;</span><br><span class="line">        register(type);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 通过configuration对象可以获取已注册的所有typeHandler</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> Collection&lt;TypeHandler&lt;?&gt;&gt; getTypeHandlers() &#123;</span><br><span class="line">    <span class="keyword">return</span> Collections.unmodifiableCollection(ALL_TYPE_HANDLERS_MAP.values());</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="执行流分析"><a href="#执行流分析" class="headerlink" title="执行流分析"></a>执行流分析</h3><h4 id="SqlSessionFactory-与-SqlSession"><a href="#SqlSessionFactory-与-SqlSession" class="headerlink" title="SqlSessionFactory 与 SqlSession"></a>SqlSessionFactory 与 SqlSession</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">（<span class="number">1</span>）首先，SqlSessionFactoryBuilder去读取mybatis的配置文件，然后build一个DefaultSqlSessionFactory。源码如下：</span><br><span class="line">```java</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 一系列的构造方法最终都会调用本方法（配置文件为Reader时会调用本方法，还有一个InputStream方法与此对应）</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> reader</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> environment</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> properties</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">build</span><span class="params">(Reader reader, String environment, Properties properties)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//通过XMLConfigBuilder解析配置文件，解析的配置相关信息都会封装为一个Configuration对象</span></span><br><span class="line">      XMLConfigBuilder parser = <span class="keyword">new</span> XMLConfigBuilder(reader, environment, properties);</span><br><span class="line">      <span class="comment">//这儿创建DefaultSessionFactory对象</span></span><br><span class="line">      <span class="keyword">return</span> build(parser.parse());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">"Error building SqlSession."</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        reader.close();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">// Intentionally ignore. Prefer previous error.</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">build</span><span class="params">(Configuration config)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DefaultSqlSessionFactory(config);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>（2）当我们获取到SqlSessionFactory之后，就可以通过SqlSessionFactory去获取SqlSession对象。源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 通常一系列openSession方法最终都会调用本方法</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> execType </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> level</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> autoCommit</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> SqlSession <span class="title">openSessionFromDataSource</span><span class="params">(ExecutorType execType, TransactionIsolationLevel level, <span class="keyword">boolean</span> autoCommit)</span> </span>&#123;</span><br><span class="line">    Transaction tx = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//通过Confuguration对象去获取Mybatis相关配置信息, Environment对象包含了数据源和事务的配置</span></span><br><span class="line">      <span class="keyword">final</span> Environment environment = configuration.getEnvironment();</span><br><span class="line">      <span class="keyword">final</span> TransactionFactory transactionFactory = getTransactionFactoryFromEnvironment(environment);</span><br><span class="line">      tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);</span><br><span class="line">      <span class="comment">//之前说了，从表面上来看，咱们是用sqlSession在执行sql语句， 实际呢，其实是通过excutor执行， excutor是对于Statement的封装</span></span><br><span class="line">      <span class="keyword">final</span> Executor executor = configuration.newExecutor(tx, execType);</span><br><span class="line">      <span class="comment">//关键看这儿，创建了一个DefaultSqlSession对象</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> DefaultSqlSession(configuration, executor, autoCommit);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      closeTransaction(tx); <span class="comment">// may have fetched a connection so lets call close()</span></span><br><span class="line">      <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">"Error opening session.  Cause: "</span> + e, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="MapperProxy"><a href="#MapperProxy" class="headerlink" title="MapperProxy"></a>MapperProxy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getMapper</span><span class="params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 交给MapperProxyFactory去做</span></span><br><span class="line">    <span class="keyword">final</span> MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory&lt;T&gt;) knownMappers.get(type);</span><br><span class="line">    <span class="keyword">if</span> (mapperProxyFactory == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Type "</span> + type + <span class="string">" is not known to the MapperRegistry."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123; </span><br><span class="line">        <span class="keyword">return</span> mapperProxyFactory.newInstance(sqlSession);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Error getting mapper instance. Cause: "</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="function"><span class="keyword">protected</span> T <span class="title">newInstance</span><span class="params">(MapperProxy&lt;T&gt; mapperProxy)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//动态代理我们写的dao接口</span></span><br><span class="line">    <span class="keyword">return</span> (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), <span class="keyword">new</span> Class[] &#123; mapperInterface &#125;, mapperProxy);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">newInstance</span><span class="params">(SqlSession sqlSession)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> MapperProxy&lt;T&gt; mapperProxy = <span class="keyword">new</span> MapperProxy&lt;T&gt;(sqlSession, mapperInterface, methodCache);</span><br><span class="line">    <span class="keyword">return</span> newInstance(mapperProxy);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* MapperProxy在执行时会触发此方法</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Object<span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">method</span>.<span class="title">getDeclaringClass</span>())) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> MapperMethod mapperMethod = cachedMapperMethod(method); </span><br><span class="line">    <span class="keyword">return</span> mapperMethod.execute(sqlSession, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//先判断CRUD类型，然后根据类型去选择到底执行sqlSession中的哪个方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">execute</span><span class="params">(SqlSession sqlSession, Object[] args)</span> </span>&#123;</span><br><span class="line">    Object result;</span><br><span class="line">    <span class="keyword">if</span> (SqlCommandType.INSERT == command.getType()) &#123;</span><br><span class="line">      Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">      result = rowCountResult(sqlSession.insert(command.getName(), param));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SqlCommandType.UPDATE == command.getType()) &#123;</span><br><span class="line">      Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">      result = rowCountResult(sqlSession.update(command.getName(), param));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SqlCommandType.DELETE == command.getType()) &#123;</span><br><span class="line">      Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">      result = rowCountResult(sqlSession.delete(command.getName(), param));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SqlCommandType.SELECT == command.getType()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (method.returnsVoid() &amp;&amp; method.hasResultHandler()) &#123;</span><br><span class="line">        executeWithResultHandler(sqlSession, args);</span><br><span class="line">        result = <span class="keyword">null</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.returnsMany()) &#123;</span><br><span class="line">        result = executeForMany(sqlSession, args);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.returnsMap()) &#123;</span><br><span class="line">        result = executeForMap(sqlSession, args);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = sqlSession.selectOne(command.getName(), param);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Unknown execution method for: "</span> + command.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span> &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Mapper method '"</span> + command.getName() </span><br><span class="line">          + <span class="string">" attempted to return null from a method with a primitive return type ("</span> + method.getReturnType() + <span class="string">")."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//最终执行</span></span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">selectList</span><span class="params">(String statement, Object parameter, RowBounds rowBounds)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      MappedStatement ms = configuration.getMappedStatement(statement);</span><br><span class="line">      <span class="keyword">return</span> executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">"Error querying database.  Cause: "</span> + e, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//查看SimpleExecutor中，最终执行</span></span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">doQuery</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    Statement stmt = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Configuration configuration = ms.getConfiguration();</span><br><span class="line">      StatementHandler handler = configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">      stmt = prepareStatement(handler, ms.getStatementLog());</span><br><span class="line">      <span class="comment">//StatementHandler封装了Statement, 让 StatementHandler 去处理</span></span><br><span class="line">      <span class="keyword">return</span> handler.&lt;E&gt;query(stmt, resultHandler);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      closeStatement(stmt);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://www.cnblogs.com/dongying/p/4142476.html" target="_blank" rel="noopener">https://www.cnblogs.com/dongying/p/4142476.html</a></p>
<h2 id="使用的设计模式"><a href="#使用的设计模式" class="headerlink" title="使用的设计模式"></a>使用的设计模式</h2><p><img src="https://img.huyunshun.com/img/20200506224912.png" alt="20200506224912"></p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/04/23/jpa%E4%B8%AD%E6%89%B9%E9%87%8F%E6%9B%B4%E6%96%B0%E5%92%8C%E6%8F%92%E5%85%A5%E5%AE%9E%E7%8E%B0%E5%8F%8A%E5%A4%8D%E6%9D%82%E6%9F%A5%E8%AF%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/23/jpa%E4%B8%AD%E6%89%B9%E9%87%8F%E6%9B%B4%E6%96%B0%E5%92%8C%E6%8F%92%E5%85%A5%E5%AE%9E%E7%8E%B0%E5%8F%8A%E5%A4%8D%E6%9D%82%E6%9F%A5%E8%AF%A2/" itemprop="url">jpa中批量更新和插入实现及复杂查询.md</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-23T14:12:24+08:00">
                2019-04-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/springboot/" itemprop="url" rel="index">
                    <span itemprop="name">springboot</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="批量更新和插入"><a href="#批量更新和插入" class="headerlink" title="批量更新和插入"></a>批量更新和插入</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NoRepositoryBean</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BaseRepository</span>&lt;<span class="title">T</span>, <span class="title">ID</span> <span class="keyword">extends</span> <span class="title">Serializable</span>&gt; <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">T</span>, <span class="title">ID</span>&gt;, <span class="title">JpaSpecificationExecutor</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    &lt;S extends T&gt; <span class="function">Iterable&lt;S&gt; <span class="title">batchSave</span><span class="params">(Iterable&lt;S&gt; var1)</span></span>;</span><br><span class="line">    &lt;S extends T&gt; <span class="function">Iterable&lt;S&gt; <span class="title">batchUpdate</span><span class="params">(Iterable&lt;S&gt; var1)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseRepositoryImpl</span>&lt;<span class="title">T</span>, <span class="title">ID</span> <span class="keyword">extends</span> <span class="title">Serializable</span>&gt; <span class="keyword">extends</span> <span class="title">SimpleJpaRepository</span>&lt;<span class="title">T</span>, <span class="title">ID</span>&gt; <span class="keyword">implements</span> <span class="title">BaseRepository</span>&lt;<span class="title">T</span>, <span class="title">ID</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//500一批</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BATCH_SIZE = <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> EntityManager em;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseRepositoryImpl</span><span class="params">(JpaEntityInformation&lt;T, ?&gt; entityInformation, EntityManager em)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(entityInformation, em);</span><br><span class="line">        <span class="keyword">this</span>.em = em;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseRepositoryImpl</span><span class="params">(Class&lt;T&gt; domainClass, EntityManager em)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(domainClass, em);</span><br><span class="line">        <span class="keyword">this</span>.em = em;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> &lt;S extends T&gt; <span class="function">Iterable&lt;S&gt; <span class="title">batchSave</span><span class="params">(Iterable&lt;S&gt; var1)</span> </span>&#123;</span><br><span class="line">        Iterator&lt;S&gt; iterator = var1.iterator();</span><br><span class="line">        <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            em.persist(iterator.next());</span><br><span class="line">            index++;</span><br><span class="line">            <span class="keyword">if</span> (index % BATCH_SIZE == <span class="number">0</span>) &#123;</span><br><span class="line">                em.flush();</span><br><span class="line">                em.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (index % BATCH_SIZE != <span class="number">0</span>) &#123;</span><br><span class="line">            em.flush();</span><br><span class="line">            em.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> var1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> &lt;S extends T&gt; <span class="function">Iterable&lt;S&gt; <span class="title">batchUpdate</span><span class="params">(Iterable&lt;S&gt; var1)</span> </span>&#123;</span><br><span class="line">        Iterator&lt;S&gt; iterator = var1.iterator();</span><br><span class="line">        <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            em.merge(iterator.next());</span><br><span class="line">            index++;</span><br><span class="line">            <span class="keyword">if</span> (index % BATCH_SIZE == <span class="number">0</span>) &#123;</span><br><span class="line">                em.flush();</span><br><span class="line">                em.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (index % BATCH_SIZE != <span class="number">0</span>) &#123;</span><br><span class="line">            em.flush();</span><br><span class="line">            em.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> var1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//业务中使用</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">QuestionRepository</span> <span class="keyword">extends</span> <span class="title">BaseRepository</span>&lt;<span class="title">Question</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Question <span class="title">findQuestionByQuestionIdAndDeleteState</span><span class="params">(String questionId, Short deleteState)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Modifying</span></span><br><span class="line">    <span class="meta">@Query</span>(<span class="string">"update Question set deleteState=1,deleteTime=:deleteTime where categoryId=:categoryId and createUserId=:userId"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">deleteAllByCategoryId</span><span class="params">(String categoryId, Integer userId, Long deleteTime)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="jpa复杂查询"><a href="#jpa复杂查询" class="headerlink" title="jpa复杂查询"></a>jpa复杂查询</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">CriteriaBuilder criteriaBuilder = entityManager.getCriteriaBuilder();</span><br><span class="line">　　　　 <span class="comment">//查询结果所需要的类型(Entity相对应)</span></span><br><span class="line">CriteriaQuery&lt;Entity&gt; criteriaQuery = criteriaBuilder.createQuery(Entity<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">　　　　 <span class="comment">//查询所需要的主体类（Entity0相对应）</span></span><br><span class="line">Root&lt;Entity0&gt; root = criteriaQuery.from(Entity0<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">　　　　 <span class="comment">//查询结果-select（此处查询所有符合条件的主体类）</span></span><br><span class="line">criteriaQuery.select(root);</span><br><span class="line">　　　　 <span class="comment">//过滤条件用Predicate方法拼接</span></span><br><span class="line">Predicate restrictions = criteriaBuilder.conjunction();</span><br><span class="line">　　　　 <span class="comment">//过滤条件——equal（当Entity0关联member类时，Entity0：member=m：1）</span></span><br><span class="line">restrictions = criteriaBuilder.and(restrictions, criteriaBuilder.equal(root.get(<span class="string">"member"</span>), member));</span><br><span class="line"><span class="comment">//过滤条件——like</span></span><br><span class="line">restrictions = criteriaBuilder.and(restrictions, criteriaBuilder.like(root.&lt;String&gt;get(<span class="string">"str"</span>), <span class="string">"%"</span> + str + <span class="string">"%"</span>));</span><br><span class="line"><span class="comment">//用户名查询（member里面的username匹配） ———— 多层查询 ———— 子查询的一种：适用于m:1或1:1（即多对一或一对一）</span></span><br><span class="line">restrictions = criteriaBuilder.and(restrictions, criteriaBuilder.like(root.get(<span class="string">"member"</span>).&lt;String&gt;get(<span class="string">"username"</span>), <span class="string">"%"</span> + username + <span class="string">"%"</span>));</span><br><span class="line"><span class="comment">//子查询（规范写法，先判断查询内容是否存在）（适用于1：m）（即一对多）</span></span><br><span class="line"><span class="keyword">if</span> (searchType != <span class="keyword">null</span> || searchValue != <span class="keyword">null</span> || hasExpired != <span class="keyword">null</span> || status != <span class="keyword">null</span> || type != <span class="keyword">null</span> || isPendingReceive != <span class="keyword">null</span></span><br><span class="line">        || isPendingRefunds != <span class="keyword">null</span> || isAllocatedStock != <span class="keyword">null</span> || businessType != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">//建立子查询</span></span><br><span class="line">　　　　　　Subquery&lt;Order&gt; orderSubquery = criteriaQuery.subquery(Order<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    Root&lt;Order&gt; orderSubqueryRoot = orderSubquery.from(Order<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    orderSubquery.select(orderSubqueryRoot);</span><br><span class="line">　　　　　　　<span class="comment">//子查询和父查询相关联</span></span><br><span class="line">    Predicate orderRestrictions = criteriaBuilder.equal(orderSubqueryRoot.&lt;MergeOrder&gt;get(<span class="string">"mergeOrder"</span>), root);</span><br><span class="line">    <span class="comment">//子查询过滤条件拼接</span></span><br><span class="line">    <span class="keyword">if</span> (searchType != <span class="keyword">null</span> &amp;&amp; searchValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"phone"</span>.equals(searchType)) &#123;</span><br><span class="line">            orderRestrictions = criteriaBuilder.and(orderRestrictions, criteriaBuilder.like(orderSubqueryRoot.&lt;String&gt;get(<span class="string">"phone"</span>), <span class="string">"%"</span> + searchValue + <span class="string">"%"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (type != <span class="keyword">null</span>) &#123;</span><br><span class="line">        CriteriaBuilder.In&lt;Order.Type&gt; in = criteriaBuilder.in(orderSubqueryRoot.&lt;Order.Type&gt;get(<span class="string">"type"</span>));</span><br><span class="line">        in.value(type);</span><br><span class="line">        orderRestrictions = criteriaBuilder.and(orderRestrictions, in);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//and、or以及判断是否为null，比较（&gt;）的使用（比较可以用于日期比较）</span></span><br><span class="line">    <span class="keyword">if</span> (hasExpired != <span class="keyword">null</span>) &#123;</span><br><span class="line">        orderRestrictions = criteriaBuilder.and(orderRestrictions, criteriaBuilder.or(orderSubqueryRoot.get(<span class="string">"expire"</span>).isNull(), criteriaBuilder.greaterThan(orderSubqueryRoot.&lt;Date&gt;get(<span class="string">"expire"</span>), <span class="keyword">new</span> Date())));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// not的使用方法（不符合上述过滤条件），notEqual的使用，&lt;（小于）的使用</span></span><br><span class="line">    <span class="keyword">if</span> (isPendingReceive != <span class="keyword">null</span>) &#123;</span><br><span class="line">        restrictions = criteriaBuilder.and(restrictions, criteriaBuilder.equal(root.get(<span class="string">"paymentMethodType"</span>), PaymentMethod.Type.cashOnDelivery));</span><br><span class="line">        Predicate predicate = criteriaBuilder.and(criteriaBuilder.or(orderSubqueryRoot.get(<span class="string">"expire"</span>).isNull()</span><br><span class="line">                , criteriaBuilder.greaterThan(orderSubqueryRoot.&lt;Date&gt;get(<span class="string">"expire"</span>), <span class="keyword">new</span> Date()))</span><br><span class="line">                , criteriaBuilder.notEqual(orderSubqueryRoot.get(<span class="string">"status"</span>), Order.Status.completed)</span><br><span class="line">                , criteriaBuilder.lessThan(orderSubqueryRoot.&lt;BigDecimal&gt;get(<span class="string">"amountPaid"</span>), orderSubqueryRoot.&lt;BigDecimal&gt;get(<span class="string">"amount"</span>)));</span><br><span class="line">        <span class="keyword">if</span> (isPendingReceive) &#123;</span><br><span class="line">            orderRestrictions = criteriaBuilder.and(orderRestrictions, criteriaBuilder.not(predicate));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 多层查询使用</span></span><br><span class="line">    <span class="keyword">if</span> (businessType != <span class="keyword">null</span>) &#123;</span><br><span class="line">        orderRestrictions = criteriaBuilder.and(orderRestrictions, criteriaBuilder.equal(orderSubqueryRoot.get(<span class="string">"store"</span>).get(<span class="string">"business"</span>).get(<span class="string">"businessType"</span>), businessType));</span><br><span class="line">    &#125;</span><br><span class="line">　　　　<span class="comment">// 拼接过滤条件</span></span><br><span class="line">    orderSubquery.where(orderRestrictions);</span><br><span class="line">    <span class="comment">// 和总条件拼接（exists的使用）</span></span><br><span class="line">    restrictions = criteriaBuilder.and(restrictions, criteriaBuilder.exists(orderSubquery));</span><br><span class="line">&#125;</span><br><span class="line">criteriaQuery.where(restrictions);</span><br><span class="line">　　　　</span><br><span class="line">TypedQuery&lt;Entity&gt; query = entityManager.createQuery(criteriaQuery);</span><br><span class="line">　　　　</span><br><span class="line">Entity singleResult = query.getSingleResult();</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/04/23/%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98%E6%95%B4%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/23/%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98%E6%95%B4%E7%90%86/" itemprop="url">跨域问题整理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-23T12:43:41+08:00">
                2019-04-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/spring/" itemprop="url" rel="index">
                    <span itemprop="name">spring</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="跨域介绍"><a href="#跨域介绍" class="headerlink" title="跨域介绍"></a>跨域介绍</h2><h3 id="1、同源策略简介"><a href="#1、同源策略简介" class="headerlink" title="1、同源策略简介"></a>1、同源策略简介</h3><p>同源策略[same origin policy]是浏览器的一个安全功能，不同源的客户端脚本在没有明确授权的情况下，不能读写对方资源。 同源策略是浏览器安全的基石。  </p>
<p>什么是源：源[origin]就是协议、域名和端口号。例如：<a href="http://www.baidu.com:80这个URL。">http://www.baidu.com:80这个URL。</a></p>
<p>什么是同源：若地址里面的协议、域名和端口号均相同则属于同源。</p>
<p>哪些操作不受同源策略限制    </p>
<ul>
<li>页面中的链接，重定向以及表单提交是不会受到同源策略限制的；</li>
<li>跨域资源的引入是可以的。</li>
</ul>
<h3 id="2、跨域"><a href="#2、跨域" class="headerlink" title="2、跨域"></a>2、跨域</h3><p>受前面所讲的浏览器同源策略的影响，不是同源的脚本不能操作其他源下面的对象。想要操作另一个源下的对象就需要跨域。 在同源策略的限制下，非同源的网站之间不能发送 AJAX 请求。</p>
<p>如何跨域？<br>降域：可以通过设置 document.damain=’a.com’，浏览器就会认为它们都是同一个源。想要实现以上任意两个页面之间的通信，两个页面必须都设置documen.damain=’a.com’。</p>
<p>JSONP跨域<br>CORS 跨域</p>
<h2 id="CORS-简介"><a href="#CORS-简介" class="headerlink" title="CORS 简介"></a>CORS 简介</h2><p>为了解决浏览器同源问题，W3C 提出了跨源资源共享，即 CORS(Cross-Origin Resource Sharing)。</p>
<p>CORS 做到了两点：不破坏即有规则和服务器实现了 CORS 接口，就可以跨源通信。</p>
<p>基于这两点，CORS 将请求分为两类：简单请求和非简单请求。   </p>
<h3 id="1、简单请求"><a href="#1、简单请求" class="headerlink" title="1、简单请求"></a>1、简单请求</h3><p>在CORS出现前，发送HTTP请求时在头信息中不能包含任何自定义字段，且 HTTP 头信息不超过以下几个字段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Accept</span><br><span class="line">Accept-Language</span><br><span class="line">Content-Language</span><br><span class="line">Last-Event-ID</span><br><span class="line">Content-Type 只限于 [application&#x2F;x-www-form-urlencoded 、multipart&#x2F;form-data、text&#x2F;plain ] 类型</span><br></pre></td></tr></table></figure>
<p>一个简单的请求例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;test HTTP&#x2F;1.1</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Accept-Encoding: gzip, deflate, sdch, br</span><br><span class="line">Origin: http:&#x2F;&#x2F;www.examples.com</span><br><span class="line">Host: www.examples.com</span><br><span class="line">对于简单请求，CORS的策略是请求时在请求头中增加一个Origin字段，服务器收到请求后，根据该字段判断是否允许该请求访问。</span><br></pre></td></tr></table></figure>
<p>如果允许，则在 HTTP 头信息中添加 Access-Control-Allow-Origin 字段，并返回正确的结果 ；<br>如果不允许，则不在 HTTP 头信息中添加 Access-Control-Allow-Origin 字段 。<br>除了上面提到的 Access-Control-Allow-Origin ，还有几个字段用于描述 CORS 返回结果 ：</p>
<p>Access-Control-Allow-Credentials： 可选，用户是否可以发送、处理 cookie；<br>Access-Control-Expose-Headers：可选，可以让用户拿到的字段。有几个字段无论设置与否都可以拿到的，包括：Cache-Control、Content-Language、Content-Type、Expires、Last-Modified、Pragma 。   </p>
<h3 id="2、非简单请求"><a href="#2、非简单请求" class="headerlink" title="2、非简单请求"></a>2、非简单请求</h3><p>对于非简单请求的跨源请求，浏览器会在真实请求发出前，增加一次OPTION请求，称为预检请求(preflight request)。预检请求将真实请求的信息，包括请求方法、自定义头字段、源信息添加到 HTTP 头信息字段中，询问服务器是否允许这样的操作。</p>
<p>例如一个DELETE请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS &#x2F;test HTTP&#x2F;1.1</span><br><span class="line">Origin: http:&#x2F;&#x2F;www.examples.com</span><br><span class="line">Access-Control-Request-Method: DELETE</span><br><span class="line">Access-Control-Request-Headers: X-Custom-Header</span><br><span class="line">Host: www.examples.com</span><br></pre></td></tr></table></figure>
<p>与 CORS 相关的字段有：</p>
<p>请求使用的 HTTP 方法 Access-Control-Request-Method ；<br>请求中包含的自定义头字段 Access-Control-Request-Headers 。<br>服务器收到请求时，需要分别对 Origin、Access-Control-Request-Method、Access-Control-Request-Headers 进行验证，验证通过后，会在返回 HTTP头信息中添加 ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin: http:&#x2F;&#x2F;www.examples.com</span><br><span class="line">Access-Control-Allow-Methods: GET, POST, PUT, DELETE</span><br><span class="line">Access-Control-Allow-Headers: X-Custom-Header</span><br><span class="line">Access-Control-Allow-Credentials: true</span><br><span class="line">Access-Control-Max-Age: 1728000</span><br><span class="line">他们的含义分别是：</span><br><span class="line"></span><br><span class="line">Access-Control-Allow-Methods: 真实请求允许的方法</span><br><span class="line">Access-Control-Allow-Headers: 服务器允许使用的字段</span><br><span class="line">Access-Control-Allow-Credentials: 是否允许用户发送、处理 cookie</span><br><span class="line">Access-Control-Max-Age: 预检请求的有效期，单位为秒。有效期内，不会重复发送预检请求</span><br><span class="line">当预检请求通过后，浏览器会发送真实请求到服务器。这就实现了跨源请求。</span><br></pre></td></tr></table></figure>

<h2 id="跨域配置实现"><a href="#跨域配置实现" class="headerlink" title="跨域配置实现"></a>跨域配置实现</h2><h3 id="1、使用-CrossOrigin-注解实现，可以加在方法或者类上。"><a href="#1、使用-CrossOrigin-注解实现，可以加在方法或者类上。" class="headerlink" title="1、使用@CrossOrigin 注解实现，可以加在方法或者类上。"></a>1、使用@CrossOrigin 注解实现，可以加在方法或者类上。</h3><ul>
<li>origins  ： 允许可访问的域列表</li>
<li>maxAge：准备响应前的缓存持续的最大时间（以秒为单位）。<br>@CrossOrigin(origins = “<a href="http://domain2.com&quot;" target="_blank" rel="noopener">http://domain2.com&quot;</a>, maxAge = 3600)</li>
</ul>
<h3 id="2、全局配置"><a href="#2、全局配置" class="headerlink" title="2、全局配置"></a>2、全局配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebMvcConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addMapping(<span class="string">"/front/edu/study/notes/getNote.php*"</span>);</span><br><span class="line">        <span class="comment">//registry.addMapping("*");</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    @Override</span></span><br><span class="line"><span class="comment">    public void addCorsMappings(CorsRegistry registry) &#123;</span></span><br><span class="line"><span class="comment">        registry.addMapping("/**")</span></span><br><span class="line"><span class="comment">                .allowedHeaders("Content-Type","X-Requested-With","accept,Origin","Access-Control-Request-Method","Access-Control-Request-Headers","token")</span></span><br><span class="line"><span class="comment">                .allowedMethods("*")</span></span><br><span class="line"><span class="comment">                .allowedOrigins("*")</span></span><br><span class="line"><span class="comment">                .allowCredentials(true);</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//过期，不建议使用，1.5版本为继承WebMvcConfigurerAdapter 类实现抽象方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebMvcConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addMapping(<span class="string">"/**"</span>)</span><br><span class="line">                .allowedOrigins(<span class="string">"*"</span>)</span><br><span class="line">                .allowedMethods(<span class="string">"POST"</span>, <span class="string">"GET"</span>, <span class="string">"PUT"</span>, <span class="string">"OPTIONS"</span>, <span class="string">"DELETE"</span>)</span><br><span class="line">                .maxAge(<span class="number">3600</span>)</span><br><span class="line">                .allowCredentials(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3、拦截器配置"><a href="#3、拦截器配置" class="headerlink" title="3、拦截器配置"></a>3、拦截器配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CorsConfig</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CorsFilter <span class="title">corsFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UrlBasedCorsConfigurationSource source = <span class="keyword">new</span> UrlBasedCorsConfigurationSource();</span><br><span class="line">        CorsConfiguration config = <span class="keyword">new</span> CorsConfiguration();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        config.addAllowedHeader(<span class="string">"*"</span>);</span><br><span class="line">        config.addAllowedMethod(<span class="string">"*"</span>);</span><br><span class="line">        config.setAllowCredentials(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//config.addAllowedOrigin("http://localhost:9000");//允许请求方</span></span><br><span class="line">        config.addAllowedOrigin(<span class="string">"*"</span>);</span><br><span class="line"></span><br><span class="line">        source.registerCorsConfiguration(<span class="string">"/front/edu/study/notes/getNote.php*"</span>, config);</span><br><span class="line">        <span class="comment">//source.registerCorsConfiguration("/**", config); // CORS 配置对所有接口都有效</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*FilterRegistrationBean bean = newFilterRegistrationBean(new CorsFilter(source));</span></span><br><span class="line"><span class="comment">        bean.setOrder(0);*/</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CorsFilter(source);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//普通拦截器在HttpServletResponse 加上也可以</span></span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                response.addHeader(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"*"</span>);</span><br><span class="line">                response.addHeader(<span class="string">"Access-Control-Allow-Methods"</span>, <span class="string">"GET, POST, PUT, DELETE, OPTIONS"</span>);</span><br><span class="line">                response.addHeader(<span class="string">"Access-Control-Allow-Headers"</span>,</span><br><span class="line">                        <span class="string">"Content-Type,X-Requested-With,accept,Origin,Access-Control-Request-Method,Access-Control-Request-Headers,token"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<p>无论是通过哪种方式配置 CORS，都是在构造 CorsConfiguration。 一个 CORS 配置用一个 CorsConfiguration类来表示，它的定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CorsConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; allowedOrigins;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; allowedMethods;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; allowedHeaders;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; exposedHeaders;</span><br><span class="line">    <span class="keyword">private</span> Boolean allowCredentials;</span><br><span class="line">    <span class="keyword">private</span> Long maxAge;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Spring 中对 CORS 规则的校验，都是通过委托给 DefaultCorsProcessor实现的。</p>
<p>DefaultCorsProcessor 处理过程如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">①判断依据是 Header中是否包含 Origin。如果包含则说明为 CORS请求，转到 2；否则，说明不是 CORS 请求，不作任何处理。</span><br><span class="line">②判断 response 的 Header 是否已经包含 Access-Control-Allow-Origin，如果包含，证明已经被处理过了, 转到 3，否则不再处理。</span><br><span class="line">③判断是否同源，如果是则转交给负责该请求的类处理</span><br><span class="line">④是否配置了 CORS 规则，如果没有配置，且是预检请求，则拒绝该请求，如果没有配置，且不是预检请求，则交给负责该请求的类处理。如果配置了，则对该请求进行校验。</span><br><span class="line">⑤校验就是根据 CorsConfiguration 这个类的配置进行判断：</span><br><span class="line"></span><br><span class="line">判断 origin 是否合法</span><br><span class="line">判断 method 是否合法</span><br><span class="line">判断 header是否合法</span><br><span class="line">如果全部合法，则在 response header中添加响应的字段，并交给负责该请求的类处理，如果不合法，则拒绝该请求。</span><br></pre></td></tr></table></figure>
<h3 id="4、Servlet方式"><a href="#4、Servlet方式" class="headerlink" title="4、Servlet方式"></a>4、Servlet方式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;设置允许跨域的配置</span><br><span class="line">&#x2F;&#x2F; 这里填写你允许进行跨域的主机</span><br><span class="line">rep.setHeader(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);</span><br><span class="line">&#x2F;&#x2F;rep.setHeader(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);</span><br><span class="line">rep.setHeader(&quot;Access-Control-Expose-Headers&quot;, jwtProperties.getHeader());</span><br><span class="line">&#x2F;&#x2F; 允许的访问方法</span><br><span class="line">rep.setHeader(&quot;Access-Control-Allow-Methods&quot;, &quot;POST, GET, PUT, OPTIONS, DELETE, PATCH&quot;);</span><br><span class="line">&#x2F;&#x2F; Access-Control-Max-Age 用于 CORS 相关配置的缓存</span><br><span class="line">rep.setHeader(&quot;Access-Control-Max-Age&quot;, &quot;3600&quot;);</span><br><span class="line">rep.setHeader(&quot;Access-Control-Allow-Headers&quot;, &quot;token, Origin, X-Requested-With, Content-Type, Accept&quot;);</span><br><span class="line">&#x2F;&#x2F;若要返回cookie、携带seesion等信息则将此项设置我true</span><br><span class="line">rep.setHeader(&quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot;);</span><br><span class="line">&#x2F;&#x2F; 把获取的Session返回个前端Cookie</span><br><span class="line">&#x2F;&#x2F;rep.addCookie(new Cookie(&quot;JSSESIONID&quot;, session.getId()));</span><br><span class="line">chain.doFilter(req, rep);</span><br></pre></td></tr></table></figure>
<p>到此，完成。<br>如果是其他语言，解决方式都是类似，这篇文章包含了多种语言的处理方式。<br><a href="https://segmentfault.com/a/1190000012469713" target="_blank" rel="noopener">https://segmentfault.com/a/1190000012469713</a></p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/04/23/Hibernate%20Validator%E6%A0%A1%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/23/Hibernate%20Validator%E6%A0%A1%E9%AA%8C/" itemprop="url">Hibernate Validator</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-23T12:00:53+08:00">
                2019-04-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hibernate/" itemprop="url" rel="index">
                    <span itemprop="name">hibernate</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在日常开发中，Hibernate Validator经常用来验证bean的字段，基于注解，方便快捷高效。</p>
<h2 id="1、Bean-Validation-中内置的-constraint"><a href="#1、Bean-Validation-中内置的-constraint" class="headerlink" title="1、Bean Validation 中内置的 constraint"></a>1、Bean Validation 中内置的 constraint</h2><pre><code>@Valid        被注释的元素是一个对象，需要检查此对象的所有字段值
@Null        被注释的元素必须为 null
@NotNull        被注释的元素必须不为 null
@AssertTrue        被注释的元素必须为 true
@AssertFalse        被注释的元素必须为 false
@Min(value)        被注释的元素必须是一个数字，其值必须大于等于指定的最小值
@Max(value)        被注释的元素必须是一个数字，其值必须小于等于指定的最大值
@DecimalMin(value)    被注释的元素必须是一个数字，其值必须大于等于指定的最小值
@DecimalMax(value)    被注释的元素必须是一个数字，其值必须小于等于指定的最大值
@Size(max, min)    被注释的元素的大小必须在指定的范围内
@Digits (integer, fraction)    被注释的元素必须是一个数字，其值必须在可接受的范围内
@Past    被注释的元素必须是一个过去的日期
@Future    被注释的元素必须是一个将来的日期
@Pattern(value)    被注释的元素必须符合指定的正则表达式</code></pre><h2 id="2、Hibernate-Validator-附加的-constraint"><a href="#2、Hibernate-Validator-附加的-constraint" class="headerlink" title="2、Hibernate Validator 附加的 constraint"></a>2、Hibernate Validator 附加的 constraint</h2><pre><code>@Email    被注释的元素必须是电子邮箱地址
@Length(min=, max=)    被注释的字符串的大小必须在指定的范围内
@NotEmpty    被注释的字符串的必须非空
@Range(min=, max=)    被注释的元素必须在合适的范围内
@NotBlank    被注释的字符串的必须非空
@URL(protocol=,host=,    port=, regexp=, flags=)    被注释的字符串必须是一个有效的url
@CreditCardNumber    被注释的字符串必须通过Luhn校验算法，银行卡，信用卡等号码一般都用Luhn计算合法性
@ScriptAssert(lang=, script=, alias=)    要有Java Scripting API 即JSR 223 (&quot;Scripting for the JavaTM Platform&quot;)的实现
@SafeHtml(whitelistType=, additionalTags=)    classpath中要有jsoup包</code></pre><p>主要区分下@NotNull  @NotEmpty  @NotBlank 3个注解的区别：</p>
<pre><code>@NotNull           任何对象的value不能为null，通常用在基本类型上
@NotEmpty       用在集合类上面 集合对象的元素不为0，即集合不为空，也可以用于字符串不为null
@NotBlank        用在String上面 只能用于字符串不为null，并且字符串trim()以后length要大于0</code></pre><p>使用</p>
<p>在实体类的属性中添加注解。<br>之后在统一异常处理类中，进一步解析异常，返回前台信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 数据校验</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@ExceptionHandler</span>(BindException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">   @<span class="title">ResponseBody</span></span></span><br><span class="line"><span class="class">   <span class="title">public</span> <span class="title">RetViewModel</span> <span class="title">methodArgumentNotValidHandler</span>(<span class="title">BindException</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">       logger.error(Constants.BAD_REQUEST, e);</span><br><span class="line">       BindingResult bindingResult = e.getBindingResult();</span><br><span class="line">       Map&lt;String, Object&gt; map = getErrors(bindingResult);</span><br><span class="line">       RetViewModel responseResult = <span class="keyword">new</span> RetViewModel(HttpStatus.BAD_REQUEST.value(),map.values().toString(),<span class="keyword">null</span>);</span><br><span class="line">       <span class="keyword">return</span> responseResult;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">private</span> Map&lt;String, Object&gt; <span class="title">getErrors</span><span class="params">(BindingResult result)</span> </span>&#123;</span><br><span class="line">       Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">       List&lt;FieldError&gt; list = result.getFieldErrors();</span><br><span class="line">       <span class="keyword">for</span> (FieldError error : list) &#123;</span><br><span class="line">           map.put(error.getField(), error.getDefaultMessage());</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> map;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>控制器中，直接在对应bean上增加注解@Valid</p>
<p>具体分析如下：</p>
<h3 id="1、简单的demo-配置校验"><a href="#1、简单的demo-配置校验" class="headerlink" title="1、简单的demo  配置校验"></a>1、简单的demo  配置校验</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidatorConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalValidatorFactoryBean <span class="title">localValidatorFactoryBean</span><span class="params">()</span></span>&#123;</span><br><span class="line">        LocalValidatorFactoryBean localValidatorFactoryBean = <span class="keyword">new</span> LocalValidatorFactoryBean();</span><br><span class="line">        localValidatorFactoryBean.setProviderClass(org.hibernate.validator.HibernateValidator<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        localValidatorFactoryBean.setValidationMessageSource(reloadableResourceBundleMessageSource());</span><br><span class="line">        <span class="keyword">return</span> localValidatorFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ReloadableResourceBundleMessageSource <span class="title">reloadableResourceBundleMessageSource</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ReloadableResourceBundleMessageSource r = <span class="keyword">new</span> ReloadableResourceBundleMessageSource();</span><br><span class="line">        r.setBasename(<span class="string">"classpath:validationMessages.properties"</span>);<span class="comment">//资源文件</span></span><br><span class="line">        <span class="comment">//r.setFileEncodings();</span></span><br><span class="line">        r.setDefaultEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">        r.setCacheSeconds(<span class="number">120</span>);<span class="comment">//资源内容缓存时间</span></span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>资源文件内容如：</p>
<p>notnull=该字段不能为空</p>
<p>验证的model里面对字段进行验证</p>
<pre><code>@NotBlank(message = &quot;{notnull}&quot;)
private String name;</code></pre><p>使用，加入注解即可@Valid</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo</span><span class="params">(@Valid Demo demo, BindingResult result)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(result.hasErrors())&#123;</span><br><span class="line">        <span class="keyword">for</span> (ObjectError error : result.getAllErrors()) &#123;</span><br><span class="line">            System.out.println(error.getDefaultMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通常不在控制器方法中写BindingResult，统一放到类去处理，如上面的统一异常处理类。</p>
<h3 id="2、hibernate的校验模式"><a href="#2、hibernate的校验模式" class="headerlink" title="2、hibernate的校验模式"></a>2、hibernate的校验模式</h3><p>普通模式（默认是这个模式）：会校验完所有的属性，然后返回所有的验证失败信息；快速失败返回模式：只要有一个验证失败，则返回。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Validator <span class="title">validator</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ValidatorFactory validatorFactory = Validation.byProvider( HibernateValidator<span class="class">.<span class="keyword">class</span> )</span></span><br><span class="line"><span class="class">            .<span class="title">configure</span>()</span></span><br><span class="line">            .addProperty( "hibernate.validator.fail_fast", "true" )</span><br><span class="line">            .buildValidatorFactory();</span><br><span class="line">    Validator validator = validatorFactory.getValidator();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*ValidatorFactory validatorFactory = Validation.byProvider( HibernateValidator.class )</span></span><br><span class="line"><span class="comment">            .configure()</span></span><br><span class="line"><span class="comment">            .failFast( true )</span></span><br><span class="line"><span class="comment">            .buildValidatorFactory();</span></span><br><span class="line"><span class="comment">    Validator validator = validatorFactory.getValidator();*/</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> validator;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3、hibernate的两种校验"><a href="#3、hibernate的两种校验" class="headerlink" title="3、hibernate的两种校验"></a>3、hibernate的两种校验</h2><h3 id="请求参数校验和GET参数校验"><a href="#请求参数校验和GET参数校验" class="headerlink" title="请求参数校验和GET参数校验"></a>请求参数校验和GET参数校验</h3><p>请求参数校验，在控制器方法中加注解 @Valid，然后后面加BindindResult，有多个参数对应加多个注解和BindindResult<br>GET参数校验(@RequestParam参数校验)</p>
<p>如果是参数较少的情况下：</p>
<p>public void demo(@RequestParam int grade,@RequestParam int classroom) {}</p>
<p>使用@Valid注解，对RequestParam对应的参数进行注解，是无效的，需要使用@Validated注解来使得验证生效。</p>
<p>需要使用MethodValidationPostProcessor 的Bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MethodValidationPostProcessor <span class="title">methodValidationPostProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//MethodValidationPostProcessor默认是普通模式，配置的validator不会生效，通过配置Validator使用validator的快速方式</span></span><br><span class="line">    MethodValidationPostProcessor postProcessor = <span class="keyword">new</span> MethodValidationPostProcessor();</span><br><span class="line">    postProcessor.setValidator(validator());</span><br><span class="line">    <span class="keyword">return</span> postProcessor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Validator <span class="title">validator</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ValidatorFactory validatorFactory = Validation.byProvider( HibernateValidator<span class="class">.<span class="keyword">class</span> )</span></span><br><span class="line"><span class="class">            .<span class="title">configure</span>()</span></span><br><span class="line">            .addProperty( "hibernate.validator.fail_fast", "true" )</span><br><span class="line">            .buildValidatorFactory();</span><br><span class="line">    Validator validator = validatorFactory.getValidator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> validator;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用：在控制器上加上注解，方法参数直接使用校验规则</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoController</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 直接在方法参数上使用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/student"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">validate1</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            @Size(min = <span class="number">1</span>,max = <span class="number">10</span>,message = <span class="string">"姓名长度必须为1到10"</span>)</span>@<span class="title">RequestParam</span><span class="params">(<span class="string">"name"</span>)</span> String name,</span></span><br><span class="line"><span class="function">            @<span class="title">Min</span><span class="params">(value = <span class="number">10</span>,message = <span class="string">"年龄最小为10"</span>)</span>@<span class="title">Max</span><span class="params">(value = <span class="number">100</span>,message = <span class="string">"年龄最大为100"</span>)</span> @<span class="title">RequestParam</span><span class="params">(<span class="string">"age"</span>)</span> Integer age,</span></span><br><span class="line"><span class="function">            @Future @<span class="title">RequestParam</span><span class="params">(<span class="string">"birth"</span>)</span>@<span class="title">DateTimeFormat</span><span class="params">(pattern = <span class="string">"yyyy-MM-dd hh:mm:ss"</span>)</span> Date birth)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>统一处理验证不通过的信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExceptionHandler</span>(ConstraintViolationException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ResponseBody</span></span></span><br><span class="line"><span class="class">@<span class="title">ResponseStatus</span>(<span class="title">HttpStatus</span>.<span class="title">BAD_REQUEST</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">String</span> <span class="title">handle</span>(<span class="title">ConstraintViolationException</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">    Set&lt;ConstraintViolation&lt;?&gt;&gt; violations = e.getConstraintViolations();</span><br><span class="line">    <span class="keyword">for</span> (ConstraintViolation&lt;?&gt; item : violations) &#123;</span><br><span class="line">        item.getMessage();<span class="comment">//验证不通过信息</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"bad request, "</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4、实体对象校验"><a href="#4、实体对象校验" class="headerlink" title="4、实体对象校验"></a>4、实体对象校验</h2><p>实体类中的属性增加对应的规则</p>
<p>方法中可以通过代码直接校验对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;ConstraintViolation&lt;Demo&gt;&gt; violationSet = validator.validate(demo);</span><br><span class="line"><span class="keyword">for</span> (ConstraintViolation&lt;Demo&gt; model : violationSet) &#123;</span><br><span class="line">    System.out.println(model.getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5、对象联级校验"><a href="#5、对象联级校验" class="headerlink" title="5、对象联级校验"></a>5、对象联级校验</h2><p>对象内部包含另一个对象作为属性，属性上加@Valid，可以验证作为属性的对象内部的验证：</p>
<pre><code>@Valid
private Demo demo;</code></pre><p>校验方式和上面一致。</p>
<h2 id="6、分组校验"><a href="#6、分组校验" class="headerlink" title="6、分组校验"></a>6、分组校验</h2><p>分组顺序校验时，按指定的分组先后顺序进行验证，前面的验证不通过，后面的分组就不行验证。</p>
<p>设置validator为普通验证模式（”hibernate.validator.fail_fast”, “false”）</p>
<p>两个组GroupA、GroupB：</p>
<pre><code>public interface GroupA {}

public interface GroupB {
}</code></pre><p>实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NotBlank</span></span><br><span class="line"><span class="meta">@Range</span>(min = <span class="number">1</span>,max = Integer.MAX_VALUE,message = <span class="string">"必须大于0"</span>,groups = &#123;GroupA<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">private</span> <span class="title">Integer</span> <span class="title">userId</span></span>;</span><br><span class="line"><span class="meta">@NotBlank</span></span><br><span class="line"><span class="meta">@Length</span>(min = <span class="number">4</span>,max = <span class="number">20</span>,message = <span class="string">"必须在[4,20]"</span>,groups = &#123;GroupB<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">private</span> <span class="title">String</span> <span class="title">userName</span></span>;</span><br><span class="line"><span class="meta">@NotBlank</span></span><br><span class="line"><span class="meta">@Range</span>(min = <span class="number">0</span>,max = <span class="number">100</span>,message = <span class="string">"年龄必须在[0,100]"</span>,groups=&#123;Default<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br></pre></td></tr></table></figure>
<pre><code>GroupA验证字段userId；
GroupB验证字段userName、sex；
Default验证字段age(Default是Validator自带的默认分组)</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo5</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Student s = <span class="keyword">new</span> Student();</span><br><span class="line">    <span class="comment">//GroupA验证不通过</span></span><br><span class="line">    s.setUserId(-<span class="number">12</span>);</span><br><span class="line">    <span class="comment">//GroupA验证通过</span></span><br><span class="line">    <span class="comment">//p.setUserId(12);</span></span><br><span class="line">    s.setUserName(<span class="string">"a"</span>);</span><br><span class="line">    s.setAge(<span class="number">110</span>);</span><br><span class="line">    s.setSex(<span class="number">5</span>);</span><br><span class="line">    Set&lt;ConstraintViolation&lt;Student&gt;&gt; validate = validator.validate(s, GroupA<span class="class">.<span class="keyword">class</span>, <span class="title">GroupB</span>.<span class="title">class</span>)</span>;</span><br><span class="line">    <span class="keyword">for</span> (ConstraintViolation&lt;Student&gt; item : validate) &#123;</span><br><span class="line">        System.out.println(item);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果在参数中使用bean，加入注解即可：@Validated({GroupA.class, GroupB.class})</p>
<p>如果使用组验证顺序：</p>
<pre><code>@GroupSequence({GroupA.class, GroupB.class, Default.class})
    public interface GroupOrder {
}</code></pre><p>定义好，使用时，直接用GroupOrder</p>
<h2 id="7、自定义验证器"><a href="#7、自定义验证器" class="headerlink" title="7、自定义验证器"></a>7、自定义验证器</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义一个注解用来校验</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD, ElementType.FIELD, ElementType.ANNOTATION_TYPE, ElementType.CONSTRUCTOR, ElementType.PARAMETER&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Constraint</span>(validatedBy = &#123;ValidatorDemo<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">ValidateDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> "Not Null"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] groups() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends Payload&gt;[] payload() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidatorDemo</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">ValidateDemo</span>, <span class="title">Student</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用于初始化注解上的值到这个validator</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(ValidateDemo constraintAnnotation)</span> </span>&#123;</span><br><span class="line">        name =constraintAnnotation.name();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 具体的校验逻辑</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(Student value, ConstraintValidatorContext context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name ==<span class="keyword">null</span> || name.equals(value.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就可以直接使用@ValidateDemo在属性或者参数上校验，类似@NotBlank，@Max一样的使用方式。</p>
<p>参考：<a href="http://docs.jboss.org/hibernate/validator/4.2/reference/zh-CN/html_single/#validator-gettingstarted" target="_blank" rel="noopener">http://docs.jboss.org/hibernate/validator/4.2/reference/zh-CN/html_single/#validator-gettingstarted</a></p>
<p>以上是Hibernate Validator校验方式，一般还可以用拦截器实现，比如创建一个校验注解来实现（针对单一参数）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;ElementType.PARAMETER&#125;)<span class="comment">//参数级别</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME) <span class="comment">//注解保留到运行阶段</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ParamsNotNull &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拦截器，直接在参数上就可以校验参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CheckParamsInterceptor</span> <span class="keyword">extends</span> <span class="title">HandlerInterceptorAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(CheckParamsInterceptor<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!(handler <span class="keyword">instanceof</span> HandlerMethod)) &#123;</span><br><span class="line">            logger.warn(<span class="string">"UnSupport handler"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;String&gt; list = getParamsName((HandlerMethod) handler);</span><br><span class="line">        <span class="keyword">for</span> (String s : list) &#123;</span><br><span class="line">            String parameter = request.getParameter(s);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isEmpty(parameter)) &#123;</span><br><span class="line">                <span class="comment">//可以增加更多的规则，还可以吧规则交给注解去定义</span></span><br><span class="line">                JSONObject jsonObject = <span class="keyword">new</span> JSONObject();</span><br><span class="line">                jsonObject.put(<span class="string">"status"</span>, <span class="number">202</span>);</span><br><span class="line">                jsonObject.put(<span class="string">"msg"</span>, <span class="string">"缺少必要参数"</span>);</span><br><span class="line">                response.setHeader(<span class="string">"Content-type"</span>, <span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">                response.setHeader(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"*"</span>);<span class="comment">//跨域</span></span><br><span class="line">                response.getWriter().write(jsonObject.toJSONString());</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取使用了该注解的参数名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List <span class="title">getParamsName</span><span class="params">(HandlerMethod handlerMethod)</span> </span>&#123;</span><br><span class="line">        Parameter[] parameters = handlerMethod.getMethod().getParameters();</span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Parameter parameter : parameters) &#123;</span><br><span class="line">            <span class="keyword">if</span> (parameter.isAnnotationPresent(ParamsNotNull<span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">                list.add(parameter.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebMvcConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line">    CheckParamsInterceptor checkSourceInterceptor = <span class="keyword">new</span> CheckParamsInterceptor();</span><br><span class="line">    <span class="comment">//增加校验拦截器</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addInterceptor(checkSourceInterceptor).addPathPatterns(<span class="string">"/**"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//跨域</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addMapping(<span class="string">"/**"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就可以在控制器方法上对应参数加上注解即可。</p>
<p>还有一些spring mvc一定定义好的一些异常，通过统一处理异常的方式去校验参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//参数类型不匹配</span></span><br><span class="line"><span class="comment">//getPropertyName()获取数据类型不匹配参数名称</span></span><br><span class="line"><span class="comment">//getRequiredType()实际要求客户端传递的数据类型</span></span><br><span class="line"><span class="meta">@ExceptionHandler</span>(&#123;TypeMismatchException<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">@<span class="title">ResponseBody</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">String</span> <span class="title">requestTypeMismatch</span>(<span class="title">TypeMismatchException</span> <span class="title">ex</span>)</span>&#123;</span><br><span class="line">    ex.printStackTrace();</span><br><span class="line">    <span class="keyword">return</span> outputJson(<span class="number">400</span>, <span class="string">"参数类型不匹配,参数"</span> + ex.getPropertyName() + <span class="string">"类型应该为"</span> + ex.getRequiredType());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//缺少参数异常</span></span><br><span class="line"><span class="comment">//getParameterName() 缺少的参数名称</span></span><br><span class="line"><span class="meta">@ExceptionHandler</span>(&#123;MissingServletRequestParameterException<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">@<span class="title">ResponseBody</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">String</span> <span class="title">requestMissingServletRequest</span>(<span class="title">MissingServletRequestParameterException</span> <span class="title">ex</span>)</span>&#123;</span><br><span class="line">    ex.printStackTrace();</span><br><span class="line">    <span class="keyword">return</span> outputJson(<span class="number">400</span>, <span class="string">"缺少必要参数,参数名称为"</span> + ex.getParameterName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码见：<br><a href="https://github.com/huingsn/tech-point-record.git中的springboot-validation-demo" target="_blank" rel="noopener">https://github.com/huingsn/tech-point-record.git中的springboot-validation-demo</a></p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/">上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><a class="extend next" rel="next" href="/page/5/">下一页</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://img.huyunshun.com/img/20200522182348.png"
                alt="初晨" />
            
              <p class="site-author-name" itemprop="name">初晨</p>
              <p class="site-description motion-element" itemprop="description">永远不要说你知道本质，更别说真相了。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">249</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">46</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">109</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          
<!--近期文章版块-->
            
                <div class="links-of-blogroll motion-element links-of-blogroll-block">
                  <div class="links-of-blogroll-title">
                    <!-- modify icon to fire by szw -->
                    <i class="fa fa-history fa-" aria-hidden="true"></i>
                    近期文章
                  </div>
                  <ul class="links-of-blogroll-list">
                    
                    
                      <li>
                        <a href="/2020/05/22/WebSocket%E3%80%81Socket%E3%80%81TCP%E3%80%81HTTP%E5%8C%BA%E5%88%AB/" title="WebSocket、Socket、TCP、HTTP区别" target="_blank">WebSocket、Socket、TCP、HTTP区别</a>
                      </li>
                    
                      <li>
                        <a href="/2020/05/19/Springboot%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%8E%A5%E5%8F%A3%E9%98%B2%E5%88%B7/" title="Springboot项目的接口防刷" target="_blank">Springboot项目的接口防刷</a>
                      </li>
                    
                      <li>
                        <a href="/2020/05/03/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Volatile%E5%85%B3%E9%94%AE%E5%AD%97%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" title="深入理解Volatile关键字及其实现原理" target="_blank">深入理解Volatile关键字及其实现原理</a>
                      </li>
                    
                      <li>
                        <a href="/2020/04/20/%E4%BD%BF%E7%94%A8vscode%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0%E7%8E%AF%E5%A2%83/" title="使用vscode搭建个人笔记环境" target="_blank">使用vscode搭建个人笔记环境</a>
                      </li>
                    
                      <li>
                        <a href="/2020/01/20/HBase%E4%BB%8B%E7%BB%8D%E5%AE%89%E8%A3%85%E4%B8%8E%E6%93%8D%E4%BD%9C/" title="HBase介绍安装与操作" target="_blank">HBase介绍安装与操作</a>
                      </li>
                    
                  </ul>
                </div>
            
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Copyright</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  


</body>
</html>
