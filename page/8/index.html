<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="永远不要说你知道本质，更别说真相了。">
<meta property="og:type" content="website">
<meta property="og:title" content="简">
<meta property="og:url" content="https://huyunshun.com/page/8/index.html">
<meta property="og:site_name" content="简">
<meta property="og:description" content="永远不要说你知道本质，更别说真相了。">
<meta property="article:author" content="初晨">
<meta property="article:tag" content="编程">
<meta property="article:tag" content="开发">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://huyunshun.com/page/8/"/>





  <title>简</title>
  








  <script type="text/javascript" src="/js/src/love.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">

  <!-- 看板娘 -->
    
        <script async src="/live2d-widget/autoload.js"></script>
    
 <!-- 飘动的彩带） -->
  <script src="/js/src/piao.js" type="text/javascript"></script>
<meta name="generator" content="Hexo 4.2.1"></head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">简</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">人生短暂，学海无边，而大道至简。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/04/01/NodeJS%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E5%8F%8AExpress%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/01/NodeJS%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E5%8F%8AExpress%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D/" itemprop="url">NodeJS安装配置及Express基本介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-01T00:00:00+08:00">
                2019-04-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Node-js简介"><a href="#Node-js简介" class="headerlink" title="Node.js简介"></a>Node.js简介</h1><p>简单的说 Node.js 就是运行在服务端的 JavaScript。Node.js 是一个基于 Chrome V8 引擎的 JavaScript 运行环境。Node.js 使用了一个事件驱动、非阻塞式 I/O 的模型，使其轻量又高效。Node.js 的包管理器 npm，是全球最大的开源库生态系统。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">安装环境</span><br><span class="line">本机系统：Windows 7</span><br><span class="line">NODEJS版本：node-v10.14.0-x64</span><br></pre></td></tr></table></figure>
<p>步骤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1、下载对应你系统的Node.js版本:https:&#x2F;&#x2F;nodejs.org&#x2F;en&#x2F;download&#x2F;</span><br><span class="line">2、选安装目录进行安装</span><br><span class="line">3、环境配置</span><br><span class="line">4、测试</span><br></pre></td></tr></table></figure>
<h1 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h1><p><img src="https://img.huyunshun.com/img1/194611-20181129173245817-852443677.png" alt=""></p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>Windows上安装时务必选择全部组件，包括勾选Add to Path，更改自己需要的安装目录。</p>
<p><img src="https://img.huyunshun.com/img1/194611-20181129173348943-146303304.png" alt=""></p>
<p>安装完成后安装目录有nodejs的文件：</p>
<p><img src="https://img.huyunshun.com/img1/194611-20181129174436210-845981413.png" alt=""></p>
<p>测试安装是否成功了：【win+R】键，输入cmd，然后回车，打开cmd窗口。</p>
<p><img src="https://img.huyunshun.com/img1/194611-20181129173740384-2069475975.png" alt=""></p>
<p>分别输入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node -v</span><br><span class="line">npm -v</span><br></pre></td></tr></table></figure>
<p><img src="https://img.huyunshun.com/img1/194611-20181129174117244-1134849807.png" alt=""></p>
<p>显示出版本信息，说明安装成功！</p>
<h1 id="NPM"><a href="#NPM" class="headerlink" title="NPM"></a>NPM</h1><p>npm是什么？</p>
<p>npm是Node.js的包管理工具（package manager）。npm的作用就是对Node.js依赖的包进行管理，也可以理解为用来安装/卸载Node.js需要装的东西，在Node.js上开发时，会用到很多别人写的JavaScript代码包。如果我们要使用别人的包，每次都要去搜索——下载——解压——使用，这样非常麻烦。于是出现了这个集中管理的工具，大家都把自己开发的模块打包后放到npm官网上，如果别人需要，直接通过npm安装就可以使用了。<br>npm还可以根据包的依赖关系，把所有依赖的包都下载并管理起来。新版的Node.js已自带npm，安装Node.js时会一起安装。</p>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><p>主要配置的是npm安装的全局模块所在的路径，以及缓存cache的路径。是因为以后在执行类似：npm install express [-g]（后面的可选参数-g，g代表global全局安装的意思）的安装语句时，会将安装的模块安装到【C:\Users\用户名\AppData\Roaming\npm】默认路径中。</p>
<p>将全模块所在路径和缓存路径放在我node.js安装的文件夹中，再安装目录下创建两个文件夹【node_global】及【node_cache】：</p>
<p><img src="https://img.huyunshun.com/img1/194611-20181129181056416-1906347011.png" alt=""></p>
<p>创建完两个空文件夹之后，打开cmd命令窗口，输入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm config set prefix &quot;XXXXXX\nodejs\node_global</span><br><span class="line">npm config set cache &quot;XXXXX\nodejs\node_cache</span><br></pre></td></tr></table></figure>
<p>XXXXX是你nodejs文件路径</p>
<p><img src="https://img.huyunshun.com/img1/194611-20181129181637580-1965005708.png" alt=""></p>
<p>设置环境变量</p>
<p>　　window7等老版本windows的编辑环境变量的方式，很麻烦，一不小心，漏了个分号，都会弄得自己怀疑人生。</p>
<p>　　下载了&nbsp;Rapid Environment Editor 这个小工具，就可以很方便的在window7及以下版本编辑环境变量了。</p>
<p>　　下载地址：<a href="https://www.rapidee.com/en/download" target="_blank" rel="noopener">https://www.rapidee.com/en/download</a>           按计算机是32还是64位下载对应版本</p>
<p>打开软件</p>
<p>【系统变量】下右键新建一个变量【NODE_PATH】，值为C:\AdministratorProgramFiles\nodejs\node_modules</p>
<p><img src="https://img.huyunshun.com/img1/194611-20181129182412766-321153255.png" alt=""></p>
<p>【用户变量】下的【Path】中的这一项C:\Users\用户名\AppData\Roaming\npm 修改为C:\AdministratorProgramFiles\nodejs\node_global</p>
<p><img src="https://img.huyunshun.com/img1/194611-20181129182720024-1458059380.png" alt=""></p>
<p>配置完后，安装个module测试下，我们就安装最常用的express模块，打开cmd窗口，<br />输入如下命令进行模块的全局安装：</p>
<p>npm install express -g# -g是全局安装的意思</p>
<p>安装完成后可以看到C:\AdministratorProgramFiles\nodejs\node_global\node_modules下有express模块</p>
<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><p>此时，nodejs安装环境配置完毕，由于nodejs是运行在服务端的，所以编写的JavaScript代码将不能在浏览器环境中执行了，而是在Node环境中执行。</p>
<p>因此，JavaScript代码将直接在你的计算机上以命令行的方式运行，所以，我们要先选择一个文本编辑器来编写JavaScript代码，并且把它保存到本地硬盘的某个目录，才能够执行。</p>
<p>&nbsp;用电脑上安装的编辑器编写代码测试。我用Notepad++，注意用UTF-8格式保存。</p>
<p>输入以下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">console.log(&#39;Hello, world！&#39;);</span><br></pre></td></tr></table></figure>
<p>第一行写上&apos;use strict&apos;，是因为我们总是以严格模式运行JavaScript代码，避免各种潜在陷阱。</p>
<p>然后，选择一个目录保存为helloworld.js，必须要以.js结尾，就可以打开命令行窗口，把当前目录切换到helloworld.js所在目录，运行这个程序：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">G:\NodeJs node helloworld.js</span><br><span class="line">Hello, world！</span><br></pre></td></tr></table></figure>
<p><img src="https://img.huyunshun.com/img1/194611-20181129184052166-628609956.png" alt=""></p>
<p>至此，NodeJS下载安装配置环境，测试都完成。</p>
<h1 id="Express"><a href="#Express" class="headerlink" title="Express"></a>Express</h1><p>Express是基于Nodejs的官方Web开发库，每年升级一个大版本，在Express4时，替换掉中件间库connect，而改用多个更细粒度的库来取代。<br>首先，我们需要安装express库。在Express3.6.x之前的版本，Express需要全局安装的，项目构建器模块是合并在Express项目中的，后来这个构建器被拆分出来，独立成为了一个项目express-generator，现在我们只需要全局安装express-generator项目就行了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g express-generator@4  #全局安装-g</span><br></pre></td></tr></table></figure>
<p>安装后可以看到全局模块：<br><img src="https://img.huyunshun.com/img1/imgclip_1.png" alt=""></p>
<h1 id="IDE工程结构"><a href="#IDE工程结构" class="headerlink" title="IDE工程结构"></a>IDE工程结构</h1><p>使用WebStorm创建一个基于Express项目：<br><img src="https://img.huyunshun.com/img1/imgclip2dfsdf.png" alt=""><br>目录结构：   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bin, 存放启动项目的脚本文件</span><br><span class="line">node_modules, 存放所有的项目依赖库。</span><br><span class="line">public，静态文件(css,js,img)</span><br><span class="line">routes，路由文件(MVC中的C,controller)</span><br><span class="line">views，页面文件(Ejs模板)</span><br><span class="line">package.json，项目依赖配置及开发者信息</span><br><span class="line">app.js，应用核心配置文件</span><br></pre></td></tr></table></figure>
<p><img src="https://img.huyunshun.com/img1/imgclip_2.png" alt="">    </p>
<h2 id="package-json项目配置"><a href="#package-json项目配置" class="headerlink" title="package.json项目配置"></a>package.json项目配置</h2><p>package.json用于项目依赖配置及开发者信息，scripts属性是用于定义操作命令的，可以非常方便的增加启动命令，比如默认的start，用npm start代表执行node ./bin/www命令。   </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"express-study"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"0.0.0"</span>,</span><br><span class="line">  <span class="attr">"private"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"start"</span>: <span class="string">"node ./bin/www"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"cookie-parser"</span>: <span class="string">"~1.4.4"</span>,</span><br><span class="line">    <span class="attr">"debug"</span>: <span class="string">"~2.6.9"</span>,</span><br><span class="line">    <span class="attr">"express"</span>: <span class="string">"~4.16.1"</span>,</span><br><span class="line">    <span class="attr">"http-errors"</span>: <span class="string">"~1.6.3"</span>,</span><br><span class="line">    <span class="attr">"morgan"</span>: <span class="string">"~1.9.1"</span>,</span><br><span class="line">    <span class="attr">"pug"</span>: <span class="string">"2.0.0-beta11"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="app-js核心文件"><a href="#app-js核心文件" class="headerlink" title="app.js核心文件"></a>app.js核心文件</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载依赖库，原来这个类库都封装在connect中，现在需地注单独加载</span></span><br><span class="line"><span class="keyword">var</span> createError = <span class="built_in">require</span>(<span class="string">'http-errors'</span>);</span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> cookieParser = <span class="built_in">require</span>(<span class="string">'cookie-parser'</span>);</span><br><span class="line"><span class="keyword">var</span> logger = <span class="built_in">require</span>(<span class="string">'morgan'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载路由控制</span></span><br><span class="line"><span class="keyword">var</span> indexRouter = <span class="built_in">require</span>(<span class="string">'./routes/index'</span>);</span><br><span class="line"><span class="keyword">var</span> usersRouter = <span class="built_in">require</span>(<span class="string">'./routes/users'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建项目实例</span></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义pug模板引擎和模板文件位置，也可以使用ejs或其他模型引擎</span></span><br><span class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'pug'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义日志和输出级别</span></span><br><span class="line">app.use(logger(<span class="string">'dev'</span>));</span><br><span class="line"><span class="comment">// 定义数据解析器</span></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(express.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line"><span class="comment">// 定义cookie解析器</span></span><br><span class="line">app.use(cookieParser());</span><br><span class="line"><span class="comment">// 定义静态文件目录</span></span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 匹配路径和路由</span></span><br><span class="line">app.use(<span class="string">'/'</span>, indexRouter);</span><br><span class="line">app.use(<span class="string">'/users'</span>, usersRouter);</span><br><span class="line"></span><br><span class="line"><span class="comment">// catch 404 and forward to error handler</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  next(createError(<span class="number">404</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// error handler</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// set locals, only providing error in development</span></span><br><span class="line">  res.locals.message = err.message;</span><br><span class="line">  res.locals.error = req.app.get(<span class="string">'env'</span>) === <span class="string">'development'</span> ? err : &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// render the error page</span></span><br><span class="line">  res.status(err.status || <span class="number">500</span>);</span><br><span class="line">  res.render(<span class="string">'error'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出模型app</span></span><br><span class="line"><span class="built_in">module</span>.exports = app;</span><br></pre></td></tr></table></figure>
<p>www文件也是一个node的脚本，用于分离配置和启动程序。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env node</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Module dependencies.</span></span><br><span class="line"><span class="comment"> * 加载依赖</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">'../app'</span>);</span><br><span class="line"><span class="keyword">var</span> debug = <span class="built_in">require</span>(<span class="string">'debug'</span>)(<span class="string">'express-study:server'</span>);</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get port from environment and store in Express.</span></span><br><span class="line"><span class="comment"> * 定义启动端口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> port = normalizePort(process.env.PORT || <span class="string">'3000'</span>);</span><br><span class="line">app.set(<span class="string">'port'</span>, port);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create HTTP server.</span></span><br><span class="line"><span class="comment"> *  创建HTTP服务器实例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(app);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Listen on provided port, on all network interfaces.</span></span><br><span class="line"><span class="comment"> * 启动网络服务监听端口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">server.listen(port);</span><br><span class="line">server.on(<span class="string">'error'</span>, onError);</span><br><span class="line">server.on(<span class="string">'listening'</span>, onListening);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Normalize a port into a number, string, or false.</span></span><br><span class="line"><span class="comment"> *  端口标准化函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizePort</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> port = <span class="built_in">parseInt</span>(val, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">isNaN</span>(port)) &#123;</span><br><span class="line">    <span class="comment">// named pipe</span></span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (port &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// port number</span></span><br><span class="line">    <span class="keyword">return</span> port;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Event listener for HTTP server "error" event.</span></span><br><span class="line"><span class="comment"> * HTTP异常事件处理函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onError</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (error.syscall !== <span class="string">'listen'</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> error;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> bind = <span class="keyword">typeof</span> port === <span class="string">'string'</span></span><br><span class="line">    ? <span class="string">'Pipe '</span> + port</span><br><span class="line">    : <span class="string">'Port '</span> + port;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// handle specific listen errors with friendly messages</span></span><br><span class="line">  <span class="keyword">switch</span> (error.code) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'EACCES'</span>:</span><br><span class="line">      <span class="built_in">console</span>.error(bind + <span class="string">' requires elevated privileges'</span>);</span><br><span class="line">      process.exit(<span class="number">1</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'EADDRINUSE'</span>:</span><br><span class="line">      <span class="built_in">console</span>.error(bind + <span class="string">' is already in use'</span>);</span><br><span class="line">      process.exit(<span class="number">1</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">throw</span> error;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Event listener for HTTP server "listening" event.</span></span><br><span class="line"><span class="comment"> * 事件绑定函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onListening</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> addr = server.address();</span><br><span class="line">  <span class="keyword">var</span> bind = <span class="keyword">typeof</span> addr === <span class="string">'string'</span></span><br><span class="line">    ? <span class="string">'pipe '</span> + addr</span><br><span class="line">    : <span class="string">'port '</span> + addr.port;</span><br><span class="line">  debug(<span class="string">'Listening on '</span> + bind);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行浏览：<br><img src="https://img.huyunshun.com/img1/imgclip_3.png" alt="">   </p>
<p>接下来，我们把index.ejs页面切分成3个部分：header.ejs, index.ejs, footer.ejs，用于网站页面的模块化。</p>
<p>header.ejs, 为页面的头部区域</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"zh-CN"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;&lt;%= title %&gt;&lt;<span class="regexp">/title&gt;</span></span><br><span class="line"><span class="regexp">    &lt;link rel="stylesheet" href="http:/</span><span class="regexp">/cdn.bootcss.com/</span>bootstrap/<span class="number">3.3</span><span class="number">.2</span>/css/bootstrap.min.css<span class="string">"&gt;</span></span><br><span class="line"><span class="string">    &lt;link rel='stylesheet' href='/stylesheets/style.css' /&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br></pre></td></tr></table></figure>
<p>index.ejs, 为内容显示区域</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;% include header.ejs %&gt;</span><br><span class="line"></span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"well jumbotron"</span>&gt;</span><br><span class="line">  &lt;h1&gt;&lt;%= title %&gt;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">  &lt;p&gt;hello&lt;/</span>p&gt;</span><br><span class="line">&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;% include footer.ejs %&gt;</span></span><br></pre></td></tr></table></figure>
<p>footer.ejs，为页面底部区域</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">"http://cdn.bootcss.com/jquery/1.11.2/jquery.min.js"</span>&gt;&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&lt;script src="http:/</span><span class="regexp">/cdn.bootcss.com/</span>bootstrap/<span class="number">3.3</span><span class="number">.2</span>/js/bootstrap.min.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="路由功能"><a href="#路由功能" class="headerlink" title="路由功能"></a>路由功能</h2><p>路由功能，是Express4以后全面改版的功能。在应用程序加载隐含路由中间件.   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app.route()函数，创建可链接的途径处理程序的路由路径。</span><br><span class="line">express.Router类，创建模块化安装路径的处理程序。</span><br></pre></td></tr></table></figure>
<p>app.route方法会返回一个Route实例，它可以继续使用所有的HTTP方法，包括get,post,all,put,delete,head等。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.route(<span class="string">'/users'</span>)</span><br><span class="line">  .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;&#125;)</span><br><span class="line">  .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;&#125;)</span><br></pre></td></tr></table></figure>
<p>express.Router类，则可以帮助我们更好的组织代码结构。<br>在app.js文件中，定义了app.use(‘/’, routes); routes是指向了routes目录下的index.js文件，./routes/index.js文件中，express.Router被定义使用，路径/*处理都会由routes/index.js文件里的Router来处理。如果我们要管理不同的路径，那么可以直接配置为多个不同的Router。</p>
<p>  app.use(‘/user’, require(‘./routes/user’).user);<br>  app.use(‘/admin’, require(‘./routes/admin’).admin);<br>  app.use(‘/‘, require(‘./routes’));</p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/03/23/%E4%BD%BF%E7%94%A8%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6%E8%A1%A5%E5%81%BF%E5%A4%84%E7%90%86%E5%AE%9E%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/23/%E4%BD%BF%E7%94%A8%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6%E8%A1%A5%E5%81%BF%E5%A4%84%E7%90%86%E5%AE%9E%E4%BE%8B/" itemprop="url">使用消息机制补偿处理实例</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-23T15:40:03+08:00">
                2019-03-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index">
                    <span itemprop="name">分布式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>分布式环境用，可以使用补偿机制实现解决一些问题，如通过下面发送邮件例子：   </p>
<h5 id="创建消息生产者"><a href="#创建消息生产者" class="headerlink" title="创建消息生产者"></a>创建消息生产者</h5><p>创建工程，具体如下：   </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.hu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>descout-buchang-producer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.32<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.6</span><span class="number">.238</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcucerApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        SpringApplication.run(ProcucerApplication<span class="class">.<span class="keyword">class</span>,<span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>rabbitmq配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FanoutConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 邮件队列</span></span><br><span class="line">    <span class="keyword">private</span> String FANOUT_EMAIL_QUEUE = <span class="string">"email_queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 短信队列</span></span><br><span class="line">    <span class="keyword">private</span> String FANOUT_SMS_QUEUE = <span class="string">"sms_queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fanout 交换机</span></span><br><span class="line">    <span class="keyword">private</span> String EXCHANGE_NAME = <span class="string">"fanoutExchange"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.定义邮件队列</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">fanOutEamilQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(FANOUT_EMAIL_QUEUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.定义短信队列</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">fanOutSmsQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(FANOUT_SMS_QUEUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.定义交换机</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">FanoutExchange <span class="title">fanoutExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FanoutExchange(EXCHANGE_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.队列与交换机绑定邮件队列</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">Binding <span class="title">bindingExchangeEamil</span><span class="params">(Queue fanOutEamilQueue, FanoutExchange fanoutExchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(fanOutEamilQueue).to(fanoutExchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4.队列与交换机绑定短信队列</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">Binding <span class="title">bindingExchangeSms</span><span class="params">(Queue fanOutSmsQueue, FanoutExchange fanoutExchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(fanOutSmsQueue).to(fanoutExchange);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发消息到消息队列，说明发邮件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FanoutProducer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AmqpTemplate amqpTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        JSONObject jsonObject = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        jsonObject.put(<span class="string">"email"</span>, <span class="string">"404914989@qq.com"</span>);</span><br><span class="line">        jsonObject.put(<span class="string">"msg"</span>,msg);</span><br><span class="line">        jsonObject.put(<span class="string">"Time"</span>, System.currentTimeMillis());</span><br><span class="line">        String jsonString = jsonObject.toJSONString();</span><br><span class="line">        System.out.println(<span class="string">"jsonString:"</span> + jsonString);        </span><br><span class="line">        amqpTemplate.convertAndSend(<span class="string">"email_queue"</span>, jsonString);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FanoutProducer fanoutProducer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/sendFanout"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sendFanout</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        fanoutProducer.send(msg);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="消费消息"><a href="#消费消息" class="headerlink" title="消费消息"></a>消费消息</h5><p>消费消息，远程调邮件服务发邮件。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.hu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>descout-buchang-consumer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-mail<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.49<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.6</span><span class="number">.238</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">retry:</span></span><br><span class="line">          <span class="comment">####开启消费者异常重试</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="comment">####最大重试次数</span></span><br><span class="line">          <span class="attr">max-attempts:</span> <span class="number">5</span></span><br><span class="line">          <span class="comment">####重试间隔次数</span></span><br><span class="line">          <span class="attr">initial-interval:</span> <span class="number">2000</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>,<span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取发邮件消息，之后调用邮件服务器发邮件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FanoutEamilConsumer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@RabbitListener</span>(queues = <span class="string">"email_queue"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(String msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"邮件消费者获取生产者消息msg:"</span> + msg);</span><br><span class="line">        JSONObject jsonObject = JSONObject.parseObject(msg);</span><br><span class="line">        String email = jsonObject.getString(<span class="string">"email"</span>);</span><br><span class="line">        String emailUrl = <span class="string">"http://192.168.6.238:8083/sendEmail?email="</span> + email;</span><br><span class="line">        JSONObject result = restTemplate.getForObject(emailUrl,JSONObject<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"调用接口失败!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"执行结束...."</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="邮件服务"><a href="#邮件服务" class="headerlink" title="邮件服务"></a>邮件服务</h5><p>下面模拟邮件服务</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.hu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>descout-buchang-emailser<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-mail<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.49<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class MsgController &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 模拟发送邮件</span><br><span class="line">    @RequestMapping(&quot;&#x2F;sendEmail&quot;)</span><br><span class="line">    public Map&lt;String, Object&gt; sendEmail(String email) &#123;</span><br><span class="line">        System.out.println(&quot;开始发送邮件:&quot; + email);</span><br><span class="line">        Map&lt;String, Object&gt; result &#x3D; new HashMap&lt;String, Object&gt;();</span><br><span class="line">        result.put(&quot;code&quot;, &quot;200&quot;);</span><br><span class="line">        result.put(&quot;msg&quot;, &quot;发送邮件成功..&quot;);</span><br><span class="line">        System.out.println(&quot;发送邮件成功&quot;);</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动邮件服务和生产者服务，浏览器中输入：<a href="http://192.168.6.238:8080/sendFanout?msg=0001" target="_blank" rel="noopener">http://192.168.6.238:8080/sendFanout?msg=0001</a><br>可以看到消息队列中有消息：   </p>
<p><img src="https://img.huyunshun.com/img/20200423155603.png" alt="20200423155603"></p>
<p>启动消费者服务：   </p>
<p><img src="https://img.huyunshun.com/img/20200423155620.png" alt="20200423155620"><br>服务消息被消费，并且消费者服务日志已经获取消息，并且调用邮件服务来发送邮件，而且邮件服务也有了日志信息。   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> INFO 14684 --- [cTaskExecutor-1] o.s.a.r.c.CachingConnectionFactory       : Created new connection: rabbitConnectionFactory#3b152928:0&#x2F;SimpleConnection@61b9a318 [delegate&#x3D;amqp:&#x2F;&#x2F;guest@192.168.6.238:5672&#x2F;, localPort&#x3D; 59727]</span><br><span class="line">邮件消费者获取生产者消息msg:&#123;&quot;msg&quot;:&quot;0001&quot;,&quot;Time&quot;:1564124703209,&quot;email&quot;:&quot;404914989@qq.com&quot;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">开始发送邮件:404914989@qq.com</span><br><span class="line">发送邮件成功</span><br></pre></td></tr></table></figure>
<p><img src="https://img.huyunshun.com/img/20200423155636.png" alt="20200423155636"></p>
<p>假如邮件服务器未启动，消费调用接口失败 会一直重试 重试五次，再次之间，如果邮件服务器启动成功 则重试成功 不再重试  不再进行补偿机制。<br>停止邮件服务器，<a href="http://192.168.6.238:8080/sendFanout?msg=456541再发送一次消息，可以看到消费者日志：" target="_blank" rel="noopener">http://192.168.6.238:8080/sendFanout?msg=456541再发送一次消息，可以看到消费者日志：</a><br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">邮件消费者获取生产者消息msg:&#123;&quot;msg&quot;:&quot;456541&quot;,&quot;Time&quot;:1564126234535,&quot;email&quot;:&quot;404914989@qq.com&quot;&#125;</span><br><span class="line">邮件消费者获取生产者消息msg:&#123;&quot;msg&quot;:&quot;456541&quot;,&quot;Time&quot;:1564126234535,&quot;email&quot;:&quot;404914989@qq.com&quot;&#125;</span><br><span class="line">邮件消费者获取生产者消息msg:&#123;&quot;msg&quot;:&quot;456541&quot;,&quot;Time&quot;:1564126234535,&quot;email&quot;:&quot;404914989@qq.com&quot;&#125;</span><br><span class="line">邮件消费者获取生产者消息msg:&#123;&quot;msg&quot;:&quot;456541&quot;,&quot;Time&quot;:1564126234535,&quot;email&quot;:&quot;404914989@qq.com&quot;&#125;</span><br><span class="line">邮件消费者获取生产者消息msg:&#123;&quot;msg&quot;:&quot;456541&quot;,&quot;Time&quot;:1564126234535,&quot;email&quot;:&quot;404914989@qq.com&quot;&#125;</span><br><span class="line">WARN 14684 --- [cTaskExecutor-1] o.s.a.r.r.RejectAndDontRequeueRecoverer  : Retries exhausted for message (Body:&#39;&#123;&quot;msg&quot;:&quot;456541&quot;,&quot;Time&quot;:1564126234535,&quot;email&quot;:&quot;404914989@qq.com&quot;&#125;&#39; MessageProperties [headers&#x3D;&#123;&#125;, contentType&#x3D;text&#x2F;plain, contentEncoding&#x3D;UTF-8, contentLength&#x3D;0, receivedDeliveryMode&#x3D;PERSISTENT, priority&#x3D;0, redelivered&#x3D;false, receivedExchange&#x3D;, receivedRoutingKey&#x3D;email_queue, deliveryTag&#x3D;4, consumerTag&#x3D;amq.ctag-y3aGTKHoCsx2ydYRm4fflA, consumerQueue&#x3D;email_queue])</span><br></pre></td></tr></table></figure><br>服务器一直没有启动，重复消费了5次，之后不再补偿，并且有了异常信息。   </p>
<p>网络延迟传输中，或者消费出现异常或者是消费延迟，会造成进行MQ重试进行重试补偿机制，在重试过程中，可能会造成重复消费。<br>如果不需要被重复消费： 使用全局MessageID判断消费，解决幂等性。</p>
<p>解决方式：<br>生产者：   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FanoutProducer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AmqpTemplate amqpTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        JSONObject jsonObject = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        jsonObject.put(<span class="string">"email"</span>, <span class="string">"404914989@qq.com"</span>);</span><br><span class="line">        jsonObject.put(<span class="string">"msg"</span>,msg);</span><br><span class="line">        jsonObject.put(<span class="string">"Time"</span>, System.currentTimeMillis());</span><br><span class="line">        String jsonString = jsonObject.toJSONString();</span><br><span class="line">        System.out.println(<span class="string">"jsonString:"</span> + jsonString);</span><br><span class="line">        <span class="comment">// 设置消息唯一id 保证每次重试消息id唯一</span></span><br><span class="line">        Message message = MessageBuilder.withBody(jsonString.getBytes())</span><br><span class="line">                .setContentType(MessageProperties.CONTENT_TYPE_JSON).setContentEncoding(<span class="string">"utf-8"</span>)</span><br><span class="line">                .setMessageId(UUID.randomUUID() + <span class="string">""</span>).build();</span><br><span class="line">        amqpTemplate.convertAndSend(<span class="string">"email_queue"</span>, jsonString);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Message message)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 获取消息Id</span></span><br><span class="line">    String messageId = message.getMessageProperties().getMessageId();</span><br><span class="line">    String msg = <span class="keyword">new</span> String(message.getBody(), <span class="string">"UTF-8"</span>);</span><br><span class="line">    System.out.println(<span class="string">"messageId:"</span> + messageId + <span class="string">",消息内容:"</span> + msg);</span><br><span class="line">    <span class="keyword">if</span> (messageId == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    JSONObject jsonObject = JSONObject.parseObject(msg);</span><br><span class="line">    String email = jsonObject.getString(<span class="string">"email"</span>);</span><br><span class="line">    String emailUrl = <span class="string">"http://127.0.0.1:8083/sendEmail?email="</span> + email;</span><br><span class="line">    JSONObject result = restTemplate.getForObject(emailUrl,JSONObject<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"调用接口失败!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">"执行结束...."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Spring boot 中还可以进行 AOP拦截 自动帮助做重试<br>如果不告诉服务器已经消费成功，则服务器不会删除 消息。告诉消费成功了才会删除。<br>消费者的yml加入：acknowledge-mode: manual    </p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.6</span><span class="number">.238</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">retry:</span></span><br><span class="line">          <span class="comment">####开启消费者异常重试</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="comment">####最大重试次数</span></span><br><span class="line">          <span class="attr">max-attempts:</span> <span class="number">5</span></span><br><span class="line">          <span class="comment">####重试间隔次数</span></span><br><span class="line">          <span class="attr">initial-interval:</span> <span class="number">2000</span></span><br><span class="line">          <span class="comment">#开启手动ack  </span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">manual</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Message message, @Headers Map&lt;String, Object&gt; headers, Channel channel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 获取消息Id</span></span><br><span class="line">        String messageId = message.getMessageProperties().getMessageId();</span><br><span class="line">        String msg = <span class="keyword">new</span> String(message.getBody(), <span class="string">"UTF-8"</span>);</span><br><span class="line">        System.out.println(<span class="string">"messageId:"</span> + messageId + <span class="string">",消息内容:"</span> + msg);</span><br><span class="line">        <span class="keyword">if</span> (messageId == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        JSONObject jsonObject = JSONObject.parseObject(msg);</span><br><span class="line">        String email = jsonObject.getString(<span class="string">"email"</span>);</span><br><span class="line">        String emailUrl = <span class="string">"http://192.168.6.238:8083/sendEmail?email="</span> + email;</span><br><span class="line">        JSONObject result = restTemplate.getForObject(emailUrl,JSONObject<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"调用接口失败!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        Long deliveryTag = (Long) headers.get(AmqpHeaders.DELIVERY_TAG);</span><br><span class="line">        <span class="comment">//RabbitMQ消费成功了 消息可以删除</span></span><br><span class="line">        channel.basicAck(deliveryTag, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这样，消息只有正常消费后才会删除。由程序控制。</p>
<h5 id="回调"><a href="#回调" class="headerlink" title="回调"></a>回调</h5><p>生产者中加入配置：   </p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.6</span><span class="number">.238</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">    <span class="comment">#开启回调</span></span><br><span class="line">    <span class="attr">publisher-confirms:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>类修改，即可有回调信息：   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FanoutProducer</span> <span class="keyword">implements</span> <span class="title">RabbitTemplate</span>.<span class="title">ConfirmCallback</span></span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate amqpTemplate;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FanoutProducer</span><span class="params">(RabbitTemplate rabbitTemplate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.amqpTemplate = rabbitTemplate;</span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        JSONObject jsonObject = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        jsonObject.put(<span class="string">"email"</span>, <span class="string">"404914989@qq.com"</span>);</span><br><span class="line">        jsonObject.put(<span class="string">"msg"</span>,msg);</span><br><span class="line">        jsonObject.put(<span class="string">"Time"</span>, System.currentTimeMillis());</span><br><span class="line">        String jsonString = jsonObject.toJSONString();</span><br><span class="line">        System.out.println(<span class="string">"jsonString:"</span> + jsonString);</span><br><span class="line">        <span class="comment">// 设置消息唯一id 保证每次重试消息id唯一</span></span><br><span class="line">        String uuid = UUID.randomUUID().toString();</span><br><span class="line">        Message message = MessageBuilder.withBody(jsonString.getBytes())</span><br><span class="line">                .setContentType(MessageProperties.CONTENT_TYPE_JSON).setContentEncoding(<span class="string">"utf-8"</span>)</span><br><span class="line">                .setMessageId(uuid).build();</span><br><span class="line">        CorrelationData correlationData = <span class="keyword">new</span> CorrelationData(uuid);</span><br><span class="line">        amqpTemplate.convertAndSend(<span class="string">"email_queue"</span>, message,correlationData);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirm</span><span class="params">(CorrelationData correlationData, <span class="keyword">boolean</span> b, String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(correlationData!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">"confirm: "</span> + correlationData.getId() + <span class="string">",s="</span> + s + <span class="string">",b:"</span> + b);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"回调"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    @Override</span></span><br><span class="line"><span class="comment">    public void confirm(CorrelationData correlationData, boolean ack, String cause) &#123;</span></span><br><span class="line"><span class="comment">        String orderId = correlationData.getId();</span></span><br><span class="line"><span class="comment">        System.out.println("消息id:" + correlationData.getId()); </span></span><br><span class="line"><span class="comment">        if (ack) &#123; //消息发送成功</span></span><br><span class="line"><span class="comment">            System.out.println("消息发送确认成功");</span></span><br><span class="line"><span class="comment">        &#125; else &#123;</span></span><br><span class="line"><span class="comment">            //重试机制</span></span><br><span class="line"><span class="comment">            send(orderId); </span></span><br><span class="line"><span class="comment">            System.out.println("消息发送确认失败:" + cause);</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或者在send方法中加入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">this.rabbitTemplate.setMandatory(true);</span><br><span class="line">this.rabbitTemplate.setConfirmCallback(this);</span><br></pre></td></tr></table></figure>
<p>demo见：<a href="https://github.com/huingsn/tech-point-record" target="_blank" rel="noopener">https://github.com/huingsn/tech-point-record</a></p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/03/22/%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BAELK%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E7%B3%BB%E7%BB%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/22/%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BAELK%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E7%B3%BB%E7%BB%9F/" itemprop="url">快速搭建ELK日志分析系统</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-22T00:00:00+08:00">
                2019-03-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://blog.csdn.net/e_wsq/article/details/81303713" target="_blank" rel="noopener">https://blog.csdn.net/e_wsq/article/details/81303713</a>    </p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/03/19/elasticsearch_%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/19/elasticsearch_%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE/" itemprop="url">elasticsearch 查询优化建议（转）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-19T00:00:00+08:00">
                2019-03-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>1：优化mapping  主要包括  doc_values , index  , norms  ， type的keyword和text  // 效果明显</p>
<p>doc_values属性  用于把数据序列化到磁盘，使索引结构更紧密</p>
<pre><code>默认为true，binary类型为false

缺点：产生额外磁盘消耗</code></pre><p>index 属性 用于是否对数据索引，对于一些没必要的数据不必要进行索引检索</p>
<pre><code>默认都为true

缺点：对与无索引的对象无法使用条件过滤和查询</code></pre><p>norms属性</p>
<pre><code>不必要聚合的属性可以设置为false</code></pre><p>keyword和text是String的拓展，5X之后使用这两个属性</p>
<pre><code>keyword属性为对数据不建倒排类似以前的String: { &quot;index&quot;: &quot;not_analyzed&quot;}，text为对数据进行分词倒排</code></pre><p>效果：能极大的减少磁盘空间</p>
<p>2 :  禁用 查询中的 _all , 设置合理的shard分片数 ，使用segment段落合并  // 效果明显</p>
<p>_all 默认打开，会把所有字段都在拷贝到这里，增加磁盘使用和影响查询性能</p>
<p>创建索引时添加 “_all”:{“enabled”:false} </p>
<p>shard </p>
<p>一个Shard就是一个Lucene实例，是一个完整的搜索引擎。</p>
<p>分片数过多会导致检索时打开比较多的文件，多台服务器之间通讯成本加大。</p>
<p>而分片数过少会导至单个分片索引过大，所以检索速度也会慢。</p>
<p>建议单个分片最多存储10G-20G左右的索引数据，每个实例的每个索引分片数建议在1-2个左右，并且尽量集群的所有节点</p>
<p>都分片数一致，不要出现分片数不一样导致的一个实例负载过大，等待合并的时间变长；</p>
<p>shard副本</p>
<p>使用副本的优点：数据备份，提高对大索引的查询效率，建议副本在1-2个左右，过多的副本会延迟合并时间以及磁盘使用率提高，性价比不高</p>
<p>segments</p>
<p>每个分片包含多个segment，每一个segment都是一个倒排索引；在查询的时，会把所有的segment查询结果汇总归并后最为最终的分片查询结果返回； segment越多,加载到内存中的segment越多，占用segment memory越多，查询性能可能就会下降，因此应该合并小的segment，减小segment数，提高检索的segment数来提高查询效率</p>
<p>创建索引的时候，elasticsearch会把文档信息写到内存bugffer中，elasticsearch定期会执行flush操作，把segment持久化到磁盘上，索引越大，segment越多，查询效率就会下降，由于segment创建是只是写入缓存，这时期容易系统异常容易丢失数据，可手动执行_flush来实现段落持久化</p>
<p>—- 合并索引段落语句</p>
<p>curl -XPOST ‘<a href="http://localhost:9200/{_index}/_forcemerge?max_num_segments=1&#39;" target="_blank" rel="noopener">http://localhost:9200/{_index}/_forcemerge?max_num_segments=1&#39;</a></p>
<p>—-并且每个es实例不要超过32G的jvm内存</p>
<p>———————以上策略 能提高不少的查询效率</p>
<p>3：避免内存交换 ，bootstrap.mlockall设置为true来实现  // 意义不大，或许是测试数据集1000w不够大，无法实现</p>
<p>在elasticsearch.yml里添加</p>
<p>bootstrap.memory_lock: true</p>
<pre><code>1./etc/security/limits.conf ，不限制Es启动用户（如xxx）的memlock
            xxx soft memlock unlimited
            xxx hard memlock unlimited
 2.修改：/etc/sysctl.conf

            vm.swappiness=0   

  ---------延迟刷新时间或禁用刷新
           curl -XGET &apos;localhost:9200/novehicle-new/_settings&apos; -d &apos;{&quot;refresh_interval&quot;: -1}&apos;</code></pre><p>4 : 优化query，查询的query返回必要字段，不用的字段，减小返回值大小     </p>
<p>5：优化日志输出等级,把trance改成info   // 好像效果不大</p>
<p>6： 路由优化  // 还在测试</p>
<p>　ES中所谓的路由和IP网络不同，是一个类似于Tag的东西。在创建文档的时候，可以通过字段为文档增加一个路由属性的Tag。ES内在机制决定了拥有相同路由属性的文档，一定会被分配到同一个分片上，无论是主分片还是副本。那么，在查询的过程中，一旦指定了感兴趣的路由属性，ES就可以直接到相应的分片所在的机器上进行搜索，而避免了复杂的分布式协同的一些工作，从而提升了ES的性能。于此同时，假设机器1上存有路由属性A的文档，机器2上存有路由属性为B的文档，那么我在查询的时候一旦指定目标路由属性为A，即使机器2故障瘫痪，对机器1构不成很大影响，所以这么做对灾况下的查询也提出了解决方案。所谓的路由，本质上是一个分桶（Bucketing）操作。当然，查询中也可以指定多个路由属性，机制大同小异。</p>
<p>7： 添加查询缓存，和预处理查询  // 测试中</p>
<p>8： 利用磁盘缓存提高检索</p>
<p>磁盘检索速度过慢,对于实时性较高的场景无法运用磁盘检索 ；所以索引处理中，需要把索引文件刷新加载到缓存中 , Elasticsearch默认1s的时间间隔，这也就是说相当于是实时搜索的，Elasticsearch也提供了单独的/_reflush接口，用户如果对1s间隔还是不太满意，可以主动调用接口来保证搜索可见。</p>
<p>— 刷新所有索引<br>POST /_refresh<br>— 指定索引刷新<br>  POST /{_index}/_refresh </p>
<p>   一般来说我们会通过/_settings接口或者定制template的方式，加大refresh_interval参数：</p>
<p>— 禁用自动refresh<br>PUT /{_index}/_settings{ “refresh_interval”: -1 }<br>— 设置每秒刷新<br>PUT /{_index}/_settings{ “refresh_interval”: “1s” }</p>
<p>9：控制translog  </p>
<p>既然refresh只是写到文件系统缓存中，那么最后一步写到实际磁盘又是由什么来控制的呢？如果这期间发生主机错误、硬盘故障等异常情况，数据会不会丢失？这里，其实Elasticsearch提供了另一个机制来控制。Elasticsearch也把数据写入到内存buffer的同时，其实还另外记录了一个treanslog的日志。也就是说，在内存数据进入到buffer这一步骤时，其实还另外记录了一个translog记录。</p>
<p>10：动态关闭不必要的索引   // 好像没太大意义</p>
<p>索引默认处于open状态，处于open状态的索引都会占用内存，对于不必要的索引可以close</p>
<p>curl -XPOST ‘<a href="http://localhost:9200/{_index}/_close&#39;" target="_blank" rel="noopener">http://localhost:9200/{_index}/_close&#39;</a></p>
<p>11 : 删除索引的注意点   // 测试中</p>
<p>当一个文档被更新，旧版本的文档被标记为删除，新版本的文档在新的段中索引。也许该文档的不同版本都会匹配一个查询，但是老版本会从结果中删除，</p>
<p>还是参与查询，影响检索效率；</p>
<p>删除文档在es时时不会马上删除，而是先生成.del文件，es在检索时会先判断文件是否删除再过滤，这样会降低检索效率，可手动执行删除文档</p>
<p>curl -XPOST ‘<a href="http://localhost:9200/{_index}/_forcemerge?only_expunge_deletes=true&#39;" target="_blank" rel="noopener">http://localhost:9200/{_index}/_forcemerge?only_expunge_deletes=true&#39;</a></p>
<p>12 ： 当要导入大量数据时，设置副本为0，之后动态添加副本   // 效率较大</p>
<p>当导入大量索引时，设置了副本数，es会同时打开副本同步，消耗系统资源，同时需要额外提供主副之间的通信</p>
<p>新建索引是可设置副本为0</p>
<p>—-设置副本数</p>
<p>curl -XPOST  ‘<a href="http://localhost:9200/{_index}/_settings&#39;" target="_blank" rel="noopener">http://localhost:9200/{_index}/_settings&#39;</a> -d </p>
<p>‘{“index”:{“number_of_replicas”:1}}’</p>
<p>13:给文件系统缓存大内存  至少给可用内存的一半到文件系统缓存。</p>
<p>14: 避免链接，嵌套会使查询慢几倍，而亲自关系能使查询慢几百倍，所以如果同样的问题可以通过没有链接的非规范回答就可以提升速度。</p>
<p>15:使用最小的足够用的数值类型</p>
<p>byte,short,integer,long</p>
<p>half_float,float,double</p>
<p>16: 索引缓冲大小</p>
<p>indices.memory.index_buffer_size通常是JVM的0.1，确保他足够处理至多512MB的索引。</p>
<p>17:优化es的线程池 </p>
<p>threadpool.index.type: fixed  </p>
<p>threadpool.index.size: 100  </p>
<p>threadpool.index.queue_size: 500  </p>
<p>18:采用G1垃圾回收机制代替默认CMS</p>
<p>JAVA_OPTS=”$JAVA_OPTS -XX:+UseG1GC”  </p>
<p>JAVA_OPTS=”$JAVA_OPTS -XX:MaxGCPauseMillis=200”  </p>
<p>19: 清理掉没用的缓存</p>
<h1 id="缓存类型设置为Soft-Reference，只有当内存不够时才会进行回收"><a href="#缓存类型设置为Soft-Reference，只有当内存不够时才会进行回收" class="headerlink" title="缓存类型设置为Soft Reference，只有当内存不够时才会进行回收"></a>缓存类型设置为Soft Reference，只有当内存不够时才会进行回收</h1><p>index.cache.field.max_size: 50000  </p>
<p>index.cache.field.expire: 10m  </p>
<p>index.cache.field.type: soft  </p>
<p>原文链接：<a href="https://blog.csdn.net/ailice001/article/details/79664455" target="_blank" rel="noopener">https://blog.csdn.net/ailice001/article/details/79664455</a></p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/03/19/elasticsearch_%E5%B8%B8%E7%94%A8%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/19/elasticsearch_%E5%B8%B8%E7%94%A8%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5/" itemprop="url">elasticsearch 常用查询语句</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-19T00:00:00+08:00">
                2019-03-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>整理常用的es查询语句： 基于kibana的Dev Tools控制板</p>
<h2 id="索引相关查询"><a href="#索引相关查询" class="headerlink" title="索引相关查询"></a>索引相关查询</h2><p>  //查询所有索引及容量</p>
<pre><code>GET _cat/indices</code></pre><p>  //查询索引映射结构<br>      GET my_index/_mapping</p>
<p>  // 查询所有索引映射结构    </p>
<pre><code>GET _all</code></pre><p>  // 查询所有的相同前缀索引</p>
<pre><code>GET my-*/_search</code></pre><p>  // 查询所有索引模板   </p>
<pre><code>GET _template</code></pre><p>  // 查询具体索引模板</p>
<pre><code>GET _template/my_template</code></pre><h2 id="集群相关"><a href="#集群相关" class="headerlink" title="集群相关"></a>集群相关</h2><p>  //查询集群健康状态</p>
<pre><code>GET _cluster/health</code></pre><p>  // 查询所有节点</p>
<pre><code>GET _cat/nodes</code></pre><p>  // 查询索引及分片的分布<br>      GET _cat/shards</p>
<p>  // 查询所有插件</p>
<pre><code>GET _cat/plugins</code></pre><h2 id="写入模块"><a href="#写入模块" class="headerlink" title="写入模块"></a>写入模块</h2><h3 id="写入索引模板"><a href="#写入索引模板" class="headerlink" title="写入索引模板"></a>写入索引模板</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">PUT _template/my_template</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"template"</span> : <span class="string">"my-*"</span>,</span><br><span class="line">    <span class="attr">"order"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"settings"</span> : &#123;</span><br><span class="line">         <span class="attr">"number_of_shards"</span> : <span class="number">10</span>,</span><br><span class="line"> <span class="attr">"number_of_replicas"</span> : <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"mappings"</span>: &#123;</span><br><span class="line"></span><br><span class="line">      <span class="attr">"default"</span>: &#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">"_all"</span>: &#123;</span><br><span class="line">        <span class="attr">"enabled"</span>: <span class="literal">false</span></span><br><span class="line">      &#125;，</span><br><span class="line">        <span class="string">"properties"</span>: &#123;</span><br><span class="line">          <span class="attr">"name"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"text"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"age"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建索引映射结构"><a href="#创建索引映射结构" class="headerlink" title="创建索引映射结构"></a>创建索引映射结构</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"doc"</span>: &#123;</span><br><span class="line">      <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"name"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"text"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"blob"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"binary"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="写入索引"><a href="#写入索引" class="headerlink" title="写入索引"></a>写入索引</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index/doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"Some binary blob"</span>,</span><br><span class="line">  <span class="attr">"blob"</span>: <span class="string">"U29tZSBiaW5hcnkgYmxvYg=="</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 索引</span></span><br><span class="line"></span><br><span class="line">DELETE my-index</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模板</span></span><br><span class="line"></span><br><span class="line">DELETE  _template/my_template</span><br></pre></td></tr></table></figure>


<h2 id="DSL-query查询"><a href="#DSL-query查询" class="headerlink" title="DSL query查询"></a>DSL query查询</h2><h2 id="使用本地插件查询"><a href="#使用本地插件查询" class="headerlink" title="使用本地插件查询"></a>使用本地插件查询</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="attr">"size"</span>: <span class="number">10</span>,</span><br><span class="line"></span><br><span class="line"><span class="attr">"from"</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line"><span class="attr">"query"</span>: &#123;</span><br><span class="line"><span class="attr">"function_score"</span>: &#123;</span><br><span class="line"><span class="attr">"script_score"</span>: &#123;</span><br><span class="line"><span class="attr">"script"</span>: &#123;</span><br><span class="line"><span class="attr">"inline"</span>: <span class="string">"featurescore"</span>,</span><br><span class="line"><span class="attr">"lang"</span>: <span class="string">"native"</span>,</span><br><span class="line"><span class="attr">"params"</span>: &#123;</span><br><span class="line"><span class="attr">"name"</span>: <span class="string">"you"</span>,</span><br><span class="line"><span class="attr">"age"</span>: <span class="string">"20"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">"query"</span>: &#123;</span><br><span class="line"><span class="attr">"bool"</span>: &#123;</span><br><span class="line"><span class="attr">"filter"</span>: &#123;</span><br><span class="line"><span class="attr">"term"</span>: &#123;</span><br><span class="line"><span class="attr">"name"</span>: <span class="string">"you"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">"_source"</span>: &#123;</span><br><span class="line"><span class="attr">"includes"</span>: [<span class="string">"name"</span>, <span class="string">"age"</span>]</span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">"sort"</span>: &#123;</span><br><span class="line"><span class="attr">"_score"</span>: &#123;</span><br><span class="line"><span class="attr">"order"</span>: <span class="string">"asc"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 说明 inline 指定插件名   lang指定插件形式  native是本地插件   param定义参数  插件里使用XContentMapValues.nodeStringValue(params.get("name"), null)获取  ,  elasticseach里存储的字段值使用 source().get("name") 来获取,插件会并行处理es中每一条数据 ； </span></span><br><span class="line"></span><br><span class="line">_source 指定返回字段 ， sort 指定插件处理结果的排序字段</span><br></pre></td></tr></table></figure>
<h2 id="基础query"><a href="#基础query" class="headerlink" title="基础query"></a>基础query</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询所有</span></span><br><span class="line">GET _search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match_all"</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>// 查询单个索引 的 固定属性</p>
<h3 id="精确匹配"><a href="#精确匹配" class="headerlink" title="精确匹配"></a>精确匹配</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET _search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"term"</span>: &#123; <span class="attr">"name"</span> : <span class="string">"you"</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="模糊匹配"><a href="#模糊匹配" class="headerlink" title="模糊匹配"></a>模糊匹配</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET _search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123; <span class="attr">"name"</span> : <span class="string">"you"</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="范围查找"><a href="#范围查找" class="headerlink" title="范围查找"></a>范围查找</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET _search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"range"</span>: &#123;</span><br><span class="line">        <span class="attr">"age"</span>:&#123; <span class="attr">"gte"</span> : <span class="number">15</span> , <span class="attr">"lte"</span> : <span class="number">25</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 功能性查询</span></span><br></pre></td></tr></table></figure>
<h3 id="过滤"><a href="#过滤" class="headerlink" title="过滤"></a>过滤</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"term"</span>:&#123;<span class="attr">"age"</span>:<span class="number">1095</span>&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="或-or"><a href="#或-or" class="headerlink" title="或  or"></a>或  or</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET my - test / _search &#123;</span><br><span class="line">"query": &#123;</span><br><span class="line">"bool": &#123;</span><br><span class="line">"should": [&#123;</span><br><span class="line">"term": &#123;</span><br><span class="line">"name": "you"</span><br><span class="line">&#125;</span><br><span class="line">&#125;, &#123;</span><br><span class="line">"match": &#123;</span><br><span class="line">"age": 20</span><br><span class="line">&#125;</span><br><span class="line">&#125;]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="与-AND"><a href="#与-AND" class="headerlink" title="与 AND"></a>与 AND</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET my-test/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"must"</span> : [&#123;</span><br><span class="line">        <span class="attr">"match"</span> : &#123;</span><br><span class="line">          <span class="attr">"name"</span> : <span class="string">"you"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,&#123;</span><br><span class="line">        <span class="attr">"range"</span>:&#123;</span><br><span class="line">        <span class="attr">"age"</span>:&#123;</span><br><span class="line">          <span class="attr">"from"</span> : <span class="number">10</span> , <span class="attr">"to"</span> : <span class="number">20</span></span><br><span class="line">        &#125; </span><br><span class="line">        &#125;</span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="必须"><a href="#必须" class="headerlink" title="必须 ="></a>必须 =</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"must"</span> : &#123;</span><br><span class="line">        <span class="attr">"range"</span> : &#123;</span><br><span class="line">          <span class="attr">"age"</span> : &#123; <span class="attr">"from"</span> : <span class="number">10</span>, <span class="attr">"to"</span> : <span class="number">20</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="必须不-not"><a href="#必须不-not" class="headerlink" title="必须不 not"></a>必须不 not</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"must_not"</span> : &#123;</span><br><span class="line">        <span class="attr">"term"</span> : &#123;</span><br><span class="line">          <span class="attr">"name"</span> : <span class="string">"you"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="复合查找"><a href="#复合查找" class="headerlink" title="复合查找"></a>复合查找</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">GET my_index/_search </span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">"query"</span>: &#123;</span><br><span class="line"><span class="attr">"bool"</span>: &#123;</span><br><span class="line"><span class="attr">"should"</span>: [&#123;</span><br><span class="line"><span class="attr">"match"</span>: &#123;</span><br><span class="line"><span class="attr">"age"</span>: <span class="number">40</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;, </span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">"match"</span>: &#123;</span><br><span class="line"><span class="attr">"age"</span>: <span class="number">20</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;],</span><br><span class="line"><span class="attr">"filter"</span>: &#123;</span><br><span class="line">  <span class="attr">"match"</span>:&#123;</span><br><span class="line">    <span class="attr">"name"</span>:<span class="string">"you"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="索引迁移"><a href="#索引迁移" class="headerlink" title="索引迁移"></a>索引迁移</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">---场景 从A索引 复制到B索引</span><br><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"source"</span>: &#123;</span><br><span class="line">    <span class="attr">"index"</span>: <span class="string">"my_index"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"dest"</span>: &#123;</span><br><span class="line">    <span class="attr">"index"</span>: <span class="string">"new_my_index"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="基于查询的删除"><a href="#基于查询的删除" class="headerlink" title="基于查询的删除"></a>基于查询的删除</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST test-index/_delete_by_query</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>:&#123;</span><br><span class="line">        <span class="attr">"term"</span>: &#123;</span><br><span class="line">         <span class="attr">"cameraId"</span>:<span class="string">"00000000002"</span></span><br><span class="line">        &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET test-index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>:&#123;</span><br><span class="line">        <span class="attr">"term"</span>: &#123;</span><br><span class="line">         <span class="attr">"cameraId"</span>:<span class="string">"00000000002"</span></span><br><span class="line">        &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/03/19/ES%E7%9A%84%E5%9B%A0%E6%9E%9C%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/19/ES%E7%9A%84%E5%9B%A0%E6%9E%9C%E4%BB%8B%E7%BB%8D/" itemprop="url">ES的因果介绍(转)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-19T00:00:00+08:00">
                2019-03-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1、大规模数据如何检索"><a href="#1、大规模数据如何检索" class="headerlink" title="1、大规模数据如何检索"></a>1、大规模数据如何检索</h1><p>1）用什么数据库好？(MySQL、Oracle、达梦、神通、MongoDB、Hbase…)<br>2）如何解决单点故障；(lvs、F5、A10、Zookeep、MQ)<br>3）如何保证数据安全性；(热备、冷备、异地多活)<br>4）如何解决检索难题；(数据库代理中间件：mysql-proxy、Cobar、MaxScale等;)<br>5）如何解决统计分析问题；(离线、近实时)     </p>
<h1 id="2、传统数据库的应对解决方案"><a href="#2、传统数据库的应对解决方案" class="headerlink" title="2、传统数据库的应对解决方案"></a>2、传统数据库的应对解决方案</h1><p>对于关系型数据，解决要点：<br>1）通过主从备份解决数据安全性问题；<br>2）通过数据库代理中间件心跳监测，解决单点故障问题；<br>3）通过代理中间件将查询语句分发到各个slave节点进行查询，并汇总结果<br>非关系型数据库的解决方案，要点：<br>1）通过副本备份保证数据安全性；<br>2）通过节点竞选机制解决单点问题；<br>3）先从配置库检索分片信息，然后将请求分发到各个节点，最后由路由节点合并汇总结果。     </p>
<p>假如把数据完全放入内存，成本超级高。所以数据放在内存也好，不放在内存也好，都不能完完全全解决问题。<br>为解决以上问题，从源头着手分析，通常会从以下方式来寻找方法：<br>1、存储数据时按有序存储；<br>2、将数据和索引分离；<br>3、压缩数据；<br>这就引出了Elasticsearch。     </p>
<h1 id="3、ES描述"><a href="#3、ES描述" class="headerlink" title="3、ES描述"></a>3、ES描述</h1><p>ES=elaticsearch简写， Elasticsearch是一个开源的高扩展的分布式全文检索引擎，它可以近乎实时的存储、检索数据；本身扩展性很好，可以扩展到上百台服务器，处理PB级别的数据。<br>Elasticsearch也使用Java开发并使用Lucene作为其核心来实现所有索引和搜索的功能，但是它的目的是通过简单的RESTful API来隐藏Lucene的复杂性，从而让全文搜索变得简单。</p>
<p> Lucene与ES关系：<br>1）Lucene只是一个库。想要使用它，你必须使用Java来作为开发语言并将其直接集成到你的应用中，更糟糕的是，Lucene非常复杂，你需要深入了解检索的相关知识来理解它是如何工作的。<br>2）Elasticsearch也使用Java开发并使用Lucene作为其核心来实现所有索引和搜索的功能，但是它的目的是通过简单的RESTful API来隐藏Lucene的复杂性，从而让全文搜索变得简单。     </p>
<p>ES主要解决问题：<br>1）检索相关数据；<br>2）返回统计结果；<br>3）速度要快。   </p>
<p>ES工作原理<br>当ElasticSearch的节点启动后，它会利用多播(multicast)(或者单播，如果用户更改了配置)寻找集群中的其它节点，并与之建立连接。   </p>
<p>ES核心概念<br>1）Cluster：集群。<br>ES可以作为一个独立的单个搜索服务器。不过，为了处理大型数据集，实现容错和高可用性，ES可以运行在许多互相合作的服务器上。这些服务器的集合称为集群。</p>
<p>2）Node：节点。<br>形成集群的每个服务器称为节点。   </p>
<p>3）Shard：分片。<br>当有大量的文档时，由于内存的限制、磁盘处理能力不足、无法足够快的响应客户端的请求等，一个节点可能不够。这种情况下，数据可以分为较小的分片。每个分片放到不同的服务器上。<br>当你查询的索引分布在多个分片上时，ES会把查询发送给每个相关的分片，并将结果组合在一起，而应用程序并不知道分片的存在。即：这个过程对用户来说是透明的。</p>
<p>4）Replia：副本。<br>为提高查询吞吐量或实现高可用性，可以使用分片副本。<br>副本是一个分片的精确复制，每个分片可以有零个或多个副本。ES中可以有许多相同的分片，其中之一被选择更改索引操作，这种特殊的分片称为主分片。<br>当主分片丢失时，如：该分片所在的数据不可用时，集群将副本提升为新的主分片。</p>
<p>5）全文检索。<br>全文检索就是对一篇文章进行索引，可以根据关键字搜索，类似于mysql里的like语句。<br>全文索引就是把内容根据词的意义进行分词，然后分别创建索引，例如”你们的激情是因为什么事情来的” 可能会被分词成：“你们“，”激情“，“什么事情“，”来“ 等token，这样当你搜索“你们” 或者 “激情” 都会把这句搜出来。 </p>
<p>ELK是什么？<br>ELK=elasticsearch+Logstash+kibana<br>elasticsearch：后台分布式存储以及全文检索<br>logstash: 日志加工、“搬运工”<br>kibana：数据可视化展示。<br>ELK架构为数据分布式存储、可视化查询和日志解析创建了一个功能强大的管理链。 三者相互配合，取长补短，共同完成分布式大数据处理工作。</p>
<p>ES特点和优势<br>1）分布式实时文件存储，可将每一个字段存入索引，使其可以被检索到。<br>2）实时分析的分布式搜索引擎。<br>分布式：索引分拆成多个分片，每个分片可有零个或多个副本。集群中的每个数据节点都可承载一个或多个分片，并且协调和处理各种操作；<br>负载再平衡和路由在大多数情况下自动完成。<br>3）可以扩展到上百台服务器，处理PB级别的结构化或非结构化数据。也可以运行在单台PC上（已测试）<br>4）支持插件机制，分词插件、同步插件、Hadoop插件、可视化插件等。</p>
<h1 id="4、ES性能"><a href="#4、ES性能" class="headerlink" title="4、ES性能"></a>4、ES性能</h1><p>性能结果展示<br>（1）硬件配置：<br>CPU 16核 AuthenticAMD<br>内存 总量：32GB<br>硬盘 总量：500GB 非SSD</p>
<p>在上述硬件指标的基础上测试性能如下：<br>1）平均索引吞吐量： 12307docs/s（每个文档大小：40B/docs）<br>2）平均CPU使用率： 887.7%（16核，平均每核：55.48%）<br>3）构建索引大小： 3.30111 GB<br>4）总写入量： 20.2123 GB<br>5）测试总耗时： 28m 54s.</p>
<p>性能esrally工具（推荐）<br>使用参考：<a href="http://blog.csdn.net/laoyang360/article/details/52155481" target="_blank" rel="noopener">http://blog.csdn.net/laoyang360/article/details/52155481</a></p>
<p>为什么要用ES？<br>1） 2013年初，GitHub抛弃了Solr，采取ElasticSearch 来做PB级的搜索。 “GitHub使用ElasticSearch搜索20TB的数据，包括13亿文件和1300亿行代码”。<br>2）维基百科：启动以elasticsearch为基础的核心搜索架构。<br>3）SoundCloud：“SoundCloud使用ElasticSearch为1.8亿用户提供即时而精准的音乐搜索服务”。<br>4）百度：百度目前广泛使用ElasticSearch作为文本数据分析，采集百度所有服务器上的各类指标数据及用户自定义数据，通过对各种数据进行多维分析展示，辅助定位分析实例异常或业务层面异常。目前覆盖百度内部20多个业务线（包括casio、云分析、网盟、预测、文库、直达号、钱包、风控等），单集群最大100台机器，200个ES节点，每天导入30TB+数据。</p>
<p>我们也需要<br>实际项目开发实战中，几乎每个系统都会有一个搜索的功能，当搜索做到一定程度时，维护和扩展起来难度就会慢慢变大，所以很多公司都会把搜索单独独立出一个模块，用ElasticSearch等来实现。</p>
<p>近年ElasticSearch发展迅猛，已经超越了其最初的纯搜索引擎的角色，现在已经增加了数据聚合分析（aggregation）和可视化的特性，如果你有数百万的文档需要通过关键词进行定位时，ElasticSearch肯定是最佳选择。当然，如果你的文档是JSON的，你也可以把ElasticSearch当作一种“NoSQL数据库”， 应用ElasticSearch数据聚合分析（aggregation）的特性，针对数据进行多维度的分析。</p>
<p>【知乎：热酷架构师潘飞】ES在某些场景下替代传统DB<br>个人以为Elasticsearch作为内部存储来说还是不错的，效率也基本能够满足，在某些方面替代传统DB也是可以的，前提是你的业务不对操作的事性务有特殊要求；而权限管理也不用那么细，因为ES的权限这块还不完善。<br>由于我们对ES的应用场景仅仅是在于对某段时间内的数据聚合操作，没有大量的单文档请求（比如通过userid来找到一个用户的文档，类似于NoSQL的应用场景），所以能否替代NoSQL还需要各位自己的测试。<br>如果让我选择的话，我会尝试使用ES来替代传统的NoSQL，因为它的横向扩展机制太方便了。</p>
<h1 id="5、ES的应用场景"><a href="#5、ES的应用场景" class="headerlink" title="5、ES的应用场景"></a>5、ES的应用场景</h1><p>通常我们面临问题有两个：<br>1）新系统开发尝试使用ES作为存储和检索服务器；<br>2）现有系统升级需要支持全文检索服务，需要使用ES。<br>以上两种架构的使用，以下链接进行详细阐述。<br><a href="http://blog.csdn.net/laoyang360/article/details/52227541" target="_blank" rel="noopener">http://blog.csdn.net/laoyang360/article/details/52227541</a></p>
<p>一线公司ES使用场景：<br>1）新浪ES 如何分析处理32亿条实时日志 <a href="http://dockone.io/article/505" target="_blank" rel="noopener">http://dockone.io/article/505</a><br>2）阿里ES 构建挖财自己的日志采集和分析体系 <a href="http://afoo.me/columns/tec/logging-platform-spec.html" target="_blank" rel="noopener">http://afoo.me/columns/tec/logging-platform-spec.html</a><br>3）有赞ES 业务日志处理 <a href="http://tech.youzan.com/you-zan-tong-ri-zhi-ping-tai-chu-tan/" target="_blank" rel="noopener">http://tech.youzan.com/you-zan-tong-ri-zhi-ping-tai-chu-tan/</a><br>4）ES实现站内搜索 <a href="http://www.wtoutiao.com/p/13bkqiZ.html" target="_blank" rel="noopener">http://www.wtoutiao.com/p/13bkqiZ.html</a></p>
<h1 id="6、如何部署ES"><a href="#6、如何部署ES" class="headerlink" title="6、如何部署ES"></a>6、如何部署ES</h1><p>6.1 ES部署（无需安装）<br>1）零配置，开箱即用<br>2）没有繁琐的安装配置<br>3）java版本要求：最低1.7<br>我使用的1.8<br>[root@lyng config_lhy]# echo $JAVA_HOME<br>/opt/jdk1.8.0_91<br>4）下载地址：<br><a href="https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/zip/elasticsearch/2.3.5/elasticsearch-2.3.5.zip" target="_blank" rel="noopener">https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/zip/elasticsearch/2.3.5/elasticsearch-2.3.5.zip</a><br>5）启动<br>cd /usr/local/elasticsearch-2.3.5<br>./bin/elasticsearch<br>bin/elasticsearch -d(后台运行)</p>
<p>6.2 ES必要的插件<br>必要的Head、kibana、IK（中文分词）、graph等插件的详细安装和使用。<br><a href="http://blog.csdn.net/column/details/deep-elasticsearch.html" target="_blank" rel="noopener">http://blog.csdn.net/column/details/deep-elasticsearch.html</a></p>
<p>6.3 ES windows下一键安装<br>自写bat脚本实现windows下一键安装。<br>1）一键安装ES及必要插件（head、kibana、IK、logstash等）<br>2）安装后以服务形式运行ES。<br>3）比自己摸索安装节省至少2小时时间，效率非常高。<br>脚本说明：<br><a href="http://blog.csdn.net/laoyang360/article/details/51900235" target="_blank" rel="noopener">http://blog.csdn.net/laoyang360/article/details/51900235</a></p>
<h1 id="7、ES对外接口"><a href="#7、ES对外接口" class="headerlink" title="7、ES对外接口"></a>7、ES对外接口</h1><p>1）JAVA API接口<br><a href="http://www.ibm.com/developerworks/library/j-use-elasticsearch-java-apps/index.html" target="_blank" rel="noopener">http://www.ibm.com/developerworks/library/j-use-elasticsearch-java-apps/index.html</a></p>
<p>2）RESTful API接口<br>常见的增、删、改、查操作实现：<br><a href="http://blog.csdn.net/laoyang360/article/details/51931981" target="_blank" rel="noopener">http://blog.csdn.net/laoyang360/article/details/51931981</a></p>
<p>ES遇到问题怎么办：<br>1）国外：<a href="https://discuss.elastic.co/" target="_blank" rel="noopener">https://discuss.elastic.co/</a><br>2）国内：<a href="http://elasticsearch.cn/" target="_blank" rel="noopener">http://elasticsearch.cn/</a></p>
<p>参考：<br>[1] <a href="http://www.tuicool.com/articles/7fueUbb" target="_blank" rel="noopener">http://www.tuicool.com/articles/7fueUbb</a><br>[2] <a href="http://zhaoyanblog.com/archives/495.html" target="_blank" rel="noopener">http://zhaoyanblog.com/archives/495.html</a><br>[3]《Elasticsearch服务器开发》<br>[4]《实战Elasticsearch、Logstash、Kibana》<br>[5]《Elasticsearch In Action》 </p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/03/18/Elasticsearch%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/18/Elasticsearch%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86/" itemprop="url">Elasticsearch集群管理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-18T00:00:00+08:00">
                2019-03-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="集群规划"><a href="#集群规划" class="headerlink" title="集群规划"></a>集群规划</h1><p>搭建一个集群我们需要考虑如下几个问题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. 我们需要多大规模的集群？</span><br><span class="line">2. 集群中的节点角色如何分配？</span><br><span class="line">3. 如何避免脑裂问题？</span><br><span class="line">4. 索引应该设置多少个分片？</span><br><span class="line">5. 分片应该设置几个副本？</span><br></pre></td></tr></table></figure>

<h2 id="我们需要多大规模的集群"><a href="#我们需要多大规模的集群" class="headerlink" title="我们需要多大规模的集群"></a>我们需要多大规模的集群</h2><p>需要从以下两个方面考虑：</p>
<p>当前的数据量有多大？数据增长情况如何？</p>
<p>你的机器配置如何？cpu、多大内存、多大硬盘容量？</p>
<p>推算的依据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ES JVM heap 最大可以设置32G 。</span><br><span class="line">30G heap 大概能处理的数据量 10 T。如果内存很大如128G，可在一台机器上运行多个ES节点实例。</span><br></pre></td></tr></table></figure>
<p>备注：集群规划满足当前数据规模+适量增长规模即可，后续可按需扩展。</p>
<p>两类应用场景：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A. 用于构建业务搜索功能模块，且多是垂直领域的搜索。数据量级几千万到数十亿级别。一般2-4台机器的规模。</span><br><span class="line">B. 用于大规模数据的实时OLAP（联机处理分析），经典的如ELK Stack，数据规模可能达到千亿或更多。几十到上百节点的规模。</span><br></pre></td></tr></table></figure>

<h2 id="集群中的节点角色如何分配"><a href="#集群中的节点角色如何分配" class="headerlink" title="集群中的节点角色如何分配"></a>集群中的节点角色如何分配</h2><p>** 节点角色 **</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Master</span><br><span class="line">node.master: true 节点可以作为主节点</span><br><span class="line">DataNode</span><br><span class="line">node.data: true 默认是数据节点。</span><br><span class="line">Coordinate node 协调节点</span><br><span class="line">如果仅担任协调节点，将上两个配置设为false。</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<p>一个节点可以充当一个或多个角色，默认三个角色都有</p>
<p>协调节点：一个节点只作为接收请求、转发请求到其他节点、汇总各个节点返回数据等功能的节点。</p>
<p>** 如何分配 **</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A. 小规模集群，不需严格区分。</span><br><span class="line">B. 中大规模集群（十个以上节点），应考虑单独的角色充当。特别并发查询量大，查询的合并量大，可以增加独立的协调节点。角色分开的好处是分工分开，不互影响。如不会因协调角色负载过高而影响数据节点的能力。</span><br></pre></td></tr></table></figure>

<h2 id="如何避免脑裂问题"><a href="#如何避免脑裂问题" class="headerlink" title="如何避免脑裂问题"></a>如何避免脑裂问题</h2><p>脑裂问题：一个集群中只有一个A主节点，A主节点因为需要处理的东西太多或者网络过于繁忙，从而导致其他从节点ping不通A主节点，这样其他从节点就会认为A主节点不可用了，就会重新选出一个新的主节点B。过了一会A主节点恢复正常了，这样就出现了两个主节点，导致一部分数据来源于A主节点，另外一部分数据来源于B主节点，出现数据不一致问题，这就是脑裂。</p>
<p>尽量避免脑裂，需要添加最小数量的主节点配置：discovery.zen.minimum_master_nodes: (有master资格节点数/2) + 1</p>
<p>这个参数控制的是，选举主节点时需要看到最少多少个具有master资格的活节点，才能进行选举。官方的推荐值是(N/2)+1，其中N是具有master资格的节点的数量。</p>
<p>** 常用做法 **（中大规模集群）：</p>
<ul>
<li><ol>
<li>Master 和 dataNode 角色分开，配置奇数个master </li>
</ol>
</li>
<li><ol start="2">
<li>单播发现机制，配置master资格节点：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">discovery.zen.ping.multicast.enabled: false —— 关闭多播发现机制，默认是关闭的</span><br><span class="line">discovery.zen.ping.unicast.hosts: [&quot;master1&quot;, &quot;master2&quot;, &quot;master3&quot;] —— 配置单播发现的主节点ip地址，其他从节点要加入进来，就得去询问单播发现机制里面配置的主节点我要加入到集群里面了，主节点同意以后才能加入，然后主节点再通知集群中的其他节点有新节点加入</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><ol start="3">
<li>配置选举发现数，及延长ping master的等待时长<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">discovery.zen.ping_timeout: 30（默认值是3秒）——其他节点ping主节点多久时间没有响应就认为主节点不可用了</span><br><span class="line">discovery.zen.minimum_master_nodes: 2 —— 选举主节点时需要看到最少多少个具有master资格的活节点，才能进行选举</span><br></pre></td></tr></table></figure>

</li>
</ol>
</li>
</ul>
<h2 id="索引应该设置多少个分片"><a href="#索引应该设置多少个分片" class="headerlink" title="索引应该设置多少个分片"></a>索引应该设置多少个分片</h2><p>说明：分片数指定后不可变，除非重索引。</p>
<p>思考：</p>
<p>分片对应的存储实体是什么？存储的实体是索引</p>
<p>分片是不是越多越好？　　不是</p>
<p>分片多有什么影响？　　分片多浪费存储空间、占用资源、影响性能</p>
<ul>
<li>分片过多的影响 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">每个分片本质上就是一个Lucene索引, 因此会消耗相应的文件句柄, 内存和CPU资源。</span><br><span class="line">每个搜索请求会调度到索引的每个分片中. 如果分片分散在不同的节点倒是问题不太. 但当分片开始竞争相同的硬件资源时, 性能便会逐步下降。</span><br><span class="line">ES使用词频统计来计算相关性. 当然这些统计也会分配到各个分片上. 如果在大量分片上只维护了很少的数据, 则将导致最终的文档相关性较差。</span><br></pre></td></tr></table></figure></li>
<li>分片设置的可参考原则 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ElasticSearch推荐的最大JVM堆空间是30~32G, 所以把你的分片最大容量限制为30GB, 然后再对分片数量做合理估算. 例如, 你认为你的数据能达到200GB, 推荐你最多分配7到8个分片。</span><br><span class="line">在开始阶段, 一个好的方案是根据你的节点数量按照1.5~3倍的原则来创建分片. 例如,如果你有3个节点, 则推荐你创建的分片数最多不超过9(3x3)个。当性能下降时，增加节点，ES会平衡分片的放置。</span><br><span class="line">对于基于日期的索引需求, 并且对索引数据的搜索场景非常少. 也许这些索引量将达到成百上千, 但每个索引的数据量只有1GB甚至更小. 对于这种类似场景, 建议只需要为索引分配1个分片。如日志管理就是一个日期的索引需求，日期索引会很多，但每个索引存放的日志数据量就很少。</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="分片应该设置几个副本"><a href="#分片应该设置几个副本" class="headerlink" title="分片应该设置几个副本"></a>分片应该设置几个副本</h2><p>说明：副本数是可以随时调整的！</p>
<p>思考：</p>
<p>副本的用途是什么？备份数据保证高可用数据不丢失，高并发的时候参与数据查询</p>
<p>针对它的用途，我们该如何设置它的副本数？　一般一个分片有1-2个副本即可保证高可用</p>
<p>集群规模没变的情况下副本过多会有什么影响？　　副本多浪费存储空间、占用资源、影响性能</p>
<p>** 副本设置基本原则**</p>
<p>为保证高可用，副本数设置为2即可。要求集群至少要有3个节点，来分开存放主分片、副本。如发现并发量大时，查询性能会下降，可增加副本数，来提升并发查询能力。</p>
<p>注意：新增副本时主节点会自动协调，然后拷贝数据到新增的副本节点</p>
<h1 id="集群搭建"><a href="#集群搭建" class="headerlink" title="集群搭建"></a>集群搭建</h1><h2 id="利用docker容器搭建伪集群"><a href="#利用docker容器搭建伪集群" class="headerlink" title="利用docker容器搭建伪集群"></a>利用docker容器搭建伪集群</h2><p>在Linux中创建目录，并且配置好：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">|-- node1</span><br><span class="line">|   |-- config</span><br><span class="line">|   |   &#96;-- es1.yml</span><br><span class="line">|   |-- data</span><br><span class="line">|   &#96;-- plugins</span><br><span class="line">|-- node2</span><br><span class="line">|   |-- config</span><br><span class="line">|   |   &#96;-- es1.yml</span><br><span class="line">|   |-- data</span><br><span class="line">|   &#96;-- plugins</span><br><span class="line">&#96;-- node3</span><br><span class="line">    |-- config</span><br><span class="line">    |   &#96;-- es1.yml</span><br><span class="line">    |-- data</span><br><span class="line">    &#96;-- plugins</span><br></pre></td></tr></table></figure>
<p>目录文件： 是用来挂载用的，同步配置文件。容器的和外部的同步。</p>
<p>开启防火墙（9300、9301、9302）：firewall-cmd –add-port=9301/tcp</p>
<p>分别配置好配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cluster.name: elasticsearch-cluster</span><br><span class="line">node.name: es-node3</span><br><span class="line">network.bind_host: 0.0.0.0</span><br><span class="line">network.publish_host: 172.17.0.13</span><br><span class="line">http.port: 9202</span><br><span class="line">transport.tcp.port: 9302</span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br><span class="line">node.master: true </span><br><span class="line">node.data: true  </span><br><span class="line">discovery.zen.ping.unicast.hosts: [&quot;172.17.0.11:9300&quot;,&quot;172.17.0.12:9301&quot;,&quot;172.17.0.13:9302&quot;]</span><br><span class="line">discovery.zen.minimum_master_nodes: 2</span><br></pre></td></tr></table></figure>
<p>discovery.zen.minimum_master_nodes: 1  master节点有1个   # discovery.zen.minimum_master_nodes—节点总数/2+1</p>
<p>说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">cluster.name：用于唯一标识一个集群，默认值是：elasticsearch。</span><br><span class="line">node.name：节点名，默认随机指定一个name列表中名字。集群中node名字不能重复</span><br><span class="line"></span><br><span class="line">index.number_of_shards: 默认的配置是把索引分为5个分片</span><br><span class="line">index.number_of_replicas:设置每个index的默认的冗余备份的分片数，默认是1</span><br><span class="line"></span><br><span class="line">通过 index.number_of_shards，index.number_of_replicas默认设置索引将分为5个分片，每个分片1个副本，共10个结点。</span><br><span class="line"></span><br><span class="line">bootstrap.memory_lock: true 当JVM做分页切换（swapping）时，ElasticSearch执行的效率会降低，推荐把ES_MIN_MEM和ES_MAX_MEM两个环境变量设置成同一个值，并且保证机器有足够的物理内存分配给ES，同时允许ElasticSearch进程锁住内存</span><br><span class="line"></span><br><span class="line">network.bind_host: 设置可以访问的ip,可以是ipv4或ipv6的，默认为0.0.0.0，这里全部设置通过</span><br><span class="line"></span><br><span class="line">network.publish_host:设置其它结点和该结点交互的ip地址，如果不设置它会自动判断，值必须是个真实的ip地址</span><br><span class="line"></span><br><span class="line">同时设置bind_host和publish_host两个参数可以替换成network.host</span><br><span class="line">network.bind_host: 172.17.0.11</span><br><span class="line">network.publish_host: 172.17.0.11</span><br><span class="line">&#x3D;&gt;network.host: 172.17.0.11</span><br><span class="line"></span><br><span class="line">http.port:设置对外服务的http端口，默认为9200</span><br><span class="line"></span><br><span class="line">transport.tcp.port: 设置节点之间交互的tcp端口，默认是9300</span><br><span class="line"></span><br><span class="line">http.cors.enabled: 是否允许跨域REST请求</span><br><span class="line"></span><br><span class="line">http.cors.allow-origin: 允许 REST 请求来自何处</span><br><span class="line"></span><br><span class="line">node.master: true 配置该结点有资格被选举为主结点（候选主结点），用于处理请求和管理集群，false为不具有选举的资格。</span><br><span class="line"></span><br><span class="line">node.data: true 配置该结点是数据结点，用于保存数据，执行数据相关的操作（CRUD，Aggregation）；</span><br><span class="line"></span><br><span class="line">discovery.zen.minimum_master_nodes: </span><br><span class="line">自动发现master节点的最小数，如果这个集群中配置进来的master节点少于这个数目，es的日志会一直报master节点数目不足，默认为1。</span><br><span class="line">为了避免脑裂，个数请遵从该公式 &#x3D;&gt; (totalnumber of master-eligible nodes &#x2F; 2 + 1)。 </span><br><span class="line">脑裂是指在主备切换时，由于切换不彻底或其他原因，导致客户端和Slave误以为出现两个active master，最终使得整个集群处于混乱状态。</span><br><span class="line"></span><br><span class="line">discovery.zen.ping.unicast.hosts： 集群个节点IP地址，也可以使用es-node等名称，需要各节点能够解析</span><br></pre></td></tr></table></figure>

<p>分别启动：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 9200:9200 -p 9300:9300 -v &#x2F;root&#x2F;es-cluster&#x2F;node1&#x2F;config&#x2F;es1.yml:&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;config&#x2F;elasticsearch.yml -v &#x2F;root&#x2F;es-cluster&#x2F;node1&#x2F;plugins:&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;plugins -v &#x2F;root&#x2F;es-cluster&#x2F;node1&#x2F;data:&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;data -e ES_JAVA_OPTS&#x3D;&quot;-Xms512m -Xmx512m&quot; --name es-node1 bdaab402b220</span><br><span class="line"></span><br><span class="line">或：</span><br><span class="line"></span><br><span class="line">docker run -d -e ES_JAVA_OPTS&#x3D;&quot;-Xms512m -Xmx512m&quot; -p 9200:9200 -p 9300:9300 --mount type&#x3D;bind,source&#x3D;&#x2F;root&#x2F;es-cluster&#x2F;node1&#x2F;config&#x2F;es1.yml,target&#x3D;&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;config&#x2F;elasticsearch.yml --mount type&#x3D;bind,source&#x3D;&#x2F;root&#x2F;es-cluster&#x2F;node1&#x2F;plugins,target&#x3D;&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;plugins --mount type&#x3D;bind,source&#x3D;&#x2F;root&#x2F;es-cluster&#x2F;node1&#x2F;data,target&#x3D;&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;data --name es-node1 bdaab402b220</span><br></pre></td></tr></table></figure>
<p>docker run -d -e ES_JAVA_OPTS=”-Xms512m -Xmx512m” -p 9201:9201 -p 9301:9301 -v /root/es-cluster/node2/config/es1.yml:/usr/share/elasticsearch/config/elasticsearch.yml -v /root/es-cluster/node2/plugins:/usr/share/elasticsearch/plugins -v /root/es-cluster/node2/data:/usr/share/elasticsearch/data –name es-node2 bdaab402b220</p>
<p>docker run -d -e ES_JAVA_OPTS=”-Xms512m -Xmx512m” -p 9202:9202 -p 9302:9302 -v /root/es-cluster/node3/config/es1.yml:/usr/share/elasticsearch/config/elasticsearch.yml -v /root/es-cluster/node3/plugins:/usr/share/elasticsearch/plugins -v /root/es-cluster/node3/data:/usr/share/elasticsearch/data –name es-node3 bdaab402b220</p>
<p>出现的问题：</p>
<p>1、Java HotSpot(TM) 64-Bit Server VM warning: INFO: os::commit_memory(0x00000000c5330000, 986513408, 0) failed; error=’Cannot allocate memory’ (errno=12)</p>
<p>解决办法是，运行的时间添加设定每个容器的 ES_JAVA_OPTS=”-Xms256m -Xmx256m”  </p>
<p>2、bootstrap checks failed max virtual memory areas vm.max_map_count [65530] likely too low, increase to at least [262144]</p>
<p>** 调高JVM线程数限制数量 **</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">在centos窗口中，修改配置sysctl.conf</span><br><span class="line">vim &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line"></span><br><span class="line">加入如下内容：</span><br><span class="line">vm.max_map_count&#x3D;262144 </span><br><span class="line"></span><br><span class="line">启用配置：sysctl -p</span><br></pre></td></tr></table></figure>
<p>3、OpenJDK 64-Bit Server VM warning: Option UseConcMarkSweepGC was deprecated in version 9.0 and will likely be removed in a future release.</p>
<p>增加data权限 ,如果有can not run elasticsearch as root则需要使用切换普通用户操作。；</p>
<p>4、docker WARNING: IPv4 forwarding is disabled</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">在宿主机上面执行：</span><br><span class="line">net.ipv4.ip_forward&#x3D;1 &gt;&gt; &#x2F;usr&#x2F;lib&#x2F;sysctl.d&#x2F;00-system.conf</span><br><span class="line">重启network和docker服务</span><br><span class="line">systemctl restart network &amp;&amp; systemctl restart docker</span><br></pre></td></tr></table></figure>
<p>5、Caused by: java.io.IOException: No route to host</p>
<p>data文件中的节点数据，需要把示例二data文件下的文件清空。rm -rf  ./node<em>/data/</em></p>
<h2 id="正式集群"><a href="#正式集群" class="headerlink" title="正式集群"></a>正式集群</h2><ol>
<li><p>准备3台虚拟机：</p>
</li>
<li><p>168.152.128 、192.168.152.129、192.168.152.130</p>
</li>
<li><p>在3台虚拟机里面都安装好elasticsearch<br>安装教程参考我之前写的文章的ES的安装和配置部分：</p>
</li>
</ol>
<p><a href="https://www.cnblogs.com/leeSmall/p/9189078.html" target="_blank" rel="noopener">https://www.cnblogs.com/leeSmall/p/9189078.html</a></p>
<ol start="3">
<li>修改3台虚拟机下ES的配置，使得它们组成一个集群<br>进入elasticsearch的config目录，修改elasticsearch.yml的配置</li>
</ol>
<p>3.1. IP访问限制、默认端口修改9200<br>这里有两个需要提醒下，第一个就是IP访问限制，第二个就是es实例的默认端口号9200。IP访问限制可以限定具体的IP访问服务器，这有一定的安全过滤作用。</p>
<p>#Set the bind address to a specific IP (IPv4 or IPv6): </p>
<h1 id=""><a href="#" class="headerlink" title=""></a></h1><p>network.host: 192.168.152.128<br>如果设置成0.0.0.0则是不限制任何IP访问。一般在生产的服务器可能会限定几台IP，通常用于管理使用。</p>
<p>默认的端口9200在一般情况下也有点风险，可以将默认的端口修改成另外一个，这还有一个原因就是怕开发人员误操作，连接上集群。当然，如果你的公司网络隔离做的很好也无所谓。</p>
<h1 id="-1"><a href="#-1" class="headerlink" title=""></a></h1><p>#Set a custom port for HTTP: </p>
<h1 id="-2"><a href="#-2" class="headerlink" title=""></a></h1><p>http.port: 9200<br>transport.tcp.port: 9300<br>这里的9300是集群内部通讯使用的端口，这个也可以修改掉。因为连接集群的方式有两种，通过扮演集群node也是可以进入集群的，所以还是安全起见，修改掉默认的端口。</p>
<p>说明：记得修改安装了ES的3台虚拟机（三个节点）的相同配置，要不然节点之间无法建立连接工作，也会报错。</p>
<p>3.2 集群发现IP列表、node、cluster名称<br>紧接着修改集群节点IP地址，这样可以让集群在规定的几个节点之间工作。elasticsearch，默认是使用自动发现IP机制。就是在当前网段内，只要能被自动感知到的IP就能自动加入到集群中。这有好处也有坏处。好处就是自动化了，当你的es集群需要云化的时候就会非常方便。但是也会带来一些不稳定的情况，如，master的选举问题、数据复制问题。</p>
<p>导致master选举的因素之一就是集群有节点进入。当数据复制发生的时候也会影响集群，因为要做数据平衡复制和冗余。这里面可以独立master集群，剔除master集群的数据节点能力。</p>
<p>固定列表的IP发现有两种配置方式，一种是互相依赖发现，一种是全量发现。各有优势吧，我是使用的依赖发现来做的。这有个很重要的参考标准，就是你的集群扩展速度有多快。因为这有个问题就是，当全量发现的时候，如果是初始化集群会有很大的问题，就是master全局会很长，然后节点之间的启动速度各不一样。所以我采用了靠谱点的依赖发现。</p>
<p>你需要在192.168.152.128的elasticsearch中配置成：</p>
<p>#——————————— Discovery ———————————- </p>
<h1 id="-3"><a href="#-3" class="headerlink" title=""></a></h1><p>#Pass an initial list of hosts to perform discovery when new node is started:<br>#The default list of hosts is [“127.0.0.1”, “[::1]”] </p>
<h1 id="-4"><a href="#-4" class="headerlink" title=""></a></h1><p>discovery.zen.ping.unicast.hosts: [ “192.168.152.129:9300”,”192.168.152.130:9300” ]<br>让他去发现129，130的机器，以此内推，完成剩下的129和130机器的配置。</p>
<p>然后你需要配置下集群名称，就是你当前节点所在集群的名称，这有助于你规划你的集群。集群中的所有节点的集群名称必须一样，只有集群名称一样才能组成一个逻辑集群。</p>
<p>#———————————- Cluster ———————————– </p>
<h1 id="-5"><a href="#-5" class="headerlink" title=""></a></h1><p>#Use a descriptive name for your cluster: </p>
<h1 id="-6"><a href="#-6" class="headerlink" title=""></a></h1><p>cluster.name: mycluster<br>配置你当前节点的名称</p>
<h1 id="-7"><a href="#-7" class="headerlink" title=""></a></h1><p>#———————————— Node ———————————— </p>
<h1 id="-8"><a href="#-8" class="headerlink" title=""></a></h1><p>#Use a descriptive name for the node: </p>
<h1 id="-9"><a href="#-9" class="headerlink" title=""></a></h1><p>node.name: node-1<br>以此类推，完成另外两个节点的配置。cluster.name的名称必须保持一样。然后分别设置node.name。</p>
<p>说明：</p>
<p>这里搭建的是一个简单的集群，没有做集群节点角色的区分，所以3个节点默认的角色有主节点、数据节点、协调节点</p>
<p>选举ES主节点的逻辑：</p>
<p>选举的大概逻辑，它会根据分片的数据的前后新鲜程度来作为选举的一个重要逻辑。（日志、数据、时间都会作为集群master全局的重要指标）</p>
<p>因为考虑到数据一致性问题，当然是用最新的数据节点作为master，然后进行新数据的复制和刷新其他node。</p>
<p>2、[WARN ][o.e.b.ElasticsearchUncaughtExceptionHandler] [] uncaught exception in thread [main] org.elasticsearch.bootstrap.StartupException: java.lang.RuntimeException: can not run elasticsearch as root</p>
<p>新的版本安全级别 提高了，不允许采用root启动，我们需要添加一个新的用户。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1、创建elasticsearch用户组：[root@localhost &#x2F;]# groupadd elasticsearch</span><br><span class="line">2、创建elasticsearch用户:[root@localhost elasticsearch-6.1.1]# useradd elasticsearch -g elasticsearch -p elasticsearch</span><br><span class="line">3、更改 elasticsearch-6.1.1文件夹下所有文件的所属用户和组分别为elasticsearch、elasticsearch。命令: chown -R elasticsearch.elasticsearch *(chown将指定文件的拥有者，-R代表处理指定目录以及子目录下的所有文件)</span><br><span class="line">4、给elasticsearch用户分配读写“&#x2F;usr&#x2F;local&#x2F;fast&#x2F;elasticsearch-6.1.1&#x2F;data”的权限 命令：chown -R elasticsearch:elasticsearch elasticsearch-6.1.1</span><br><span class="line">[1]: max file descriptors [4096] for elasticsearch process is too low, increase to at least [65536]，修改&#x2F;etc&#x2F;security&#x2F;limits.conf，添加如下内容，如果不成功的话可以尝试ulimit -n 65536。</span><br><span class="line">[2]: max number of threads [794] for user [elasticsearch] is too low, increase to at least [4096]，修改&#x2F;etc&#x2F;security&#x2F;limits.d&#x2F;20-nproc.conf和&#x2F;etc&#x2F;security&#x2F;limits.conf。</span><br><span class="line">[3]: max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]，修改&#x2F;etc&#x2F;sysctl.conf文件，具体如下。修改完成后，输入sysctl -a 命令。</span><br></pre></td></tr></table></figure>

<h1 id="集群管理"><a href="#集群管理" class="headerlink" title="集群管理"></a>集群管理</h1><ol>
<li>监控API<br><a href="http://localhost:9200/_cat" target="_blank" rel="noopener">http://localhost:9200/_cat</a></li>
</ol>
<p>复制代码<br>GET  /_cat</p>
<p>/_cat/health<br>/_cat/nodes<br>/_cat/master<br>/_cat/indices<br>/_cat/allocation<br>/_cat/shards<br>/_cat/shards/{index}<br>/_cat/thread_pool<br>/_cat/segments<br>/_cat/segments/{index}<br>复制代码<br>2. x-pack<br>为集群提供安全防护、监控、告警、报告等功能的收费组件；<br>部分免费：<a href="https://www.elastic.co/subscriptions" target="_blank" rel="noopener">https://www.elastic.co/subscriptions</a><br>6.3开始已开源，并并入了elasticsearch核心中。</p>
<p>官网安装介绍：</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.2/installing-xpack-es.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/6.2/installing-xpack-es.html</a></p>
<p>参考文章：</p>
<p>集群搭建一：<a href="https://www.cnblogs.com/wangiqngpei557/p/5967377.html" target="_blank" rel="noopener">https://www.cnblogs.com/wangiqngpei557/p/5967377.html</a></p>
<p>集群搭建二：<a href="https://www.cnblogs.com/jstarseven/p/6803054.html" target="_blank" rel="noopener">https://www.cnblogs.com/jstarseven/p/6803054.html</a> 这一篇文章写得比较详细，同时还总结了搭建过程中遇到的问题，搭建ES集群的话强烈推荐</p>
<h1 id="配置参数"><a href="#配置参数" class="headerlink" title="配置参数"></a>配置参数</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">cluster.name: ES	ES集群名称，同一个集群内的所有节点集群名称必须保持一致</span><br><span class="line">node.name: slave2	ES集群内的节点名称，同一个集群内的节点名称要具备唯一性</span><br><span class="line">node.master: true	允许节点是否可以成为一个master节点，ES是默认集群中的第一台机器成为master，如果这台机器停止就会重新选举</span><br><span class="line">node.data: false	允许该节点存储索引数据（默认开启）</span><br><span class="line">path.data:	ES是搜索引擎，会创建文档，建立索引，此路径是索引的存放目录.可以指定多个存储位置</span><br><span class="line">path.logs:	elasticsearch专门的日志存储位置</span><br><span class="line">bootstrap.memory_lock: true	在ES运行起来后锁定ES所能使用的堆内存大小，锁定内存大小一般为可用内存的一半左右；锁定内存后就不会使用交换分区。如果不打开此项，当系统物理内存空间不足，ES将使用交换分区，ES如果使用交换分区，那么ES的性能将会变得很差</span><br><span class="line">network.host: 0.0.0.0	es的HTTP端口和集群通信端口就会监听在此地址上</span><br><span class="line">network.tcp.no_delay: true	是否启用tcp无延迟，true为启用tcp不延迟，默认为false启用tcp延迟</span><br><span class="line">truenetwork.tcp.keep_alive: true	是否启用TCP保持活动状态，默认为true</span><br><span class="line">network.tcp.reuse_address: true	是否应该重复使用地址。默认true，在Windows机器上默认为false</span><br><span class="line">network.tcp.send_buffer_size: 128mb	tcp发送缓冲区大小，默认不设置</span><br><span class="line">network.tcp.receive_buffer_size: 128mb	tcp接收缓冲区大小，默认不设置</span><br><span class="line">transport.tcp.port: 9301	设置集群节点通信的TCP端口，默认就是9300</span><br><span class="line">transport.tcp.compress: true	设置是否压缩TCP传输时的数据，默认为false</span><br><span class="line">http.max_content_length: 200mb	设置http请求内容的最大容量，默认是100mb</span><br><span class="line">http.cors.enabled: true	是否开启跨域访问</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;	开启跨域访问后的地址限制，*表示无限制</span><br><span class="line">http.port: 9201	定义ES对外调用的http端口，默认是9200</span><br><span class="line">discovery.zen.ping.unicast.hosts: [&quot;127.0.0.1:9301&quot;,&quot;127.0.0.1:9302&quot;,&quot;127.0.0.1:9303&quot;]	在Elasticsearch7.0版本已被移除，配置错误。写入候选主节点的设备地址，来开启服务时就可以被选为主节点。默认主机列表只有127.0.0.1和IPV6的本机回环地址。上面是书写格式，discover意思为发现，zen是判定集群成员的协议，unicast是单播的意思，ES5.0版本之后只支持单播的方式来进行集群间的通信，hosts为主机</span><br><span class="line">discovery.zen.minimum_master_nodes: 2	在Elasticsearch7.0版本已被移除，配置无效，为了避免脑裂，集群的最少节点数量为，集群的总节点数量除以2加一</span><br><span class="line">discovery.zen.fd.ping_timeout: 120s	在Elasticsearch7.0版本已被移除，配置无效。探测超时时间，默认是3秒，我们这里填120秒是为了防止网络不好的时候ES集群发生脑裂现象</span><br><span class="line">discovery.zen.fd.ping_retries: 6	在Elasticsearch7.0版本已被移除，配置无效。探测次数，如果每次探测90秒，连续探测超过六次，则认为节点该节点已脱离集群，默认为3次</span><br><span class="line">discovery.zen.fd.ping_interval: 15s	在Elasticsearch7.0版本已被移除，配置无效。节点每隔15秒向master发送一次心跳，证明自己和master还存活，默认为1秒太频繁</span><br><span class="line">discovery.seed_hosts: [&quot;127.0.0.1:9301&quot;,&quot;127.0.0.1:9302&quot;,&quot;127.0.0.1:9303&quot;]	Elasticsearch7新增参数，写入候选主节点的设备地址，来开启服务时就可以被选为主节点,由discovery.zen.ping.unicast.hosts:参数改变而来</span><br><span class="line">cluster.initial_master_nodes: [&quot;127.0.0.1:9301&quot;,&quot;127.0.0.1:9302&quot;]	Elasticsearch7新增参数，写入候选主节点的设备地址，来开启服务时就可以被选为主节点</span><br><span class="line">cluster.fault_detection.leader_check.interval: 15s	Elasticsearch7新增参数，设置每个节点在选中的主节点的检查之间等待的时间。默认为1秒</span><br><span class="line">discovery.cluster_formation_warning_timeout: 30s	Elasticsearch7新增参数，启动后30秒内，如果集群未形成，那么将会记录一条警告信息，警告信息未master not fount开始，默认为10秒</span><br><span class="line">cluster.join.timeout: 30s	Elasticsearch7新增参数，节点发送请求加入集群后，在认为请求失败后，再次发送请求的等待时间，默认为60秒</span><br><span class="line">cluster.publish.timeout: 90s	Elasticsearch7新增参数，设置主节点等待每个集群状态完全更新后发布到所有节点的时间，默认为30秒</span><br><span class="line">cluster.routing.allocation.cluster_concurrent_rebalance: 32	集群内同时启动的数据任务个数，默认是2个</span><br><span class="line">cluster.routing.allocation.node_concurrent_recoveries: 32	添加或删除节点及负载均衡时并发恢复的线程个数，默认4个</span><br><span class="line">cluster.routing.allocation.node_initial_primaries_recoveries: 32	初始化数据恢复时，并发恢复线程的个数，默认4个</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/03/17/Elasticsearch%E4%BD%BF%E7%94%A8%E6%93%8D%E4%BD%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/17/Elasticsearch%E4%BD%BF%E7%94%A8%E6%93%8D%E4%BD%9C/" itemprop="url">Elasticsearch使用操作</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-17T00:00:00+08:00">
                2019-03-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>ES架构</p>
<p><img src="https://img.huyunshun.com/img1/Elasticsearch/sdfsdjjhfdvxdd676tyfgfdimgclip.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Gateway层：</span><br><span class="line">最底这一层最主要是是做数据持久化的，其实就是数据层，es支持可以在多种文件系统上运行，可以支持各种的存储系统，本地的存储系统、HadoopHDFS等等各种各样的数据存储系统，用于存元数据。</span><br><span class="line"></span><br><span class="line">Lucene层</span><br><span class="line">ElasticScarch的底层就是对Lucene的一个封装，它由始至终都要用到Lucene，ElasticScarch在Lucene的基础之上做了一个分布式的框架，把多个Lucene的索引给管理起来，最后做一个非常大规模的搜索引擎。</span><br><span class="line"></span><br><span class="line">倒数第三层 index、search、mapping：</span><br><span class="line">index模块： 怎么创建某个索引，数据如何创建，如何存储 都由它来管理。</span><br><span class="line">search模块： 数据的查询由它来完成。</span><br><span class="line">mapping模块： 相单于如何创建一个表的结构、怎么创建这个mapping都由它管理</span><br><span class="line">River模块： 这个模块现在没有了，我记得是数据同步还是什么鬼（反正不重要）</span><br><span class="line"></span><br><span class="line">倒数第四层 Discovery、Scripting、3rdPlugins：</span><br><span class="line">Discovery模块： 服务发现模块、当有节点要加入进来需要通过此模块，主要处理节点与节点之间的问题，目前实现有两种方式，分别是ZEN、EC2，用的最多的是ZEN。</span><br><span class="line">Scripting模块： 脚本模块、可以自己写一段脚本代码 来进行元数据的二次处理 返回给前台页面。（性能低最好别用）</span><br><span class="line">3rdPlugins：第三方插件，ElasticScarch支持很多的第三方插件。</span><br><span class="line"></span><br><span class="line">Transport层：</span><br><span class="line">Transport层主要用于数据的传输、想访问ElasticScarch，第一步就是要和它进行连接，那么连接的步骤和数据的传输，就在这层。一般我们都用http进行交互。</span><br><span class="line"></span><br><span class="line">RESTful 层：访问</span><br></pre></td></tr></table></figure>

<p>** ES支持的客户端连接方式 **</p>
<p>1、REST API ，端口 9200</p>
<p>这种连接方式对应于架构图中的RESTful style API这一层，这种客户端的连接方式是RESTful风格的，使用http的方式进行连接</p>
<p>2、Transport 连接 端口 9300</p>
<p>这种连接方式对应于架构图中的Transport这一层，这种客户端连接方式是直接连接ES的节点，使用TCP的方式进行连接</p>
<p>3、多种编程语言客户端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Java REST Client [7.4] — other versions</span><br><span class="line">Java API [7.4] — other versions</span><br><span class="line">JavaScript API [7.x] — other versions</span><br><span class="line">Ruby API [7.x] — other versions</span><br><span class="line">Go API</span><br><span class="line">.NET API [7.x] — other versions</span><br><span class="line">PHP API [7.2] — other versions</span><br><span class="line">Perl API</span><br><span class="line">Python API</span><br><span class="line">Community Contributed Clients</span><br></pre></td></tr></table></figure>
<h1 id="Java-REST-Client"><a href="#Java-REST-Client" class="headerlink" title="Java REST Client"></a>Java REST Client</h1><p>** ES提供了两个JAVA REST client 版本** </p>
<p>Java Low Level REST Client: 低级别的REST客户端，通过http与集群交互，用户需自己编组请求JSON串，及解析响应JSON串。兼容所有ES版本。</p>
<p>Java High Level REST Client: 高级别的REST客户端，基于低级别的REST客户端，增加了编组请求JSON串、解析响应JSON串等相关api。使用的版本需要保持和ES服务端的版本一致，否则会有版本问题。</p>
<p>** Java Low Level REST Client ** </p>
<p>maven 引入、使用介绍： <a href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-low.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-low.html</a></p>
<p>API doc ：<a href="https://artifacts.elastic.co/javadoc/org/elasticsearch/client/elasticsearch-rest-client/6.2.4/index.html" target="_blank" rel="noopener">https://artifacts.elastic.co/javadoc/org/elasticsearch/client/elasticsearch-rest-client/6.2.4/index.html</a>.</p>
<p>** Java High Level REST Client ** </p>
<p>从6.0.0开始加入的，目的是以java面向对象的方式来进行请求、响应处理。每个API 支持 同步/异步 两种方式，同步方法直接返回一个结果对象。异步的方法以async为后缀，通过listener参数来通知结果。<br>高级java REST 客户端依赖Elasticsearch core project</p>
<p>兼容性说明：依赖 java1.8 和 Elasticsearch core project，请使用与服务端ES版本一致的客户端版本</p>
<p>** Java High Level REST Client  maven 集成** </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.2.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>** Java High Level REST Client  初始化** </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RestHighLevelClient client = <span class="keyword">new</span> RestHighLevelClient(</span><br><span class="line">        RestClient.builder(</span><br><span class="line">                <span class="keyword">new</span> HttpHost(<span class="string">"localhost"</span>, <span class="number">9200</span>, <span class="string">"http"</span>),</span><br><span class="line">                <span class="keyword">new</span> HttpHost(<span class="string">"localhost"</span>, <span class="number">9201</span>, <span class="string">"http"</span>)));</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">client.close();</span><br></pre></td></tr></table></figure>
<p>给定集群的多个节点地址，将客户端负载均衡地向这个节点地址集发请求，API及用法示例，请参考：<a href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-supported-apis.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-supported-apis.html</a></p>
<h1 id="Java-High-Level-REST-Client-使用示例"><a href="#Java-High-Level-REST-Client-使用示例" class="headerlink" title="Java High Level REST Client  使用示例"></a>Java High Level REST Client  使用示例</h1><h2 id="引入包"><a href="#引入包" class="headerlink" title="引入包"></a>引入包</h2><p>maven工程里面引入和ES服务端版本一样的Java客户端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.elasticsearch.client&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;elasticsearch-rest-high-level-client&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;6.2.4&lt;&#x2F;version&gt;</span><br><span class="line"> &lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
<h2 id="初始化客户端"><a href="#初始化客户端" class="headerlink" title="初始化客户端"></a>初始化客户端</h2><p>给定集群的多个节点地址，将客户端负载均衡地向这个节点地址集发请求。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class InitDemo &#123;</span><br><span class="line"></span><br><span class="line">    public static RestHighLevelClient getClient() &#123;</span><br><span class="line"></span><br><span class="line">        RestHighLevelClient client &#x3D; new RestHighLevelClient(</span><br><span class="line">                RestClient.builder(new HttpHost(&quot;localhost&quot;, 9200, &quot;http&quot;),</span><br><span class="line">                        new HttpHost(&quot;localhost&quot;, 9201, &quot;http&quot;)));</span><br><span class="line"></span><br><span class="line">        return client;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Create-index-创建索引"><a href="#Create-index-创建索引" class="headerlink" title="Create index 创建索引"></a>Create index 创建索引</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreateIndexDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (RestHighLevelClient client = InitDemo.getClient();) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 1、创建 创建索引request 参数：索引名mess</span></span><br><span class="line">            CreateIndexRequest request = <span class="keyword">new</span> CreateIndexRequest(<span class="string">"mess"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2、设置索引的settings</span></span><br><span class="line">            request.settings(Settings.builder().put(<span class="string">"index.number_of_shards"</span>, <span class="number">3</span>) <span class="comment">// 分片数</span></span><br><span class="line">                    .put(<span class="string">"index.number_of_replicas"</span>, <span class="number">2</span>) <span class="comment">// 副本数</span></span><br><span class="line">                    .put(<span class="string">"analysis.analyzer.default.tokenizer"</span>, <span class="string">"ik_smart"</span>) <span class="comment">// 默认分词器</span></span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3、设置索引的mappings</span></span><br><span class="line">            request.mapping(<span class="string">"_doc"</span>,</span><br><span class="line">                    <span class="string">"  &#123;\n"</span> +</span><br><span class="line">                    <span class="string">"    \"_doc\": &#123;\n"</span> +</span><br><span class="line">                    <span class="string">"      \"properties\": &#123;\n"</span> +</span><br><span class="line">                    <span class="string">"        \"message\": &#123;\n"</span> +</span><br><span class="line">                    <span class="string">"          \"type\": \"text\"\n"</span> +</span><br><span class="line">                    <span class="string">"        &#125;\n"</span> +</span><br><span class="line">                    <span class="string">"      &#125;\n"</span> +</span><br><span class="line">                    <span class="string">"    &#125;\n"</span> +</span><br><span class="line">                    <span class="string">"  &#125;"</span>,</span><br><span class="line">                    XContentType.JSON);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4、 设置索引的别名</span></span><br><span class="line">            request.alias(<span class="keyword">new</span> Alias(<span class="string">"mmm"</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 5、 发送请求</span></span><br><span class="line">            <span class="comment">// 5.1 同步方式发送请求</span></span><br><span class="line">            CreateIndexResponse createIndexResponse = client.indices()</span><br><span class="line">                    .create(request);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 6、处理响应</span></span><br><span class="line">            <span class="keyword">boolean</span> acknowledged = createIndexResponse.isAcknowledged();</span><br><span class="line">            <span class="keyword">boolean</span> shardsAcknowledged = createIndexResponse</span><br><span class="line">                    .isShardsAcknowledged();</span><br><span class="line">            System.out.println(<span class="string">"acknowledged = "</span> + acknowledged);</span><br><span class="line">            System.out.println(<span class="string">"shardsAcknowledged = "</span> + shardsAcknowledged);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 5.1 异步方式发送请求</span></span><br><span class="line">            <span class="comment">/*ActionListener&lt;CreateIndexResponse&gt; listener = new ActionListener&lt;CreateIndexResponse&gt;() &#123;</span></span><br><span class="line"><span class="comment">                @Override</span></span><br><span class="line"><span class="comment">                public void onResponse(</span></span><br><span class="line"><span class="comment">                        CreateIndexResponse createIndexResponse) &#123;</span></span><br><span class="line"><span class="comment">                    // 6、处理响应</span></span><br><span class="line"><span class="comment">                    boolean acknowledged = createIndexResponse.isAcknowledged();</span></span><br><span class="line"><span class="comment">                    boolean shardsAcknowledged = createIndexResponse</span></span><br><span class="line"><span class="comment">                            .isShardsAcknowledged();</span></span><br><span class="line"><span class="comment">                    System.out.println("acknowledged = " + acknowledged);</span></span><br><span class="line"><span class="comment">                    System.out.println(</span></span><br><span class="line"><span class="comment">                            "shardsAcknowledged = " + shardsAcknowledged);</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                @Override</span></span><br><span class="line"><span class="comment">                public void onFailure(Exception e) &#123;</span></span><br><span class="line"><span class="comment">                    System.out.println("创建索引异常：" + e.getMessage());</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            client.indices().createAsync(request, listener);</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="index-document"><a href="#index-document" class="headerlink" title="index  document"></a>index  document</h2><p> 索引文档，即往索引里面放入文档数据.类似于数据库里面向表里面插入一行数据，一行数据就是一个文档。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexDocumentDemo</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LogManager.getRootLogger();  </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (RestHighLevelClient client = InitDemo.getClient();) &#123;</span><br><span class="line">            <span class="comment">// 1、创建索引请求</span></span><br><span class="line">            IndexRequest request = <span class="keyword">new</span> IndexRequest(</span><br><span class="line">                    <span class="string">"mess"</span>,   <span class="comment">//索引</span></span><br><span class="line">                    <span class="string">"_doc"</span>,     <span class="comment">// mapping type</span></span><br><span class="line">                    <span class="string">"1"</span>);     <span class="comment">//文档id  </span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2、准备文档数据</span></span><br><span class="line">            <span class="comment">// 方式一：直接给JSON串</span></span><br><span class="line">            String jsonString = <span class="string">"&#123;"</span> +</span><br><span class="line">                    <span class="string">"\"user\":\"kimchy\","</span> +</span><br><span class="line">                    <span class="string">"\"postDate\":\"2013-01-30\","</span> +</span><br><span class="line">                    <span class="string">"\"message\":\"trying out Elasticsearch\""</span> +</span><br><span class="line">                    <span class="string">"&#125;"</span>;</span><br><span class="line">            request.source(jsonString, XContentType.JSON); </span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 方式二：以map对象来表示文档</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            Map&lt;String, Object&gt; jsonMap = new HashMap&lt;&gt;();</span></span><br><span class="line"><span class="comment">            jsonMap.put("user", "kimchy");</span></span><br><span class="line"><span class="comment">            jsonMap.put("postDate", new Date());</span></span><br><span class="line"><span class="comment">            jsonMap.put("message", "trying out Elasticsearch");</span></span><br><span class="line"><span class="comment">            request.source(jsonMap); </span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 方式三：用XContentBuilder来构建文档</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            XContentBuilder builder = XContentFactory.jsonBuilder();</span></span><br><span class="line"><span class="comment">            builder.startObject();</span></span><br><span class="line"><span class="comment">            &#123;</span></span><br><span class="line"><span class="comment">                builder.field("user", "kimchy");</span></span><br><span class="line"><span class="comment">                builder.field("postDate", new Date());</span></span><br><span class="line"><span class="comment">                builder.field("message", "trying out Elasticsearch");</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">            builder.endObject();</span></span><br><span class="line"><span class="comment">            request.source(builder); </span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 方式四：直接用key-value对给出</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            request.source("user", "kimchy",</span></span><br><span class="line"><span class="comment">                            "postDate", new Date(),</span></span><br><span class="line"><span class="comment">                            "message", "trying out Elasticsearch");</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//3、其他的一些可选设置</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            request.routing("routing");  //设置routing值</span></span><br><span class="line"><span class="comment">            request.timeout(TimeValue.timeValueSeconds(1));  //设置主分片等待时长</span></span><br><span class="line"><span class="comment">            request.setRefreshPolicy("wait_for");  //设置重刷新策略</span></span><br><span class="line"><span class="comment">            request.version(2);  //设置版本号</span></span><br><span class="line"><span class="comment">            request.opType(DocWriteRequest.OpType.CREATE);  //操作类别  </span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//4、发送请求</span></span><br><span class="line">            IndexResponse indexResponse = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 同步方式</span></span><br><span class="line">                indexResponse = client.index(request);            </span><br><span class="line">            &#125; <span class="keyword">catch</span>(ElasticsearchException e) &#123;</span><br><span class="line">                <span class="comment">// 捕获，并处理异常</span></span><br><span class="line">                <span class="comment">//判断是否版本冲突、create但文档已存在冲突</span></span><br><span class="line">                <span class="keyword">if</span> (e.status() == RestStatus.CONFLICT) &#123;</span><br><span class="line">                    logger.error(<span class="string">"冲突了，请在此写冲突处理逻辑！\n"</span> + e.getDetailedMessage());</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                logger.error(<span class="string">"索引异常"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//5、处理响应</span></span><br><span class="line">            <span class="keyword">if</span>(indexResponse != <span class="keyword">null</span>) &#123;</span><br><span class="line">                String index = indexResponse.getIndex();</span><br><span class="line">                String type = indexResponse.getType();</span><br><span class="line">                String id = indexResponse.getId();</span><br><span class="line">                <span class="keyword">long</span> version = indexResponse.getVersion();</span><br><span class="line">                <span class="keyword">if</span> (indexResponse.getResult() == DocWriteResponse.Result.CREATED) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"新增文档成功，处理逻辑代码写到这里。"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (indexResponse.getResult() == DocWriteResponse.Result.UPDATED) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"修改文档成功，处理逻辑代码写到这里。"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 分片处理信息</span></span><br><span class="line">                ReplicationResponse.ShardInfo shardInfo = indexResponse.getShardInfo();</span><br><span class="line">                <span class="keyword">if</span> (shardInfo.getTotal() != shardInfo.getSuccessful()) &#123;</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果有分片副本失败，可以获得失败原因信息</span></span><br><span class="line">                <span class="keyword">if</span> (shardInfo.getFailed() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (ReplicationResponse.ShardInfo.Failure failure : shardInfo.getFailures()) &#123;</span><br><span class="line">                        String reason = failure.reason(); </span><br><span class="line">                        System.out.println(<span class="string">"副本失败原因："</span> + reason);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            <span class="comment">//异步方式发送索引请求</span></span><br><span class="line">            <span class="comment">/*ActionListener&lt;IndexResponse&gt; listener = new ActionListener&lt;IndexResponse&gt;() &#123;</span></span><br><span class="line"><span class="comment">                @Override</span></span><br><span class="line"><span class="comment">                public void onResponse(IndexResponse indexResponse) &#123;</span></span><br><span class="line"><span class="comment">                    </span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                @Override</span></span><br><span class="line"><span class="comment">                public void onFailure(Exception e) &#123;</span></span><br><span class="line"><span class="comment">                    </span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;;</span></span><br><span class="line"><span class="comment">            client.indexAsync(request, listener);</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="获取文档数据"><a href="#获取文档数据" class="headerlink" title="获取文档数据"></a>获取文档数据</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetDocumentDemo</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LogManager.getRootLogger();  </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (RestHighLevelClient client = InitDemo.getClient();) &#123;</span><br><span class="line">            <span class="comment">// 1、创建获取文档请求</span></span><br><span class="line">            GetRequest request = <span class="keyword">new</span> GetRequest(</span><br><span class="line">                    <span class="string">"mess"</span>,   <span class="comment">//索引</span></span><br><span class="line">                    <span class="string">"_doc"</span>,     <span class="comment">// mapping type</span></span><br><span class="line">                    <span class="string">"1"</span>);     <span class="comment">//文档id  </span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2、可选的设置</span></span><br><span class="line">            <span class="comment">//request.routing("routing");</span></span><br><span class="line">            <span class="comment">//request.version(2);</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//request.fetchSourceContext(new FetchSourceContext(false)); //是否获取_source字段</span></span><br><span class="line">            <span class="comment">//选择返回的字段</span></span><br><span class="line">            String[] includes = <span class="keyword">new</span> String[]&#123;<span class="string">"message"</span>, <span class="string">"*Date"</span>&#125;;</span><br><span class="line">            String[] excludes = Strings.EMPTY_ARRAY;</span><br><span class="line">            FetchSourceContext fetchSourceContext = <span class="keyword">new</span> FetchSourceContext(<span class="keyword">true</span>, includes, excludes);</span><br><span class="line">            request.fetchSourceContext(fetchSourceContext); </span><br><span class="line">            </span><br><span class="line">            <span class="comment">//也可写成这样</span></span><br><span class="line">            <span class="comment">/*String[] includes = Strings.EMPTY_ARRAY;</span></span><br><span class="line"><span class="comment">            String[] excludes = new String[]&#123;"message"&#125;;</span></span><br><span class="line"><span class="comment">            FetchSourceContext fetchSourceContext = new FetchSourceContext(true, includes, excludes);</span></span><br><span class="line"><span class="comment">            request.fetchSourceContext(fetchSourceContext);*/</span></span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 取stored字段</span></span><br><span class="line">            <span class="comment">/*request.storedFields("message"); </span></span><br><span class="line"><span class="comment">            GetResponse getResponse = client.get(request);</span></span><br><span class="line"><span class="comment">            String message = getResponse.getField("message").getValue();*/</span></span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            <span class="comment">//3、发送请求        </span></span><br><span class="line">            GetResponse getResponse = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 同步请求</span></span><br><span class="line">                getResponse = client.get(request);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ElasticsearchException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.status() == RestStatus.NOT_FOUND) &#123;</span><br><span class="line">                    logger.error(<span class="string">"没有找到该id的文档"</span> );</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (e.status() == RestStatus.CONFLICT) &#123;</span><br><span class="line">                    logger.error(<span class="string">"获取时版本冲突了，请在此写冲突处理逻辑！"</span> );</span><br><span class="line">                &#125;</span><br><span class="line">                logger.error(<span class="string">"获取文档异常"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//4、处理响应</span></span><br><span class="line">            <span class="keyword">if</span>(getResponse != <span class="keyword">null</span>) &#123;</span><br><span class="line">                String index = getResponse.getIndex();</span><br><span class="line">                String type = getResponse.getType();</span><br><span class="line">                String id = getResponse.getId();</span><br><span class="line">                <span class="keyword">if</span> (getResponse.isExists()) &#123; <span class="comment">// 文档存在</span></span><br><span class="line">                    <span class="keyword">long</span> version = getResponse.getVersion();</span><br><span class="line">                    String sourceAsString = getResponse.getSourceAsString(); <span class="comment">//结果取成 String       </span></span><br><span class="line">                    Map&lt;String, Object&gt; sourceAsMap = getResponse.getSourceAsMap();  <span class="comment">// 结果取成Map</span></span><br><span class="line">                    <span class="keyword">byte</span>[] sourceAsBytes = getResponse.getSourceAsBytes();    <span class="comment">//结果取成字节数组</span></span><br><span class="line">                    </span><br><span class="line">                    logger.info(<span class="string">"index:"</span> + index + <span class="string">"  type:"</span> + type + <span class="string">"  id:"</span> + id);</span><br><span class="line">                    logger.info(sourceAsString);</span><br><span class="line">                    </span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    logger.error(<span class="string">"没有找到该id的文档"</span> );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            <span class="comment">//异步方式发送获取文档请求</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            ActionListener&lt;GetResponse&gt; listener = new ActionListener&lt;GetResponse&gt;() &#123;</span></span><br><span class="line"><span class="comment">                @Override</span></span><br><span class="line"><span class="comment">                public void onResponse(GetResponse getResponse) &#123;</span></span><br><span class="line"><span class="comment">                    </span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            </span></span><br><span class="line"><span class="comment">                @Override</span></span><br><span class="line"><span class="comment">                public void onFailure(Exception e) &#123;</span></span><br><span class="line"><span class="comment">                    </span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;;</span></span><br><span class="line"><span class="comment">            client.getAsync(request, listener);</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="批量索引文档"><a href="#批量索引文档" class="headerlink" title="批量索引文档"></a>批量索引文档</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BulkDemo</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LogManager.getRootLogger();  </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (RestHighLevelClient client = InitDemo.getClient();) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 1、创建批量操作请求</span></span><br><span class="line">            BulkRequest request = <span class="keyword">new</span> BulkRequest(); </span><br><span class="line">            request.add(<span class="keyword">new</span> IndexRequest(<span class="string">"mess"</span>, <span class="string">"_doc"</span>, <span class="string">"1"</span>)  </span><br><span class="line">                    .source(XContentType.JSON,<span class="string">"field"</span>, <span class="string">"foo"</span>));</span><br><span class="line">            request.add(<span class="keyword">new</span> IndexRequest(<span class="string">"mess"</span>, <span class="string">"_doc"</span>, <span class="string">"2"</span>)  </span><br><span class="line">                    .source(XContentType.JSON,<span class="string">"field"</span>, <span class="string">"bar"</span>));</span><br><span class="line">            request.add(<span class="keyword">new</span> IndexRequest(<span class="string">"mess"</span>, <span class="string">"_doc"</span>, <span class="string">"3"</span>)  </span><br><span class="line">                    .source(XContentType.JSON,<span class="string">"field"</span>, <span class="string">"baz"</span>));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            request.add(new DeleteRequest("mess", "_doc", "3")); </span></span><br><span class="line"><span class="comment">            request.add(new UpdateRequest("mess", "_doc", "2") </span></span><br><span class="line"><span class="comment">                    .doc(XContentType.JSON,"other", "test"));</span></span><br><span class="line"><span class="comment">            request.add(new IndexRequest("mess", "_doc", "4")  </span></span><br><span class="line"><span class="comment">                    .source(XContentType.JSON,"field", "baz"));</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2、可选的设置</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            request.timeout("2m");</span></span><br><span class="line"><span class="comment">            request.setRefreshPolicy("wait_for");  </span></span><br><span class="line"><span class="comment">            request.waitForActiveShards(2);</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            <span class="comment">//3、发送请求        </span></span><br><span class="line">        </span><br><span class="line">            <span class="comment">// 同步请求</span></span><br><span class="line">            BulkResponse bulkResponse = client.bulk(request);</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            <span class="comment">//4、处理响应</span></span><br><span class="line">            <span class="keyword">if</span>(bulkResponse != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (BulkItemResponse bulkItemResponse : bulkResponse) &#123; </span><br><span class="line">                    DocWriteResponse itemResponse = bulkItemResponse.getResponse(); </span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (bulkItemResponse.getOpType() == DocWriteRequest.OpType.INDEX</span><br><span class="line">                            || bulkItemResponse.getOpType() == DocWriteRequest.OpType.CREATE) &#123; </span><br><span class="line">                        IndexResponse indexResponse = (IndexResponse) itemResponse;</span><br><span class="line">                        <span class="comment">//TODO 新增成功的处理</span></span><br><span class="line"></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bulkItemResponse.getOpType() == DocWriteRequest.OpType.UPDATE) &#123; </span><br><span class="line">                        UpdateResponse updateResponse = (UpdateResponse) itemResponse;</span><br><span class="line">                       <span class="comment">//TODO 修改成功的处理</span></span><br><span class="line"></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bulkItemResponse.getOpType() == DocWriteRequest.OpType.DELETE) &#123; </span><br><span class="line">                        DeleteResponse deleteResponse = (DeleteResponse) itemResponse;</span><br><span class="line">                        <span class="comment">//TODO 删除成功的处理</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            <span class="comment">//异步方式发送批量操作请求</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            ActionListener&lt;BulkResponse&gt; listener = new ActionListener&lt;BulkResponse&gt;() &#123;</span></span><br><span class="line"><span class="comment">                @Override</span></span><br><span class="line"><span class="comment">                public void onResponse(BulkResponse bulkResponse) &#123;</span></span><br><span class="line"><span class="comment">                    </span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            </span></span><br><span class="line"><span class="comment">                @Override</span></span><br><span class="line"><span class="comment">                public void onFailure(Exception e) &#123;</span></span><br><span class="line"><span class="comment">                    </span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;;</span></span><br><span class="line"><span class="comment">            client.bulkAsync(request, listener);</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="搜索数据"><a href="#搜索数据" class="headerlink" title="搜索数据"></a>搜索数据</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchDemo</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LogManager.getRootLogger();  </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (RestHighLevelClient client = InitDemo.getClient();) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 1、创建search请求</span></span><br><span class="line">            <span class="comment">//SearchRequest searchRequest = new SearchRequest();</span></span><br><span class="line">            SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"bank"</span>); </span><br><span class="line">            searchRequest.types(<span class="string">"_doc"</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2、用SearchSourceBuilder来构造查询请求体 ,请仔细查看它的方法，构造各种查询的方法都在这。</span></span><br><span class="line">            SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder(); </span><br><span class="line">            </span><br><span class="line">            <span class="comment">//构造QueryBuilder</span></span><br><span class="line">            <span class="comment">/*QueryBuilder matchQueryBuilder = QueryBuilders.matchQuery("user", "kimchy")</span></span><br><span class="line"><span class="comment">                    .fuzziness(Fuzziness.AUTO)</span></span><br><span class="line"><span class="comment">                    .prefixLength(3)</span></span><br><span class="line"><span class="comment">                    .maxExpansions(10);</span></span><br><span class="line"><span class="comment">            sourceBuilder.query(matchQueryBuilder);*/</span></span><br><span class="line">            </span><br><span class="line">            sourceBuilder.query(QueryBuilders.termQuery(<span class="string">"age"</span>, <span class="number">24</span>)); </span><br><span class="line">            sourceBuilder.from(<span class="number">0</span>); </span><br><span class="line">            sourceBuilder.size(<span class="number">10</span>); </span><br><span class="line">            sourceBuilder.timeout(<span class="keyword">new</span> TimeValue(<span class="number">60</span>, TimeUnit.SECONDS)); </span><br><span class="line">            </span><br><span class="line">            <span class="comment">//是否返回_source字段</span></span><br><span class="line">            <span class="comment">//sourceBuilder.fetchSource(false);</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//设置返回哪些字段</span></span><br><span class="line">            <span class="comment">/*String[] includeFields = new String[] &#123;"title", "user", "innerObject.*"&#125;;</span></span><br><span class="line"><span class="comment">            String[] excludeFields = new String[] &#123;"_type"&#125;;</span></span><br><span class="line"><span class="comment">            sourceBuilder.fetchSource(includeFields, excludeFields);*/</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//指定排序</span></span><br><span class="line">            <span class="comment">//sourceBuilder.sort(new ScoreSortBuilder().order(SortOrder.DESC)); </span></span><br><span class="line">            <span class="comment">//sourceBuilder.sort(new FieldSortBuilder("_uid").order(SortOrder.ASC));</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 设置返回 profile </span></span><br><span class="line">            <span class="comment">//sourceBuilder.profile(true);</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//将请求体加入到请求中</span></span><br><span class="line">            searchRequest.source(sourceBuilder);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 可选的设置</span></span><br><span class="line">            <span class="comment">//searchRequest.routing("routing");</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 高亮设置</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            HighlightBuilder highlightBuilder = new HighlightBuilder(); </span></span><br><span class="line"><span class="comment">            HighlightBuilder.Field highlightTitle =</span></span><br><span class="line"><span class="comment">                    new HighlightBuilder.Field("title"); </span></span><br><span class="line"><span class="comment">            highlightTitle.highlighterType("unified");  </span></span><br><span class="line"><span class="comment">            highlightBuilder.field(highlightTitle);  </span></span><br><span class="line"><span class="comment">            HighlightBuilder.Field highlightUser = new HighlightBuilder.Field("user");</span></span><br><span class="line"><span class="comment">            highlightBuilder.field(highlightUser);</span></span><br><span class="line"><span class="comment">            sourceBuilder.highlighter(highlightBuilder);*/</span></span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            <span class="comment">//加入聚合</span></span><br><span class="line">            <span class="comment">/*TermsAggregationBuilder aggregation = AggregationBuilders.terms("by_company")</span></span><br><span class="line"><span class="comment">                    .field("company.keyword");</span></span><br><span class="line"><span class="comment">            aggregation.subAggregation(AggregationBuilders.avg("average_age")</span></span><br><span class="line"><span class="comment">                    .field("age"));</span></span><br><span class="line"><span class="comment">            sourceBuilder.aggregation(aggregation);*/</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//做查询建议</span></span><br><span class="line">            <span class="comment">/*SuggestionBuilder termSuggestionBuilder =</span></span><br><span class="line"><span class="comment">                    SuggestBuilders.termSuggestion("user").text("kmichy"); </span></span><br><span class="line"><span class="comment">                SuggestBuilder suggestBuilder = new SuggestBuilder();</span></span><br><span class="line"><span class="comment">                suggestBuilder.addSuggestion("suggest_user", termSuggestionBuilder); </span></span><br><span class="line"><span class="comment">            sourceBuilder.suggest(suggestBuilder);*/</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//3、发送请求        </span></span><br><span class="line">            SearchResponse searchResponse = client.search(searchRequest);</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            <span class="comment">//4、处理响应</span></span><br><span class="line">            <span class="comment">//搜索结果状态信息</span></span><br><span class="line">            RestStatus status = searchResponse.status();</span><br><span class="line">            TimeValue took = searchResponse.getTook();</span><br><span class="line">            Boolean terminatedEarly = searchResponse.isTerminatedEarly();</span><br><span class="line">            <span class="keyword">boolean</span> timedOut = searchResponse.isTimedOut();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//分片搜索情况</span></span><br><span class="line">            <span class="keyword">int</span> totalShards = searchResponse.getTotalShards();</span><br><span class="line">            <span class="keyword">int</span> successfulShards = searchResponse.getSuccessfulShards();</span><br><span class="line">            <span class="keyword">int</span> failedShards = searchResponse.getFailedShards();</span><br><span class="line">            <span class="keyword">for</span> (ShardSearchFailure failure : searchResponse.getShardFailures()) &#123;</span><br><span class="line">                <span class="comment">// failures should be handled here</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//处理搜索命中文档结果</span></span><br><span class="line">            SearchHits hits = searchResponse.getHits();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">long</span> totalHits = hits.getTotalHits();</span><br><span class="line">            <span class="keyword">float</span> maxScore = hits.getMaxScore();</span><br><span class="line">            </span><br><span class="line">            SearchHit[] searchHits = hits.getHits();</span><br><span class="line">            <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">                <span class="comment">// do something with the SearchHit</span></span><br><span class="line">                </span><br><span class="line">                String index = hit.getIndex();</span><br><span class="line">                String type = hit.getType();</span><br><span class="line">                String id = hit.getId();</span><br><span class="line">                <span class="keyword">float</span> score = hit.getScore();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//取_source字段值</span></span><br><span class="line">                String sourceAsString = hit.getSourceAsString(); <span class="comment">//取成json串</span></span><br><span class="line">                Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap(); <span class="comment">// 取成map对象</span></span><br><span class="line">                <span class="comment">//从map中取字段值</span></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                String documentTitle = (String) sourceAsMap.get("title"); </span></span><br><span class="line"><span class="comment">                List&lt;Object&gt; users = (List&lt;Object&gt;) sourceAsMap.get("user");</span></span><br><span class="line"><span class="comment">                Map&lt;String, Object&gt; innerObject = (Map&lt;String, Object&gt;) sourceAsMap.get("innerObject");</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                logger.info(<span class="string">"index:"</span> + index + <span class="string">"  type:"</span> + type + <span class="string">"  id:"</span> + id);</span><br><span class="line">                logger.info(sourceAsString);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//取高亮结果</span></span><br><span class="line">                <span class="comment">/*Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();</span></span><br><span class="line"><span class="comment">                HighlightField highlight = highlightFields.get("title"); </span></span><br><span class="line"><span class="comment">                Text[] fragments = highlight.fragments();  </span></span><br><span class="line"><span class="comment">                String fragmentString = fragments[0].string();*/</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 获取聚合结果</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            Aggregations aggregations = searchResponse.getAggregations();</span></span><br><span class="line"><span class="comment">            Terms byCompanyAggregation = aggregations.get("by_company"); </span></span><br><span class="line"><span class="comment">            Bucket elasticBucket = byCompanyAggregation.getBucketByKey("Elastic"); </span></span><br><span class="line"><span class="comment">            Avg averageAge = elasticBucket.getAggregations().get("average_age"); </span></span><br><span class="line"><span class="comment">            double avg = averageAge.getValue();</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 获取建议结果</span></span><br><span class="line">            <span class="comment">/*Suggest suggest = searchResponse.getSuggest(); </span></span><br><span class="line"><span class="comment">            TermSuggestion termSuggestion = suggest.getSuggestion("suggest_user"); </span></span><br><span class="line"><span class="comment">            for (TermSuggestion.Entry entry : termSuggestion.getEntries()) &#123; </span></span><br><span class="line"><span class="comment">                for (TermSuggestion.Entry.Option option : entry) &#123; </span></span><br><span class="line"><span class="comment">                    String suggestText = option.getText().string();</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//异步方式发送获查询请求</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            ActionListener&lt;SearchResponse&gt; listener = new ActionListener&lt;SearchResponse&gt;() &#123;</span></span><br><span class="line"><span class="comment">                @Override</span></span><br><span class="line"><span class="comment">                public void onResponse(SearchResponse getResponse) &#123;</span></span><br><span class="line"><span class="comment">                    //结果获取</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            </span></span><br><span class="line"><span class="comment">                @Override</span></span><br><span class="line"><span class="comment">                public void onFailure(Exception e) &#123;</span></span><br><span class="line"><span class="comment">                    //失败处理</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;;</span></span><br><span class="line"><span class="comment">            client.searchAsync(searchRequest, listener); </span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.error(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="highlight-高亮"><a href="#highlight-高亮" class="headerlink" title="highlight 高亮"></a>highlight 高亮</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HighlightDemo</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LogManager.getRootLogger();  </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (RestHighLevelClient client = InitDemo.getClient();) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 1、创建search请求</span></span><br><span class="line">            SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"hl_test"</span>); </span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2、用SearchSourceBuilder来构造查询请求体 ,请仔细查看它的方法，构造各种查询的方法都在这。</span></span><br><span class="line">            SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder(); </span><br><span class="line">            </span><br><span class="line">            <span class="comment">//构造QueryBuilder</span></span><br><span class="line">            QueryBuilder matchQueryBuilder = QueryBuilders.matchQuery(<span class="string">"title"</span>, <span class="string">"lucene solr"</span>);</span><br><span class="line">            sourceBuilder.query(matchQueryBuilder);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//分页设置</span></span><br><span class="line">            <span class="comment">/*sourceBuilder.from(0); </span></span><br><span class="line"><span class="comment">            sourceBuilder.size(5); ;*/</span> </span><br><span class="line">            </span><br><span class="line">                    </span><br><span class="line">            <span class="comment">// 高亮设置</span></span><br><span class="line">            HighlightBuilder highlightBuilder = <span class="keyword">new</span> HighlightBuilder(); </span><br><span class="line">            highlightBuilder.requireFieldMatch(<span class="keyword">false</span>).field(<span class="string">"title"</span>).field(<span class="string">"content"</span>)</span><br><span class="line">                .preTags(<span class="string">"&lt;strong&gt;"</span>).postTags(<span class="string">"&lt;/strong&gt;"</span>);</span><br><span class="line">            <span class="comment">//不同字段可有不同设置，如不同标签</span></span><br><span class="line">            <span class="comment">/*HighlightBuilder.Field highlightTitle = new HighlightBuilder.Field("title"); </span></span><br><span class="line"><span class="comment">            highlightTitle.preTags("&lt;strong&gt;").postTags("&lt;/strong&gt;");</span></span><br><span class="line"><span class="comment">            highlightBuilder.field(highlightTitle);  </span></span><br><span class="line"><span class="comment">            HighlightBuilder.Field highlightContent = new HighlightBuilder.Field("content");</span></span><br><span class="line"><span class="comment">            highlightContent.preTags("&lt;b&gt;").postTags("&lt;/b&gt;");</span></span><br><span class="line"><span class="comment">            highlightBuilder.field(highlightContent).requireFieldMatch(false);*/</span></span><br><span class="line">            </span><br><span class="line">            sourceBuilder.highlighter(highlightBuilder);</span><br><span class="line">            </span><br><span class="line">            searchRequest.source(sourceBuilder);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//3、发送请求        </span></span><br><span class="line">            SearchResponse searchResponse = client.search(searchRequest);</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            <span class="comment">//4、处理响应</span></span><br><span class="line">            <span class="keyword">if</span>(RestStatus.OK.equals(searchResponse.status())) &#123;</span><br><span class="line">                <span class="comment">//处理搜索命中文档结果</span></span><br><span class="line">                SearchHits hits = searchResponse.getHits();</span><br><span class="line">                <span class="keyword">long</span> totalHits = hits.getTotalHits();</span><br><span class="line">                </span><br><span class="line">                SearchHit[] searchHits = hits.getHits();</span><br><span class="line">                <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;        </span><br><span class="line">                    String index = hit.getIndex();</span><br><span class="line">                    String type = hit.getType();</span><br><span class="line">                    String id = hit.getId();</span><br><span class="line">                    <span class="keyword">float</span> score = hit.getScore();</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">//取_source字段值</span></span><br><span class="line">                    <span class="comment">//String sourceAsString = hit.getSourceAsString(); //取成json串</span></span><br><span class="line">                    Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap(); <span class="comment">// 取成map对象</span></span><br><span class="line">                    <span class="comment">//从map中取字段值</span></span><br><span class="line">                    <span class="comment">/*String title = (String) sourceAsMap.get("title"); </span></span><br><span class="line"><span class="comment">                    String content  = (String) sourceAsMap.get("content"); */</span></span><br><span class="line">                    logger.info(<span class="string">"index:"</span> + index + <span class="string">"  type:"</span> + type + <span class="string">"  id:"</span> + id);</span><br><span class="line">                    logger.info(<span class="string">"sourceMap : "</span> +  sourceAsMap);</span><br><span class="line">                    <span class="comment">//取高亮结果</span></span><br><span class="line">                    Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();</span><br><span class="line">                    HighlightField highlight = highlightFields.get(<span class="string">"title"</span>); </span><br><span class="line">                    <span class="keyword">if</span>(highlight != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        Text[] fragments = highlight.fragments();  <span class="comment">//多值的字段会有多个值</span></span><br><span class="line">                        <span class="keyword">if</span>(fragments != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            String fragmentString = fragments[<span class="number">0</span>].string();</span><br><span class="line">                            logger.info(<span class="string">"title highlight : "</span> +  fragmentString);</span><br><span class="line">                            <span class="comment">//可用高亮字符串替换上面sourceAsMap中的对应字段返回到上一级调用</span></span><br><span class="line">                            <span class="comment">//sourceAsMap.put("title", fragmentString);</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    highlight = highlightFields.get(<span class="string">"content"</span>); </span><br><span class="line">                    <span class="keyword">if</span>(highlight != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        Text[] fragments = highlight.fragments();  <span class="comment">//多值的字段会有多个值</span></span><br><span class="line">                        <span class="keyword">if</span>(fragments != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            String fragmentString = fragments[<span class="number">0</span>].string();</span><br><span class="line">                            logger.info(<span class="string">"content highlight : "</span> +  fragmentString);</span><br><span class="line">                            <span class="comment">//可用高亮字符串替换上面sourceAsMap中的对应字段返回到上一级调用</span></span><br><span class="line">                            <span class="comment">//sourceAsMap.put("content", fragmentString);</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.error(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="suggest-查询建议"><a href="#suggest-查询建议" class="headerlink" title="suggest 查询建议"></a>suggest 查询建议</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SuggestDemo</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LogManager.getRootLogger();  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//词项建议拼写检查，检查用户的拼写是否错误，如果有错给用户推荐正确的词，appel-&gt;apple</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">termSuggest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (RestHighLevelClient client = InitDemo.getClient();) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 1、创建search请求</span></span><br><span class="line">            <span class="comment">//SearchRequest searchRequest = new SearchRequest();</span></span><br><span class="line">            SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"mess"</span>); </span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2、用SearchSourceBuilder来构造查询请求体 ,请仔细查看它的方法，构造各种查询的方法都在这。</span></span><br><span class="line">            SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder(); </span><br><span class="line">             </span><br><span class="line">            sourceBuilder.size(<span class="number">0</span>); </span><br><span class="line">            </span><br><span class="line">            <span class="comment">//做查询建议        </span></span><br><span class="line">            <span class="comment">//词项建议</span></span><br><span class="line">            SuggestionBuilder termSuggestionBuilder =</span><br><span class="line">                    SuggestBuilders.termSuggestion(<span class="string">"user"</span>).text(<span class="string">"kmichy"</span>); </span><br><span class="line">            SuggestBuilder suggestBuilder = <span class="keyword">new</span> SuggestBuilder();</span><br><span class="line">            suggestBuilder.addSuggestion(<span class="string">"suggest_user"</span>, termSuggestionBuilder);     </span><br><span class="line">            sourceBuilder.suggest(suggestBuilder);</span><br><span class="line">            </span><br><span class="line">            searchRequest.source(sourceBuilder);    </span><br><span class="line">            </span><br><span class="line">            <span class="comment">//3、发送请求        </span></span><br><span class="line">            SearchResponse searchResponse = client.search(searchRequest);</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            <span class="comment">//4、处理响应</span></span><br><span class="line">            <span class="comment">//搜索结果状态信息</span></span><br><span class="line">            <span class="keyword">if</span>(RestStatus.OK.equals(searchResponse.status())) &#123;</span><br><span class="line">                <span class="comment">// 获取建议结果</span></span><br><span class="line">                Suggest suggest = searchResponse.getSuggest(); </span><br><span class="line">                TermSuggestion termSuggestion = suggest.getSuggestion(<span class="string">"suggest_user"</span>); </span><br><span class="line">                <span class="keyword">for</span> (TermSuggestion.Entry entry : termSuggestion.getEntries()) &#123; </span><br><span class="line">                    logger.info(<span class="string">"text: "</span> + entry.getText().string());</span><br><span class="line">                    <span class="keyword">for</span> (TermSuggestion.Entry.Option option : entry) &#123; </span><br><span class="line">                        String suggestText = option.getText().string();</span><br><span class="line">                        logger.info(<span class="string">"   suggest option : "</span> + suggestText);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">              "suggest": &#123;</span></span><br><span class="line"><span class="comment">                "my-suggestion": [</span></span><br><span class="line"><span class="comment">                  &#123;</span></span><br><span class="line"><span class="comment">                    "text": "tring",</span></span><br><span class="line"><span class="comment">                    "offset": 0,</span></span><br><span class="line"><span class="comment">                    "length": 5,</span></span><br><span class="line"><span class="comment">                    "options": [</span></span><br><span class="line"><span class="comment">                      &#123;</span></span><br><span class="line"><span class="comment">                        "text": "trying",</span></span><br><span class="line"><span class="comment">                        "score": 0.8,</span></span><br><span class="line"><span class="comment">                        "freq": 1</span></span><br><span class="line"><span class="comment">                      &#125;</span></span><br><span class="line"><span class="comment">                    ]</span></span><br><span class="line"><span class="comment">                  &#125;,</span></span><br><span class="line"><span class="comment">                  &#123;</span></span><br><span class="line"><span class="comment">                    "text": "out",</span></span><br><span class="line"><span class="comment">                    "offset": 6,</span></span><br><span class="line"><span class="comment">                    "length": 3,</span></span><br><span class="line"><span class="comment">                    "options": []</span></span><br><span class="line"><span class="comment">                  &#125;,</span></span><br><span class="line"><span class="comment">                  &#123;</span></span><br><span class="line"><span class="comment">                    "text": "elasticsearch",</span></span><br><span class="line"><span class="comment">                    "offset": 10,</span></span><br><span class="line"><span class="comment">                    "length": 13,</span></span><br><span class="line"><span class="comment">                    "options": []</span></span><br><span class="line"><span class="comment">                  &#125;</span></span><br><span class="line"><span class="comment">                ]</span></span><br><span class="line"><span class="comment">              &#125;*/</span></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.error(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//自动补全，根据用户的输入联想到可能的词或者短语</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">completionSuggester</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (RestHighLevelClient client = InitDemo.getClient();) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 1、创建search请求</span></span><br><span class="line">            <span class="comment">//SearchRequest searchRequest = new SearchRequest();</span></span><br><span class="line">            SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"music"</span>); </span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2、用SearchSourceBuilder来构造查询请求体 ,请仔细查看它的方法，构造各种查询的方法都在这。</span></span><br><span class="line">            SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder(); </span><br><span class="line">             </span><br><span class="line">            sourceBuilder.size(<span class="number">0</span>); </span><br><span class="line">            </span><br><span class="line">            <span class="comment">//做查询建议        </span></span><br><span class="line">            <span class="comment">//自动补全</span></span><br><span class="line">            <span class="comment">/*POST music/_search?pretty</span></span><br><span class="line"><span class="comment">                    &#123;</span></span><br><span class="line"><span class="comment">                        "suggest": &#123;</span></span><br><span class="line"><span class="comment">                            "song-suggest" : &#123;</span></span><br><span class="line"><span class="comment">                                "prefix" : "lucene s", </span></span><br><span class="line"><span class="comment">                                "completion" : &#123; </span></span><br><span class="line"><span class="comment">                                    "field" : "suggest" ,</span></span><br><span class="line"><span class="comment">                                    "skip_duplicates": true</span></span><br><span class="line"><span class="comment">                                &#125;</span></span><br><span class="line"><span class="comment">                            &#125;</span></span><br><span class="line"><span class="comment">                        &#125;</span></span><br><span class="line"><span class="comment">                    &#125;*/</span></span><br><span class="line"></span><br><span class="line">            SuggestionBuilder termSuggestionBuilder =</span><br><span class="line">                    SuggestBuilders.completionSuggestion(<span class="string">"suggest"</span>).prefix(<span class="string">"lucene s"</span>)</span><br><span class="line">                    .skipDuplicates(<span class="keyword">true</span>); </span><br><span class="line">            SuggestBuilder suggestBuilder = <span class="keyword">new</span> SuggestBuilder();</span><br><span class="line">            suggestBuilder.addSuggestion(<span class="string">"song-suggest"</span>, termSuggestionBuilder);     </span><br><span class="line">            sourceBuilder.suggest(suggestBuilder);</span><br><span class="line">            </span><br><span class="line">            searchRequest.source(sourceBuilder);    </span><br><span class="line">            </span><br><span class="line">            <span class="comment">//3、发送请求        </span></span><br><span class="line">            SearchResponse searchResponse = client.search(searchRequest);</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            <span class="comment">//4、处理响应</span></span><br><span class="line">            <span class="comment">//搜索结果状态信息</span></span><br><span class="line">            <span class="keyword">if</span>(RestStatus.OK.equals(searchResponse.status())) &#123;</span><br><span class="line">                <span class="comment">// 获取建议结果</span></span><br><span class="line">                Suggest suggest = searchResponse.getSuggest(); </span><br><span class="line">                CompletionSuggestion termSuggestion = suggest.getSuggestion(<span class="string">"song-suggest"</span>); </span><br><span class="line">                <span class="keyword">for</span> (CompletionSuggestion.Entry entry : termSuggestion.getEntries()) &#123; </span><br><span class="line">                    logger.info(<span class="string">"text: "</span> + entry.getText().string());</span><br><span class="line">                    <span class="keyword">for</span> (CompletionSuggestion.Entry.Option option : entry) &#123; </span><br><span class="line">                        String suggestText = option.getText().string();</span><br><span class="line">                        logger.info(<span class="string">"   suggest option : "</span> + suggestText);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.error(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        termSuggest();</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">"--------------------------------------"</span>);</span><br><span class="line">        </span><br><span class="line">        completionSuggester();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="aggregation-聚合分析"><a href="#aggregation-聚合分析" class="headerlink" title="aggregation 聚合分析"></a>aggregation 聚合分析</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AggregationDemo</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LogManager.getRootLogger();  </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (RestHighLevelClient client = InitDemo.getClient();) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 1、创建search请求</span></span><br><span class="line">            <span class="comment">//SearchRequest searchRequest = new SearchRequest();</span></span><br><span class="line">            SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"bank"</span>); </span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2、用SearchSourceBuilder来构造查询请求体 ,请仔细查看它的方法，构造各种查询的方法都在这。</span></span><br><span class="line">            SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder(); </span><br><span class="line">             </span><br><span class="line">            sourceBuilder.size(<span class="number">0</span>); </span><br><span class="line"></span><br><span class="line">            <span class="comment">//加入聚合</span></span><br><span class="line">            <span class="comment">//字段值项分组聚合</span></span><br><span class="line">            TermsAggregationBuilder aggregation = AggregationBuilders.terms(<span class="string">"by_age"</span>)</span><br><span class="line">                    .field(<span class="string">"age"</span>).order(BucketOrder.aggregation(<span class="string">"average_balance"</span>, <span class="keyword">true</span>));</span><br><span class="line">            <span class="comment">//计算每组的平均balance指标</span></span><br><span class="line">            aggregation.subAggregation(AggregationBuilders.avg(<span class="string">"average_balance"</span>)</span><br><span class="line">                    .field(<span class="string">"balance"</span>));</span><br><span class="line">            sourceBuilder.aggregation(aggregation);</span><br><span class="line">            </span><br><span class="line">            searchRequest.source(sourceBuilder);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//3、发送请求        </span></span><br><span class="line">            SearchResponse searchResponse = client.search(searchRequest);</span><br><span class="line">                </span><br><span class="line">            <span class="comment">//4、处理响应</span></span><br><span class="line">            <span class="comment">//搜索结果状态信息</span></span><br><span class="line">            <span class="keyword">if</span>(RestStatus.OK.equals(searchResponse.status())) &#123;</span><br><span class="line">                <span class="comment">// 获取聚合结果</span></span><br><span class="line">                Aggregations aggregations = searchResponse.getAggregations();</span><br><span class="line">                Terms byAgeAggregation = aggregations.get(<span class="string">"by_age"</span>); </span><br><span class="line">                logger.info(<span class="string">"aggregation by_age 结果"</span>);</span><br><span class="line">                logger.info(<span class="string">"docCountError: "</span> + byAgeAggregation.getDocCountError());</span><br><span class="line">                logger.info(<span class="string">"sumOfOtherDocCounts: "</span> + byAgeAggregation.getSumOfOtherDocCounts());</span><br><span class="line">                logger.info(<span class="string">"------------------------------------"</span>);</span><br><span class="line">                <span class="keyword">for</span>(Bucket buck : byAgeAggregation.getBuckets()) &#123;</span><br><span class="line">                    logger.info(<span class="string">"key: "</span> + buck.getKeyAsNumber());</span><br><span class="line">                    logger.info(<span class="string">"docCount: "</span> + buck.getDocCount());</span><br><span class="line">                    logger.info(<span class="string">"docCountError: "</span> + buck.getDocCountError());</span><br><span class="line">                    <span class="comment">//取子聚合</span></span><br><span class="line">                    Avg averageBalance = buck.getAggregations().get(<span class="string">"average_balance"</span>); </span><br><span class="line"></span><br><span class="line">                    logger.info(<span class="string">"average_balance: "</span> + averageBalance.getValue());</span><br><span class="line">                    logger.info(<span class="string">"------------------------------------"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//直接用key 来去分组</span></span><br><span class="line">                <span class="comment">/*Bucket elasticBucket = byCompanyAggregation.getBucketByKey("24"); </span></span><br><span class="line"><span class="comment">                Avg averageAge = elasticBucket.getAggregations().get("average_age"); </span></span><br><span class="line"><span class="comment">                double avg = averageAge.getValue();*/</span></span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.error(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>各种查询对应的QueryBuilder：</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-query-builders.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-query-builders.html</a></p>
<p>各种聚合对应的AggregationBuilder：</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-aggregation-builders.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-aggregation-builders.html</a></p>
<p>参考：<a href="https://www.cnblogs.com/leeSmall/p/9218779.html" target="_blank" rel="noopener">https://www.cnblogs.com/leeSmall/p/9218779.html</a></p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/03/16/Elasticsearch%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/16/Elasticsearch%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90/" itemprop="url">Elasticsearch聚合分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-16T00:00:00+08:00">
                2019-03-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="聚合分析简介"><a href="#聚合分析简介" class="headerlink" title="聚合分析简介"></a>聚合分析简介</h1><p>聚合分析是数据库中重要的功能特性，完成对一个查询的数据集中数据的聚合计算，如：找出某字段（或计算表达式的结果）的最大值、最小值，计算和、平均值等。ES作为搜索引擎兼数据库，同样提供了强大的聚合分析能力。</p>
<p>对一个数据集求最大、最小、和、平均值等指标的聚合，在ES中称为指标聚合   metric</p>
<p>而关系型数据库中除了有聚合函数外，还可以对查询出的数据进行分组group by，再在组上进行指标聚合。在 ES 中group by 称为分桶，桶聚合 bucketing</p>
<p>ES中还提供了矩阵聚合（matrix）、管道聚合（pipleline），但还在完善中。 </p>
<p>ES聚合分析查询的写法</p>
<p>在查询请求体中以aggregations节点按如下语法定义聚合分析(aggregations 也可简写为 aggs)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&quot;aggregations&quot; : &#123;</span><br><span class="line">    &quot;&lt;aggregation_name&gt;&quot; : &#123; &lt;!--聚合的名字 --&gt;</span><br><span class="line">        &quot;&lt;aggregation_type&gt;&quot; : &#123; &lt;!--聚合的类型 --&gt;</span><br><span class="line">            &lt;aggregation_body&gt; &lt;!--聚合体：对哪些字段进行聚合 --&gt;</span><br><span class="line">        &#125;</span><br><span class="line">        [,&quot;meta&quot; : &#123;  [&lt;meta_data_body&gt;] &#125; ]? &lt;!--元 --&gt;</span><br><span class="line">        [,&quot;aggregations&quot; : &#123; [&lt;sub_aggregation&gt;]+ &#125; ]? &lt;!--在聚合里面在定义子聚合 --&gt;</span><br><span class="line">    &#125;</span><br><span class="line">    [,&quot;&lt;aggregation_name_2&gt;&quot; : &#123; ... &#125; ]*&lt;!--聚合的名字 --&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>聚合计算的值可以取字段的值，也可是脚本计算的结果。</p>
<h1 id="指标聚合"><a href="#指标聚合" class="headerlink" title="指标聚合"></a>指标聚合</h1><h2 id="max-min-sum-avg"><a href="#max-min-sum-avg" class="headerlink" title="max min sum avg"></a>max min sum avg</h2><p>最大值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0, </span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;masssbalance&quot;: &#123;</span><br><span class="line">      &quot;max&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;balance&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>年龄为24岁的客户中的余额最大值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 20, </span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;age&quot;: 24</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;balance&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;desc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;max_balance&quot;: &#123;</span><br><span class="line">      &quot;max&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;balance&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>值来源于脚本，查询所有客户的平均年龄是多少，并对平均年龄加10</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?size&#x3D;0</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;avg_age&quot;: &#123;</span><br><span class="line">      &quot;avg&quot;: &#123;</span><br><span class="line">        &quot;script&quot;: &#123;</span><br><span class="line">          &quot;source&quot;: &quot;doc.age.value&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;avg_age10&quot;: &#123;</span><br><span class="line">      &quot;avg&quot;: &#123;</span><br><span class="line">        &quot;script&quot;: &#123;</span><br><span class="line">          &quot;source&quot;: &quot;doc.age.value + 10&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>指定field，在脚本中用_value 取字段的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?size&#x3D;0</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;sum_balance&quot;: &#123;</span><br><span class="line">      &quot;sum&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;balance&quot;,</span><br><span class="line">        &quot;script&quot;: &#123;</span><br><span class="line">            &quot;source&quot;: &quot;_value * 1.03&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为没有值字段指定值。如未指定，缺失该字段值的文档将被忽略。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?size&#x3D;0</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;avg_age&quot;: &#123;</span><br><span class="line">      &quot;avg&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">        &quot;missing&quot;: 18</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="文档计数-count"><a href="#文档计数-count" class="headerlink" title="文档计数 count"></a>文档计数 count</h2><p>统计银行索引bank下年龄为24的文档数量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;accounts&#x2F;_count</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;age&quot; : 24</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="value-count-统计某字段有值的文档数"><a href="#value-count-统计某字段有值的文档数" class="headerlink" title="value_count 统计某字段有值的文档数"></a>value_count 统计某字段有值的文档数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?size&#x3D;1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;age_count&quot;: &#123;</span><br><span class="line">      &quot;value_count&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="cardinality-值去重计数"><a href="#cardinality-值去重计数" class="headerlink" title="cardinality  值去重计数"></a>cardinality  值去重计数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?size&#x3D;1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;age_count&quot;: &#123;</span><br><span class="line">      &quot;cardinality&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;state_count&quot;: &#123;</span><br><span class="line">      &quot;cardinality&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;state.keyword&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>说明：state的使用它的keyword版</p>
<h2 id="stats-统计-count-max-min-avg-sum-5个值"><a href="#stats-统计-count-max-min-avg-sum-5个值" class="headerlink" title="stats 统计 count max min avg sum 5个值"></a>stats 统计 count max min avg sum 5个值</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?size&#x3D;0</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;age_stats&quot;: &#123;</span><br><span class="line">      &quot;stats&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Extended-stats"><a href="#Extended-stats" class="headerlink" title="Extended stats"></a>Extended stats</h2><p>高级统计，比stats多4个统计结果： 平方和、方差、标准差、平均值加/减两个标准差的区间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?size&#x3D;0</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;age_stats&quot;: &#123;</span><br><span class="line">      &quot;extended_stats&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Percentiles-占比百分位对应的值统计"><a href="#Percentiles-占比百分位对应的值统计" class="headerlink" title="Percentiles 占比百分位对应的值统计"></a>Percentiles 占比百分位对应的值统计</h2><p>对指定字段（脚本）的值按从小到大累计每个值对应的文档数的占比（占所有命中文档数的百分比），返回指定占比比例对应的值。默认返回[ 1, 5, 25, 50, 75, 95, 99 ]分位上的值。如下中间的结果，可以理解为：占比为50%的文档的age值 &lt;= 31，或反过来：age&lt;=31的文档数占总命中文档数的50%</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?size&#x3D;0</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;age_percents&quot;: &#123;</span><br><span class="line">      &quot;percentiles&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果说明:占比为50%的文档的age值 &lt;= 31，或反过来：age&lt;=31的文档数占总命中文档数的50%</p>
<p>指定分位值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?size&#x3D;0</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;age_percents&quot;: &#123;</span><br><span class="line">      &quot;percentiles&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">        &quot;percents&quot; : [95, 99, 99.9] </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Percentiles-rank-统计值小于等于指定值的文档占比"><a href="#Percentiles-rank-统计值小于等于指定值的文档占比" class="headerlink" title="Percentiles rank 统计值小于等于指定值的文档占比"></a>Percentiles rank 统计值小于等于指定值的文档占比</h2><p>统计年龄小于25和30的文档的占比，和第7项相反</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?size&#x3D;0</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;gge_perc_rank&quot;: &#123;</span><br><span class="line">      &quot;percentile_ranks&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">        &quot;values&quot;: [</span><br><span class="line">          25,</span><br><span class="line">          30</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果说明：年龄小于25的文档占比为26.1%，年龄小于30的文档占比为49.2%，</p>
<h2 id="Geo-Bounds-aggregation-求文档集中的地理位置坐标点的范围"><a href="#Geo-Bounds-aggregation-求文档集中的地理位置坐标点的范围" class="headerlink" title="Geo Bounds aggregation 求文档集中的地理位置坐标点的范围"></a>Geo Bounds aggregation 求文档集中的地理位置坐标点的范围</h2><p>参考官网链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics-geobounds-aggregation.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics-geobounds-aggregation.html</a></p>
<h2 id="Geo-Centroid-aggregation-求地理位置中心点坐标值"><a href="#Geo-Centroid-aggregation-求地理位置中心点坐标值" class="headerlink" title="Geo Centroid aggregation  求地理位置中心点坐标值"></a>Geo Centroid aggregation  求地理位置中心点坐标值</h2><p>参考官网链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics-geocentroid-aggregation.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics-geocentroid-aggregation.html</a></p>
<h1 id="桶聚合"><a href="#桶聚合" class="headerlink" title="桶聚合"></a>桶聚合</h1><h2 id="Terms-Aggregation-根据字段值项分组聚合"><a href="#Terms-Aggregation-根据字段值项分组聚合" class="headerlink" title="Terms Aggregation  根据字段值项分组聚合"></a>Terms Aggregation  根据字段值项分组聚合</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?size&#x3D;0</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;age_terms&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;doc_count_error_upper_bound&quot;: 0：文档计数的最大偏差值</span><br><span class="line">&quot;sum_other_doc_count&quot;: 463：未返回的其他项的文档数</span><br></pre></td></tr></table></figure>
<p>默认情况下返回按文档计数从高到低的前10个分组。</p>
<p>年龄为31的文档有61个，年龄为39的文档有60个</p>
<p>** size 指定返回多少个分组 ** </p>
<p>指定返回20个分组</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?size&#x3D;0</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;age_terms&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">        &quot;size&quot;: 20</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每个分组上显示偏差值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?size&#x3D;0</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;age_terms&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">        &quot;size&quot;: 5,</span><br><span class="line">        &quot;shard_size&quot;: 20,</span><br><span class="line">        &quot;show_term_doc_count_error&quot;: true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>** shard_size ** 指定每个分片上返回多少个分组</p>
<p>shard_size 的默认值为：索引只有一个分片：= size，多分片：= size * 1.5 + 10</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?size&#x3D;0</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;age_terms&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">        &quot;size&quot;: 5,</span><br><span class="line">        &quot;shard_size&quot;: 20</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>** order ** 指定分组的排序</p>
<p>根据文档计数排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?size&#x3D;0</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;age_terms&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">        &quot;order&quot; : &#123; &quot;_count&quot; : &quot;asc&quot; &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据分组值排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?size&#x3D;0</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;age_terms&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">        &quot;order&quot; : &#123; &quot;_key&quot; : &quot;asc&quot; &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>取分组指标值排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?size&#x3D;0</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;age_terms&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">        &quot;order&quot;: &#123;</span><br><span class="line">          &quot;max_balance&quot;: &quot;asc&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;max_balance&quot;: &#123;</span><br><span class="line">          &quot;max&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;balance&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;min_balance&quot;: &#123;</span><br><span class="line">          &quot;min&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;balance&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>筛选分组-正则表达式匹配值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;aggs&quot; : &#123;</span><br><span class="line">        &quot;tags&quot; : &#123;</span><br><span class="line">            &quot;terms&quot; : &#123;</span><br><span class="line">                &quot;field&quot; : &quot;tags&quot;,</span><br><span class="line">                &quot;include&quot; : &quot;.*sport.*&quot;,</span><br><span class="line">                &quot;exclude&quot; : &quot;water_.*&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>筛选分组-指定值列表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;aggs&quot; : &#123;</span><br><span class="line">        &quot;JapaneseCars&quot; : &#123;</span><br><span class="line">             &quot;terms&quot; : &#123;</span><br><span class="line">                 &quot;field&quot; : &quot;make&quot;,</span><br><span class="line">                 &quot;include&quot; : [&quot;mazda&quot;, &quot;honda&quot;]</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">        &quot;ActiveCarManufacturers&quot; : &#123;</span><br><span class="line">             &quot;terms&quot; : &#123;</span><br><span class="line">                 &quot;field&quot; : &quot;make&quot;,</span><br><span class="line">                 &quot;exclude&quot; : [&quot;rover&quot;, &quot;jensen&quot;]</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据脚本计算值分组</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;aggs&quot; : &#123;</span><br><span class="line">        &quot;genres&quot; : &#123;</span><br><span class="line">            &quot;terms&quot; : &#123;</span><br><span class="line">                &quot;script&quot; : &#123;</span><br><span class="line">                    &quot;source&quot;: &quot;doc[&#39;genre&#39;].value&quot;,</span><br><span class="line">                    &quot;lang&quot;: &quot;painless&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>缺失值处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;aggs&quot; : &#123;</span><br><span class="line">        &quot;tags&quot; : &#123;</span><br><span class="line">             &quot;terms&quot; : &#123;</span><br><span class="line">                 &quot;field&quot; : &quot;tags&quot;,</span><br><span class="line">                 &quot;missing&quot;: &quot;N&#x2F;A&quot; </span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="filter-Aggregation-对满足过滤查询的文档进行聚合计算"><a href="#filter-Aggregation-对满足过滤查询的文档进行聚合计算" class="headerlink" title="filter Aggregation  对满足过滤查询的文档进行聚合计算"></a>filter Aggregation  对满足过滤查询的文档进行聚合计算</h2><p> 在查询命中的文档中选取符合过滤条件的文档进行聚合，先过滤再聚合</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?size&#x3D;0</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;age_terms&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;&quot;match&quot;:&#123;&quot;gender&quot;:&quot;F&quot;&#125;&#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;avg_age&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;age&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Filters-Aggregation-多个过滤组聚合计算"><a href="#Filters-Aggregation-多个过滤组聚合计算" class="headerlink" title="Filters Aggregation  多个过滤组聚合计算"></a>Filters Aggregation  多个过滤组聚合计算</h2><p> 准备数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;logs&#x2F;_doc&#x2F;_bulk?refresh</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:1&#125;&#125;</span><br><span class="line">&#123;&quot;body&quot;:&quot;warning: page could not be rendered&quot;&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:2&#125;&#125;</span><br><span class="line">&#123;&quot;body&quot;:&quot;authentication error&quot;&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:3&#125;&#125;</span><br><span class="line">&#123;&quot;body&quot;:&quot;warning: connection timed out&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>获取组合过滤后聚合的结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">GET logs&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;messages&quot;: &#123;</span><br><span class="line">      &quot;filters&quot;: &#123;</span><br><span class="line">        &quot;filters&quot;: &#123;</span><br><span class="line">          &quot;errors&quot;: &#123;</span><br><span class="line">            &quot;match&quot;: &#123;</span><br><span class="line">              &quot;body&quot;: &quot;error&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;warnings&quot;: &#123;</span><br><span class="line">            &quot;match&quot;: &#123;</span><br><span class="line">              &quot;body&quot;: &quot;warning&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为其他值组指定key</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET logs&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;messages&quot;: &#123;</span><br><span class="line">      &quot;filters&quot;: &#123;</span><br><span class="line">        &quot;other_bucket_key&quot;: &quot;other_messages&quot;,</span><br><span class="line">        &quot;filters&quot;: &#123;</span><br><span class="line">          &quot;errors&quot;: &#123;</span><br><span class="line">            &quot;match&quot;: &#123;</span><br><span class="line">              &quot;body&quot;: &quot;error&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;warnings&quot;: &#123;</span><br><span class="line">            &quot;match&quot;: &#123;</span><br><span class="line">              &quot;body&quot;: &quot;warning&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Range-Aggregation-范围分组聚合"><a href="#Range-Aggregation-范围分组聚合" class="headerlink" title="Range Aggregation 范围分组聚合"></a>Range Aggregation 范围分组聚合</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?size&#x3D;0</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;age_range&quot;: &#123;</span><br><span class="line">      &quot;range&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">        &quot;ranges&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;to&quot;: 25</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 25,</span><br><span class="line">            &quot;to&quot;: 35</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 35</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;bmax&quot;: &#123;</span><br><span class="line">          &quot;max&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;balance&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为组指定key</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?size&#x3D;0</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;age_range&quot;: &#123;</span><br><span class="line">      &quot;range&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">        &quot;keyed&quot;: true,</span><br><span class="line">        &quot;ranges&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;to&quot;: 25,</span><br><span class="line">            &quot;key&quot;: &quot;Ld&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 25,</span><br><span class="line">            &quot;to&quot;: 35,</span><br><span class="line">            &quot;key&quot;: &quot;Md&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 35,</span><br><span class="line">            &quot;key&quot;: &quot;Od&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Date-Range-Aggregation-时间范围分组聚合"><a href="#Date-Range-Aggregation-时间范围分组聚合" class="headerlink" title="Date Range Aggregation  时间范围分组聚合"></a>Date Range Aggregation  时间范围分组聚合</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?size&#x3D;0</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">      &quot;date_range&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;date&quot;,</span><br><span class="line">        &quot;format&quot;: &quot;MM-yyy&quot;,</span><br><span class="line">        &quot;ranges&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;to&quot;: &quot;now-10M&#x2F;M&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: &quot;now-10M&#x2F;M&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Date-Histogram-Aggregation-时间直方图（柱状）聚合"><a href="#Date-Histogram-Aggregation-时间直方图（柱状）聚合" class="headerlink" title="Date Histogram Aggregation  时间直方图（柱状）聚合"></a>Date Histogram Aggregation  时间直方图（柱状）聚合</h2><p>就是按天、月、年等进行聚合统计。可按 year (1y), quarter (1q), month (1M), week (1w), day (1d), hour (1h), minute (1m), second (1s) 间隔聚合或指定的时间间隔聚合。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?size&#x3D;0</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;sales_over_time&quot;: &#123;</span><br><span class="line">      &quot;date_histogram&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;date&quot;,</span><br><span class="line">        &quot;interval&quot;: &quot;month&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Missing-Aggregation-缺失值的桶聚合"><a href="#Missing-Aggregation-缺失值的桶聚合" class="headerlink" title="Missing Aggregation  缺失值的桶聚合"></a>Missing Aggregation  缺失值的桶聚合</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;bank&#x2F;_search?size&#x3D;0</span><br><span class="line">&#123;</span><br><span class="line">    &quot;aggs&quot; : &#123;</span><br><span class="line">        &quot;account_without_a_age&quot; : &#123;</span><br><span class="line">            &quot;missing&quot; : &#123; &quot;field&quot; : &quot;age&quot; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Geo-Distance-Aggregation-地理距离分区聚合"><a href="#Geo-Distance-Aggregation-地理距离分区聚合" class="headerlink" title="Geo Distance Aggregation  地理距离分区聚合"></a>Geo Distance Aggregation  地理距离分区聚合</h2><p>参考官网链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-geodistance-aggregation.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-geodistance-aggregation.html</a> </p>

          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huyunshun.com/2019/03/15/Elasticsearch%E6%90%9C%E7%B4%A2%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="初晨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img.huyunshun.com/img/20200522182348.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/15/Elasticsearch%E6%90%9C%E7%B4%A2%E8%AF%A6%E8%A7%A3/" itemprop="url">Elasticsearch搜索详解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-15T00:00:00+08:00">
                2019-03-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="查询建议"><a href="#查询建议" class="headerlink" title="查询建议"></a>查询建议</h1><p> 查询建议：查询建议，为用户提供良好的使用体验。主要包括： 拼写检查； 自动建议查询词（自动补全）。</p>
<h2 id="ES中查询建议的API"><a href="#ES中查询建议的API" class="headerlink" title="ES中查询建议的API"></a>ES中查询建议的API</h2><p> 查询建议也是使用_search端点地址。在DSL中suggest节点来定义需要的建议查询</p>
<p>示例1：定义单个建议查询词</p>
<h2 id="定义查询建议"><a href="#定义查询建议" class="headerlink" title="定义查询建议"></a>定义查询建议</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&quot;suggest&quot; : &#123; </span><br><span class="line">    &quot;my-suggestion&quot; : &#123; &lt;!-- 一个建议查询名 --&gt;</span><br><span class="line">      &quot;text&quot; : &quot;tring out Elasticsearch&quot;, &lt;!-- 查询文本 --&gt;</span><br><span class="line">      &quot;term&quot; : &#123; &lt;!-- 使用词项建议器 --&gt;</span><br><span class="line">        &quot;field&quot; : &quot;message&quot; &lt;!-- 指定在哪个字段上获取建议词 --&gt;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot; : &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;email&quot;: &quot;virginiaayala@filodyne.com&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;suggest&quot; : &#123; </span><br><span class="line">    &quot;my-suggestion&quot; : &#123;  </span><br><span class="line">      &quot;text&quot; : &quot;virginiaayala@filodyne.com&quot;, </span><br><span class="line">      &quot;term&quot; : &#123;  </span><br><span class="line">        &quot;field&quot; : &quot;email&quot;  </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例2：定义多个建议查询词</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;suggest&quot;: &#123;</span><br><span class="line">    &quot;my-suggest-1&quot; : &#123;</span><br><span class="line">      &quot;text&quot; : &quot;virginiaayala@filodyne.com&quot;,</span><br><span class="line">      &quot;term&quot; : &#123;</span><br><span class="line">        &quot;field&quot; : &quot;email&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;my-suggest-2&quot; : &#123;</span><br><span class="line">      &quot;text&quot; : &quot;Nicholson&quot;,</span><br><span class="line">      &quot;term&quot; : &#123;</span><br><span class="line">        &quot;field&quot; : &quot;city&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例3：多个建议查询可以使用全局的查询文本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST _search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;suggest&quot;: &#123;</span><br><span class="line">    &quot;text&quot; : &quot;virginiaayala@filodyne.com&quot;,</span><br><span class="line">    &quot;my-suggest-1&quot; : &#123;</span><br><span class="line">      &quot;term&quot; : &#123;</span><br><span class="line">        &quot;field&quot; : &quot;email&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;my-suggest-2&quot; : &#123;</span><br><span class="line">       &quot;term&quot; : &#123;</span><br><span class="line">        &quot;field&quot; : &quot;city&quot;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Suggester-介绍"><a href="#Suggester-介绍" class="headerlink" title="Suggester 介绍"></a>Suggester 介绍</h1><h2 id="Term-suggester"><a href="#Term-suggester" class="headerlink" title="Term suggester"></a>Term suggester</h2><p>term 词项建议器，对给入的文本进行分词，为每个词进行模糊查询提供词项建议。对于在索引中存在词默认不提供建议词，不存在的词则根据模糊查询结果进行排序后取一定数量的建议词。</p>
<p>常用的建议选项：</p>
<p><img src="https://img.huyunshun.com/img1/Elasticsearch/ddsgsdg23435465t3423vfvsdimgclip.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot; : &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;email&quot;: &quot;virginiaayala@filodyne.com&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;suggest&quot; : &#123; </span><br><span class="line">    &quot;my-suggestion&quot; : &#123;  </span><br><span class="line">      &quot;text&quot; : &quot;virginiaayala@filodyne.com&quot;, </span><br><span class="line">      &quot;term&quot; : &#123;  </span><br><span class="line">        &quot;field&quot; : &quot;email&quot;  </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="phrase-suggester"><a href="#phrase-suggester" class="headerlink" title="phrase suggester"></a>phrase suggester</h2><p>phrase 短语建议，在term的基础上，会考量多个term之间的关系，比如是否同时出现在索引的原文里，相邻程度，以及词频等</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST bank&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot; : &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;suggest&quot; : &#123; </span><br><span class="line">    &quot;my-suggestion11&quot; : &#123;  </span><br><span class="line">      &quot;text&quot; : &quot;virginiaayala@filodyne.com&quot;, </span><br><span class="line">      &quot;phrase&quot; : &#123;  </span><br><span class="line">        &quot;field&quot; : &quot;email&quot;  </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Completion-suggester-自动补全"><a href="#Completion-suggester-自动补全" class="headerlink" title="Completion suggester   自动补全"></a>Completion suggester   自动补全</h2><p>针对自动补全场景而设计的建议器。此场景下用户每输入一个字符的时候，就需要即时发送一次查询请求到后端查找匹配项，在用户输入速度较高的情况下对后端响应速度要求比较苛刻。因此实现上它和前面两个Suggester采用了不同的数据结构，索引并非通过倒排来完成，而是将analyze过的数据编码成FST和索引一起存放。对于一个open状态的索引，FST会被ES整个装载到内存里的，进行前缀查找速度极快。但是FST只能用于前缀查找，这也是Completion Suggester的局限所在。</p>
<p> 官网链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-suggesters-completion.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/search-suggesters-completion.html</a></p>
<p> 为了使用自动补全，索引中用来提供补全建议的字段需特殊设计，字段类型为 completion。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT music</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">        &quot;_doc&quot; : &#123;</span><br><span class="line">            &quot;properties&quot; : &#123;</span><br><span class="line">                &quot;suggest&quot; : &#123;  &lt;!-- 用于自动补全的字段 --&gt;</span><br><span class="line">                    &quot;type&quot; : &quot;completion&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;title&quot; : &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Input 指定输入词 Weight 指定排序值（可选）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT music&#x2F;_doc&#x2F;1?refresh</span><br><span class="line">&#123;</span><br><span class="line">    &quot;suggest&quot; : &#123;</span><br><span class="line">        &quot;input&quot;: [ &quot;Nevermind&quot;, &quot;Nirvana&quot; ],</span><br><span class="line">        &quot;weight&quot; : 34</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>指定不同的排序值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT music&#x2F;_doc&#x2F;1?refresh</span><br><span class="line">&#123;</span><br><span class="line">    &quot;suggest&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;input&quot;: &quot;Nevermind&quot;,</span><br><span class="line">            &quot;weight&quot; : 10</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;input&quot;: &quot;Nirvana&quot;,</span><br><span class="line">            &quot;weight&quot; : 3</span><br><span class="line">        &#125;</span><br><span class="line">    ]&#125;</span><br></pre></td></tr></table></figure>

<p>放入一条重复数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT music&#x2F;_doc&#x2F;2?refresh</span><br><span class="line">&#123;</span><br><span class="line">    &quot;suggest&quot; : &#123;</span><br><span class="line">        &quot;input&quot;: [ &quot;Nevermind&quot;, &quot;Nirvana&quot; ],</span><br><span class="line">        &quot;weight&quot; : 20</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查询建议根据前缀查询：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST music&#x2F;_search?pretty</span><br><span class="line">&#123;</span><br><span class="line">    &quot;suggest&quot;: &#123;</span><br><span class="line">        &quot;song-suggest&quot; : &#123;</span><br><span class="line">            &quot;prefix&quot; : &quot;nir&quot;, </span><br><span class="line">            &quot;completion&quot; : &#123; </span><br><span class="line">                &quot;field&quot; : &quot;suggest&quot; </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对建议查询结果去重</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST music&#x2F;_search?pretty</span><br><span class="line">&#123;</span><br><span class="line">    &quot;suggest&quot;: &#123;</span><br><span class="line">        &quot;song-suggest&quot; : &#123;</span><br><span class="line">            &quot;prefix&quot; : &quot;nir&quot;, </span><br><span class="line">            &quot;completion&quot; : &#123; </span><br><span class="line">                &quot;field&quot; : &quot;suggest&quot;,</span><br><span class="line">                &quot;skip_duplicates&quot;: true </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;    &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>查询建议文档存储短语</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT music&#x2F;_doc&#x2F;3?refresh</span><br><span class="line">&#123;</span><br><span class="line">    &quot;suggest&quot; : &#123;</span><br><span class="line">        &quot;input&quot;: [ &quot;lucene solr&quot;, &quot;lucene so cool&quot;,&quot;lucene elasticsearch&quot; ],</span><br><span class="line">        &quot;weight&quot; : 20</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT music&#x2F;_doc&#x2F;4?refresh</span><br><span class="line">&#123;</span><br><span class="line">    &quot;suggest&quot; : &#123;</span><br><span class="line">        &quot;input&quot;: [&quot;lucene solr cool&quot;,&quot;lucene elasticsearch&quot; ],</span><br><span class="line">        &quot;weight&quot; : 10</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查询：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST music&#x2F;_search?pretty</span><br><span class="line">&#123;</span><br><span class="line">    &quot;suggest&quot;: &#123;</span><br><span class="line">        &quot;song-suggest&quot; : &#123;</span><br><span class="line">            &quot;prefix&quot; : &quot;lucene s&quot;, </span><br><span class="line">            &quot;completion&quot; : &#123; </span><br><span class="line">                &quot;field&quot; : &quot;suggest&quot; ,</span><br><span class="line">                &quot;skip_duplicates&quot;: true</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
     <!-- 相关文章推荐 -->
    
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/">上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><a class="extend next" rel="next" href="/page/9/">下一页</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://img.huyunshun.com/img/20200522182348.png"
                alt="初晨" />
            
              <p class="site-author-name" itemprop="name">初晨</p>
              <p class="site-description motion-element" itemprop="description">永远不要说你知道本质，更别说真相了。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">249</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">46</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">109</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          
<!--近期文章版块-->
            
                <div class="links-of-blogroll motion-element links-of-blogroll-block">
                  <div class="links-of-blogroll-title">
                    <!-- modify icon to fire by szw -->
                    <i class="fa fa-history fa-" aria-hidden="true"></i>
                    近期文章
                  </div>
                  <ul class="links-of-blogroll-list">
                    
                    
                      <li>
                        <a href="/2020/05/22/WebSocket%E3%80%81Socket%E3%80%81TCP%E3%80%81HTTP%E5%8C%BA%E5%88%AB/" title="WebSocket、Socket、TCP、HTTP区别" target="_blank">WebSocket、Socket、TCP、HTTP区别</a>
                      </li>
                    
                      <li>
                        <a href="/2020/05/19/Springboot%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%8E%A5%E5%8F%A3%E9%98%B2%E5%88%B7/" title="Springboot项目的接口防刷" target="_blank">Springboot项目的接口防刷</a>
                      </li>
                    
                      <li>
                        <a href="/2020/05/03/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Volatile%E5%85%B3%E9%94%AE%E5%AD%97%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" title="深入理解Volatile关键字及其实现原理" target="_blank">深入理解Volatile关键字及其实现原理</a>
                      </li>
                    
                      <li>
                        <a href="/2020/04/20/%E4%BD%BF%E7%94%A8vscode%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0%E7%8E%AF%E5%A2%83/" title="使用vscode搭建个人笔记环境" target="_blank">使用vscode搭建个人笔记环境</a>
                      </li>
                    
                      <li>
                        <a href="/2020/01/20/HBase%E4%BB%8B%E7%BB%8D%E5%AE%89%E8%A3%85%E4%B8%8E%E6%93%8D%E4%BD%9C/" title="HBase介绍安装与操作" target="_blank">HBase介绍安装与操作</a>
                      </li>
                    
                  </ul>
                </div>
            
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Copyright</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  


</body>
</html>
